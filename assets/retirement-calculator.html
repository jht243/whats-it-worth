<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Retirement Calculator — Plan Your Financial Future</title>
    <meta name="description" content="A comprehensive retirement calculator to analyze your savings, contributions, and retirement timeline. Get personalized tips to optimize your financial future." />
    <meta property="og:title" content="Retirement Calculator — Plan Your Financial Future" />
    <meta property="og:description" content="A comprehensive retirement calculator to analyze your savings, contributions, and retirement timeline. Get personalized tips to optimize your financial future." />
    <meta name="keywords" content="retirement calculator, retirement planning, savings calculator, 401k calculator, financial independence, investment growth, retirement age" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #F3F4F6;
        color: #1F2937;
        -webkit-font-smoothing: antialiased;
      }
      #retirement-calculator-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }
    </style>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit"></script>
    <script>
      window.TURNSTILE_SITE_KEY = "__TURNSTILE_SITE_KEY__";
    </script>
  </head>
  <body>
    <div id="retirement-calculator-root"></div>
    <!-- 
      Load script via import() to avoid HTML parser issues with inline code
    -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9Owp2YXIgX19jb3B5UHJvcHMgPSAodG8yLCBmcm9tMiwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgaWYgKGZyb20yICYmIHR5cGVvZiBmcm9tMiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20yID09PSAiZnVuY3Rpb24iKSB7CiAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbTIpKQogICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvMiwga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8yLCBrZXksIHsgZ2V0OiAoKSA9PiBmcm9tMltrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20yLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzI7Cn07CnZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogIC8vIGZpbGUgdGhhdCBoYXMgYmVlbiBjb252ZXJ0ZWQgdG8gYSBDb21tb25KUyBmaWxlIHVzaW5nIGEgQmFiZWwtCiAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogIGlzTm9kZU1vZGUgfHwgIW1vZCB8fCAhbW9kLl9fZXNNb2R1bGUgPyBfX2RlZlByb3AodGFyZ2V0LCAiZGVmYXVsdCIsIHsgdmFsdWU6IG1vZCwgZW51bWVyYWJsZTogdHJ1ZSB9KSA6IHRhcmdldCwKICBtb2QKKSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmVsZW1lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfUE9SVEFMX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wb3J0YWwiKTsKICAgICAgICB2YXIgUkVBQ1RfRlJBR01FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmZyYWdtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdHJpY3RfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9QUk9GSUxFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvZmlsZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPVklERVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb3ZpZGVyIik7CiAgICAgICAgdmFyIFJFQUNUX0NPTlRFWFRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmNvbnRleHQiKTsKICAgICAgICB2YXIgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSB7CiAgICAgICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSB7CiAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgLy8gVXNlZCB0byByZXByb2R1Y2UgYmVoYXZpb3Igb2YgYGJhdGNoZWRVcGRhdGVzYCBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgIGlzQmF0Y2hpbmdMZWdhY3k6IGZhbHNlLAogICAgICAgICAgZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IHt9OwogICAgICAgIHZhciBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZSA9IGZ1bmN0aW9uKHN0YWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gIiI7CiAgICAgICAgICAgIGlmIChjdXJyZW50RXh0cmFTdGFja0ZyYW1lKSB7CiAgICAgICAgICAgICAgc3RhY2sgKz0gY3VycmVudEV4dHJhU3RhY2tGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwogICAgICAgICAgICBpZiAoaW1wbCkgewogICAgICAgICAgICAgIHN0YWNrICs9IGltcGwoKSB8fCAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLAogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcsCiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lcgogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJ3YXJuIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfY29uc3RydWN0b3IgPSBwdWJsaWNJbnN0YW5jZS5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBfY29uc3RydWN0b3IgJiYgKF9jb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSB8fCBfY29uc3RydWN0b3IubmFtZSkgfHwgIlJlYWN0Q2xhc3MiOwogICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IGNvbXBvbmVudE5hbWUgKyAiLiIgKyBjYWxsZXJOYW1lOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVycm9yKCJDYW4ndCBjYWxsICVzIG9uIGEgY29tcG9uZW50IHRoYXQgaXMgbm90IHlldCBtb3VudGVkLiBUaGlzIGlzIGEgbm8tb3AsIGJ1dCBpdCBtaWdodCBpbmRpY2F0ZSBhIGJ1ZyBpbiB5b3VyIGFwcGxpY2F0aW9uLiBJbnN0ZWFkLCBhc3NpZ24gdG8gYHRoaXMuc3RhdGVgIGRpcmVjdGx5IG9yIGRlZmluZSBhIGBzdGF0ZSA9IHt9O2AgY2xhc3MgcHJvcGVydHkgd2l0aCB0aGUgZGVzaXJlZCBzdGF0ZSBpbiB0aGUgJXMgY29tcG9uZW50LiIsIGNhbGxlck5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3ROb29wVXBkYXRlUXVldWUgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIENoZWNrcyB3aGV0aGVyIG9yIG5vdCB0aGlzIGNvbXBvc2l0ZSBjb21wb25lbnQgaXMgbW91bnRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHdlIHdhbnQgdG8gdGVzdC4KICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgbW91bnRlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICogQHByb3RlY3RlZAogICAgICAgICAgICogQGZpbmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGlzTW91bnRlZDogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogRm9yY2VzIGFuIHVwZGF0ZS4gVGhpcyBzaG91bGQgb25seSBiZSBpbnZva2VkIHdoZW4gaXQgaXMga25vd24gd2l0aAogICAgICAgICAgICogY2VydGFpbnR5IHRoYXQgd2UgYXJlICoqbm90KiogaW4gYSBET00gdHJhbnNhY3Rpb24uCiAgICAgICAgICAgKgogICAgICAgICAgICogWW91IG1heSB3YW50IHRvIGNhbGwgdGhpcyB3aGVuIHlvdSBrbm93IHRoYXQgc29tZSBkZWVwZXIgYXNwZWN0IG9mIHRoZQogICAgICAgICAgICogY29tcG9uZW50J3Mgc3RhdGUgaGFzIGNoYW5nZWQgYnV0IGBzZXRTdGF0ZWAgd2FzIG5vdCBjYWxsZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhpcyB3aWxsIG5vdCBpbnZva2UgYHNob3VsZENvbXBvbmVudFVwZGF0ZWAsIGJ1dCBpdCB3aWxsIGludm9rZQogICAgICAgICAgICogYGNvbXBvbmVudFdpbGxVcGRhdGVgIGFuZCBgY29tcG9uZW50RGlkVXBkYXRlYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgImZvcmNlVXBkYXRlIik7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBSZXBsYWNlcyBhbGwgb2YgdGhlIHN0YXRlLiBBbHdheXMgdXNlIHRoaXMgb3IgYHNldFN0YXRlYCB0byBtdXRhdGUgc3RhdGUuCiAgICAgICAgICAgKiBZb3Ugc2hvdWxkIHRyZWF0IGB0aGlzLnN0YXRlYCBhcyBpbW11dGFibGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlcmUgaXMgbm8gZ3VhcmFudGVlIHRoYXQgYHRoaXMuc3RhdGVgIHdpbGwgYmUgaW1tZWRpYXRlbHkgdXBkYXRlZCwgc28KICAgICAgICAgICAqIGFjY2Vzc2luZyBgdGhpcy5zdGF0ZWAgYWZ0ZXIgY2FsbGluZyB0aGlzIG1ldGhvZCBtYXkgcmV0dXJuIHRoZSBvbGQgdmFsdWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29tcGxldGVTdGF0ZSBOZXh0IHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gY2FsbGVyTmFtZSBuYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjb21wbGV0ZVN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInJlcGxhY2VTdGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogU2V0cyBhIHN1YnNldCBvZiB0aGUgc3RhdGUuIFRoaXMgb25seSBleGlzdHMgYmVjYXVzZSBfcGVuZGluZ1N0YXRlIGlzCiAgICAgICAgICAgKiBpbnRlcm5hbC4gVGhpcyBwcm92aWRlcyBhIG1lcmdpbmcgc3RyYXRlZ3kgdGhhdCBpcyBub3QgYXZhaWxhYmxlIHRvIGRlZXAKICAgICAgICAgICAqIHByb3BlcnRpZXMgd2hpY2ggaXMgY29uZnVzaW5nLiBUT0RPOiBFeHBvc2UgcGVuZGluZ1N0YXRlIG9yIGRvbid0IHVzZSBpdAogICAgICAgICAgICogZHVyaW5nIHRoZSBtZXJnZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJ0aWFsU3RhdGUgTmV4dCBwYXJ0aWFsIHN0YXRlIHRvIGJlIG1lcmdlZCB3aXRoIHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gTmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAic2V0U3RhdGUiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZW1wdHlPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50KHByb3BzLCBjb250ZXh0LCB1cGRhdGVyKSB7CiAgICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgdGhpcy5yZWZzID0gZW1wdHlPYmplY3Q7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICAgIH0KICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQgPSB7fTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24ocGFydGlhbFN0YXRlLCBjYWxsYmFjaykgewogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJvYmplY3QiICYmIHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJmdW5jdGlvbiIgJiYgcGFydGlhbFN0YXRlICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZXRTdGF0ZSguLi4pOiB0YWtlcyBhbiBvYmplY3Qgb2Ygc3RhdGUgdmFyaWFibGVzIHRvIHVwZGF0ZSBvciBhIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUodGhpcywgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgfTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmZvcmNlVXBkYXRlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlRm9yY2VVcGRhdGUodGhpcywgY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGRlcHJlY2F0ZWRBUElzID0gewogICAgICAgICAgICBpc01vdW50ZWQ6IFsiaXNNb3VudGVkIiwgIkluc3RlYWQsIG1ha2Ugc3VyZSB0byBjbGVhbiB1cCBzdWJzY3JpcHRpb25zIGFuZCBwZW5kaW5nIHJlcXVlc3RzIGluIGNvbXBvbmVudFdpbGxVbm1vdW50IHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzLiJdLAogICAgICAgICAgICByZXBsYWNlU3RhdGU6IFsicmVwbGFjZVN0YXRlIiwgIlJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2Ugc2V0U3RhdGUgaW5zdGVhZCAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMvMzIzNikuIl0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nID0gZnVuY3Rpb24obWV0aG9kTmFtZSwgaW5mbykgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ29tcG9uZW50LnByb3RvdHlwZSwgbWV0aG9kTmFtZSwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiJXMoLi4uKSBpcyBkZXByZWNhdGVkIGluIHBsYWluIEphdmFTY3JpcHQgUmVhY3QgY2xhc3Nlcy4gJXMiLCBpbmZvWzBdLCBpbmZvWzFdKTsKICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBmb3IgKHZhciBmbk5hbWUgaW4gZGVwcmVjYXRlZEFQSXMpIHsKICAgICAgICAgICAgaWYgKGRlcHJlY2F0ZWRBUElzLmhhc093blByb3BlcnR5KGZuTmFtZSkpIHsKICAgICAgICAgICAgICBkZWZpbmVEZXByZWNhdGlvbldhcm5pbmcoZm5OYW1lLCBkZXByZWNhdGVkQVBJc1tmbk5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDb21wb25lbnREdW1teSgpIHsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50RHVtbXkucHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICBmdW5jdGlvbiBQdXJlQ29tcG9uZW50Myhwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHB1cmVDb21wb25lbnRQcm90b3R5cGUgPSBQdXJlQ29tcG9uZW50My5wcm90b3R5cGUgPSBuZXcgQ29tcG9uZW50RHVtbXkoKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUHVyZUNvbXBvbmVudDM7CiAgICAgICAgYXNzaWduMihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSZWYoKSB7CiAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBPYmplY3Quc2VhbChyZWZPYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlZk9iamVjdDsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIFJFU0VSVkVEX1BST1BTID0gewogICAgICAgICAga2V5OiB0cnVlLAogICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgX19zZWxmOiB0cnVlLAogICAgICAgICAgX19zb3VyY2U6IHRydWUKICAgICAgICB9OwogICAgICAgIHZhciBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biwgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24sIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZFJlZihjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAicmVmIikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJyZWYiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgImtleSIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5rZXkgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nS2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGBrZXlgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgImtleSIsIHsKICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXksCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ1JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBgcmVmYCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJyZWYiLCB7CiAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nUmVmLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnJlZiA9PT0gInN0cmluZyIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCAmJiBjb25maWcuX19zZWxmICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQuc3RhdGVOb2RlICE9PSBjb25maWcuX19zZWxmKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVGhpcyBjYXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbi4gV2UgYXNrIHlvdSB0byBtYW51YWxseSBmaXggdGhpcyBjYXNlIGJ5IHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBjb25maWcucmVmKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24odHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIG93bmVyLCBwcm9wcykgewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB7CiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGFsbG93cyB1cyB0byB1bmlxdWVseSBpZGVudGlmeSB0aGlzIGFzIGEgUmVhY3QgRWxlbWVudAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfRUxFTUVOVF9UWVBFLAogICAgICAgICAgICAvLyBCdWlsdC1pbiBwcm9wZXJ0aWVzIHRoYXQgYmVsb25nIG9uIHRoZSBlbGVtZW50CiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgcmVmLAogICAgICAgICAgICBwcm9wcywKICAgICAgICAgICAgLy8gUmVjb3JkIHRoZSBjb21wb25lbnQgcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIHRoaXMgZWxlbWVudC4KICAgICAgICAgICAgX293bmVyOiBvd25lcgogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQuX3N0b3JlLCAidmFsaWRhdGVkIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgICAgdmFsdWU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zZWxmIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzZWxmMgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc291cmNlIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzb3VyY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQ0MCh0eXBlLCBjb25maWcsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICB2YXIgcHJvcHMgPSB7fTsKICAgICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgICAgdmFyIHJlZiA9IG51bGw7CiAgICAgICAgICB2YXIgc2VsZjIgPSBudWxsOwogICAgICAgICAgdmFyIHNvdXJjZSA9IG51bGw7CiAgICAgICAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmMiA9IGNvbmZpZy5fX3NlbGYgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zZWxmOwogICAgICAgICAgICBzb3VyY2UgPSBjb25maWcuX19zb3VyY2UgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zb3VyY2U7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGNoaWxkQXJyYXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gdHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoa2V5IHx8IHJlZikgewogICAgICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iID8gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgIlVua25vd24iIDogdHlwZTsKICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVmKSB7CiAgICAgICAgICAgICAgICBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUFuZFJlcGxhY2VLZXkob2xkRWxlbWVudCwgbmV3S2V5KSB7CiAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IFJlYWN0RWxlbWVudChvbGRFbGVtZW50LnR5cGUsIG5ld0tleSwgb2xkRWxlbWVudC5yZWYsIG9sZEVsZW1lbnQuX3NlbGYsIG9sZEVsZW1lbnQuX3NvdXJjZSwgb2xkRWxlbWVudC5fb3duZXIsIG9sZEVsZW1lbnQucHJvcHMpOwogICAgICAgICAgcmV0dXJuIG5ld0VsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudDkoZWxlbWVudCwgY29uZmlnLCBjaGlsZHJlbikgewogICAgICAgICAgaWYgKGVsZW1lbnQgPT09IG51bGwgfHwgZWxlbWVudCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuY2xvbmVFbGVtZW50KC4uLik6IFRoZSBhcmd1bWVudCBtdXN0IGJlIGEgUmVhY3QgZWxlbWVudCwgYnV0IHlvdSBwYXNzZWQgIiArIGVsZW1lbnQgKyAiLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgdmFyIHByb3BzID0gYXNzaWduMih7fSwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5rZXk7CiAgICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICB2YXIgc2VsZjIgPSBlbGVtZW50Ll9zZWxmOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSAmJiBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChjb25maWdbcHJvcE5hbWVdID09PSB2b2lkIDAgJiYgZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRBcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQoZWxlbWVudC50eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQxNihvYmplY3QpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgfQogICAgICAgIHZhciBTRVBBUkFUT1IgPSAiLiI7CiAgICAgICAgdmFyIFNVQlNFUEFSQVRPUiA9ICI6IjsKICAgICAgICBmdW5jdGlvbiBlc2NhcGUoa2V5KSB7CiAgICAgICAgICB2YXIgZXNjYXBlUmVnZXggPSAvWz06XS9nOwogICAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAgICI9IjogIj0wIiwKICAgICAgICAgICAgIjoiOiAiPTIiCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVzY2FwZWRTdHJpbmcgPSBrZXkucmVwbGFjZShlc2NhcGVSZWdleCwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIGVzY2FwZXJMb29rdXBbbWF0Y2hdOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gIiQiICsgZXNjYXBlZFN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICB2YXIgdXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXggPSAvXC8rL2c7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlVXNlclByb3ZpZGVkS2V5KHRleHQpIHsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXgsICIkJi8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEtleShlbGVtZW50LCBpbmRleCkgewogICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAib2JqZWN0IiAmJiBlbGVtZW50ICE9PSBudWxsICYmIGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlc2NhcGUoIiIgKyBlbGVtZW50LmtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5kZXgudG9TdHJpbmcoMzYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuYW1lU29GYXIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IHR5cGVvZiBjaGlsZHJlbjsKICAgICAgICAgIGlmICh0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgY2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGludm9rZUNhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT09IG51bGwpIHsKICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGRyZW4uJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW52b2tlQ2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNoaWxkcmVuOwogICAgICAgICAgICB2YXIgbWFwcGVkQ2hpbGQgPSBjYWxsYmFjayhfY2hpbGQpOwogICAgICAgICAgICB2YXIgY2hpbGRLZXkgPSBuYW1lU29GYXIgPT09ICIiID8gU0VQQVJBVE9SICsgZ2V0RWxlbWVudEtleShfY2hpbGQsIDApIDogbmFtZVNvRmFyOwogICAgICAgICAgICBpZiAoaXNBcnJheTIobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgdmFyIGVzY2FwZWRDaGlsZEtleSA9ICIiOwogICAgICAgICAgICAgIGlmIChjaGlsZEtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlc2NhcGVkQ2hpbGRLZXkgPSBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoY2hpbGRLZXkpICsgIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYXBJbnRvQXJyYXkobWFwcGVkQ2hpbGQsIGFycmF5LCBlc2NhcGVkQ2hpbGRLZXksICIiLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXBwZWRDaGlsZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTYobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChtYXBwZWRDaGlsZC5rZXkgJiYgKCFfY2hpbGQgfHwgX2NoaWxkLmtleSAhPT0gbWFwcGVkQ2hpbGQua2V5KSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWFwcGVkQ2hpbGQua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWFwcGVkQ2hpbGQgPSBjbG9uZUFuZFJlcGxhY2VLZXkoCiAgICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkLAogICAgICAgICAgICAgICAgICAvLyBLZWVwIGJvdGggdGhlIChtYXBwZWQpIGFuZCBvbGQga2V5cyBpZiB0aGV5IGRpZmZlciwganVzdCBhcwogICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZUFsbENoaWxkcmVuIHVzZWQgdG8gZG8gZm9yIG9iamVjdHMgYXMgY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgZXNjYXBlZFByZWZpeCArIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgUmVhY3QuUG9ydGFsIGRvZXNuJ3QgaGF2ZSBhIGtleQogICAgICAgICAgICAgICAgICAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkgPyAoCiAgICAgICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBleGlzdGluZyBlbGVtZW50J3Mga2V5IGNhbiBiZSBhIG51bWJlcgogICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1pbnRlcm5hbC9zYWZlLXN0cmluZy1jb2VyY2lvbgogICAgICAgICAgICAgICAgICAgIGVzY2FwZVVzZXJQcm92aWRlZEtleSgiIiArIG1hcHBlZENoaWxkLmtleSkgKyAiLyIKICAgICAgICAgICAgICAgICAgKSA6ICIiKSArIGNoaWxkS2V5CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhcnJheS5wdXNoKG1hcHBlZENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgIHZhciBuZXh0TmFtZTsKICAgICAgICAgIHZhciBzdWJ0cmVlQ291bnQgPSAwOwogICAgICAgICAgdmFyIG5leHROYW1lUHJlZml4ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiA6IG5hbWVTb0ZhciArIFNVQlNFUEFSQVRPUjsKICAgICAgICAgIGlmIChpc0FycmF5MihjaGlsZHJlbikpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGkpOwogICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmFibGVDaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuID09PSBpdGVyYWJsZUNoaWxkcmVuLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNYXBzKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjMoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGl0ZXJhYmxlQ2hpbGRyZW4pOwogICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgIHZhciBpaSA9IDA7CiAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgY2hpbGQgPSBzdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGlpKyspOwogICAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5leHROYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuU3RyaW5nID0gU3RyaW5nKGNoaWxkcmVuKTsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZHJlblN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKGNoaWxkcmVuKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRyZW5TdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN1YnRyZWVDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmMsIGNvbnRleHQpIHsKICAgICAgICAgIGlmIChjaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIHJlc3VsdCwgIiIsICIiLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIGNoaWxkLCBjb3VudCsrKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY291bnRDaGlsZHJlbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIG4gPSAwOwogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBuKys7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JFYWNoQ2hpbGRyZW4oY2hpbGRyZW4sIGZvckVhY2hGdW5jLCBmb3JFYWNoQ29udGV4dCkgewogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3JFYWNoRnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZm9yRWFjaENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0b0FycmF5KGNoaWxkcmVuKSB7CiAgICAgICAgICByZXR1cm4gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0pIHx8IFtdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbmx5Q2hpbGQoY2hpbGRyZW4pIHsKICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnQxNihjaGlsZHJlbikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdC5DaGlsZHJlbi5vbmx5IGV4cGVjdGVkIHRvIHJlY2VpdmUgYSBzaW5nbGUgUmVhY3QgZWxlbWVudCBjaGlsZC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGV4dDEyKGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgIC8vIEFzIGEgd29ya2Fyb3VuZCB0byBzdXBwb3J0IG11bHRpcGxlIGNvbmN1cnJlbnQgcmVuZGVyZXJzLCB3ZSBjYXRlZ29yaXplCiAgICAgICAgICAgIC8vIHNvbWUgcmVuZGVyZXJzIGFzIHByaW1hcnkgYW5kIG90aGVycyBhcyBzZWNvbmRhcnkuIFdlIG9ubHkgZXhwZWN0CiAgICAgICAgICAgIC8vIHRoZXJlIHRvIGJlIHR3byBjb25jdXJyZW50IHJlbmRlcmVycyBhdCBtb3N0OiBSZWFjdCBOYXRpdmUgKHByaW1hcnkpIGFuZAogICAgICAgICAgICAvLyBGYWJyaWMgKHNlY29uZGFyeSk7IFJlYWN0IERPTSAocHJpbWFyeSkgYW5kIFJlYWN0IEFSVCAoc2Vjb25kYXJ5KS4KICAgICAgICAgICAgLy8gU2Vjb25kYXJ5IHJlbmRlcmVycyBzdG9yZSB0aGVpciBjb250ZXh0IHZhbHVlcyBvbiBzZXBhcmF0ZSBmaWVsZHMuCiAgICAgICAgICAgIF9jdXJyZW50VmFsdWU6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgLy8gVXNlZCB0byB0cmFjayBob3cgbWFueSBjb25jdXJyZW50IHJlbmRlcmVycyB0aGlzIGNvbnRleHQgY3VycmVudGx5CiAgICAgICAgICAgIC8vIHN1cHBvcnRzIHdpdGhpbiBpbiBhIHNpbmdsZSByZW5kZXJlci4gU3VjaCBhcyBwYXJhbGxlbCBzZXJ2ZXIgcmVuZGVyaW5nLgogICAgICAgICAgICBfdGhyZWFkQ291bnQ6IDAsCiAgICAgICAgICAgIC8vIFRoZXNlIGFyZSBjaXJjdWxhcgogICAgICAgICAgICBQcm92aWRlcjogbnVsbCwKICAgICAgICAgICAgQ29uc3VtZXI6IG51bGwsCiAgICAgICAgICAgIC8vIEFkZCB0aGVzZSB0byB1c2Ugc2FtZSBoaWRkZW4gY2xhc3MgaW4gVk0gYXMgU2VydmVyQ29udGV4dAogICAgICAgICAgICBfZGVmYXVsdFZhbHVlOiBudWxsLAogICAgICAgICAgICBfZ2xvYmFsTmFtZTogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QUk9WSURFUl9UWVBFLAogICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IGZhbHNlOwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIENvbnN1bWVyID0gewogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgICAgX2NvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ29uc3VtZXIsIHsKICAgICAgICAgICAgICBQcm92aWRlcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nQ29uc3VtZXJQcm92aWRlcikgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLlByb3ZpZGVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Qcm92aWRlcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Qcm92aWRlcjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9Qcm92aWRlcikgewogICAgICAgICAgICAgICAgICBjb250ZXh0LlByb3ZpZGVyID0gX1Byb3ZpZGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF9jdXJyZW50VmFsdWUyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTIgPSBfY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF90aHJlYWRDb3VudDogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX3RocmVhZENvdW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX3RocmVhZENvdW50ID0gX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgQ29uc3VtZXI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ05lc3RlZENvbnRleHRDb25zdW1lcnMpIHsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlcmluZyA8Q29udGV4dC5Db25zdW1lci5Db25zdW1lcj4gaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byByZW5kZXIgPENvbnRleHQuQ29uc3VtZXI+IGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuQ29uc3VtZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihkaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjMoIlNldHRpbmcgYGRpc3BsYXlOYW1lYCBvbiBDb250ZXh0LkNvbnN1bWVyIGhhcyBubyBlZmZlY3QuIFlvdSBzaG91bGQgc2V0IGl0IGRpcmVjdGx5IG9uIHRoZSBjb250ZXh0IHdpdGggQ29udGV4dC5kaXNwbGF5TmFtZSA9ICclcycuIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnRleHQuQ29uc3VtZXIgPSBDb25zdW1lcjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyID0gbnVsbDsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyMiA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgdmFyIFVuaW5pdGlhbGl6ZWQgPSAtMTsKICAgICAgICB2YXIgUGVuZGluZyA9IDA7CiAgICAgICAgdmFyIFJlc29sdmVkID0gMTsKICAgICAgICB2YXIgUmVqZWN0ZWQgPSAyOwogICAgICAgIGZ1bmN0aW9uIGxhenlJbml0aWFsaXplcihwYXlsb2FkKSB7CiAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgIHZhciBjdG9yID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICB2YXIgdGhlbmFibGUgPSBjdG9yKCk7CiAgICAgICAgICAgIHRoZW5hYmxlLnRoZW4oZnVuY3Rpb24obW9kdWxlT2JqZWN0MikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3N0YXR1cyA9IFJlc29sdmVkOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3Jlc3VsdCA9IG1vZHVsZU9iamVjdDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBQZW5kaW5nIHx8IHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgdmFyIHJlamVjdGVkID0gcGF5bG9hZDsKICAgICAgICAgICAgICAgIHJlamVjdGVkLl9zdGF0dXMgPSBSZWplY3RlZDsKICAgICAgICAgICAgICAgIHJlamVjdGVkLl9yZXN1bHQgPSBlcnJvcjI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gcGF5bG9hZDsKICAgICAgICAgICAgICBwZW5kaW5nLl9zdGF0dXMgPSBQZW5kaW5nOwogICAgICAgICAgICAgIHBlbmRpbmcuX3Jlc3VsdCA9IHRoZW5hYmxlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBSZXNvbHZlZCkgewogICAgICAgICAgICB2YXIgbW9kdWxlT2JqZWN0ID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG1vZHVsZU9iamVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpXG5cbkRpZCB5b3UgYWNjaWRlbnRhbGx5IHB1dCBjdXJseSBicmFjZXMgYXJvdW5kIHRoZSBpbXBvcnQ/IiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghKCJkZWZhdWx0IiBpbiBtb2R1bGVPYmplY3QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpIiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZHVsZU9iamVjdC5kZWZhdWx0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYXp5KGN0b3IpIHsKICAgICAgICAgIHZhciBwYXlsb2FkID0gewogICAgICAgICAgICAvLyBXZSB1c2UgdGhlc2UgZmllbGRzIHRvIHN0b3JlIHRoZSByZXN1bHQuCiAgICAgICAgICAgIF9zdGF0dXM6IFVuaW5pdGlhbGl6ZWQsCiAgICAgICAgICAgIF9yZXN1bHQ6IGN0b3IKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgbGF6eVR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9MQVpZX1RZUEUsCiAgICAgICAgICAgIF9wYXlsb2FkOiBwYXlsb2FkLAogICAgICAgICAgICBfaW5pdDogbGF6eUluaXRpYWxpemVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhsYXp5VHlwZSwgewogICAgICAgICAgICAgIGRlZmF1bHRQcm9wczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld0RlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgZGVmYXVsdFByb3BzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcm9wcyA9IG5ld0RlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAiZGVmYXVsdFByb3BzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBwcm9wVHlwZXM6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9wVHlwZXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuZXdQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmxhenkoLi4uKTogSXQgaXMgbm90IHN1cHBvcnRlZCB0byBhc3NpZ24gYHByb3BUeXBlc2AgdG8gYSBsYXp5IGNvbXBvbmVudCBpbXBvcnQuIEVpdGhlciBzcGVjaWZ5IHRoZW0gd2hlcmUgdGhlIGNvbXBvbmVudCBpcyBkZWZpbmVkLCBvciBjcmVhdGUgYSB3cmFwcGluZyBjb21wb25lbnQgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICAgICAgICBwcm9wVHlwZXMgPSBuZXdQcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShsYXp5VHlwZSwgInByb3BUeXBlcyIsIHsKICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGF6eVR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcndhcmRSZWYxNShyZW5kZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsICYmIHJlbmRlci4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMikgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCByZWNlaXZlZCBhIGBtZW1vYCBjb21wb25lbnQuIEluc3RlYWQgb2YgZm9yd2FyZFJlZihtZW1vKC4uLikpLCB1c2UgbWVtbyhmb3J3YXJkUmVmKC4uLikpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgd2FzIGdpdmVuICVzLiIsIHJlbmRlciA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiByZW5kZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChyZW5kZXIubGVuZ3RoICE9PSAwICYmIHJlbmRlci5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgYWNjZXB0IGV4YWN0bHkgdHdvIHBhcmFtZXRlcnM6IHByb3BzIGFuZCByZWYuICVzIiwgcmVuZGVyLmxlbmd0aCA9PT0gMSA/ICJEaWQgeW91IGZvcmdldCB0byB1c2UgdGhlIHJlZiBwYXJhbWV0ZXI/IiA6ICJBbnkgYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2lsbCBiZSB1bmRlZmluZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChyZW5kZXIuZGVmYXVsdFByb3BzICE9IG51bGwgfHwgcmVuZGVyLnByb3BUeXBlcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGRvIG5vdCBzdXBwb3J0IHByb3BUeXBlcyBvciBkZWZhdWx0UHJvcHMuIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgYSBSZWFjdCBjb21wb25lbnQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiwKICAgICAgICAgICAgcmVuZGVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duTmFtZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnRUeXBlLCAiZGlzcGxheU5hbWUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAoIXJlbmRlci5uYW1lICYmICFyZW5kZXIuZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyLmRpc3BsYXlOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlOwogICAgICAgIH0KICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICB7CiAgICAgICAgICBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QubW9kdWxlLnJlZmVyZW5jZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUgPT09IFJFQUNUX09GRlNDUkVFTl9UWVBFIHx8IGVuYWJsZVNjb3BlQVBJIHx8IGVuYWJsZUNhY2hlRWxlbWVudCB8fCBlbmFibGVUcmFuc2l0aW9uVHJhY2luZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgfHwgLy8gVGhpcyBuZWVkcyB0byBpbmNsdWRlIGFsbCBwb3NzaWJsZSBtb2R1bGUgcmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICAvLyB0eXBlcyBzdXBwb3J0ZWQgYnkgYW55IEZsaWdodCBjb25maWd1cmF0aW9uIGFueXdoZXJlIHNpbmNlCiAgICAgICAgICAgIC8vIHdlIGRvbid0IGtub3cgd2hpY2ggRmxpZ2h0IGJ1aWxkIHRoaXMgd2lsbCBlbmQgdXAgYmVpbmcgdXNlZAogICAgICAgICAgICAvLyB3aXRoLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFIHx8IHR5cGUuZ2V0TW9kdWxlSWQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lbW83KHR5cGUsIGNvbXBhcmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkpIHsKICAgICAgICAgICAgICBlcnJvcigibWVtbzogVGhlIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBjb21wb25lbnQuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzIiwgdHlwZSA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfTUVNT19UWVBFMiwKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgY29tcGFyZTogY29tcGFyZSA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbXBhcmUKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghdHlwZS5uYW1lICYmICF0eXBlLmRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIHR5cGUuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VDb250ZXh0MTIoQ29udGV4dCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29udGV4dC5fY29udGV4dCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlYWxDb250ZXh0ID0gQ29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgICBpZiAocmVhbENvbnRleHQuQ29uc3VtZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Db25zdW1lcikgaXMgbm90IHN1cHBvcnRlZCwgbWF5IGNhdXNlIGJ1Z3MsIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVhbENvbnRleHQuUHJvdmlkZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Qcm92aWRlcikgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ29udGV4dChDb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlU3RhdGUxMihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZjE1KGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUVmZmVjdDE1KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VMYXlvdXRFZmZlY3Q5KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNhbGxiYWNrNyhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VNZW1vOChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSW1wZXJhdGl2ZUhhbmRsZTMocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VUcmFuc2l0aW9uKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJZDIoKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJZCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50MikgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudDIucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLnR5cGUsIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoaW5pdChwYXlsb2FkKSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzMyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzMyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIHNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bjsKICAgICAgICB7CiAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCkgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgbmFtZSArICJgLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKSB7CiAgICAgICAgICBpZiAoc291cmNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgdmFyIGxpbmVOdW1iZXIgPSBzb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICIgKyBmaWxlTmFtZSArICI6IiArIGxpbmVOdW1iZXIgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMoZWxlbWVudFByb3BzKSB7CiAgICAgICAgICBpZiAoZWxlbWVudFByb3BzICE9PSBudWxsICYmIGVsZW1lbnRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShlbGVtZW50UHJvcHMuX19zb3VyY2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgaWYgKCFpbmZvKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgIGluZm8gPSAiXG5cbkNoZWNrIHRoZSB0b3AtbGV2ZWwgcmVuZGVyIGNhbGwgdXNpbmcgPCIgKyBwYXJlbnROYW1lICsgIj4uIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQXJyYXkyKG5vZGUpKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTYoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQxNihub2RlKSkgewogICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICBub2RlLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5vZGUpOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTYoc3RlcC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcFR5cGVzKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsIHx8IHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BUeXBlczsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBOb3RlOiBNZW1vIG9ubHkgY2hlY2tzIG91dGVyIHByb3BzIGhlcmUuCiAgICAgICAgICAgIC8vIElubmVyIHByb3BzIGFyZSBjaGVja2VkIGluIHRoZSByZWNvbmNpbGVyLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciB2YWxpZFR5cGUgPSBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSk7CiAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsICYmIE9iamVjdC5rZXlzKHR5cGUpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSW5mbyA9IGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMocHJvcHMpOwogICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgIGluZm8gKz0gc291cmNlSW5mbzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAibnVsbCI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheTIodHlwZSkpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSB2b2lkIDAgJiYgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSB0eXBlb2YgdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmNyZWF0ZUVsZW1lbnQ6IHR5cGUgaXMgaW52YWxpZCAtLSBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMiLCB0eXBlU3RyaW5nLCBpbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnQgPSBjcmVhdGVFbGVtZW50NDAuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsaWRUeXBlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgdmFsaWRhdGVGcmFnbWVudFByb3BzKGVsZW1lbnQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uKHR5cGUpIHsKICAgICAgICAgIHZhciB2YWxpZGF0ZWRGYWN0b3J5ID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uLmJpbmQobnVsbCwgdHlwZSk7CiAgICAgICAgICB2YWxpZGF0ZWRGYWN0b3J5LnR5cGUgPSB0eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5KSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkgPSB0cnVlOwogICAgICAgICAgICAgIHdhcm4zKCJSZWFjdC5jcmVhdGVGYWN0b3J5KCkgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIENvbnNpZGVyIHVzaW5nIEpTWCBvciB1c2UgUmVhY3QuY3JlYXRlRWxlbWVudCgpIGRpcmVjdGx5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHZhbGlkYXRlZEZhY3RvcnksICJ0eXBlIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiRmFjdG9yeS50eXBlIGlzIGRlcHJlY2F0ZWQuIEFjY2VzcyB0aGUgY2xhc3MgZGlyZWN0bHkgYmVmb3JlIHBhc3NpbmcgaXQgdG8gY3JlYXRlRmFjdG9yeS4iKTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAidHlwZSIsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHR5cGUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWxpZGF0ZWRGYWN0b3J5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbihlbGVtZW50LCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gY2xvbmVFbGVtZW50OS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCBuZXdFbGVtZW50LnR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMobmV3RWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRUcmFuc2l0aW9uKHNjb3BlLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzY29wZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMygiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSBmYWxzZTsKICAgICAgICB2YXIgZW5xdWV1ZVRhc2tJbXBsID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVGFzayh0YXNrMikgewogICAgICAgICAgaWYgKGVucXVldWVUYXNrSW1wbCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciByZXF1aXJlU3RyaW5nID0gKCJyZXF1aXJlIiArIE1hdGgucmFuZG9tKCkpLnNsaWNlKDAsIDcpOwogICAgICAgICAgICAgIHZhciBub2RlUmVxdWlyZSA9IG1vZHVsZSAmJiBtb2R1bGVbcmVxdWlyZVN0cmluZ107CiAgICAgICAgICAgICAgZW5xdWV1ZVRhc2tJbXBsID0gbm9kZVJlcXVpcmUuY2FsbChtb2R1bGUsICJ0aW1lcnMiKS5zZXRJbW1lZGlhdGU7CiAgICAgICAgICAgIH0gY2F0Y2ggKF9lcnIpIHsKICAgICAgICAgICAgICBlbnF1ZXVlVGFza0ltcGwgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgTWVzc2FnZUNoYW5uZWwgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiVGhpcyBicm93c2VyIGRvZXMgbm90IGhhdmUgYSBNZXNzYWdlQ2hhbm5lbCBpbXBsZW1lbnRhdGlvbiwgc28gZW5xdWV1aW5nIHRhc2tzIHZpYSBhd2FpdCBhY3QoYXN5bmMgKCkgPT4gLi4uKSB3aWxsIGZhaWwuIFBsZWFzZSBmaWxlIGFuIGlzc3VlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMgaWYgeW91IGVuY291bnRlciB0aGlzIHdhcm5pbmcuIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBNZXNzYWdlQ2hhbm5lbCgpOwogICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGNoYW5uZWwucG9ydDIucG9zdE1lc3NhZ2Uodm9pZCAwKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZW5xdWV1ZVRhc2tJbXBsKHRhc2syKTsKICAgICAgICB9CiAgICAgICAgdmFyIGFjdFNjb3BlRGVwdGggPSAwOwogICAgICAgIHZhciBkaWRXYXJuTm9Bd2FpdEFjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGFjdChjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJldkFjdFNjb3BlRGVwdGggPSBhY3RTY29wZURlcHRoOwogICAgICAgICAgICBhY3RTY29wZURlcHRoKys7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2SXNCYXRjaGluZ0xlZ2FjeSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHRydWU7CiAgICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2soKTsKICAgICAgICAgICAgICBpZiAoIXByZXZJc0JhdGNoaW5nTGVnYWN5ICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUocXVldWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5ID0gcHJldklzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCAmJiB0eXBlb2YgcmVzdWx0ID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcmVzdWx0LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgdGhlbmFibGVSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgdmFyIHdhc0F3YWl0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgd2FzQXdhaXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHRoZW5hYmxlUmVzdWx0LnRoZW4oZnVuY3Rpb24ocmV0dXJuVmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlMiwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2Fybk5vQXdhaXRBY3QgJiYgdHlwZW9mIFByb21pc2UgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXNBd2FpdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaWRXYXJuTm9Bd2FpdEFjdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiWW91IGNhbGxlZCBhY3QoYXN5bmMgKCkgPT4gLi4uKSB3aXRob3V0IGF3YWl0LiBUaGlzIGNvdWxkIGxlYWQgdG8gdW5leHBlY3RlZCB0ZXN0aW5nIGJlaGF2aW91ciwgaW50ZXJsZWF2aW5nIG11bHRpcGxlIGFjdCBjYWxscyBhbmQgbWl4aW5nIHRoZWlyIHNjb3Blcy4gWW91IHNob3VsZCAtIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pOyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGVuYWJsZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWUgPSByZXN1bHQ7CiAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX3F1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChfcXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShfcXVldWUpOwogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gW107CiAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoZW5hYmxlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlMiA9IHsKICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoZW5hYmxlMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZXZBY3RTY29wZURlcHRoICE9PSBhY3RTY29wZURlcHRoIC0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3Ugc2VlbSB0byBoYXZlIG92ZXJsYXBwaW5nIGFjdCgpIGNhbGxzLCB0aGlzIGlzIG5vdCBzdXBwb3J0ZWQuIEJlIHN1cmUgdG8gYXdhaXQgcHJldmlvdXMgYWN0KCkgY2FsbHMgYmVmb3JlIG1ha2luZyBhIG5ldyBvbmUuICIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdFNjb3BlRGVwdGggPSBwcmV2QWN0U2NvcGVEZXB0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBxdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIGVucXVldWVUYXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAocXVldWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmbHVzaEFjdFF1ZXVlKHF1ZXVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNGbHVzaGluZykgewogICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTsKICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBxdWV1ZSA9IHF1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaXNGbHVzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlRWxlbWVudCQxID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBjbG9uZUVsZW1lbnQkMSA9IGNsb25lRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBjcmVhdGVGYWN0b3J5ID0gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBDaGlsZHJlbjIgPSB7CiAgICAgICAgICBtYXA6IG1hcENoaWxkcmVuLAogICAgICAgICAgZm9yRWFjaDogZm9yRWFjaENoaWxkcmVuLAogICAgICAgICAgY291bnQ6IGNvdW50Q2hpbGRyZW4sCiAgICAgICAgICB0b0FycmF5LAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLkNoaWxkcmVuID0gQ2hpbGRyZW4yOwogICAgICAgIGV4cG9ydHMuQ29tcG9uZW50ID0gQ29tcG9uZW50OwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuUHJvZmlsZXIgPSBSRUFDVF9QUk9GSUxFUl9UWVBFOwogICAgICAgIGV4cG9ydHMuUHVyZUNvbXBvbmVudCA9IFB1cmVDb21wb25lbnQzOwogICAgICAgIGV4cG9ydHMuU3RyaWN0TW9kZSA9IFJFQUNUX1NUUklDVF9NT0RFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5TdXNwZW5zZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzOwogICAgICAgIGV4cG9ydHMuYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMuY2xvbmVFbGVtZW50ID0gY2xvbmVFbGVtZW50JDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVDb250ZXh0ID0gY3JlYXRlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQkMTsKICAgICAgICBleHBvcnRzLmNyZWF0ZUZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5OwogICAgICAgIGV4cG9ydHMuY3JlYXRlUmVmID0gY3JlYXRlUmVmOwogICAgICAgIGV4cG9ydHMuZm9yd2FyZFJlZiA9IGZvcndhcmRSZWYxNTsKICAgICAgICBleHBvcnRzLmlzVmFsaWRFbGVtZW50ID0gaXNWYWxpZEVsZW1lbnQxNjsKICAgICAgICBleHBvcnRzLmxhenkgPSBsYXp5OwogICAgICAgIGV4cG9ydHMubWVtbyA9IG1lbW83OwogICAgICAgIGV4cG9ydHMuc3RhcnRUcmFuc2l0aW9uID0gc3RhcnRUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMudXNlQ2FsbGJhY2sgPSB1c2VDYWxsYmFjazc7CiAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMudXNlRGVidWdWYWx1ZSA9IHVzZURlYnVnVmFsdWUyOwogICAgICAgIGV4cG9ydHMudXNlRGVmZXJyZWRWYWx1ZSA9IHVzZURlZmVycmVkVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QxNTsKICAgICAgICBleHBvcnRzLnVzZUlkID0gdXNlSWQyOwogICAgICAgIGV4cG9ydHMudXNlSW1wZXJhdGl2ZUhhbmRsZSA9IHVzZUltcGVyYXRpdmVIYW5kbGUzOwogICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTGF5b3V0RWZmZWN0ID0gdXNlTGF5b3V0RWZmZWN0OTsKICAgICAgICBleHBvcnRzLnVzZU1lbW8gPSB1c2VNZW1vODsKICAgICAgICBleHBvcnRzLnVzZVJlZHVjZXIgPSB1c2VSZWR1Y2VyOwogICAgICAgIGV4cG9ydHMudXNlUmVmID0gdXNlUmVmMTU7CiAgICAgICAgZXhwb3J0cy51c2VTdGF0ZSA9IHVzZVN0YXRlMTI7CiAgICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMjsKICAgICAgICBleHBvcnRzLnVzZVRyYW5zaXRpb24gPSB1c2VUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcwp2YXIgcmVxdWlyZV9yZWFjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9zY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NoZWR1bGVyRGVidWdnaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGluZyA9IGZhbHNlOwogICAgICAgIHZhciBmcmFtZVlpZWxkTXMgPSA1OwogICAgICAgIGZ1bmN0aW9uIHB1c2goaGVhcCwgbm9kZSkgewogICAgICAgICAgdmFyIGluZGV4ID0gaGVhcC5sZW5ndGg7CiAgICAgICAgICBoZWFwLnB1c2gobm9kZSk7CiAgICAgICAgICBzaWZ0VXAoaGVhcCwgbm9kZSwgaW5kZXgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZWVrMyhoZWFwKSB7CiAgICAgICAgICByZXR1cm4gaGVhcC5sZW5ndGggPT09IDAgPyBudWxsIDogaGVhcFswXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wKGhlYXApIHsKICAgICAgICAgIGlmIChoZWFwLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdCA9IGhlYXBbMF07CiAgICAgICAgICB2YXIgbGFzdDIgPSBoZWFwLnBvcCgpOwogICAgICAgICAgaWYgKGxhc3QyICE9PSBmaXJzdCkgewogICAgICAgICAgICBoZWFwWzBdID0gbGFzdDI7CiAgICAgICAgICAgIHNpZnREb3duKGhlYXAsIGxhc3QyLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdFVwKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPiAwKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmRleCA9IGluZGV4IC0gMSA+Pj4gMTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGhlYXBbcGFyZW50SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShwYXJlbnQsIG5vZGUpID4gMCkgewogICAgICAgICAgICAgIGhlYXBbcGFyZW50SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHBhcmVudDsKICAgICAgICAgICAgICBpbmRleCA9IHBhcmVudEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0RG93bihoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgdmFyIGhhbGZMZW5ndGggPSBsZW5ndGggPj4+IDE7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBoYWxmTGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0SW5kZXggPSAoaW5kZXggKyAxKSAqIDIgLSAxOwogICAgICAgICAgICB2YXIgbGVmdCA9IGhlYXBbbGVmdEluZGV4XTsKICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBsZWZ0SW5kZXggKyAxOwogICAgICAgICAgICB2YXIgcmlnaHQgPSBoZWFwW3JpZ2h0SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShsZWZ0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBsZWZ0KSA8IDApIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBsZWZ0OwogICAgICAgICAgICAgICAgaGVhcFtsZWZ0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbGVmdEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICAgICAgICAgIHZhciBkaWZmID0gYS5zb3J0SW5kZXggLSBiLnNvcnRJbmRleDsKICAgICAgICAgIHJldHVybiBkaWZmICE9PSAwID8gZGlmZiA6IGEuaWQgLSBiLmlkOwogICAgICAgIH0KICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSAxOwogICAgICAgIHZhciBVc2VyQmxvY2tpbmdQcmlvcml0eSA9IDI7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gMzsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSA0OwogICAgICAgIHZhciBJZGxlUHJpb3JpdHkgPSA1OwogICAgICAgIGZ1bmN0aW9uIG1hcmtUYXNrRXJyb3JlZCh0YXNrMiwgbXMpIHsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1BlcmZvcm1hbmNlTm93ID0gdHlwZW9mIHBlcmZvcm1hbmNlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAiZnVuY3Rpb24iOwogICAgICAgIGlmIChoYXNQZXJmb3JtYW5jZU5vdykgewogICAgICAgICAgdmFyIGxvY2FsUGVyZm9ybWFuY2UgPSBwZXJmb3JtYW5jZTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbFBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGxvY2FsRGF0ZTIgPSBEYXRlOwogICAgICAgICAgdmFyIGluaXRpYWxUaW1lID0gbG9jYWxEYXRlMi5ub3coKTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbERhdGUyLm5vdygpIC0gaW5pdGlhbFRpbWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbWF4U2lnbmVkMzFCaXRJbnQgPSAxMDczNzQxODIzOwogICAgICAgIHZhciBJTU1FRElBVEVfUFJJT1JJVFlfVElNRU9VVCA9IC0xOwogICAgICAgIHZhciBVU0VSX0JMT0NLSU5HX1BSSU9SSVRZX1RJTUVPVVQgPSAyNTA7CiAgICAgICAgdmFyIE5PUk1BTF9QUklPUklUWV9USU1FT1VUID0gNWUzOwogICAgICAgIHZhciBMT1dfUFJJT1JJVFlfVElNRU9VVCA9IDFlNDsKICAgICAgICB2YXIgSURMRV9QUklPUklUWV9USU1FT1VUID0gbWF4U2lnbmVkMzFCaXRJbnQ7CiAgICAgICAgdmFyIHRhc2tRdWV1ZSA9IFtdOwogICAgICAgIHZhciB0aW1lclF1ZXVlID0gW107CiAgICAgICAgdmFyIHRhc2tJZENvdW50ZXIgPSAxOwogICAgICAgIHZhciBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgdmFyIGlzUGVyZm9ybWluZ1dvcmsgPSBmYWxzZTsKICAgICAgICB2YXIgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIHZhciBsb2NhbFNldFRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiBudWxsOwogICAgICAgIHZhciBsb2NhbENsZWFyVGltZW91dCA9IHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBjbGVhclRpbWVvdXQgOiBudWxsOwogICAgICAgIHZhciBsb2NhbFNldEltbWVkaWF0ZSA9IHR5cGVvZiBzZXRJbW1lZGlhdGUgIT09ICJ1bmRlZmluZWQiID8gc2V0SW1tZWRpYXRlIDogbnVsbDsKICAgICAgICB2YXIgaXNJbnB1dFBlbmRpbmcgPSB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3Iuc2NoZWR1bGluZyAhPT0gdm9pZCAwICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nICE9PSB2b2lkIDAgPyBuYXZpZ2F0b3Iuc2NoZWR1bGluZy5pc0lucHV0UGVuZGluZy5iaW5kKG5hdmlnYXRvci5zY2hlZHVsaW5nKSA6IG51bGw7CiAgICAgICAgZnVuY3Rpb24gYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAodGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHRpbWVyLmNhbGxiYWNrID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcG9wKHRpbWVyUXVldWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRpbWVyLnN0YXJ0VGltZSA8PSBjdXJyZW50VGltZSkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgICB0aW1lci5zb3J0SW5kZXggPSB0aW1lci5leHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgdGltZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lb3V0KGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQpIHsKICAgICAgICAgICAgaWYgKHBlZWszKHRhc2tRdWV1ZSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBmaXJzdFRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hXb3JrKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIGlmIChpc0hvc3RUaW1lb3V0U2NoZWR1bGVkKSB7CiAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzUGVyZm9ybWluZ1dvcmsgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGluZykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgICAgIG1hcmtUYXNrRXJyb3JlZChjdXJyZW50VGFzaywgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICBjdXJyZW50VGFzay5pc1F1ZXVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gaW5pdGlhbFRpbWUyOwogICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAoY3VycmVudFRhc2sgIT09IG51bGwgJiYgIWVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZykgewogICAgICAgICAgICBpZiAoY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPiBjdXJyZW50VGltZSAmJiAoIWhhc1RpbWVSZW1haW5pbmcgfHwgc2hvdWxkWWllbGRUb0hvc3QoKSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBjdXJyZW50VGFzay5jYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRUYXNrLnByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgdmFyIGRpZFVzZXJDYWxsYmFja1RpbWVvdXQgPSBjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICB2YXIgY29udGludWF0aW9uQ2FsbGJhY2sgPSBjYWxsYmFjayhkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0KTsKICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250aW51YXRpb25DYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBjb250aW51YXRpb25DYWxsYmFjazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrID09PSBwZWVrMyh0YXNrUXVldWUpKSB7CiAgICAgICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AodGFza1F1ZXVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudFRhc2sgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgICBpZiAoZmlyc3RUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3J1bldpdGhQcmlvcml0eShwcmlvcml0eUxldmVsLCBldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfbmV4dChldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHZhciBwcmlvcml0eUxldmVsOwogICAgICAgICAgc3dpdGNoIChjdXJyZW50UHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfd3JhcENhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgcGFyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcGFyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjaywgb3B0aW9ucykgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgIHZhciBzdGFydFRpbWUyOwogICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAib2JqZWN0IiAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiICYmIGRlbGF5ID4gMCkgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZSArIGRlbGF5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRpbWVvdXQ7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElETEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gTE9XX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGltZW91dCA9IE5PUk1BTF9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gc3RhcnRUaW1lMiArIHRpbWVvdXQ7CiAgICAgICAgICB2YXIgbmV3VGFzayA9IHsKICAgICAgICAgICAgaWQ6IHRhc2tJZENvdW50ZXIrKywKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwsCiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lMiwKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgIHNvcnRJbmRleDogLTEKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoc3RhcnRUaW1lMiA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIG5ld1Rhc2suc29ydEluZGV4ID0gc3RhcnRUaW1lMjsKICAgICAgICAgICAgcHVzaCh0aW1lclF1ZXVlLCBuZXdUYXNrKTsKICAgICAgICAgICAgaWYgKHBlZWszKHRhc2tRdWV1ZSkgPT09IG51bGwgJiYgbmV3VGFzayA9PT0gcGVlazModGltZXJRdWV1ZSkpIHsKICAgICAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBzdGFydFRpbWUyIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdUYXNrLnNvcnRJbmRleCA9IGV4cGlyYXRpb25UaW1lOwogICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3VGFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcGF1c2VFeGVjdXRpb24oKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uKCkgewogICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCAmJiAhaXNQZXJmb3JtaW5nV29yaykgewogICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGUoKSB7CiAgICAgICAgICByZXR1cm4gcGVlazModGFza1F1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sodGFzazIpIHsKICAgICAgICAgIHRhc2syLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgfQogICAgICAgIHZhciBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgIHZhciBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgIHZhciB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgdmFyIGZyYW1lSW50ZXJ2YWwgPSBmcmFtZVlpZWxkTXM7CiAgICAgICAgdmFyIHN0YXJ0VGltZSA9IC0xOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFlpZWxkVG9Ib3N0KCkgewogICAgICAgICAgdmFyIHRpbWVFbGFwc2VkID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKSAtIHN0YXJ0VGltZTsKICAgICAgICAgIGlmICh0aW1lRWxhcHNlZCA8IGZyYW1lSW50ZXJ2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RQYWludCgpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VGcmFtZVJhdGUoZnBzKSB7CiAgICAgICAgICBpZiAoZnBzIDwgMCB8fCBmcHMgPiAxMjUpIHsKICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXSgiZm9yY2VGcmFtZVJhdGUgdGFrZXMgYSBwb3NpdGl2ZSBpbnQgYmV0d2VlbiAwIGFuZCAxMjUsIGZvcmNpbmcgZnJhbWUgcmF0ZXMgaGlnaGVyIHRoYW4gMTI1IGZwcyBpcyBub3Qgc3VwcG9ydGVkIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcHMgPiAwKSB7CiAgICAgICAgICAgIGZyYW1lSW50ZXJ2YWwgPSBNYXRoLmZsb29yKDFlMyAvIGZwcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc2NoZWR1bGVkSG9zdENhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgIHN0YXJ0VGltZSA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICB2YXIgaGFzVGltZVJlbWFpbmluZyA9IHRydWU7CiAgICAgICAgICAgIHZhciBoYXNNb3JlV29yayA9IHRydWU7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaGFzTW9yZVdvcmsgPSBzY2hlZHVsZWRIb3N0Q2FsbGJhY2soaGFzVGltZVJlbWFpbmluZywgY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmIChoYXNNb3JlV29yaykgewogICAgICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgIGlmICh0eXBlb2YgbG9jYWxTZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0SW1tZWRpYXRlKHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgIHZhciBwb3J0ID0gY2hhbm5lbC5wb3J0MjsKICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9ydC5wb3N0TWVzc2FnZShudWxsKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0VGltZW91dChwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUsIDApOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICBpZiAoIWlzTWVzc2FnZUxvb3BSdW5uaW5nKSB7CiAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RUaW1lb3V0KGNhbGxiYWNrLCBtcykgewogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IGxvY2FsU2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2soZXhwb3J0cy51bnN0YWJsZV9ub3coKSk7CiAgICAgICAgICB9LCBtcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbmNlbEhvc3RUaW1lb3V0KCkgewogICAgICAgICAgbG9jYWxDbGVhclRpbWVvdXQodGFza1RpbWVvdXRJRCk7CiAgICAgICAgICB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgfQogICAgICAgIHZhciB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSByZXF1ZXN0UGFpbnQ7CiAgICAgICAgdmFyIHVuc3RhYmxlX1Byb2ZpbGluZyA9IG51bGw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JZGxlUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JbW1lZGlhdGVQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfTG93UHJpb3JpdHkgPSBMb3dQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Qcm9maWxpbmcgPSB1bnN0YWJsZV9Qcm9maWxpbmc7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Vc2VyQmxvY2tpbmdQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sgPSB1bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uID0gdW5zdGFibGVfY29udGludWVFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9mb3JjZUZyYW1lUmF0ZSA9IGZvcmNlRnJhbWVSYXRlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwgPSB1bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlID0gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9uZXh0ID0gdW5zdGFibGVfbmV4dDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uID0gdW5zdGFibGVfcGF1c2VFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHkgPSB1bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrID0gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3Nob3VsZFlpZWxkID0gc2hvdWxkWWllbGRUb0hvc3Q7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV93cmFwQ2FsbGJhY2sgPSB1bnN0YWJsZV93cmFwQ2FsbGJhY2s7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdDM5ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0MzkuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgdmFyIHN1cHByZXNzV2FybmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNldFN1cHByZXNzV2FybmluZyhuZXdTdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3VwcHJlc3NXYXJuaW5nID0gbmV3U3VwcHJlc3NXYXJuaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghc3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJlcnJvciIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0MiwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQyICs9ICIlcyI7CiAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzV2l0aEZvcm1hdCA9IGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXJnc1dpdGhGb3JtYXQudW5zaGlmdCgiV2FybmluZzogIiArIGZvcm1hdDIpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRnVuY3Rpb25Db21wb25lbnQgPSAwOwogICAgICAgIHZhciBDbGFzc0NvbXBvbmVudCA9IDE7CiAgICAgICAgdmFyIEluZGV0ZXJtaW5hdGVDb21wb25lbnQgPSAyOwogICAgICAgIHZhciBIb3N0Um9vdCA9IDM7CiAgICAgICAgdmFyIEhvc3RQb3J0YWwgPSA0OwogICAgICAgIHZhciBIb3N0Q29tcG9uZW50ID0gNTsKICAgICAgICB2YXIgSG9zdFRleHQgPSA2OwogICAgICAgIHZhciBGcmFnbWVudDEwID0gNzsKICAgICAgICB2YXIgTW9kZSA9IDg7CiAgICAgICAgdmFyIENvbnRleHRDb25zdW1lciA9IDk7CiAgICAgICAgdmFyIENvbnRleHRQcm92aWRlciA9IDEwOwogICAgICAgIHZhciBGb3J3YXJkUmVmMiA9IDExOwogICAgICAgIHZhciBQcm9maWxlciA9IDEyOwogICAgICAgIHZhciBTdXNwZW5zZUNvbXBvbmVudCA9IDEzOwogICAgICAgIHZhciBNZW1vQ29tcG9uZW50ID0gMTQ7CiAgICAgICAgdmFyIFNpbXBsZU1lbW9Db21wb25lbnQgPSAxNTsKICAgICAgICB2YXIgTGF6eUNvbXBvbmVudCA9IDE2OwogICAgICAgIHZhciBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQgPSAxNzsKICAgICAgICB2YXIgRGVoeWRyYXRlZEZyYWdtZW50ID0gMTg7CiAgICAgICAgdmFyIFN1c3BlbnNlTGlzdENvbXBvbmVudCA9IDE5OwogICAgICAgIHZhciBTY29wZUNvbXBvbmVudCA9IDIxOwogICAgICAgIHZhciBPZmZzY3JlZW5Db21wb25lbnQgPSAyMjsKICAgICAgICB2YXIgTGVnYWN5SGlkZGVuQ29tcG9uZW50ID0gMjM7CiAgICAgICAgdmFyIENhY2hlQ29tcG9uZW50ID0gMjQ7CiAgICAgICAgdmFyIFRyYWNpbmdNYXJrZXJDb21wb25lbnQgPSAyNTsKICAgICAgICB2YXIgZW5hYmxlQ2xpZW50UmVuZGVyRmFsbGJhY2tPblRleHRNaXNtYXRjaCA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZU5ld1JlY29uY2lsZXIgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayA9IGZhbHNlOwogICAgICAgIHZhciBkaXNhYmxlQ29tbWVudHNBc0RPTUNvbnRhaW5lcnMgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0ID0gZmFsc2U7CiAgICAgICAgdmFyIHdhcm5BYm91dFN0cmluZ1JlZnMgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVTY2hlZHVsaW5nUHJvZmlsZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlclRpbWVyID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlUHJvZmlsZXJDb21taXRIb29rcyA9IHRydWU7CiAgICAgICAgdmFyIGFsbE5hdGl2ZUV2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMgPSB7fTsKICAgICAgICB2YXIgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lcyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpIHsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgZGVwZW5kZW5jaWVzKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQocmVnaXN0cmF0aW9uTmFtZSArICJDYXB0dXJlIiwgZGVwZW5kZW5jaWVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXNbcmVnaXN0cmF0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICBlcnJvcigiRXZlbnRSZWdpc3RyeTogTW9yZSB0aGFuIG9uZSBwbHVnaW4gYXR0ZW1wdGVkIHRvIHB1Ymxpc2ggdGhlIHNhbWUgcmVnaXN0cmF0aW9uIG5hbWUsIGAlc2AuIiwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXNbcmVnaXN0cmF0aW9uTmFtZV0gPSBkZXBlbmRlbmNpZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IHJlZ2lzdHJhdGlvbk5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lc1tsb3dlckNhc2VkTmFtZV0gPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZSA9PT0gIm9uRG91YmxlQ2xpY2siKSB7CiAgICAgICAgICAgICAgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lcy5vbmRibGNsaWNrID0gcmVnaXN0cmF0aW9uTmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYWxsTmF0aXZlRXZlbnRzLmFkZChkZXBlbmRlbmNpZXNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY2FuVXNlRE9NMiA9ICEhKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCAhPT0gInVuZGVmaW5lZCIpOwogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBhdHRyaWJ1dGUgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIGF0dHJpYnV0ZU5hbWUsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wU3RyaW5nQ29lcmNpb24odmFsdWUsIHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgcHJvcCBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgcHJvcE5hbWUsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDU1NQcm9wZXJ0eVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIENTUyBwcm9wZXJ0eSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgcHJvcE5hbWUsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tIdG1sU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgSFRNTCBtYXJrdXAgdXNlcyBhIHZhbHVlIG9mIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkZvcm0gZmllbGQgdmFsdWVzICh2YWx1ZSwgY2hlY2tlZCwgZGVmYXVsdFZhbHVlLCBvciBkZWZhdWx0Q2hlY2tlZCBwcm9wcykgbXVzdCBiZSBzdHJpbmdzLCBub3QgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSRVNFUlZFRCA9IDA7CiAgICAgICAgdmFyIFNUUklORyA9IDE7CiAgICAgICAgdmFyIEJPT0xFQU5JU0hfU1RSSU5HID0gMjsKICAgICAgICB2YXIgQk9PTEVBTiA9IDM7CiAgICAgICAgdmFyIE9WRVJMT0FERURfQk9PTEVBTiA9IDQ7CiAgICAgICAgdmFyIE5VTUVSSUMgPSA1OwogICAgICAgIHZhciBQT1NJVElWRV9OVU1FUklDID0gNjsKICAgICAgICB2YXIgQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiA9ICI6QS1aX2EtelxcdTAwQzAtXFx1MDBENlxcdTAwRDgtXFx1MDBGNlxcdTAwRjgtXFx1MDJGRlxcdTAzNzAtXFx1MDM3RFxcdTAzN0YtXFx1MUZGRlxcdTIwMEMtXFx1MjAwRFxcdTIwNzAtXFx1MjE4RlxcdTJDMDAtXFx1MkZFRlxcdTMwMDEtXFx1RDdGRlxcdUY5MDAtXFx1RkRDRlxcdUZERjAtXFx1RkZGRCI7CiAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX0NIQVIgPSBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSICsgIlxcLS4wLTlcXHUwMEI3XFx1MDMwMC1cXHUwMzZGXFx1MjAzRi1cXHUyMDQwIjsKICAgICAgICB2YXIgVkFMSURfQVRUUklCVVRFX05BTUVfUkVHRVggPSBuZXcgUmVnRXhwKCJeWyIgKyBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSICsgIl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgdmFyIGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGUgPSB7fTsKICAgICAgICB2YXIgdmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgZnVuY3Rpb24gaXNBdHRyaWJ1dGVOYW1lU2FmZShhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGUsIGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZSwgYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKFZBTElEX0FUVFJJQlVURV9OQU1FX1JFR0VYLnRlc3QoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgdmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlW2F0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlW2F0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXR0cmlidXRlIG5hbWU6IGAlc2AiLCBhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkSWdub3JlQXR0cmlidXRlKG5hbWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHByb3BlcnR5SW5mby50eXBlID09PSBSRVNFUlZFRDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmFtZS5sZW5ndGggPiAyICYmIChuYW1lWzBdID09PSAibyIgfHwgbmFtZVswXSA9PT0gIk8iKSAmJiAobmFtZVsxXSA9PT0gIm4iIHx8IG5hbWVbMV0gPT09ICJOIikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsICYmIHByb3BlcnR5SW5mby50eXBlID09PSBSRVNFUlZFRCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOiB7CiAgICAgICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhcHJvcGVydHlJbmZvLmFjY2VwdHNCb29sZWFuczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHByZWZpeDIgPSBuYW1lLnRvTG93ZXJDYXNlKCkuc2xpY2UoMCwgNSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJlZml4MiAhPT0gImRhdGEtIiAmJiBwcmVmaXgyICE9PSAiYXJpYS0iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICBzd2l0Y2ggKHByb3BlcnR5SW5mby50eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSBCT09MRUFOOgogICAgICAgICAgICAgICAgcmV0dXJuICF2YWx1ZTsKICAgICAgICAgICAgICBjYXNlIE9WRVJMT0FERURfQk9PTEVBTjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gZmFsc2U7CiAgICAgICAgICAgICAgY2FzZSBOVU1FUklDOgogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKTsKICAgICAgICAgICAgICBjYXNlIFBPU0lUSVZFX05VTUVSSUM6CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4odmFsdWUpIHx8IHZhbHVlIDwgMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQcm9wZXJ0eUluZm8obmFtZSkgewogICAgICAgICAgcmV0dXJuIHByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkobmFtZSkgPyBwcm9wZXJ0aWVzW25hbWVdIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gUHJvcGVydHlJbmZvUmVjb3JkKG5hbWUsIHR5cGUsIG11c3RVc2VQcm9wZXJ0eSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlTmFtZXNwYWNlLCBzYW5pdGl6ZVVSTDIsIHJlbW92ZUVtcHR5U3RyaW5nKSB7CiAgICAgICAgICB0aGlzLmFjY2VwdHNCb29sZWFucyA9IHR5cGUgPT09IEJPT0xFQU5JU0hfU1RSSU5HIHx8IHR5cGUgPT09IEJPT0xFQU4gfHwgdHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOOwogICAgICAgICAgdGhpcy5hdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZTsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlTmFtZXNwYWNlID0gYXR0cmlidXRlTmFtZXNwYWNlOwogICAgICAgICAgdGhpcy5tdXN0VXNlUHJvcGVydHkgPSBtdXN0VXNlUHJvcGVydHk7CiAgICAgICAgICB0aGlzLnByb3BlcnR5TmFtZSA9IG5hbWU7CiAgICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgICAgdGhpcy5zYW5pdGl6ZVVSTCA9IHNhbml0aXplVVJMMjsKICAgICAgICAgIHRoaXMucmVtb3ZlRW1wdHlTdHJpbmcgPSByZW1vdmVFbXB0eVN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB7fTsKICAgICAgICB2YXIgcmVzZXJ2ZWRQcm9wcyA9IFsKICAgICAgICAgICJjaGlsZHJlbiIsCiAgICAgICAgICAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLAogICAgICAgICAgLy8gVE9ETzogVGhpcyBwcmV2ZW50cyB0aGUgYXNzaWdubWVudCBvZiBkZWZhdWx0VmFsdWUgdG8gcmVndWxhcgogICAgICAgICAgLy8gZWxlbWVudHMgKG5vdCBqdXN0IGlucHV0cykuIE5vdyB0aGF0IFJlYWN0RE9NSW5wdXQgYXNzaWducyB0byB0aGUKICAgICAgICAgIC8vIGRlZmF1bHRWYWx1ZSBwcm9wZXJ0eSAtLSBkbyB3ZSBuZWVkIHRoaXM/CiAgICAgICAgICAiZGVmYXVsdFZhbHVlIiwKICAgICAgICAgICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICAiaW5uZXJIVE1MIiwKICAgICAgICAgICJzdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmciLAogICAgICAgICAgInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICAic3R5bGUiCiAgICAgICAgXTsKICAgICAgICByZXNlcnZlZFByb3BzLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFJFU0VSVkVELAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbWyJhY2NlcHRDaGFyc2V0IiwgImFjY2VwdC1jaGFyc2V0Il0sIFsiY2xhc3NOYW1lIiwgImNsYXNzIl0sIFsiaHRtbEZvciIsICJmb3IiXSwgWyJodHRwRXF1aXYiLCAiaHR0cC1lcXVpdiJdXS5mb3JFYWNoKGZ1bmN0aW9uKF9yZWYyKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IF9yZWYyWzBdLCBhdHRyaWJ1dGVOYW1lID0gX3JlZjJbMV07CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbImNvbnRlbnRFZGl0YWJsZSIsICJkcmFnZ2FibGUiLCAic3BlbGxDaGVjayIsICJ2YWx1ZSJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU5JU0hfU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsiYXV0b1JldmVyc2UiLCAiZXh0ZXJuYWxSZXNvdXJjZXNSZXF1aXJlZCIsICJmb2N1c2FibGUiLCAicHJlc2VydmVBbHBoYSJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU5JU0hfU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiYWxsb3dGdWxsU2NyZWVuIiwKICAgICAgICAgICJhc3luYyIsCiAgICAgICAgICAvLyBOb3RlOiB0aGVyZSBpcyBhIHNwZWNpYWwgY2FzZSB0aGF0IHByZXZlbnRzIGl0IGZyb20gYmVpbmcgd3JpdHRlbiB0byB0aGUgRE9NCiAgICAgICAgICAvLyBvbiB0aGUgY2xpZW50IHNpZGUgYmVjYXVzZSB0aGUgYnJvd3NlcnMgYXJlIGluY29uc2lzdGVudC4gSW5zdGVhZCB3ZSBjYWxsIGZvY3VzKCkuCiAgICAgICAgICAiYXV0b0ZvY3VzIiwKICAgICAgICAgICJhdXRvUGxheSIsCiAgICAgICAgICAiY29udHJvbHMiLAogICAgICAgICAgImRlZmF1bHQiLAogICAgICAgICAgImRlZmVyIiwKICAgICAgICAgICJkaXNhYmxlZCIsCiAgICAgICAgICAiZGlzYWJsZVBpY3R1cmVJblBpY3R1cmUiLAogICAgICAgICAgImRpc2FibGVSZW1vdGVQbGF5YmFjayIsCiAgICAgICAgICAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgImhpZGRlbiIsCiAgICAgICAgICAibG9vcCIsCiAgICAgICAgICAibm9Nb2R1bGUiLAogICAgICAgICAgIm5vVmFsaWRhdGUiLAogICAgICAgICAgIm9wZW4iLAogICAgICAgICAgInBsYXlzSW5saW5lIiwKICAgICAgICAgICJyZWFkT25seSIsCiAgICAgICAgICAicmVxdWlyZWQiLAogICAgICAgICAgInJldmVyc2VkIiwKICAgICAgICAgICJzY29wZWQiLAogICAgICAgICAgInNlYW1sZXNzIiwKICAgICAgICAgIC8vIE1pY3JvZGF0YQogICAgICAgICAgIml0ZW1TY29wZSIKICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU4sCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNoZWNrZWQiLAogICAgICAgICAgLy8gTm90ZTogYG9wdGlvbi5zZWxlY3RlZGAgaXMgbm90IHVwZGF0ZWQgaWYgYHNlbGVjdC5tdWx0aXBsZWAgaXMKICAgICAgICAgIC8vIGRpc2FibGVkIHdpdGggYHJlbW92ZUF0dHJpYnV0ZWAuIFdlIGhhdmUgc3BlY2lhbCBsb2dpYyBmb3IgaGFuZGxpbmcgdGhpcy4KICAgICAgICAgICJtdWx0aXBsZSIsCiAgICAgICAgICAibXV0ZWQiLAogICAgICAgICAgInNlbGVjdGVkIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOLAogICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjYXB0dXJlIiwKICAgICAgICAgICJkb3dubG9hZCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgT1ZFUkxPQURFRF9CT09MRUFOLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY29scyIsCiAgICAgICAgICAicm93cyIsCiAgICAgICAgICAic2l6ZSIsCiAgICAgICAgICAic3BhbiIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgUE9TSVRJVkVfTlVNRVJJQywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJyb3dTcGFuIiwgInN0YXJ0Il0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgTlVNRVJJQywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgQ0FNRUxJWkUgPSAvW1wtXDpdKFthLXpdKS9nOwogICAgICAgIHZhciBjYXBpdGFsaXplID0gZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgIHJldHVybiB0b2tlblsxXS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH07CiAgICAgICAgWwogICAgICAgICAgImFjY2VudC1oZWlnaHQiLAogICAgICAgICAgImFsaWdubWVudC1iYXNlbGluZSIsCiAgICAgICAgICAiYXJhYmljLWZvcm0iLAogICAgICAgICAgImJhc2VsaW5lLXNoaWZ0IiwKICAgICAgICAgICJjYXAtaGVpZ2h0IiwKICAgICAgICAgICJjbGlwLXBhdGgiLAogICAgICAgICAgImNsaXAtcnVsZSIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIiwKICAgICAgICAgICJjb2xvci1wcm9maWxlIiwKICAgICAgICAgICJjb2xvci1yZW5kZXJpbmciLAogICAgICAgICAgImRvbWluYW50LWJhc2VsaW5lIiwKICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCIsCiAgICAgICAgICAiZmlsbC1vcGFjaXR5IiwKICAgICAgICAgICJmaWxsLXJ1bGUiLAogICAgICAgICAgImZsb29kLWNvbG9yIiwKICAgICAgICAgICJmbG9vZC1vcGFjaXR5IiwKICAgICAgICAgICJmb250LWZhbWlseSIsCiAgICAgICAgICAiZm9udC1zaXplIiwKICAgICAgICAgICJmb250LXNpemUtYWRqdXN0IiwKICAgICAgICAgICJmb250LXN0cmV0Y2giLAogICAgICAgICAgImZvbnQtc3R5bGUiLAogICAgICAgICAgImZvbnQtdmFyaWFudCIsCiAgICAgICAgICAiZm9udC13ZWlnaHQiLAogICAgICAgICAgImdseXBoLW5hbWUiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLWhvcml6b250YWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLXZlcnRpY2FsIiwKICAgICAgICAgICJob3Jpei1hZHYteCIsCiAgICAgICAgICAiaG9yaXotb3JpZ2luLXgiLAogICAgICAgICAgImltYWdlLXJlbmRlcmluZyIsCiAgICAgICAgICAibGV0dGVyLXNwYWNpbmciLAogICAgICAgICAgImxpZ2h0aW5nLWNvbG9yIiwKICAgICAgICAgICJtYXJrZXItZW5kIiwKICAgICAgICAgICJtYXJrZXItbWlkIiwKICAgICAgICAgICJtYXJrZXItc3RhcnQiLAogICAgICAgICAgIm92ZXJsaW5lLXBvc2l0aW9uIiwKICAgICAgICAgICJvdmVybGluZS10aGlja25lc3MiLAogICAgICAgICAgInBhaW50LW9yZGVyIiwKICAgICAgICAgICJwYW5vc2UtMSIsCiAgICAgICAgICAicG9pbnRlci1ldmVudHMiLAogICAgICAgICAgInJlbmRlcmluZy1pbnRlbnQiLAogICAgICAgICAgInNoYXBlLXJlbmRlcmluZyIsCiAgICAgICAgICAic3RvcC1jb2xvciIsCiAgICAgICAgICAic3RvcC1vcGFjaXR5IiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXBvc2l0aW9uIiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXRoaWNrbmVzcyIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hhcnJheSIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hvZmZzZXQiLAogICAgICAgICAgInN0cm9rZS1saW5lY2FwIiwKICAgICAgICAgICJzdHJva2UtbGluZWpvaW4iLAogICAgICAgICAgInN0cm9rZS1taXRlcmxpbWl0IiwKICAgICAgICAgICJzdHJva2Utb3BhY2l0eSIsCiAgICAgICAgICAic3Ryb2tlLXdpZHRoIiwKICAgICAgICAgICJ0ZXh0LWFuY2hvciIsCiAgICAgICAgICAidGV4dC1kZWNvcmF0aW9uIiwKICAgICAgICAgICJ0ZXh0LXJlbmRlcmluZyIsCiAgICAgICAgICAidW5kZXJsaW5lLXBvc2l0aW9uIiwKICAgICAgICAgICJ1bmRlcmxpbmUtdGhpY2tuZXNzIiwKICAgICAgICAgICJ1bmljb2RlLWJpZGkiLAogICAgICAgICAgInVuaWNvZGUtcmFuZ2UiLAogICAgICAgICAgInVuaXRzLXBlci1lbSIsCiAgICAgICAgICAidi1hbHBoYWJldGljIiwKICAgICAgICAgICJ2LWhhbmdpbmciLAogICAgICAgICAgInYtaWRlb2dyYXBoaWMiLAogICAgICAgICAgInYtbWF0aGVtYXRpY2FsIiwKICAgICAgICAgICJ2ZWN0b3ItZWZmZWN0IiwKICAgICAgICAgICJ2ZXJ0LWFkdi15IiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi14IiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi15IiwKICAgICAgICAgICJ3b3JkLXNwYWNpbmciLAogICAgICAgICAgIndyaXRpbmctbW9kZSIsCiAgICAgICAgICAieG1sbnM6eGxpbmsiLAogICAgICAgICAgIngtaGVpZ2h0IgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAieGxpbms6YWN0dWF0ZSIsCiAgICAgICAgICAieGxpbms6YXJjcm9sZSIsCiAgICAgICAgICAieGxpbms6cm9sZSIsCiAgICAgICAgICAieGxpbms6c2hvdyIsCiAgICAgICAgICAieGxpbms6dGl0bGUiLAogICAgICAgICAgInhsaW5rOnR5cGUiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAiaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAieG1sOmJhc2UiLAogICAgICAgICAgInhtbDpsYW5nIiwKICAgICAgICAgICJ4bWw6c3BhY2UiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAiaHR0cDovL3d3dy53My5vcmcvWE1MLzE5OTgvbmFtZXNwYWNlIiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsidGFiSW5kZXgiLCAiY3Jvc3NPcmlnaW4iXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbYXR0cmlidXRlTmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHhsaW5rSHJlZiA9ICJ4bGlua0hyZWYiOwogICAgICAgIHByb3BlcnRpZXNbeGxpbmtIcmVmXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAieGxpbmtIcmVmIiwKICAgICAgICAgIFNUUklORywKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAieGxpbms6aHJlZiIsCiAgICAgICAgICAiaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIsCiAgICAgICAgICB0cnVlLAogICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBbInNyYyIsICJocmVmIiwgImFjdGlvbiIsICJmb3JtQWN0aW9uIl0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW2F0dHJpYnV0ZU5hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgaXNKYXZhU2NyaXB0UHJvdG9jb2wgPSAvXltcdTAwMDAtXHUwMDFGIF0qaltcclxuXHRdKmFbXHJcblx0XSp2W1xyXG5cdF0qYVtcclxuXHRdKnNbXHJcblx0XSpjW1xyXG5cdF0qcltcclxuXHRdKmlbXHJcblx0XSpwW1xyXG5cdF0qdFtcclxuXHRdKlw6L2k7CiAgICAgICAgdmFyIGRpZFdhcm4gPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBzYW5pdGl6ZVVSTCh1cmwpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuICYmIGlzSmF2YVNjcmlwdFByb3RvY29sLnRlc3QodXJsKSkgewogICAgICAgICAgICAgIGRpZFdhcm4gPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJBIGZ1dHVyZSB2ZXJzaW9uIG9mIFJlYWN0IHdpbGwgYmxvY2sgamF2YXNjcmlwdDogVVJMcyBhcyBhIHNlY3VyaXR5IHByZWNhdXRpb24uIFVzZSBldmVudCBoYW5kbGVycyBpbnN0ZWFkIGlmIHlvdSBjYW4uIElmIHlvdSBuZWVkIHRvIGdlbmVyYXRlIHVuc2FmZSBIVE1MIHRyeSB1c2luZyBkYW5nZXJvdXNseVNldElubmVySFRNTCBpbnN0ZWFkLiBSZWFjdCB3YXMgcGFzc2VkICVzLiIsIEpTT04uc3RyaW5naWZ5KHVybCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgbmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLm11c3RVc2VQcm9wZXJ0eSkgewogICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eUluZm8ucHJvcGVydHlOYW1lOwogICAgICAgICAgICAgIHJldHVybiBub2RlW3Byb3BlcnR5TmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8uc2FuaXRpemVVUkwpIHsKICAgICAgICAgICAgICAgIHNhbml0aXplVVJMKCIiICsgZXhwZWN0ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlTmFtZSA9IHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lOwogICAgICAgICAgICAgIHZhciBzdHJpbmdWYWx1ZSA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby50eXBlID09PSBPVkVSTE9BREVEX0JPT0xFQU4pIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby50eXBlID09PSBCT09MRUFOKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cmluZ1ZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nVmFsdWUgPT09IG51bGwgPyBleHBlY3RlZCA6IHN0cmluZ1ZhbHVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyaW5nVmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1ZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZvckF0dHJpYnV0ZShub2RlLCBuYW1lLCBleHBlY3RlZCwgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc0F0dHJpYnV0ZU5hbWVTYWZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbm9kZS5oYXNBdHRyaWJ1dGUobmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKGV4cGVjdGVkLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsIG5hbWUsIHZhbHVlLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGdldFByb3BlcnR5SW5mbyhuYW1lKTsKICAgICAgICAgIGlmIChzaG91bGRJZ25vcmVBdHRyaWJ1dGUobmFtZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgdmFsdWUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnIHx8IHByb3BlcnR5SW5mbyA9PT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaXNBdHRyaWJ1dGVOYW1lU2FmZShuYW1lKSkgewogICAgICAgICAgICAgIHZhciBfYXR0cmlidXRlTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShfYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShfYXR0cmlidXRlTmFtZSwgIiIgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtdXN0VXNlUHJvcGVydHkgPSBwcm9wZXJ0eUluZm8ubXVzdFVzZVByb3BlcnR5OwogICAgICAgICAgaWYgKG11c3RVc2VQcm9wZXJ0eSkgewogICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gcHJvcGVydHlJbmZvLnByb3BlcnR5TmFtZTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wZXJ0eUluZm8udHlwZTsKICAgICAgICAgICAgICBub2RlW3Byb3BlcnR5TmFtZV0gPSB0eXBlID09PSBCT09MRUFOID8gZmFsc2UgOiAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBub2RlW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYXR0cmlidXRlTmFtZSA9IHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lc3BhY2UgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZXNwYWNlOwogICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF90eXBlID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVWYWx1ZTsKICAgICAgICAgICAgaWYgKF90eXBlID09PSBCT09MRUFOIHx8IF90eXBlID09PSBPVkVSTE9BREVEX0JPT0xFQU4gJiYgdmFsdWUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBhdHRyaWJ1dGVWYWx1ZSA9ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8uc2FuaXRpemVVUkwpIHsKICAgICAgICAgICAgICAgIHNhbml0aXplVVJMKGF0dHJpYnV0ZVZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0cmlidXRlTmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGVOUyhhdHRyaWJ1dGVOYW1lc3BhY2UsIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmVsZW1lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfUE9SVEFMX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wb3J0YWwiKTsKICAgICAgICB2YXIgUkVBQ1RfRlJBR01FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmZyYWdtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdHJpY3RfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9QUk9GSUxFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvZmlsZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPVklERVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb3ZpZGVyIik7CiAgICAgICAgdmFyIFJFQUNUX0NPTlRFWFRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmNvbnRleHQiKTsKICAgICAgICB2YXIgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX1NDT1BFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zY29wZSIpOwogICAgICAgIHZhciBSRUFDVF9ERUJVR19UUkFDSU5HX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmRlYnVnX3RyYWNlX21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5vZmZzY3JlZW4iKTsKICAgICAgICB2YXIgUkVBQ1RfTEVHQUNZX0hJRERFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGVnYWN5X2hpZGRlbiIpOwogICAgICAgIHZhciBSRUFDVF9DQUNIRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY2FjaGUiKTsKICAgICAgICB2YXIgUkVBQ1RfVFJBQ0lOR19NQVJLRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnRyYWNpbmdfbWFya2VyIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGFzc2lnbjIgPSBPYmplY3QuYXNzaWduOwogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2SW5mbwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB3YXJuOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXAKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgdmFyIHByZWZpeDsKICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHgyLnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoZm4sIFtdLCBGYWtlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgRmFrZS5jYWxsKCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQ2xhc3NDb21wb25lbnRGcmFtZShjdG9yLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoY3RvciwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLnR5cGUsIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoaW5pdChwYXlsb2FkKSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBvd25lciA9IGZpYmVyLl9kZWJ1Z093bmVyID8gZmliZXIuX2RlYnVnT3duZXIudHlwZSA6IG51bGw7CiAgICAgICAgICB2YXIgc291cmNlID0gZmliZXIuX2RlYnVnU291cmNlOwogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShmaWJlci50eXBlKTsKICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiTGF6eSIpOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmaWJlci50eXBlKTsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUucmVuZGVyKTsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpbmZvICs9IGRlc2NyaWJlRmliZXIobm9kZSk7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICByZXR1cm4gIlxuRXJyb3IgZ2VuZXJhdGluZyBzdGFjazogIiArIHgyLm1lc3NhZ2UgKyAiXG4iICsgeDIuc3RhY2s7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lKHR5cGUsIHR5cGUucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgIHZhciBvdXRlck5hbWUgPSB0eXBlLmRpc3BsYXlOYW1lIHx8IG51bGw7CiAgICAgICAgICAgICAgICBpZiAob3V0ZXJOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBvdXRlck5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIk1lbW8iOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGluaXQocGF5bG9hZCkpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUkMShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lIHx8IChmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lJDEodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJDYWNoZSI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUkMShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICBjYXNlIERlaHlkcmF0ZWRGcmFnbWVudDoKICAgICAgICAgICAgICByZXR1cm4gIkRlaHlkcmF0ZWRGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lJDEodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQxMDoKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgIHJldHVybiAiUm9vdCI7CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUZXh0IjsKICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgIGNhc2UgTW9kZToKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuICJNb2RlIjsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJPZmZzY3JlZW4iOwogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiU2NvcGUiOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlRyYWNpbmdNYXJrZXIiOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIHZhciBjdXJyZW50MyA9IG51bGw7CiAgICAgICAgdmFyIGlzUmVuZGVyaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvd25lciA9IGN1cnJlbnQzLl9kZWJ1Z093bmVyOwogICAgICAgICAgICBpZiAob3duZXIgIT09IG51bGwgJiYgdHlwZW9mIG93bmVyICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlclN0YWNrSW5EZXYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKGN1cnJlbnQzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDdXJyZW50RmliZXIoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gbnVsbDsKICAgICAgICAgICAgY3VycmVudDMgPSBudWxsOwogICAgICAgICAgICBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBmaWJlciA9PT0gbnVsbCA/IG51bGwgOiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2OwogICAgICAgICAgICBjdXJyZW50MyA9IGZpYmVyOwogICAgICAgICAgICBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXIoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50MzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNSZW5kZXJpbmcocmVuZGVyaW5nKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzUmVuZGVyaW5nID0gcmVuZGVyaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0b1N0cmluZyh2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRvU3RyaW5nVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICBjYXNlICJ1bmRlZmluZWQiOgogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaGFzUmVhZE9ubHlWYWx1ZSA9IHsKICAgICAgICAgIGJ1dHRvbjogdHJ1ZSwKICAgICAgICAgIGNoZWNrYm94OiB0cnVlLAogICAgICAgICAgaW1hZ2U6IHRydWUsCiAgICAgICAgICBoaWRkZW46IHRydWUsCiAgICAgICAgICByYWRpbzogdHJ1ZSwKICAgICAgICAgIHJlc2V0OiB0cnVlLAogICAgICAgICAgc3VibWl0OiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKHRhZ05hbWUsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghKGhhc1JlYWRPbmx5VmFsdWVbcHJvcHMudHlwZV0gfHwgcHJvcHMub25DaGFuZ2UgfHwgcHJvcHMub25JbnB1dCB8fCBwcm9wcy5yZWFkT25seSB8fCBwcm9wcy5kaXNhYmxlZCB8fCBwcm9wcy52YWx1ZSA9PSBudWxsKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcHJvdmlkZWQgYSBgdmFsdWVgIHByb3AgdG8gYSBmb3JtIGZpZWxkIHdpdGhvdXQgYW4gYG9uQ2hhbmdlYCBoYW5kbGVyLiBUaGlzIHdpbGwgcmVuZGVyIGEgcmVhZC1vbmx5IGZpZWxkLiBJZiB0aGUgZmllbGQgc2hvdWxkIGJlIG11dGFibGUgdXNlIGBkZWZhdWx0VmFsdWVgLiBPdGhlcndpc2UsIHNldCBlaXRoZXIgYG9uQ2hhbmdlYCBvciBgcmVhZE9ubHlgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKHByb3BzLm9uQ2hhbmdlIHx8IHByb3BzLnJlYWRPbmx5IHx8IHByb3BzLmRpc2FibGVkIHx8IHByb3BzLmNoZWNrZWQgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHByb3ZpZGVkIGEgYGNoZWNrZWRgIHByb3AgdG8gYSBmb3JtIGZpZWxkIHdpdGhvdXQgYW4gYG9uQ2hhbmdlYCBoYW5kbGVyLiBUaGlzIHdpbGwgcmVuZGVyIGEgcmVhZC1vbmx5IGZpZWxkLiBJZiB0aGUgZmllbGQgc2hvdWxkIGJlIG11dGFibGUgdXNlIGBkZWZhdWx0Q2hlY2tlZGAuIE90aGVyd2lzZSwgc2V0IGVpdGhlciBgb25DaGFuZ2VgIG9yIGByZWFkT25seWAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDaGVja2FibGUoZWxlbSkgewogICAgICAgICAgdmFyIHR5cGUgPSBlbGVtLnR5cGU7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgKHR5cGUgPT09ICJjaGVja2JveCIgfHwgdHlwZSA9PT0gInJhZGlvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyYWNrZXIobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuX3ZhbHVlVHJhY2tlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoVHJhY2tlcihub2RlKSB7CiAgICAgICAgICBub2RlLl92YWx1ZVRyYWNrZXIgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZyb21Ob2RlKG5vZGUpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9ICIiOwogICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0NoZWNrYWJsZShub2RlKSkgewogICAgICAgICAgICB2YWx1ZSA9IG5vZGUuY2hlY2tlZCA/ICJ0cnVlIiA6ICJmYWxzZSI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IG5vZGUudmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyYWNrVmFsdWVPbk5vZGUobm9kZSkgewogICAgICAgICAgdmFyIHZhbHVlRmllbGQgPSBpc0NoZWNrYWJsZShub2RlKSA/ICJjaGVja2VkIiA6ICJ2YWx1ZSI7CiAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iobm9kZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHZhbHVlRmllbGQpOwogICAgICAgICAgewogICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24obm9kZVt2YWx1ZUZpZWxkXSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gIiIgKyBub2RlW3ZhbHVlRmllbGRdOwogICAgICAgICAgaWYgKG5vZGUuaGFzT3duUHJvcGVydHkodmFsdWVGaWVsZCkgfHwgdHlwZW9mIGRlc2NyaXB0b3IgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZXNjcmlwdG9yLmdldCAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgZGVzY3JpcHRvci5zZXQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldDYgPSBkZXNjcmlwdG9yLmdldCwgc2V0NCA9IGRlc2NyaXB0b3Iuc2V0OwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5vZGUsIHZhbHVlRmllbGQsIHsKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXQ2LmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICAgIHNldDQuY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5vZGUsIHZhbHVlRmllbGQsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogZGVzY3JpcHRvci5lbnVtZXJhYmxlCiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciB0cmFja2VyID0gewogICAgICAgICAgICBnZXRWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3RvcFRyYWNraW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBkZXRhY2hUcmFja2VyKG5vZGUpOwogICAgICAgICAgICAgIGRlbGV0ZSBub2RlW3ZhbHVlRmllbGRdOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHRyYWNrZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyYWNrKG5vZGUpIHsKICAgICAgICAgIGlmIChnZXRUcmFja2VyKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuX3ZhbHVlVHJhY2tlciA9IHRyYWNrVmFsdWVPbk5vZGUobm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZhbHVlSWZDaGFuZ2VkKG5vZGUpIHsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdHJhY2tlciA9IGdldFRyYWNrZXIobm9kZSk7CiAgICAgICAgICBpZiAoIXRyYWNrZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdFZhbHVlID0gdHJhY2tlci5nZXRWYWx1ZSgpOwogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGdldFZhbHVlRnJvbU5vZGUobm9kZSk7CiAgICAgICAgICBpZiAobmV4dFZhbHVlICE9PSBsYXN0VmFsdWUpIHsKICAgICAgICAgICAgdHJhY2tlci5zZXRWYWx1ZShuZXh0VmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QWN0aXZlRWxlbWVudChkb2MpIHsKICAgICAgICAgIGRvYyA9IGRvYyB8fCAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiA/IGRvY3VtZW50IDogdm9pZCAwKTsKICAgICAgICAgIGlmICh0eXBlb2YgZG9jID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBkb2MuYWN0aXZlRWxlbWVudCB8fCBkb2MuYm9keTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGRvYy5ib2R5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5DaGVja2VkRGVmYXVsdENoZWNrZWQgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuVW5jb250cm9sbGVkVG9Db250cm9sbGVkID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gaXNDb250cm9sbGVkKHByb3BzKSB7CiAgICAgICAgICB2YXIgdXNlc0NoZWNrZWQgPSBwcm9wcy50eXBlID09PSAiY2hlY2tib3giIHx8IHByb3BzLnR5cGUgPT09ICJyYWRpbyI7CiAgICAgICAgICByZXR1cm4gdXNlc0NoZWNrZWQgPyBwcm9wcy5jaGVja2VkICE9IG51bGwgOiBwcm9wcy52YWx1ZSAhPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciBjaGVja2VkID0gcHJvcHMuY2hlY2tlZDsKICAgICAgICAgIHZhciBob3N0UHJvcHMgPSBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICBkZWZhdWx0Q2hlY2tlZDogdm9pZCAwLAogICAgICAgICAgICBkZWZhdWx0VmFsdWU6IHZvaWQgMCwKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICAgICAgY2hlY2tlZDogY2hlY2tlZCAhPSBudWxsID8gY2hlY2tlZCA6IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsQ2hlY2tlZAogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gaG9zdFByb3BzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0V3JhcHBlclN0YXRlKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoImlucHV0IiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5DaGVja2VkRGVmYXVsdENoZWNrZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYW4gaW5wdXQgb2YgdHlwZSAlcyB3aXRoIGJvdGggY2hlY2tlZCBhbmQgZGVmYXVsdENoZWNrZWQgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgY2hlY2tlZCBwcm9wLCBvciB0aGUgZGVmYXVsdENoZWNrZWQgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiLCBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpIHx8ICJBIGNvbXBvbmVudCIsIHByb3BzLnR5cGUpOwogICAgICAgICAgICAgIGRpZFdhcm5DaGVja2VkRGVmYXVsdENoZWNrZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRWYWx1ZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYW4gaW5wdXQgb2YgdHlwZSAlcyB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gSW5wdXQgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gcHJvcHMuZGVmYXVsdFZhbHVlID09IG51bGwgPyAiIiA6IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZSA9IHsKICAgICAgICAgICAgaW5pdGlhbENoZWNrZWQ6IHByb3BzLmNoZWNrZWQgIT0gbnVsbCA/IHByb3BzLmNoZWNrZWQgOiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCwKICAgICAgICAgICAgaW5pdGlhbFZhbHVlOiBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlICE9IG51bGwgPyBwcm9wcy52YWx1ZSA6IGRlZmF1bHRWYWx1ZSksCiAgICAgICAgICAgIGNvbnRyb2xsZWQ6IGlzQ29udHJvbGxlZChwcm9wcykKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciBjaGVja2VkID0gcHJvcHMuY2hlY2tlZDsKICAgICAgICAgIGlmIChjaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCAiY2hlY2tlZCIsIGNoZWNrZWQsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV3JhcHBlcihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29udHJvbGxlZCA9IGlzQ29udHJvbGxlZChwcm9wcyk7CiAgICAgICAgICAgIGlmICghbm9kZS5fd3JhcHBlclN0YXRlLmNvbnRyb2xsZWQgJiYgY29udHJvbGxlZCAmJiAhZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCkgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbXBvbmVudCBpcyBjaGFuZ2luZyBhbiB1bmNvbnRyb2xsZWQgaW5wdXQgdG8gYmUgY29udHJvbGxlZC4gVGhpcyBpcyBsaWtlbHkgY2F1c2VkIGJ5IHRoZSB2YWx1ZSBjaGFuZ2luZyBmcm9tIHVuZGVmaW5lZCB0byBhIGRlZmluZWQgdmFsdWUsIHdoaWNoIHNob3VsZCBub3QgaGFwcGVuLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgY29tcG9uZW50LiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVW5jb250cm9sbGVkVG9Db250cm9sbGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZS5fd3JhcHBlclN0YXRlLmNvbnRyb2xsZWQgJiYgIWNvbnRyb2xsZWQgJiYgIWRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYSBjb250cm9sbGVkIGlucHV0IHRvIGJlIHVuY29udHJvbGxlZC4gVGhpcyBpcyBsaWtlbHkgY2F1c2VkIGJ5IHRoZSB2YWx1ZSBjaGFuZ2luZyBmcm9tIGEgZGVmaW5lZCB0byB1bmRlZmluZWQsIHdoaWNoIHNob3VsZCBub3QgaGFwcGVuLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgY29tcG9uZW50LiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdXBkYXRlQ2hlY2tlZChlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICB2YXIgdmFsdWUgPSBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlKTsKICAgICAgICAgIHZhciB0eXBlID0gcHJvcHMudHlwZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gMCAmJiBub2RlLnZhbHVlID09PSAiIiB8fCAvLyBXZSBleHBsaWNpdGx5IHdhbnQgdG8gY29lcmNlIHRvIG51bWJlciBoZXJlIGlmIHBvc3NpYmxlLgogICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZQogICAgICAgICAgICAgIG5vZGUudmFsdWUgIT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudmFsdWUgIT09IHRvU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInN1Ym1pdCIgfHwgdHlwZSA9PT0gInJlc2V0IikgewogICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZSgidmFsdWUiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuaGFzT3duUHJvcGVydHkoInZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgdmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJkZWZhdWx0VmFsdWUiKSkgewogICAgICAgICAgICAgIHNldERlZmF1bHRWYWx1ZShub2RlLCBwcm9wcy50eXBlLCBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLmRlZmF1bHRWYWx1ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGVja2VkID09IG51bGwgJiYgcHJvcHMuZGVmYXVsdENoZWNrZWQgIT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhIXByb3BzLmRlZmF1bHRDaGVja2VkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIoZWxlbWVudCwgcHJvcHMsIGlzSHlkcmF0aW5nMikgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpIHx8IHByb3BzLmhhc093blByb3BlcnR5KCJkZWZhdWx0VmFsdWUiKSkgewogICAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICAgIHZhciBpc0J1dHRvbiA9IHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCI7CiAgICAgICAgICAgIGlmIChpc0J1dHRvbiAmJiAocHJvcHMudmFsdWUgPT09IHZvaWQgMCB8fCBwcm9wcy52YWx1ZSA9PT0gbnVsbCkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluaXRpYWxWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nMikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpbml0aWFsVmFsdWUgIT09IG5vZGUudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gaW5pdGlhbFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IG5vZGUubmFtZTsKICAgICAgICAgIGlmIChuYW1lICE9PSAiIikgewogICAgICAgICAgICBub2RlLm5hbWUgPSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICFub2RlLmRlZmF1bHRDaGVja2VkOwogICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdXBkYXRlV3JhcHBlcihub2RlLCBwcm9wcyk7CiAgICAgICAgICB1cGRhdGVOYW1lZENvdXNpbnMobm9kZSwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVOYW1lZENvdXNpbnMocm9vdE5vZGUsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IHByb3BzLm5hbWU7CiAgICAgICAgICBpZiAocHJvcHMudHlwZSA9PT0gInJhZGlvIiAmJiBuYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIHF1ZXJ5Um9vdCA9IHJvb3ROb2RlOwogICAgICAgICAgICB3aGlsZSAocXVlcnlSb290LnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICBxdWVyeVJvb3QgPSBxdWVyeVJvb3QucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihuYW1lLCAibmFtZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBncm91cCA9IHF1ZXJ5Um9vdC5xdWVyeVNlbGVjdG9yQWxsKCJpbnB1dFtuYW1lPSIgKyBKU09OLnN0cmluZ2lmeSgiIiArIG5hbWUpICsgJ11bdHlwZT0icmFkaW8iXScpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGdyb3VwLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG90aGVyTm9kZSA9IGdyb3VwW2ldOwogICAgICAgICAgICAgIGlmIChvdGhlck5vZGUgPT09IHJvb3ROb2RlIHx8IG90aGVyTm9kZS5mb3JtICE9PSByb290Tm9kZS5mb3JtKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG90aGVyUHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKG90aGVyTm9kZSk7CiAgICAgICAgICAgICAgaWYgKCFvdGhlclByb3BzKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0RE9NSW5wdXQ6IE1peGluZyBSZWFjdCBhbmQgbm9uLVJlYWN0IHJhZGlvIGlucHV0cyB3aXRoIHRoZSBzYW1lIGBuYW1lYCBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGVWYWx1ZUlmQ2hhbmdlZChvdGhlck5vZGUpOwogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIob3RoZXJOb2RlLCBvdGhlclByb3BzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXREZWZhdWx0VmFsdWUobm9kZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgLy8gRm9jdXNlZCBudW1iZXIgaW5wdXRzIHN5bmNocm9uaXplIG9uIGJsdXIuIFNlZSBDaGFuZ2VFdmVudFBsdWdpbi5qcwogICAgICAgICAgICB0eXBlICE9PSAibnVtYmVyIiB8fCBnZXRBY3RpdmVFbGVtZW50KG5vZGUub3duZXJEb2N1bWVudCkgIT09IG5vZGUKICAgICAgICAgICkgewogICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5kZWZhdWx0VmFsdWUgIT09IHRvU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbiA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZENoaWxkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wcyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJvYmplY3QiICYmIHByb3BzLmNoaWxkcmVuICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdDM5LkNoaWxkcmVuLmZvckVhY2gocHJvcHMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBjaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuSW52YWxpZENoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCBpbmZlciB0aGUgb3B0aW9uIHZhbHVlIG9mIGNvbXBsZXggY2hpbGRyZW4uIFBhc3MgYSBgdmFsdWVgIHByb3Agb3IgdXNlIGEgcGxhaW4gc3RyaW5nIGFzIGNoaWxkcmVuIHRvIDxvcHRpb24+LiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRJbm5lckhUTUwpIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRJbm5lckhUTUwgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUGFzcyBhIGB2YWx1ZWAgcHJvcCBpZiB5b3Ugc2V0IGRhbmdlcm91c2x5SW5uZXJIVE1MIHNvIFJlYWN0IGtub3dzIHdoaWNoIHZhbHVlIHNob3VsZCBiZSBzZWxlY3RlZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLnNlbGVjdGVkICE9IG51bGwgJiYgIWRpZFdhcm5TZWxlY3RlZFNldE9uT3B0aW9uKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVzZSB0aGUgYGRlZmF1bHRWYWx1ZWAgb3IgYHZhbHVlYCBwcm9wcyBvbiA8c2VsZWN0PiBpbnN0ZWFkIG9mIHNldHRpbmcgYHNlbGVjdGVkYCBvbiA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICBkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgidmFsdWUiLCB0b1N0cmluZyhnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlKSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkyKGEpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSQxOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSQxID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHZhciBvd25lck5hbWUgPSBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpOwogICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZVByb3BOYW1lcyA9IFsidmFsdWUiLCAiZGVmYXVsdFZhbHVlIl07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTZWxlY3RQcm9wVHlwZXMocHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcygic2VsZWN0IiwgcHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlUHJvcE5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BOYW1lID0gdmFsdWVQcm9wTmFtZXNbaV07CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHByb3BOYW1lSXNBcnJheSA9IGlzQXJyYXkyKHByb3BzW3Byb3BOYW1lXSk7CiAgICAgICAgICAgICAgaWYgKHByb3BzLm11bHRpcGxlICYmICFwcm9wTmFtZUlzQXJyYXkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgYCVzYCBwcm9wIHN1cHBsaWVkIHRvIDxzZWxlY3Q+IG11c3QgYmUgYW4gYXJyYXkgaWYgYG11bHRpcGxlYCBpcyB0cnVlLiVzIiwgcHJvcE5hbWUsIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFwcm9wcy5tdWx0aXBsZSAmJiBwcm9wTmFtZUlzQXJyYXkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgYCVzYCBwcm9wIHN1cHBsaWVkIHRvIDxzZWxlY3Q+IG11c3QgYmUgYSBzY2FsYXIgdmFsdWUgaWYgYG11bHRpcGxlYCBpcyBmYWxzZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU9wdGlvbnMyKG5vZGUsIG11bHRpcGxlLCBwcm9wVmFsdWUsIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgdmFyIG9wdGlvbnMyID0gbm9kZS5vcHRpb25zOwogICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlcyA9IHByb3BWYWx1ZTsKICAgICAgICAgICAgdmFyIHNlbGVjdGVkVmFsdWUgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWxlY3RlZFZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVbIiQiICsgc2VsZWN0ZWRWYWx1ZXNbaV1dID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgb3B0aW9uczIubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkID0gc2VsZWN0ZWRWYWx1ZS5oYXNPd25Qcm9wZXJ0eSgiJCIgKyBvcHRpb25zMltfaV0udmFsdWUpOwogICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaV0uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zMltfaV0uc2VsZWN0ZWQgPSBzZWxlY3RlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkICYmIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3NlbGVjdGVkVmFsdWUgPSB0b1N0cmluZyhnZXRUb1N0cmluZ1ZhbHVlKHByb3BWYWx1ZSkpOwogICAgICAgICAgICB2YXIgZGVmYXVsdFNlbGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgX2kyID0gMDsgX2kyIDwgb3B0aW9uczIubGVuZ3RoOyBfaTIrKykgewogICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaTJdLnZhbHVlID09PSBfc2VsZWN0ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2kyXS5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoc2V0RGVmYXVsdFNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uZGVmYXVsdFNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCA9PT0gbnVsbCAmJiAhb3B0aW9uczJbX2kyXS5kaXNhYmxlZCkgewogICAgICAgICAgICAgICAgZGVmYXVsdFNlbGVjdGVkID0gb3B0aW9uczJbX2kyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZC5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICB2YWx1ZTogdm9pZCAwCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZSA9IHsKICAgICAgICAgICAgd2FzTXVsdGlwbGU6ICEhcHJvcHMubXVsdGlwbGUKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRWYWx1ZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSkgewogICAgICAgICAgICAgIGVycm9yKCJTZWxlY3QgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgc2VsZWN0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIpOwogICAgICAgICAgICAgIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSQxID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIG5vZGUubXVsdGlwbGUgPSAhIXByb3BzLm11bHRpcGxlOwogICAgICAgICAgdmFyIHZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGVPcHRpb25zMihub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGVPcHRpb25zMihub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5kZWZhdWx0VmFsdWUsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0VXBkYXRlV3JhcHBlcihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHdhc011bHRpcGxlID0gbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlOwogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAod2FzTXVsdGlwbGUgIT09ICEhcHJvcHMubXVsdGlwbGUpIHsKICAgICAgICAgICAgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMuZGVmYXVsdFZhbHVlLCB0cnVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGVPcHRpb25zMihub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5tdWx0aXBsZSA/IFtdIDogIiIsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWxEZWZhdWx0VmFsID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYCBkb2VzIG5vdCBtYWtlIHNlbnNlIG9uIDx0ZXh0YXJlYT4uIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaG9zdFByb3BzID0gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoaWxkcmVuOiB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gaG9zdFByb3BzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0V3JhcHBlclN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcygidGV4dGFyZWEiLCBwcm9wcyk7CiAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRWYWx1ZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuVmFsRGVmYXVsdFZhbCkgewogICAgICAgICAgICAgIGVycm9yKCIlcyBjb250YWlucyBhIHRleHRhcmVhIHdpdGggYm90aCB2YWx1ZSBhbmQgZGVmYXVsdFZhbHVlIHByb3BzLiBUZXh0YXJlYSBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCB0ZXh0YXJlYSBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmIChpbml0aWFsVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbiwgZGVmYXVsdFZhbHVlID0gcHJvcHMuZGVmYXVsdFZhbHVlOwogICAgICAgICAgICBpZiAoY2hpbGRyZW4gIT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVc2UgdGhlIGBkZWZhdWx0VmFsdWVgIG9yIGB2YWx1ZWAgcHJvcHMgaW5zdGVhZCBvZiBzZXR0aW5nIGNoaWxkcmVuIG9uIDx0ZXh0YXJlYT4uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklmIHlvdSBzdXBwbHkgYGRlZmF1bHRWYWx1ZWAgb24gYSA8dGV4dGFyZWE+LCBkbyBub3QgcGFzcyBjaGlsZHJlbi4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpc0FycmF5MihjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIjx0ZXh0YXJlYT4gY2FuIG9ubHkgaGF2ZSBhdCBtb3N0IG9uZSBjaGlsZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjaGlsZHJlbiA9IGNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gY2hpbGRyZW47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZSA9IHsKICAgICAgICAgICAgaW5pdGlhbFZhbHVlOiBnZXRUb1N0cmluZ1ZhbHVlKGluaXRpYWxWYWx1ZSkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICBpZiAobmV3VmFsdWUgIT09IG5vZGUudmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsICYmIG5vZGUuZGVmYXVsdFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gbm9kZS50ZXh0Q29udGVudDsKICAgICAgICAgIGlmICh0ZXh0Q29udGVudCA9PT0gbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICBpZiAodGV4dENvbnRlbnQgIT09ICIiICYmIHRleHRDb250ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IHRleHRDb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgdmFyIEhUTUxfTkFNRVNQQUNFID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiOwogICAgICAgIHZhciBNQVRIX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MIjsKICAgICAgICB2YXIgU1ZHX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJzdmciOgogICAgICAgICAgICAgIHJldHVybiBTVkdfTkFNRVNQQUNFOwogICAgICAgICAgICBjYXNlICJtYXRoIjoKICAgICAgICAgICAgICByZXR1cm4gTUFUSF9OQU1FU1BBQ0U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnROYW1lc3BhY2UsIHR5cGUpIHsKICAgICAgICAgIGlmIChwYXJlbnROYW1lc3BhY2UgPT0gbnVsbCB8fCBwYXJlbnROYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09PSBTVkdfTkFNRVNQQUNFICYmIHR5cGUgPT09ICJmb3JlaWduT2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gSFRNTF9OQU1FU1BBQ0U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGFyZW50TmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbiA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgTVNBcHAgIT09ICJ1bmRlZmluZWQiICYmIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihhcmcwLCBhcmcxLCBhcmcyLCBhcmczKSB7CiAgICAgICAgICAgICAgTVNBcHAuZXhlY1Vuc2FmZUxvY2FsRnVuY3Rpb24oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuYyhhcmcwLCBhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHJldXNhYmxlU1ZHQ29udGFpbmVyOwogICAgICAgIHZhciBzZXRJbm5lckhUTUwgPSBjcmVhdGVNaWNyb3NvZnRVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKG5vZGUsIGh0bWwpIHsKICAgICAgICAgIGlmIChub2RlLm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRSkgewogICAgICAgICAgICBpZiAoISgiaW5uZXJIVE1MIiBpbiBub2RlKSkgewogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyID0gcmV1c2FibGVTVkdDb250YWluZXIgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgcmV1c2FibGVTVkdDb250YWluZXIuaW5uZXJIVE1MID0gIjxzdmc+IiArIGh0bWwudmFsdWVPZigpLnRvU3RyaW5nKCkgKyAiPC9zdmc+IjsKICAgICAgICAgICAgICB2YXIgc3ZnTm9kZSA9IHJldXNhYmxlU1ZHQ29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVDaGlsZChub2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAoc3ZnTm9kZS5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKHN2Z05vZGUuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS5pbm5lckhUTUwgPSBodG1sOwogICAgICAgIH0pOwogICAgICAgIHZhciBFTEVNRU5UX05PREUgPSAxOwogICAgICAgIHZhciBURVhUX05PREUgPSAzOwogICAgICAgIHZhciBDT01NRU5UX05PREUgPSA4OwogICAgICAgIHZhciBET0NVTUVOVF9OT0RFID0gOTsKICAgICAgICB2YXIgRE9DVU1FTlRfRlJBR01FTlRfTk9ERSA9IDExOwogICAgICAgIHZhciBzZXRUZXh0Q29udGVudCA9IGZ1bmN0aW9uKG5vZGUsIHRleHQpIHsKICAgICAgICAgIGlmICh0ZXh0KSB7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAmJiBmaXJzdENoaWxkID09PSBub2RlLmxhc3RDaGlsZCAmJiBmaXJzdENoaWxkLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgICB9OwogICAgICAgIHZhciBzaG9ydGhhbmRUb0xvbmdoYW5kID0gewogICAgICAgICAgYW5pbWF0aW9uOiBbImFuaW1hdGlvbkRlbGF5IiwgImFuaW1hdGlvbkRpcmVjdGlvbiIsICJhbmltYXRpb25EdXJhdGlvbiIsICJhbmltYXRpb25GaWxsTW9kZSIsICJhbmltYXRpb25JdGVyYXRpb25Db3VudCIsICJhbmltYXRpb25OYW1lIiwgImFuaW1hdGlvblBsYXlTdGF0ZSIsICJhbmltYXRpb25UaW1pbmdGdW5jdGlvbiJdLAogICAgICAgICAgYmFja2dyb3VuZDogWyJiYWNrZ3JvdW5kQXR0YWNobWVudCIsICJiYWNrZ3JvdW5kQ2xpcCIsICJiYWNrZ3JvdW5kQ29sb3IiLCAiYmFja2dyb3VuZEltYWdlIiwgImJhY2tncm91bmRPcmlnaW4iLCAiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIiwgImJhY2tncm91bmRSZXBlYXQiLCAiYmFja2dyb3VuZFNpemUiXSwKICAgICAgICAgIGJhY2tncm91bmRQb3NpdGlvbjogWyJiYWNrZ3JvdW5kUG9zaXRpb25YIiwgImJhY2tncm91bmRQb3NpdGlvblkiXSwKICAgICAgICAgIGJvcmRlcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJCb3R0b21XaWR0aCIsICJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiLCAiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJSaWdodFN0eWxlIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wQ29sb3IiLCAiYm9yZGVyVG9wU3R5bGUiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckJsb2NrRW5kOiBbImJvcmRlckJsb2NrRW5kQ29sb3IiLCAiYm9yZGVyQmxvY2tFbmRTdHlsZSIsICJib3JkZXJCbG9ja0VuZFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja1N0YXJ0OiBbImJvcmRlckJsb2NrU3RhcnRDb2xvciIsICJib3JkZXJCbG9ja1N0YXJ0U3R5bGUiLCAiYm9yZGVyQmxvY2tTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCb3R0b206IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckNvbG9yOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclRvcENvbG9yIl0sCiAgICAgICAgICBib3JkZXJJbWFnZTogWyJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZUVuZDogWyJib3JkZXJJbmxpbmVFbmRDb2xvciIsICJib3JkZXJJbmxpbmVFbmRTdHlsZSIsICJib3JkZXJJbmxpbmVFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVySW5saW5lU3RhcnQ6IFsiYm9yZGVySW5saW5lU3RhcnRDb2xvciIsICJib3JkZXJJbmxpbmVTdGFydFN0eWxlIiwgImJvcmRlcklubGluZVN0YXJ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlckxlZnQ6IFsiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlclJhZGl1czogWyJib3JkZXJCb3R0b21MZWZ0UmFkaXVzIiwgImJvcmRlckJvdHRvbVJpZ2h0UmFkaXVzIiwgImJvcmRlclRvcExlZnRSYWRpdXMiLCAiYm9yZGVyVG9wUmlnaHRSYWRpdXMiXSwKICAgICAgICAgIGJvcmRlclJpZ2h0OiBbImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJTdHlsZTogWyJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJUb3BTdHlsZSJdLAogICAgICAgICAgYm9yZGVyVG9wOiBbImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJXaWR0aDogWyJib3JkZXJCb3R0b21XaWR0aCIsICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRXaWR0aCIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgY29sdW1uUnVsZTogWyJjb2x1bW5SdWxlQ29sb3IiLCAiY29sdW1uUnVsZVN0eWxlIiwgImNvbHVtblJ1bGVXaWR0aCJdLAogICAgICAgICAgY29sdW1uczogWyJjb2x1bW5Db3VudCIsICJjb2x1bW5XaWR0aCJdLAogICAgICAgICAgZmxleDogWyJmbGV4QmFzaXMiLCAiZmxleEdyb3ciLCAiZmxleFNocmluayJdLAogICAgICAgICAgZmxleEZsb3c6IFsiZmxleERpcmVjdGlvbiIsICJmbGV4V3JhcCJdLAogICAgICAgICAgZm9udDogWyJmb250RmFtaWx5IiwgImZvbnRGZWF0dXJlU2V0dGluZ3MiLCAiZm9udEtlcm5pbmciLCAiZm9udExhbmd1YWdlT3ZlcnJpZGUiLCAiZm9udFNpemUiLCAiZm9udFNpemVBZGp1c3QiLCAiZm9udFN0cmV0Y2giLCAiZm9udFN0eWxlIiwgImZvbnRWYXJpYW50IiwgImZvbnRWYXJpYW50QWx0ZXJuYXRlcyIsICJmb250VmFyaWFudENhcHMiLCAiZm9udFZhcmlhbnRFYXN0QXNpYW4iLCAiZm9udFZhcmlhbnRMaWdhdHVyZXMiLCAiZm9udFZhcmlhbnROdW1lcmljIiwgImZvbnRWYXJpYW50UG9zaXRpb24iLCAiZm9udFdlaWdodCIsICJsaW5lSGVpZ2h0Il0sCiAgICAgICAgICBmb250VmFyaWFudDogWyJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIl0sCiAgICAgICAgICBnYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZDogWyJncmlkQXV0b0NvbHVtbnMiLCAiZ3JpZEF1dG9GbG93IiwgImdyaWRBdXRvUm93cyIsICJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGdyaWRBcmVhOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0IiwgImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICBncmlkQ29sdW1uOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0Il0sCiAgICAgICAgICBncmlkQ29sdW1uR2FwOiBbImNvbHVtbkdhcCJdLAogICAgICAgICAgZ3JpZEdhcDogWyJjb2x1bW5HYXAiLCAicm93R2FwIl0sCiAgICAgICAgICBncmlkUm93OiBbImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICBncmlkUm93R2FwOiBbInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFRlbXBsYXRlOiBbImdyaWRUZW1wbGF0ZUFyZWFzIiwgImdyaWRUZW1wbGF0ZUNvbHVtbnMiLCAiZ3JpZFRlbXBsYXRlUm93cyJdLAogICAgICAgICAgbGlzdFN0eWxlOiBbImxpc3RTdHlsZUltYWdlIiwgImxpc3RTdHlsZVBvc2l0aW9uIiwgImxpc3RTdHlsZVR5cGUiXSwKICAgICAgICAgIG1hcmdpbjogWyJtYXJnaW5Cb3R0b20iLCAibWFyZ2luTGVmdCIsICJtYXJnaW5SaWdodCIsICJtYXJnaW5Ub3AiXSwKICAgICAgICAgIG1hcmtlcjogWyJtYXJrZXJFbmQiLCAibWFya2VyTWlkIiwgIm1hcmtlclN0YXJ0Il0sCiAgICAgICAgICBtYXNrOiBbIm1hc2tDbGlwIiwgIm1hc2tDb21wb3NpdGUiLCAibWFza0ltYWdlIiwgIm1hc2tNb2RlIiwgIm1hc2tPcmlnaW4iLCAibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIiwgIm1hc2tSZXBlYXQiLCAibWFza1NpemUiXSwKICAgICAgICAgIG1hc2tQb3NpdGlvbjogWyJtYXNrUG9zaXRpb25YIiwgIm1hc2tQb3NpdGlvblkiXSwKICAgICAgICAgIG91dGxpbmU6IFsib3V0bGluZUNvbG9yIiwgIm91dGxpbmVTdHlsZSIsICJvdXRsaW5lV2lkdGgiXSwKICAgICAgICAgIG92ZXJmbG93OiBbIm92ZXJmbG93WCIsICJvdmVyZmxvd1kiXSwKICAgICAgICAgIHBhZGRpbmc6IFsicGFkZGluZ0JvdHRvbSIsICJwYWRkaW5nTGVmdCIsICJwYWRkaW5nUmlnaHQiLCAicGFkZGluZ1RvcCJdLAogICAgICAgICAgcGxhY2VDb250ZW50OiBbImFsaWduQ29udGVudCIsICJqdXN0aWZ5Q29udGVudCJdLAogICAgICAgICAgcGxhY2VJdGVtczogWyJhbGlnbkl0ZW1zIiwgImp1c3RpZnlJdGVtcyJdLAogICAgICAgICAgcGxhY2VTZWxmOiBbImFsaWduU2VsZiIsICJqdXN0aWZ5U2VsZiJdLAogICAgICAgICAgdGV4dERlY29yYXRpb246IFsidGV4dERlY29yYXRpb25Db2xvciIsICJ0ZXh0RGVjb3JhdGlvbkxpbmUiLCAidGV4dERlY29yYXRpb25TdHlsZSJdLAogICAgICAgICAgdGV4dEVtcGhhc2lzOiBbInRleHRFbXBoYXNpc0NvbG9yIiwgInRleHRFbXBoYXNpc1N0eWxlIl0sCiAgICAgICAgICB0cmFuc2l0aW9uOiBbInRyYW5zaXRpb25EZWxheSIsICJ0cmFuc2l0aW9uRHVyYXRpb24iLCAidHJhbnNpdGlvblByb3BlcnR5IiwgInRyYW5zaXRpb25UaW1pbmdGdW5jdGlvbiJdLAogICAgICAgICAgd29yZFdyYXA6IFsib3ZlcmZsb3dXcmFwIl0KICAgICAgICB9OwogICAgICAgIHZhciBpc1VuaXRsZXNzTnVtYmVyID0gewogICAgICAgICAgYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQ6IHRydWUsCiAgICAgICAgICBhc3BlY3RSYXRpbzogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlT3V0c2V0OiB0cnVlLAogICAgICAgICAgYm9yZGVySW1hZ2VTbGljZTogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlV2lkdGg6IHRydWUsCiAgICAgICAgICBib3hGbGV4OiB0cnVlLAogICAgICAgICAgYm94RmxleEdyb3VwOiB0cnVlLAogICAgICAgICAgYm94T3JkaW5hbEdyb3VwOiB0cnVlLAogICAgICAgICAgY29sdW1uQ291bnQ6IHRydWUsCiAgICAgICAgICBjb2x1bW5zOiB0cnVlLAogICAgICAgICAgZmxleDogdHJ1ZSwKICAgICAgICAgIGZsZXhHcm93OiB0cnVlLAogICAgICAgICAgZmxleFBvc2l0aXZlOiB0cnVlLAogICAgICAgICAgZmxleFNocmluazogdHJ1ZSwKICAgICAgICAgIGZsZXhOZWdhdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhPcmRlcjogdHJ1ZSwKICAgICAgICAgIGdyaWRBcmVhOiB0cnVlLAogICAgICAgICAgZ3JpZFJvdzogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dFbmQ6IHRydWUsCiAgICAgICAgICBncmlkUm93U3BhbjogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dTdGFydDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW46IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uRW5kOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblNwYW46IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uU3RhcnQ6IHRydWUsCiAgICAgICAgICBmb250V2VpZ2h0OiB0cnVlLAogICAgICAgICAgbGluZUNsYW1wOiB0cnVlLAogICAgICAgICAgbGluZUhlaWdodDogdHJ1ZSwKICAgICAgICAgIG9wYWNpdHk6IHRydWUsCiAgICAgICAgICBvcmRlcjogdHJ1ZSwKICAgICAgICAgIG9ycGhhbnM6IHRydWUsCiAgICAgICAgICB0YWJTaXplOiB0cnVlLAogICAgICAgICAgd2lkb3dzOiB0cnVlLAogICAgICAgICAgekluZGV4OiB0cnVlLAogICAgICAgICAgem9vbTogdHJ1ZSwKICAgICAgICAgIC8vIFNWRy1yZWxhdGVkIHByb3BlcnRpZXMKICAgICAgICAgIGZpbGxPcGFjaXR5OiB0cnVlLAogICAgICAgICAgZmxvb2RPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3RvcE9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRydWUsCiAgICAgICAgICBzdHJva2VEYXNob2Zmc2V0OiB0cnVlLAogICAgICAgICAgc3Ryb2tlTWl0ZXJsaW1pdDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdHJva2VXaWR0aDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcHJlZml4S2V5KHByZWZpeDIsIGtleSkgewogICAgICAgICAgcmV0dXJuIHByZWZpeDIgKyBrZXkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc3Vic3RyaW5nKDEpOwogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ZXMyID0gWyJXZWJraXQiLCAibXMiLCAiTW96IiwgIk8iXTsKICAgICAgICBPYmplY3Qua2V5cyhpc1VuaXRsZXNzTnVtYmVyKS5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgICAgIHByZWZpeGVzMi5mb3JFYWNoKGZ1bmN0aW9uKHByZWZpeDIpIHsKICAgICAgICAgICAgaXNVbml0bGVzc051bWJlcltwcmVmaXhLZXkocHJlZml4MiwgcHJvcCldID0gaXNVbml0bGVzc051bWJlcltwcm9wXTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGZ1bmN0aW9uIGRhbmdlcm91c1N0eWxlVmFsdWUobmFtZSwgdmFsdWUsIGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgIHZhciBpc0VtcHR5ID0gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgICBpZiAoaXNFbXB0eSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkgJiYgdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiB2YWx1ZSAhPT0gMCAmJiAhKGlzVW5pdGxlc3NOdW1iZXIuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgaXNVbml0bGVzc051bWJlcltuYW1lXSkpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlICsgInB4IjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tDU1NQcm9wZXJ0eVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBuYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAoIiIgKyB2YWx1ZSkudHJpbSgpOwogICAgICAgIH0KICAgICAgICB2YXIgdXBwZXJjYXNlUGF0dGVybiA9IC8oW0EtWl0pL2c7CiAgICAgICAgdmFyIG1zUGF0dGVybiA9IC9ebXMtLzsKICAgICAgICBmdW5jdGlvbiBoeXBoZW5hdGVTdHlsZU5hbWUobmFtZSkgewogICAgICAgICAgcmV0dXJuIG5hbWUucmVwbGFjZSh1cHBlcmNhc2VQYXR0ZXJuLCAiLSQxIikudG9Mb3dlckNhc2UoKS5yZXBsYWNlKG1zUGF0dGVybiwgIi1tcy0iKTsKICAgICAgICB9CiAgICAgICAgdmFyIHdhcm5WYWxpZFN0eWxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgYmFkVmVuZG9yZWRTdHlsZU5hbWVQYXR0ZXJuID0gL14oPzp3ZWJraXR8bW96fG8pW0EtWl0vOwogICAgICAgICAgdmFyIG1zUGF0dGVybiQxID0gL14tbXMtLzsKICAgICAgICAgIHZhciBoeXBoZW5QYXR0ZXJuID0gLy0oLikvZzsKICAgICAgICAgIHZhciBiYWRTdHlsZVZhbHVlV2l0aFNlbWljb2xvblBhdHRlcm4gPSAvO1xzKiQvOwogICAgICAgICAgdmFyIHdhcm5lZFN0eWxlTmFtZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZVZhbHVlcyA9IHt9OwogICAgICAgICAgdmFyIHdhcm5lZEZvck5hTlZhbHVlID0gZmFsc2U7CiAgICAgICAgICB2YXIgd2FybmVkRm9ySW5maW5pdHlWYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShoeXBoZW5QYXR0ZXJuLCBmdW5jdGlvbihfLCBjaGFyYWN0ZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gY2hhcmFjdGVyLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuSHlwaGVuYXRlZFN0eWxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKHdhcm5lZFN0eWxlTmFtZXMuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZU5hbWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoCiAgICAgICAgICAgICAgIlVuc3VwcG9ydGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIC8vIEFzIEFuZGkgU21pdGggc3VnZ2VzdHMKICAgICAgICAgICAgICAvLyAoaHR0cDovL3d3dy5hbmRpc21pdGguY29tL2Jsb2cvMjAxMi8wMi9tb2Rlcm5penItcHJlZml4ZWQvKSwgYW4gYC1tc2AgcHJlZml4CiAgICAgICAgICAgICAgLy8gaXMgY29udmVydGVkIHRvIGxvd2VyY2FzZSBgbXNgLgogICAgICAgICAgICAgIGNhbWVsaXplKG5hbWUucmVwbGFjZShtc1BhdHRlcm4kMSwgIm1zLSIpKQogICAgICAgICAgICApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuQmFkVmVuZG9yZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJVbnN1cHBvcnRlZCB2ZW5kb3ItcHJlZml4ZWQgc3R5bGUgcHJvcGVydHkgJXMuIERpZCB5b3UgbWVhbiAlcz8iLCBuYW1lLCBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZVZhbHVlcy5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSkgJiYgd2FybmVkU3R5bGVWYWx1ZXNbdmFsdWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKGBTdHlsZSBwcm9wZXJ0eSB2YWx1ZXMgc2hvdWxkbid0IGNvbnRhaW4gYSBzZW1pY29sb24uIFRyeSAiJXM6ICVzIiBpbnN0ZWFkLmAsIG5hbWUsIHZhbHVlLnJlcGxhY2UoYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuLCAiIikpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZUlzTmFOID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHdhcm5lZEZvck5hTlZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvck5hTlZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoImBOYU5gIGlzIGFuIGludmFsaWQgdmFsdWUgZm9yIHRoZSBgJXNgIGNzcyBzdHlsZSBwcm9wZXJ0eS4iLCBuYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc0luZmluaXR5ID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHdhcm5lZEZvckluZmluaXR5VmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkRm9ySW5maW5pdHlWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgSW5maW5pdHlgIGlzIGFuIGludmFsaWQgdmFsdWUgZm9yIHRoZSBgJXNgIGNzcyBzdHlsZSBwcm9wZXJ0eS4iLCBuYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgICB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChuYW1lLmluZGV4T2YoIi0iKSA+IC0xKSB7CiAgICAgICAgICAgICAgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUobmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFkVmVuZG9yZWRTdHlsZU5hbWVQYXR0ZXJuLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICB3YXJuQmFkVmVuZG9yZWRTdHlsZU5hbWUobmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgd2FyblN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmIChpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNOYU4obmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzRmluaXRlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgd2FyblN0eWxlVmFsdWVJc0luZmluaXR5KG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSQxID0gd2FyblZhbGlkU3R5bGU7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRGFuZ2Vyb3VzU3RyaW5nRm9yU3R5bGVzKHN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgc2VyaWFsaXplZCA9ICIiOwogICAgICAgICAgICB2YXIgZGVsaW1pdGVyID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgICBpZiAoIXN0eWxlcy5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBzdHlsZXNbc3R5bGVOYW1lXTsKICAgICAgICAgICAgICBpZiAoc3R5bGVWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNDdXN0b21Qcm9wZXJ0eSA9IHN0eWxlTmFtZS5pbmRleE9mKCItLSIpID09PSAwOwogICAgICAgICAgICAgICAgc2VyaWFsaXplZCArPSBkZWxpbWl0ZXIgKyAoaXNDdXN0b21Qcm9wZXJ0eSA/IHN0eWxlTmFtZSA6IGh5cGhlbmF0ZVN0eWxlTmFtZShzdHlsZU5hbWUpKSArICI6IjsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlVmFsdWUsIGlzQ3VzdG9tUHJvcGVydHkpOwogICAgICAgICAgICAgICAgZGVsaW1pdGVyID0gIjsiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2VyaWFsaXplZCB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRWYWx1ZUZvclN0eWxlcyhub2RlLCBzdHlsZXMpIHsKICAgICAgICAgIHZhciBzdHlsZTIgPSBub2RlLnN0eWxlOwogICAgICAgICAgZm9yICh2YXIgc3R5bGVOYW1lIGluIHN0eWxlcykgewogICAgICAgICAgICBpZiAoIXN0eWxlcy5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Qcm9wZXJ0eSkgewogICAgICAgICAgICAgICAgd2FyblZhbGlkU3R5bGUkMShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBkYW5nZXJvdXNTdHlsZVZhbHVlKHN0eWxlTmFtZSwgc3R5bGVzW3N0eWxlTmFtZV0sIGlzQ3VzdG9tUHJvcGVydHkpOwogICAgICAgICAgICBpZiAoc3R5bGVOYW1lID09PSAiZmxvYXQiKSB7CiAgICAgICAgICAgICAgc3R5bGVOYW1lID0gImNzc0Zsb2F0IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDdXN0b21Qcm9wZXJ0eSkgewogICAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eShzdHlsZU5hbWUsIHN0eWxlVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0eWxlMltzdHlsZU5hbWVdID0gc3R5bGVWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbHVlRW1wdHkodmFsdWUpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImJvb2xlYW4iIHx8IHZhbHVlID09PSAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXhwYW5kU2hvcnRoYW5kTWFwKHN0eWxlcykgewogICAgICAgICAgdmFyIGV4cGFuZGVkID0ge307CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgIHZhciBsb25naGFuZHMgPSBzaG9ydGhhbmRUb0xvbmdoYW5kW2tleV0gfHwgW2tleV07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbG9uZ2hhbmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZXhwYW5kZWRbbG9uZ2hhbmRzW2ldXSA9IGtleTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4cGFuZGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVNob3J0aGFuZFByb3BlcnR5Q29sbGlzaW9uSW5EZXYoc3R5bGVVcGRhdGVzLCBuZXh0U3R5bGVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbmV4dFN0eWxlcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhwYW5kZWRVcGRhdGVzID0gZXhwYW5kU2hvcnRoYW5kTWFwKHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICAgIHZhciBleHBhbmRlZFN0eWxlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChuZXh0U3R5bGVzKTsKICAgICAgICAgICAgdmFyIHdhcm5lZEFib3V0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBleHBhbmRlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxLZXkgPSBleHBhbmRlZFVwZGF0ZXNba2V5XTsKICAgICAgICAgICAgICB2YXIgY29ycmVjdE9yaWdpbmFsS2V5ID0gZXhwYW5kZWRTdHlsZXNba2V5XTsKICAgICAgICAgICAgICBpZiAoY29ycmVjdE9yaWdpbmFsS2V5ICYmIG9yaWdpbmFsS2V5ICE9PSBjb3JyZWN0T3JpZ2luYWxLZXkpIHsKICAgICAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gb3JpZ2luYWxLZXkgKyAiLCIgKyBjb3JyZWN0T3JpZ2luYWxLZXk7CiAgICAgICAgICAgICAgICBpZiAod2FybmVkQWJvdXRbd2FybmluZ0tleV0pIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3YXJuZWRBYm91dFt3YXJuaW5nS2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgYSBzdHlsZSBwcm9wZXJ0eSBkdXJpbmcgcmVyZW5kZXIgKCVzKSB3aGVuIGEgY29uZmxpY3RpbmcgcHJvcGVydHkgaXMgc2V0ICglcykgY2FuIGxlYWQgdG8gc3R5bGluZyBidWdzLiBUbyBhdm9pZCB0aGlzLCBkb24ndCBtaXggc2hvcnRoYW5kIGFuZCBub24tc2hvcnRoYW5kIHByb3BlcnRpZXMgZm9yIHRoZSBzYW1lIHZhbHVlOyBpbnN0ZWFkLCByZXBsYWNlIHRoZSBzaG9ydGhhbmQgd2l0aCBzZXBhcmF0ZSB2YWx1ZXMuIiwgaXNWYWx1ZUVtcHR5KHN0eWxlVXBkYXRlc1tvcmlnaW5hbEtleV0pID8gIlJlbW92aW5nIiA6ICJVcGRhdGluZyIsIG9yaWdpbmFsS2V5LCBjb3JyZWN0T3JpZ2luYWxLZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgb21pdHRlZENsb3NlVGFncyA9IHsKICAgICAgICAgIGFyZWE6IHRydWUsCiAgICAgICAgICBiYXNlOiB0cnVlLAogICAgICAgICAgYnI6IHRydWUsCiAgICAgICAgICBjb2w6IHRydWUsCiAgICAgICAgICBlbWJlZDogdHJ1ZSwKICAgICAgICAgIGhyOiB0cnVlLAogICAgICAgICAgaW1nOiB0cnVlLAogICAgICAgICAgaW5wdXQ6IHRydWUsCiAgICAgICAgICBrZXlnZW46IHRydWUsCiAgICAgICAgICBsaW5rOiB0cnVlLAogICAgICAgICAgbWV0YTogdHJ1ZSwKICAgICAgICAgIHBhcmFtOiB0cnVlLAogICAgICAgICAgc291cmNlOiB0cnVlLAogICAgICAgICAgdHJhY2s6IHRydWUsCiAgICAgICAgICB3YnI6IHRydWUKICAgICAgICAgIC8vIE5PVEU6IG1lbnVpdGVtJ3MgY2xvc2UgdGFnIHNob3VsZCBiZSBvbWl0dGVkLCBidXQgdGhhdCBjYXVzZXMgcHJvYmxlbXMuCiAgICAgICAgfTsKICAgICAgICB2YXIgdm9pZEVsZW1lbnRUYWdzID0gYXNzaWduMih7CiAgICAgICAgICBtZW51aXRlbTogdHJ1ZQogICAgICAgIH0sIG9taXR0ZWRDbG9zZVRhZ3MpOwogICAgICAgIHZhciBIVE1MID0gIl9faHRtbCI7CiAgICAgICAgZnVuY3Rpb24gYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHByb3BzKSB7CiAgICAgICAgICBpZiAoIXByb3BzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2b2lkRWxlbWVudFRhZ3NbdGFnXSkgewogICAgICAgICAgICBpZiAocHJvcHMuY2hpbGRyZW4gIT0gbnVsbCB8fCBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRhZyArICIgaXMgYSB2b2lkIGVsZW1lbnQgdGFnIGFuZCBtdXN0IG5laXRoZXIgaGF2ZSBgY2hpbGRyZW5gIG5vciB1c2UgYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbiBvbmx5IHNldCBvbmUgb2YgYGNoaWxkcmVuYCBvciBgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09ICJvYmplY3QiIHx8ICEoSFRNTCBpbiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCkpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTGAgbXVzdCBiZSBpbiB0aGUgZm9ybSBge19faHRtbDogLi4ufWAuIFBsZWFzZSB2aXNpdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGFuZ2Vyb3VzbHktc2V0LWlubmVyLWh0bWwgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFwcm9wcy5zdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmcgJiYgcHJvcHMuY29udGVudEVkaXRhYmxlICYmIHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgYGNvbnRlbnRFZGl0YWJsZWAgYW5kIGNvbnRhaW5zIGBjaGlsZHJlbmAgbWFuYWdlZCBieSBSZWFjdC4gSXQgaXMgbm93IHlvdXIgcmVzcG9uc2liaWxpdHkgdG8gZ3VhcmFudGVlIHRoYXQgbm9uZSBvZiB0aG9zZSBub2RlcyBhcmUgdW5leHBlY3RlZGx5IG1vZGlmaWVkIG9yIGR1cGxpY2F0ZWQuIFRoaXMgaXMgcHJvYmFibHkgbm90IGludGVudGlvbmFsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcHMuc3R5bGUgIT0gbnVsbCAmJiB0eXBlb2YgcHJvcHMuc3R5bGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBzdHlsZWAgcHJvcCBleHBlY3RzIGEgbWFwcGluZyBmcm9tIHN0eWxlIHByb3BlcnRpZXMgdG8gdmFsdWVzLCBub3QgYSBzdHJpbmcuIEZvciBleGFtcGxlLCBzdHlsZT17e21hcmdpblJpZ2h0OiBzcGFjaW5nICsgJ2VtJ319IHdoZW4gdXNpbmcgSlNYLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0N1c3RvbUNvbXBvbmVudCh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgaWYgKHRhZ05hbWUuaW5kZXhPZigiLSIpID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHByb3BzLmlzID09PSAic3RyaW5nIjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnTmFtZSkgewogICAgICAgICAgICBjYXNlICJhbm5vdGF0aW9uLXhtbCI6CiAgICAgICAgICAgIGNhc2UgImNvbG9yLXByb2ZpbGUiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2Utc3JjIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXVyaSI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1mb3JtYXQiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtbmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm1pc3NpbmctZ2x5cGgiOgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBvc3NpYmxlU3RhbmRhcmROYW1lcyA9IHsKICAgICAgICAgIC8vIEhUTUwKICAgICAgICAgIGFjY2VwdDogImFjY2VwdCIsCiAgICAgICAgICBhY2NlcHRjaGFyc2V0OiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICAiYWNjZXB0LWNoYXJzZXQiOiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICBhY2Nlc3NrZXk6ICJhY2Nlc3NLZXkiLAogICAgICAgICAgYWN0aW9uOiAiYWN0aW9uIiwKICAgICAgICAgIGFsbG93ZnVsbHNjcmVlbjogImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICBhbHQ6ICJhbHQiLAogICAgICAgICAgYXM6ICJhcyIsCiAgICAgICAgICBhc3luYzogImFzeW5jIiwKICAgICAgICAgIGF1dG9jYXBpdGFsaXplOiAiYXV0b0NhcGl0YWxpemUiLAogICAgICAgICAgYXV0b2NvbXBsZXRlOiAiYXV0b0NvbXBsZXRlIiwKICAgICAgICAgIGF1dG9jb3JyZWN0OiAiYXV0b0NvcnJlY3QiLAogICAgICAgICAgYXV0b2ZvY3VzOiAiYXV0b0ZvY3VzIiwKICAgICAgICAgIGF1dG9wbGF5OiAiYXV0b1BsYXkiLAogICAgICAgICAgYXV0b3NhdmU6ICJhdXRvU2F2ZSIsCiAgICAgICAgICBjYXB0dXJlOiAiY2FwdHVyZSIsCiAgICAgICAgICBjZWxscGFkZGluZzogImNlbGxQYWRkaW5nIiwKICAgICAgICAgIGNlbGxzcGFjaW5nOiAiY2VsbFNwYWNpbmciLAogICAgICAgICAgY2hhbGxlbmdlOiAiY2hhbGxlbmdlIiwKICAgICAgICAgIGNoYXJzZXQ6ICJjaGFyU2V0IiwKICAgICAgICAgIGNoZWNrZWQ6ICJjaGVja2VkIiwKICAgICAgICAgIGNoaWxkcmVuOiAiY2hpbGRyZW4iLAogICAgICAgICAgY2l0ZTogImNpdGUiLAogICAgICAgICAgY2xhc3M6ICJjbGFzc05hbWUiLAogICAgICAgICAgY2xhc3NpZDogImNsYXNzSUQiLAogICAgICAgICAgY2xhc3NuYW1lOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNvbHM6ICJjb2xzIiwKICAgICAgICAgIGNvbHNwYW46ICJjb2xTcGFuIiwKICAgICAgICAgIGNvbnRlbnQ6ICJjb250ZW50IiwKICAgICAgICAgIGNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIsCiAgICAgICAgICBjb250ZXh0bWVudTogImNvbnRleHRNZW51IiwKICAgICAgICAgIGNvbnRyb2xzOiAiY29udHJvbHMiLAogICAgICAgICAgY29udHJvbHNsaXN0OiAiY29udHJvbHNMaXN0IiwKICAgICAgICAgIGNvb3JkczogImNvb3JkcyIsCiAgICAgICAgICBjcm9zc29yaWdpbjogImNyb3NzT3JpZ2luIiwKICAgICAgICAgIGRhbmdlcm91c2x5c2V0aW5uZXJodG1sOiAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLAogICAgICAgICAgZGF0YTogImRhdGEiLAogICAgICAgICAgZGF0ZXRpbWU6ICJkYXRlVGltZSIsCiAgICAgICAgICBkZWZhdWx0OiAiZGVmYXVsdCIsCiAgICAgICAgICBkZWZhdWx0Y2hlY2tlZDogImRlZmF1bHRDaGVja2VkIiwKICAgICAgICAgIGRlZmF1bHR2YWx1ZTogImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICBkZWZlcjogImRlZmVyIiwKICAgICAgICAgIGRpcjogImRpciIsCiAgICAgICAgICBkaXNhYmxlZDogImRpc2FibGVkIiwKICAgICAgICAgIGRpc2FibGVwaWN0dXJlaW5waWN0dXJlOiAiZGlzYWJsZVBpY3R1cmVJblBpY3R1cmUiLAogICAgICAgICAgZGlzYWJsZXJlbW90ZXBsYXliYWNrOiAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgIGRvd25sb2FkOiAiZG93bmxvYWQiLAogICAgICAgICAgZHJhZ2dhYmxlOiAiZHJhZ2dhYmxlIiwKICAgICAgICAgIGVuY3R5cGU6ICJlbmNUeXBlIiwKICAgICAgICAgIGVudGVya2V5aGludDogImVudGVyS2V5SGludCIsCiAgICAgICAgICBmb3I6ICJodG1sRm9yIiwKICAgICAgICAgIGZvcm06ICJmb3JtIiwKICAgICAgICAgIGZvcm1tZXRob2Q6ICJmb3JtTWV0aG9kIiwKICAgICAgICAgIGZvcm1hY3Rpb246ICJmb3JtQWN0aW9uIiwKICAgICAgICAgIGZvcm1lbmN0eXBlOiAiZm9ybUVuY1R5cGUiLAogICAgICAgICAgZm9ybW5vdmFsaWRhdGU6ICJmb3JtTm9WYWxpZGF0ZSIsCiAgICAgICAgICBmb3JtdGFyZ2V0OiAiZm9ybVRhcmdldCIsCiAgICAgICAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgICAgICAgIGhlYWRlcnM6ICJoZWFkZXJzIiwKICAgICAgICAgIGhlaWdodDogImhlaWdodCIsCiAgICAgICAgICBoaWRkZW46ICJoaWRkZW4iLAogICAgICAgICAgaGlnaDogImhpZ2giLAogICAgICAgICAgaHJlZjogImhyZWYiLAogICAgICAgICAgaHJlZmxhbmc6ICJocmVmTGFuZyIsCiAgICAgICAgICBodG1sZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBodHRwZXF1aXY6ICJodHRwRXF1aXYiLAogICAgICAgICAgImh0dHAtZXF1aXYiOiAiaHR0cEVxdWl2IiwKICAgICAgICAgIGljb246ICJpY29uIiwKICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgaW1hZ2VzaXplczogImltYWdlU2l6ZXMiLAogICAgICAgICAgaW1hZ2VzcmNzZXQ6ICJpbWFnZVNyY1NldCIsCiAgICAgICAgICBpbm5lcmh0bWw6ICJpbm5lckhUTUwiLAogICAgICAgICAgaW5wdXRtb2RlOiAiaW5wdXRNb2RlIiwKICAgICAgICAgIGludGVncml0eTogImludGVncml0eSIsCiAgICAgICAgICBpczogImlzIiwKICAgICAgICAgIGl0ZW1pZDogIml0ZW1JRCIsCiAgICAgICAgICBpdGVtcHJvcDogIml0ZW1Qcm9wIiwKICAgICAgICAgIGl0ZW1yZWY6ICJpdGVtUmVmIiwKICAgICAgICAgIGl0ZW1zY29wZTogIml0ZW1TY29wZSIsCiAgICAgICAgICBpdGVtdHlwZTogIml0ZW1UeXBlIiwKICAgICAgICAgIGtleXBhcmFtczogImtleVBhcmFtcyIsCiAgICAgICAgICBrZXl0eXBlOiAia2V5VHlwZSIsCiAgICAgICAgICBraW5kOiAia2luZCIsCiAgICAgICAgICBsYWJlbDogImxhYmVsIiwKICAgICAgICAgIGxhbmc6ICJsYW5nIiwKICAgICAgICAgIGxpc3Q6ICJsaXN0IiwKICAgICAgICAgIGxvb3A6ICJsb29wIiwKICAgICAgICAgIGxvdzogImxvdyIsCiAgICAgICAgICBtYW5pZmVzdDogIm1hbmlmZXN0IiwKICAgICAgICAgIG1hcmdpbndpZHRoOiAibWFyZ2luV2lkdGgiLAogICAgICAgICAgbWFyZ2luaGVpZ2h0OiAibWFyZ2luSGVpZ2h0IiwKICAgICAgICAgIG1heDogIm1heCIsCiAgICAgICAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgICAgICAgbWVkaWE6ICJtZWRpYSIsCiAgICAgICAgICBtZWRpYWdyb3VwOiAibWVkaWFHcm91cCIsCiAgICAgICAgICBtZXRob2Q6ICJtZXRob2QiLAogICAgICAgICAgbWluOiAibWluIiwKICAgICAgICAgIG1pbmxlbmd0aDogIm1pbkxlbmd0aCIsCiAgICAgICAgICBtdWx0aXBsZTogIm11bHRpcGxlIiwKICAgICAgICAgIG11dGVkOiAibXV0ZWQiLAogICAgICAgICAgbmFtZTogIm5hbWUiLAogICAgICAgICAgbm9tb2R1bGU6ICJub01vZHVsZSIsCiAgICAgICAgICBub25jZTogIm5vbmNlIiwKICAgICAgICAgIG5vdmFsaWRhdGU6ICJub1ZhbGlkYXRlIiwKICAgICAgICAgIG9wZW46ICJvcGVuIiwKICAgICAgICAgIG9wdGltdW06ICJvcHRpbXVtIiwKICAgICAgICAgIHBhdHRlcm46ICJwYXR0ZXJuIiwKICAgICAgICAgIHBsYWNlaG9sZGVyOiAicGxhY2Vob2xkZXIiLAogICAgICAgICAgcGxheXNpbmxpbmU6ICJwbGF5c0lubGluZSIsCiAgICAgICAgICBwb3N0ZXI6ICJwb3N0ZXIiLAogICAgICAgICAgcHJlbG9hZDogInByZWxvYWQiLAogICAgICAgICAgcHJvZmlsZTogInByb2ZpbGUiLAogICAgICAgICAgcmFkaW9ncm91cDogInJhZGlvR3JvdXAiLAogICAgICAgICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAgICAgICByZWZlcnJlcnBvbGljeTogInJlZmVycmVyUG9saWN5IiwKICAgICAgICAgIHJlbDogInJlbCIsCiAgICAgICAgICByZXF1aXJlZDogInJlcXVpcmVkIiwKICAgICAgICAgIHJldmVyc2VkOiAicmV2ZXJzZWQiLAogICAgICAgICAgcm9sZTogInJvbGUiLAogICAgICAgICAgcm93czogInJvd3MiLAogICAgICAgICAgcm93c3BhbjogInJvd1NwYW4iLAogICAgICAgICAgc2FuZGJveDogInNhbmRib3giLAogICAgICAgICAgc2NvcGU6ICJzY29wZSIsCiAgICAgICAgICBzY29wZWQ6ICJzY29wZWQiLAogICAgICAgICAgc2Nyb2xsaW5nOiAic2Nyb2xsaW5nIiwKICAgICAgICAgIHNlYW1sZXNzOiAic2VhbWxlc3MiLAogICAgICAgICAgc2VsZWN0ZWQ6ICJzZWxlY3RlZCIsCiAgICAgICAgICBzaGFwZTogInNoYXBlIiwKICAgICAgICAgIHNpemU6ICJzaXplIiwKICAgICAgICAgIHNpemVzOiAic2l6ZXMiLAogICAgICAgICAgc3BhbjogInNwYW4iLAogICAgICAgICAgc3BlbGxjaGVjazogInNwZWxsQ2hlY2siLAogICAgICAgICAgc3JjOiAic3JjIiwKICAgICAgICAgIHNyY2RvYzogInNyY0RvYyIsCiAgICAgICAgICBzcmNsYW5nOiAic3JjTGFuZyIsCiAgICAgICAgICBzcmNzZXQ6ICJzcmNTZXQiLAogICAgICAgICAgc3RhcnQ6ICJzdGFydCIsCiAgICAgICAgICBzdGVwOiAic3RlcCIsCiAgICAgICAgICBzdHlsZTogInN0eWxlIiwKICAgICAgICAgIHN1bW1hcnk6ICJzdW1tYXJ5IiwKICAgICAgICAgIHRhYmluZGV4OiAidGFiSW5kZXgiLAogICAgICAgICAgdGFyZ2V0OiAidGFyZ2V0IiwKICAgICAgICAgIHRpdGxlOiAidGl0bGUiLAogICAgICAgICAgdHlwZTogInR5cGUiLAogICAgICAgICAgdXNlbWFwOiAidXNlTWFwIiwKICAgICAgICAgIHZhbHVlOiAidmFsdWUiLAogICAgICAgICAgd2lkdGg6ICJ3aWR0aCIsCiAgICAgICAgICB3bW9kZTogIndtb2RlIiwKICAgICAgICAgIHdyYXA6ICJ3cmFwIiwKICAgICAgICAgIC8vIFNWRwogICAgICAgICAgYWJvdXQ6ICJhYm91dCIsCiAgICAgICAgICBhY2NlbnRoZWlnaHQ6ICJhY2NlbnRIZWlnaHQiLAogICAgICAgICAgImFjY2VudC1oZWlnaHQiOiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgIGFjY3VtdWxhdGU6ICJhY2N1bXVsYXRlIiwKICAgICAgICAgIGFkZGl0aXZlOiAiYWRkaXRpdmUiLAogICAgICAgICAgYWxpZ25tZW50YmFzZWxpbmU6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIjogImFsaWdubWVudEJhc2VsaW5lIiwKICAgICAgICAgIGFsbG93cmVvcmRlcjogImFsbG93UmVvcmRlciIsCiAgICAgICAgICBhbHBoYWJldGljOiAiYWxwaGFiZXRpYyIsCiAgICAgICAgICBhbXBsaXR1ZGU6ICJhbXBsaXR1ZGUiLAogICAgICAgICAgYXJhYmljZm9ybTogImFyYWJpY0Zvcm0iLAogICAgICAgICAgImFyYWJpYy1mb3JtIjogImFyYWJpY0Zvcm0iLAogICAgICAgICAgYXNjZW50OiAiYXNjZW50IiwKICAgICAgICAgIGF0dHJpYnV0ZW5hbWU6ICJhdHRyaWJ1dGVOYW1lIiwKICAgICAgICAgIGF0dHJpYnV0ZXR5cGU6ICJhdHRyaWJ1dGVUeXBlIiwKICAgICAgICAgIGF1dG9yZXZlcnNlOiAiYXV0b1JldmVyc2UiLAogICAgICAgICAgYXppbXV0aDogImF6aW11dGgiLAogICAgICAgICAgYmFzZWZyZXF1ZW5jeTogImJhc2VGcmVxdWVuY3kiLAogICAgICAgICAgYmFzZWxpbmVzaGlmdDogImJhc2VsaW5lU2hpZnQiLAogICAgICAgICAgImJhc2VsaW5lLXNoaWZ0IjogImJhc2VsaW5lU2hpZnQiLAogICAgICAgICAgYmFzZXByb2ZpbGU6ICJiYXNlUHJvZmlsZSIsCiAgICAgICAgICBiYm94OiAiYmJveCIsCiAgICAgICAgICBiZWdpbjogImJlZ2luIiwKICAgICAgICAgIGJpYXM6ICJiaWFzIiwKICAgICAgICAgIGJ5OiAiYnkiLAogICAgICAgICAgY2FsY21vZGU6ICJjYWxjTW9kZSIsCiAgICAgICAgICBjYXBoZWlnaHQ6ICJjYXBIZWlnaHQiLAogICAgICAgICAgImNhcC1oZWlnaHQiOiAiY2FwSGVpZ2h0IiwKICAgICAgICAgIGNsaXA6ICJjbGlwIiwKICAgICAgICAgIGNsaXBwYXRoOiAiY2xpcFBhdGgiLAogICAgICAgICAgImNsaXAtcGF0aCI6ICJjbGlwUGF0aCIsCiAgICAgICAgICBjbGlwcGF0aHVuaXRzOiAiY2xpcFBhdGhVbml0cyIsCiAgICAgICAgICBjbGlwcnVsZTogImNsaXBSdWxlIiwKICAgICAgICAgICJjbGlwLXJ1bGUiOiAiY2xpcFJ1bGUiLAogICAgICAgICAgY29sb3I6ICJjb2xvciIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb246ICJjb2xvckludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgIGNvbG9yaW50ZXJwb2xhdGlvbmZpbHRlcnM6ICJjb2xvckludGVycG9sYXRpb25GaWx0ZXJzIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICBjb2xvcnByb2ZpbGU6ICJjb2xvclByb2ZpbGUiLAogICAgICAgICAgImNvbG9yLXByb2ZpbGUiOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgIGNvbG9ycmVuZGVyaW5nOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgImNvbG9yLXJlbmRlcmluZyI6ICJjb2xvclJlbmRlcmluZyIsCiAgICAgICAgICBjb250ZW50c2NyaXB0dHlwZTogImNvbnRlbnRTY3JpcHRUeXBlIiwKICAgICAgICAgIGNvbnRlbnRzdHlsZXR5cGU6ICJjb250ZW50U3R5bGVUeXBlIiwKICAgICAgICAgIGN1cnNvcjogImN1cnNvciIsCiAgICAgICAgICBjeDogImN4IiwKICAgICAgICAgIGN5OiAiY3kiLAogICAgICAgICAgZDogImQiLAogICAgICAgICAgZGF0YXR5cGU6ICJkYXRhdHlwZSIsCiAgICAgICAgICBkZWNlbGVyYXRlOiAiZGVjZWxlcmF0ZSIsCiAgICAgICAgICBkZXNjZW50OiAiZGVzY2VudCIsCiAgICAgICAgICBkaWZmdXNlY29uc3RhbnQ6ICJkaWZmdXNlQ29uc3RhbnQiLAogICAgICAgICAgZGlyZWN0aW9uOiAiZGlyZWN0aW9uIiwKICAgICAgICAgIGRpc3BsYXk6ICJkaXNwbGF5IiwKICAgICAgICAgIGRpdmlzb3I6ICJkaXZpc29yIiwKICAgICAgICAgIGRvbWluYW50YmFzZWxpbmU6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSI6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgIGR1cjogImR1ciIsCiAgICAgICAgICBkeDogImR4IiwKICAgICAgICAgIGR5OiAiZHkiLAogICAgICAgICAgZWRnZW1vZGU6ICJlZGdlTW9kZSIsCiAgICAgICAgICBlbGV2YXRpb246ICJlbGV2YXRpb24iLAogICAgICAgICAgZW5hYmxlYmFja2dyb3VuZDogImVuYWJsZUJhY2tncm91bmQiLAogICAgICAgICAgImVuYWJsZS1iYWNrZ3JvdW5kIjogImVuYWJsZUJhY2tncm91bmQiLAogICAgICAgICAgZW5kOiAiZW5kIiwKICAgICAgICAgIGV4cG9uZW50OiAiZXhwb25lbnQiLAogICAgICAgICAgZXh0ZXJuYWxyZXNvdXJjZXNyZXF1aXJlZDogImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLAogICAgICAgICAgZmlsbDogImZpbGwiLAogICAgICAgICAgZmlsbG9wYWNpdHk6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1vcGFjaXR5IjogImZpbGxPcGFjaXR5IiwKICAgICAgICAgIGZpbGxydWxlOiAiZmlsbFJ1bGUiLAogICAgICAgICAgImZpbGwtcnVsZSI6ICJmaWxsUnVsZSIsCiAgICAgICAgICBmaWx0ZXI6ICJmaWx0ZXIiLAogICAgICAgICAgZmlsdGVycmVzOiAiZmlsdGVyUmVzIiwKICAgICAgICAgIGZpbHRlcnVuaXRzOiAiZmlsdGVyVW5pdHMiLAogICAgICAgICAgZmxvb2RvcGFjaXR5OiAiZmxvb2RPcGFjaXR5IiwKICAgICAgICAgICJmbG9vZC1vcGFjaXR5IjogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICBmbG9vZGNvbG9yOiAiZmxvb2RDb2xvciIsCiAgICAgICAgICAiZmxvb2QtY29sb3IiOiAiZmxvb2RDb2xvciIsCiAgICAgICAgICBmb2N1c2FibGU6ICJmb2N1c2FibGUiLAogICAgICAgICAgZm9udGZhbWlseTogImZvbnRGYW1pbHkiLAogICAgICAgICAgImZvbnQtZmFtaWx5IjogImZvbnRGYW1pbHkiLAogICAgICAgICAgZm9udHNpemU6ICJmb250U2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplIjogImZvbnRTaXplIiwKICAgICAgICAgIGZvbnRzaXplYWRqdXN0OiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiOiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgZm9udHN0cmV0Y2g6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIjogImZvbnRTdHJldGNoIiwKICAgICAgICAgIGZvbnRzdHlsZTogImZvbnRTdHlsZSIsCiAgICAgICAgICAiZm9udC1zdHlsZSI6ICJmb250U3R5bGUiLAogICAgICAgICAgZm9udHZhcmlhbnQ6ICJmb250VmFyaWFudCIsCiAgICAgICAgICAiZm9udC12YXJpYW50IjogImZvbnRWYXJpYW50IiwKICAgICAgICAgIGZvbnR3ZWlnaHQ6ICJmb250V2VpZ2h0IiwKICAgICAgICAgICJmb250LXdlaWdodCI6ICJmb250V2VpZ2h0IiwKICAgICAgICAgIGZvcm1hdDogImZvcm1hdCIsCiAgICAgICAgICBmcm9tOiAiZnJvbSIsCiAgICAgICAgICBmeDogImZ4IiwKICAgICAgICAgIGZ5OiAiZnkiLAogICAgICAgICAgZzE6ICJnMSIsCiAgICAgICAgICBnMjogImcyIiwKICAgICAgICAgIGdseXBobmFtZTogImdseXBoTmFtZSIsCiAgICAgICAgICAiZ2x5cGgtbmFtZSI6ICJnbHlwaE5hbWUiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbmhvcml6b250YWw6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCI6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICBnbHlwaG9yaWVudGF0aW9udmVydGljYWw6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLXZlcnRpY2FsIjogImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgICAgICAgICBnbHlwaHJlZjogImdseXBoUmVmIiwKICAgICAgICAgIGdyYWRpZW50dHJhbnNmb3JtOiAiZ3JhZGllbnRUcmFuc2Zvcm0iLAogICAgICAgICAgZ3JhZGllbnR1bml0czogImdyYWRpZW50VW5pdHMiLAogICAgICAgICAgaGFuZ2luZzogImhhbmdpbmciLAogICAgICAgICAgaG9yaXphZHZ4OiAiaG9yaXpBZHZYIiwKICAgICAgICAgICJob3Jpei1hZHYteCI6ICJob3JpekFkdlgiLAogICAgICAgICAgaG9yaXpvcmlnaW54OiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgICJob3Jpei1vcmlnaW4teCI6ICJob3Jpek9yaWdpblgiLAogICAgICAgICAgaWRlb2dyYXBoaWM6ICJpZGVvZ3JhcGhpYyIsCiAgICAgICAgICBpbWFnZXJlbmRlcmluZzogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciOiAiaW1hZ2VSZW5kZXJpbmciLAogICAgICAgICAgaW4yOiAiaW4yIiwKICAgICAgICAgIGluOiAiaW4iLAogICAgICAgICAgaW5saXN0OiAiaW5saXN0IiwKICAgICAgICAgIGludGVyY2VwdDogImludGVyY2VwdCIsCiAgICAgICAgICBrMTogImsxIiwKICAgICAgICAgIGsyOiAiazIiLAogICAgICAgICAgazM6ICJrMyIsCiAgICAgICAgICBrNDogIms0IiwKICAgICAgICAgIGs6ICJrIiwKICAgICAgICAgIGtlcm5lbG1hdHJpeDogImtlcm5lbE1hdHJpeCIsCiAgICAgICAgICBrZXJuZWx1bml0bGVuZ3RoOiAia2VybmVsVW5pdExlbmd0aCIsCiAgICAgICAgICBrZXJuaW5nOiAia2VybmluZyIsCiAgICAgICAgICBrZXlwb2ludHM6ICJrZXlQb2ludHMiLAogICAgICAgICAga2V5c3BsaW5lczogImtleVNwbGluZXMiLAogICAgICAgICAga2V5dGltZXM6ICJrZXlUaW1lcyIsCiAgICAgICAgICBsZW5ndGhhZGp1c3Q6ICJsZW5ndGhBZGp1c3QiLAogICAgICAgICAgbGV0dGVyc3BhY2luZzogImxldHRlclNwYWNpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIjogImxldHRlclNwYWNpbmciLAogICAgICAgICAgbGlnaHRpbmdjb2xvcjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgImxpZ2h0aW5nLWNvbG9yIjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgbGltaXRpbmdjb25lYW5nbGU6ICJsaW1pdGluZ0NvbmVBbmdsZSIsCiAgICAgICAgICBsb2NhbDogImxvY2FsIiwKICAgICAgICAgIG1hcmtlcmVuZDogIm1hcmtlckVuZCIsCiAgICAgICAgICAibWFya2VyLWVuZCI6ICJtYXJrZXJFbmQiLAogICAgICAgICAgbWFya2VyaGVpZ2h0OiAibWFya2VySGVpZ2h0IiwKICAgICAgICAgIG1hcmtlcm1pZDogIm1hcmtlck1pZCIsCiAgICAgICAgICAibWFya2VyLW1pZCI6ICJtYXJrZXJNaWQiLAogICAgICAgICAgbWFya2Vyc3RhcnQ6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IjogIm1hcmtlclN0YXJ0IiwKICAgICAgICAgIG1hcmtlcnVuaXRzOiAibWFya2VyVW5pdHMiLAogICAgICAgICAgbWFya2Vyd2lkdGg6ICJtYXJrZXJXaWR0aCIsCiAgICAgICAgICBtYXNrOiAibWFzayIsCiAgICAgICAgICBtYXNrY29udGVudHVuaXRzOiAibWFza0NvbnRlbnRVbml0cyIsCiAgICAgICAgICBtYXNrdW5pdHM6ICJtYXNrVW5pdHMiLAogICAgICAgICAgbWF0aGVtYXRpY2FsOiAibWF0aGVtYXRpY2FsIiwKICAgICAgICAgIG1vZGU6ICJtb2RlIiwKICAgICAgICAgIG51bW9jdGF2ZXM6ICJudW1PY3RhdmVzIiwKICAgICAgICAgIG9mZnNldDogIm9mZnNldCIsCiAgICAgICAgICBvcGFjaXR5OiAib3BhY2l0eSIsCiAgICAgICAgICBvcGVyYXRvcjogIm9wZXJhdG9yIiwKICAgICAgICAgIG9yZGVyOiAib3JkZXIiLAogICAgICAgICAgb3JpZW50OiAib3JpZW50IiwKICAgICAgICAgIG9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iLAogICAgICAgICAgb3JpZ2luOiAib3JpZ2luIiwKICAgICAgICAgIG92ZXJmbG93OiAib3ZlcmZsb3ciLAogICAgICAgICAgb3ZlcmxpbmVwb3NpdGlvbjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgIm92ZXJsaW5lLXBvc2l0aW9uIjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgb3ZlcmxpbmV0aGlja25lc3M6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIjogIm92ZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHBhaW50b3JkZXI6ICJwYWludE9yZGVyIiwKICAgICAgICAgICJwYWludC1vcmRlciI6ICJwYWludE9yZGVyIiwKICAgICAgICAgIHBhbm9zZTE6ICJwYW5vc2UxIiwKICAgICAgICAgICJwYW5vc2UtMSI6ICJwYW5vc2UxIiwKICAgICAgICAgIHBhdGhsZW5ndGg6ICJwYXRoTGVuZ3RoIiwKICAgICAgICAgIHBhdHRlcm5jb250ZW50dW5pdHM6ICJwYXR0ZXJuQ29udGVudFVuaXRzIiwKICAgICAgICAgIHBhdHRlcm50cmFuc2Zvcm06ICJwYXR0ZXJuVHJhbnNmb3JtIiwKICAgICAgICAgIHBhdHRlcm51bml0czogInBhdHRlcm5Vbml0cyIsCiAgICAgICAgICBwb2ludGVyZXZlbnRzOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICAicG9pbnRlci1ldmVudHMiOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICBwb2ludHM6ICJwb2ludHMiLAogICAgICAgICAgcG9pbnRzYXR4OiAicG9pbnRzQXRYIiwKICAgICAgICAgIHBvaW50c2F0eTogInBvaW50c0F0WSIsCiAgICAgICAgICBwb2ludHNhdHo6ICJwb2ludHNBdFoiLAogICAgICAgICAgcHJlZml4OiAicHJlZml4IiwKICAgICAgICAgIHByZXNlcnZlYWxwaGE6ICJwcmVzZXJ2ZUFscGhhIiwKICAgICAgICAgIHByZXNlcnZlYXNwZWN0cmF0aW86ICJwcmVzZXJ2ZUFzcGVjdFJhdGlvIiwKICAgICAgICAgIHByaW1pdGl2ZXVuaXRzOiAicHJpbWl0aXZlVW5pdHMiLAogICAgICAgICAgcHJvcGVydHk6ICJwcm9wZXJ0eSIsCiAgICAgICAgICByOiAiciIsCiAgICAgICAgICByYWRpdXM6ICJyYWRpdXMiLAogICAgICAgICAgcmVmeDogInJlZlgiLAogICAgICAgICAgcmVmeTogInJlZlkiLAogICAgICAgICAgcmVuZGVyaW5naW50ZW50OiAicmVuZGVyaW5nSW50ZW50IiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IjogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICByZXBlYXRjb3VudDogInJlcGVhdENvdW50IiwKICAgICAgICAgIHJlcGVhdGR1cjogInJlcGVhdER1ciIsCiAgICAgICAgICByZXF1aXJlZGV4dGVuc2lvbnM6ICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICAgICAgICAgcmVxdWlyZWRmZWF0dXJlczogInJlcXVpcmVkRmVhdHVyZXMiLAogICAgICAgICAgcmVzb3VyY2U6ICJyZXNvdXJjZSIsCiAgICAgICAgICByZXN0YXJ0OiAicmVzdGFydCIsCiAgICAgICAgICByZXN1bHQ6ICJyZXN1bHQiLAogICAgICAgICAgcmVzdWx0czogInJlc3VsdHMiLAogICAgICAgICAgcm90YXRlOiAicm90YXRlIiwKICAgICAgICAgIHJ4OiAicngiLAogICAgICAgICAgcnk6ICJyeSIsCiAgICAgICAgICBzY2FsZTogInNjYWxlIiwKICAgICAgICAgIHNlY3VyaXR5OiAic2VjdXJpdHkiLAogICAgICAgICAgc2VlZDogInNlZWQiLAogICAgICAgICAgc2hhcGVyZW5kZXJpbmc6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICAic2hhcGUtcmVuZGVyaW5nIjogInNoYXBlUmVuZGVyaW5nIiwKICAgICAgICAgIHNsb3BlOiAic2xvcGUiLAogICAgICAgICAgc3BhY2luZzogInNwYWNpbmciLAogICAgICAgICAgc3BlY3VsYXJjb25zdGFudDogInNwZWN1bGFyQ29uc3RhbnQiLAogICAgICAgICAgc3BlY3VsYXJleHBvbmVudDogInNwZWN1bGFyRXhwb25lbnQiLAogICAgICAgICAgc3BlZWQ6ICJzcGVlZCIsCiAgICAgICAgICBzcHJlYWRtZXRob2Q6ICJzcHJlYWRNZXRob2QiLAogICAgICAgICAgc3RhcnRvZmZzZXQ6ICJzdGFydE9mZnNldCIsCiAgICAgICAgICBzdGRkZXZpYXRpb246ICJzdGREZXZpYXRpb24iLAogICAgICAgICAgc3RlbWg6ICJzdGVtaCIsCiAgICAgICAgICBzdGVtdjogInN0ZW12IiwKICAgICAgICAgIHN0aXRjaHRpbGVzOiAic3RpdGNoVGlsZXMiLAogICAgICAgICAgc3RvcGNvbG9yOiAic3RvcENvbG9yIiwKICAgICAgICAgICJzdG9wLWNvbG9yIjogInN0b3BDb2xvciIsCiAgICAgICAgICBzdG9wb3BhY2l0eTogInN0b3BPcGFjaXR5IiwKICAgICAgICAgICJzdG9wLW9wYWNpdHkiOiAic3RvcE9wYWNpdHkiLAogICAgICAgICAgc3RyaWtldGhyb3VnaHBvc2l0aW9uOiAic3RyaWtldGhyb3VnaFBvc2l0aW9uIiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXBvc2l0aW9uIjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICBzdHJpa2V0aHJvdWdodGhpY2tuZXNzOiAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiOiAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgICAgICAgICBzdHJpbmc6ICJzdHJpbmciLAogICAgICAgICAgc3Ryb2tlOiAic3Ryb2tlIiwKICAgICAgICAgIHN0cm9rZWRhc2hhcnJheTogInN0cm9rZURhc2hhcnJheSIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hhcnJheSI6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgc3Ryb2tlZGFzaG9mZnNldDogInN0cm9rZURhc2hvZmZzZXQiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IjogInN0cm9rZURhc2hvZmZzZXQiLAogICAgICAgICAgc3Ryb2tlbGluZWNhcDogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgInN0cm9rZS1saW5lY2FwIjogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgc3Ryb2tlbGluZWpvaW46ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIjogInN0cm9rZUxpbmVqb2luIiwKICAgICAgICAgIHN0cm9rZW1pdGVybGltaXQ6ICJzdHJva2VNaXRlcmxpbWl0IiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCI6ICJzdHJva2VNaXRlcmxpbWl0IiwKICAgICAgICAgIHN0cm9rZXdpZHRoOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgInN0cm9rZS13aWR0aCI6ICJzdHJva2VXaWR0aCIsCiAgICAgICAgICBzdHJva2VvcGFjaXR5OiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiOiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICBzdXBwcmVzc2NvbnRlbnRlZGl0YWJsZXdhcm5pbmc6ICJzdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmciLAogICAgICAgICAgc3VwcHJlc3NoeWRyYXRpb253YXJuaW5nOiAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIiwKICAgICAgICAgIHN1cmZhY2VzY2FsZTogInN1cmZhY2VTY2FsZSIsCiAgICAgICAgICBzeXN0ZW1sYW5ndWFnZTogInN5c3RlbUxhbmd1YWdlIiwKICAgICAgICAgIHRhYmxldmFsdWVzOiAidGFibGVWYWx1ZXMiLAogICAgICAgICAgdGFyZ2V0eDogInRhcmdldFgiLAogICAgICAgICAgdGFyZ2V0eTogInRhcmdldFkiLAogICAgICAgICAgdGV4dGFuY2hvcjogInRleHRBbmNob3IiLAogICAgICAgICAgInRleHQtYW5jaG9yIjogInRleHRBbmNob3IiLAogICAgICAgICAgdGV4dGRlY29yYXRpb246ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1kZWNvcmF0aW9uIjogInRleHREZWNvcmF0aW9uIiwKICAgICAgICAgIHRleHRsZW5ndGg6ICJ0ZXh0TGVuZ3RoIiwKICAgICAgICAgIHRleHRyZW5kZXJpbmc6ICJ0ZXh0UmVuZGVyaW5nIiwKICAgICAgICAgICJ0ZXh0LXJlbmRlcmluZyI6ICJ0ZXh0UmVuZGVyaW5nIiwKICAgICAgICAgIHRvOiAidG8iLAogICAgICAgICAgdHJhbnNmb3JtOiAidHJhbnNmb3JtIiwKICAgICAgICAgIHR5cGVvZjogInR5cGVvZiIsCiAgICAgICAgICB1MTogInUxIiwKICAgICAgICAgIHUyOiAidTIiLAogICAgICAgICAgdW5kZXJsaW5lcG9zaXRpb246ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXBvc2l0aW9uIjogInVuZGVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIHVuZGVybGluZXRoaWNrbmVzczogInVuZGVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyI6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgdW5pY29kZTogInVuaWNvZGUiLAogICAgICAgICAgdW5pY29kZWJpZGk6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIjogInVuaWNvZGVCaWRpIiwKICAgICAgICAgIHVuaWNvZGVyYW5nZTogInVuaWNvZGVSYW5nZSIsCiAgICAgICAgICAidW5pY29kZS1yYW5nZSI6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgdW5pdHNwZXJlbTogInVuaXRzUGVyRW0iLAogICAgICAgICAgInVuaXRzLXBlci1lbSI6ICJ1bml0c1BlckVtIiwKICAgICAgICAgIHVuc2VsZWN0YWJsZTogInVuc2VsZWN0YWJsZSIsCiAgICAgICAgICB2YWxwaGFiZXRpYzogInZBbHBoYWJldGljIiwKICAgICAgICAgICJ2LWFscGhhYmV0aWMiOiAidkFscGhhYmV0aWMiLAogICAgICAgICAgdmFsdWVzOiAidmFsdWVzIiwKICAgICAgICAgIHZlY3RvcmVmZmVjdDogInZlY3RvckVmZmVjdCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCI6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgdmVyc2lvbjogInZlcnNpb24iLAogICAgICAgICAgdmVydGFkdnk6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICAidmVydC1hZHYteSI6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueDogInZlcnRPcmlnaW5YIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi14IjogInZlcnRPcmlnaW5YIiwKICAgICAgICAgIHZlcnRvcmlnaW55OiAidmVydE9yaWdpblkiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXkiOiAidmVydE9yaWdpblkiLAogICAgICAgICAgdmhhbmdpbmc6ICJ2SGFuZ2luZyIsCiAgICAgICAgICAidi1oYW5naW5nIjogInZIYW5naW5nIiwKICAgICAgICAgIHZpZGVvZ3JhcGhpYzogInZJZGVvZ3JhcGhpYyIsCiAgICAgICAgICAidi1pZGVvZ3JhcGhpYyI6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgdmlld2JveDogInZpZXdCb3giLAogICAgICAgICAgdmlld3RhcmdldDogInZpZXdUYXJnZXQiLAogICAgICAgICAgdmlzaWJpbGl0eTogInZpc2liaWxpdHkiLAogICAgICAgICAgdm1hdGhlbWF0aWNhbDogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgInYtbWF0aGVtYXRpY2FsIjogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgdm9jYWI6ICJ2b2NhYiIsCiAgICAgICAgICB3aWR0aHM6ICJ3aWR0aHMiLAogICAgICAgICAgd29yZHNwYWNpbmc6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIjogIndvcmRTcGFjaW5nIiwKICAgICAgICAgIHdyaXRpbmdtb2RlOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgIndyaXRpbmctbW9kZSI6ICJ3cml0aW5nTW9kZSIsCiAgICAgICAgICB4MTogIngxIiwKICAgICAgICAgIHgyOiAieDIiLAogICAgICAgICAgeDogIngiLAogICAgICAgICAgeGNoYW5uZWxzZWxlY3RvcjogInhDaGFubmVsU2VsZWN0b3IiLAogICAgICAgICAgeGhlaWdodDogInhIZWlnaHQiLAogICAgICAgICAgIngtaGVpZ2h0IjogInhIZWlnaHQiLAogICAgICAgICAgeGxpbmthY3R1YXRlOiAieGxpbmtBY3R1YXRlIiwKICAgICAgICAgICJ4bGluazphY3R1YXRlIjogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICB4bGlua2FyY3JvbGU6ICJ4bGlua0FyY3JvbGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgIHhsaW5raHJlZjogInhsaW5rSHJlZiIsCiAgICAgICAgICAieGxpbms6aHJlZiI6ICJ4bGlua0hyZWYiLAogICAgICAgICAgeGxpbmtyb2xlOiAieGxpbmtSb2xlIiwKICAgICAgICAgICJ4bGluazpyb2xlIjogInhsaW5rUm9sZSIsCiAgICAgICAgICB4bGlua3Nob3c6ICJ4bGlua1Nob3ciLAogICAgICAgICAgInhsaW5rOnNob3ciOiAieGxpbmtTaG93IiwKICAgICAgICAgIHhsaW5rdGl0bGU6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgICJ4bGluazp0aXRsZSI6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgIHhsaW5rdHlwZTogInhsaW5rVHlwZSIsCiAgICAgICAgICAieGxpbms6dHlwZSI6ICJ4bGlua1R5cGUiLAogICAgICAgICAgeG1sYmFzZTogInhtbEJhc2UiLAogICAgICAgICAgInhtbDpiYXNlIjogInhtbEJhc2UiLAogICAgICAgICAgeG1sbGFuZzogInhtbExhbmciLAogICAgICAgICAgInhtbDpsYW5nIjogInhtbExhbmciLAogICAgICAgICAgeG1sbnM6ICJ4bWxucyIsCiAgICAgICAgICAieG1sOnNwYWNlIjogInhtbFNwYWNlIiwKICAgICAgICAgIHhtbG5zeGxpbms6ICJ4bWxuc1hsaW5rIiwKICAgICAgICAgICJ4bWxuczp4bGluayI6ICJ4bWxuc1hsaW5rIiwKICAgICAgICAgIHhtbHNwYWNlOiAieG1sU3BhY2UiLAogICAgICAgICAgeTE6ICJ5MSIsCiAgICAgICAgICB5MjogInkyIiwKICAgICAgICAgIHk6ICJ5IiwKICAgICAgICAgIHljaGFubmVsc2VsZWN0b3I6ICJ5Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHo6ICJ6IiwKICAgICAgICAgIHpvb21hbmRwYW46ICJ6b29tQW5kUGFuIgogICAgICAgIH07CiAgICAgICAgdmFyIGFyaWFQcm9wZXJ0aWVzID0gewogICAgICAgICAgImFyaWEtY3VycmVudCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtZGVzY3JpcHRpb24iOiAwLAogICAgICAgICAgImFyaWEtZGV0YWlscyI6IDAsCiAgICAgICAgICAiYXJpYS1kaXNhYmxlZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaGlkZGVuIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1pbnZhbGlkIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1rZXlzaG9ydGN1dHMiOiAwLAogICAgICAgICAgImFyaWEtbGFiZWwiOiAwLAogICAgICAgICAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgIC8vIFdpZGdldCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1hdXRvY29tcGxldGUiOiAwLAogICAgICAgICAgImFyaWEtY2hlY2tlZCI6IDAsCiAgICAgICAgICAiYXJpYS1leHBhbmRlZCI6IDAsCiAgICAgICAgICAiYXJpYS1oYXNwb3B1cCI6IDAsCiAgICAgICAgICAiYXJpYS1sZXZlbCI6IDAsCiAgICAgICAgICAiYXJpYS1tb2RhbCI6IDAsCiAgICAgICAgICAiYXJpYS1tdWx0aWxpbmUiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlzZWxlY3RhYmxlIjogMCwKICAgICAgICAgICJhcmlhLW9yaWVudGF0aW9uIjogMCwKICAgICAgICAgICJhcmlhLXBsYWNlaG9sZGVyIjogMCwKICAgICAgICAgICJhcmlhLXByZXNzZWQiOiAwLAogICAgICAgICAgImFyaWEtcmVhZG9ubHkiOiAwLAogICAgICAgICAgImFyaWEtcmVxdWlyZWQiOiAwLAogICAgICAgICAgImFyaWEtc2VsZWN0ZWQiOiAwLAogICAgICAgICAgImFyaWEtc29ydCI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW1heCI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW1pbiI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW5vdyI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZXRleHQiOiAwLAogICAgICAgICAgLy8gTGl2ZSBSZWdpb24gQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXRvbWljIjogMCwKICAgICAgICAgICJhcmlhLWJ1c3kiOiAwLAogICAgICAgICAgImFyaWEtbGl2ZSI6IDAsCiAgICAgICAgICAiYXJpYS1yZWxldmFudCI6IDAsCiAgICAgICAgICAvLyBEcmFnLWFuZC1Ecm9wIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWRyb3BlZmZlY3QiOiAwLAogICAgICAgICAgImFyaWEtZ3JhYmJlZCI6IDAsCiAgICAgICAgICAvLyBSZWxhdGlvbnNoaXAgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYWN0aXZlZGVzY2VuZGFudCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xjb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xzcGFuIjogMCwKICAgICAgICAgICJhcmlhLWNvbnRyb2xzIjogMCwKICAgICAgICAgICJhcmlhLWRlc2NyaWJlZGJ5IjogMCwKICAgICAgICAgICJhcmlhLWVycm9ybWVzc2FnZSI6IDAsCiAgICAgICAgICAiYXJpYS1mbG93dG8iOiAwLAogICAgICAgICAgImFyaWEtbGFiZWxsZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1vd25zIjogMCwKICAgICAgICAgICJhcmlhLXBvc2luc2V0IjogMCwKICAgICAgICAgICJhcmlhLXJvd2NvdW50IjogMCwKICAgICAgICAgICJhcmlhLXJvd2luZGV4IjogMCwKICAgICAgICAgICJhcmlhLXJvd3NwYW4iOiAwLAogICAgICAgICAgImFyaWEtc2V0c2l6ZSI6IDAKICAgICAgICB9OwogICAgICAgIHZhciB3YXJuZWRQcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJBUklBID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgdmFyIHJBUklBQ2FtZWwgPSBuZXcgUmVnRXhwKCJeKGFyaWEpW0EtWl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0eSh0YWdOYW1lLCBuYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMsIG5hbWUpICYmIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUFDYW1lbC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGFyaWFOYW1lID0gImFyaWEtIiArIG5hbWUuc2xpY2UoNCkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICB2YXIgY29ycmVjdE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShhcmlhTmFtZSkgPyBhcmlhTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3ROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIEFSSUEgYXR0cmlidXRlcyBmb2xsb3cgdGhlIHBhdHRlcm4gYXJpYS0qIGFuZCBtdXN0IGJlIGxvd2VyY2FzZS4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuYW1lICE9PSBjb3JyZWN0TmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgY29ycmVjdE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGFyaWFQcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSA/IGxvd2VyQ2FzZWROYW1lIDogbnVsbDsKICAgICAgICAgICAgICBpZiAoc3RhbmRhcmROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gc3RhbmRhcmROYW1lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVW5rbm93biBBUklBIGF0dHJpYnV0ZSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW52YWxpZFByb3BzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSh0eXBlLCBrZXkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaW52YWxpZFByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gaW52YWxpZFByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmIChpbnZhbGlkUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhcmlhIHByb3BzICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5JbnZhbGlkQVJJQVByb3BzKHR5cGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZU51bGwgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZSAhPT0gImlucHV0IiAmJiB0eXBlICE9PSAidGV4dGFyZWEiICYmIHR5cGUgIT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcyAhPSBudWxsICYmIHByb3BzLnZhbHVlID09PSBudWxsICYmICFkaWRXYXJuVmFsdWVOdWxsKSB7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlTnVsbCA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiICYmIHByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiYHZhbHVlYCBwcm9wIG9uIGAlc2Agc2hvdWxkIG5vdCBiZSBudWxsLiBDb25zaWRlciB1c2luZyBhbiBlbXB0eSBhcnJheSB3aGVuIGBtdWx0aXBsZWAgaXMgc2V0IHRvIGB0cnVlYCB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgc3RyaW5nIHRvIGNsZWFyIHRoZSBjb21wb25lbnQgb3IgYHVuZGVmaW5lZGAgZm9yIHVuY29udHJvbGxlZCBjb21wb25lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyQxID0ge307CiAgICAgICAgICB2YXIgRVZFTlRfTkFNRV9SRUdFWCA9IC9eb24uLzsKICAgICAgICAgIHZhciBJTlZBTElEX0VWRU5UX05BTUVfUkVHRVggPSAvXm9uW15BLVpdLzsKICAgICAgICAgIHZhciByQVJJQSQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgICB2YXIgckFSSUFDYW1lbCQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24odGFnTmFtZSwgbmFtZSwgdmFsdWUsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwod2FybmVkUHJvcGVydGllcyQxLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gIm9uZm9jdXNpbiIgfHwgbG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3Vzb3V0IikgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCB1c2VzIG9uRm9jdXMgYW5kIG9uQmx1ciBpbnN0ZWFkIG9mIG9uRm9jdXNJbiBhbmQgb25Gb2N1c091dC4gQWxsIFJlYWN0IGV2ZW50cyBhcmUgbm9ybWFsaXplZCB0byBidWJibGUsIHNvIG9uRm9jdXNJbiBhbmQgb25Gb2N1c091dCBhcmUgbm90IG5lZWRlZC9zdXBwb3J0ZWQgYnkgUmVhY3QuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlbnRSZWdpc3RyeSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyID0gZXZlbnRSZWdpc3RyeS5yZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLCBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMiA9IGV2ZW50UmVnaXN0cnkucG9zc2libGVSZWdpc3RyYXRpb25OYW1lczsKICAgICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llczIuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSA/IHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyW2xvd2VyQ2FzZWROYW1lXSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKEVWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBJdCB3aWxsIGJlIGlnbm9yZWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKEVWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIGlmIChJTlZBTElEX0VWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBSZWFjdCBldmVudHMgdXNlIHRoZSBjYW1lbENhc2UgbmFtaW5nIGNvbnZlbnRpb24sIGZvciBleGFtcGxlIGBvbkNsaWNrYC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUEkMS50ZXN0KG5hbWUpIHx8IHJBUklBQ2FtZWwkMS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiaW5uZXJodG1sIikgewogICAgICAgICAgICAgIGVycm9yKCJEaXJlY3RseSBzZXR0aW5nIHByb3BlcnR5IGBpbm5lckhUTUxgIGlzIG5vdCBwZXJtaXR0ZWQuIEZvciBtb3JlIGluZm9ybWF0aW9uLCBsb29rdXAgZG9jdW1lbnRhdGlvbiBvbiBgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiYXJpYSIpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGBhcmlhYCBhdHRyaWJ1dGUgaXMgcmVzZXJ2ZWQgZm9yIGZ1dHVyZSB1c2UgaW4gUmVhY3QuIFBhc3MgaW5kaXZpZHVhbCBgYXJpYS1gIGF0dHJpYnV0ZXMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlzIiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYSBgJXNgIGZvciBhIHN0cmluZyBhdHRyaWJ1dGUgYGlzYC4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgdHlwZW9mIHZhbHVlKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiICYmIGlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBOYU4gZm9yIHRoZSBgJXNgIGF0dHJpYnV0ZS4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgbmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gZ2V0UHJvcGVydHlJbmZvKG5hbWUpOwogICAgICAgICAgICB2YXIgaXNSZXNlcnZlZCA9IHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICAgIGlmIChwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IHBvc3NpYmxlU3RhbmRhcmROYW1lc1tsb3dlckNhc2VkTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgRE9NIHByb3BlcnR5IGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKCFpc1Jlc2VydmVkICYmIG5hbWUgIT09IGxvd2VyQ2FzZWROYW1lKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGRvZXMgbm90IHJlY29nbml6ZSB0aGUgYCVzYCBwcm9wIG9uIGEgRE9NIGVsZW1lbnQuIElmIHlvdSBpbnRlbnRpb25hbGx5IHdhbnQgaXQgdG8gYXBwZWFyIGluIHRoZSBET00gYXMgYSBjdXN0b20gYXR0cmlidXRlLCBzcGVsbCBpdCBhcyBsb3dlcmNhc2UgYCVzYCBpbnN0ZWFkLiBJZiB5b3UgYWNjaWRlbnRhbGx5IHBhc3NlZCBpdCBmcm9tIGEgcGFyZW50IGNvbXBvbmVudCwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBlbGVtZW50LiIsIG5hbWUsIGxvd2VyQ2FzZWROYW1lKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiAmJiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCdSZWNlaXZlZCBgJXNgIGZvciBhIG5vbi1ib29sZWFuIGF0dHJpYnV0ZSBgJXNgLlxuXG5JZiB5b3Ugd2FudCB0byB3cml0ZSBpdCB0byB0aGUgRE9NLCBwYXNzIGEgc3RyaW5nIGluc3RlYWQ6ICVzPSIlcyIgb3IgJXM9e3ZhbHVlLnRvU3RyaW5nKCl9LicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCdSZWNlaXZlZCBgJXNgIGZvciBhIG5vbi1ib29sZWFuIGF0dHJpYnV0ZSBgJXNgLlxuXG5JZiB5b3Ugd2FudCB0byB3cml0ZSBpdCB0byB0aGUgRE9NLCBwYXNzIGEgc3RyaW5nIGluc3RlYWQ6ICVzPSIlcyIgb3IgJXM9e3ZhbHVlLnRvU3RyaW5nKCl9LlxuXG5JZiB5b3UgdXNlZCB0byBjb25kaXRpb25hbGx5IG9taXQgaXQgd2l0aCAlcz17Y29uZGl0aW9uICYmIHZhbHVlfSwgcGFzcyAlcz17Y29uZGl0aW9uID8gdmFsdWUgOiB1bmRlZmluZWR9IGluc3RlYWQuJywgdmFsdWUsIG5hbWUsIG5hbWUsIHZhbHVlLCBuYW1lLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNSZXNlcnZlZCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHZhbHVlID09PSAiZmFsc2UiIHx8IHZhbHVlID09PSAidHJ1ZSIpICYmIHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCB0aGUgc3RyaW5nIGAlc2AgZm9yIHRoZSBib29sZWFuIGF0dHJpYnV0ZSBgJXNgLiAlcyBEaWQgeW91IG1lYW4gJXM9eyVzfT8iLCB2YWx1ZSwgbmFtZSwgdmFsdWUgPT09ICJmYWxzZSIgPyAiVGhlIGJyb3dzZXIgd2lsbCBpbnRlcnByZXQgaXQgYXMgYSB0cnV0aHkgdmFsdWUuIiA6ICdBbHRob3VnaCB0aGlzIHdvcmtzLCBpdCB3aWxsIG5vdCB3b3JrIGFzIGV4cGVjdGVkIGlmIHlvdSBwYXNzIHRoZSBzdHJpbmcgImZhbHNlIi4nLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVW5rbm93blByb3BlcnRpZXMgPSBmdW5jdGlvbih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5rbm93blByb3BzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSQxKHR5cGUsIGtleSwgcHJvcHNba2V5XSwgZXZlbnRSZWdpc3RyeSk7CiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICB1bmtub3duUHJvcHMucHVzaChrZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdW5rbm93blByb3BTdHJpbmcgPSB1bmtub3duUHJvcHMubWFwKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gImAiICsgcHJvcCArICJgIjsKICAgICAgICAgICAgfSkuam9pbigiLCAiKTsKICAgICAgICAgICAgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZSBmb3IgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSBpdCBmcm9tIHRoZSBlbGVtZW50LCBvciBwYXNzIGEgc3RyaW5nIG9yIG51bWJlciB2YWx1ZSB0byBrZWVwIGl0IGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodW5rbm93blByb3BzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZXMgZm9yIHByb3BzICVzIG9uIDwlcz4gdGFnLiBFaXRoZXIgcmVtb3ZlIHRoZW0gZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCB0aGVtIGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5Vbmtub3duUHJvcGVydGllcyh0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSk7CiAgICAgICAgfQogICAgICAgIHZhciBJU19FVkVOVF9IQU5ETEVfTk9OX01BTkFHRURfTk9ERSA9IDE7CiAgICAgICAgdmFyIElTX05PTl9ERUxFR0FURUQgPSAxIDw8IDE7CiAgICAgICAgdmFyIElTX0NBUFRVUkVfUEhBU0UgPSAxIDw8IDI7CiAgICAgICAgdmFyIFNIT1VMRF9OT1RfUFJPQ0VTU19QT0xZRklMTF9FVkVOVF9QTFVHSU5TID0gSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgfCBJU19OT05fREVMRUdBVEVEIHwgSVNfQ0FQVFVSRV9QSEFTRTsKICAgICAgICB2YXIgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gYmUgbnVsbC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gZXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVwbGF5aW5nRXZlbnQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50UmVwbGF5aW5nRXZlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgY3VycmVudGx5IHJlcGxheWluZyBldmVudCB0byBub3QgYmUgbnVsbC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgcmV0dXJuIGV2ZW50ID09PSBjdXJyZW50UmVwbGF5aW5nRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbmF0aXZlRXZlbnQudGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LnNyY0VsZW1lbnQgfHwgd2luZG93OwogICAgICAgICAgaWYgKHRhcmdldC5jb3JyZXNwb25kaW5nVXNlRWxlbWVudCkgewogICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGFyZ2V0Lm5vZGVUeXBlID09PSBURVhUX05PREUgPyB0YXJnZXQucGFyZW50Tm9kZSA6IHRhcmdldDsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc3RvcmVJbXBsID0gbnVsbDsKICAgICAgICB2YXIgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZSA9IGdldEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0KTsKICAgICAgICAgIGlmICghaW50ZXJuYWxJbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHJlc3RvcmVJbXBsICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0UmVzdG9yZUltcGxlbWVudGF0aW9uKCkgbmVlZHMgdG8gYmUgY2FsbGVkIHRvIGhhbmRsZSBhIHRhcmdldCBmb3IgY29udHJvbGxlZCBldmVudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gaW50ZXJuYWxJbnN0YW5jZS5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAoc3RhdGVOb2RlKSB7CiAgICAgICAgICAgIHZhciBfcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICAgIHJlc3RvcmVJbXBsKGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlLCBpbnRlcm5hbEluc3RhbmNlLnR5cGUsIF9wcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihpbXBsKSB7CiAgICAgICAgICByZXN0b3JlSW1wbCA9IGltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KSB7CiAgICAgICAgICBpZiAocmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICBpZiAocmVzdG9yZVF1ZXVlKSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlLnB1c2godGFyZ2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN0b3JlUXVldWUgPSBbdGFyZ2V0XTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdG9yZVRhcmdldCA9IHRhcmdldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbmVlZHNTdGF0ZVJlc3RvcmUoKSB7CiAgICAgICAgICByZXR1cm4gcmVzdG9yZVRhcmdldCAhPT0gbnVsbCB8fCByZXN0b3JlUXVldWUgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCkgewogICAgICAgICAgaWYgKCFyZXN0b3JlVGFyZ2V0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXQgPSByZXN0b3JlVGFyZ2V0OwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldHMgPSByZXN0b3JlUXVldWU7CiAgICAgICAgICByZXN0b3JlVGFyZ2V0ID0gbnVsbDsKICAgICAgICAgIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgICByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpOwogICAgICAgICAgaWYgKHF1ZXVlZFRhcmdldHMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZWRUYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQocXVldWVkVGFyZ2V0c1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJhdGNoZWRVcGRhdGVzSW1wbCA9IGZ1bmN0aW9uKGZuLCBib29ra2VlcGluZykgewogICAgICAgICAgcmV0dXJuIGZuKGJvb2trZWVwaW5nKTsKICAgICAgICB9OwogICAgICAgIHZhciBmbHVzaFN5bmNJbXBsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmaW5pc2hFdmVudEhhbmRsZXIoKSB7CiAgICAgICAgICB2YXIgY29udHJvbGxlZENvbXBvbmVudHNIYXZlUGVuZGluZ1VwZGF0ZXMgPSBuZWVkc1N0YXRlUmVzdG9yZSgpOwogICAgICAgICAgaWYgKGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0ltcGwoKTsKICAgICAgICAgICAgcmVzdG9yZVN0YXRlSWZOZWVkZWQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMoZm4sIGEsIGIpIHsKICAgICAgICAgIGlmIChpc0luc2lkZUV2ZW50SGFuZGxlcikgewogICAgICAgICAgICByZXR1cm4gZm4oYSwgYik7CiAgICAgICAgICB9CiAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IHRydWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gYmF0Y2hlZFVwZGF0ZXNJbXBsKGZuLCBhLCBiKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgICAgIGZpbmlzaEV2ZW50SGFuZGxlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRCYXRjaGluZ0ltcGxlbWVudGF0aW9uKF9iYXRjaGVkVXBkYXRlc0ltcGwsIF9kaXNjcmV0ZVVwZGF0ZXNJbXBsLCBfZmx1c2hTeW5jSW1wbCkgewogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXNJbXBsID0gX2JhdGNoZWRVcGRhdGVzSW1wbDsKICAgICAgICAgIGZsdXNoU3luY0ltcGwgPSBfZmx1c2hTeW5jSW1wbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbnRlcmFjdGl2ZSh0YWcpIHsKICAgICAgICAgIHJldHVybiB0YWcgPT09ICJidXR0b24iIHx8IHRhZyA9PT0gImlucHV0IiB8fCB0YWcgPT09ICJzZWxlY3QiIHx8IHRhZyA9PT0gInRleHRhcmVhIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUHJldmVudE1vdXNlRXZlbnQobmFtZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICBjYXNlICJvbkNsaWNrIjoKICAgICAgICAgICAgY2FzZSAib25DbGlja0NhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbkRvdWJsZUNsaWNrIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGlja0NhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93biI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VEb3duQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZU1vdmVDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZVVwIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZVVwQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VFbnRlciI6CiAgICAgICAgICAgICAgcmV0dXJuICEhKHByb3BzLmRpc2FibGVkICYmIGlzSW50ZXJhY3RpdmUodHlwZSkpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXIoaW5zdCwgcmVnaXN0cmF0aW9uTmFtZSkgewogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGluc3Quc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wcyA9IGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUoc3RhdGVOb2RlKTsKICAgICAgICAgIGlmIChwcm9wcyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcjIgPSBwcm9wc1tyZWdpc3RyYXRpb25OYW1lXTsKICAgICAgICAgIGlmIChzaG91bGRQcmV2ZW50TW91c2VFdmVudChyZWdpc3RyYXRpb25OYW1lLCBpbnN0LnR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsaXN0ZW5lcjIgJiYgdHlwZW9mIGxpc3RlbmVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGAiICsgcmVnaXN0cmF0aW9uTmFtZSArICJgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCIgKyB0eXBlb2YgbGlzdGVuZXIyICsgImAgdHlwZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjI7CiAgICAgICAgfQogICAgICAgIHZhciBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIGlmIChjYW5Vc2VET00yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3B0aW9ucywgInBhc3NpdmUiLCB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kOwogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRpc3BhdGNoRXZlbnQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRXZlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZha2VOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicmVhY3QiKTsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCA9IGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja0RldihuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBkb2N1bWVudGAgZ2xvYmFsIHdhcyBkZWZpbmVkIHdoZW4gUmVhY3Qgd2FzIGluaXRpYWxpemVkLCBidXQgaXMgbm90IGRlZmluZWQgYW55bW9yZS4gVGhpcyBjYW4gaGFwcGVuIGluIGEgdGVzdCBlbnZpcm9ubWVudCBpZiBhIGNvbXBvbmVudCBzY2hlZHVsZXMgYW4gdXBkYXRlIGZyb20gYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrLCBidXQgdGhlIHRlc3QgaGFzIGFscmVhZHkgZmluaXNoZWQgcnVubmluZy4gVG8gc29sdmUgdGhpcywgeW91IGNhbiBlaXRoZXIgdW5tb3VudCB0aGUgY29tcG9uZW50IGF0IHRoZSBlbmQgb2YgeW91ciB0ZXN0IChhbmQgZW5zdXJlIHRoYXQgYW55IGFzeW5jaHJvbm91cyBvcGVyYXRpb25zIGdldCBjYW5jZWxlZCBpbiBgY29tcG9uZW50V2lsbFVubW91bnRgKSwgb3IgeW91IGNhbiBjaGFuZ2UgdGhlIHRlc3QgaXRzZWxmIHRvIGJlIGFzeW5jaHJvbm91cy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJFdmVudCIpOwogICAgICAgICAgICAgIHZhciBkaWRDYWxsID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIGRpZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgd2luZG93RXZlbnQgPSB3aW5kb3cuZXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50RGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iod2luZG93LCAiZXZlbnQiKTsKICAgICAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpIHsKICAgICAgICAgICAgICAgIGZha2VOb2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZ0VHlwZSwgY2FsbENhbGxiYWNrMiwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuZXZlbnQgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgiZXZlbnQiKSkgewogICAgICAgICAgICAgICAgICB3aW5kb3cuZXZlbnQgPSB3aW5kb3dFdmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZ1bmNBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKICAgICAgICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2syKCkgewogICAgICAgICAgICAgICAgZGlkQ2FsbCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpOwogICAgICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICAgICAgICBkaWRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IyOwogICAgICAgICAgICAgIHZhciBkaWRTZXRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBpc0Nyb3NzT3JpZ2luRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVXaW5kb3dFcnJvcihldmVudCkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gZXZlbnQuZXJyb3I7CiAgICAgICAgICAgICAgICBkaWRTZXRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IyID09PSBudWxsICYmIGV2ZW50LmNvbG5vID09PSAwICYmIGV2ZW50LmxpbmVubyA9PT0gMCkgewogICAgICAgICAgICAgICAgICBpc0Nyb3NzT3JpZ2luRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIHR5cGVvZiBlcnJvcjIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChpbm5lcikgewogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXZ0VHlwZSA9ICJyZWFjdC0iICsgKG5hbWUgPyBuYW1lIDogImludm9rZWd1YXJkZWRjYWxsYmFjayIpOwogICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBmYWtlTm9kZS5hZGRFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICBldnQuaW5pdEV2ZW50KGV2dFR5cGUsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgZmFrZU5vZGUuZGlzcGF0Y2hFdmVudChldnQpOwogICAgICAgICAgICAgIGlmICh3aW5kb3dFdmVudERlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3csICJldmVudCIsIHdpbmRvd0V2ZW50RGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkaWRDYWxsICYmIGRpZEVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFNldEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcihgQW4gZXJyb3Igd2FzIHRocm93biBpbnNpZGUgb25lIG9mIHlvdXIgY29tcG9uZW50cywgYnV0IFJlYWN0IGRvZXNuJ3Qga25vdyB3aGF0IGl0IHdhcy4gVGhpcyBpcyBsaWtlbHkgZHVlIHRvIGJyb3dzZXIgZmxha2luZXNzLiBSZWFjdCBkb2VzIGl0cyBiZXN0IHRvIHByZXNlcnZlIHRoZSAiUGF1c2Ugb24gZXhjZXB0aW9ucyIgYmVoYXZpb3Igb2YgdGhlIERldlRvb2xzLCB3aGljaCByZXF1aXJlcyBzb21lIERFVi1tb2RlIG9ubHkgdHJpY2tzLiBJdCdzIHBvc3NpYmxlIHRoYXQgdGhlc2UgZG9uJ3Qgd29yayBpbiB5b3VyIGJyb3dzZXIuIFRyeSB0cmlnZ2VyaW5nIHRoZSBlcnJvciBpbiBwcm9kdWN0aW9uIG1vZGUsIG9yIHN3aXRjaGluZyB0byBhIG1vZGVybiBicm93c2VyLiBJZiB5b3Ugc3VzcGVjdCB0aGF0IHRoaXMgaXMgYWN0dWFsbHkgYW4gaXNzdWUgd2l0aCBSZWFjdCwgcGxlYXNlIGZpbGUgYW4gaXNzdWUuYCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ3Jvc3NPcmlnaW5FcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIkEgY3Jvc3Mtb3JpZ2luIGVycm9yIHdhcyB0aHJvd24uIFJlYWN0IGRvZXNuJ3QgaGF2ZSBhY2Nlc3MgdG8gdGhlIGFjdHVhbCBlcnJvciBvYmplY3QgaW4gZGV2ZWxvcG1lbnQuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY3Jvc3NvcmlnaW4tZXJyb3IgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIiwgaGFuZGxlV2luZG93RXJyb3IpOwogICAgICAgICAgICAgIGlmICghZGlkQ2FsbCkgewogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIHJldHVybiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCQxID0gaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbDsKICAgICAgICB2YXIgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICB2YXIgcmVwb3J0ZXIgPSB7CiAgICAgICAgICBvbkVycm9yOiBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgICAgICBjYXVnaHRFcnJvciA9IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFjayhuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCQxLmFwcGx5KHJlcG9ydGVyLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tBbmRDYXRjaEZpcnN0RXJyb3IobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpIHsKICAgICAgICAgICAgdmFyIGVycm9yMiA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgaWYgKCFoYXNSZXRocm93RXJyb3IpIHsKICAgICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIHJldGhyb3dFcnJvciA9IGVycm9yMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRocm93Q2F1Z2h0RXJyb3IoKSB7CiAgICAgICAgICBpZiAoaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSByZXRocm93RXJyb3I7CiAgICAgICAgICAgIGhhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgICAgICByZXRocm93RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc0NhdWdodEVycm9yKCkgewogICAgICAgICAgcmV0dXJuIGhhc0Vycm9yOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhckNhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjYXVnaHRFcnJvcjsKICAgICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gZXJyb3IyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjbGVhckNhdWdodEVycm9yIHdhcyBjYWxsZWQgYnV0IG5vIGVycm9yIHdhcyBjYXB0dXJlZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0NShrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXMzKGtleSkgewogICAgICAgICAgcmV0dXJuIGtleS5fcmVhY3RJbnRlcm5hbHMgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0MyhrZXksIHZhbHVlKSB7CiAgICAgICAgICBrZXkuX3JlYWN0SW50ZXJuYWxzID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBOb0ZsYWdzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBQZXJmb3JtZWRXb3JrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQbGFjZW1lbnQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBVcGRhdGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBDaGlsZERlbGV0aW9uID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgQ29udGVudFJlc2V0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMgogICAgICAgICk7CiAgICAgICAgdmFyIENhbGxiYWNrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBEaWRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIEZvcmNlQ2xpZW50UmVuZGVyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAqLwogICAgICAgICAgMjU2CiAgICAgICAgKTsKICAgICAgICB2YXIgUmVmMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTEyCiAgICAgICAgKTsKICAgICAgICB2YXIgU25hcHNob3QgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgUGFzc2l2ZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyMDQ4CiAgICAgICAgKTsKICAgICAgICB2YXIgSHlkcmF0aW5nID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MDk2CiAgICAgICAgKTsKICAgICAgICB2YXIgVmlzaWJpbGl0eSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4MTkyCiAgICAgICAgKTsKICAgICAgICB2YXIgU3RvcmVDb25zaXN0ZW5jeSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICAxNjM4NAogICAgICAgICk7CiAgICAgICAgdmFyIExpZmVjeWNsZUVmZmVjdE1hc2sgPSBQYXNzaXZlIHwgVXBkYXRlIHwgQ2FsbGJhY2sgfCBSZWYyIHwgU25hcHNob3QgfCBTdG9yZUNvbnNpc3RlbmN5OwogICAgICAgIHZhciBIb3N0RWZmZWN0TWFzayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyNzY3CiAgICAgICAgKTsKICAgICAgICB2YXIgSW5jb21wbGV0ZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2OAogICAgICAgICk7CiAgICAgICAgdmFyIFNob3VsZENhcHR1cmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjU1MzYKICAgICAgICApOwogICAgICAgIHZhciBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlID0gKAogICAgICAgICAgLyogKi8KICAgICAgICAgIDEzMTA3MgogICAgICAgICk7CiAgICAgICAgdmFyIEZvcmtlZCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA0ODU3NgogICAgICAgICk7CiAgICAgICAgdmFyIFJlZlN0YXRpYyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA5NzE1MgogICAgICAgICk7CiAgICAgICAgdmFyIExheW91dFN0YXRpYyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDMwNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmVTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODM4ODYwOAogICAgICAgICk7CiAgICAgICAgdmFyIE1vdW50TGF5b3V0RGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMTY3NzcyMTYKICAgICAgICApOwogICAgICAgIHZhciBNb3VudFBhc3NpdmVEZXYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgQmVmb3JlTXV0YXRpb25NYXNrID0gKAogICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIFVwZGF0ZSBmbGFnIGZyb20gYmVmb3JlIG11dGF0aW9uIHBoYXNlIGJ5IHJlLWxhbmRpbmcgVmlzaWJpbGl0eQogICAgICAgICAgLy8gZmxhZyBsb2dpYyAoc2VlICMyMDA0MykKICAgICAgICAgIFVwZGF0ZSB8IFNuYXBzaG90IHwgMAogICAgICAgICk7CiAgICAgICAgdmFyIE11dGF0aW9uTWFzayA9IFBsYWNlbWVudCB8IFVwZGF0ZSB8IENoaWxkRGVsZXRpb24gfCBDb250ZW50UmVzZXQgfCBSZWYyIHwgSHlkcmF0aW5nIHwgVmlzaWJpbGl0eTsKICAgICAgICB2YXIgTGF5b3V0TWFzayA9IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmMiB8IFZpc2liaWxpdHk7CiAgICAgICAgdmFyIFBhc3NpdmVNYXNrID0gUGFzc2l2ZSB8IENoaWxkRGVsZXRpb247CiAgICAgICAgdmFyIFN0YXRpY01hc2sgPSBMYXlvdXRTdGF0aWMgfCBQYXNzaXZlU3RhdGljIHwgUmVmU3RhdGljOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIGZ1bmN0aW9uIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBmaWJlcjsKICAgICAgICAgIGlmICghZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICAgICAgaWYgKChub2RlLmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBuZWFyZXN0TW91bnRlZCA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChuZXh0Tm9kZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGlsZSAobm9kZS5yZXR1cm4pIHsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgcmV0dXJuIG5lYXJlc3RNb3VudGVkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZVN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBIb3N0Um9vdCA/IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGaWJlck1vdW50ZWQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTW91bnRlZChjb21wb25lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG93bmVyID0gUmVhY3RDdXJyZW50T3duZXIuY3VycmVudDsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIG93bmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXJGaWJlciA9IG93bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmICghaW5zdGFuY2UuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgYWNjZXNzaW5nIGlzTW91bnRlZCBpbnNpZGUgaXRzIHJlbmRlcigpIGZ1bmN0aW9uLiByZW5kZXIoKSBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZS4gSXQgc2hvdWxkIG5ldmVyIGFjY2VzcyBzb21ldGhpbmcgdGhhdCByZXF1aXJlcyBzdGFsZSBkYXRhIGZyb20gdGhlIHByZXZpb3VzIHJlbmRlciwgc3VjaCBhcyByZWZzLiBNb3ZlIHRoaXMgbG9naWMgdG8gY29tcG9uZW50RGlkTW91bnQgYW5kIGNvbXBvbmVudERpZFVwZGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXJGaWJlcikgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGdldDUoY29tcG9uZW50KTsKICAgICAgICAgIGlmICghZmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpID09PSBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXNzZXJ0SXNNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudEZpYmVyVXNpbmdTbG93UGF0aChmaWJlcikgewogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmICghYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGEgPSBmaWJlcjsKICAgICAgICAgIHZhciBiID0gYWx0ZXJuYXRlOwogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgdmFyIHBhcmVudEEgPSBhLnJldHVybjsKICAgICAgICAgICAgaWYgKHBhcmVudEEgPT09IG51bGwpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcGFyZW50QiA9IHBhcmVudEEuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAocGFyZW50QiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXh0UGFyZW50ID0gcGFyZW50QS5yZXR1cm47CiAgICAgICAgICAgICAgaWYgKG5leHRQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGEgPSBiID0gbmV4dFBhcmVudDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyZW50QS5jaGlsZCA9PT0gcGFyZW50Qi5jaGlsZCkgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudEEuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgYXNzZXJ0SXNNb3VudGVkKHBhcmVudEEpOwogICAgICAgICAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgYXNzZXJ0SXNNb3VudGVkKHBhcmVudEEpOwogICAgICAgICAgICAgICAgICByZXR1cm4gYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYS5yZXR1cm4gIT09IGIucmV0dXJuKSB7CiAgICAgICAgICAgICAgYSA9IHBhcmVudEE7CiAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGRpZEZpbmRDaGlsZCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBfY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQpIHsKICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgZGlkRmluZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYSA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgZGlkRmluZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYiA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRpZEZpbmRDaGlsZCkgewogICAgICAgICAgICAgICAgX2NoaWxkID0gcGFyZW50Qi5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYSkgewogICAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYSA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICAgICAgYiA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYikgewogICAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICAgICAgYSA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWRpZEZpbmRDaGlsZCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNoaWxkIHdhcyBub3QgZm91bmQgaW4gZWl0aGVyIHBhcmVudCBzZXQuIFRoaXMgaW5kaWNhdGVzIGEgYnVnIGluIFJlYWN0IHJlbGF0ZWQgdG8gdGhlIHJldHVybiBwb2ludGVyLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEuYWx0ZXJuYXRlICE9PSBiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZXR1cm4gZmliZXJzIHNob3VsZCBhbHdheXMgYmUgZWFjaCBvdGhlcnMnIGFsdGVybmF0ZXMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChhLnRhZyAhPT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS5zdGF0ZU5vZGUuY3VycmVudCA9PT0gYSkgewogICAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYWx0ZXJuYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudEhvc3RGaWJlcihwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJJbXBsKGN1cnJlbnRQYXJlbnQpIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXJJbXBsKG5vZGUpIHsKICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjaGlsZCk7CiAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzKHBhcmVudCkgewogICAgICAgICAgdmFyIGN1cnJlbnRQYXJlbnQgPSBmaW5kQ3VycmVudEZpYmVyVXNpbmdTbG93UGF0aChwYXJlbnQpOwogICAgICAgICAgcmV0dXJuIGN1cnJlbnRQYXJlbnQgIT09IG51bGwgPyBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHNJbXBsKGN1cnJlbnRQYXJlbnQpIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY2hpbGQudGFnICE9PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjaGlsZCk7CiAgICAgICAgICAgICAgaWYgKG1hdGNoICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVDYWxsYmFjayA9IFNjaGVkdWxlci51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrOwogICAgICAgIHZhciBjYW5jZWxDYWxsYmFjayA9IFNjaGVkdWxlci51bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICB2YXIgc2hvdWxkWWllbGQgPSBTY2hlZHVsZXIudW5zdGFibGVfc2hvdWxkWWllbGQ7CiAgICAgICAgdmFyIHJlcXVlc3RQYWludCA9IFNjaGVkdWxlci51bnN0YWJsZV9yZXF1ZXN0UGFpbnQ7CiAgICAgICAgdmFyIG5vdyA9IFNjaGVkdWxlci51bnN0YWJsZV9ub3c7CiAgICAgICAgdmFyIGdldEN1cnJlbnRQcmlvcml0eUxldmVsID0gU2NoZWR1bGVyLnVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgIHZhciBJbW1lZGlhdGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICB2YXIgVXNlckJsb2NraW5nUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5OwogICAgICAgIHZhciBMb3dQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Mb3dQcmlvcml0eTsKICAgICAgICB2YXIgSWRsZVByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX0lkbGVQcmlvcml0eTsKICAgICAgICB2YXIgdW5zdGFibGVfeWllbGRWYWx1ZSA9IFNjaGVkdWxlci51bnN0YWJsZV95aWVsZFZhbHVlOwogICAgICAgIHZhciB1bnN0YWJsZV9zZXREaXNhYmxlWWllbGRWYWx1ZSA9IFNjaGVkdWxlci51bnN0YWJsZV9zZXREaXNhYmxlWWllbGRWYWx1ZTsKICAgICAgICB2YXIgcmVuZGVyZXJJRCA9IG51bGw7CiAgICAgICAgdmFyIGluamVjdGVkSG9vayA9IG51bGw7CiAgICAgICAgdmFyIGluamVjdGVkUHJvZmlsaW5nSG9va3MgPSBudWxsOwogICAgICAgIHZhciBoYXNMb2dnZWRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBpc0RldlRvb2xzUHJlc2VudCA9IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiOwogICAgICAgIGZ1bmN0aW9uIGluamVjdEludGVybmFscyhpbnRlcm5hbHMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaG9vayA9IF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXzsKICAgICAgICAgIGlmIChob29rLmlzRGlzYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWhvb2suc3VwcG9ydHNGaWJlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBpbnN0YWxsZWQgdmVyc2lvbiBvZiBSZWFjdCBEZXZUb29scyBpcyB0b28gb2xkIGFuZCB3aWxsIG5vdCB3b3JrIHdpdGggdGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBSZWFjdC4gUGxlYXNlIHVwZGF0ZSBSZWFjdCBEZXZUb29scy4gaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoZW5hYmxlU2NoZWR1bGluZ1Byb2ZpbGVyKSB7CiAgICAgICAgICAgICAgaW50ZXJuYWxzID0gYXNzaWduMih7fSwgaW50ZXJuYWxzLCB7CiAgICAgICAgICAgICAgICBnZXRMYW5lTGFiZWxNYXAsCiAgICAgICAgICAgICAgICBpbmplY3RQcm9maWxpbmdIb29rcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlbmRlcmVySUQgPSBob29rLmluamVjdChpbnRlcm5hbHMpOwogICAgICAgICAgICBpbmplY3RlZEhvb2sgPSBob29rOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcy4iLCBlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaG9vay5jaGVja0RDRSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25TY2hlZHVsZVJvb3Qocm9vdDMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFJvb3Qocm9vdDMsIGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IChyb290My5jdXJyZW50LmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIpIHsKICAgICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IElkbGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBzY2hlZHVsZXJQcmlvcml0eSwgZGlkRXJyb3IpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIHZvaWQgMCwgZGlkRXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Qb3N0Q29tbWl0Um9vdChyb290MykgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uUG9zdENvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMpOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFVubW91bnQoZmliZXIpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudChyZW5kZXJlcklELCBmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKG5ld0lzU3RyaWN0TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHVuc3RhYmxlX3lpZWxkVmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB1bnN0YWJsZV9zZXREaXNhYmxlWWllbGRWYWx1ZShuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIHNldFN1cHByZXNzV2FybmluZyhuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5zZXRTdHJpY3RNb2RlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5zZXRTdHJpY3RNb2RlKHJlbmRlcmVySUQsIG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluamVjdFByb2ZpbGluZ0hvb2tzKHByb2ZpbGluZ0hvb2tzKSB7CiAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gcHJvZmlsaW5nSG9va3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVMYWJlbE1hcCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG1hcDMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDE7CiAgICAgICAgICAgIGZvciAodmFyIGluZGV4MiA9IDA7IGluZGV4MiA8IFRvdGFsTGFuZXM7IGluZGV4MisrKSB7CiAgICAgICAgICAgICAgdmFyIGxhYmVsID0gZ2V0TGFiZWxGb3JMYW5lKGxhbmUpOwogICAgICAgICAgICAgIG1hcDMuc2V0KGxhbmUsIGxhYmVsKTsKICAgICAgICAgICAgICBsYW5lICo9IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1hcDM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRFcnJvcmVkKGZpYmVyLCB0aHJvd25WYWx1ZSwgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRFcnJvcmVkKGZpYmVyLCB0aHJvd25WYWx1ZSwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRTdXNwZW5kZWQoZmliZXIsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50U3VzcGVuZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlcllpZWxkZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJZaWVsZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZChsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgQ29uY3VycmVudE1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQcm9maWxlTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIFN0cmljdExlZ2FjeU1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgU3RyaWN0RWZmZWN0c01vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgY2x6MzIgPSBNYXRoLmNsejMyID8gTWF0aC5jbHozMiA6IGNsejMyRmFsbGJhY2s7CiAgICAgICAgdmFyIGxvZzIgPSBNYXRoLmxvZzsKICAgICAgICB2YXIgTE4yID0gTWF0aC5MTjI7CiAgICAgICAgZnVuY3Rpb24gY2x6MzJGYWxsYmFjayh4MikgewogICAgICAgICAgdmFyIGFzVWludCA9IHgyID4+PiAwOwogICAgICAgICAgaWYgKGFzVWludCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gMzI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMzEgLSAobG9nMihhc1VpbnQpIC8gTE4yIHwgMCkgfCAwOwogICAgICAgIH0KICAgICAgICB2YXIgVG90YWxMYW5lcyA9IDMxOwogICAgICAgIHZhciBOb0xhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIE5vTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIFN5bmNMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIElucHV0Q29udGludW91c0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIERlZmF1bHRIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIERlZmF1bHRMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lcyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDI0MAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTI4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjU2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTEyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU1ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTAyNAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwNDgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTcgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MDk2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU4ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODE5MgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lOSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Mzg0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTExID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA2NTUzNgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEzMTA3MgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2MjE0NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUyNDI4OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyMDk3MTUyCiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lcyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMzAwMjM0MjQKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUxID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MTk0MzA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODM4ODYwOAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzM1NTQ0MzIKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmU1ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA2NzEwODg2NAogICAgICAgICk7CiAgICAgICAgdmFyIFNvbWVSZXRyeUxhbmUgPSBSZXRyeUxhbmUxOwogICAgICAgIHZhciBTZWxlY3RpdmVIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgKi8KICAgICAgICAgIDEzNDIxNzcyOAogICAgICAgICk7CiAgICAgICAgdmFyIE5vbklkbGVMYW5lcyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjY4NDM1NDU1CiAgICAgICAgKTsKICAgICAgICB2YXIgSWRsZUh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjg0MzU0NTYKICAgICAgICApOwogICAgICAgIHZhciBJZGxlTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUzNjg3MDkxMgogICAgICAgICk7CiAgICAgICAgdmFyIE9mZnNjcmVlbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA3Mzc0MTgyNAogICAgICAgICk7CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFiZWxGb3JMYW5lKGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGxhbmUgJiBTeW5jTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiU3luYyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJbnB1dENvbnRpbnVvdXNIeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgSW5wdXRDb250aW51b3VzTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSW5wdXRDb250aW51b3VzIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIERlZmF1bHRIeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJEZWZhdWx0SHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIERlZmF1bHRMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJEZWZhdWx0IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFuc2l0aW9uSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFRyYW5zaXRpb25MYW5lcykgewogICAgICAgICAgICAgIHJldHVybiAiVHJhbnNpdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBSZXRyeUxhbmVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJSZXRyeSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBTZWxlY3RpdmVIeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJTZWxlY3RpdmVIeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgSWRsZUh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklkbGVIeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgSWRsZUxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklkbGUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgT2Zmc2NyZWVuTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTm9UaW1lc3RhbXAgPSAtMTsKICAgICAgICB2YXIgbmV4dFRyYW5zaXRpb25MYW5lID0gVHJhbnNpdGlvbkxhbmUxOwogICAgICAgIHZhciBuZXh0UmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICBmdW5jdGlvbiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhsYW5lcykgewogICAgICAgICAgc3dpdGNoIChnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKSkgewogICAgICAgICAgICBjYXNlIFN5bmNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBTeW5jTGFuZTsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0xhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElucHV0Q29udGludW91c0xhbmU7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIERlZmF1bHRMYW5lOgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0TGFuZTsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgICByZXR1cm4gbGFuZXMgJiBUcmFuc2l0aW9uTGFuZXM7CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMToKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTM6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNDoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgIHJldHVybiBsYW5lcyAmIFJldHJ5TGFuZXM7CiAgICAgICAgICAgIGNhc2UgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gU2VsZWN0aXZlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJZGxlSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSWRsZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElkbGVMYW5lOwogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIE9mZnNjcmVlbkxhbmU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXJyb3IoIlNob3VsZCBoYXZlIGZvdW5kIG1hdGNoaW5nIGxhbmVzLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRMYW5lcyhyb290Mywgd2lwTGFuZXMpIHsKICAgICAgICAgIHZhciBwZW5kaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXM7CiAgICAgICAgICBpZiAocGVuZGluZ0xhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgc3VzcGVuZGVkTGFuZXMgPSByb290My5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHZhciBwaW5nZWRMYW5lcyA9IHJvb3QzLnBpbmdlZExhbmVzOwogICAgICAgICAgdmFyIG5vbklkbGVQZW5kaW5nTGFuZXMgPSBwZW5kaW5nTGFuZXMgJiBOb25JZGxlTGFuZXM7CiAgICAgICAgICBpZiAobm9uSWRsZVBlbmRpbmdMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgbm9uSWRsZVVuYmxvY2tlZExhbmVzID0gbm9uSWRsZVBlbmRpbmdMYW5lcyAmIH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgICAgaWYgKG5vbklkbGVVbmJsb2NrZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKG5vbklkbGVVbmJsb2NrZWRMYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5vbklkbGVQaW5nZWRMYW5lcyA9IG5vbklkbGVQZW5kaW5nTGFuZXMgJiBwaW5nZWRMYW5lczsKICAgICAgICAgICAgICBpZiAobm9uSWRsZVBpbmdlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBuZXh0TGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhub25JZGxlUGluZ2VkTGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHVuYmxvY2tlZExhbmVzID0gcGVuZGluZ0xhbmVzICYgfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICBpZiAodW5ibG9ja2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0TGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyh1bmJsb2NrZWRMYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHBpbmdlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBuZXh0TGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV4dExhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdpcExhbmVzICE9PSBOb0xhbmVzICYmIHdpcExhbmVzICE9PSBuZXh0TGFuZXMgJiYgLy8gSWYgd2UgYWxyZWFkeSBzdXNwZW5kZWQgd2l0aCBhIGRlbGF5LCB0aGVuIGludGVycnVwdGluZyBpcyBmaW5lLiBEb24ndAogICAgICAgICAgLy8gYm90aGVyIHdhaXRpbmcgdW50aWwgdGhlIHJvb3QgaXMgY29tcGxldGUuCiAgICAgICAgICAod2lwTGFuZXMgJiBzdXNwZW5kZWRMYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIG5leHRMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShuZXh0TGFuZXMpOwogICAgICAgICAgICB2YXIgd2lwTGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUod2lwTGFuZXMpOwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgLy8gVGVzdHMgd2hldGhlciB0aGUgbmV4dCBsYW5lIGlzIGVxdWFsIG9yIGxvd2VyIHByaW9yaXR5IHRoYW4gdGhlIHdpcAogICAgICAgICAgICAgIC8vIG9uZS4gVGhpcyB3b3JrcyBiZWNhdXNlIHRoZSBiaXRzIGRlY3JlYXNlIGluIHByaW9yaXR5IGFzIHlvdSBnbyBsZWZ0LgogICAgICAgICAgICAgIG5leHRMYW5lID49IHdpcExhbmUgfHwgLy8gRGVmYXVsdCBwcmlvcml0eSB1cGRhdGVzIHNob3VsZCBub3QgaW50ZXJydXB0IHRyYW5zaXRpb24gdXBkYXRlcy4gVGhlCiAgICAgICAgICAgICAgLy8gb25seSBkaWZmZXJlbmNlIGJldHdlZW4gZGVmYXVsdCB1cGRhdGVzIGFuZCB0cmFuc2l0aW9uIHVwZGF0ZXMgaXMgdGhhdAogICAgICAgICAgICAgIC8vIGRlZmF1bHQgdXBkYXRlcyBkbyBub3Qgc3VwcG9ydCByZWZyZXNoIHRyYW5zaXRpb25zLgogICAgICAgICAgICAgIG5leHRMYW5lID09PSBEZWZhdWx0TGFuZSAmJiAod2lwTGFuZSAmIFRyYW5zaXRpb25MYW5lcykgIT09IE5vTGFuZXMKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHdpcExhbmVzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKG5leHRMYW5lcyAmIElucHV0Q29udGludW91c0xhbmUpICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG5leHRMYW5lcyB8PSBwZW5kaW5nTGFuZXMgJiBEZWZhdWx0TGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbnRhbmdsZWRMYW5lcyA9IHJvb3QzLmVudGFuZ2xlZExhbmVzOwogICAgICAgICAgaWYgKGVudGFuZ2xlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgICAgdmFyIGxhbmVzID0gbmV4dExhbmVzICYgZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgICBuZXh0TGFuZXMgfD0gZW50YW5nbGVtZW50c1tpbmRleDJdOwogICAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV4dExhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRNb3N0UmVjZW50RXZlbnRUaW1lKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIG1vc3RSZWNlbnRFdmVudFRpbWUgPSBOb1RpbWVzdGFtcDsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gZXZlbnRUaW1lc1tpbmRleDJdOwogICAgICAgICAgICBpZiAoZXZlbnRUaW1lID4gbW9zdFJlY2VudEV2ZW50VGltZSkgewogICAgICAgICAgICAgIG1vc3RSZWNlbnRFdmVudFRpbWUgPSBldmVudFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbW9zdFJlY2VudEV2ZW50VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcHV0ZUV4cGlyYXRpb25UaW1lKGxhbmUsIGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBzd2l0Y2ggKGxhbmUpIHsKICAgICAgICAgICAgY2FzZSBTeW5jTGFuZToKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0xhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRUaW1lICsgMjUwOwogICAgICAgICAgICBjYXNlIERlZmF1bHRIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIERlZmF1bHRMYW5lOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTg6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTA6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTY6CiAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRUaW1lICsgNWUzOwogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGNhc2UgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBJZGxlSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBJZGxlTGFuZToKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5MYW5lOgogICAgICAgICAgICAgIHJldHVybiBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiU2hvdWxkIGhhdmUgZm91bmQgbWF0Y2hpbmcgbGFuZXMuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBOb1RpbWVzdGFtcDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N0YXJ2ZWRMYW5lc0FzRXhwaXJlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciBwZW5kaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXM7CiAgICAgICAgICB2YXIgc3VzcGVuZGVkTGFuZXMgPSByb290My5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHZhciBwaW5nZWRMYW5lcyA9IHJvb3QzLnBpbmdlZExhbmVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IHBlbmRpbmdMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZXNbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKGV4cGlyYXRpb25UaW1lID09PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICAgIGlmICgobGFuZSAmIHN1c3BlbmRlZExhbmVzKSA9PT0gTm9MYW5lcyB8fCAobGFuZSAmIHBpbmdlZExhbmVzKSAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4Ml0gPSBjb21wdXRlRXhwaXJhdGlvblRpbWUobGFuZSwgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChleHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZSkgewogICAgICAgICAgICAgIHJvb3QzLmV4cGlyZWRMYW5lcyB8PSBsYW5lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIaWdoZXN0UHJpb3JpdHlQZW5kaW5nTGFuZXMocm9vdDMpIHsKICAgICAgICAgIHJldHVybiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhyb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290MykgewogICAgICAgICAgdmFyIGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gPSByb290My5wZW5kaW5nTGFuZXMgJiB+T2Zmc2NyZWVuTGFuZTsKICAgICAgICAgIGlmIChldmVyeXRoaW5nQnV0T2Zmc2NyZWVuICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBldmVyeXRoaW5nQnV0T2Zmc2NyZWVuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gJiBPZmZzY3JlZW5MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiBPZmZzY3JlZW5MYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzU3luY0xhbmUobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBTeW5jTGFuZSkgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzTm9uSWRsZVdvcmsobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBOb25JZGxlTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc09ubHlSZXRyaWVzKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgUmV0cnlMYW5lcykgPT09IGxhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc09ubHlOb25VcmdlbnRMYW5lcyhsYW5lcykgewogICAgICAgICAgdmFyIFVyZ2VudExhbmVzID0gU3luY0xhbmUgfCBJbnB1dENvbnRpbnVvdXNMYW5lIHwgRGVmYXVsdExhbmU7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgVXJnZW50TGFuZXMpID09PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc09ubHlUcmFuc2l0aW9ucyhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFRyYW5zaXRpb25MYW5lcykgPT09IGxhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBTeW5jRGVmYXVsdExhbmVzID0gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSB8IElucHV0Q29udGludW91c0xhbmUgfCBEZWZhdWx0SHlkcmF0aW9uTGFuZSB8IERlZmF1bHRMYW5lOwogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFN5bmNEZWZhdWx0TGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc0V4cGlyZWRMYW5lKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIHJvb3QzLmV4cGlyZWRMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVHJhbnNpdGlvbkxhbmUobGFuZSkgewogICAgICAgICAgcmV0dXJuIChsYW5lICYgVHJhbnNpdGlvbkxhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xhaW1OZXh0VHJhbnNpdGlvbkxhbmUoKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IG5leHRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgIG5leHRUcmFuc2l0aW9uTGFuZSA8PD0gMTsKICAgICAgICAgIGlmICgobmV4dFRyYW5zaXRpb25MYW5lICYgVHJhbnNpdGlvbkxhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0VHJhbnNpdGlvbkxhbmUgPSBUcmFuc2l0aW9uTGFuZTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xhaW1OZXh0UmV0cnlMYW5lKCkgewogICAgICAgICAgdmFyIGxhbmUgPSBuZXh0UmV0cnlMYW5lOwogICAgICAgICAgbmV4dFJldHJ5TGFuZSA8PD0gMTsKICAgICAgICAgIGlmICgobmV4dFJldHJ5TGFuZSAmIFJldHJ5TGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG5leHRSZXRyeUxhbmUgPSBSZXRyeUxhbmUxOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpIHsKICAgICAgICAgIHJldHVybiBsYW5lcyAmIC1sYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGlja0FyYml0cmFyeUxhbmUobGFuZXMpIHsKICAgICAgICAgIHJldHVybiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcykgewogICAgICAgICAgcmV0dXJuIDMxIC0gY2x6MzIobGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lVG9JbmRleChsYW5lKSB7CiAgICAgICAgICByZXR1cm4gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNTb21lTGFuZShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gKGEgJiBiKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdWJzZXRPZkxhbmVzKHNldDQsIHN1YnNldCkgewogICAgICAgICAgcmV0dXJuIChzZXQ0ICYgc3Vic2V0KSA9PT0gc3Vic2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtZXJnZUxhbmVzKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhIHwgYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlTGFuZXMoc2V0NCwgc3Vic2V0KSB7CiAgICAgICAgICByZXR1cm4gc2V0NCAmIH5zdWJzZXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludGVyc2VjdExhbmVzKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICYgYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGFuZVRvTGFuZXMobGFuZSkgewogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZ2hlclByaW9yaXR5TGFuZShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAhPT0gTm9MYW5lICYmIGEgPCBiID8gYSA6IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUxhbmVNYXAoaW5pdGlhbCkgewogICAgICAgICAgdmFyIGxhbmVNYXAgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgVG90YWxMYW5lczsgaSsrKSB7CiAgICAgICAgICAgIGxhbmVNYXAucHVzaChpbml0aWFsKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lTWFwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIHVwZGF0ZUxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgcm9vdDMucGVuZGluZ0xhbmVzIHw9IHVwZGF0ZUxhbmU7CiAgICAgICAgICBpZiAodXBkYXRlTGFuZSAhPT0gSWRsZUxhbmUpIHsKICAgICAgICAgICAgcm9vdDMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICByb290My5waW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lcyA9IHJvb3QzLmV2ZW50VGltZXM7CiAgICAgICAgICB2YXIgaW5kZXgyID0gbGFuZVRvSW5kZXgodXBkYXRlTGFuZSk7CiAgICAgICAgICBldmVudFRpbWVzW2luZGV4Ml0gPSBldmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290U3VzcGVuZGVkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcykgewogICAgICAgICAgcm9vdDMuc3VzcGVuZGVkTGFuZXMgfD0gc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICByb290My5waW5nZWRMYW5lcyAmPSB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWVzID0gcm9vdDMuZXhwaXJhdGlvblRpbWVzOwogICAgICAgICAgdmFyIGxhbmVzID0gc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290UGluZ2VkKHJvb3QzLCBwaW5nZWRMYW5lcywgZXZlbnRUaW1lKSB7CiAgICAgICAgICByb290My5waW5nZWRMYW5lcyB8PSByb290My5zdXNwZW5kZWRMYW5lcyAmIHBpbmdlZExhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdEZpbmlzaGVkKHJvb3QzLCByZW1haW5pbmdMYW5lcykgewogICAgICAgICAgdmFyIG5vTG9uZ2VyUGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzICYgfnJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMucGVuZGluZ0xhbmVzID0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICByb290My5waW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICByb290My5leHBpcmVkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5tdXRhYmxlUmVhZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMuZW50YW5nbGVkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lcyA9IHJvb3QzLmV2ZW50VGltZXM7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWVzID0gcm9vdDMuZXhwaXJhdGlvblRpbWVzOwogICAgICAgICAgdmFyIGxhbmVzID0gbm9Mb25nZXJQZW5kaW5nTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdID0gTm9MYW5lczsKICAgICAgICAgICAgZXZlbnRUaW1lc1tpbmRleDJdID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgZW50YW5nbGVkTGFuZXMpIHsKICAgICAgICAgIHZhciByb290RW50YW5nbGVkTGFuZXMgPSByb290My5lbnRhbmdsZWRMYW5lcyB8PSBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgIHZhciBsYW5lcyA9IHJvb3RFbnRhbmdsZWRMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcykgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAvLyBJcyB0aGlzIG9uZSBvZiB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgIGxhbmUgJiBlbnRhbmdsZWRMYW5lcyB8IC8vIElzIHRoaXMgbGFuZSB0cmFuc2l0aXZlbHkgZW50YW5nbGVkIHdpdGggdGhlIG5ld2x5IGVudGFuZ2xlZCBsYW5lcz8KICAgICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4Ml0gJiBlbnRhbmdsZWRMYW5lcwogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4Ml0gfD0gZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEJ1bXBlZExhbmVGb3JIeWRyYXRpb24ocm9vdDMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHJlbmRlckxhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgbGFuZTsKICAgICAgICAgIHN3aXRjaCAocmVuZGVyTGFuZSkgewogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0xhbmU6CiAgICAgICAgICAgICAgbGFuZSA9IElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgICAgbGFuZSA9IERlZmF1bHRIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTg6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTA6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTY6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMToKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTM6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNDoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgIGxhbmUgPSBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBJZGxlTGFuZToKICAgICAgICAgICAgICBsYW5lID0gSWRsZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbGFuZSA9IE5vTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgobGFuZSAmIChyb290My5zdXNwZW5kZWRMYW5lcyB8IHJlbmRlckxhbmVzMikpICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRGaWJlclRvTGFuZXNNYXAocm9vdDMsIGZpYmVyLCBsYW5lcykgewogICAgICAgICAgaWYgKCFpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHJvb3QzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXA7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciB1cGRhdGVycyA9IHBlbmRpbmdVcGRhdGVyc0xhbmVNYXBbaW5kZXgyXTsKICAgICAgICAgICAgdXBkYXRlcnMuYWRkKGZpYmVyKTsKICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpIHsKICAgICAgICAgIGlmICghaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSByb290My5wZW5kaW5nVXBkYXRlcnNMYW5lTWFwOwogICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gbGFuZVRvSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICB2YXIgdXBkYXRlcnMgPSBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwW2luZGV4Ml07CiAgICAgICAgICAgIGlmICh1cGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgIHVwZGF0ZXJzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlID09PSBudWxsIHx8ICFtZW1vaXplZFVwZGF0ZXJzLmhhcyhhbHRlcm5hdGUpKSB7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuYWRkKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB1cGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmFuc2l0aW9uc0ZvckxhbmVzKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIERpc2NyZXRlRXZlbnRQcmlvcml0eSA9IFN5bmNMYW5lOwogICAgICAgIHZhciBDb250aW51b3VzRXZlbnRQcmlvcml0eSA9IElucHV0Q29udGludW91c0xhbmU7CiAgICAgICAgdmFyIERlZmF1bHRFdmVudFByaW9yaXR5ID0gRGVmYXVsdExhbmU7CiAgICAgICAgdmFyIElkbGVFdmVudFByaW9yaXR5ID0gSWRsZUxhbmU7CiAgICAgICAgdmFyIGN1cnJlbnRVcGRhdGVQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFVwZGF0ZVByaW9yaXR5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkobmV3UHJpb3JpdHkpIHsKICAgICAgICAgIGN1cnJlbnRVcGRhdGVQcmlvcml0eSA9IG5ld1ByaW9yaXR5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBydW5XaXRoUHJpb3JpdHkocHJpb3JpdHksIGZuKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGN1cnJlbnRVcGRhdGVQcmlvcml0eTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVQcmlvcml0eSA9IHByaW9yaXR5OwogICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVQcmlvcml0eSA9IHByZXZpb3VzUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZ2hlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IDAgJiYgYSA8IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbG93ZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhID09PSAwIHx8IGEgPiBiID8gYSA6IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSGlnaGVyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAhPT0gMCAmJiBhIDwgYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGFuZXNUb0V2ZW50UHJpb3JpdHkobGFuZXMpIHsKICAgICAgICAgIHZhciBsYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcyk7CiAgICAgICAgICBpZiAoIWlzSGlnaGVyRXZlbnRQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHksIGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzSGlnaGVyRXZlbnRQcmlvcml0eShDb250aW51b3VzRXZlbnRQcmlvcml0eSwgbGFuZSkpIHsKICAgICAgICAgICAgcmV0dXJuIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluY2x1ZGVzTm9uSWRsZVdvcmsobGFuZSkpIHsKICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIElkbGVFdmVudFByaW9yaXR5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSB7CiAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcm9vdDMuY3VycmVudC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIGN1cnJlbnRTdGF0ZS5pc0RlaHlkcmF0ZWQ7CiAgICAgICAgfQogICAgICAgIHZhciBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uOwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmbikgewogICAgICAgICAgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbiA9IGZuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZmliZXIpIHsKICAgICAgICAgIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb247CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oZm4pIHsKICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHk7CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KGZuKSB7CiAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkgPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxOwogICAgICAgIGZ1bmN0aW9uIHNldEdldEN1cnJlbnRVcGRhdGVQcmlvcml0eShmbikgewogICAgICAgICAgZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5JDEgPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5OwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KGZuKSB7CiAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IGZhbHNlOwogICAgICAgIHZhciBxdWV1ZWREaXNjcmV0ZUV2ZW50cyA9IFtdOwogICAgICAgIHZhciBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgdmFyIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgdmFyIHF1ZXVlZFBvaW50ZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB2YXIgcXVldWVkUG9pbnRlckNhcHR1cmVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB2YXIgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzID0gW107CiAgICAgICAgdmFyIGRpc2NyZXRlUmVwbGF5YWJsZUV2ZW50cyA9IFsKICAgICAgICAgICJtb3VzZWRvd24iLAogICAgICAgICAgIm1vdXNldXAiLAogICAgICAgICAgInRvdWNoY2FuY2VsIiwKICAgICAgICAgICJ0b3VjaGVuZCIsCiAgICAgICAgICAidG91Y2hzdGFydCIsCiAgICAgICAgICAiYXV4Y2xpY2siLAogICAgICAgICAgImRibGNsaWNrIiwKICAgICAgICAgICJwb2ludGVyY2FuY2VsIiwKICAgICAgICAgICJwb2ludGVyZG93biIsCiAgICAgICAgICAicG9pbnRlcnVwIiwKICAgICAgICAgICJkcmFnZW5kIiwKICAgICAgICAgICJkcmFnc3RhcnQiLAogICAgICAgICAgImRyb3AiLAogICAgICAgICAgImNvbXBvc2l0aW9uZW5kIiwKICAgICAgICAgICJjb21wb3NpdGlvbnN0YXJ0IiwKICAgICAgICAgICJrZXlkb3duIiwKICAgICAgICAgICJrZXlwcmVzcyIsCiAgICAgICAgICAia2V5dXAiLAogICAgICAgICAgImlucHV0IiwKICAgICAgICAgICJ0ZXh0SW5wdXQiLAogICAgICAgICAgLy8gSW50ZW50aW9uYWxseSBjYW1lbENhc2UKICAgICAgICAgICJjb3B5IiwKICAgICAgICAgICJjdXQiLAogICAgICAgICAgInBhc3RlIiwKICAgICAgICAgICJjbGljayIsCiAgICAgICAgICAiY2hhbmdlIiwKICAgICAgICAgICJjb250ZXh0bWVudSIsCiAgICAgICAgICAicmVzZXQiLAogICAgICAgICAgInN1Ym1pdCIKICAgICAgICBdOwogICAgICAgIGZ1bmN0aW9uIGlzRGlzY3JldGVFdmVudFRoYXRSZXF1aXJlc0h5ZHJhdGlvbihldmVudFR5cGUpIHsKICAgICAgICAgIHJldHVybiBkaXNjcmV0ZVJlcGxheWFibGVFdmVudHMuaW5kZXhPZihldmVudFR5cGUpID4gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVF1ZXVlZFJlcGxheWFibGVFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYmxvY2tlZE9uLAogICAgICAgICAgICBkb21FdmVudE5hbWUsCiAgICAgICAgICAgIGV2ZW50U3lzdGVtRmxhZ3MsCiAgICAgICAgICAgIG5hdGl2ZUV2ZW50LAogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzOiBbdGFyZ2V0Q29udGFpbmVyXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJJZkNvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2xlYXZlIjoKICAgICAgICAgICAgICBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICAgIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjogewogICAgICAgICAgICAgIHZhciBwb2ludGVySWQgPSBuYXRpdmVFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlcnMuZGVsZXRlKHBvaW50ZXJJZCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiZ290cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJsb3N0cG9pbnRlcmNhcHR1cmUiOiB7CiAgICAgICAgICAgICAgdmFyIF9wb2ludGVySWQgPSBuYXRpdmVFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLmRlbGV0ZShfcG9pbnRlcklkKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KGV4aXN0aW5nUXVldWVkRXZlbnQsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAoZXhpc3RpbmdRdWV1ZWRFdmVudCA9PT0gbnVsbCB8fCBleGlzdGluZ1F1ZXVlZEV2ZW50Lm5hdGl2ZUV2ZW50ICE9PSBuYXRpdmVFdmVudCkgewogICAgICAgICAgICB2YXIgcXVldWVkRXZlbnQgPSBjcmVhdGVRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICBpZiAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlcjIgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKGJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKF9maWJlcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKF9maWJlcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcXVldWVkRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBleGlzdGluZ1F1ZXVlZEV2ZW50LmV2ZW50U3lzdGVtRmxhZ3MgfD0gZXZlbnRTeXN0ZW1GbGFnczsKICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJzID0gZXhpc3RpbmdRdWV1ZWRFdmVudC50YXJnZXRDb250YWluZXJzOwogICAgICAgICAgaWYgKHRhcmdldENvbnRhaW5lciAhPT0gbnVsbCAmJiB0YXJnZXRDb250YWluZXJzLmluZGV4T2YodGFyZ2V0Q29udGFpbmVyKSA9PT0gLTEpIHsKICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVycy5wdXNoKHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXhpc3RpbmdRdWV1ZWRFdmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcXVldWVJZkNvbnRpbnVvdXNFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6IHsKICAgICAgICAgICAgICB2YXIgZm9jdXNFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHF1ZXVlZEZvY3VzID0gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRGb2N1cywgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgZm9jdXNFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjogewogICAgICAgICAgICAgIHZhciBkcmFnRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWREcmFnID0gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWREcmFnLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBkcmFnRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6IHsKICAgICAgICAgICAgICB2YXIgbW91c2VFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHF1ZXVlZE1vdXNlID0gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRNb3VzZSwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbW91c2VFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHZhciBwb2ludGVySWQgPSBwb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLnNldChwb2ludGVySWQsIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkUG9pbnRlcnMuZ2V0KHBvaW50ZXJJZCkgfHwgbnVsbCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgcG9pbnRlckV2ZW50KSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiZ290cG9pbnRlcmNhcHR1cmUiOiB7CiAgICAgICAgICAgICAgdmFyIF9wb2ludGVyRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJJZDIgPSBfcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuc2V0KF9wb2ludGVySWQyLCBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5nZXQoX3BvaW50ZXJJZDIpIHx8IG51bGwsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIF9wb2ludGVyRXZlbnQpKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0RXhwbGljaXRIeWRyYXRpb25UYXJnZXQocXVldWVkVGFyZ2V0KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0SW5zdCA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKHF1ZXVlZFRhcmdldC50YXJnZXQpOwogICAgICAgICAgaWYgKHRhcmdldEluc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHRhZyA9IG5lYXJlc3RNb3VudGVkLnRhZzsKICAgICAgICAgICAgICBpZiAodGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0U3VzcGVuc2VJbnN0YW5jZUZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShxdWV1ZWRUYXJnZXQucHJpb3JpdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBuZWFyZXN0TW91bnRlZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IGdldENvbnRhaW5lckZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHRhcmdldCkgewogICAgICAgICAgdmFyIHVwZGF0ZVByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5JDEoKTsKICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXQgPSB7CiAgICAgICAgICAgIGJsb2NrZWRPbjogbnVsbCwKICAgICAgICAgICAgdGFyZ2V0LAogICAgICAgICAgICBwcmlvcml0eTogdXBkYXRlUHJpb3JpdHkKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICBmb3IgKDsgaSA8IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoIWlzSGlnaGVyRXZlbnRQcmlvcml0eSh1cGRhdGVQcmlvcml0eSwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzW2ldLnByaW9yaXR5KSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMuc3BsaWNlKGksIDAsIHF1ZXVlZFRhcmdldCk7CiAgICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgICBhdHRlbXB0RXhwbGljaXRIeWRyYXRpb25UYXJnZXQocXVldWVkVGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRFdmVudCkgewogICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVycyA9IHF1ZXVlZEV2ZW50LnRhcmdldENvbnRhaW5lcnM7CiAgICAgICAgICB3aGlsZSAodGFyZ2V0Q29udGFpbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXIgPSB0YXJnZXRDb250YWluZXJzWzBdOwogICAgICAgICAgICB2YXIgbmV4dEJsb2NrZWRPbiA9IGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQocXVldWVkRXZlbnQuZG9tRXZlbnROYW1lLCBxdWV1ZWRFdmVudC5ldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIHF1ZXVlZEV2ZW50Lm5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBxdWV1ZWRFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICAgIHZhciBuYXRpdmVFdmVudENsb25lID0gbmV3IG5hdGl2ZUV2ZW50LmNvbnN0cnVjdG9yKG5hdGl2ZUV2ZW50LnR5cGUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICAgIHNldFJlcGxheWluZ0V2ZW50KG5hdGl2ZUV2ZW50Q2xvbmUpOwogICAgICAgICAgICAgICAgbmF0aXZlRXZlbnQudGFyZ2V0LmRpc3BhdGNoRXZlbnQobmF0aXZlRXZlbnRDbG9uZSk7CiAgICAgICAgICAgICAgICByZXNldFJlcGxheWluZ0V2ZW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfZmliZXIzID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShuZXh0QmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoX2ZpYmVyMyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oX2ZpYmVyMyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG5leHRCbG9ja2VkT247CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnMuc2hpZnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50SW5NYXAocXVldWVkRXZlbnQsIGtleSwgbWFwMykgewogICAgICAgICAgaWYgKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRXZlbnQpKSB7CiAgICAgICAgICAgIG1hcDMuZGVsZXRlKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcGxheVVuYmxvY2tlZEV2ZW50cygpIHsKICAgICAgICAgIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICAgIGlmIChxdWV1ZWRGb2N1cyAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEZvY3VzKSkgewogICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRHJhZyAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZERyYWcpKSB7CiAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZE1vdXNlICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkTW91c2UpKSB7CiAgICAgICAgICAgIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmZvckVhY2goYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRFdmVudCwgdW5ibG9ja2VkKSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0KSB7CiAgICAgICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IHRydWU7CiAgICAgICAgICAgICAgU2NoZWR1bGVyLnVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2soU2NoZWR1bGVyLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5LCByZXBsYXlVbmJsb2NrZWRFdmVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJldHJ5SWZCbG9ja2VkT24odW5ibG9ja2VkKSB7CiAgICAgICAgICBpZiAocXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRGlzY3JldGVFdmVudHNbMF0sIHVuYmxvY2tlZCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcXVldWVkRXZlbnQgPSBxdWV1ZWREaXNjcmV0ZUV2ZW50c1tpXTsKICAgICAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEZvY3VzLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZERyYWcsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkTW91c2UgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZE1vdXNlLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVuYmxvY2sgPSBmdW5jdGlvbihxdWV1ZWRFdmVudDIpIHsKICAgICAgICAgICAgcmV0dXJuIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRFdmVudDIsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9OwogICAgICAgICAgcXVldWVkUG9pbnRlcnMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKHVuYmxvY2spOwogICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tfaV07CiAgICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBuZXh0RXhwbGljaXRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbMF07CiAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KG5leHRFeHBsaWNpdFRhcmdldCk7CiAgICAgICAgICAgICAgaWYgKG5leHRFeHBsaWNpdFRhcmdldC5ibG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zaGlmdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgX2VuYWJsZWQgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIHNldEVuYWJsZWQoZW5hYmxlZCkgewogICAgICAgICAgX2VuYWJsZWQgPSAhIWVuYWJsZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRW5hYmxlZCgpIHsKICAgICAgICAgIHJldHVybiBfZW5hYmxlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRXZlbnRMaXN0ZW5lcldyYXBwZXJXaXRoUHJpb3JpdHkodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MpIHsKICAgICAgICAgIHZhciBldmVudFByaW9yaXR5ID0gZ2V0RXZlbnRQcmlvcml0eShkb21FdmVudE5hbWUpOwogICAgICAgICAgdmFyIGxpc3RlbmVyV3JhcHBlcjsKICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaERpc2NyZXRlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcldyYXBwZXIuYmluZChudWxsLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRGlzY3JldGVFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShDb250aW51b3VzRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmICghX2VuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRXaXRoRW5hYmxlQ2FwdHVyZVBoYXNlU2VsZWN0aXZlSHlkcmF0aW9uV2l0aG91dERpc2NyZXRlRXZlbnRSZXBsYXkoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgYmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgaWYgKGJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgcmV0dXJuX3RhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICBuYXRpdmVFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY2xlYXJJZkNvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIGlmIChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSAmJiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICB3aGlsZSAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCByZXR1cm5fdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IGJsb2NrZWRPbikgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJsb2NrZWRPbiA9IG5leHRCbG9ja2VkT247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCBudWxsLCB0YXJnZXRDb250YWluZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm5fdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRUYXJnZXQgPSBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCk7CiAgICAgICAgICB2YXIgdGFyZ2V0SW5zdCA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gdGFyZ2V0SW5zdCkgewogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRQcmlvcml0eShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiY2xvc2UiOgogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImludmFsaWQiOgogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgIGNhc2UgInBhdXNlIjoKICAgICAgICAgICAgY2FzZSAicGxheSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZG93biI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJ1cCI6CiAgICAgICAgICAgIGNhc2UgInJhdGVjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJyZXNldCI6CiAgICAgICAgICAgIGNhc2UgInJlc2l6ZSI6CiAgICAgICAgICAgIGNhc2UgInNlZWtlZCI6CiAgICAgICAgICAgIGNhc2UgInN1Ym1pdCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hlbmQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaHN0YXJ0IjoKICAgICAgICAgICAgY2FzZSAidm9sdW1lY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAiY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25zdGFydCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb251cGRhdGUiOgogICAgICAgICAgICBjYXNlICJiZWZvcmVibHVyIjoKICAgICAgICAgICAgY2FzZSAiYWZ0ZXJibHVyIjoKICAgICAgICAgICAgY2FzZSAiYmVmb3JlaW5wdXQiOgogICAgICAgICAgICBjYXNlICJibHVyIjoKICAgICAgICAgICAgY2FzZSAiZnVsbHNjcmVlbmNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgImZvY3VzIjoKICAgICAgICAgICAgY2FzZSAiaGFzaGNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInBvcHN0YXRlIjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0c3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgIGNhc2UgInRvZ2dsZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgIndoZWVsIjoKICAgICAgICAgICAgY2FzZSAibW91c2VlbnRlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbGVhdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZW50ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVybGVhdmUiOgogICAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgY2FzZSAibWVzc2FnZSI6IHsKICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHkgPSBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCgpOwogICAgICAgICAgICAgIHN3aXRjaCAoc2NoZWR1bGVyUHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMikgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIGZhbHNlKTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcjIpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIyLCB0cnVlKTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHBhc3NpdmUpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIyLCB7CiAgICAgICAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgICAgICAgIHBhc3NpdmUKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBwYXNzaXZlKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgewogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjI7CiAgICAgICAgfQogICAgICAgIHZhciByb290MiA9IG51bGw7CiAgICAgICAgdmFyIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgdmFyIGZhbGxiYWNrVGV4dCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgcm9vdDIgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgIHN0YXJ0VGV4dCA9IGdldFRleHQoKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgICAgIHJvb3QyID0gbnVsbDsKICAgICAgICAgIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgICBmYWxsYmFja1RleHQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhKCkgewogICAgICAgICAgaWYgKGZhbGxiYWNrVGV4dCkgewogICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tUZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXJ0OwogICAgICAgICAgdmFyIHN0YXJ0VmFsdWUgPSBzdGFydFRleHQ7CiAgICAgICAgICB2YXIgc3RhcnRMZW5ndGggPSBzdGFydFZhbHVlLmxlbmd0aDsKICAgICAgICAgIHZhciBlbmQ7CiAgICAgICAgICB2YXIgZW5kVmFsdWUgPSBnZXRUZXh0KCk7CiAgICAgICAgICB2YXIgZW5kTGVuZ3RoID0gZW5kVmFsdWUubGVuZ3RoOwogICAgICAgICAgZm9yIChzdGFydCA9IDA7IHN0YXJ0IDwgc3RhcnRMZW5ndGg7IHN0YXJ0KyspIHsKICAgICAgICAgICAgaWYgKHN0YXJ0VmFsdWVbc3RhcnRdICE9PSBlbmRWYWx1ZVtzdGFydF0pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG1pbkVuZCA9IHN0YXJ0TGVuZ3RoIC0gc3RhcnQ7CiAgICAgICAgICBmb3IgKGVuZCA9IDE7IGVuZCA8PSBtaW5FbmQ7IGVuZCsrKSB7CiAgICAgICAgICAgIGlmIChzdGFydFZhbHVlW3N0YXJ0TGVuZ3RoIC0gZW5kXSAhPT0gZW5kVmFsdWVbZW5kTGVuZ3RoIC0gZW5kXSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2xpY2VUYWlsID0gZW5kID4gMSA/IDEgLSBlbmQgOiB2b2lkIDA7CiAgICAgICAgICBmYWxsYmFja1RleHQgPSBlbmRWYWx1ZS5zbGljZShzdGFydCwgc2xpY2VUYWlsKTsKICAgICAgICAgIHJldHVybiBmYWxsYmFja1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRleHQoKSB7CiAgICAgICAgICBpZiAoInZhbHVlIiBpbiByb290MikgewogICAgICAgICAgICByZXR1cm4gcm9vdDIudmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcm9vdDIudGV4dENvbnRlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBjaGFyQ29kZTsKICAgICAgICAgIHZhciBrZXlDb2RlID0gbmF0aXZlRXZlbnQua2V5Q29kZTsKICAgICAgICAgIGlmICgiY2hhckNvZGUiIGluIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gbmF0aXZlRXZlbnQuY2hhckNvZGU7CiAgICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gMCAmJiBrZXlDb2RlID09PSAxMykgewogICAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0ga2V5Q29kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gMTApIHsKICAgICAgICAgICAgY2hhckNvZGUgPSAxMzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFyQ29kZSA+PSAzMiB8fCBjaGFyQ29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlKCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZSgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlU3ludGhldGljRXZlbnQoSW50ZXJmYWNlKSB7CiAgICAgICAgICBmdW5jdGlvbiBTeW50aGV0aWNCYXNlRXZlbnQocmVhY3ROYW1lLCByZWFjdEV2ZW50VHlwZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHRoaXMuX3JlYWN0TmFtZSA9IHJlYWN0TmFtZTsKICAgICAgICAgICAgdGhpcy5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHJlYWN0RXZlbnRUeXBlOwogICAgICAgICAgICB0aGlzLm5hdGl2ZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9wcm9wTmFtZSBpbiBJbnRlcmZhY2UpIHsKICAgICAgICAgICAgICBpZiAoIUludGVyZmFjZS5oYXNPd25Qcm9wZXJ0eShfcHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZTIgPSBJbnRlcmZhY2VbX3Byb3BOYW1lXTsKICAgICAgICAgICAgICBpZiAobm9ybWFsaXplMikgewogICAgICAgICAgICAgICAgdGhpc1tfcHJvcE5hbWVdID0gbm9ybWFsaXplMihuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5hdGl2ZUV2ZW50W19wcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJldmVudGVkID0gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCAhPSBudWxsID8gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCA6IG5hdGl2ZUV2ZW50LnJldHVyblZhbHVlID09PSBmYWxzZTsKICAgICAgICAgICAgaWYgKGRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgYXNzaWduMihTeW50aGV0aWNCYXNlRXZlbnQucHJvdG90eXBlLCB7CiAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBldmVudCA9IHRoaXMubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgaWYgKCFldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXZlbnQucmV0dXJuVmFsdWUgIT09ICJ1bmtub3duIikgewogICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIGlmICghZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXZlbnQuY2FuY2VsQnViYmxlICE9PSAidW5rbm93biIpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFdlIHJlbGVhc2UgYWxsIGRpc3BhdGNoZWQgYFN5bnRoZXRpY0V2ZW50YHMgYWZ0ZXIgZWFjaCBldmVudCBsb29wLCBhZGRpbmcKICAgICAgICAgICAgICogdGhlbSBiYWNrIGludG8gdGhlIHBvb2wuIFRoaXMgYWxsb3dzIGEgd2F5IHRvIGhvbGQgb250byBhIHJlZmVyZW5jZSB0aGF0CiAgICAgICAgICAgICAqIHdvbid0IGJlIGFkZGVkIGJhY2sgaW50byB0aGUgcG9vbC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHBlcnNpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ2hlY2tzIGlmIHRoaXMgZXZlbnQgc2hvdWxkIGJlIHJlbGVhc2VkIGJhY2sgaW50byB0aGUgcG9vbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGlzIHNob3VsZCBub3QgYmUgcmVsZWFzZWQsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlzUGVyc2lzdGVudDogZnVuY3Rpb25UaGF0UmV0dXJuc1RydWUKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIFN5bnRoZXRpY0Jhc2VFdmVudDsKICAgICAgICB9CiAgICAgICAgdmFyIEV2ZW50SW50ZXJmYWNlID0gewogICAgICAgICAgZXZlbnRQaGFzZTogMCwKICAgICAgICAgIGJ1YmJsZXM6IDAsCiAgICAgICAgICBjYW5jZWxhYmxlOiAwLAogICAgICAgICAgdGltZVN0YW1wOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gZXZlbnQudGltZVN0YW1wIHx8IERhdGUubm93KCk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogMCwKICAgICAgICAgIGlzVHJ1c3RlZDogMAogICAgICAgIH07CiAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBVSUV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHZpZXc6IDAsCiAgICAgICAgICBkZXRhaWw6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljVUlFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFVJRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBsYXN0TW92ZW1lbnRYOwogICAgICAgIHZhciBsYXN0TW92ZW1lbnRZOwogICAgICAgIHZhciBsYXN0TW91c2VFdmVudDsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVNb3VzZU1vdmVtZW50UG9seWZpbGxTdGF0ZShldmVudCkgewogICAgICAgICAgaWYgKGV2ZW50ICE9PSBsYXN0TW91c2VFdmVudCkgewogICAgICAgICAgICBpZiAobGFzdE1vdXNlRXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlbW92ZSIpIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gZXZlbnQuc2NyZWVuWCAtIGxhc3RNb3VzZUV2ZW50LnNjcmVlblg7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WSA9IGV2ZW50LnNjcmVlblkgLSBsYXN0TW91c2VFdmVudC5zY3JlZW5ZOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFggPSAwOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RNb3VzZUV2ZW50ID0gZXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBNb3VzZUV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgc2NyZWVuWDogMCwKICAgICAgICAgIHNjcmVlblk6IDAsCiAgICAgICAgICBjbGllbnRYOiAwLAogICAgICAgICAgY2xpZW50WTogMCwKICAgICAgICAgIHBhZ2VYOiAwLAogICAgICAgICAgcGFnZVk6IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlLAogICAgICAgICAgYnV0dG9uOiAwLAogICAgICAgICAgYnV0dG9uczogMCwKICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC5yZWxhdGVkVGFyZ2V0ID09PSB2b2lkIDApIHJldHVybiBldmVudC5mcm9tRWxlbWVudCA9PT0gZXZlbnQuc3JjRWxlbWVudCA/IGV2ZW50LnRvRWxlbWVudCA6IGV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICByZXR1cm4gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgIH0sCiAgICAgICAgICBtb3ZlbWVudFg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICgibW92ZW1lbnRYIiBpbiBldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpOwogICAgICAgICAgICByZXR1cm4gbGFzdE1vdmVtZW50WDsKICAgICAgICAgIH0sCiAgICAgICAgICBtb3ZlbWVudFk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICgibW92ZW1lbnRZIiBpbiBldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY01vdXNlRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChNb3VzZUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRHJhZ0V2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgTW91c2VFdmVudEludGVyZmFjZSwgewogICAgICAgICAgZGF0YVRyYW5zZmVyOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0RyYWdFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KERyYWdFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEZvY3VzRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICByZWxhdGVkVGFyZ2V0OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0ZvY3VzRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChGb2N1c0V2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQW5pbWF0aW9uRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgYW5pbWF0aW9uTmFtZTogMCwKICAgICAgICAgIGVsYXBzZWRUaW1lOiAwLAogICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNBbmltYXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgY2xpcGJvYXJkRGF0YTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICJjbGlwYm9hcmREYXRhIiBpbiBldmVudCA/IGV2ZW50LmNsaXBib2FyZERhdGEgOiB3aW5kb3cuY2xpcGJvYXJkRGF0YTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQ2xpcGJvYXJkRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChDbGlwYm9hcmRFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgZGF0YTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNDb21wb3NpdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQ29tcG9zaXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0lucHV0RXZlbnQgPSBTeW50aGV0aWNDb21wb3NpdGlvbkV2ZW50OwogICAgICAgIHZhciBub3JtYWxpemVLZXkgPSB7CiAgICAgICAgICBFc2M6ICJFc2NhcGUiLAogICAgICAgICAgU3BhY2ViYXI6ICIgIiwKICAgICAgICAgIExlZnQ6ICJBcnJvd0xlZnQiLAogICAgICAgICAgVXA6ICJBcnJvd1VwIiwKICAgICAgICAgIFJpZ2h0OiAiQXJyb3dSaWdodCIsCiAgICAgICAgICBEb3duOiAiQXJyb3dEb3duIiwKICAgICAgICAgIERlbDogIkRlbGV0ZSIsCiAgICAgICAgICBXaW46ICJPUyIsCiAgICAgICAgICBNZW51OiAiQ29udGV4dE1lbnUiLAogICAgICAgICAgQXBwczogIkNvbnRleHRNZW51IiwKICAgICAgICAgIFNjcm9sbDogIlNjcm9sbExvY2siLAogICAgICAgICAgTW96UHJpbnRhYmxlS2V5OiAiVW5pZGVudGlmaWVkIgogICAgICAgIH07CiAgICAgICAgdmFyIHRyYW5zbGF0ZVRvS2V5ID0gewogICAgICAgICAgIjgiOiAiQmFja3NwYWNlIiwKICAgICAgICAgICI5IjogIlRhYiIsCiAgICAgICAgICAiMTIiOiAiQ2xlYXIiLAogICAgICAgICAgIjEzIjogIkVudGVyIiwKICAgICAgICAgICIxNiI6ICJTaGlmdCIsCiAgICAgICAgICAiMTciOiAiQ29udHJvbCIsCiAgICAgICAgICAiMTgiOiAiQWx0IiwKICAgICAgICAgICIxOSI6ICJQYXVzZSIsCiAgICAgICAgICAiMjAiOiAiQ2Fwc0xvY2siLAogICAgICAgICAgIjI3IjogIkVzY2FwZSIsCiAgICAgICAgICAiMzIiOiAiICIsCiAgICAgICAgICAiMzMiOiAiUGFnZVVwIiwKICAgICAgICAgICIzNCI6ICJQYWdlRG93biIsCiAgICAgICAgICAiMzUiOiAiRW5kIiwKICAgICAgICAgICIzNiI6ICJIb21lIiwKICAgICAgICAgICIzNyI6ICJBcnJvd0xlZnQiLAogICAgICAgICAgIjM4IjogIkFycm93VXAiLAogICAgICAgICAgIjM5IjogIkFycm93UmlnaHQiLAogICAgICAgICAgIjQwIjogIkFycm93RG93biIsCiAgICAgICAgICAiNDUiOiAiSW5zZXJ0IiwKICAgICAgICAgICI0NiI6ICJEZWxldGUiLAogICAgICAgICAgIjExMiI6ICJGMSIsCiAgICAgICAgICAiMTEzIjogIkYyIiwKICAgICAgICAgICIxMTQiOiAiRjMiLAogICAgICAgICAgIjExNSI6ICJGNCIsCiAgICAgICAgICAiMTE2IjogIkY1IiwKICAgICAgICAgICIxMTciOiAiRjYiLAogICAgICAgICAgIjExOCI6ICJGNyIsCiAgICAgICAgICAiMTE5IjogIkY4IiwKICAgICAgICAgICIxMjAiOiAiRjkiLAogICAgICAgICAgIjEyMSI6ICJGMTAiLAogICAgICAgICAgIjEyMiI6ICJGMTEiLAogICAgICAgICAgIjEyMyI6ICJGMTIiLAogICAgICAgICAgIjE0NCI6ICJOdW1Mb2NrIiwKICAgICAgICAgICIxNDUiOiAiU2Nyb2xsTG9jayIsCiAgICAgICAgICAiMjI0IjogIk1ldGEiCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBnZXRFdmVudEtleShuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmtleSkgewogICAgICAgICAgICB2YXIga2V5ID0gbm9ybWFsaXplS2V5W25hdGl2ZUV2ZW50LmtleV0gfHwgbmF0aXZlRXZlbnQua2V5OwogICAgICAgICAgICBpZiAoa2V5ICE9PSAiVW5pZGVudGlmaWVkIikgewogICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgIHZhciBjaGFyQ29kZSA9IGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpOwogICAgICAgICAgICByZXR1cm4gY2hhckNvZGUgPT09IDEzID8gIkVudGVyIiA6IFN0cmluZy5mcm9tQ2hhckNvZGUoY2hhckNvZGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBuYXRpdmVFdmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgIHJldHVybiB0cmFuc2xhdGVUb0tleVtuYXRpdmVFdmVudC5rZXlDb2RlXSB8fCAiVW5pZGVudGlmaWVkIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIG1vZGlmaWVyS2V5VG9Qcm9wID0gewogICAgICAgICAgQWx0OiAiYWx0S2V5IiwKICAgICAgICAgIENvbnRyb2w6ICJjdHJsS2V5IiwKICAgICAgICAgIE1ldGE6ICJtZXRhS2V5IiwKICAgICAgICAgIFNoaWZ0OiAic2hpZnRLZXkiCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBtb2RpZmllclN0YXRlR2V0dGVyKGtleUFyZykgewogICAgICAgICAgdmFyIHN5bnRoZXRpY0V2ZW50ID0gdGhpczsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudCA9IHN5bnRoZXRpY0V2ZW50Lm5hdGl2ZUV2ZW50OwogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmdldE1vZGlmaWVyU3RhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50LmdldE1vZGlmaWVyU3RhdGUoa2V5QXJnKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBrZXlQcm9wID0gbW9kaWZpZXJLZXlUb1Byb3Bba2V5QXJnXTsKICAgICAgICAgIHJldHVybiBrZXlQcm9wID8gISFuYXRpdmVFdmVudFtrZXlQcm9wXSA6IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudE1vZGlmaWVyU3RhdGUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBtb2RpZmllclN0YXRlR2V0dGVyOwogICAgICAgIH0KICAgICAgICB2YXIgS2V5Ym9hcmRFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGtleTogZ2V0RXZlbnRLZXksCiAgICAgICAgICBjb2RlOiAwLAogICAgICAgICAgbG9jYXRpb246IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgcmVwZWF0OiAwLAogICAgICAgICAgbG9jYWxlOiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlLAogICAgICAgICAgLy8gTGVnYWN5IEludGVyZmFjZQogICAgICAgICAgY2hhckNvZGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEV2ZW50Q2hhckNvZGUoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSwKICAgICAgICAgIGtleUNvZGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5ZG93biIgfHwgZXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXlDb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSwKICAgICAgICAgIHdoaWNoOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljS2V5Ym9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEtleWJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBQb2ludGVyRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBwb2ludGVySWQ6IDAsCiAgICAgICAgICB3aWR0aDogMCwKICAgICAgICAgIGhlaWdodDogMCwKICAgICAgICAgIHByZXNzdXJlOiAwLAogICAgICAgICAgdGFuZ2VudGlhbFByZXNzdXJlOiAwLAogICAgICAgICAgdGlsdFg6IDAsCiAgICAgICAgICB0aWx0WTogMCwKICAgICAgICAgIHR3aXN0OiAwLAogICAgICAgICAgcG9pbnRlclR5cGU6IDAsCiAgICAgICAgICBpc1ByaW1hcnk6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljUG9pbnRlckV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoUG9pbnRlckV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgVG91Y2hFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHRvdWNoZXM6IDAsCiAgICAgICAgICB0YXJnZXRUb3VjaGVzOiAwLAogICAgICAgICAgY2hhbmdlZFRvdWNoZXM6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1RvdWNoRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChUb3VjaEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHByb3BlcnR5TmFtZTogMCwKICAgICAgICAgIGVsYXBzZWRUaW1lOiAwLAogICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChUcmFuc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBXaGVlbEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgTW91c2VFdmVudEludGVyZmFjZSwgewogICAgICAgICAgZGVsdGFYOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImRlbHRhWCIgaW4gZXZlbnQgPyBldmVudC5kZWx0YVggOiAoCiAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFYYCBmb3IgV2Via2l0IGFuZCBub3JtYWxpemUgKHJpZ2h0IGlzIHBvc2l0aXZlKS4KICAgICAgICAgICAgICAid2hlZWxEZWx0YVgiIGluIGV2ZW50ID8gLWV2ZW50LndoZWVsRGVsdGFYIDogMAogICAgICAgICAgICApOwogICAgICAgICAgfSwKICAgICAgICAgIGRlbHRhWTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICJkZWx0YVkiIGluIGV2ZW50ID8gZXZlbnQuZGVsdGFZIDogKAogICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhWWAgZm9yIFdlYmtpdCBhbmQgbm9ybWFsaXplIChkb3duIGlzIHBvc2l0aXZlKS4KICAgICAgICAgICAgICAid2hlZWxEZWx0YVkiIGluIGV2ZW50ID8gLWV2ZW50LndoZWVsRGVsdGFZIDogKAogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFgIGZvciBJRTw5IGFuZCBub3JtYWxpemUgKGRvd24gaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICAgIndoZWVsRGVsdGEiIGluIGV2ZW50ID8gLWV2ZW50LndoZWVsRGVsdGEgOiAwCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgICAgfSwKICAgICAgICAgIGRlbHRhWjogMCwKICAgICAgICAgIC8vIEJyb3dzZXJzIHdpdGhvdXQgImRlbHRhTW9kZSIgaXMgcmVwb3J0aW5nIGluIHJhdyB3aGVlbCBkZWx0YSB3aGVyZSBvbmUKICAgICAgICAgIC8vIG5vdGNoIG9uIHRoZSBzY3JvbGwgaXMgYWx3YXlzICsvLSAxMjAsIHJvdWdobHkgZXF1aXZhbGVudCB0byBwaXhlbHMuCiAgICAgICAgICAvLyBBIGdvb2QgYXBwcm94aW1hdGlvbiBvZiBET01fREVMVEFfTElORSAoMSkgaXMgNSUgb2Ygdmlld3BvcnQgc2l6ZSBvcgogICAgICAgICAgLy8gfjQwIHBpeGVscywgZm9yIERPTV9ERUxUQV9TQ1JFRU4gKDIpIGl0IGlzIDg3LjUlIG9mIHZpZXdwb3J0IHNpemUuCiAgICAgICAgICBkZWx0YU1vZGU6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljV2hlZWxFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFdoZWVsRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBFTkRfS0VZQ09ERVMgPSBbOSwgMTMsIDI3LCAzMl07CiAgICAgICAgdmFyIFNUQVJUX0tFWUNPREUgPSAyMjk7CiAgICAgICAgdmFyIGNhblVzZUNvbXBvc2l0aW9uRXZlbnQgPSBjYW5Vc2VET00yICYmICJDb21wb3NpdGlvbkV2ZW50IiBpbiB3aW5kb3c7CiAgICAgICAgdmFyIGRvY3VtZW50TW9kZSA9IG51bGw7CiAgICAgICAgaWYgKGNhblVzZURPTTIgJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQpIHsKICAgICAgICAgIGRvY3VtZW50TW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNhblVzZVRleHRJbnB1dEV2ZW50ID0gY2FuVXNlRE9NMiAmJiAiVGV4dEV2ZW50IiBpbiB3aW5kb3cgJiYgIWRvY3VtZW50TW9kZTsKICAgICAgICB2YXIgdXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgPSBjYW5Vc2VET00yICYmICghY2FuVXNlQ29tcG9zaXRpb25FdmVudCB8fCBkb2N1bWVudE1vZGUgJiYgZG9jdW1lbnRNb2RlID4gOCAmJiBkb2N1bWVudE1vZGUgPD0gMTEpOwogICAgICAgIHZhciBTUEFDRUJBUl9DT0RFID0gMzI7CiAgICAgICAgdmFyIFNQQUNFQkFSX0NIQVIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKFNQQUNFQkFSX0NPREUpOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkJlZm9yZUlucHV0IiwgWyJjb21wb3NpdGlvbmVuZCIsICJrZXlwcmVzcyIsICJ0ZXh0SW5wdXQiLCAicGFzdGUiXSk7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ29tcG9zaXRpb25FbmQiLCBbImNvbXBvc2l0aW9uZW5kIiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uU3RhcnQiLCBbImNvbXBvc2l0aW9uc3RhcnQiLCAiZm9jdXNvdXQiLCAia2V5ZG93biIsICJrZXlwcmVzcyIsICJrZXl1cCIsICJtb3VzZWRvd24iXSk7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ29tcG9zaXRpb25VcGRhdGUiLCBbImNvbXBvc2l0aW9udXBkYXRlIiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzU3BhY2VLZXlwcmVzcyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gKG5hdGl2ZUV2ZW50LmN0cmxLZXkgfHwgbmF0aXZlRXZlbnQuYWx0S2V5IHx8IG5hdGl2ZUV2ZW50Lm1ldGFLZXkpICYmIC8vIGN0cmxLZXkgJiYgYWx0S2V5IGlzIGVxdWl2YWxlbnQgdG8gQWx0R3IsIGFuZCBpcyBub3QgYSBjb21tYW5kLgogICAgICAgICAgIShuYXRpdmVFdmVudC5jdHJsS2V5ICYmIG5hdGl2ZUV2ZW50LmFsdEtleSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25zdGFydCI6CiAgICAgICAgICAgICAgcmV0dXJuICJvbkNvbXBvc2l0aW9uU3RhcnQiOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuICJvbkNvbXBvc2l0aW9uRW5kIjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb251cGRhdGUiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblVwZGF0ZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmFsbGJhY2tDb21wb3NpdGlvblN0YXJ0KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBkb21FdmVudE5hbWUgPT09ICJrZXlkb3duIiAmJiBuYXRpdmVFdmVudC5rZXlDb2RlID09PSBTVEFSVF9LRVlDT0RFOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIHJldHVybiBFTkRfS0VZQ09ERVMuaW5kZXhPZihuYXRpdmVFdmVudC5rZXlDb2RlKSAhPT0gLTE7CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5rZXlDb2RlICE9PSBTVEFSVF9LRVlDT0RFOwogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERhdGFGcm9tQ3VzdG9tRXZlbnQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBkZXRhaWwgPSBuYXRpdmVFdmVudC5kZXRhaWw7CiAgICAgICAgICBpZiAodHlwZW9mIGRldGFpbCA9PT0gIm9iamVjdCIgJiYgImRhdGEiIGluIGRldGFpbCkgewogICAgICAgICAgICByZXR1cm4gZGV0YWlsLmRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNVc2luZ0tvcmVhbklNRShuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50LmxvY2FsZSA9PT0gImtvIjsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQ29tcG9zaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciBldmVudFR5cGU7CiAgICAgICAgICB2YXIgZmFsbGJhY2tEYXRhOwogICAgICAgICAgaWYgKGNhblVzZUNvbXBvc2l0aW9uRXZlbnQpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gZ2V0Q29tcG9zaXRpb25FdmVudFR5cGUoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIH0gZWxzZSBpZiAoIWlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgIGV2ZW50VHlwZSA9ICJvbkNvbXBvc2l0aW9uU3RhcnQiOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGlzRmFsbGJhY2tDb21wb3NpdGlvbkVuZChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWV2ZW50VHlwZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSAmJiAhaXNVc2luZ0tvcmVhbklNRShuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgaWYgKCFpc0NvbXBvc2luZyAmJiBldmVudFR5cGUgPT09ICJvbkNvbXBvc2l0aW9uU3RhcnQiKSB7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBpbml0aWFsaXplKG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09ICJvbkNvbXBvc2l0aW9uRW5kIikgewogICAgICAgICAgICAgIGlmIChpc0NvbXBvc2luZykgewogICAgICAgICAgICAgICAgZmFsbGJhY2tEYXRhID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRJbnN0LCBldmVudFR5cGUpOwogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNDb21wb3NpdGlvbkV2ZW50KGV2ZW50VHlwZSwgZG9tRXZlbnROYW1lLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGZhbGxiYWNrRGF0YSkgewogICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBmYWxsYmFja0RhdGE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGN1c3RvbURhdGEgPSBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICBpZiAoY3VzdG9tRGF0YSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGN1c3RvbURhdGE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5hdGl2ZUJlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIHZhciB3aGljaCA9IG5hdGl2ZUV2ZW50LndoaWNoOwogICAgICAgICAgICAgIGlmICh3aGljaCAhPT0gU1BBQ0VCQVJfQ09ERSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhhc1NwYWNlS2V5cHJlc3MgPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBTUEFDRUJBUl9DSEFSOwogICAgICAgICAgICBjYXNlICJ0ZXh0SW5wdXQiOgogICAgICAgICAgICAgIHZhciBjaGFycyA9IG5hdGl2ZUV2ZW50LmRhdGE7CiAgICAgICAgICAgICAgaWYgKGNoYXJzID09PSBTUEFDRUJBUl9DSEFSICYmIGhhc1NwYWNlS2V5cHJlc3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZhbGxiYWNrQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNvbXBvc2l0aW9uZW5kIiB8fCAhY2FuVXNlQ29tcG9zaXRpb25FdmVudCAmJiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBnZXREYXRhKCk7CiAgICAgICAgICAgICAgcmVzZXQoKTsKICAgICAgICAgICAgICBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgICAgICAgIHJldHVybiBjaGFyczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIGlmICghaXNLZXlwcmVzc0NvbW1hbmQobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuY2hhciAmJiBuYXRpdmVFdmVudC5jaGFyLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50LmNoYXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5hdGl2ZUV2ZW50LndoaWNoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKG5hdGl2ZUV2ZW50LndoaWNoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gdXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpID8gbnVsbCA6IG5hdGl2ZUV2ZW50LmRhdGE7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RCZWZvcmVJbnB1dEV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgY2hhcnM7CiAgICAgICAgICBpZiAoY2FuVXNlVGV4dElucHV0RXZlbnQpIHsKICAgICAgICAgICAgY2hhcnMgPSBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2hhcnMgPSBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRJbnN0LCAib25CZWZvcmVJbnB1dCIpOwogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNJbnB1dEV2ZW50KCJvbkJlZm9yZUlucHV0IiwgImJlZm9yZWlucHV0IiwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjaGFyczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICBleHRyYWN0Q29tcG9zaXRpb25FdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgfQogICAgICAgIHZhciBzdXBwb3J0ZWRJbnB1dFR5cGVzID0gewogICAgICAgICAgY29sb3I6IHRydWUsCiAgICAgICAgICBkYXRlOiB0cnVlLAogICAgICAgICAgZGF0ZXRpbWU6IHRydWUsCiAgICAgICAgICAiZGF0ZXRpbWUtbG9jYWwiOiB0cnVlLAogICAgICAgICAgZW1haWw6IHRydWUsCiAgICAgICAgICBtb250aDogdHJ1ZSwKICAgICAgICAgIG51bWJlcjogdHJ1ZSwKICAgICAgICAgIHBhc3N3b3JkOiB0cnVlLAogICAgICAgICAgcmFuZ2U6IHRydWUsCiAgICAgICAgICBzZWFyY2g6IHRydWUsCiAgICAgICAgICB0ZWw6IHRydWUsCiAgICAgICAgICB0ZXh0OiB0cnVlLAogICAgICAgICAgdGltZTogdHJ1ZSwKICAgICAgICAgIHVybDogdHJ1ZSwKICAgICAgICAgIHdlZWs6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGlzVGV4dElucHV0RWxlbWVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtICYmIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKG5vZGVOYW1lID09PSAiaW5wdXQiKSB7CiAgICAgICAgICAgIHJldHVybiAhIXN1cHBvcnRlZElucHV0VHlwZXNbZWxlbS50eXBlXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gInRleHRhcmVhIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNFdmVudFN1cHBvcnRlZChldmVudE5hbWVTdWZmaXgpIHsKICAgICAgICAgIGlmICghY2FuVXNlRE9NMikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnROYW1lID0gIm9uIiArIGV2ZW50TmFtZVN1ZmZpeDsKICAgICAgICAgIHZhciBpc1N1cHBvcnRlZCA9IGV2ZW50TmFtZSBpbiBkb2N1bWVudDsKICAgICAgICAgIGlmICghaXNTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoZXZlbnROYW1lLCAicmV0dXJuOyIpOwogICAgICAgICAgICBpc1N1cHBvcnRlZCA9IHR5cGVvZiBlbGVtZW50W2V2ZW50TmFtZV0gPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaXNTdXBwb3J0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDEoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ2hhbmdlIiwgWyJjaGFuZ2UiLCAiY2xpY2siLCAiZm9jdXNpbiIsICJmb2N1c291dCIsICJpbnB1dCIsICJrZXlkb3duIiwgImtleXVwIiwgInNlbGVjdGlvbmNoYW5nZSJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGluc3QsIG5hdGl2ZUV2ZW50LCB0YXJnZXQpIHsKICAgICAgICAgIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoaW5zdCwgIm9uQ2hhbmdlIik7CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvbkNoYW5nZSIsICJjaGFuZ2UiLCBudWxsLCBuYXRpdmVFdmVudCwgdGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICB2YXIgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFVzZUNoYW5nZUV2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lID09PSAic2VsZWN0IiB8fCBub2RlTmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJmaWxlIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoUXVldWUgPSBbXTsKICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBhY3RpdmVFbGVtZW50SW5zdCwgbmF0aXZlRXZlbnQsIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSk7CiAgICAgICAgICBiYXRjaGVkVXBkYXRlcyhydW5FdmVudEluQmF0Y2gsIGRpc3BhdGNoUXVldWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBydW5FdmVudEluQmF0Y2goZGlzcGF0Y2hRdWV1ZSkgewogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgMCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCk7CiAgICAgICAgICBpZiAodXBkYXRlVmFsdWVJZkNoYW5nZWQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gZmFsc2U7CiAgICAgICAgaWYgKGNhblVzZURPTTIpIHsKICAgICAgICAgIGlzSW5wdXRFdmVudFN1cHBvcnRlZCA9IGlzRXZlbnRTdXBwb3J0ZWQoImlucHV0IikgJiYgKCFkb2N1bWVudC5kb2N1bWVudE1vZGUgfHwgZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gOSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0V2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSh0YXJnZXQsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgPSB0YXJnZXQ7CiAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICBhY3RpdmVFbGVtZW50LmF0dGFjaEV2ZW50KCJvbnByb3BlcnR5Y2hhbmdlIiwgaGFuZGxlUHJvcGVydHlDaGFuZ2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdG9wV2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSgpIHsKICAgICAgICAgIGlmICghYWN0aXZlRWxlbWVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBhY3RpdmVFbGVtZW50LmRldGFjaEV2ZW50KCJvbnByb3BlcnR5Y2hhbmdlIiwgaGFuZGxlUHJvcGVydHlDaGFuZ2UpOwogICAgICAgICAgYWN0aXZlRWxlbWVudCA9IG51bGw7CiAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZVByb3BlcnR5Q2hhbmdlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQucHJvcGVydHlOYW1lICE9PSAidmFsdWUiKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChnZXRJbnN0SWZWYWx1ZUNoYW5nZWQoYWN0aXZlRWxlbWVudEluc3QpKSB7CiAgICAgICAgICAgIG1hbnVhbERpc3BhdGNoQ2hhbmdlRXZlbnQobmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVFdmVudHNGb3JJbnB1dEV2ZW50UG9seWZpbGwoZG9tRXZlbnROYW1lLCB0YXJnZXQsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c2luIikgewogICAgICAgICAgICBzdG9wV2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSgpOwogICAgICAgICAgICBzdGFydFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UodGFyZ2V0LCB0YXJnZXRJbnN0KTsKICAgICAgICAgIH0gZWxzZSBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNvdXQiKSB7CiAgICAgICAgICAgIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JJbnB1dEV2ZW50UG9seWZpbGwoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAic2VsZWN0aW9uY2hhbmdlIiB8fCBkb21FdmVudE5hbWUgPT09ICJrZXl1cCIgfHwgZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZChhY3RpdmVFbGVtZW50SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFVzZUNsaWNrRXZlbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiBub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmIChlbGVtLnR5cGUgPT09ICJjaGVja2JveCIgfHwgZWxlbS50eXBlID09PSAicmFkaW8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvckNsaWNrRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiY2xpY2siKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JJbnB1dE9yQ2hhbmdlRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiaW5wdXQiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImNoYW5nZSIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlQ29udHJvbGxlZElucHV0Qmx1cihub2RlKSB7CiAgICAgICAgICB2YXIgc3RhdGUgPSBub2RlLl93cmFwcGVyU3RhdGU7CiAgICAgICAgICBpZiAoIXN0YXRlIHx8ICFzdGF0ZS5jb250cm9sbGVkIHx8IG5vZGUudHlwZSAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgIm51bWJlciIsIG5vZGUudmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDEoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSB0YXJnZXRJbnN0ID8gZ2V0Tm9kZUZyb21JbnN0YW5jZSh0YXJnZXRJbnN0KSA6IHdpbmRvdzsKICAgICAgICAgIHZhciBnZXRUYXJnZXRJbnN0RnVuYywgaGFuZGxlRXZlbnRGdW5jOwogICAgICAgICAgaWYgKHNob3VsZFVzZUNoYW5nZUV2ZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvckNoYW5nZUV2ZW50OwogICAgICAgICAgfSBlbHNlIGlmIChpc1RleHRJbnB1dEVsZW1lbnQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgaWYgKGlzSW5wdXRFdmVudFN1cHBvcnRlZCkgewogICAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvcklucHV0T3JDaGFuZ2VFdmVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JJbnB1dEV2ZW50UG9seWZpbGw7CiAgICAgICAgICAgICAgaGFuZGxlRXZlbnRGdW5jID0gaGFuZGxlRXZlbnRzRm9ySW5wdXRFdmVudFBvbHlmaWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFVzZUNsaWNrRXZlbnQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9yQ2xpY2tFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChnZXRUYXJnZXRJbnN0RnVuYykgewogICAgICAgICAgICB2YXIgaW5zdCA9IGdldFRhcmdldEluc3RGdW5jKGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgICAgY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFuZGxlRXZlbnRGdW5jKSB7CiAgICAgICAgICAgIGhhbmRsZUV2ZW50RnVuYyhkb21FdmVudE5hbWUsIHRhcmdldE5vZGUsIHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3Vzb3V0IikgewogICAgICAgICAgICBoYW5kbGVDb250cm9sbGVkSW5wdXRCbHVyKHRhcmdldE5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cyQyKCkgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Nb3VzZUVudGVyIiwgWyJtb3VzZW91dCIsICJtb3VzZW92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvbk1vdXNlTGVhdmUiLCBbIm1vdXNlb3V0IiwgIm1vdXNlb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uUG9pbnRlckVudGVyIiwgWyJwb2ludGVyb3V0IiwgInBvaW50ZXJvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Qb2ludGVyTGVhdmUiLCBbInBvaW50ZXJvdXQiLCAicG9pbnRlcm92ZXIiXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkMihkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgaXNPdmVyRXZlbnQgPSBkb21FdmVudE5hbWUgPT09ICJtb3VzZW92ZXIiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdmVyIjsKICAgICAgICAgIHZhciBpc091dEV2ZW50ID0gZG9tRXZlbnROYW1lID09PSAibW91c2VvdXQiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdXQiOwogICAgICAgICAgaWYgKGlzT3ZlckV2ZW50ICYmICFpc1JlcGxheWluZ0V2ZW50KG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICB2YXIgcmVsYXRlZCA9IG5hdGl2ZUV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgbmF0aXZlRXZlbnQuZnJvbUVsZW1lbnQ7CiAgICAgICAgICAgIGlmIChyZWxhdGVkKSB7CiAgICAgICAgICAgICAgaWYgKGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKHJlbGF0ZWQpIHx8IGlzQ29udGFpbmVyTWFya2VkQXNSb290KHJlbGF0ZWQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzT3V0RXZlbnQgJiYgIWlzT3ZlckV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3aW47CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnRUYXJnZXQud2luZG93ID09PSBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgICB3aW4gPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkb2MgPSBuYXRpdmVFdmVudFRhcmdldC5vd25lckRvY3VtZW50OwogICAgICAgICAgICBpZiAoZG9jKSB7CiAgICAgICAgICAgICAgd2luID0gZG9jLmRlZmF1bHRWaWV3IHx8IGRvYy5wYXJlbnRXaW5kb3c7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd2luID0gd2luZG93OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnJvbTI7CiAgICAgICAgICB2YXIgdG8yOwogICAgICAgICAgaWYgKGlzT3V0RXZlbnQpIHsKICAgICAgICAgICAgdmFyIF9yZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC50b0VsZW1lbnQ7CiAgICAgICAgICAgIGZyb20yID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgdG8yID0gX3JlbGF0ZWQgPyBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShfcmVsYXRlZCkgOiBudWxsOwogICAgICAgICAgICBpZiAodG8yICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0bzIpOwogICAgICAgICAgICAgIGlmICh0bzIgIT09IG5lYXJlc3RNb3VudGVkIHx8IHRvMi50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgdG8yLnRhZyAhPT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgIHRvMiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcm9tMiA9IG51bGw7CiAgICAgICAgICAgIHRvMiA9IHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZnJvbTIgPT09IHRvMikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgIHZhciBsZWF2ZUV2ZW50VHlwZSA9ICJvbk1vdXNlTGVhdmUiOwogICAgICAgICAgdmFyIGVudGVyRXZlbnRUeXBlID0gIm9uTW91c2VFbnRlciI7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlUHJlZml4ID0gIm1vdXNlIjsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciIpIHsKICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljUG9pbnRlckV2ZW50OwogICAgICAgICAgICBsZWF2ZUV2ZW50VHlwZSA9ICJvblBvaW50ZXJMZWF2ZSI7CiAgICAgICAgICAgIGVudGVyRXZlbnRUeXBlID0gIm9uUG9pbnRlckVudGVyIjsKICAgICAgICAgICAgZXZlbnRUeXBlUHJlZml4ID0gInBvaW50ZXIiOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb21Ob2RlID0gZnJvbTIgPT0gbnVsbCA/IHdpbiA6IGdldE5vZGVGcm9tSW5zdGFuY2UoZnJvbTIpOwogICAgICAgICAgdmFyIHRvTm9kZSA9IHRvMiA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZSh0bzIpOwogICAgICAgICAgdmFyIGxlYXZlID0gbmV3IFN5bnRoZXRpY0V2ZW50Q3RvcihsZWF2ZUV2ZW50VHlwZSwgZXZlbnRUeXBlUHJlZml4ICsgImxlYXZlIiwgZnJvbTIsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBsZWF2ZS50YXJnZXQgPSBmcm9tTm9kZTsKICAgICAgICAgIGxlYXZlLnJlbGF0ZWRUYXJnZXQgPSB0b05vZGU7CiAgICAgICAgICB2YXIgZW50ZXIgPSBudWxsOwogICAgICAgICAgdmFyIG5hdGl2ZVRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBpZiAobmF0aXZlVGFyZ2V0SW5zdCA9PT0gdGFyZ2V0SW5zdCkgewogICAgICAgICAgICB2YXIgZW50ZXJFdmVudCA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IoZW50ZXJFdmVudFR5cGUsIGV2ZW50VHlwZVByZWZpeCArICJlbnRlciIsIHRvMiwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZW50ZXJFdmVudC50YXJnZXQgPSB0b05vZGU7CiAgICAgICAgICAgIGVudGVyRXZlbnQucmVsYXRlZFRhcmdldCA9IGZyb21Ob2RlOwogICAgICAgICAgICBlbnRlciA9IGVudGVyRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlLCBlbnRlciwgZnJvbTIsIHRvMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzNCh4MiwgeTIpIHsKICAgICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKHgyICE9PSAwIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICAgIH0KICAgICAgICB2YXIgb2JqZWN0SXMgPSB0eXBlb2YgT2JqZWN0LmlzID09PSAiZnVuY3Rpb24iID8gT2JqZWN0LmlzIDogaXM0OwogICAgICAgIGZ1bmN0aW9uIHNoYWxsb3dFcXVhbDIob2JqQSwgb2JqQikgewogICAgICAgICAgaWYgKG9iamVjdElzKG9iakEsIG9iakIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBvYmpBICE9PSAib2JqZWN0IiB8fCBvYmpBID09PSBudWxsIHx8IHR5cGVvZiBvYmpCICE9PSAib2JqZWN0IiB8fCBvYmpCID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBrZXlzQSA9IE9iamVjdC5rZXlzKG9iakEpOwogICAgICAgICAgdmFyIGtleXNCID0gT2JqZWN0LmtleXMob2JqQik7CiAgICAgICAgICBpZiAoa2V5c0EubGVuZ3RoICE9PSBrZXlzQi5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzQS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgY3VycmVudEtleSA9IGtleXNBW2ldOwogICAgICAgICAgICBpZiAoIWhhc093blByb3BlcnR5LmNhbGwob2JqQiwgY3VycmVudEtleSkgfHwgIW9iamVjdElzKG9iakFbY3VycmVudEtleV0sIG9iakJbY3VycmVudEtleV0pKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZk5vZGUobm9kZSkgewogICAgICAgICAgd2hpbGUgKG5vZGUgJiYgbm9kZS5maXJzdENoaWxkKSB7CiAgICAgICAgICAgIG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2libGluZ05vZGUobm9kZSkgewogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KHJvb3QzLCBvZmZzZXQpIHsKICAgICAgICAgIHZhciBub2RlID0gZ2V0TGVhZk5vZGUocm9vdDMpOwogICAgICAgICAgdmFyIG5vZGVTdGFydCA9IDA7CiAgICAgICAgICB2YXIgbm9kZUVuZCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgbm9kZUVuZCA9IG5vZGVTdGFydCArIG5vZGUudGV4dENvbnRlbnQubGVuZ3RoOwogICAgICAgICAgICAgIGlmIChub2RlU3RhcnQgPD0gb2Zmc2V0ICYmIG5vZGVFbmQgPj0gb2Zmc2V0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICBub2RlLAogICAgICAgICAgICAgICAgICBvZmZzZXQ6IG9mZnNldCAtIG5vZGVTdGFydAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZVN0YXJ0ID0gbm9kZUVuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gZ2V0TGVhZk5vZGUoZ2V0U2libGluZ05vZGUobm9kZSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRPZmZzZXRzKG91dGVyTm9kZSkgewogICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSBvdXRlck5vZGUub3duZXJEb2N1bWVudDsKICAgICAgICAgIHZhciB3aW4gPSBvd25lckRvY3VtZW50ICYmIG93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24gJiYgd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgaWYgKCFzZWxlY3Rpb24gfHwgc2VsZWN0aW9uLnJhbmdlQ291bnQgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYW5jaG9yTm9kZSA9IHNlbGVjdGlvbi5hbmNob3JOb2RlLCBhbmNob3JPZmZzZXQgPSBzZWxlY3Rpb24uYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUgPSBzZWxlY3Rpb24uZm9jdXNOb2RlLCBmb2N1c09mZnNldCA9IHNlbGVjdGlvbi5mb2N1c09mZnNldDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGFuY2hvck5vZGUubm9kZVR5cGU7CiAgICAgICAgICAgIGZvY3VzTm9kZS5ub2RlVHlwZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0TW9kZXJuT2Zmc2V0c0Zyb21Qb2ludHMob3V0ZXJOb2RlLCBhbmNob3JOb2RlLCBhbmNob3JPZmZzZXQsIGZvY3VzTm9kZSwgZm9jdXNPZmZzZXQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRNb2Rlcm5PZmZzZXRzRnJvbVBvaW50cyhvdXRlck5vZGUsIGFuY2hvck5vZGUsIGFuY2hvck9mZnNldCwgZm9jdXNOb2RlLCBmb2N1c09mZnNldCkgewogICAgICAgICAgdmFyIGxlbmd0aCA9IDA7CiAgICAgICAgICB2YXIgc3RhcnQgPSAtMTsKICAgICAgICAgIHZhciBlbmQgPSAtMTsKICAgICAgICAgIHZhciBpbmRleFdpdGhpbkFuY2hvciA9IDA7CiAgICAgICAgICB2YXIgaW5kZXhXaXRoaW5Gb2N1cyA9IDA7CiAgICAgICAgICB2YXIgbm9kZSA9IG91dGVyTm9kZTsKICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gbnVsbDsKICAgICAgICAgIG91dGVyOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB2YXIgbmV4dCA9IG51bGw7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGFuY2hvck5vZGUgJiYgKGFuY2hvck9mZnNldCA9PT0gMCB8fCBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpKSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IGxlbmd0aCArIGFuY2hvck9mZnNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZvY3VzTm9kZSAmJiAoZm9jdXNPZmZzZXQgPT09IDAgfHwgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSkgewogICAgICAgICAgICAgICAgZW5kID0gbGVuZ3RoICsgZm9jdXNPZmZzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICAgIGxlbmd0aCArPSBub2RlLm5vZGVWYWx1ZS5sZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgobmV4dCA9IG5vZGUuZmlyc3RDaGlsZCkgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnROb2RlID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlID09PSBvdXRlck5vZGUpIHsKICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocGFyZW50Tm9kZSA9PT0gYW5jaG9yTm9kZSAmJiArK2luZGV4V2l0aGluQW5jaG9yID09PSBhbmNob3JPZmZzZXQpIHsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocGFyZW50Tm9kZSA9PT0gZm9jdXNOb2RlICYmICsraW5kZXhXaXRoaW5Gb2N1cyA9PT0gZm9jdXNPZmZzZXQpIHsKICAgICAgICAgICAgICAgIGVuZCA9IGxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChuZXh0ID0gbm9kZS5uZXh0U2libGluZykgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gcGFyZW50Tm9kZTsKICAgICAgICAgICAgICBwYXJlbnROb2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0YXJ0ID09PSAtMSB8fCBlbmQgPT09IC0xKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgIGVuZAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0T2Zmc2V0cyhub2RlLCBvZmZzZXRzKSB7CiAgICAgICAgICB2YXIgZG9jID0gbm9kZS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwogICAgICAgICAgdmFyIHdpbiA9IGRvYyAmJiBkb2MuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgaWYgKCF3aW4uZ2V0U2VsZWN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gbm9kZS50ZXh0Q29udGVudC5sZW5ndGg7CiAgICAgICAgICB2YXIgc3RhcnQgPSBNYXRoLm1pbihvZmZzZXRzLnN0YXJ0LCBsZW5ndGgpOwogICAgICAgICAgdmFyIGVuZCA9IG9mZnNldHMuZW5kID09PSB2b2lkIDAgPyBzdGFydCA6IE1hdGgubWluKG9mZnNldHMuZW5kLCBsZW5ndGgpOwogICAgICAgICAgaWYgKCFzZWxlY3Rpb24uZXh0ZW5kICYmIHN0YXJ0ID4gZW5kKSB7CiAgICAgICAgICAgIHZhciB0ZW1wID0gZW5kOwogICAgICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICAgICAgc3RhcnQgPSB0ZW1wOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXJ0TWFya2VyID0gZ2V0Tm9kZUZvckNoYXJhY3Rlck9mZnNldChub2RlLCBzdGFydCk7CiAgICAgICAgICB2YXIgZW5kTWFya2VyID0gZ2V0Tm9kZUZvckNoYXJhY3Rlck9mZnNldChub2RlLCBlbmQpOwogICAgICAgICAgaWYgKHN0YXJ0TWFya2VyICYmIGVuZE1hcmtlcikgewogICAgICAgICAgICBpZiAoc2VsZWN0aW9uLnJhbmdlQ291bnQgPT09IDEgJiYgc2VsZWN0aW9uLmFuY2hvck5vZGUgPT09IHN0YXJ0TWFya2VyLm5vZGUgJiYgc2VsZWN0aW9uLmFuY2hvck9mZnNldCA9PT0gc3RhcnRNYXJrZXIub2Zmc2V0ICYmIHNlbGVjdGlvbi5mb2N1c05vZGUgPT09IGVuZE1hcmtlci5ub2RlICYmIHNlbGVjdGlvbi5mb2N1c09mZnNldCA9PT0gZW5kTWFya2VyLm9mZnNldCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmFuZ2U0ID0gZG9jLmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICAgIHJhbmdlNC5zZXRTdGFydChzdGFydE1hcmtlci5ub2RlLCBzdGFydE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICAgICAgICAgIGlmIChzdGFydCA+IGVuZCkgewogICAgICAgICAgICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZTQpOwogICAgICAgICAgICAgIHNlbGVjdGlvbi5leHRlbmQoZW5kTWFya2VyLm5vZGUsIGVuZE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJhbmdlNC5zZXRFbmQoZW5kTWFya2VyLm5vZGUsIGVuZE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZTQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb250YWluc05vZGUob3V0ZXJOb2RlLCBpbm5lck5vZGUpIHsKICAgICAgICAgIGlmICghb3V0ZXJOb2RlIHx8ICFpbm5lck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvdXRlck5vZGUgPT09IGlubmVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShvdXRlck5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShpbm5lck5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBjb250YWluc05vZGUob3V0ZXJOb2RlLCBpbm5lck5vZGUucGFyZW50Tm9kZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCJjb250YWlucyIgaW4gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBvdXRlck5vZGUuY29udGFpbnMoaW5uZXJOb2RlKTsKICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiAhIShvdXRlck5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24oaW5uZXJOb2RlKSAmIDE2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbkRvY3VtZW50KG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUub3duZXJEb2N1bWVudCAmJiBjb250YWluc05vZGUobm9kZS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgbm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2FtZU9yaWdpbkZyYW1lKGlmcmFtZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBpZnJhbWUuY29udGVudFdpbmRvdy5sb2NhdGlvbi5ocmVmID09PSAic3RyaW5nIjsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnREZWVwKCkgewogICAgICAgICAgdmFyIHdpbiA9IHdpbmRvdzsKICAgICAgICAgIHZhciBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCgpOwogICAgICAgICAgd2hpbGUgKGVsZW1lbnQgaW5zdGFuY2VvZiB3aW4uSFRNTElGcmFtZUVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGlzU2FtZU9yaWdpbkZyYW1lKGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgd2luID0gZWxlbWVudC5jb250ZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQgPSBnZXRBY3RpdmVFbGVtZW50KHdpbi5kb2N1bWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0gJiYgZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgKG5vZGVOYW1lID09PSAiaW5wdXQiICYmIChlbGVtLnR5cGUgPT09ICJ0ZXh0IiB8fCBlbGVtLnR5cGUgPT09ICJzZWFyY2giIHx8IGVsZW0udHlwZSA9PT0gInRlbCIgfHwgZWxlbS50eXBlID09PSAidXJsIiB8fCBlbGVtLnR5cGUgPT09ICJwYXNzd29yZCIpIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiIHx8IGVsZW0uY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb25JbmZvcm1hdGlvbigpIHsKICAgICAgICAgIHZhciBmb2N1c2VkRWxlbSA9IGdldEFjdGl2ZUVsZW1lbnREZWVwKCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBmb2N1c2VkRWxlbSwKICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2U6IGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhmb2N1c2VkRWxlbSkgPyBnZXRTZWxlY3Rpb24oZm9jdXNlZEVsZW0pIDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVNlbGVjdGlvbihwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uKSB7CiAgICAgICAgICB2YXIgY3VyRm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgdmFyIHByaW9yRm9jdXNlZEVsZW0gPSBwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uLmZvY3VzZWRFbGVtOwogICAgICAgICAgdmFyIHByaW9yU2VsZWN0aW9uUmFuZ2UgPSBwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uLnNlbGVjdGlvblJhbmdlOwogICAgICAgICAgaWYgKGN1ckZvY3VzZWRFbGVtICE9PSBwcmlvckZvY3VzZWRFbGVtICYmIGlzSW5Eb2N1bWVudChwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICBpZiAocHJpb3JTZWxlY3Rpb25SYW5nZSAhPT0gbnVsbCAmJiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMocHJpb3JGb2N1c2VkRWxlbSkpIHsKICAgICAgICAgICAgICBzZXRTZWxlY3Rpb24ocHJpb3JGb2N1c2VkRWxlbSwgcHJpb3JTZWxlY3Rpb25SYW5nZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2VzdG9ycyA9IFtdOwogICAgICAgICAgICB2YXIgYW5jZXN0b3IgPSBwcmlvckZvY3VzZWRFbGVtOwogICAgICAgICAgICB3aGlsZSAoYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgaWYgKGFuY2VzdG9yLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgZWxlbWVudDogYW5jZXN0b3IsCiAgICAgICAgICAgICAgICAgIGxlZnQ6IGFuY2VzdG9yLnNjcm9sbExlZnQsCiAgICAgICAgICAgICAgICAgIHRvcDogYW5jZXN0b3Iuc2Nyb2xsVG9wCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmlvckZvY3VzZWRFbGVtLmZvY3VzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJpb3JGb2N1c2VkRWxlbS5mb2N1cygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYW5jZXN0b3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSBhbmNlc3RvcnNbaV07CiAgICAgICAgICAgICAgaW5mby5lbGVtZW50LnNjcm9sbExlZnQgPSBpbmZvLmxlZnQ7CiAgICAgICAgICAgICAgaW5mby5lbGVtZW50LnNjcm9sbFRvcCA9IGluZm8udG9wOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbihpbnB1dCkgewogICAgICAgICAgdmFyIHNlbGVjdGlvbjsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIGlucHV0KSB7CiAgICAgICAgICAgIHNlbGVjdGlvbiA9IHsKICAgICAgICAgICAgICBzdGFydDogaW5wdXQuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBpbnB1dC5zZWxlY3Rpb25FbmQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGVjdGlvbiA9IGdldE9mZnNldHMoaW5wdXQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNlbGVjdGlvbiB8fCB7CiAgICAgICAgICAgIHN0YXJ0OiAwLAogICAgICAgICAgICBlbmQ6IDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFNlbGVjdGlvbihpbnB1dCwgb2Zmc2V0cykgewogICAgICAgICAgdmFyIHN0YXJ0ID0gb2Zmc2V0cy5zdGFydDsKICAgICAgICAgIHZhciBlbmQgPSBvZmZzZXRzLmVuZDsKICAgICAgICAgIGlmIChlbmQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIGlucHV0KSB7CiAgICAgICAgICAgIGlucHV0LnNlbGVjdGlvblN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgICAgIGlucHV0LnNlbGVjdGlvbkVuZCA9IE1hdGgubWluKGVuZCwgaW5wdXQudmFsdWUubGVuZ3RoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldE9mZnNldHMoaW5wdXQsIG9mZnNldHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgc2tpcFNlbGVjdGlvbkNoYW5nZUV2ZW50ID0gY2FuVXNlRE9NMiAmJiAiZG9jdW1lbnRNb2RlIiBpbiBkb2N1bWVudCAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGUgPD0gMTE7CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMygpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25TZWxlY3QiLCBbImZvY3Vzb3V0IiwgImNvbnRleHRtZW51IiwgImRyYWdlbmQiLCAiZm9jdXNpbiIsICJrZXlkb3duIiwgImtleXVwIiwgIm1vdXNlZG93biIsICJtb3VzZXVwIiwgInNlbGVjdGlvbmNoYW5nZSJdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQkMSA9IG51bGw7CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnRJbnN0JDEgPSBudWxsOwogICAgICAgIHZhciBsYXN0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICB2YXIgbW91c2VEb3duID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uJDEobm9kZSkgewogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gbm9kZSAmJiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMobm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBzdGFydDogbm9kZS5zZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICBlbmQ6IG5vZGUuc2VsZWN0aW9uRW5kCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgd2luID0gbm9kZS5vd25lckRvY3VtZW50ICYmIG5vZGUub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgYW5jaG9yTm9kZTogc2VsZWN0aW9uLmFuY2hvck5vZGUsCiAgICAgICAgICAgICAgYW5jaG9yT2Zmc2V0OiBzZWxlY3Rpb24uYW5jaG9yT2Zmc2V0LAogICAgICAgICAgICAgIGZvY3VzTm9kZTogc2VsZWN0aW9uLmZvY3VzTm9kZSwKICAgICAgICAgICAgICBmb2N1c09mZnNldDogc2VsZWN0aW9uLmZvY3VzT2Zmc2V0CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQoZXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHJldHVybiBldmVudFRhcmdldC53aW5kb3cgPT09IGV2ZW50VGFyZ2V0ID8gZXZlbnRUYXJnZXQuZG9jdW1lbnQgOiBldmVudFRhcmdldC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IGV2ZW50VGFyZ2V0IDogZXZlbnRUYXJnZXQub3duZXJEb2N1bWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZG9jID0gZ2V0RXZlbnRUYXJnZXREb2N1bWVudChuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBpZiAobW91c2VEb3duIHx8IGFjdGl2ZUVsZW1lbnQkMSA9PSBudWxsIHx8IGFjdGl2ZUVsZW1lbnQkMSAhPT0gZ2V0QWN0aXZlRWxlbWVudChkb2MpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50U2VsZWN0aW9uID0gZ2V0U2VsZWN0aW9uJDEoYWN0aXZlRWxlbWVudCQxKTsKICAgICAgICAgIGlmICghbGFzdFNlbGVjdGlvbiB8fCAhc2hhbGxvd0VxdWFsMihsYXN0U2VsZWN0aW9uLCBjdXJyZW50U2VsZWN0aW9uKSkgewogICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyhhY3RpdmVFbGVtZW50SW5zdCQxLCAib25TZWxlY3QiKTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvblNlbGVjdCIsICJzZWxlY3QiLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGFjdGl2ZUVsZW1lbnQkMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSB0YXJnZXRJbnN0ID8gZ2V0Tm9kZUZyb21JbnN0YW5jZSh0YXJnZXRJbnN0KSA6IHdpbmRvdzsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIGlmIChpc1RleHRJbnB1dEVsZW1lbnQodGFyZ2V0Tm9kZSkgfHwgdGFyZ2V0Tm9kZS5jb250ZW50RWRpdGFibGUgPT09ICJ0cnVlIikgewogICAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudCQxID0gdGFyZ2V0Tm9kZTsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0JDEgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudCQxID0gbnVsbDsKICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgICBtb3VzZURvd24gPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgICBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3Rpb25jaGFuZ2UiOgogICAgICAgICAgICAgIGlmIChza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYWtlUHJlZml4TWFwKHN0eWxlUHJvcCwgZXZlbnROYW1lKSB7CiAgICAgICAgICB2YXIgcHJlZml4ZXMzID0ge307CiAgICAgICAgICBwcmVmaXhlczNbc3R5bGVQcm9wLnRvTG93ZXJDYXNlKCldID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBwcmVmaXhlczNbIldlYmtpdCIgKyBzdHlsZVByb3BdID0gIndlYmtpdCIgKyBldmVudE5hbWU7CiAgICAgICAgICBwcmVmaXhlczNbIk1veiIgKyBzdHlsZVByb3BdID0gIm1veiIgKyBldmVudE5hbWU7CiAgICAgICAgICByZXR1cm4gcHJlZml4ZXMzOwogICAgICAgIH0KICAgICAgICB2YXIgdmVuZG9yUHJlZml4ZXMgPSB7CiAgICAgICAgICBhbmltYXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25FbmQiKSwKICAgICAgICAgIGFuaW1hdGlvbml0ZXJhdGlvbjogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvbkl0ZXJhdGlvbiIpLAogICAgICAgICAgYW5pbWF0aW9uc3RhcnQ6IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25TdGFydCIpLAogICAgICAgICAgdHJhbnNpdGlvbmVuZDogbWFrZVByZWZpeE1hcCgiVHJhbnNpdGlvbiIsICJUcmFuc2l0aW9uRW5kIikKICAgICAgICB9OwogICAgICAgIHZhciBwcmVmaXhlZEV2ZW50TmFtZXMgPSB7fTsKICAgICAgICB2YXIgc3R5bGUgPSB7fTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKS5zdHlsZTsKICAgICAgICAgIGlmICghKCJBbmltYXRpb25FdmVudCIgaW4gd2luZG93KSkgewogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uZW5kLmFuaW1hdGlvbjsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbml0ZXJhdGlvbi5hbmltYXRpb247CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25zdGFydC5hbmltYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoISgiVHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cpKSB7CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy50cmFuc2l0aW9uZW5kLnRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKGV2ZW50TmFtZSkgewogICAgICAgICAgaWYgKHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgIHJldHVybiBwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXTsKICAgICAgICAgIH0gZWxzZSBpZiAoIXZlbmRvclByZWZpeGVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmVmaXhNYXAgPSB2ZW5kb3JQcmVmaXhlc1tldmVudE5hbWVdOwogICAgICAgICAgZm9yICh2YXIgc3R5bGVQcm9wIGluIHByZWZpeE1hcCkgewogICAgICAgICAgICBpZiAocHJlZml4TWFwLmhhc093blByb3BlcnR5KHN0eWxlUHJvcCkgJiYgc3R5bGVQcm9wIGluIHN0eWxlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdID0gcHJlZml4TWFwW3N0eWxlUHJvcF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBldmVudE5hbWU7CiAgICAgICAgfQogICAgICAgIHZhciBBTklNQVRJT05fRU5EID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbmVuZCIpOwogICAgICAgIHZhciBBTklNQVRJT05fSVRFUkFUSU9OID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbml0ZXJhdGlvbiIpOwogICAgICAgIHZhciBBTklNQVRJT05fU1RBUlQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uc3RhcnQiKTsKICAgICAgICB2YXIgVFJBTlNJVElPTl9FTkQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgidHJhbnNpdGlvbmVuZCIpOwogICAgICAgIHZhciB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzID0gWyJhYm9ydCIsICJhdXhDbGljayIsICJjYW5jZWwiLCAiY2FuUGxheSIsICJjYW5QbGF5VGhyb3VnaCIsICJjbGljayIsICJjbG9zZSIsICJjb250ZXh0TWVudSIsICJjb3B5IiwgImN1dCIsICJkcmFnIiwgImRyYWdFbmQiLCAiZHJhZ0VudGVyIiwgImRyYWdFeGl0IiwgImRyYWdMZWF2ZSIsICJkcmFnT3ZlciIsICJkcmFnU3RhcnQiLCAiZHJvcCIsICJkdXJhdGlvbkNoYW5nZSIsICJlbXB0aWVkIiwgImVuY3J5cHRlZCIsICJlbmRlZCIsICJlcnJvciIsICJnb3RQb2ludGVyQ2FwdHVyZSIsICJpbnB1dCIsICJpbnZhbGlkIiwgImtleURvd24iLCAia2V5UHJlc3MiLCAia2V5VXAiLCAibG9hZCIsICJsb2FkZWREYXRhIiwgImxvYWRlZE1ldGFkYXRhIiwgImxvYWRTdGFydCIsICJsb3N0UG9pbnRlckNhcHR1cmUiLCAibW91c2VEb3duIiwgIm1vdXNlTW92ZSIsICJtb3VzZU91dCIsICJtb3VzZU92ZXIiLCAibW91c2VVcCIsICJwYXN0ZSIsICJwYXVzZSIsICJwbGF5IiwgInBsYXlpbmciLCAicG9pbnRlckNhbmNlbCIsICJwb2ludGVyRG93biIsICJwb2ludGVyTW92ZSIsICJwb2ludGVyT3V0IiwgInBvaW50ZXJPdmVyIiwgInBvaW50ZXJVcCIsICJwcm9ncmVzcyIsICJyYXRlQ2hhbmdlIiwgInJlc2V0IiwgInJlc2l6ZSIsICJzZWVrZWQiLCAic2Vla2luZyIsICJzdGFsbGVkIiwgInN1Ym1pdCIsICJzdXNwZW5kIiwgInRpbWVVcGRhdGUiLCAidG91Y2hDYW5jZWwiLCAidG91Y2hFbmQiLCAidG91Y2hTdGFydCIsICJ2b2x1bWVDaGFuZ2UiLCAic2Nyb2xsIiwgInRvZ2dsZSIsICJ0b3VjaE1vdmUiLCAid2FpdGluZyIsICJ3aGVlbCJdOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU2ltcGxlRXZlbnQoZG9tRXZlbnROYW1lLCByZWFjdE5hbWUpIHsKICAgICAgICAgIHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzLnNldChkb21FdmVudE5hbWUsIHJlYWN0TmFtZSk7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQocmVhY3ROYW1lLCBbZG9tRXZlbnROYW1lXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU2ltcGxlRXZlbnRzKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaW1wbGVFdmVudFBsdWdpbkV2ZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgZXZlbnROYW1lID0gc2ltcGxlRXZlbnRQbHVnaW5FdmVudHNbaV07CiAgICAgICAgICAgIHZhciBkb21FdmVudE5hbWUgPSBldmVudE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgdmFyIGNhcGl0YWxpemVkRXZlbnQgPSBldmVudE5hbWVbMF0udG9VcHBlckNhc2UoKSArIGV2ZW50TmFtZS5zbGljZSgxKTsKICAgICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChkb21FdmVudE5hbWUsICJvbiIgKyBjYXBpdGFsaXplZEV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX0VORCwgIm9uQW5pbWF0aW9uRW5kIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9JVEVSQVRJT04sICJvbkFuaW1hdGlvbkl0ZXJhdGlvbiIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fU1RBUlQsICJvbkFuaW1hdGlvblN0YXJ0Iik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KCJkYmxjbGljayIsICJvbkRvdWJsZUNsaWNrIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KCJmb2N1c2luIiwgIm9uRm9jdXMiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImZvY3Vzb3V0IiwgIm9uQmx1ciIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChUUkFOU0lUSU9OX0VORCwgIm9uVHJhbnNpdGlvbkVuZCIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIHJlYWN0TmFtZSA9IHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzLmdldChkb21FdmVudE5hbWUpOwogICAgICAgICAgaWYgKHJlYWN0TmFtZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNFdmVudDsKICAgICAgICAgIHZhciByZWFjdEV2ZW50VHlwZSA9IGRvbUV2ZW50TmFtZTsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCkgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljS2V5Ym9hcmRFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgICAgcmVhY3RFdmVudFR5cGUgPSAiZm9jdXMiOwogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICByZWFjdEV2ZW50VHlwZSA9ICJibHVyIjsKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNGb2N1c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJiZWZvcmVibHVyIjoKICAgICAgICAgICAgY2FzZSAiYWZ0ZXJibHVyIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNGb2N1c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjbGljayI6CiAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmJ1dHRvbiA9PT0gMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiYXV4Y2xpY2siOgogICAgICAgICAgICBjYXNlICJkYmxjbGljayI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNNb3VzZUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkcmFnIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdleGl0IjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2xlYXZlIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ292ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnc3RhcnQiOgogICAgICAgICAgICBjYXNlICJkcm9wIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNEcmFnRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRvdWNoY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hlbmQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaG1vdmUiOgogICAgICAgICAgICBjYXNlICJ0b3VjaHN0YXJ0IjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNUb3VjaEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9FTkQ6CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX0lURVJBVElPTjoKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fU1RBUlQ6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljQW5pbWF0aW9uRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVFJBTlNJVElPTl9FTkQ6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVHJhbnNpdGlvbkV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzY3JvbGwiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1VJRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIndoZWVsIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNXaGVlbEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjb3B5IjoKICAgICAgICAgICAgY2FzZSAiY3V0IjoKICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0NsaXBib2FyZEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgImxvc3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZG93biI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJtb3ZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcnVwIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNQb2ludGVyRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWNjdW11bGF0ZVRhcmdldE9ubHkgPSAhaW5DYXB0dXJlUGhhc2UgJiYgLy8gVE9ETzogaWRlYWxseSwgd2UnZCBldmVudHVhbGx5IGFkZCBhbGwgZXZlbnRzIGZyb20KICAgICAgICAgICAgLy8gbm9uRGVsZWdhdGVkRXZlbnRzIGxpc3QgaW4gRE9NUGx1Z2luRXZlbnRTeXN0ZW0uCiAgICAgICAgICAgIC8vIFRoZW4gd2UgY2FuIHJlbW92ZSB0aGlzIHNwZWNpYWwgbGlzdC4KICAgICAgICAgICAgLy8gVGhpcyBpcyBhIGJyZWFraW5nIGNoYW5nZSB0aGF0IGNhbiB3YWl0IHVudGlsIFJlYWN0IDE4LgogICAgICAgICAgICBkb21FdmVudE5hbWUgPT09ICJzY3JvbGwiOwogICAgICAgICAgICB2YXIgX2xpc3RlbmVycyA9IGFjY3VtdWxhdGVTaW5nbGVQaGFzZUxpc3RlbmVycyh0YXJnZXRJbnN0LCByZWFjdE5hbWUsIG5hdGl2ZUV2ZW50LnR5cGUsIGluQ2FwdHVyZVBoYXNlLCBhY2N1bXVsYXRlVGFyZ2V0T25seSk7CiAgICAgICAgICAgIGlmIChfbGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB2YXIgX2V2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50Q3RvcihyZWFjdE5hbWUsIHJlYWN0RXZlbnRUeXBlLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudDogX2V2ZW50LAogICAgICAgICAgICAgICAgbGlzdGVuZXJzOiBfbGlzdGVuZXJzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudHMoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQyKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMSgpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDMoKTsKICAgICAgICByZWdpc3RlckV2ZW50cygpOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkNShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgdmFyIHNob3VsZFByb2Nlc3NQb2x5ZmlsbFBsdWdpbnMgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIFNIT1VMRF9OT1RfUFJPQ0VTU19QT0xZRklMTF9FVkVOVF9QTFVHSU5TKSA9PT0gMDsKICAgICAgICAgIGlmIChzaG91bGRQcm9jZXNzUG9seWZpbGxQbHVnaW5zKSB7CiAgICAgICAgICAgIGV4dHJhY3RFdmVudHMkMihkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGV4dHJhY3RFdmVudHMkMShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGV4dHJhY3RFdmVudHMkMyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgbWVkaWFFdmVudFR5cGVzID0gWyJhYm9ydCIsICJjYW5wbGF5IiwgImNhbnBsYXl0aHJvdWdoIiwgImR1cmF0aW9uY2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImxvYWRlZGRhdGEiLCAibG9hZGVkbWV0YWRhdGEiLCAibG9hZHN0YXJ0IiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwcm9ncmVzcyIsICJyYXRlY2hhbmdlIiwgInJlc2l6ZSIsICJzZWVrZWQiLCAic2Vla2luZyIsICJzdGFsbGVkIiwgInN1c3BlbmQiLCAidGltZXVwZGF0ZSIsICJ2b2x1bWVjaGFuZ2UiLCAid2FpdGluZyJdOwogICAgICAgIHZhciBub25EZWxlZ2F0ZWRFdmVudHMgPSBuZXcgU2V0KFsiY2FuY2VsIiwgImNsb3NlIiwgImludmFsaWQiLCAibG9hZCIsICJzY3JvbGwiLCAidG9nZ2xlIl0uY29uY2F0KG1lZGlhRXZlbnRUeXBlcykpOwogICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgbGlzdGVuZXIyLCBjdXJyZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgdHlwZSA9IGV2ZW50LnR5cGUgfHwgInVua25vd24tZXZlbnQiOwogICAgICAgICAgZXZlbnQuY3VycmVudFRhcmdldCA9IGN1cnJlbnRUYXJnZXQ7CiAgICAgICAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2tBbmRDYXRjaEZpcnN0RXJyb3IodHlwZSwgbGlzdGVuZXIyLCB2b2lkIDAsIGV2ZW50KTsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZUl0ZW1zSW5PcmRlcihldmVudCwgZGlzcGF0Y2hMaXN0ZW5lcnMsIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNJbnN0YW5jZTsKICAgICAgICAgIGlmIChpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICB2YXIgX2Rpc3BhdGNoTGlzdGVuZXJzJGkgPSBkaXNwYXRjaExpc3RlbmVyc1tpXSwgaW5zdGFuY2UgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5pbnN0YW5jZSwgY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmN1cnJlbnRUYXJnZXQsIGxpc3RlbmVyMiA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmxpc3RlbmVyOwogICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgbGlzdGVuZXIyLCBjdXJyZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBwcmV2aW91c0luc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBkaXNwYXRjaExpc3RlbmVycy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgICB2YXIgX2Rpc3BhdGNoTGlzdGVuZXJzJF9pID0gZGlzcGF0Y2hMaXN0ZW5lcnNbX2ldLCBfaW5zdGFuY2UgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kuaW5zdGFuY2UsIF9jdXJyZW50VGFyZ2V0ID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmN1cnJlbnRUYXJnZXQsIF9saXN0ZW5lciA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5saXN0ZW5lcjsKICAgICAgICAgICAgICBpZiAoX2luc3RhbmNlICE9PSBwcmV2aW91c0luc3RhbmNlICYmIGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBfbGlzdGVuZXIsIF9jdXJyZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBwcmV2aW91c0luc3RhbmNlID0gX2luc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NEaXNwYXRjaFF1ZXVlKGRpc3BhdGNoUXVldWUsIGV2ZW50U3lzdGVtRmxhZ3MpIHsKICAgICAgICAgIHZhciBpbkNhcHR1cmVQaGFzZSA9IChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSkgIT09IDA7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpc3BhdGNoUXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIF9kaXNwYXRjaFF1ZXVlJGkgPSBkaXNwYXRjaFF1ZXVlW2ldLCBldmVudCA9IF9kaXNwYXRjaFF1ZXVlJGkuZXZlbnQsIGxpc3RlbmVycyA9IF9kaXNwYXRjaFF1ZXVlJGkubGlzdGVuZXJzOwogICAgICAgICAgICBwcm9jZXNzRGlzcGF0Y2hRdWV1ZUl0ZW1zSW5PcmRlcihldmVudCwgbGlzdGVuZXJzLCBpbkNhcHR1cmVQaGFzZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXRocm93Q2F1Z2h0RXJyb3IoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudHNGb3JQbHVnaW5zKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHRhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50VGFyZ2V0ID0gZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpOwogICAgICAgICAgdmFyIGRpc3BhdGNoUXVldWUgPSBbXTsKICAgICAgICAgIGV4dHJhY3RFdmVudHMkNShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3QgYSBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCkgY2FsbCBmb3IgIiVzIi4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuJywgZG9tRXZlbnROYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciBsaXN0ZW5lclNldCA9IGdldEV2ZW50TGlzdGVuZXJTZXQodGFyZ2V0RWxlbWVudCk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJTZXRLZXkgPSBnZXRMaXN0ZW5lclNldEtleShkb21FdmVudE5hbWUsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgaWYgKCFsaXN0ZW5lclNldC5oYXMobGlzdGVuZXJTZXRLZXkpKSB7CiAgICAgICAgICAgIGFkZFRyYXBwZWRFdmVudExpc3RlbmVyKHRhcmdldEVsZW1lbnQsIGRvbUV2ZW50TmFtZSwgSVNfTk9OX0RFTEVHQVRFRCwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgICAgIGxpc3RlbmVyU2V0LmFkZChsaXN0ZW5lclNldEtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyLCB0YXJnZXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSAmJiAhaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBhIGxpc3RlblRvTmF0aXZlRXZlbnQoKSBjYWxsIGZvciAiJXMiIGluIHRoZSBidWJibGUgcGhhc2UuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFN5c3RlbUZsYWdzID0gMDsKICAgICAgICAgIGlmIChpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKSB7CiAgICAgICAgICAgIGV2ZW50U3lzdGVtRmxhZ3MgfD0gSVNfQ0FQVFVSRV9QSEFTRTsKICAgICAgICAgIH0KICAgICAgICAgIGFkZFRyYXBwZWRFdmVudExpc3RlbmVyKHRhcmdldCwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIGxpc3RlbmluZ01hcmtlciA9ICJfcmVhY3RMaXN0ZW5pbmciICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgZnVuY3Rpb24gbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIGlmICghcm9vdENvbnRhaW5lckVsZW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICByb290Q29udGFpbmVyRWxlbWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgYWxsTmF0aXZlRXZlbnRzLmZvckVhY2goZnVuY3Rpb24oZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSAhPT0gInNlbGVjdGlvbmNoYW5nZSIpIHsKICAgICAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCBmYWxzZSwgcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIHRydWUsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IHJvb3RDb250YWluZXJFbGVtZW50Lm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckVsZW1lbnQgOiByb290Q29udGFpbmVyRWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICAgICAgICBpZiAob3duZXJEb2N1bWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICghb3duZXJEb2N1bWVudFtsaXN0ZW5pbmdNYXJrZXJdKSB7CiAgICAgICAgICAgICAgICBvd25lckRvY3VtZW50W2xpc3RlbmluZ01hcmtlcl0gPSB0cnVlOwogICAgICAgICAgICAgICAgbGlzdGVuVG9OYXRpdmVFdmVudCgic2VsZWN0aW9uY2hhbmdlIiwgZmFsc2UsIG93bmVyRG9jdW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgaXNEZWZlcnJlZExpc3RlbmVyRm9yTGVnYWN5RkJTdXBwb3J0KSB7CiAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gY3JlYXRlRXZlbnRMaXN0ZW5lcldyYXBwZXJXaXRoUHJpb3JpdHkodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgdmFyIGlzUGFzc2l2ZUxpc3RlbmVyID0gdm9pZCAwOwogICAgICAgICAgaWYgKHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJ0b3VjaHN0YXJ0IiB8fCBkb21FdmVudE5hbWUgPT09ICJ0b3VjaG1vdmUiIHx8IGRvbUV2ZW50TmFtZSA9PT0gIndoZWVsIikgewogICAgICAgICAgICAgIGlzUGFzc2l2ZUxpc3RlbmVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgdmFyIHVuc3Vic2NyaWJlTGlzdGVuZXI7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBpZiAoaXNQYXNzaXZlTGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyLCBpc1Bhc3NpdmVMaXN0ZW5lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNQYXNzaXZlTGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lcjIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc01hdGNoaW5nUm9vdENvbnRhaW5lcihncmFuZENvbnRhaW5lciwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICByZXR1cm4gZ3JhbmRDb250YWluZXIgPT09IHRhcmdldENvbnRhaW5lciB8fCBncmFuZENvbnRhaW5lci5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFICYmIGdyYW5kQ29udGFpbmVyLnBhcmVudE5vZGUgPT09IHRhcmdldENvbnRhaW5lcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHRhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIGFuY2VzdG9ySW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICBpZiAoKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19FVkVOVF9IQU5ETEVfTk9OX01BTkFHRURfTk9ERSkgPT09IDAgJiYgKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19OT05fREVMRUdBVEVEKSA9PT0gMCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVyTm9kZSA9IHRhcmdldENvbnRhaW5lcjsKICAgICAgICAgICAgaWYgKHRhcmdldEluc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgICAgbWFpbkxvb3A6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbm9kZVRhZyA9IG5vZGUudGFnOwogICAgICAgICAgICAgICAgaWYgKG5vZGVUYWcgPT09IEhvc3RSb290IHx8IG5vZGVUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSBub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoY29udGFpbmVyMiwgdGFyZ2V0Q29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobm9kZVRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBncmFuZE5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZ3JhbmROb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmRUYWcgPSBncmFuZE5vZGUudGFnOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGdyYW5kVGFnID09PSBIb3N0Um9vdCB8fCBncmFuZFRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmRDb250YWluZXIgPSBncmFuZE5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm9vdENvbnRhaW5lcihncmFuZENvbnRhaW5lciwgdGFyZ2V0Q29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGdyYW5kTm9kZSA9IGdyYW5kTm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHdoaWxlIChjb250YWluZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShjb250YWluZXIyKTsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50VGFnID0gcGFyZW50Tm9kZS50YWc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBwYXJlbnRUYWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICBub2RlID0gYW5jZXN0b3JJbnN0ID0gcGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIG1haW5Mb29wOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb250YWluZXIyID0gY29udGFpbmVyMi5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBiYXRjaGVkVXBkYXRlcyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCBhbmNlc3Rvckluc3QpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICAgIGxpc3RlbmVyOiBsaXN0ZW5lcjIsCiAgICAgICAgICAgIGN1cnJlbnRUYXJnZXQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVTaW5nbGVQaGFzZUxpc3RlbmVycyh0YXJnZXRGaWJlciwgcmVhY3ROYW1lLCBuYXRpdmVFdmVudFR5cGUsIGluQ2FwdHVyZVBoYXNlLCBhY2N1bXVsYXRlVGFyZ2V0T25seSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBjYXB0dXJlTmFtZSA9IHJlYWN0TmFtZSAhPT0gbnVsbCA/IHJlYWN0TmFtZSArICJDYXB0dXJlIiA6IG51bGw7CiAgICAgICAgICB2YXIgcmVhY3RFdmVudE5hbWUgPSBpbkNhcHR1cmVQaGFzZSA/IGNhcHR1cmVOYW1lIDogcmVhY3ROYW1lOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0RmliZXI7CiAgICAgICAgICB2YXIgbGFzdEhvc3RDb21wb25lbnQgPSBudWxsOwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBfaW5zdGFuY2UyID0gaW5zdGFuY2UsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTIuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2UyLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBsYXN0SG9zdENvbXBvbmVudCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAocmVhY3RFdmVudE5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBsaXN0ZW5lcjIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVhY3RFdmVudE5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyMiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGxpc3RlbmVyMiwgbGFzdEhvc3RDb21wb25lbnQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFjY3VtdWxhdGVUYXJnZXRPbmx5KSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0RmliZXIsIHJlYWN0TmFtZSkgewogICAgICAgICAgdmFyIGNhcHR1cmVOYW1lID0gcmVhY3ROYW1lICsgIkNhcHR1cmUiOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0RmliZXI7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTMgPSBpbnN0YW5jZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlMy5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTMudGFnOwogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50VGFyZ2V0ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIHZhciBjYXB0dXJlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgY2FwdHVyZU5hbWUpOwogICAgICAgICAgICAgIGlmIChjYXB0dXJlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnVuc2hpZnQoY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgY2FwdHVyZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBidWJibGVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWFjdE5hbWUpOwogICAgICAgICAgICAgIGlmIChidWJibGVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBidWJibGVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFBhcmVudChpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgaW5zdCA9IGluc3QucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAoaW5zdCAmJiBpbnN0LnRhZyAhPT0gSG9zdENvbXBvbmVudCk7CiAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICByZXR1cm4gaW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMb3dlc3RDb21tb25BbmNlc3RvcihpbnN0QSwgaW5zdEIpIHsKICAgICAgICAgIHZhciBub2RlQSA9IGluc3RBOwogICAgICAgICAgdmFyIG5vZGVCID0gaW5zdEI7CiAgICAgICAgICB2YXIgZGVwdGhBID0gMDsKICAgICAgICAgIGZvciAodmFyIHRlbXBBID0gbm9kZUE7IHRlbXBBOyB0ZW1wQSA9IGdldFBhcmVudCh0ZW1wQSkpIHsKICAgICAgICAgICAgZGVwdGhBKys7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVwdGhCID0gMDsKICAgICAgICAgIGZvciAodmFyIHRlbXBCID0gbm9kZUI7IHRlbXBCOyB0ZW1wQiA9IGdldFBhcmVudCh0ZW1wQikpIHsKICAgICAgICAgICAgZGVwdGhCKys7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZGVwdGhBIC0gZGVwdGhCID4gMCkgewogICAgICAgICAgICBub2RlQSA9IGdldFBhcmVudChub2RlQSk7CiAgICAgICAgICAgIGRlcHRoQS0tOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGRlcHRoQiAtIGRlcHRoQSA+IDApIHsKICAgICAgICAgICAgbm9kZUIgPSBnZXRQYXJlbnQobm9kZUIpOwogICAgICAgICAgICBkZXB0aEItLTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZXB0aCA9IGRlcHRoQTsKICAgICAgICAgIHdoaWxlIChkZXB0aC0tKSB7CiAgICAgICAgICAgIGlmIChub2RlQSA9PT0gbm9kZUIgfHwgbm9kZUIgIT09IG51bGwgJiYgbm9kZUEgPT09IG5vZGVCLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIHJldHVybiBub2RlQTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlQSA9IGdldFBhcmVudChub2RlQSk7CiAgICAgICAgICAgIG5vZGVCID0gZ2V0UGFyZW50KG5vZGVCKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGV2ZW50LCB0YXJnZXQsIGNvbW1vbiwgaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lID0gZXZlbnQuX3JlYWN0TmFtZTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldDsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaW5zdGFuY2UgPT09IGNvbW1vbikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfaW5zdGFuY2U0ID0gaW5zdGFuY2UsIGFsdGVybmF0ZSA9IF9pbnN0YW5jZTQuYWx0ZXJuYXRlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2U0LnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlNC50YWc7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlID09PSBjb21tb24pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50VGFyZ2V0ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICAgICAgdmFyIGNhcHR1cmVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIGlmIChjYXB0dXJlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICAgICAgdmFyIGJ1YmJsZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGJ1YmJsZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgYnViYmxlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZUVudGVyTGVhdmVUd29QaGFzZUxpc3RlbmVycyhkaXNwYXRjaFF1ZXVlLCBsZWF2ZUV2ZW50LCBlbnRlckV2ZW50LCBmcm9tMiwgdG8yKSB7CiAgICAgICAgICB2YXIgY29tbW9uID0gZnJvbTIgJiYgdG8yID8gZ2V0TG93ZXN0Q29tbW9uQW5jZXN0b3IoZnJvbTIsIHRvMikgOiBudWxsOwogICAgICAgICAgaWYgKGZyb20yICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFjY3VtdWxhdGVFbnRlckxlYXZlTGlzdGVuZXJzRm9yRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbGVhdmVFdmVudCwgZnJvbTIsIGNvbW1vbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRvMiAhPT0gbnVsbCAmJiBlbnRlckV2ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFjY3VtdWxhdGVFbnRlckxlYXZlTGlzdGVuZXJzRm9yRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZW50ZXJFdmVudCwgdG8yLCBjb21tb24sIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMaXN0ZW5lclNldEtleShkb21FdmVudE5hbWUsIGNhcHR1cmUpIHsKICAgICAgICAgIHJldHVybiBkb21FdmVudE5hbWUgKyAiX18iICsgKGNhcHR1cmUgPyAiY2FwdHVyZSIgOiAiYnViYmxlIik7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IGZhbHNlOwogICAgICAgIHZhciBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCA9ICJkYW5nZXJvdXNseVNldElubmVySFRNTCI7CiAgICAgICAgdmFyIFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyA9ICJzdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmciOwogICAgICAgIHZhciBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyA9ICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciOwogICAgICAgIHZhciBBVVRPRk9DVVMgPSAiYXV0b0ZvY3VzIjsKICAgICAgICB2YXIgQ0hJTERSRU4gPSAiY2hpbGRyZW4iOwogICAgICAgIHZhciBTVFlMRSA9ICJzdHlsZSI7CiAgICAgICAgdmFyIEhUTUwkMSA9ICJfX2h0bWwiOwogICAgICAgIHZhciB3YXJuZWRVbmtub3duVGFnczsKICAgICAgICB2YXIgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudDsKICAgICAgICB2YXIgd2FybkZvclByb3BEaWZmZXJlbmNlOwogICAgICAgIHZhciB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzOwogICAgICAgIHZhciB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXI7CiAgICAgICAgdmFyIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmc7CiAgICAgICAgdmFyIG5vcm1hbGl6ZUhUTUw7CiAgICAgICAgewogICAgICAgICAgd2FybmVkVW5rbm93blRhZ3MgPSB7CiAgICAgICAgICAgIC8vIFRoZXJlIGFyZSB3b3JraW5nIHBvbHlmaWxscyBmb3IgPGRpYWxvZz4uIExldCBwZW9wbGUgdXNlIGl0LgogICAgICAgICAgICBkaWFsb2c6IHRydWUsCiAgICAgICAgICAgIC8vIEVsZWN0cm9uIHNoaXBzIGEgY3VzdG9tIDx3ZWJ2aWV3PiB0YWcgdG8gZGlzcGxheSBleHRlcm5hbCB3ZWIgY29udGVudCBpbgogICAgICAgICAgICAvLyBhbiBpc29sYXRlZCBmcmFtZSBhbmQgcHJvY2Vzcy4KICAgICAgICAgICAgLy8gVGhpcyB0YWcgaXMgbm90IHByZXNlbnQgaW4gbm9uIEVsZWN0cm9uIGVudmlyb25tZW50cyBzdWNoIGFzIEpTRG9tIHdoaWNoCiAgICAgICAgICAgIC8vIGlzIG9mdGVuIHVzZWQgZm9yIHRlc3RpbmcgcHVycG9zZXMuCiAgICAgICAgICAgIC8vIEBzZWUgaHR0cHM6Ly9lbGVjdHJvbmpzLm9yZy9kb2NzL2FwaS93ZWJ2aWV3LXRhZwogICAgICAgICAgICB3ZWJ2aWV3OiB0cnVlCiAgICAgICAgICB9OwogICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyQxKHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzJDIodHlwZSwgcHJvcHMsIHsKICAgICAgICAgICAgICByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLAogICAgICAgICAgICAgIHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgY2FuRGlmZlN0eWxlRm9ySHlkcmF0aW9uV2FybmluZyA9IGNhblVzZURPTTIgJiYgIWRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZSA9IGZ1bmN0aW9uKHByb3BOYW1lLCBzZXJ2ZXJWYWx1ZSwgY2xpZW50VmFsdWUpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkQ2xpZW50VmFsdWUgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VmFsdWUpOwogICAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKHNlcnZlclZhbHVlKTsKICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9PT0gbm9ybWFsaXplZENsaWVudFZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIlByb3AgYCVzYCBkaWQgbm90IG1hdGNoLiBTZXJ2ZXI6ICVzIENsaWVudDogJXMiLCBwcm9wTmFtZSwgSlNPTi5zdHJpbmdpZnkobm9ybWFsaXplZFNlcnZlclZhbHVlKSwgSlNPTi5zdHJpbmdpZnkobm9ybWFsaXplZENsaWVudFZhbHVlKSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckV4dHJhQXR0cmlidXRlcyA9IGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWVzKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICBuYW1lcy5wdXNoKG5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZXJyb3IoIkV4dHJhIGF0dHJpYnV0ZXMgZnJvbSB0aGUgc2VydmVyOiAlcyIsIG5hbWVzKTsKICAgICAgICAgIH07CiAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihyZWdpc3RyYXRpb25OYW1lLCBsaXN0ZW5lcjIpIHsKICAgICAgICAgICAgaWYgKGxpc3RlbmVyMiA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgYCVzYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBgZmFsc2VgLlxuXG5JZiB5b3UgdXNlZCB0byBjb25kaXRpb25hbGx5IG9taXQgaXQgd2l0aCAlcz17Y29uZGl0aW9uICYmIHZhbHVlfSwgcGFzcyAlcz17Y29uZGl0aW9uID8gdmFsdWUgOiB1bmRlZmluZWR9IGluc3RlYWQuIiwgcmVnaXN0cmF0aW9uTmFtZSwgcmVnaXN0cmF0aW9uTmFtZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYSB2YWx1ZSBvZiBgJXNgIHR5cGUuIiwgcmVnaXN0cmF0aW9uTmFtZSwgdHlwZW9mIGxpc3RlbmVyMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBub3JtYWxpemVIVE1MID0gZnVuY3Rpb24ocGFyZW50LCBodG1sKSB7CiAgICAgICAgICAgIHZhciB0ZXN0RWxlbWVudCA9IHBhcmVudC5uYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFID8gcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChwYXJlbnQudGFnTmFtZSkgOiBwYXJlbnQub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50TlMocGFyZW50Lm5hbWVzcGFjZVVSSSwgcGFyZW50LnRhZ05hbWUpOwogICAgICAgICAgICB0ZXN0RWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICAgICByZXR1cm4gdGVzdEVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIE5PUk1BTElaRV9ORVdMSU5FU19SRUdFWCA9IC9cclxuPy9nOwogICAgICAgIHZhciBOT1JNQUxJWkVfTlVMTF9BTkRfUkVQTEFDRU1FTlRfUkVHRVggPSAvXHUwMDAwfFx1RkZGRC9nOwogICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShtYXJrdXApIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tIdG1sU3RyaW5nQ29lcmNpb24obWFya3VwKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXJrdXBTdHJpbmcgPSB0eXBlb2YgbWFya3VwID09PSAic3RyaW5nIiA/IG1hcmt1cCA6ICIiICsgbWFya3VwOwogICAgICAgICAgcmV0dXJuIG1hcmt1cFN0cmluZy5yZXBsYWNlKE5PUk1BTElaRV9ORVdMSU5FU19SRUdFWCwgIlxuIikucmVwbGFjZShOT1JNQUxJWkVfTlVMTF9BTkRfUkVQTEFDRU1FTlRfUkVHRVgsICIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHNlcnZlclRleHQsIGNsaWVudFRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHZhciBub3JtYWxpemVkQ2xpZW50VGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShjbGllbnRUZXh0KTsKICAgICAgICAgIHZhciBub3JtYWxpemVkU2VydmVyVGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJUZXh0KTsKICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVGV4dCA9PT0gbm9ybWFsaXplZENsaWVudFRleHQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCdUZXh0IGNvbnRlbnQgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAiJXMiIENsaWVudDogIiVzIicsIG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0LCBub3JtYWxpemVkQ2xpZW50VGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSAmJiBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGV4dCBjb250ZW50IGRvZXMgbm90IG1hdGNoIHNlcnZlci1yZW5kZXJlZCBIVE1MLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcDQoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KG5vZGUpIHsKICAgICAgICAgIG5vZGUub25jbGljayA9IG5vb3A0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJbml0aWFsRE9NUHJvcGVydGllcyh0YWcsIGRvbUVsZW1lbnQsIHJvb3RDb250YWluZXJFbGVtZW50LCBuZXh0UHJvcHMsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBmb3IgKHZhciBwcm9wS2V5IGluIG5leHRQcm9wcykgewogICAgICAgICAgICBpZiAoIW5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IG5leHRQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUobmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXRWYWx1ZUZvclN0eWxlcyhkb21FbGVtZW50LCBuZXh0UHJvcCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNldElubmVySFRNTChkb21FbGVtZW50LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBjYW5TZXRUZXh0Q29udGVudCA9IHRhZyAhPT0gInRleHRhcmVhIiB8fCBuZXh0UHJvcCAhPT0gIiI7CiAgICAgICAgICAgICAgICBpZiAoY2FuU2V0VGV4dENvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgIiIgKyBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORykgOwogICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBBVVRPRk9DVVMpIDsKICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gIm9uU2Nyb2xsIikgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3AsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVET01Qcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHdhc0N1c3RvbUNvbXBvbmVudFRhZywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdXBkYXRlUGF5bG9hZC5sZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICB2YXIgcHJvcEtleSA9IHVwZGF0ZVBheWxvYWRbaV07CiAgICAgICAgICAgIHZhciBwcm9wVmFsdWUgPSB1cGRhdGVQYXlsb2FkW2kgKyAxXTsKICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JTdHlsZXMoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgIHNldElubmVySFRNTChkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIHByb3BWYWx1ZSwgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQ0MCh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQsIHBhcmVudE5hbWVzcGFjZSkgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgdmFyIGRvbUVsZW1lbnQ7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlVVJJID0gcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgbmFtZXNwYWNlVVJJID0gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgdHlwZSAhPT0gdHlwZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiPCVzIC8+IGlzIHVzaW5nIGluY29ycmVjdCBjYXNpbmcuIFVzZSBQYXNjYWxDYXNlIGZvciBSZWFjdCBjb21wb25lbnRzLCBvciBsb3dlcmNhc2UgZm9yIEhUTUwgZWxlbWVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlID09PSAic2NyaXB0IikgewogICAgICAgICAgICAgIHZhciBkaXYgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAiPHNjcmlwdD48XC9zY3JpcHQ+IjsKICAgICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGRpdi5maXJzdENoaWxkOwogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBkaXYucmVtb3ZlQ2hpbGQoZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3BzLmlzID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSwgewogICAgICAgICAgICAgICAgaXM6IHByb3BzLmlzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlKTsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gZG9tRWxlbWVudDsKICAgICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICBub2RlLm11bHRpcGxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuc2l6ZSkgewogICAgICAgICAgICAgICAgICBub2RlLnNpemUgPSBwcm9wcy5zaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZVVSSSwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9tRWxlbWVudCkgPT09ICJbb2JqZWN0IEhUTUxVbmtub3duRWxlbWVudF0iICYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFVua25vd25UYWdzLCB0eXBlKSkgewogICAgICAgICAgICAgICAgd2FybmVkVW5rbm93blRhZ3NbdHlwZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSB0YWcgPCVzPiBpcyB1bnJlY29nbml6ZWQgaW4gdGhpcyBicm93c2VyLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgUmVhY3QgY29tcG9uZW50LCBzdGFydCBpdHMgbmFtZSB3aXRoIGFuIHVwcGVyY2FzZSBsZXR0ZXIuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUodGV4dCwgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpLmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIHJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHM7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWZyYW1lIjoKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ2aWRlbyI6CiAgICAgICAgICAgIGNhc2UgImF1ZGlvIjoKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1lZGlhRXZlbnRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudChtZWRpYUV2ZW50VHlwZXNbaV0sIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJ0b2dnbGUiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcyk7CiAgICAgICAgICBzZXRJbml0aWFsRE9NUHJvcGVydGllcyh0YWcsIGRvbUVsZW1lbnQsIHJvb3RDb250YWluZXJFbGVtZW50LCBwcm9wcywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIGZhbHNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMyhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgbGFzdFJhd1Byb3BzLCBuZXh0UmF3UHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBudWxsOwogICAgICAgICAgdmFyIGxhc3RQcm9wczsKICAgICAgICAgIHZhciBuZXh0UHJvcHM7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGxhc3RSYXdQcm9wczsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBuZXh0UmF3UHJvcHM7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsYXN0UHJvcHMub25DbGljayAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgbmV4dFByb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCBuZXh0UHJvcHMpOwogICAgICAgICAgdmFyIHByb3BLZXk7CiAgICAgICAgICB2YXIgc3R5bGVOYW1lOwogICAgICAgICAgdmFyIHN0eWxlVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbGFzdFByb3BzKSB7CiAgICAgICAgICAgIGlmIChuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgIWxhc3RQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBsYXN0UHJvcHNbcHJvcEtleV0gPT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHZhciBsYXN0U3R5bGUgPSBsYXN0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFN0eWxlKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdFN0eWxlLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCB8fCBwcm9wS2V5ID09PSBDSElMRFJFTikgOwogICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbmV4dFByb3BzKSB7CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IG5leHRQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgdmFyIGxhc3RQcm9wID0gbGFzdFByb3BzICE9IG51bGwgPyBsYXN0UHJvcHNbcHJvcEtleV0gOiB2b2lkIDA7CiAgICAgICAgICAgIGlmICghbmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8IG5leHRQcm9wID09PSBsYXN0UHJvcCB8fCBuZXh0UHJvcCA9PSBudWxsICYmIGxhc3RQcm9wID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYXN0UHJvcCkgewogICAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkgJiYgKCFuZXh0UHJvcCB8fCAhbmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gIiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmIGxhc3RQcm9wW3N0eWxlTmFtZV0gIT09IG5leHRQcm9wW3N0eWxlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gbmV4dFByb3Bbc3R5bGVOYW1lXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZC5wdXNoKHByb3BLZXksIHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSBuZXh0UHJvcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIGxhc3RIdG1sID0gbGFzdFByb3AgPyBsYXN0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdEh0bWwgIT09IG5leHRIdG1sKSB7CiAgICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gIm9uU2Nyb2xsIikgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkICYmIGxhc3RQcm9wICE9PSBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVNob3J0aGFuZFByb3BlcnR5Q29sbGlzaW9uSW5EZXYoc3R5bGVVcGRhdGVzLCBuZXh0UHJvcHNbU1RZTEVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2goU1RZTEUsIHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzKSB7CiAgICAgICAgICBpZiAodGFnID09PSAiaW5wdXQiICYmIG5leHRSYXdQcm9wcy50eXBlID09PSAicmFkaW8iICYmIG5leHRSYXdQcm9wcy5uYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlQ2hlY2tlZChkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIHVwZGF0ZURPTVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgd2FzQ3VzdG9tQ29tcG9uZW50VGFnLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlcihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcG9zdFVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UG9zc2libGVTdGFuZGFyZE5hbWUocHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcHJvcE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYgKCFwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBvc3NpYmxlU3RhbmRhcmROYW1lc1tsb3dlckNhc2VkTmFtZV0gfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIHJhd1Byb3BzLCBwYXJlbnROYW1lc3BhY2UsIHJvb3RDb250YWluZXJFbGVtZW50LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWc7CiAgICAgICAgICB2YXIgZXh0cmFBdHRyaWJ1dGVOYW1lczsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2FuY2VsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2xvc2UiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWZyYW1lIjoKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNvdXJjZSI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IGRvbUVsZW1lbnQuYXR0cmlidXRlczsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGF0dHJpYnV0ZXMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVzW19pXS5uYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgICAgICBjYXNlICJ2YWx1ZSI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiY2hlY2tlZCI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0ZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuYWRkKGF0dHJpYnV0ZXNbX2ldLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBudWxsOwogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiByYXdQcm9wcykgewogICAgICAgICAgICBpZiAoIXJhd1Byb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gcmF3UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tRWxlbWVudC50ZXh0Q29udGVudCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtDSElMRFJFTiwgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09ICIiICsgbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtDSElMRFJFTiwgIiIgKyBuZXh0UHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFdhcm5EZXYgJiYgdHJ1ZSAmJiAvLyBDb252aW5jZSBGbG93IHdlJ3ZlIGNhbGN1bGF0ZWQgaXQgKGl0J3MgREVWLW9ubHkgaW4gdGhpcyBtZXRob2QuKQogICAgICAgICAgICB0eXBlb2YgaXNDdXN0b21Db21wb25lbnRUYWcgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgIHZhciBzZXJ2ZXJWYWx1ZSA9IHZvaWQgMDsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gaXNDdXN0b21Db21wb25lbnRUYWcgJiYgZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCA/IG51bGwgOiBnZXRQcm9wZXJ0eUluZm8ocHJvcEtleSk7CiAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSA9PT0gdHJ1ZSkgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyB8fCAvLyBDb250cm9sbGVkIGF0dHJpYnV0ZXMgYXJlIG5vdCB2YWxpZGF0ZWQKICAgICAgICAgICAgICAvLyBUT0RPOiBPbmx5IGlnbm9yZSB0aGVtIG9uIGNvbnRyb2xsZWQgdGFncy4KICAgICAgICAgICAgICBwcm9wS2V5ID09PSAidmFsdWUiIHx8IHByb3BLZXkgPT09ICJjaGVja2VkIiB8fCBwcm9wS2V5ID09PSAic2VsZWN0ZWQiKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICAgIHZhciBzZXJ2ZXJIVE1MID0gZG9tRWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZXhwZWN0ZWRIVE1MID0gbm9ybWFsaXplSFRNTChkb21FbGVtZW50LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZEhUTUwgIT09IHNlcnZlckhUTUwpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVySFRNTCwgZXhwZWN0ZWRIVE1MKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkpOwogICAgICAgICAgICAgICAgaWYgKGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkU3R5bGUgPSBjcmVhdGVEYW5nZXJvdXNTdHJpbmdGb3JTdHlsZXMobmV4dFByb3ApOwogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGRvbUVsZW1lbnQuZ2V0QXR0cmlidXRlKCJzdHlsZSIpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRTdHlsZSAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIGV4cGVjdGVkU3R5bGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiAhZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCkgewogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSkgewogICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFzaG91bGRJZ25vcmVBdHRyaWJ1dGUocHJvcEtleSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgJiYgIXNob3VsZFJlbW92ZUF0dHJpYnV0ZShwcm9wS2V5LCBuZXh0UHJvcCwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgICAgIHZhciBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgb3duTmFtZXNwYWNlID0gcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIG93bk5hbWVzcGFjZSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0YWcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChvd25OYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhbmRhcmROYW1lID0gZ2V0UG9zc2libGVTdGFuZGFyZE5hbWUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbnVsbCAmJiBzdGFuZGFyZE5hbWUgIT09IHByb3BLZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlzTWlzbWF0Y2hEdWVUb0JhZENhc2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBkb250V2FybkN1c3RvbUVsZW1lbnQgPSBlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0OwogICAgICAgICAgICAgICAgaWYgKCFkb250V2FybkN1c3RvbUVsZW1lbnQgJiYgbmV4dFByb3AgIT09IHNlcnZlclZhbHVlICYmICFpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSAtIFNob3VsZCBiZSBpbmZlcnJlZCBhcyBub3QgdW5kZWZpbmVkLgogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5zaXplID4gMCAmJiByYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMoZXh0cmFBdHRyaWJ1dGVOYW1lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlcihkb21FbGVtZW50LCByYXdQcm9wcywgdHJ1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByYXdQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkVGV4dCh0ZXh0Tm9kZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIGlzRGlmZmVyZW50ID0gdGV4dE5vZGUubm9kZVZhbHVlICE9PSB0ZXh0OwogICAgICAgICAgcmV0dXJuIGlzRGlmZmVyZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgPCVzPiBpbiA8JXM+LiIsIGNoaWxkLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgY2hpbGQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gdGhlIHRleHQgbm9kZSAiJXMiIGluIDwlcz4uJywgY2hpbGQubm9kZVZhbHVlLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Tm9kZSwgdGFnLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIG1hdGNoaW5nIDwlcz4gaW4gPCVzPi4iLCB0YWcsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnROb2RlLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0ZXh0ID09PSAiIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcignRXhwZWN0ZWQgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIG1hdGNoaW5nIHRleHQgbm9kZSBmb3IgIiVzIiBpbiA8JXM+LicsIHRleHQsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMyhkb21FbGVtZW50LCB0YWcsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQyKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWxpZGF0ZURPTU5lc3RpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIHZhciB1cGRhdGVkQW5jZXN0b3JJbmZvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgc3BlY2lhbFRhZ3MgPSBbImFkZHJlc3MiLCAiYXBwbGV0IiwgImFyZWEiLCAiYXJ0aWNsZSIsICJhc2lkZSIsICJiYXNlIiwgImJhc2Vmb250IiwgImJnc291bmQiLCAiYmxvY2txdW90ZSIsICJib2R5IiwgImJyIiwgImJ1dHRvbiIsICJjYXB0aW9uIiwgImNlbnRlciIsICJjb2wiLCAiY29sZ3JvdXAiLCAiZGQiLCAiZGV0YWlscyIsICJkaXIiLCAiZGl2IiwgImRsIiwgImR0IiwgImVtYmVkIiwgImZpZWxkc2V0IiwgImZpZ2NhcHRpb24iLCAiZmlndXJlIiwgImZvb3RlciIsICJmb3JtIiwgImZyYW1lIiwgImZyYW1lc2V0IiwgImgxIiwgImgyIiwgImgzIiwgImg0IiwgImg1IiwgImg2IiwgImhlYWQiLCAiaGVhZGVyIiwgImhncm91cCIsICJociIsICJodG1sIiwgImlmcmFtZSIsICJpbWciLCAiaW5wdXQiLCAiaXNpbmRleCIsICJsaSIsICJsaW5rIiwgImxpc3RpbmciLCAibWFpbiIsICJtYXJxdWVlIiwgIm1lbnUiLCAibWVudWl0ZW0iLCAibWV0YSIsICJuYXYiLCAibm9lbWJlZCIsICJub2ZyYW1lcyIsICJub3NjcmlwdCIsICJvYmplY3QiLCAib2wiLCAicCIsICJwYXJhbSIsICJwbGFpbnRleHQiLCAicHJlIiwgInNjcmlwdCIsICJzZWN0aW9uIiwgInNlbGVjdCIsICJzb3VyY2UiLCAic3R5bGUiLCAic3VtbWFyeSIsICJ0YWJsZSIsICJ0Ym9keSIsICJ0ZCIsICJ0ZW1wbGF0ZSIsICJ0ZXh0YXJlYSIsICJ0Zm9vdCIsICJ0aCIsICJ0aGVhZCIsICJ0aXRsZSIsICJ0ciIsICJ0cmFjayIsICJ1bCIsICJ3YnIiLCAieG1wIl07CiAgICAgICAgICB2YXIgaW5TY29wZVRhZ3MgPSBbCiAgICAgICAgICAgICJhcHBsZXQiLAogICAgICAgICAgICAiY2FwdGlvbiIsCiAgICAgICAgICAgICJodG1sIiwKICAgICAgICAgICAgInRhYmxlIiwKICAgICAgICAgICAgInRkIiwKICAgICAgICAgICAgInRoIiwKICAgICAgICAgICAgIm1hcnF1ZWUiLAogICAgICAgICAgICAib2JqZWN0IiwKICAgICAgICAgICAgInRlbXBsYXRlIiwKICAgICAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc3ludGF4Lmh0bWwjaHRtbC1pbnRlZ3JhdGlvbi1wb2ludAogICAgICAgICAgICAvLyBUT0RPOiBEaXN0aW5ndWlzaCBieSBuYW1lc3BhY2UgaGVyZSAtLSBmb3IgPHRpdGxlPiwgaW5jbHVkaW5nIGl0IGhlcmUKICAgICAgICAgICAgLy8gZXJycyBvbiB0aGUgc2lkZSBvZiBmZXdlciB3YXJuaW5ncwogICAgICAgICAgICAiZm9yZWlnbk9iamVjdCIsCiAgICAgICAgICAgICJkZXNjIiwKICAgICAgICAgICAgInRpdGxlIgogICAgICAgICAgXTsKICAgICAgICAgIHZhciBidXR0b25TY29wZVRhZ3MgPSBpblNjb3BlVGFncy5jb25jYXQoWyJidXR0b24iXSk7CiAgICAgICAgICB2YXIgaW1wbGllZEVuZFRhZ3MgPSBbImRkIiwgImR0IiwgImxpIiwgIm9wdGlvbiIsICJvcHRncm91cCIsICJwIiwgInJwIiwgInJ0Il07CiAgICAgICAgICB2YXIgZW1wdHlBbmNlc3RvckluZm8gPSB7CiAgICAgICAgICAgIGN1cnJlbnQ6IG51bGwsCiAgICAgICAgICAgIGZvcm1UYWc6IG51bGwsCiAgICAgICAgICAgIGFUYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBidXR0b25UYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBub2JyVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgcFRhZ0luQnV0dG9uU2NvcGU6IG51bGwsCiAgICAgICAgICAgIGxpc3RJdGVtVGFnQXV0b2Nsb3Npbmc6IG51bGwsCiAgICAgICAgICAgIGRsSXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKG9sZEluZm8sIHRhZykgewogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gYXNzaWduMih7fSwgb2xkSW5mbyB8fCBlbXB0eUFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIHZhciBpbmZvID0gewogICAgICAgICAgICAgIHRhZwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoaW5TY29wZVRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSkgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJ1dHRvblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3BlY2lhbFRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSAmJiB0YWcgIT09ICJhZGRyZXNzIiAmJiB0YWcgIT09ICJkaXYiICYmIHRhZyAhPT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmN1cnJlbnQgPSBpbmZvOwogICAgICAgICAgICBpZiAodGFnID09PSAiZm9ybSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZm9ybVRhZyA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImEiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYnV0dG9uIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAibm9iciIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJwIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImxpIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiZGQiIHx8IHRhZyA9PT0gImR0IikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZyA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mbzsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgaXNUYWdWYWxpZFdpdGhQYXJlbnQgPSBmdW5jdGlvbih0YWcsIHBhcmVudFRhZykgewogICAgICAgICAgICBzd2l0Y2ggKHBhcmVudFRhZykgewogICAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAib3B0aW9uIiB8fCB0YWcgPT09ICJvcHRncm91cCIgfHwgdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgIm9wdGdyb3VwIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICBjYXNlICJ0ciI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAidGgiIHx8IHRhZyA9PT0gInRkIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAidGJvZHkiOgogICAgICAgICAgICAgIGNhc2UgInRoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJ0Zm9vdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAidHIiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJjb2xncm91cCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiY29sIiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAidGFibGUiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImNhcHRpb24iIHx8IHRhZyA9PT0gImNvbGdyb3VwIiB8fCB0YWcgPT09ICJ0Ym9keSIgfHwgdGFnID09PSAidGZvb3QiIHx8IHRhZyA9PT0gInRoZWFkIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiaGVhZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiYmFzZSIgfHwgdGFnID09PSAiYmFzZWZvbnQiIHx8IHRhZyA9PT0gImJnc291bmQiIHx8IHRhZyA9PT0gImxpbmsiIHx8IHRhZyA9PT0gIm1ldGEiIHx8IHRhZyA9PT0gInRpdGxlIiB8fCB0YWcgPT09ICJub3NjcmlwdCIgfHwgdGFnID09PSAibm9mcmFtZXMiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJoZWFkIiB8fCB0YWcgPT09ICJib2R5IiB8fCB0YWcgPT09ICJmcmFtZXNldCI7CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWVzZXQiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImZyYW1lIjsKICAgICAgICAgICAgICBjYXNlICIjZG9jdW1lbnQiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImh0bWwiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiaDEiOgogICAgICAgICAgICAgIGNhc2UgImgyIjoKICAgICAgICAgICAgICBjYXNlICJoMyI6CiAgICAgICAgICAgICAgY2FzZSAiaDQiOgogICAgICAgICAgICAgIGNhc2UgImg1IjoKICAgICAgICAgICAgICBjYXNlICJoNiI6CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VGFnICE9PSAiaDEiICYmIHBhcmVudFRhZyAhPT0gImgyIiAmJiBwYXJlbnRUYWcgIT09ICJoMyIgJiYgcGFyZW50VGFnICE9PSAiaDQiICYmIHBhcmVudFRhZyAhPT0gImg1IiAmJiBwYXJlbnRUYWcgIT09ICJoNiI7CiAgICAgICAgICAgICAgY2FzZSAicnAiOgogICAgICAgICAgICAgIGNhc2UgInJ0IjoKICAgICAgICAgICAgICAgIHJldHVybiBpbXBsaWVkRW5kVGFncy5pbmRleE9mKHBhcmVudFRhZykgPT09IC0xOwogICAgICAgICAgICAgIGNhc2UgImJvZHkiOgogICAgICAgICAgICAgIGNhc2UgImNhcHRpb24iOgogICAgICAgICAgICAgIGNhc2UgImNvbCI6CiAgICAgICAgICAgICAgY2FzZSAiY29sZ3JvdXAiOgogICAgICAgICAgICAgIGNhc2UgImZyYW1lc2V0IjoKICAgICAgICAgICAgICBjYXNlICJmcmFtZSI6CiAgICAgICAgICAgICAgY2FzZSAiaGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAiaHRtbCI6CiAgICAgICAgICAgICAgY2FzZSAidGJvZHkiOgogICAgICAgICAgICAgIGNhc2UgInRkIjoKICAgICAgICAgICAgICBjYXNlICJ0Zm9vdCI6CiAgICAgICAgICAgICAgY2FzZSAidGgiOgogICAgICAgICAgICAgIGNhc2UgInRoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJ0ciI6CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VGFnID09IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZpbmRJbnZhbGlkQW5jZXN0b3JGb3JUYWcgPSBmdW5jdGlvbih0YWcsIGFuY2VzdG9ySW5mbykgewogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgImFkZHJlc3MiOgogICAgICAgICAgICAgIGNhc2UgImFydGljbGUiOgogICAgICAgICAgICAgIGNhc2UgImFzaWRlIjoKICAgICAgICAgICAgICBjYXNlICJibG9ja3F1b3RlIjoKICAgICAgICAgICAgICBjYXNlICJjZW50ZXIiOgogICAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgY2FzZSAiZGlyIjoKICAgICAgICAgICAgICBjYXNlICJkaXYiOgogICAgICAgICAgICAgIGNhc2UgImRsIjoKICAgICAgICAgICAgICBjYXNlICJmaWVsZHNldCI6CiAgICAgICAgICAgICAgY2FzZSAiZmlnY2FwdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAiZmlndXJlIjoKICAgICAgICAgICAgICBjYXNlICJmb290ZXIiOgogICAgICAgICAgICAgIGNhc2UgImhlYWRlciI6CiAgICAgICAgICAgICAgY2FzZSAiaGdyb3VwIjoKICAgICAgICAgICAgICBjYXNlICJtYWluIjoKICAgICAgICAgICAgICBjYXNlICJtZW51IjoKICAgICAgICAgICAgICBjYXNlICJuYXYiOgogICAgICAgICAgICAgIGNhc2UgIm9sIjoKICAgICAgICAgICAgICBjYXNlICJwIjoKICAgICAgICAgICAgICBjYXNlICJzZWN0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJzdW1tYXJ5IjoKICAgICAgICAgICAgICBjYXNlICJ1bCI6CiAgICAgICAgICAgICAgY2FzZSAicHJlIjoKICAgICAgICAgICAgICBjYXNlICJsaXN0aW5nIjoKICAgICAgICAgICAgICBjYXNlICJ0YWJsZSI6CiAgICAgICAgICAgICAgY2FzZSAiaHIiOgogICAgICAgICAgICAgIGNhc2UgInhtcCI6CiAgICAgICAgICAgICAgY2FzZSAiaDEiOgogICAgICAgICAgICAgIGNhc2UgImgyIjoKICAgICAgICAgICAgICBjYXNlICJoMyI6CiAgICAgICAgICAgICAgY2FzZSAiaDQiOgogICAgICAgICAgICAgIGNhc2UgImg1IjoKICAgICAgICAgICAgICBjYXNlICJoNiI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImZvcm0iOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5mb3JtVGFnIHx8IGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZTsKICAgICAgICAgICAgICBjYXNlICJsaSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3Npbmc7CiAgICAgICAgICAgICAgY2FzZSAiZGQiOgogICAgICAgICAgICAgIGNhc2UgImR0IjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3Npbmc7CiAgICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZTsKICAgICAgICAgICAgICBjYXNlICJhIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAibm9iciI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkaWRXYXJuJDEgPSB7fTsKICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyA9IGZ1bmN0aW9uKGNoaWxkVGFnLCBjaGlsZFRleHQsIGFuY2VzdG9ySW5mbykgewogICAgICAgICAgICBhbmNlc3RvckluZm8gPSBhbmNlc3RvckluZm8gfHwgZW1wdHlBbmNlc3RvckluZm87CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmZvID0gYW5jZXN0b3JJbmZvLmN1cnJlbnQ7CiAgICAgICAgICAgIHZhciBwYXJlbnRUYWcgPSBwYXJlbnRJbmZvICYmIHBhcmVudEluZm8udGFnOwogICAgICAgICAgICBpZiAoY2hpbGRUZXh0ICE9IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGRUYWcgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoInZhbGlkYXRlRE9NTmVzdGluZzogd2hlbiBjaGlsZFRleHQgaXMgcGFzc2VkLCBjaGlsZFRhZyBzaG91bGQgYmUgbnVsbCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZFRhZyA9ICIjdGV4dCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGludmFsaWRQYXJlbnQgPSBpc1RhZ1ZhbGlkV2l0aFBhcmVudChjaGlsZFRhZywgcGFyZW50VGFnKSA/IG51bGwgOiBwYXJlbnRJbmZvOwogICAgICAgICAgICB2YXIgaW52YWxpZEFuY2VzdG9yID0gaW52YWxpZFBhcmVudCA/IG51bGwgOiBmaW5kSW52YWxpZEFuY2VzdG9yRm9yVGFnKGNoaWxkVGFnLCBhbmNlc3RvckluZm8pOwogICAgICAgICAgICB2YXIgaW52YWxpZFBhcmVudE9yQW5jZXN0b3IgPSBpbnZhbGlkUGFyZW50IHx8IGludmFsaWRBbmNlc3RvcjsKICAgICAgICAgICAgaWYgKCFpbnZhbGlkUGFyZW50T3JBbmNlc3RvcikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYW5jZXN0b3JUYWcgPSBpbnZhbGlkUGFyZW50T3JBbmNlc3Rvci50YWc7CiAgICAgICAgICAgIHZhciB3YXJuS2V5ID0gISFpbnZhbGlkUGFyZW50ICsgInwiICsgY2hpbGRUYWcgKyAifCIgKyBhbmNlc3RvclRhZzsKICAgICAgICAgICAgaWYgKGRpZFdhcm4kMVt3YXJuS2V5XSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuJDFbd2FybktleV0gPSB0cnVlOwogICAgICAgICAgICB2YXIgdGFnRGlzcGxheU5hbWUgPSBjaGlsZFRhZzsKICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2VJbmZvID0gIiI7CiAgICAgICAgICAgIGlmIChjaGlsZFRhZyA9PT0gIiN0ZXh0IikgewogICAgICAgICAgICAgIGlmICgvXFMvLnRlc3QoY2hpbGRUZXh0KSkgewogICAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiVGV4dCBub2RlcyI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIldoaXRlc3BhY2UgdGV4dCBub2RlcyI7CiAgICAgICAgICAgICAgICB3aGl0ZXNwYWNlSW5mbyA9ICIgTWFrZSBzdXJlIHlvdSBkb24ndCBoYXZlIGFueSBleHRyYSB3aGl0ZXNwYWNlIGJldHdlZW4gdGFncyBvbiBlYWNoIGxpbmUgb2YgeW91ciBzb3VyY2UgY29kZS4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICI8IiArIGNoaWxkVGFnICsgIj4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnZhbGlkUGFyZW50KSB7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICBpZiAoYW5jZXN0b3JUYWcgPT09ICJ0YWJsZSIgJiYgY2hpbGRUYWcgPT09ICJ0ciIpIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIiBBZGQgYSA8dGJvZHk+LCA8dGhlYWQ+IG9yIDx0Zm9vdD4gdG8geW91ciBjb2RlIHRvIG1hdGNoIHRoZSBET00gdHJlZSBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXJyb3IoInZhbGlkYXRlRE9NTmVzdGluZyguLi4pOiAlcyBjYW5ub3QgYXBwZWFyIGFzIGEgY2hpbGQgb2YgPCVzPi4lcyVzIiwgdGFnRGlzcGxheU5hbWUsIGFuY2VzdG9yVGFnLCB3aGl0ZXNwYWNlSW5mbywgaW5mbyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXJyb3IoInZhbGlkYXRlRE9NTmVzdGluZyguLi4pOiAlcyBjYW5ub3QgYXBwZWFyIGFzIGEgZGVzY2VuZGFudCBvZiA8JXM+LiIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxID0gInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyI7CiAgICAgICAgdmFyIFNVU1BFTlNFX1NUQVJUX0RBVEEgPSAiJCI7CiAgICAgICAgdmFyIFNVU1BFTlNFX0VORF9EQVRBID0gIi8kIjsKICAgICAgICB2YXIgU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBID0gIiQ/IjsKICAgICAgICB2YXIgU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSA9ICIkISI7CiAgICAgICAgdmFyIFNUWUxFJDEgPSAic3R5bGUiOwogICAgICAgIHZhciBldmVudHNFbmFibGVkID0gbnVsbDsKICAgICAgICB2YXIgc2VsZWN0aW9uSW5mb3JtYXRpb24gPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGdldFJvb3RIb3N0Q29udGV4dChyb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgIHZhciB0eXBlOwogICAgICAgICAgdmFyIG5hbWVzcGFjZTsKICAgICAgICAgIHZhciBub2RlVHlwZSA9IHJvb3RDb250YWluZXJJbnN0YW5jZS5ub2RlVHlwZTsKICAgICAgICAgIHN3aXRjaCAobm9kZVR5cGUpIHsKICAgICAgICAgICAgY2FzZSBET0NVTUVOVF9OT0RFOgogICAgICAgICAgICBjYXNlIERPQ1VNRU5UX0ZSQUdNRU5UX05PREU6IHsKICAgICAgICAgICAgICB0eXBlID0gbm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyAiI2RvY3VtZW50IiA6ICIjZnJhZ21lbnQiOwogICAgICAgICAgICAgIHZhciByb290MyA9IHJvb3RDb250YWluZXJJbnN0YW5jZS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgICAgbmFtZXNwYWNlID0gcm9vdDMgPyByb290My5uYW1lc3BhY2VVUkkgOiBnZXRDaGlsZE5hbWVzcGFjZShudWxsLCAiIik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gbm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJJbnN0YW5jZS5wYXJlbnROb2RlIDogcm9vdENvbnRhaW5lckluc3RhbmNlOwogICAgICAgICAgICAgIHZhciBvd25OYW1lc3BhY2UgPSBjb250YWluZXIyLm5hbWVzcGFjZVVSSSB8fCBudWxsOwogICAgICAgICAgICAgIHR5cGUgPSBjb250YWluZXIyLnRhZ05hbWU7CiAgICAgICAgICAgICAgbmFtZXNwYWNlID0gZ2V0Q2hpbGROYW1lc3BhY2Uob3duTmFtZXNwYWNlLCB0eXBlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgdmFsaWRhdGVkVGFnID0gdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhudWxsLCB2YWxpZGF0ZWRUYWcpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBhbmNlc3RvckluZm8KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGRIb3N0Q29udGV4dChwYXJlbnRIb3N0Q29udGV4dCwgdHlwZSwgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnRIb3N0Q29udGV4dERldiA9IHBhcmVudEhvc3RDb250ZXh0OwogICAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZ2V0Q2hpbGROYW1lc3BhY2UocGFyZW50SG9zdENvbnRleHREZXYubmFtZXNwYWNlLCB0eXBlKTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8ocGFyZW50SG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVGb3JDb21taXQoY29udGFpbmVySW5mbykgewogICAgICAgICAgZXZlbnRzRW5hYmxlZCA9IGlzRW5hYmxlZCgpOwogICAgICAgICAgc2VsZWN0aW9uSW5mb3JtYXRpb24gPSBnZXRTZWxlY3Rpb25JbmZvcm1hdGlvbigpOwogICAgICAgICAgdmFyIGFjdGl2ZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgIHNldEVuYWJsZWQoZmFsc2UpOwogICAgICAgICAgcmV0dXJuIGFjdGl2ZUluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEFmdGVyQ29tbWl0KGNvbnRhaW5lckluZm8pIHsKICAgICAgICAgIHJlc3RvcmVTZWxlY3Rpb24oc2VsZWN0aW9uSW5mb3JtYXRpb24pOwogICAgICAgICAgc2V0RW5hYmxlZChldmVudHNFbmFibGVkKTsKICAgICAgICAgIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgICAgc2VsZWN0aW9uSW5mb3JtYXRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZSh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdmFyIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyh0eXBlLCBudWxsLCBob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8pOwogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgcHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudE5hbWVzcGFjZSA9IGhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkb21FbGVtZW50ID0gY3JlYXRlRWxlbWVudDQwKHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIHBhcmVudE5hbWVzcGFjZSk7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBkb21FbGVtZW50KTsKICAgICAgICAgIHVwZGF0ZUZpYmVyUHJvcHMoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgcmV0dXJuIGRvbUVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oZG9tRWxlbWVudCwgdHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHNldEluaXRpYWxQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgImJ1dHRvbiI6CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHJldHVybiAhIXByb3BzLmF1dG9Gb2N1czsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVVcGRhdGUoZG9tRWxlbWVudCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICBpZiAodHlwZW9mIG5ld1Byb3BzLmNoaWxkcmVuICE9PSB0eXBlb2Ygb2xkUHJvcHMuY2hpbGRyZW4gJiYgKHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5ld1Byb3BzLmNoaWxkcmVuID09PSAibnVtYmVyIikpIHsKICAgICAgICAgICAgICB2YXIgc3RyaW5nID0gIiIgKyBuZXdQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgb3duQW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyhudWxsLCBzdHJpbmcsIG93bkFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkaWZmUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRTZXRUZXh0Q29udGVudCh0eXBlLCBwcm9wcykgewogICAgICAgICAgcmV0dXJuIHR5cGUgPT09ICJ0ZXh0YXJlYSIgfHwgdHlwZSA9PT0gIm5vc2NyaXB0IiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIgfHwgdHlwZW9mIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MID09PSAib2JqZWN0IiAmJiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPT0gbnVsbCAmJiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTC5fX2h0bWwgIT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVGV4dEluc3RhbmNlKHRleHQsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyhudWxsLCB0ZXh0LCBob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRleHROb2RlID0gY3JlYXRlVGV4dE5vZGUodGV4dCwgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRleHROb2RlKTsKICAgICAgICAgIHJldHVybiB0ZXh0Tm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEV2ZW50UHJpb3JpdHkoKSB7CiAgICAgICAgICB2YXIgY3VycmVudEV2ZW50ID0gd2luZG93LmV2ZW50OwogICAgICAgICAgaWYgKGN1cnJlbnRFdmVudCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRFdmVudFByaW9yaXR5KGN1cnJlbnRFdmVudC50eXBlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlVGltZW91dCA9IHR5cGVvZiBzZXRUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gc2V0VGltZW91dCA6IHZvaWQgMDsKICAgICAgICB2YXIgY2FuY2VsVGltZW91dCA9IHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBjbGVhclRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgdmFyIG5vVGltZW91dCA9IC0xOwogICAgICAgIHZhciBsb2NhbFByb21pc2UgPSB0eXBlb2YgUHJvbWlzZSA9PT0gImZ1bmN0aW9uIiA/IFByb21pc2UgOiB2b2lkIDA7CiAgICAgICAgdmFyIHNjaGVkdWxlTWljcm90YXNrID0gdHlwZW9mIHF1ZXVlTWljcm90YXNrID09PSAiZnVuY3Rpb24iID8gcXVldWVNaWNyb3Rhc2sgOiB0eXBlb2YgbG9jYWxQcm9taXNlICE9PSAidW5kZWZpbmVkIiA/IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gbG9jYWxQcm9taXNlLnJlc29sdmUobnVsbCkudGhlbihjYWxsYmFjaykuY2F0Y2goaGFuZGxlRXJyb3JJbk5leHRUaWNrKTsKICAgICAgICB9IDogc2NoZWR1bGVUaW1lb3V0OwogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9ySW5OZXh0VGljayhlcnJvcjIpIHsKICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRNb3VudChkb21FbGVtZW50LCB0eXBlLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgImJ1dHRvbiI6CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5hdXRvRm9jdXMpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQuZm9jdXMoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJpbWciOiB7CiAgICAgICAgICAgICAgaWYgKG5ld1Byb3BzLnNyYykgewogICAgICAgICAgICAgICAgZG9tRWxlbWVudC5zcmMgPSBuZXdQcm9wcy5zcmM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRVcGRhdGUoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB1cGRhdGVQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIG5ld1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRUZXh0Q29udGVudChkb21FbGVtZW50KSB7CiAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCAiIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFRleHRVcGRhdGUodGV4dEluc3RhbmNlLCBvbGRUZXh0LCBuZXdUZXh0KSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gbmV3VGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwZW5kQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkVG9Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGQpIHsKICAgICAgICAgIHZhciBwYXJlbnROb2RlOwogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBwYXJlbnROb2RlID0gY29udGFpbmVyMi5wYXJlbnROb2RlOwogICAgICAgICAgICBwYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZCwgY29udGFpbmVyMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXJlbnROb2RlID0gY29udGFpbmVyMjsKICAgICAgICAgICAgcGFyZW50Tm9kZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVhY3RSb290Q29udGFpbmVyID0gY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgaWYgKChyZWFjdFJvb3RDb250YWluZXIgPT09IG51bGwgfHwgcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDApICYmIHBhcmVudE5vZGUub25jbGljayA9PT0gbnVsbCkgewogICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChwYXJlbnROb2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0QmVmb3JlKHBhcmVudEluc3RhbmNlLCBjaGlsZCwgYmVmb3JlQ2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLmluc2VydEJlZm9yZShjaGlsZCwgYmVmb3JlQ2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRJbkNvbnRhaW5lckJlZm9yZShjb250YWluZXIyLCBjaGlsZCwgYmVmb3JlQ2hpbGQpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZCwgYmVmb3JlQ2hpbGQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGFpbmVyMi5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkRnJvbUNvbnRhaW5lcihjb250YWluZXIyLCBjaGlsZCkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjb250YWluZXIyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGFpbmVyMi5yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShwYXJlbnRJbnN0YW5jZSwgc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgdmFyIG5vZGUgPSBzdXNwZW5zZUluc3RhbmNlOwogICAgICAgICAgdmFyIGRlcHRoID0gMDsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIG5leHROb2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQobm9kZSk7CiAgICAgICAgICAgIGlmIChuZXh0Tm9kZSAmJiBuZXh0Tm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBuZXh0Tm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgaWYgKGRlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5leHROb2RlKTsKICAgICAgICAgICAgICAgICAgcmV0cnlJZkJsb2NrZWRPbihzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBuZXh0Tm9kZTsKICAgICAgICAgIH0gd2hpbGUgKG5vZGUpOwogICAgICAgICAgcmV0cnlJZkJsb2NrZWRPbihzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJTdXNwZW5zZUJvdW5kYXJ5RnJvbUNvbnRhaW5lcihjb250YWluZXIyLCBzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIyLnBhcmVudE5vZGUsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGNvbnRhaW5lcjIsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlJZkJsb2NrZWRPbihjb250YWluZXIyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlkZUluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgdmFyIHN0eWxlMiA9IGluc3RhbmNlLnN0eWxlOwogICAgICAgICAgaWYgKHR5cGVvZiBzdHlsZTIuc2V0UHJvcGVydHkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgc3R5bGUyLnNldFByb3BlcnR5KCJkaXNwbGF5IiwgIm5vbmUiLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdHlsZTIuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlkZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UpIHsKICAgICAgICAgIHRleHRJbnN0YW5jZS5ub2RlVmFsdWUgPSAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5oaWRlSW5zdGFuY2UoaW5zdGFuY2UsIHByb3BzKSB7CiAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgdmFyIHN0eWxlUHJvcCA9IHByb3BzW1NUWUxFJDFdOwogICAgICAgICAgdmFyIGRpc3BsYXkgPSBzdHlsZVByb3AgIT09IHZvaWQgMCAmJiBzdHlsZVByb3AgIT09IG51bGwgJiYgc3R5bGVQcm9wLmhhc093blByb3BlcnR5KCJkaXNwbGF5IikgPyBzdHlsZVByb3AuZGlzcGxheSA6IG51bGw7CiAgICAgICAgICBpbnN0YW5jZS5zdHlsZS5kaXNwbGF5ID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZSgiZGlzcGxheSIsIGRpc3BsYXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bmhpZGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlLCB0ZXh0KSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gdGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJDb250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICBjb250YWluZXIyLnRleHRDb250ZW50ID0gIiI7CiAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50KSB7CiAgICAgICAgICAgICAgY29udGFpbmVyMi5yZW1vdmVDaGlsZChjb250YWluZXIyLmRvY3VtZW50RWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgaWYgKGluc3RhbmNlLm5vZGVUeXBlICE9PSBFTEVNRU5UX05PREUgfHwgdHlwZS50b0xvd2VyQ2FzZSgpICE9PSBpbnN0YW5jZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5IeWRyYXRlVGV4dEluc3RhbmNlKGluc3RhbmNlLCB0ZXh0KSB7CiAgICAgICAgICBpZiAodGV4dCA9PT0gIiIgfHwgaW5zdGFuY2Uubm9kZVR5cGUgIT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbnNlSW5zdGFuY2VGYWxsYmFja0Vycm9yRGV0YWlscyhpbnN0YW5jZSkgewogICAgICAgICAgdmFyIGRhdGFzZXQgPSBpbnN0YW5jZS5uZXh0U2libGluZyAmJiBpbnN0YW5jZS5uZXh0U2libGluZy5kYXRhc2V0OwogICAgICAgICAgdmFyIGRpZ2VzdCwgbWVzc2FnZSwgc3RhY2s7CiAgICAgICAgICBpZiAoZGF0YXNldCkgewogICAgICAgICAgICBkaWdlc3QgPSBkYXRhc2V0LmRnc3Q7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtZXNzYWdlID0gZGF0YXNldC5tc2c7CiAgICAgICAgICAgICAgc3RhY2sgPSBkYXRhc2V0LnN0Y2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBtZXNzYWdlLAogICAgICAgICAgICAgIGRpZ2VzdCwKICAgICAgICAgICAgICBzdGFjawogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlclN1c3BlbnNlSW5zdGFuY2VSZXRyeShpbnN0YW5jZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGluc3RhbmNlLl9yZWFjdFJldHJ5ID0gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRIeWRyYXRhYmxlKG5vZGUpIHsKICAgICAgICAgIGZvciAoOyBub2RlICE9IG51bGw7IG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgIHZhciBub2RlVHlwZSA9IG5vZGUubm9kZVR5cGU7CiAgICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFIHx8IG5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBub2RlRGF0YSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgbm9kZURhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgbm9kZURhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlRGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKGluc3RhbmNlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGQocGFyZW50SW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShwYXJlbnRJbnN0YW5jZS5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50Q29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShwYXJlbnRJbnN0YW5jZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIGluc3RhbmNlKTsKICAgICAgICAgIHVwZGF0ZUZpYmVyUHJvcHMoaW5zdGFuY2UsIHByb3BzKTsKICAgICAgICAgIHZhciBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICBwYXJlbnROYW1lc3BhY2UgPSBob3N0Q29udGV4dERldi5uYW1lc3BhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHJldHVybiBkaWZmSHlkcmF0ZWRQcm9wZXJ0aWVzKGluc3RhbmNlLCB0eXBlLCBwcm9wcywgcGFyZW50TmFtZXNwYWNlLCByb290Q29udGFpbmVySW5zdGFuY2UsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgdGV4dEluc3RhbmNlKTsKICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKGludGVybmFsSW5zdGFuY2VIYW5kbGUubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgcmV0dXJuIGRpZmZIeWRyYXRlZFRleHQodGV4dEluc3RhbmNlLCB0ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRIeWRyYXRhYmxlSW5zdGFuY2VBZnRlclN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgdmFyIG5vZGUgPSBzdXNwZW5zZUluc3RhbmNlLm5leHRTaWJsaW5nOwogICAgICAgICAgdmFyIGRlcHRoID0gMDsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKG5vZGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFBhcmVudFN1c3BlbnNlSW5zdGFuY2UodGFyZ2V0SW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gdGFyZ2V0SW5zdGFuY2UucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgdmFyIGRlcHRoID0gMDsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSkgewogICAgICAgICAgICAgICAgaWYgKGRlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0SHlkcmF0ZWRDb250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgcmV0cnlJZkJsb2NrZWRPbihjb250YWluZXIyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0SHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZERlbGV0ZVVuaHlkcmF0ZWRUYWlsSW5zdGFuY2VzKHBhcmVudFR5cGUpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRUeXBlICE9PSAiaGVhZCIgJiYgcGFyZW50VHlwZSAhPT0gImJvZHkiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RNYXRjaEh5ZHJhdGVkQ29udGFpbmVyVGV4dEluc3RhbmNlKHBhcmVudENvbnRhaW5lciwgdGV4dEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICB2YXIgc2hvdWxkV2FybkRldiA9IHRydWU7CiAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQodGV4dEluc3RhbmNlLm5vZGVWYWx1ZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdE1hdGNoSHlkcmF0ZWRUZXh0SW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCB0ZXh0SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIGlmIChwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICB2YXIgc2hvdWxkV2FybkRldiA9IHRydWU7CiAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dCh0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudENvbnRhaW5lciwgaW5zdGFuY2UpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlVGV4dChwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHBhcmVudEluc3RhbmNlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwYXJlbnROb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZUVsZW1lbnQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgOwogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlVGV4dChwYXJlbnROb2RlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIGluc3RhbmNlLCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlIHx8IHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZUVsZW1lbnQocGFyZW50SW5zdGFuY2UsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50SW5zdGFuY2UsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnRDb250YWluZXIsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHBhcmVudEluc3RhbmNlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwYXJlbnROb2RlICE9PSBudWxsKSB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Tm9kZSwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHBhcmVudEluc3RhbmNlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwYXJlbnROb2RlICE9PSBudWxsKSB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Tm9kZSwgdGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCB0eXBlLCBwcm9wcywgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnRJbnN0YW5jZSwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlIHx8IHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudEluc3RhbmNlLCB0ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlcnJvckh5ZHJhdGluZ0NvbnRhaW5lcihwYXJlbnRDb250YWluZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIkFuIGVycm9yIG9jY3VycmVkIGR1cmluZyBoeWRyYXRpb24uIFRoZSBzZXJ2ZXIgSFRNTCB3YXMgcmVwbGFjZWQgd2l0aCBjbGllbnQgY29udGVudCBpbiA8JXM+LiIsIHBhcmVudENvbnRhaW5lci5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVBvcnRhbE1vdW50KHBvcnRhbEluc3RhbmNlKSB7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhwb3J0YWxJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIHZhciByYW5kb21LZXkgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsKICAgICAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZUtleSA9ICJfX3JlYWN0RmliZXIkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxQcm9wc0tleSA9ICJfX3JlYWN0UHJvcHMkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleSA9ICJfX3JlYWN0Q29udGFpbmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVyc0tleSA9ICJfX3JlYWN0RXZlbnRzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVyTGlzdGVuZXJzS2V5ID0gIl9fcmVhY3RMaXN0ZW5lcnMkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxFdmVudEhhbmRsZXNTZXRLZXkgPSAiX19yZWFjdEhhbmRsZXMkIiArIHJhbmRvbUtleTsKICAgICAgICBmdW5jdGlvbiBkZXRhY2hEZWxldGVkSW5zdGFuY2Uobm9kZSkgewogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbFByb3BzS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlc1NldEtleV07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZWNhY2hlRmliZXJOb2RlKGhvc3RJbnN0LCBub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldID0gaG9zdEluc3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb250YWluZXJBc1Jvb3QoaG9zdFJvb3QsIG5vZGUpIHsKICAgICAgICAgIG5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV0gPSBob3N0Um9vdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5tYXJrQ29udGFpbmVyQXNSb290KG5vZGUpIHsKICAgICAgICAgIG5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV0gPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChub2RlKSB7CiAgICAgICAgICByZXR1cm4gISFub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZSh0YXJnZXROb2RlKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0SW5zdCA9IHRhcmdldE5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCkgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gdGFyZ2V0Tm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgd2hpbGUgKHBhcmVudE5vZGUpIHsKICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IHBhcmVudE5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV0gfHwgcGFyZW50Tm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gdGFyZ2V0SW5zdC5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKHRhcmdldEluc3QuY2hpbGQgIT09IG51bGwgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHRhcmdldE5vZGUpOwogICAgICAgICAgICAgICAgd2hpbGUgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldFN1c3BlbnNlSW5zdCA9IHN1c3BlbnNlSW5zdGFuY2VbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRTdXNwZW5zZUluc3QpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0U3VzcGVuc2VJbnN0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlSW5zdGFuY2UgPSBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YXJnZXROb2RlID0gcGFyZW50Tm9kZTsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRJbnN0YW5jZUZyb21Ob2RlKG5vZGUpIHsKICAgICAgICAgIHZhciBpbnN0ID0gbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XSB8fCBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldOwogICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgaWYgKGluc3QudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0VGV4dCB8fCBpbnN0LnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROb2RlRnJvbUluc3RhbmNlKGluc3QpIHsKICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3Quc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJnZXROb2RlRnJvbUluc3RhbmNlOiBJbnZhbGlkIGFyZ3VtZW50LiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlW2ludGVybmFsUHJvcHNLZXldIHx8IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZpYmVyUHJvcHMobm9kZSwgcHJvcHMpIHsKICAgICAgICAgIG5vZGVbaW50ZXJuYWxQcm9wc0tleV0gPSBwcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRMaXN0ZW5lclNldChub2RlKSB7CiAgICAgICAgICB2YXIgZWxlbWVudExpc3RlbmVyU2V0ID0gbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgaWYgKGVsZW1lbnRMaXN0ZW5lclNldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVsZW1lbnRMaXN0ZW5lclNldCA9IG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudExpc3RlbmVyU2V0OwogICAgICAgIH0KICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BUeXBlcyh0eXBlU3BlY3MsIHZhbHVlcywgbG9jYXRpb24sIGNvbXBvbmVudE5hbWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhczQgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhczQodHlwZVNwZWNzLCB0eXBlU3BlY05hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gRXJyb3IoKGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIikgKyAiOiAiICsgbG9jYXRpb24gKyAiIHR5cGUgYCIgKyB0eXBlU3BlY05hbWUgKyAiYCBpcyBpbnZhbGlkOyBpdCBtdXN0IGJlIGEgZnVuY3Rpb24sIHVzdWFsbHkgZnJvbSB0aGUgYHByb3AtdHlwZXNgIHBhY2thZ2UsIGJ1dCByZWNlaXZlZCBgIiArIHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSArICJgLlRoaXMgb2Z0ZW4gaGFwcGVucyBiZWNhdXNlIG9mIHR5cG9zIHN1Y2ggYXMgYFByb3BUeXBlcy5mdW5jdGlvbmAgaW5zdGVhZCBvZiBgUHJvcFR5cGVzLmZ1bmNgLiIpOwogICAgICAgICAgICAgICAgICAgIGVyci5uYW1lID0gIkludmFyaWFudCBWaW9sYXRpb24iOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvciQxID0gdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0odmFsdWVzLCB0eXBlU3BlY05hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBudWxsLCAiU0VDUkVUX0RPX05PVF9QQVNTX1RISVNfT1JfWU9VX1dJTExfQkVfRklSRUQiKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSBleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxICYmICEoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yKSkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiB0eXBlIHNwZWNpZmljYXRpb24gb2YgJXMgYCVzYCBpcyBpbnZhbGlkOyB0aGUgdHlwZSBjaGVja2VyIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGBudWxsYCBvciBhbiBgRXJyb3JgIGJ1dCByZXR1cm5lZCBhICVzLiBZb3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIHBhc3MgYW4gYXJndW1lbnQgdG8gdGhlIHR5cGUgY2hlY2tlciBjcmVhdG9yIChhcnJheU9mLCBpbnN0YW5jZU9mLCBvYmplY3RPZiwgb25lT2YsIG9uZU9mVHlwZSwgYW5kIHNoYXBlIGFsbCByZXF1aXJlIGFuIGFyZ3VtZW50KS4iLCBjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIsIGxvY2F0aW9uLCB0eXBlU3BlY05hbWUsIHR5cGVvZiBlcnJvciQxKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yICYmICEoZXJyb3IkMS5tZXNzYWdlIGluIGxvZ2dlZFR5cGVGYWlsdXJlcykpIHsKICAgICAgICAgICAgICAgICAgbG9nZ2VkVHlwZUZhaWx1cmVzW2Vycm9yJDEubWVzc2FnZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkZhaWxlZCAlcyB0eXBlOiAlcyIsIGxvY2F0aW9uLCBlcnJvciQxLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlU3RhY2sgPSBbXTsKICAgICAgICB2YXIgZmliZXJTdGFjazsKICAgICAgICB7CiAgICAgICAgICBmaWJlclN0YWNrID0gW107CiAgICAgICAgfQogICAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUN1cnNvcihkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGN1cnJlbnQ6IGRlZmF1bHRWYWx1ZQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wKGN1cnNvciwgZmliZXIpIHsKICAgICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHBvcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWJlciAhPT0gZmliZXJTdGFja1tpbmRleF0pIHsKICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBGaWJlciBwb3BwZWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWVTdGFja1tpbmRleF07CiAgICAgICAgICB2YWx1ZVN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyU3RhY2tbaW5kZXhdID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGluZGV4LS07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2goY3Vyc29yLCB2YWx1ZSwgZmliZXIpIHsKICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICB2YWx1ZVN0YWNrW2luZGV4XSA9IGN1cnNvci5jdXJyZW50OwogICAgICAgICAgewogICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4XSA9IGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgY3Vyc29yLmN1cnJlbnQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dDsKICAgICAgICB7CiAgICAgICAgICB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHQgPSB7fTsKICAgICAgICB9CiAgICAgICAgdmFyIGVtcHR5Q29udGV4dE9iamVjdCA9IHt9OwogICAgICAgIHsKICAgICAgICAgIE9iamVjdC5mcmVlemUoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbnRleHRTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihlbXB0eUNvbnRleHRPYmplY3QpOwogICAgICAgIHZhciBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKGZhbHNlKTsKICAgICAgICB2YXIgcHJldmlvdXNDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgIGZ1bmN0aW9uIGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgZGlkUHVzaE93bkNvbnRleHRJZlByb3ZpZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRQdXNoT3duQ29udGV4dElmUHJvdmlkZXIgJiYgaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c0NvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIG1hc2tlZENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9IHVubWFza2VkQ29udGV4dDsKICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNYXNrZWRDaGlsZENvbnRleHQgPSBtYXNrZWRDb250ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgIHZhciBjb250ZXh0VHlwZXMgPSB0eXBlLmNvbnRleHRUeXBlczsKICAgICAgICAgICAgaWYgKCFjb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSAmJiBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZFVubWFza2VkQ2hpbGRDb250ZXh0ID09PSB1bm1hc2tlZENvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNYXNrZWRDaGlsZENvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbnRleHRUeXBlcykgewogICAgICAgICAgICAgIGNvbnRleHRba2V5XSA9IHVubWFza2VkQ29udGV4dFtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoY29udGV4dFR5cGVzLCBjb250ZXh0LCAiY29udGV4dCIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSkgewogICAgICAgICAgICAgIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc0NvbnRleHRDaGFuZ2VkKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbnRleHRQcm92aWRlcih0eXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHRUeXBlcyA9IHR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgIHJldHVybiBjaGlsZENvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjaGlsZENvbnRleHRUeXBlcyAhPT0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wVG9wTGV2ZWxDb250ZXh0T2JqZWN0KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlciwgY29udGV4dCwgZGlkQ2hhbmdlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudCAhPT0gZW1wdHlDb250ZXh0T2JqZWN0KSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGNvbnRleHQgZm91bmQgb24gc3RhY2suIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIGNvbnRleHQsIGZpYmVyKTsKICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRDaGFuZ2UsIGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgdHlwZSwgcGFyZW50Q29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHRUeXBlcyA9IHR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIXdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dFtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgICB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHRbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXMuY2hpbGRDb250ZXh0VHlwZXMgaXMgc3BlY2lmaWVkIGJ1dCB0aGVyZSBpcyBubyBnZXRDaGlsZENvbnRleHQoKSBtZXRob2Qgb24gdGhlIGluc3RhbmNlLiBZb3UgY2FuIGVpdGhlciBkZWZpbmUgZ2V0Q2hpbGRDb250ZXh0KCkgb24gJXMgb3IgcmVtb3ZlIGNoaWxkQ29udGV4dFR5cGVzIGZyb20gaXQuIiwgY29tcG9uZW50TmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHQgPSBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQoKTsKICAgICAgICAgICAgZm9yICh2YXIgY29udGV4dEtleSBpbiBjaGlsZENvbnRleHQpIHsKICAgICAgICAgICAgICBpZiAoIShjb250ZXh0S2V5IGluIGNoaWxkQ29udGV4dFR5cGVzKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biIpICsgJy5nZXRDaGlsZENvbnRleHQoKToga2V5ICInICsgY29udGV4dEtleSArICciIGlzIG5vdCBkZWZpbmVkIGluIGNoaWxkQ29udGV4dFR5cGVzLicpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoY2hpbGRDb250ZXh0VHlwZXMsIGNoaWxkQ29udGV4dCwgImNoaWxkIGNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcGFyZW50Q29udGV4dCwgY2hpbGRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgfHwgZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgICBwcmV2aW91c0NvbnRleHQgPSBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBkaWRDaGFuZ2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gaGF2ZSBhbiBpbnN0YW5jZSBieSB0aGlzIHBvaW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRDaGFuZ2UpIHsKICAgICAgICAgICAgICB2YXIgbWVyZ2VkQ29udGV4dCA9IHByb2Nlc3NDaGlsZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBwcmV2aW91c0NvbnRleHQpOwogICAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gbWVyZ2VkQ29udGV4dDsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZXJnZWRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50VW5tYXNrZWRDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNGaWJlck1vdW50ZWQoZmliZXIpIHx8IGZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHN1YnRyZWUgcGFyZW50IHRvIGJlIGEgbW91bnRlZCBjbGFzcyBjb21wb25lbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5jb250ZXh0OwogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gbm9kZS50eXBlOwogICAgICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChub2RlICE9PSBudWxsKTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGb3VuZCB1bmV4cGVjdGVkIGRldGFjaGVkIHN1YnRyZWUgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTGVnYWN5Um9vdCA9IDA7CiAgICAgICAgdmFyIENvbmN1cnJlbnRSb290ID0gMTsKICAgICAgICB2YXIgc3luY1F1ZXVlID0gbnVsbDsKICAgICAgICB2YXIgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgaWYgKHN5bmNRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBzeW5jUXVldWUgPSBbY2FsbGJhY2tdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3luY1F1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gdHJ1ZTsKICAgICAgICAgIHNjaGVkdWxlU3luY0NhbGxiYWNrKGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpIHsKICAgICAgICAgIGlmIChpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MpIHsKICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrcygpIHsKICAgICAgICAgIGlmICghaXNGbHVzaGluZ1N5bmNRdWV1ZSAmJiBzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1N5bmNRdWV1ZSA9IHRydWU7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzVXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgaXNTeW5jID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBzeW5jUXVldWU7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2soaXNTeW5jKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3luY1F1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgaWYgKHN5bmNRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3luY1F1ZXVlID0gc3luY1F1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayhJbW1lZGlhdGVQcmlvcml0eSwgZmx1c2hTeW5jQ2FsbGJhY2tzKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlUHJpb3JpdHkpOwogICAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBmb3JrU3RhY2sgPSBbXTsKICAgICAgICB2YXIgZm9ya1N0YWNrSW5kZXggPSAwOwogICAgICAgIHZhciB0cmVlRm9ya1Byb3ZpZGVyID0gbnVsbDsKICAgICAgICB2YXIgdHJlZUZvcmtDb3VudCA9IDA7CiAgICAgICAgdmFyIGlkU3RhY2sgPSBbXTsKICAgICAgICB2YXIgaWRTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUNvbnRleHRQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0SWQgPSAxOwogICAgICAgIHZhciB0cmVlQ29udGV4dE92ZXJmbG93ID0gIiI7CiAgICAgICAgZnVuY3Rpb24gaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgcmV0dXJuICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JrZWQpICE9PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGb3Jrc0F0TGV2ZWwod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiB0cmVlRm9ya0NvdW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmVlSWQoKSB7CiAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgdmFyIGlkID0gaWRXaXRoTGVhZGluZ0JpdCAmIH5nZXRMZWFkaW5nQml0KGlkV2l0aExlYWRpbmdCaXQpOwogICAgICAgICAgcmV0dXJuIGlkLnRvU3RyaW5nKDMyKSArIG92ZXJmbG93OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCB0b3RhbENoaWxkcmVuKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleCsrXSA9IHRyZWVGb3JrQ291bnQ7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya1Byb3ZpZGVyOwogICAgICAgICAgdHJlZUZvcmtQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHRyZWVGb3JrQ291bnQgPSB0b3RhbENoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbiwgaW5kZXgyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRQcm92aWRlcjsKICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgYmFzZUlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgdmFyIGJhc2VPdmVyZmxvdyA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICB2YXIgYmFzZUxlbmd0aCA9IGdldEJpdExlbmd0aChiYXNlSWRXaXRoTGVhZGluZ0JpdCkgLSAxOwogICAgICAgICAgdmFyIGJhc2VJZCA9IGJhc2VJZFdpdGhMZWFkaW5nQml0ICYgfigxIDw8IGJhc2VMZW5ndGgpOwogICAgICAgICAgdmFyIHNsb3QgPSBpbmRleDIgKyAxOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIGJhc2VMZW5ndGg7CiAgICAgICAgICBpZiAobGVuZ3RoID4gMzApIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mT3ZlcmZsb3dCaXRzID0gYmFzZUxlbmd0aCAtIGJhc2VMZW5ndGggJSA1OwogICAgICAgICAgICB2YXIgbmV3T3ZlcmZsb3dCaXRzID0gKDEgPDwgbnVtYmVyT2ZPdmVyZmxvd0JpdHMpIC0gMTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93ID0gKGJhc2VJZCAmIG5ld092ZXJmbG93Qml0cykudG9TdHJpbmcoMzIpOwogICAgICAgICAgICB2YXIgcmVzdE9mQmFzZUlkID0gYmFzZUlkID4+IG51bWJlck9mT3ZlcmZsb3dCaXRzOwogICAgICAgICAgICB2YXIgcmVzdE9mQmFzZUxlbmd0aCA9IGJhc2VMZW5ndGggLSBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIHJlc3RPZkJhc2VMZW5ndGg7CiAgICAgICAgICAgIHZhciByZXN0T2ZOZXdCaXRzID0gc2xvdCA8PCByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgaWQgPSByZXN0T2ZOZXdCaXRzIHwgcmVzdE9mQmFzZUlkOwogICAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSBuZXdPdmVyZmxvdyArIGJhc2VPdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgcmVzdE9mTGVuZ3RoIHwgaWQ7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBvdmVyZmxvdzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXdCaXRzID0gc2xvdCA8PCBiYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgX2lkID0gbmV3Qml0cyB8IGJhc2VJZDsKICAgICAgICAgICAgdmFyIF9vdmVyZmxvdyA9IGJhc2VPdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgbGVuZ3RoIHwgX2lkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gX292ZXJmbG93OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gMTsKICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IDA7CiAgICAgICAgICAgIHB1c2hUcmVlRm9yayh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcywgc2xvdEluZGV4KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Qml0TGVuZ3RoKG51bWJlcjQpIHsKICAgICAgICAgIHJldHVybiAzMiAtIGNsejMyKG51bWJlcjQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMZWFkaW5nQml0KGlkKSB7CiAgICAgICAgICByZXR1cm4gMSA8PCBnZXRCaXRMZW5ndGgoaWQpIC0gMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wVHJlZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlRm9ya1Byb3ZpZGVyKSB7CiAgICAgICAgICAgIHRyZWVGb3JrUHJvdmlkZXIgPSBmb3JrU3RhY2tbLS1mb3JrU3RhY2tJbmRleF07CiAgICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlRm9ya0NvdW50ID0gZm9ya1N0YWNrWy0tZm9ya1N0YWNrSW5kZXhdOwogICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzczIgPT09IHRyZWVDb250ZXh0UHJvdmlkZXIpIHsKICAgICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuZGVkVHJlZUNvbnRleHQoKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGlmICh0cmVlQ29udGV4dFByb3ZpZGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgaWQ6IHRyZWVDb250ZXh0SWQsCiAgICAgICAgICAgICAgb3ZlcmZsb3c6IHRyZWVDb250ZXh0T3ZlcmZsb3cKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3VzcGVuZGVkVHJlZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5kZWRDb250ZXh0KSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRQcm92aWRlcjsKICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSBzdXNwZW5kZWRDb250ZXh0LmlkOwogICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IHN1c3BlbmRlZENvbnRleHQub3ZlcmZsb3c7CiAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZOb3RIeWRyYXRpbmcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBiZSBoeWRyYXRpbmcuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBoeWRyYXRpb25QYXJlbnRGaWJlciA9IG51bGw7CiAgICAgICAgdmFyIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgIHZhciBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgIHZhciBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHdhcm5JZkh5ZHJhdGluZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgICAgZXJyb3IoIldlIHNob3VsZCBub3QgYmUgaHlkcmF0aW5nIGhlcmUuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGEgYnVnLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZFN1c3BlbmRPckVycm9yV2hpbGVIeWRyYXRpbmdERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50ZXJIeWRyYXRpb25TdGF0ZShmaWJlcikgewogICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5Db250YWluZXIocGFyZW50SW5zdGFuY2UpOwogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW50ZXJIeWRyYXRpb25TdGF0ZUZyb21EZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlciwgc3VzcGVuc2VJbnN0YW5jZSwgdHJlZUNvbnRleHQpIHsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpblN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgICBpZiAodHJlZUNvbnRleHQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmVzdG9yZVN1c3BlbmRlZFRyZWVDb250ZXh0KGZpYmVyLCB0cmVlQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FyblVuaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChyZXR1cm5GaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocmV0dXJuRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8sIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgcmV0dXJuRmliZXIudHlwZSwKICAgICAgICAgICAgICAgICAgcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wcywKICAgICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuc3RhdGVOb2RlLAogICAgICAgICAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHJldHVybkZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShyZXR1cm5GaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKTsKICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3JlYXRlRmliZXJGcm9tSG9zdEluc3RhbmNlRm9yRGVsZXRpb24oKTsKICAgICAgICAgIGNoaWxkVG9EZWxldGUuc3RhdGVOb2RlID0gaW5zdGFuY2U7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHJldHVybkZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2NoaWxkVG9EZWxldGVdOwogICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkU3VzcGVuZE9yRXJyb3JERVYpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoIChyZXR1cm5GaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50Q29udGFpbmVyID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRQcm9wcyA9IHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3R5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciBfcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIF90eXBlLAogICAgICAgICAgICAgICAgICAgICAgX3Byb3BzLAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3RleHQgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFR5cGUsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgICAgX3RleHQsCiAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgICAgX2lzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIF9wYXJlbnRJbnN0YW5jZSA9IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICAgIGlmIChfcGFyZW50SW5zdGFuY2UgIT09IG51bGwpIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICB2YXIgX3R5cGUyID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzMiA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShfcGFyZW50SW5zdGFuY2UsIF90eXBlMik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0MiA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdGV4dDIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIGZpYmVyLmZsYWdzID0gZmliZXIuZmxhZ3MgJiB+SHlkcmF0aW5nIHwgUGxhY2VtZW50OwogICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNhbkh5ZHJhdGVJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHR5cGUpOwogICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciB0ZXh0SW5zdGFuY2UgPSBjYW5IeWRyYXRlVGV4dEluc3RhbmNlKG5leHRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgICAgICAgaWYgKHRleHRJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gdGV4dEluc3RhbmNlOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBjYW5IeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHsKICAgICAgICAgICAgICAgICAgZGVoeWRyYXRlZDogc3VzcGVuc2VJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgdHJlZUNvbnRleHQ6IGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCksCiAgICAgICAgICAgICAgICAgIHJldHJ5TGFuZTogT2Zmc2NyZWVuTGFuZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkU3RhdGUgPSBzdXNwZW5zZVN0YXRlOwogICAgICAgICAgICAgICAgdmFyIGRlaHlkcmF0ZWRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbURlaHlkcmF0ZWRGcmFnbWVudChzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWRGcmFnbWVudC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICAgIGZpYmVyLmNoaWxkID0gZGVoeWRyYXRlZEZyYWdtZW50OwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikgewogICAgICAgICAgcmV0dXJuIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUgJiYgKGZpYmVyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93T25IeWRyYXRpb25NaXNtYXRjaChmaWJlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJIeWRyYXRpb24gZmFpbGVkIGJlY2F1c2UgdGhlIGluaXRpYWwgVUkgZG9lcyBub3QgbWF0Y2ggd2hhdCB3YXMgcmVuZGVyZWQgb24gdGhlIHNlcnZlci4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIGlmICghaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICBpZiAoIW5leHRJbnN0YW5jZSkgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIHRocm93T25IeWRyYXRpb25NaXNtYXRjaCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UgPSBuZXh0SW5zdGFuY2U7CiAgICAgICAgICBpZiAoIXRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSk7CiAgICAgICAgICAgIHZhciBwcmV2SHlkcmF0aW9uUGFyZW50RmliZXIgPSBoeWRyYXRpb25QYXJlbnRGaWJlcjsKICAgICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UgfHwgIXRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocHJldkh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaXJzdEF0dGVtcHRlZEluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvSHlkcmF0ZUhvc3RJbnN0YW5jZShmaWJlciwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHNob3VsZFdhcm5JZk1pc21hdGNoRGV2ID0gIWRpZFN1c3BlbmRPckVycm9yREVWOwogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBoeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIGZpYmVyLnR5cGUsIGZpYmVyLm1lbW9pemVkUHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGZpYmVyLCBzaG91bGRXYXJuSWZNaXNtYXRjaERldik7CiAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIHZhciB0ZXh0SW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgdGV4dENvbnRlbnQgPSBmaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGh5ZHJhdGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlLCB0ZXh0Q29udGVudCwgZmliZXIpOwogICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSBoeWRyYXRpb25QYXJlbnRGaWJlcjsKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChyZXR1cm5GaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgIGRpZE5vdE1hdGNoSHlkcmF0ZWRDb250YWluZXJUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgcGFyZW50Q29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFR5cGUgPSByZXR1cm5GaWJlci50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHZhciBfaXNDb25jdXJyZW50TW9kZTIgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgIHBhcmVudFR5cGUsCiAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRDb250ZW50LAogICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgX2lzQ29uY3VycmVudE1vZGUyCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvSHlkcmF0ZUhvc3RTdXNwZW5zZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IHN1c3BlbnNlU3RhdGUgIT09IG51bGwgPyBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgOiBudWxsOwogICAgICAgICAgaWYgKCFzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gaGF2ZSBhIGh5ZHJhdGVkIHN1c3BlbnNlIGluc3RhbmNlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgaHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBza2lwUGFzdERlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IHN1c3BlbnNlU3RhdGUgIT09IG51bGwgPyBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgOiBudWxsOwogICAgICAgICAgaWYgKCFzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gaGF2ZSBhIGh5ZHJhdGVkIHN1c3BlbnNlIGluc3RhbmNlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlSW5zdGFuY2VBZnRlclN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsICYmIHBhcmVudC50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgcGFyZW50LnRhZyAhPT0gSG9zdFJvb3QgJiYgcGFyZW50LnRhZyAhPT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gcGFyZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIeWRyYXRpb25TdGF0ZShmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyICE9PSBoeWRyYXRpb25QYXJlbnRGaWJlcikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IEhvc3RSb290ICYmIChmaWJlci50YWcgIT09IEhvc3RDb21wb25lbnQgfHwgc2hvdWxkRGVsZXRlVW5oeWRyYXRlZFRhaWxJbnN0YW5jZXMoZmliZXIudHlwZSkgJiYgIXNob3VsZFNldFRleHRDb250ZW50KGZpYmVyLnR5cGUsIGZpYmVyLm1lbW9pemVkUHJvcHMpKSkgewogICAgICAgICAgICB2YXIgbmV4dEluc3RhbmNlID0gbmV4dEh5ZHJhdGFibGVJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKG5leHRJbnN0YW5jZSkgewogICAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgICAgd2FybklmVW5oeWRyYXRlZFRhaWxOb2RlcyhmaWJlcik7CiAgICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd2hpbGUgKG5leHRJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgICBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcik7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gc2tpcFBhc3REZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gaHlkcmF0aW9uUGFyZW50RmliZXIgPyBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoZmliZXIuc3RhdGVOb2RlKSA6IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVW5oeWRyYXRlZFRhaWxOb2RlcygpIHsKICAgICAgICAgIHJldHVybiBpc0h5ZHJhdGluZyAmJiBuZXh0SHlkcmF0YWJsZUluc3RhbmNlICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbmV4dEluc3RhbmNlID0gbmV4dEh5ZHJhdGFibGVJbnN0YW5jZTsKICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgd2FyblVuaHlkcmF0ZWRJbnN0YW5jZShmaWJlciwgbmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKG5leHRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0SHlkcmF0aW9uU3RhdGUoKSB7CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IG51bGw7CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGdyYWRlSHlkcmF0aW9uRXJyb3JzVG9SZWNvdmVyYWJsZSgpIHsKICAgICAgICAgIGlmIChoeWRyYXRpb25FcnJvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWVSZWNvdmVyYWJsZUVycm9ycyhoeWRyYXRpb25FcnJvcnMpOwogICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRJc0h5ZHJhdGluZygpIHsKICAgICAgICAgIHJldHVybiBpc0h5ZHJhdGluZzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcXVldWVIeWRyYXRpb25FcnJvcihlcnJvcjIpIHsKICAgICAgICAgIGlmIChoeWRyYXRpb25FcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gW2Vycm9yMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMucHVzaChlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgIHZhciBOb1RyYW5zaXRpb24gPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RDdXJyZW50VHJhbnNpdGlvbigpIHsKICAgICAgICAgIHJldHVybiBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQxLnRyYW5zaXRpb247CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncyA9IHsKICAgICAgICAgIHJlY29yZFVuc2FmZUxpZmVjeWNsZVdhcm5pbmdzOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBmbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5nczogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9LAogICAgICAgICAgcmVjb3JkTGVnYWN5Q29udGV4dFdhcm5pbmc6IGZ1bmN0aW9uKGZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgfSwKICAgICAgICAgIGZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfSwKICAgICAgICAgIGRpc2NhcmRQZW5kaW5nV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGZpbmRTdHJpY3RSb290ID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgdmFyIG1heWJlU3RyaWN0Um9vdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIG1heWJlU3RyaWN0Um9vdCA9IG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF5YmVTdHJpY3RSb290OwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBzZXRUb1NvcnRlZFN0cmluZyA9IGZ1bmN0aW9uKHNldDQpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgIHNldDQuZm9yRWFjaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGFycmF5LnB1c2godmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGFycmF5LnNvcnQoKS5qb2luKCIsICIpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyA9IGZ1bmN0aW9uKGZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgJiYgLy8gRG9uJ3Qgd2FybiBhYm91dCByZWFjdC1saWZlY3ljbGVzLWNvbXBhdCBwb2x5ZmlsbGVkIGNvbXBvbmVudHMuCiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudC5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlICYmIHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgc29ydGVkTmFtZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogSWYgeW91J3JlIHVwZGF0aW5nIHN0YXRlIHdoZW5ldmVyIHByb3BzIGNoYW5nZSwgcmVmYWN0b3IgeW91ciBjb2RlIHRvIHVzZSBtZW1vaXphdGlvbiB0ZWNobmlxdWVzIG9yIG1vdmUgaXQgdG8gc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gTGVhcm4gbW9yZSBhdDogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rlcml2ZWQtc3RhdGVcblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMyID0gc2V0VG9Tb3J0ZWRTdHJpbmcoVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMyA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB3YXJuMygiY29tcG9uZW50V2lsbE1vdW50IGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBjb2RlIHdpdGggc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZE1vdW50LCBhbmQgc2V0IGluaXRpYWwgc3RhdGUgaW4gdGhlIGNvbnN0cnVjdG9yLlxuKiBSZW5hbWUgY29tcG9uZW50V2lsbE1vdW50IHRvIFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXM0ID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB3YXJuMygiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG4qIFJlbmFtZSBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIHRvIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNSA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxVcGRhdGUgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBSZW5hbWUgY29tcG9uZW50V2lsbFVwZGF0ZSB0byBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXM1KTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkTGVnYWN5Q29udGV4dFdhcm5pbmcgPSBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIHN0cmljdFJvb3QgPSBmaW5kU3RyaWN0Um9vdChmaWJlcik7CiAgICAgICAgICAgIGlmIChzdHJpY3RSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgYSBTdHJpY3RNb2RlIGNvbXBvbmVudCBpbiBhIHN0cmljdCBtb2RlIHRyZWUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0LmhhcyhmaWJlci50eXBlKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgd2FybmluZ3NGb3JSb290ID0gcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nLmdldChzdHJpY3RSb290KTsKICAgICAgICAgICAgaWYgKGZpYmVyLnR5cGUuY29udGV4dFR5cGVzICE9IG51bGwgfHwgZmliZXIudHlwZS5jaGlsZENvbnRleHRUeXBlcyAhPSBudWxsIHx8IGluc3RhbmNlICE9PSBudWxsICYmIHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAod2FybmluZ3NGb3JSb290ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHdhcm5pbmdzRm9yUm9vdCA9IFtdOwogICAgICAgICAgICAgICAgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nLnNldChzdHJpY3RSb290LCB3YXJuaW5nc0ZvclJvb3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyQXJyYXksIHN0cmljdFJvb3QpIHsKICAgICAgICAgICAgICBpZiAoZmliZXJBcnJheS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZpcnN0RmliZXIgPSBmaWJlckFycmF5WzBdOwogICAgICAgICAgICAgIHZhciB1bmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgZmliZXJBcnJheS5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICB1bmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdmFyIHNvcnRlZE5hbWVzID0gc2V0VG9Tb3J0ZWRTdHJpbmcodW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmlyc3RGaWJlcik7CiAgICAgICAgICAgICAgICBlcnJvcigiTGVnYWN5IGNvbnRleHQgQVBJIGhhcyBiZWVuIGRldGVjdGVkIHdpdGhpbiBhIHN0cmljdC1tb2RlIHRyZWUuXG5cblRoZSBvbGQgQVBJIHdpbGwgYmUgc3VwcG9ydGVkIGluIGFsbCAxNi54IHJlbGVhc2VzLCBidXQgYXBwbGljYXRpb25zIHVzaW5nIGl0IHNob3VsZCBtaWdyYXRlIHRvIHRoZSBuZXcgdmVyc2lvbi5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzXG5cbkxlYXJuIG1vcmUgYWJvdXQgdGhpcyB3YXJuaW5nIGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9sZWdhY3ktY29udGV4dCIsIHNvcnRlZE5hbWVzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmRpc2NhcmRQZW5kaW5nV2FybmluZ3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TWFwczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0R2VuZXJhdG9yczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nOwogICAgICAgIHZhciBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmc7CiAgICAgICAgdmFyIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gZmFsc2U7CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZW5lcmF0b3JzID0gZmFsc2U7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmcgPSB7fTsKICAgICAgICAgIG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZyA9IHt9OwogICAgICAgICAgd2FybkZvck1pc3NpbmdLZXkgPSBmdW5jdGlvbihjaGlsZCwgcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgaWYgKGNoaWxkID09PSBudWxsIHx8IHR5cGVvZiBjaGlsZCAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjaGlsZC5fc3RvcmUgfHwgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCB8fCBjaGlsZC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkLl9zdG9yZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0IENvbXBvbmVudCBpbiB3YXJuRm9yTWlzc2luZ0tleSBzaG91bGQgaGF2ZSBhIF9zdG9yZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHJldHVybkZpYmVyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcignRWFjaCBjaGlsZCBpbiBhIGxpc3Qgc2hvdWxkIGhhdmUgYSB1bmlxdWUgImtleSIgcHJvcC4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJyk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlYWN0Q2xhc3ModHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUucHJvdG90eXBlICYmIHR5cGUucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQpIHsKICAgICAgICAgIHZhciBtaXhlZFJlZiA9IGVsZW1lbnQucmVmOwogICAgICAgICAgaWYgKG1peGVkUmVmICE9PSBudWxsICYmIHR5cGVvZiBtaXhlZFJlZiAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoKHJldHVybkZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlIHx8IHdhcm5BYm91dFN0cmluZ1JlZnMpICYmIC8vIFdlIHdhcm4gaW4gUmVhY3RFbGVtZW50LmpzIGlmIG93bmVyIGFuZCBzZWxmIGFyZSBlcXVhbCBmb3Igc3RyaW5nIHJlZnMKICAgICAgICAgICAgICAvLyBiZWNhdXNlIHRoZXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbgogICAgICAgICAgICAgIC8vIHVzaW5nIGEgY29kZW1vZC4gVGhlcmVmb3JlLCB3ZSBkb24ndCBoYXZlIHRvIHdhcm4gYWJvdXQgc3RyaW5nIHJlZnMgYWdhaW4uCiAgICAgICAgICAgICAgIShlbGVtZW50Ll9vd25lciAmJiBlbGVtZW50Ll9zZWxmICYmIGVsZW1lbnQuX293bmVyLnN0YXRlTm9kZSAhPT0gZWxlbWVudC5fc2VsZikgJiYgLy8gV2lsbCBhbHJlYWR5IHRocm93IHdpdGggIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGhhdmUgc3RyaW5nIHJlZnMiCiAgICAgICAgICAgICAgIShlbGVtZW50Ll9vd25lciAmJiBlbGVtZW50Ll9vd25lci50YWcgIT09IENsYXNzQ29tcG9uZW50KSAmJiAvLyBXaWxsIGFscmVhZHkgd2FybiB3aXRoICJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBiZSBnaXZlbiByZWZzIgogICAgICAgICAgICAgICEodHlwZW9mIGVsZW1lbnQudHlwZSA9PT0gImZ1bmN0aW9uIiAmJiAhaXNSZWFjdENsYXNzKGVsZW1lbnQudHlwZSkpICYmIC8vIFdpbGwgYWxyZWFkeSB0aHJvdyB3aXRoICJFbGVtZW50IHJlZiB3YXMgc3BlY2lmaWVkIGFzIGEgc3RyaW5nIChzb21lU3RyaW5nUmVmKSBidXQgbm8gb3duZXIgd2FzIHNldCIKICAgICAgICAgICAgICBlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHJldHVybkZpYmVyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJ0NvbXBvbmVudCAiJXMiIGNvbnRhaW5zIHRoZSBzdHJpbmcgcmVmICIlcyIuIFN1cHBvcnQgZm9yIHN0cmluZyByZWZzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgb3IgY3JlYXRlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZicsIGNvbXBvbmVudE5hbWUsIG1peGVkUmVmKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVsZW1lbnQuX293bmVyKSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIGluc3Q7CiAgICAgICAgICAgICAgaWYgKG93bmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgb3duZXJGaWJlciA9IG93bmVyOwogICAgICAgICAgICAgICAgaWYgKG93bmVyRmliZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGhhdmUgc3RyaW5nIHJlZnMuIFdlIHJlY29tbWVuZCB1c2luZyB1c2VSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbnN0ID0gb3duZXJGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghaW5zdCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIG93bmVyIGZvciBzdHJpbmcgcmVmICIgKyBtaXhlZFJlZiArICIuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZXNvbHZlZEluc3QgPSBpbnN0OwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFN0cmluZ0NvZXJjaW9uKG1peGVkUmVmLCAicmVmIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHJpbmdSZWYgPSAiIiArIG1peGVkUmVmOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5yZWYgIT09IG51bGwgJiYgdHlwZW9mIGN1cnJlbnQ0LnJlZiA9PT0gImZ1bmN0aW9uIiAmJiBjdXJyZW50NC5yZWYuX3N0cmluZ1JlZiA9PT0gc3RyaW5nUmVmKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudDQucmVmOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVmID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciByZWZzID0gcmVzb2x2ZWRJbnN0LnJlZnM7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlIHJlZnNbc3RyaW5nUmVmXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlZnNbc3RyaW5nUmVmXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgcmVmLl9zdHJpbmdSZWYgPSBzdHJpbmdSZWY7CiAgICAgICAgICAgICAgcmV0dXJuIHJlZjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG1peGVkUmVmICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCByZWYgdG8gYmUgYSBmdW5jdGlvbiwgYSBzdHJpbmcsIGFuIG9iamVjdCByZXR1cm5lZCBieSBSZWFjdC5jcmVhdGVSZWYoKSwgb3IgbnVsbC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbGVtZW50IHJlZiB3YXMgc3BlY2lmaWVkIGFzIGEgc3RyaW5nICgiICsgbWl4ZWRSZWYgKyAiKSBidXQgbm8gb3duZXIgd2FzIHNldC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWF5IGJlIGFkZGluZyBhIHJlZiB0byBhIGZ1bmN0aW9uIGNvbXBvbmVudFxuMi4gWW91IG1heSBiZSBhZGRpbmcgYSByZWYgdG8gYSBjb21wb25lbnQgdGhhdCB3YXMgbm90IGNyZWF0ZWQgaW5zaWRlIGEgY29tcG9uZW50J3MgcmVuZGVyIG1ldGhvZFxuMy4gWW91IGhhdmUgbXVsdGlwbGUgY29waWVzIG9mIFJlYWN0IGxvYWRlZFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWZzLW11c3QtaGF2ZS1vd25lciBmb3IgbW9yZSBpbmZvcm1hdGlvbi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtaXhlZFJlZjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCkgewogICAgICAgICAgdmFyIGNoaWxkU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG5ld0NoaWxkKTsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT2JqZWN0cyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQgKGZvdW5kOiAiICsgKGNoaWxkU3RyaW5nID09PSAiW29iamVjdCBPYmplY3RdIiA/ICJvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMobmV3Q2hpbGQpLmpvaW4oIiwgIikgKyAifSIgOiBjaGlsZFN0cmluZykgKyAiKS4gSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIGNvbGxlY3Rpb24gb2YgY2hpbGRyZW4sIHVzZSBhbiBhcnJheSBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHJldHVybkZpYmVyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgaWYgKG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZ1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRnVuY3Rpb25zIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZC4gVGhpcyBtYXkgaGFwcGVuIGlmIHlvdSByZXR1cm4gYSBDb21wb25lbnQgaW5zdGVhZCBvZiA8Q29tcG9uZW50IC8+IGZyb20gcmVuZGVyLiBPciBtYXliZSB5b3UgbWVhbnQgdG8gY2FsbCB0aGlzIGZ1bmN0aW9uIHJhdGhlciB0aGFuIHJldHVybiBpdC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUxhenkobGF6eVR5cGUpIHsKICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eVR5cGUuX3BheWxvYWQ7CiAgICAgICAgICB2YXIgaW5pdCA9IGxhenlUeXBlLl9pbml0OwogICAgICAgICAgcmV0dXJuIGluaXQocGF5bG9hZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIENoaWxkUmVjb25jaWxlcihzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICBmdW5jdGlvbiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGRUb0RlbGV0ZSkgewogICAgICAgICAgICBpZiAoIXNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHJldHVybkZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjaGlsZFRvRGVsZXRlXTsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkVG9EZWxldGUgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkVG9EZWxldGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICAgICAgY2hpbGRUb0RlbGV0ZSA9IGNoaWxkVG9EZWxldGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCkgewogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChleGlzdGluZ0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2hpbGQua2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLnNldChleGlzdGluZ0NoaWxkLmtleSwgZXhpc3RpbmdDaGlsZCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uc2V0KGV4aXN0aW5nQ2hpbGQuaW5kZXgsIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkID0gZXhpc3RpbmdDaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBleGlzdGluZ0NoaWxkcmVuOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXNlRmliZXIoZmliZXIsIHBlbmRpbmdQcm9wcykgewogICAgICAgICAgICB2YXIgY2xvbmUgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhmaWJlciwgcGVuZGluZ1Byb3BzKTsKICAgICAgICAgICAgY2xvbmUuaW5kZXggPSAwOwogICAgICAgICAgICBjbG9uZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGNsb25lOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJbmRleCkgewogICAgICAgICAgICBuZXdGaWJlci5pbmRleCA9IG5ld0luZGV4OwogICAgICAgICAgICBpZiAoIXNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBuZXdGaWJlci5mbGFncyB8PSBGb3JrZWQ7CiAgICAgICAgICAgICAgcmV0dXJuIGxhc3RQbGFjZWRJbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBuZXdGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBvbGRJbmRleCA9IGN1cnJlbnQ0LmluZGV4OwogICAgICAgICAgICAgIGlmIChvbGRJbmRleCA8IGxhc3RQbGFjZWRJbmRleCkgewogICAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIGxhc3RQbGFjZWRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG9sZEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXdGaWJlci5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgICAgcmV0dXJuIGxhc3RQbGFjZWRJbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGxhY2VTaW5nbGVDaGlsZChuZXdGaWJlcikgewogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cyAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXdGaWJlci5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ld0ZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCB0ZXh0Q29udGVudCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQodGV4dENvbnRlbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQ0LCB0ZXh0Q29udGVudCk7CiAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICBpZiAoZWxlbWVudFR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudC5wcm9wcy5jaGlsZHJlbiwgbGFuZXMsIGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQuZWxlbWVudFR5cGUgPT09IGVsZW1lbnRUeXBlIHx8IC8vIEtlZXAgdGhpcyBjaGVjayBpbmxpbmUgc28gaXQgb25seSBydW5zIG9uIHRoZSBmYWxzZSBwYXRoOgogICAgICAgICAgICAgIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhjdXJyZW50NCwgZWxlbWVudCkgfHwgLy8gTGF6eSB0eXBlcyBzaG91bGQgcmVjb25jaWxlIHRoZWlyIHJlc29sdmVkIHR5cGUuCiAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBkbyB0aGlzIGFmdGVyIHRoZSBIb3QgUmVsb2FkaW5nIGNoZWNrIGFib3ZlLAogICAgICAgICAgICAgIC8vIGJlY2F1c2UgaG90IHJlbG9hZGluZyBoYXMgZGlmZmVyZW50IHNlbWFudGljcyB0aGFuIHByb2QgYmVjYXVzZQogICAgICAgICAgICAgIC8vIGl0IGRvZXNuJ3QgcmVzdXNwZW5kLiBTbyB3ZSBjYW4ndCBsZXQgdGhlIGNhbGwgYmVsb3cgc3VzcGVuZC4KICAgICAgICAgICAgICB0eXBlb2YgZWxlbWVudFR5cGUgPT09ICJvYmplY3QiICYmIGVsZW1lbnRUeXBlICE9PSBudWxsICYmIGVsZW1lbnRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgJiYgcmVzb2x2ZUxhenkoZWxlbWVudFR5cGUpID09PSBjdXJyZW50NC50eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50KTsKICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudCk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBjdXJyZW50NCwgcG9ydGFsLCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQudGFnICE9PSBIb3N0UG9ydGFsIHx8IGN1cnJlbnQ0LnN0YXRlTm9kZS5jb250YWluZXJJbmZvICE9PSBwb3J0YWwuY29udGFpbmVySW5mbyB8fCBjdXJyZW50NC5zdGF0ZU5vZGUuaW1wbGVtZW50YXRpb24gIT09IHBvcnRhbC5pbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIHBvcnRhbC5jaGlsZHJlbiB8fCBbXSk7CiAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBmcmFnbWVudCwgbGFuZXMsIGtleSkgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQudGFnICE9PSBGcmFnbWVudDEwKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmcmFnbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgZnJhZ21lbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCgiIiArIG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBudWxsLCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDIgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQyLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDMgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgICAgX2NyZWF0ZWQzLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gb2xkRmliZXIgIT09IG51bGwgPyBvbGRGaWJlci5rZXkgOiBudWxsOwogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmIChrZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG9sZEZpYmVyLCAiIiArIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoZWRGaWJlciA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG1hdGNoZWRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX21hdGNoZWRGaWJlcjIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIzID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjMsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiIHx8IGNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5KGNoaWxkLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBjaGlsZC5rZXk7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChrbm93bktleXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIWtub3duS2V5cy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvcigiRW5jb3VudGVyZWQgdHdvIGNoaWxkcmVuIHdpdGggdGhlIHNhbWUga2V5LCBgJXNgLiBLZXlzIHNob3VsZCBiZSB1bmlxdWUgc28gdGhhdCBjb21wb25lbnRzIG1haW50YWluIHRoZWlyIGlkZW50aXR5IGFjcm9zcyB1cGRhdGVzLiBOb24tdW5pcXVlIGtleXMgbWF5IGNhdXNlIGNoaWxkcmVuIHRvIGJlIGR1cGxpY2F0ZWQgYW5kL29yIG9taXR0ZWQgXHUyMDE0IHRoZSBiZWhhdmlvciBpcyB1bnN1cHBvcnRlZCBhbmQgY291bGQgY2hhbmdlIGluIGEgZnV0dXJlIHZlcnNpb24uIiwga2V5KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBjaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBjaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZEtleShpbml0KHBheWxvYWQpLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBrbm93bktleXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGRyZW4sIGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIga25vd25LZXlzID0gbnVsbDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXdDaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIG9sZEZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBsYXN0UGxhY2VkSW5kZXggPSAwOwogICAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgICAgdmFyIG5leHRPbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV3SWR4ID09PSBuZXdDaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAoOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXIyID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjIua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyMi5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczIgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuSXRlcmFibGUsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBvYmplY3QgaXMgbm90IGFuIGl0ZXJhYmxlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiAvLyAkRmxvd0ZpeE1lIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IHRvU3RyaW5nVGFnCiAgICAgICAgICAgICAgbmV3Q2hpbGRyZW5JdGVyYWJsZVtTeW1ib2wudG9TdHJpbmdUYWddID09PSAiR2VuZXJhdG9yIikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZW5lcmF0b3JzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVc2luZyBHZW5lcmF0b3JzIGFzIGNoaWxkcmVuIGlzIHVuc3VwcG9ydGVkIGFuZCB3aWxsIGxpa2VseSB5aWVsZCB1bmV4cGVjdGVkIHJlc3VsdHMgYmVjYXVzZSBlbnVtZXJhdGluZyBhIGdlbmVyYXRvciBtdXRhdGVzIGl0LiBZb3UgbWF5IGNvbnZlcnQgaXQgdG8gYW4gYXJyYXkgd2l0aCBgQXJyYXkuZnJvbSgpYCBvciB0aGUgYFsuLi5zcHJlYWRdYCBvcGVyYXRvciBiZWZvcmUgcmVuZGVyaW5nLiBLZWVwIGluIG1pbmQgeW91IG1pZ2h0IG5lZWQgdG8gcG9seWZpbGwgdGhlc2UgZmVhdHVyZXMgZm9yIG9sZGVyIGJyb3dzZXJzLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbkl0ZXJhYmxlLmVudHJpZXMgPT09IGl0ZXJhdG9yRm4pIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyBub3Qgc3VwcG9ydGVkLiBVc2UgYW4gYXJyYXkgb2Yga2V5ZWQgUmVhY3RFbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgICAgaWYgKF9uZXdDaGlsZHJlbikgewogICAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpOwogICAgICAgICAgICAgICAgZm9yICg7ICFfc3RlcC5kb25lOyBfc3RlcCA9IF9uZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gX3N0ZXAudmFsdWU7CiAgICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBpdGVyYWJsZSBvYmplY3QgcHJvdmlkZWQgbm8gaXRlcmF0b3IuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgZm9yICg7IG9sZEZpYmVyICE9PSBudWxsICYmICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RlcC5kb25lKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIzID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIzLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczMgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzMyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjQgPSB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyNCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5kZWxldGUoX25ld0ZpYmVyNC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXI0LmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyNCwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZDIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzNCA9IG5ld0lkeDsKICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50LCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudEZpcnN0Q2hpbGQgIT09IG51bGwgJiYgY3VycmVudEZpcnN0Q2hpbGQudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50Rmlyc3RDaGlsZCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQodGV4dENvbnRlbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gRnJhZ21lbnQxMCkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC5wcm9wcy5jaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQuZWxlbWVudFR5cGUgPT09IGVsZW1lbnRUeXBlIHx8IC8vIEtlZXAgdGhpcyBjaGVjayBpbmxpbmUgc28gaXQgb25seSBydW5zIG9uIHRoZSBmYWxzZSBwYXRoOgogICAgICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY2hpbGQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgaG90IHJlbG9hZGluZyBoYXMgZGlmZmVyZW50IHNlbWFudGljcyB0aGFuIHByb2QgYmVjYXVzZQogICAgICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGNoaWxkLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9leGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9leGlzdGluZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudC5wcm9wcy5jaGlsZHJlbiwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY3JlYXRlZDQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgX2NyZWF0ZWQ0LnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IHBvcnRhbC5rZXk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEhvc3RQb3J0YWwgJiYgY2hpbGQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gPT09IHBvcnRhbC5jb250YWluZXJJbmZvICYmIGNoaWxkLnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiA9PT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIHBvcnRhbC5jaGlsZHJlbiB8fCBbXSk7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkRmliZXJzMihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXNVbmtleWVkVG9wTGV2ZWxGcmFnbWVudCA9IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwgJiYgbmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSAmJiBuZXdDaGlsZC5rZXkgPT09IG51bGw7CiAgICAgICAgICAgIGlmIChpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5wcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyOwogICAgICAgIH0KICAgICAgICB2YXIgcmVjb25jaWxlQ2hpbGRGaWJlcnMgPSBDaGlsZFJlY29uY2lsZXIodHJ1ZSk7CiAgICAgICAgdmFyIG1vdW50Q2hpbGRGaWJlcnMgPSBDaGlsZFJlY29uY2lsZXIoZmFsc2UpOwogICAgICAgIGZ1bmN0aW9uIGNsb25lQ2hpbGRGaWJlcnMoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudDQuY2hpbGQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZXN1bWluZyB3b3JrIG5vdCB5ZXQgaW1wbGVtZW50ZWQuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50Q2hpbGQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB2YXIgbmV3Q2hpbGQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIGN1cnJlbnRDaGlsZC5wZW5kaW5nUHJvcHMpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3aGlsZSAoY3VycmVudENoaWxkLnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudENoaWxkID0gY3VycmVudENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIG5ld0NoaWxkID0gbmV3Q2hpbGQuc2libGluZyA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgY3VycmVudENoaWxkLnBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIG5ld0NoaWxkLnNpYmxpbmcgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzKGNoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKG51bGwpOwogICAgICAgIHZhciByZW5kZXJlclNpZ2lsOwogICAgICAgIHsKICAgICAgICAgIHJlbmRlcmVyU2lnaWwgPSB7fTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gbnVsbDsKICAgICAgICB2YXIgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICB2YXIgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICB2YXIgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpIHsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gbnVsbDsKICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgICBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFByb3ZpZGVyKHByb3ZpZGVyRmliZXIsIGNvbnRleHQsIG5leHRWYWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBwdXNoKHZhbHVlQ3Vyc29yLCBjb250ZXh0Ll9jdXJyZW50VmFsdWUsIHByb3ZpZGVyRmliZXIpOwogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBuZXh0VmFsdWU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSB2b2lkIDAgJiYgY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSBudWxsICYmIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gcmVuZGVyZXJTaWdpbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkRldGVjdGVkIG11bHRpcGxlIHJlbmRlcmVycyBjb25jdXJyZW50bHkgcmVuZGVyaW5nIHRoZSBzYW1lIGNvbnRleHQgcHJvdmlkZXIuIFRoaXMgaXMgY3VycmVudGx5IHVuc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSByZW5kZXJlclNpZ2lsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFByb3ZpZGVyKGNvbnRleHQsIHByb3ZpZGVyRmliZXIpIHsKICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSB2YWx1ZUN1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHZhbHVlQ3Vyc29yLCBwcm92aWRlckZpYmVyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKHBhcmVudCwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgIHZhciBub2RlID0gcGFyZW50OwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IG5vZGUuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhub2RlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5vZGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCAmJiAhaXNTdWJzZXRPZkxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub2RlICE9PSBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gZmluZCB0aGUgcHJvcGFnYXRpb24gcm9vdCB3aGVuIHNjaGVkdWxpbmcgY29udGV4dCB3b3JrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJvcGFnYXRlQ29udGV4dENoYW5nZV9lYWdlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2VfZWFnZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBmaWJlciA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIGlmIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICBmaWJlci5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5leHRGaWJlciA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGxpc3QgPSBmaWJlci5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIGlmIChsaXN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIGRlcGVuZGVuY3kgPSBsaXN0LmZpcnN0Q29udGV4dDsKICAgICAgICAgICAgICB3aGlsZSAoZGVwZW5kZW5jeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVuY3kuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGVuZGluZyA9IHNoYXJlZFF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKGZpYmVyLnJldHVybiwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICBsaXN0LmxhbmVzID0gbWVyZ2VMYW5lcyhsaXN0LmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlcGVuZGVuY3kgPSBkZXBlbmRlbmN5Lm5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGZpYmVyLnRhZyA9PT0gQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLnR5cGUgPyBudWxsIDogZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50U3VzcGVuc2UgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgaWYgKHBhcmVudFN1c3BlbnNlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIGp1c3QgY2FtZSBmcm9tIGEgcGFyZW50IHNvIHdlIG11c3QgaGF2ZSBoYWQgYSBwYXJlbnQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLmxhbmVzID0gbWVyZ2VMYW5lcyhwYXJlbnRTdXNwZW5zZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX2FsdGVybmF0ZSA9IHBhcmVudFN1c3BlbnNlLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoX2FsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgX2FsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoX2FsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChwYXJlbnRTdXNwZW5zZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5leHRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRGaWJlci5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICB3aGlsZSAobmV4dEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dEZpYmVyID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgc2libGluZyA9IG5leHRGaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBuZXh0RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBzaWJsaW5nOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IG5leHRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpYmVyID0gbmV4dEZpYmVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHZhciBkZXBlbmRlbmNpZXMgPSB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgaWYgKGRlcGVuZGVuY2llcyAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q29udGV4dCA9IGRlcGVuZGVuY2llcy5maXJzdENvbnRleHQ7CiAgICAgICAgICAgICAgaWYgKGZpcnN0Q29udGV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoZGVwZW5kZW5jaWVzLmxhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhZENvbnRleHQoY29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVikgewogICAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhbHVlID0gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgaWYgKGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9PT0gY29udGV4dCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0SXRlbSA9IHsKICAgICAgICAgICAgICBjb250ZXh0LAogICAgICAgICAgICAgIG1lbW9pemVkVmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gY29udGV4dEl0ZW07CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIuZGVwZW5kZW5jaWVzID0gewogICAgICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBmaXJzdENvbnRleHQ6IGNvbnRleHRJdGVtCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBsYXN0Q29udGV4dERlcGVuZGVuY3kubmV4dCA9IGNvbnRleHRJdGVtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKSB7CiAgICAgICAgICBpZiAoY29uY3VycmVudFF1ZXVlcyA9PT0gbnVsbCkgewogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gW3F1ZXVlXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMucHVzaChxdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmlzaFF1ZXVlaW5nQ29uY3VycmVudFVwZGF0ZXMoKSB7CiAgICAgICAgICBpZiAoY29uY3VycmVudFF1ZXVlcyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbmN1cnJlbnRRdWV1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBjb25jdXJyZW50UXVldWVzW2ldOwogICAgICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZSA9IGxhc3RJbnRlcmxlYXZlZFVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgdmFyIGxhc3RQZW5kaW5nVXBkYXRlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgICAgICAgIGlmIChsYXN0UGVuZGluZ1VwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZmlyc3RQZW5kaW5nVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IGZpcnN0SW50ZXJsZWF2ZWRVcGRhdGU7CiAgICAgICAgICAgICAgICAgIGxhc3RJbnRlcmxlYXZlZFVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IGxhc3RJbnRlcmxlYXZlZFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGVBbmRFYWdlcmx5QmFpbG91dChmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50Q2xhc3NVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICB2YXIgdW5zYWZlX21hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290ID0gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3Q7CiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3Qoc291cmNlRmliZXIsIGxhbmUpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhzb3VyY2VGaWJlci5sYW5lcywgbGFuZSk7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgJiYgKHNvdXJjZUZpYmVyLmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlID0gc291cmNlRmliZXI7CiAgICAgICAgICB2YXIgcGFyZW50ID0gc291cmNlRmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBwYXJlbnQuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMocGFyZW50LmNoaWxkTGFuZXMsIGxhbmUpOwogICAgICAgICAgICBhbHRlcm5hdGUgPSBwYXJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoKHBhcmVudC5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IHBhcmVudDsKICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgVXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHZhciBSZXBsYWNlU3RhdGUgPSAxOwogICAgICAgIHZhciBGb3JjZVVwZGF0ZSA9IDI7CiAgICAgICAgdmFyIENhcHR1cmVVcGRhdGUgPSAzOwogICAgICAgIHZhciBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlOwogICAgICAgIHZhciBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWU7CiAgICAgICAgewogICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIGJhc2VTdGF0ZTogZmliZXIubWVtb2l6ZWRTdGF0ZSwKICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBudWxsLAogICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgc2hhcmVkOiB7CiAgICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgICBsYW5lczogTm9MYW5lcwogICAgICAgICAgICB9LAogICAgICAgICAgICBlZmZlY3RzOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSBxdWV1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50UXVldWUuYmFzZVN0YXRlLAogICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSwKICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlLAogICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICBlZmZlY3RzOiBjdXJyZW50UXVldWUuZWZmZWN0cwogICAgICAgICAgICB9OwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgZXZlbnRUaW1lLAogICAgICAgICAgICBsYW5lLAogICAgICAgICAgICB0YWc6IFVwZGF0ZVN0YXRlLAogICAgICAgICAgICBwYXlsb2FkOiBudWxsLAogICAgICAgICAgICBjYWxsYmFjazogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPT09IHNoYXJlZFF1ZXVlICYmICFkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkFuIHVwZGF0ZSAoc2V0U3RhdGUsIHJlcGxhY2VTdGF0ZSwgb3IgZm9yY2VVcGRhdGUpIHdhcyBzY2hlZHVsZWQgZnJvbSBpbnNpZGUgYW4gdXBkYXRlIGZ1bmN0aW9uLiBVcGRhdGUgZnVuY3Rpb25zIHNob3VsZCBiZSBwdXJlLCB3aXRoIHplcm8gc2lkZS1lZmZlY3RzLiBDb25zaWRlciB1c2luZyBjb21wb25lbnREaWRVcGRhdGUgb3IgYSBjYWxsYmFjay4iKTsKICAgICAgICAgICAgICBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzVW5zYWZlQ2xhc3NSZW5kZXJQaGFzZVVwZGF0ZSgpKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nID0gc2hhcmVkUXVldWUucGVuZGluZzsKICAgICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2hhcmVkUXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHVuc2FmZV9tYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZW5xdWV1ZUNvbmN1cnJlbnRDbGFzc1VwZGF0ZShmaWJlciwgc2hhcmVkUXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uTGFuZShsYW5lKSkgewogICAgICAgICAgICB2YXIgcXVldWVMYW5lcyA9IHNoYXJlZFF1ZXVlLmxhbmVzOwogICAgICAgICAgICBxdWV1ZUxhbmVzID0gaW50ZXJzZWN0TGFuZXMocXVldWVMYW5lcywgcm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICAgICAgdmFyIG5ld1F1ZXVlTGFuZXMgPSBtZXJnZUxhbmVzKHF1ZXVlTGFuZXMsIGxhbmUpOwogICAgICAgICAgICBzaGFyZWRRdWV1ZS5sYW5lcyA9IG5ld1F1ZXVlTGFuZXM7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBuZXdRdWV1ZUxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY2FwdHVyZWRVcGRhdGUpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBpZiAocXVldWUgPT09IGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICAgIHZhciBuZXdGaXJzdCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5ld0xhc3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmaXJzdEJhc2VVcGRhdGUgPSBxdWV1ZS5maXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlLmV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGUubGFuZSwKICAgICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3TGFzdC5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgICAgbmV3TGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBudWxsKTsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3TGFzdC5uZXh0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHF1ZXVlID0gewogICAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50UXVldWUuYmFzZVN0YXRlLAogICAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBuZXdGaXJzdCwKICAgICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBuZXdMYXN0LAogICAgICAgICAgICAgICAgc2hhcmVkOiBjdXJyZW50UXVldWUuc2hhcmVkLAogICAgICAgICAgICAgICAgZWZmZWN0czogY3VycmVudFF1ZXVlLmVmZmVjdHMKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICBpZiAobGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUuZmlyc3RCYXNlVXBkYXRlID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZS5uZXh0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdGF0ZUZyb21VcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBxdWV1ZSwgdXBkYXRlLCBwcmV2U3RhdGUsIG5leHRQcm9wcywgaW5zdGFuY2UpIHsKICAgICAgICAgIHN3aXRjaCAodXBkYXRlLnRhZykgewogICAgICAgICAgICBjYXNlIFJlcGxhY2VTdGF0ZTogewogICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gdXBkYXRlLnBheWxvYWQ7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXlsb2FkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSBwYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBwYXlsb2FkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2FwdHVyZVVwZGF0ZTogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IHdvcmtJblByb2dyZXNzMi5mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFVwZGF0ZVN0YXRlOiB7CiAgICAgICAgICAgICAgdmFyIF9wYXlsb2FkID0gdXBkYXRlLnBheWxvYWQ7CiAgICAgICAgICAgICAgdmFyIHBhcnRpYWxTdGF0ZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIF9wYXlsb2FkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IF9wYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBfcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IF9wYXlsb2FkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocGFydGlhbFN0YXRlID09PSBudWxsIHx8IHBhcnRpYWxTdGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRm9yY2VVcGRhdGU6IHsKICAgICAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgcHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEJhc2VVcGRhdGUgPSBxdWV1ZS5maXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHZhciBjdXJyZW50TGFzdEJhc2VVcGRhdGUgPSBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSAhPT0gbGFzdEJhc2VVcGRhdGUpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IHF1ZXVlLmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdGaXJzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3TGFzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICB2YXIgdXBkYXRlRXZlbnRUaW1lID0gdXBkYXRlLmV2ZW50VGltZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lczIsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlRXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBnZXRTdGF0ZUZyb21VcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBxdWV1ZSwgdXBkYXRlLCBuZXdTdGF0ZSwgcHJvcHMsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHVwZGF0ZS5jYWxsYmFjazsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiAvLyBJZiB0aGUgdXBkYXRlIHdhcyBhbHJlYWR5IGNvbW1pdHRlZCwgd2Ugc2hvdWxkIG5vdCBxdWV1ZSBpdHMKICAgICAgICAgICAgICAgIC8vIGNhbGxiYWNrIGFnYWluLgogICAgICAgICAgICAgICAgdXBkYXRlLmxhbmUgIT09IE5vTGFuZSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3RzID0gcXVldWUuZWZmZWN0czsKICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBxdWV1ZS5lZmZlY3RzID0gW3VwZGF0ZV07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0cy5wdXNoKHVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIF9sYXN0UGVuZGluZ1VwZGF0ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgICAgICAgdmFyIF9maXJzdFBlbmRpbmdVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBudWxsOwogICAgICAgICAgICAgICAgICB1cGRhdGUgPSBfZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IF9sYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgcXVldWUuZmlyc3RCYXNlVXBkYXRlID0gbmV3Rmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuc2hhcmVkLmludGVybGVhdmVkOwogICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIG5ld0xhbmVzID0gbWVyZ2VMYW5lcyhuZXdMYW5lcywgaW50ZXJsZWF2ZWQubGFuZSk7CiAgICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKG5ld0xhbmVzKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbmV3TGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgYXJndW1lbnQgcGFzc2VkIGFzIGNhbGxiYWNrLiBFeHBlY3RlZCBhIGZ1bmN0aW9uLiBJbnN0ZWFkICIgKyAoInJlY2VpdmVkOiAiICsgY2FsbGJhY2spKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrLmNhbGwoY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCkgewogICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHsKICAgICAgICAgIHJldHVybiBoYXNGb3JjZVVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFF1ZXVlLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIGVmZmVjdHMgPSBmaW5pc2hlZFF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICBmaW5pc2hlZFF1ZXVlLmVmZmVjdHMgPSBudWxsOwogICAgICAgICAgaWYgKGVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGVmZmVjdHNbaV07CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZWZmZWN0LmNhbGxiYWNrOwogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZWZmZWN0LmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICAgIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTk9fQ09OVEVYVCA9IHt9OwogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IkMSA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICB2YXIgY29udGV4dEZpYmVyU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIGZ1bmN0aW9uIHJlcXVpcmVkQ29udGV4dChjKSB7CiAgICAgICAgICBpZiAoYyA9PT0gTk9fQ09OVEVYVCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGhvc3QgY29udGV4dCB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRhaW5lcigpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gcm9vdEluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRhaW5lcihmaWJlciwgbmV4dFJvb3RJbnN0YW5jZSkgewogICAgICAgICAgcHVzaChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgbmV4dFJvb3RJbnN0YW5jZSwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIE5PX0NPTlRFWFQsIGZpYmVyKTsKICAgICAgICAgIHZhciBuZXh0Um9vdENvbnRleHQgPSBnZXRSb290SG9zdENvbnRleHQobmV4dFJvb3RJbnN0YW5jZSk7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIG5leHRSb290Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGFpbmVyKGZpYmVyKSB7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgcG9wKHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RDb250ZXh0KCkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBnZXRDaGlsZEhvc3RDb250ZXh0KGNvbnRleHQsIGZpYmVyLnR5cGUpOwogICAgICAgICAgaWYgKGNvbnRleHQgPT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgaWYgKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBEZWZhdWx0U3VzcGVuc2VDb250ZXh0ID0gMDsKICAgICAgICB2YXIgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgPSAxOwogICAgICAgIHZhciBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQgPSAxOwogICAgICAgIHZhciBGb3JjZVN1c3BlbnNlRmFsbGJhY2sgPSAyOwogICAgICAgIHZhciBzdXNwZW5zZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKERlZmF1bHRTdXNwZW5zZUNvbnRleHQpOwogICAgICAgIGZ1bmN0aW9uIGhhc1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBmbGFnKSB7CiAgICAgICAgICByZXR1cm4gKHBhcmVudENvbnRleHQgJiBmbGFnKSAhPT0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzaGFsbG93Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayB8IHNoYWxsb3dDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIHN1YnRyZWVDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCB8IHN1YnRyZWVDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3VzcGVuc2VDb250ZXh0KGZpYmVyLCBuZXdDb250ZXh0KSB7CiAgICAgICAgICBwdXNoKHN1c3BlbnNlU3RhY2tDdXJzb3IsIG5ld0NvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wU3VzcGVuc2VDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICBwb3Aoc3VzcGVuc2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDYXB0dXJlU3VzcGVuc2Uod29ya0luUHJvZ3Jlc3MyLCBoYXNJbnZpc2libGVQYXJlbnQpIHsKICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXh0U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kRmlyc3RTdXNwZW5kZWQocm93KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHJvdzsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBub2RlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZCA9IHN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoZGVoeWRyYXRlZCA9PT0gbnVsbCB8fCBpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKGRlaHlkcmF0ZWQpIHx8IGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKGRlaHlkcmF0ZWQpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VMaXN0Q29tcG9uZW50ICYmIC8vIHJldmVhbE9yZGVyIHVuZGVmaW5lZCBjYW4ndCBiZSB0cnVzdGVkIGJlY2F1c2UgaXQgZG9uJ3QKICAgICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB3aGV0aGVyIGl0IHN1c3BlbmRlZCBvciBub3QuCiAgICAgICAgICAgIG5vZGUubWVtb2l6ZWRQcm9wcy5yZXZlYWxPcmRlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmQgPSAobm9kZS5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcm93KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gcm93KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEhhc0VmZmVjdCA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5zZXJ0aW9uID0gKAogICAgICAgICAgLyogICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgTGF5b3V0ID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlJDEgPSAoCiAgICAgICAgICAvKiAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NTb3VyY2VzID0gW107CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzc1ZlcnNpb25zKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzc1NvdXJjZXNbaV07CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtdXRhYmxlU291cmNlLl93b3JrSW5Qcm9ncmVzc1ZlcnNpb25QcmltYXJ5ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyTXV0YWJsZVNvdXJjZUZvckh5ZHJhdGlvbihyb290MywgbXV0YWJsZVNvdXJjZSkgewogICAgICAgICAgdmFyIGdldFZlcnNpb24gPSBtdXRhYmxlU291cmNlLl9nZXRWZXJzaW9uOwogICAgICAgICAgdmFyIHZlcnNpb24yID0gZ2V0VmVyc2lvbihtdXRhYmxlU291cmNlLl9zb3VyY2UpOwogICAgICAgICAgaWYgKHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gW211dGFibGVTb3VyY2UsIHZlcnNpb24yXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEucHVzaChtdXRhYmxlU291cmNlLCB2ZXJzaW9uMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3Q7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICB2YXIgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBnbG9iYWxDbGllbnRJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBSRV9SRU5ERVJfTElNSVQgPSAyNTsKICAgICAgICB2YXIgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgIHZhciBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50SG9va1R5cGVzRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9va05hbWUgPSBjdXJyZW50SG9va05hbWVJbkRldjsKICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IFtob29rTmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzRGV2LnB1c2goaG9va05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldisrOwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXZbaG9va1R5cGVzVXBkYXRlSW5kZXhEZXZdICE9PSBob29rTmFtZSkgewogICAgICAgICAgICAgICAgd2Fybk9uSG9va01pc21hdGNoSW5EZXYoaG9va05hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkZXBzICE9PSB2b2lkIDAgJiYgZGVwcyAhPT0gbnVsbCAmJiAhaXNBcnJheTIoZGVwcykpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCB0aGF0IGlzIG5vdCBhbiBhcnJheSAoaW5zdGVhZCwgcmVjZWl2ZWQgYCVzYCkuIFdoZW4gc3BlY2lmaWVkLCB0aGUgZmluYWwgYXJndW1lbnQgbXVzdCBiZSBhbiBhcnJheS4iLCBjdXJyZW50SG9va05hbWVJbkRldiwgdHlwZW9mIGRlcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGN1cnJlbnRIb29rTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSk7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHRhYmxlID0gIiI7CiAgICAgICAgICAgICAgICB2YXIgc2Vjb25kQ29sdW1uU3RhcnQgPSAzMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIG9sZEhvb2tOYW1lID0gaG9va1R5cGVzRGV2W2ldOwogICAgICAgICAgICAgICAgICB2YXIgbmV3SG9va05hbWUgPSBpID09PSBob29rVHlwZXNVcGRhdGVJbmRleERldiA/IGN1cnJlbnRIb29rTmFtZSA6IG9sZEhvb2tOYW1lOwogICAgICAgICAgICAgICAgICB2YXIgcm93ID0gaSArIDEgKyAiLiAiICsgb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChyb3cubGVuZ3RoIDwgc2Vjb25kQ29sdW1uU3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICByb3cgKz0gIiAiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvdyArPSBuZXdIb29rTmFtZSArICJcbiI7CiAgICAgICAgICAgICAgICAgIHRhYmxlICs9IHJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBoYXMgZGV0ZWN0ZWQgYSBjaGFuZ2UgaW4gdGhlIG9yZGVyIG9mIEhvb2tzIGNhbGxlZCBieSAlcy4gVGhpcyB3aWxsIGxlYWQgdG8gYnVncyBhbmQgZXJyb3JzIGlmIG5vdCBmaXhlZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHJlYWQgdGhlIFJ1bGVzIG9mIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3NcblxuICAgUHJldmlvdXMgcmVuZGVyICAgICAgICAgICAgTmV4dCByZW5kZXJcbiAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuJXMgICBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5cbiIsIGNvbXBvbmVudE5hbWUsIHRhYmxlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnZhbGlkSG9va0Vycm9yKCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcykgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByZXZEZXBzID09PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCBkdXJpbmcgdGhpcyByZW5kZXIsIGJ1dCBub3QgZHVyaW5nIHRoZSBwcmV2aW91cyByZW5kZXIuIEV2ZW4gdGhvdWdoIHRoZSBmaW5hbCBhcmd1bWVudCBpcyBvcHRpb25hbCwgaXRzIHR5cGUgY2Fubm90IGNoYW5nZSBiZXR3ZWVuIHJlbmRlcnMuIiwgY3VycmVudEhvb2tOYW1lSW5EZXYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzLmxlbmd0aCAhPT0gcHJldkRlcHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBmaW5hbCBhcmd1bWVudCBwYXNzZWQgdG8gJXMgY2hhbmdlZCBzaXplIGJldHdlZW4gcmVuZGVycy4gVGhlIG9yZGVyIGFuZCBzaXplIG9mIHRoaXMgYXJyYXkgbXVzdCByZW1haW4gY29uc3RhbnQuXG5cblByZXZpb3VzOiAlc1xuSW5jb21pbmc6ICVzIiwgY3VycmVudEhvb2tOYW1lSW5EZXYsICJbIiArIHByZXZEZXBzLmpvaW4oIiwgIikgKyAiXSIsICJbIiArIG5leHREZXBzLmpvaW4oIiwgIikgKyAiXSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByZXZEZXBzLmxlbmd0aCAmJiBpIDwgbmV4dERlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iamVjdElzKG5leHREZXBzW2ldLCBwcmV2RGVwc1tpXSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIHNlY29uZEFyZywgbmV4dFJlbmRlckxhbmVzKSB7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IG5leHRSZW5kZXJMYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQuX2RlYnVnSG9va1R5cGVzIDogbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MpIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mUmVSZW5kZXJzID0gMDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgICAgICBpZiAobnVtYmVyT2ZSZVJlbmRlcnMgPj0gUkVfUkVOREVSX0xJTUlUKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRvbyBtYW55IHJlLXJlbmRlcnMuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlbmRlcnMgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBudW1iZXJPZlJlUmVuZGVycyArPSAxOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgY2hpbGRyZW4gPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICAgIH0gd2hpbGUgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyk7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGhvb2tUeXBlc0RldjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRSZW5kZXJUb29GZXdIb29rcyA9IGN1cnJlbnRIb29rICE9PSBudWxsICYmIGN1cnJlbnRIb29rLm5leHQgIT09IG51bGw7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIChjdXJyZW50NC5mbGFncyAmIFN0YXRpY01hc2spICE9PSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgU3RhdGljTWFzaykgJiYgLy8gRGlzYWJsZSB0aGlzIHdhcm5pbmcgaW4gbGVnYWN5IG1vZGUsIGJlY2F1c2UgbGVnYWN5IFN1c3BlbnNlIGlzIHdlaXJkCiAgICAgICAgICAgIC8vIGFuZCBjcmVhdGVzIGZhbHNlIHBvc2l0aXZlcy4gVG8gbWFrZSB0aGlzIHdvcmsgaW4gbGVnYWN5IG1vZGUsIHdlJ2QKICAgICAgICAgICAgLy8gbmVlZCB0byBtYXJrIGZpYmVycyB0aGF0IGNvbW1pdCBpbiBhbiBpbmNvbXBsZXRlIHN0YXRlLCBzb21laG93LiBGb3IKICAgICAgICAgICAgLy8gbm93IEknbGwgZGlzYWJsZSB0aGUgd2FybmluZyB0aGF0IG1vc3Qgb2YgdGhlIGJ1Z3MgdGhhdCB3b3VsZCB0cmlnZ2VyCiAgICAgICAgICAgIC8vIGl0IGFyZSBlaXRoZXIgZXhjbHVzaXZlIHRvIGNvbmN1cnJlbnQgbW9kZSBvciBleGlzdCBpbiBib3RoLgogICAgICAgICAgICAoY3VycmVudDQubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBFeHBlY3RlZCBzdGF0aWMgZmxhZyB3YXMgbWlzc2luZy4gUGxlYXNlIG5vdGlmeSB0aGUgUmVhY3QgdGVhbS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgaWYgKGRpZFJlbmRlclRvb0Zld0hvb2tzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgZmV3ZXIgaG9va3MgdGhhbiBleHBlY3RlZC4gVGhpcyBtYXkgYmUgY2F1c2VkIGJ5IGFuIGFjY2lkZW50YWwgZWFybHkgcmV0dXJuIHN0YXRlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEaWRSZW5kZXJJZEhvb2soKSB7CiAgICAgICAgICB2YXIgZGlkUmVuZGVySWRIb29rID0gbG9jYWxJZENvdW50ZXIgIT09IDA7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgICByZXR1cm4gZGlkUmVuZGVySWRIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYWlsb3V0SG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KE1vdW50UGFzc2l2ZURldiB8IE1vdW50TGF5b3V0RGV2IHwgUGFzc2l2ZSB8IFVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfihQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnQ0LmxhbmVzID0gcmVtb3ZlTGFuZXMoY3VycmVudDQubGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIb29rc0FmdGVyVGhyb3coKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG9vayA9IGhvb2submV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIGhvb2sgPSB7CiAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IG51bGwsCiAgICAgICAgICAgIGJhc2VTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVF1ZXVlOiBudWxsLAogICAgICAgICAgICBxdWV1ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gaG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gaG9vazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpIHsKICAgICAgICAgIHZhciBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudEhvb2submV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbmV4dFdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChuZXh0Q3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlbmRlcmVkIG1vcmUgaG9va3MgdGhhbiBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgICAgdmFyIG5ld0hvb2sgPSB7CiAgICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZSwKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRIb29rLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBiYXNlUXVldWU6IGN1cnJlbnRIb29rLmJhc2VRdWV1ZSwKICAgICAgICAgICAgICBxdWV1ZTogY3VycmVudEhvb2sucXVldWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gbmV3SG9vazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dCA9IG5ld0hvb2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBsYXN0RWZmZWN0OiBudWxsLAogICAgICAgICAgICBzdG9yZXM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhc2ljU3RhdGVSZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iID8gYWN0aW9uKHN0YXRlKSA6IGFjdGlvbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBpbml0aWFsU3RhdGUxMzsKICAgICAgICAgIGlmIChpbml0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlMTMgPSBpbml0KGluaXRpYWxBcmcpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlMTMgPSBpbml0aWFsQXJnOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGUxMzsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICBkaXNwYXRjaDogbnVsbCwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkUmVkdWNlcjogcmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZTEzCiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2ggPSBkaXNwYXRjaFJlZHVjZXJBY3Rpb24uYmluZChudWxsLCBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLCBxdWV1ZSk7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBxdWV1ZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSBjdXJyZW50SG9vazsKICAgICAgICAgIHZhciBiYXNlUXVldWUgPSBjdXJyZW50NC5iYXNlUXVldWU7CiAgICAgICAgICB2YXIgcGVuZGluZ1F1ZXVlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGJhc2VRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBiYXNlRmlyc3QgPSBiYXNlUXVldWUubmV4dDsKICAgICAgICAgICAgICB2YXIgcGVuZGluZ0ZpcnN0ID0gcGVuZGluZ1F1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgYmFzZVF1ZXVlLm5leHQgPSBwZW5kaW5nRmlyc3Q7CiAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlLm5leHQgPSBiYXNlRmlyc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdXJyZW50NC5iYXNlUXVldWUgIT09IGJhc2VRdWV1ZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIGVycm9yOiBFeHBlY3RlZCB3b3JrLWluLXByb2dyZXNzIHF1ZXVlIHRvIGJlIGEgY2xvbmUuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQ0LmJhc2VRdWV1ZSA9IGJhc2VRdWV1ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdCA9IGJhc2VRdWV1ZS5uZXh0OwogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjdXJyZW50NC5iYXNlU3RhdGU7CiAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3QmFzZVF1ZXVlRmlyc3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3QmFzZVF1ZXVlTGFzdCA9IG51bGw7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gdXBkYXRlLmxhbmU7CiAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMocmVuZGVyTGFuZXMsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZUxhbmUsCiAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogdXBkYXRlLmhhc0VhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgIGVhZ2VyU3RhdGU6IHVwZGF0ZS5lYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlRmlyc3QgPSBuZXdCYXNlUXVldWVMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgdXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Nsb25lID0gewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgdXBkYXRlIGlzIGdvaW5nIHRvIGJlIGNvbW1pdHRlZCBzbyB3ZSBuZXZlciB3YW50IHVuY29tbWl0CiAgICAgICAgICAgICAgICAgICAgLy8gaXQuIFVzaW5nIE5vTGFuZSB3b3JrcyBiZWNhdXNlIDAgaXMgYSBzdWJzZXQgb2YgYWxsIGJpdG1hc2tzLCBzbwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgd2lsbCBuZXZlciBiZSBza2lwcGVkIGJ5IHRoZSBjaGVjayBhYm92ZS4KICAgICAgICAgICAgICAgICAgICBsYW5lOiBOb0xhbmUsCiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiB1cGRhdGUuYWN0aW9uLAogICAgICAgICAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IHVwZGF0ZS5oYXNFYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICAgIGVhZ2VyU3RhdGU6IHVwZGF0ZS5lYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IF9jbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1cGRhdGUuaGFzRWFnZXJTdGF0ZSkgewogICAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHVwZGF0ZS5lYWdlclN0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHVwZGF0ZS5hY3Rpb247CiAgICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gcmVkdWNlcihuZXdTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gbnVsbCAmJiB1cGRhdGUgIT09IGZpcnN0KTsKICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBuZXdCYXNlUXVldWVGaXJzdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW9iamVjdElzKG5ld1N0YXRlLCBob29rLm1lbW9pemVkU3RhdGUpKSB7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdCYXNlU3RhdGU7CiAgICAgICAgICAgIGhvb2suYmFzZVF1ZXVlID0gbmV3QmFzZVF1ZXVlTGFzdDsKICAgICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkTGFuZSA9IGludGVybGVhdmVkLmxhbmU7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKGludGVybGVhdmVkTGFuZSk7CiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChpbnRlcmxlYXZlZCAhPT0gbGFzdEludGVybGVhdmVkKTsKICAgICAgICAgIH0gZWxzZSBpZiAoYmFzZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBxdWV1ZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaDsKICAgICAgICAgIHZhciBsYXN0UmVuZGVyUGhhc2VVcGRhdGUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgdmFyIG5ld1N0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGxhc3RSZW5kZXJQaGFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGZpcnN0UmVuZGVyUGhhc2VVcGRhdGUgPSBsYXN0UmVuZGVyUGhhc2VVcGRhdGUubmV4dDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0UmVuZGVyUGhhc2VVcGRhdGU7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdXBkYXRlLmFjdGlvbjsKICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHJlZHVjZXIobmV3U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZSk7CiAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV3U3RhdGUsIGhvb2subWVtb2l6ZWRTdGF0ZSkpIHsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICBpZiAoaG9vay5iYXNlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gW25ld1N0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TXV0YWJsZVNvdXJjZShzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTXV0YWJsZVNvdXJjZShzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0U25hcHNob3Q7CiAgICAgICAgICB2YXIgaXNIeWRyYXRpbmcyID0gZ2V0SXNIeWRyYXRpbmcoKTsKICAgICAgICAgIGlmIChpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgaWYgKGdldFNlcnZlclNuYXBzaG90ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgZ2V0U2VydmVyU25hcHNob3QsIHdoaWNoIGlzIHJlcXVpcmVkIGZvciBzZXJ2ZXItcmVuZGVyZWQgY29udGVudC4gV2lsbCByZXZlcnQgdG8gY2xpZW50IHJlbmRlcmluZy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTZXJ2ZXJTbmFwc2hvdCgpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgaWYgKG5leHRTbmFwc2hvdCAhPT0gZ2V0U2VydmVyU25hcHNob3QoKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTZXJ2ZXJTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgIHZhciBjYWNoZWRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKG5leHRTbmFwc2hvdCwgY2FjaGVkU25hcHNob3QpKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgd29yay1pbi1wcm9ncmVzcyByb290LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCByZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgdmFyIGluc3QgPSB7CiAgICAgICAgICAgIHZhbHVlOiBuZXh0U25hcHNob3QsCiAgICAgICAgICAgIGdldFNuYXBzaG90CiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IGluc3Q7CiAgICAgICAgICBtb3VudEVmZmVjdChzdWJzY3JpYmVUb1N0b3JlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIHN1YnNjcmliZSksIFtzdWJzY3JpYmVdKTsKICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFBhc3NpdmU7CiAgICAgICAgICBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IFBhc3NpdmUkMSwgdXBkYXRlU3RvcmVJbnN0YW5jZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSwgdm9pZCAwLCBudWxsKTsKICAgICAgICAgIHJldHVybiBuZXh0U25hcHNob3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKG5leHRTbmFwc2hvdCwgY2FjaGVkU25hcHNob3QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2U25hcHNob3QgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgc25hcHNob3RDaGFuZ2VkID0gIW9iamVjdElzKHByZXZTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgIGlmIChzbmFwc2hvdENoYW5nZWQpIHsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3QgPSBob29rLnF1ZXVlOwogICAgICAgICAgdXBkYXRlRWZmZWN0KHN1YnNjcmliZVRvU3RvcmUuYmluZChudWxsLCBmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSwgW3N1YnNjcmliZV0pOwogICAgICAgICAgaWYgKGluc3QuZ2V0U25hcHNob3QgIT09IGdldFNuYXBzaG90IHx8IHNuYXBzaG90Q2hhbmdlZCB8fCAvLyBDaGVjayBpZiB0aGUgc3VzYmNyaWJlIGZ1bmN0aW9uIGNoYW5nZWQuIFdlIGNhbiBzYXZlIHNvbWUgbWVtb3J5IGJ5CiAgICAgICAgICAvLyBjaGVja2luZyB3aGV0aGVyIHdlIHNjaGVkdWxlZCBhIHN1YnNjcmlwdGlvbiBlZmZlY3QgYWJvdmUuCiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3NIb29rLm1lbW9pemVkU3RhdGUudGFnICYgSGFzRWZmZWN0KSB7CiAgICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFBhc3NpdmU7CiAgICAgICAgICAgIHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgUGFzc2l2ZSQxLCB1cGRhdGVTdG9yZUluc3RhbmNlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpLCB2b2lkIDAsIG51bGwpOwogICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBhIHdvcmstaW4tcHJvZ3Jlc3Mgcm9vdC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgcmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0U25hcHNob3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCByZW5kZXJlZFNuYXBzaG90KSB7CiAgICAgICAgICBmaWJlci5mbGFncyB8PSBTdG9yZUNvbnNpc3RlbmN5OwogICAgICAgICAgdmFyIGNoZWNrID0gewogICAgICAgICAgICBnZXRTbmFwc2hvdCwKICAgICAgICAgICAgdmFsdWU6IHJlbmRlcmVkU25hcHNob3QKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKGNvbXBvbmVudFVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlcyA9IFtjaGVja107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc3RvcmVzID0gY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICBpZiAoc3RvcmVzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzID0gW2NoZWNrXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdG9yZXMucHVzaChjaGVjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3RvcmVJbnN0YW5jZShmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCkgewogICAgICAgICAgaW5zdC52YWx1ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgIGluc3QuZ2V0U25hcHNob3QgPSBnZXRTbmFwc2hvdDsKICAgICAgICAgIGlmIChjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpKSB7CiAgICAgICAgICAgIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN1YnNjcmliZVRvU3RvcmUoZmliZXIsIGluc3QsIHN1YnNjcmliZSkgewogICAgICAgICAgdmFyIGhhbmRsZVN0b3JlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpKSB7CiAgICAgICAgICAgICAgZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBzdWJzY3JpYmUoaGFuZGxlU3RvcmVDaGFuZ2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpIHsKICAgICAgICAgIHZhciBsYXRlc3RHZXRTbmFwc2hvdCA9IGluc3QuZ2V0U25hcHNob3Q7CiAgICAgICAgICB2YXIgcHJldlZhbHVlID0gaW5zdC52YWx1ZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBsYXRlc3RHZXRTbmFwc2hvdCgpOwogICAgICAgICAgICByZXR1cm4gIW9iamVjdElzKHByZXZWYWx1ZSwgbmV4dFZhbHVlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAodHlwZW9mIGluaXRpYWxTdGF0ZTEzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZTEzID0gaW5pdGlhbFN0YXRlMTMoKTsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGhvb2suYmFzZVN0YXRlID0gaW5pdGlhbFN0YXRlMTM7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IGJhc2ljU3RhdGVSZWR1Y2VyLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRTdGF0ZTogaW5pdGlhbFN0YXRlMTMKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gcXVldWU7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaCA9IGRpc3BhdGNoU2V0U3RhdGUuYmluZChudWxsLCBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLCBxdWV1ZSk7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIoYmFzaWNTdGF0ZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKGJhc2ljU3RhdGVSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEVmZmVjdCh0YWcsIGNyZWF0ZSwgZGVzdHJveSwgZGVwcykgewogICAgICAgICAgdmFyIGVmZmVjdCA9IHsKICAgICAgICAgICAgdGFnLAogICAgICAgICAgICBjcmVhdGUsCiAgICAgICAgICAgIGRlc3Ryb3ksCiAgICAgICAgICAgIGRlcHMsCiAgICAgICAgICAgIC8vIENpcmN1bGFyCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKGNvbXBvbmVudFVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgIGxhc3RFZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgICAgICBlZmZlY3QubmV4dCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlZmZlY3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50UmVmKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX3JlZjIgPSB7CiAgICAgICAgICAgICAgY3VycmVudDogaW5pdGlhbFZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IF9yZWYyOwogICAgICAgICAgICByZXR1cm4gX3JlZjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICByZXR1cm4gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgdm9pZCAwLCBuZXh0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBkZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBwcmV2RWZmZWN0ID0gY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgZGVzdHJveSA9IHByZXZFZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldkVmZmVjdC5kZXBzOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChNb3VudFBhc3NpdmVEZXYgfCBQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChQYXNzaXZlLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0KGNyZWF0ZSwgcmVmKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgcmVmQ2FsbGJhY2sgPSByZWY7CiAgICAgICAgICAgIHZhciBfaW5zdCA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZDYWxsYmFjayhfaW5zdCk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVmICE9PSBudWxsICYmIHJlZiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciByZWZPYmplY3QgPSByZWY7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXJlZk9iamVjdC5oYXNPd25Qcm9wZXJ0eSgiY3VycmVudCIpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIGZpcnN0IGFyZ3VtZW50IHRvIGVpdGhlciBiZSBhIHJlZiBjYWxsYmFjayBvciBSZWFjdC5jcmVhdGVSZWYoKSBvYmplY3QuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsICJhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMocmVmT2JqZWN0KS5qb2luKCIsICIpICsgIn0iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0MiA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IF9pbnN0MjsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJlZk9iamVjdC5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3JlYXRlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBzZWNvbmQgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBoYW5kbGUuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNyZWF0ZSAhPT0gbnVsbCA/IHR5cGVvZiBjcmVhdGUgOiAibnVsbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWZmZWN0RGVwcyA9IGRlcHMgIT09IG51bGwgJiYgZGVwcyAhPT0gdm9pZCAwID8gZGVwcy5jb25jYXQoW3JlZl0pIDogbnVsbDsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0LmJpbmQobnVsbCwgY3JlYXRlLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICB9CiAgICAgICAgdmFyIHVwZGF0ZURlYnVnVmFsdWUgPSBtb3VudERlYnVnVmFsdWU7CiAgICAgICAgZnVuY3Rpb24gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtuZXh0VmFsdWUsIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBuZXh0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW8obmV4dENyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldlN0YXRlWzFdOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZVswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHJlc29sdmVkQ3VycmVudEhvb2sgPSBjdXJyZW50SG9vazsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSByZXNvbHZlZEN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSkgewogICAgICAgICAgdmFyIHNob3VsZERlZmVyVmFsdWUgPSAhaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMocmVuZGVyTGFuZXMpOwogICAgICAgICAgaWYgKHNob3VsZERlZmVyVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyh2YWx1ZSwgcHJldlZhbHVlKSkgewogICAgICAgICAgICAgIHZhciBkZWZlcnJlZExhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGRlZmVycmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJldlZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVN0YXRlKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzZXRQZW5kaW5nLCBjYWxsYmFjaywgb3B0aW9uczIpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoaGlnaGVyRXZlbnRQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5LCBDb250aW51b3VzRXZlbnRQcmlvcml0eSkpOwogICAgICAgICAgc2V0UGVuZGluZyh0cnVlKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0UGVuZGluZyhmYWxzZSk7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMygiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX21vdW50U3RhdGUgPSBtb3VudFN0YXRlKGZhbHNlKSwgaXNQZW5kaW5nID0gX21vdW50U3RhdGVbMF0sIHNldFBlbmRpbmcgPSBfbW91bnRTdGF0ZVsxXTsKICAgICAgICAgIHZhciBzdGFydCA9IHN0YXJ0VHJhbnNpdGlvbi5iaW5kKG51bGwsIHNldFBlbmRpbmcpOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gc3RhcnQ7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF91cGRhdGVTdGF0ZSA9IHVwZGF0ZVN0YXRlKCksIGlzUGVuZGluZyA9IF91cGRhdGVTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3JlcmVuZGVyU3RhdGUgPSByZXJlbmRlclN0YXRlKCksIGlzUGVuZGluZyA9IF9yZXJlbmRlclN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIHZhciBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSByb290My5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdmFyIGlkOwogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgdmFyIHRyZWVJZCA9IGdldFRyZWVJZCgpOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiUiIgKyB0cmVlSWQ7CiAgICAgICAgICAgIHZhciBsb2NhbElkID0gbG9jYWxJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWYgKGxvY2FsSWQgPiAwKSB7CiAgICAgICAgICAgICAgaWQgKz0gIkgiICsgbG9jYWxJZC50b1N0cmluZygzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgKz0gIjoiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGdsb2JhbENsaWVudElkID0gZ2xvYmFsQ2xpZW50SWRDb3VudGVyKys7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJyIiArIGdsb2JhbENsaWVudElkLnRvU3RyaW5nKDMyKSArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGlkOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaWQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoUmVkdWNlckFjdGlvbihmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hTZXRTdGF0ZShmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoZmliZXIubGFuZXMgPT09IE5vTGFuZXMgJiYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCBhbHRlcm5hdGUubGFuZXMgPT09IE5vTGFuZXMpKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RSZW5kZXJlZFJlZHVjZXIgPSBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyOwogICAgICAgICAgICAgIGlmIChsYXN0UmVuZGVyZWRSZWR1Y2VyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcXVldWUubGFzdFJlbmRlcmVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBlYWdlclN0YXRlID0gbGFzdFJlbmRlcmVkUmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5oYXNFYWdlclN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmVhZ2VyU3RhdGUgPSBlYWdlclN0YXRlOwogICAgICAgICAgICAgICAgICBpZiAob2JqZWN0SXMoZWFnZXJTdGF0ZSwgY3VycmVudFN0YXRlKSkgewogICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICByZXR1cm4gZmliZXIgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpIHsKICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgdmFyIHBlbmRpbmcgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSkgewogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBxdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENvbnRleHRPbmx5RGlzcGF0Y2hlciA9IHsKICAgICAgICAgIHJlYWRDb250ZXh0LAogICAgICAgICAgdXNlQ2FsbGJhY2s6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUNvbnRleHQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU1lbW86IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZHVjZXI6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3RhdGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlYnVnVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVRyYW5zaXRpb246IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJZDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgfTsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybkludmFsaWRDb250ZXh0QWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkludmFsaWRIb29rQWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJEbyBub3QgY2FsbCBIb29rcyBpbnNpZGUgdXNlRWZmZWN0KC4uLiksIHVzZU1lbW8oLi4uKSwgb3Igb3RoZXIgYnVpbHQtaW4gSG9va3MuIFlvdSBjYW4gb25seSBjYWxsIEhvb2tzIGF0IHRoZSB0b3AgbGV2ZWwgb2YgeW91ciBSZWFjdCBmdW5jdGlvbi4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3MiKTsKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50V2l0aEhvb2tUeXBlc0luREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIG5vdyQxID0gU2NoZWR1bGVyLnVuc3RhYmxlX25vdzsKICAgICAgICB2YXIgY29tbWl0VGltZSA9IDA7CiAgICAgICAgdmFyIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgIHZhciBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgIHZhciBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IGZhbHNlOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFVwZGF0ZUlzTmVzdGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTmVzdGVkVXBkYXRlU2NoZWR1bGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldE5lc3RlZFVwZGF0ZUZsYWcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IGZhbHNlOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3luY05lc3RlZFVwZGF0ZUZsYWcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IG5lc3RlZFVwZGF0ZVNjaGVkdWxlZDsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbW1pdFRpbWUoKSB7CiAgICAgICAgICByZXR1cm4gY29tbWl0VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3JkQ29tbWl0VGltZSgpIHsKICAgICAgICAgIGNvbW1pdFRpbWUgPSBub3ckMSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFByb2ZpbGVyVGltZXIoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIGlmIChmaWJlci5hY3R1YWxTdGFydFRpbWUgPCAwKSB7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nKGZpYmVyKSB7CiAgICAgICAgICBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGZpYmVyLCBvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICBpZiAocHJvZmlsZXJTdGFydFRpbWUgPj0gMCkgewogICAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBub3ckMSgpIC0gcHJvZmlsZXJTdGFydFRpbWU7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICBpZiAob3ZlcnJpZGVCYXNlVGltZSkgewogICAgICAgICAgICAgIGZpYmVyLnNlbGZCYXNlRHVyYXRpb24gPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaWJlcikgewogICAgICAgICAgaWYgKGxheW91dEVmZmVjdFN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBsYXlvdXRFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHJvb3QzLmVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAocGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lOwogICAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcm9vdDMucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRTdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpIHsKICAgICAgICAgIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCkgewogICAgICAgICAgcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgYmFzZVByb3BzKSB7CiAgICAgICAgICBpZiAoQ29tcG9uZW50ICYmIENvbXBvbmVudC5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIHByb3BzID0gYXNzaWduMih7fSwgYmFzZVByb3BzKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IENvbXBvbmVudC5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2VQcm9wczsKICAgICAgICB9CiAgICAgICAgdmFyIGZha2VJbnRlcm5hbEluc3RhbmNlID0ge307CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2s7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB2YXIgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IGNhbGxlck5hbWUgKyAiXyIgKyBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suaGFzKGtleSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suYWRkKGtleSk7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gZnVuY3Rpb24odHlwZSwgcGFydGlhbFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKTogQSB2YWxpZCBzdGF0ZSBvYmplY3QgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUludGVybmFsSW5zdGFuY2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCIsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl9wcm9jZXNzQ2hpbGRDb250ZXh0IGlzIG5vdCBhdmFpbGFibGUgaW4gUmVhY3QgMTYrLiBUaGlzIGxpa2VseSBtZWFucyB5b3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgYW5kIGFyZSBhdHRlbXB0aW5nIHRvIG5lc3QgYSBSZWFjdCAxNSB0cmVlIGluc2lkZSBhIFJlYWN0IDE2IHRyZWUgdXNpbmcgdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIsIHdoaWNoIGlzbid0IHN1cHBvcnRlZC4gVHJ5IHRvIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvbmx5IG9uZSBjb3B5IG9mIFJlYWN0IChhbmQgaWRlYWxseSwgc3dpdGNoIHRvIFJlYWN0RE9NLmNyZWF0ZVBvcnRhbCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmZyZWV6ZShmYWtlSW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXh0UHJvcHMpIHsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlKGN0b3IsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWVtb2l6ZWRTdGF0ZSA9IHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCA/IHByZXZTdGF0ZSA6IGFzc2lnbjIoe30sIHByZXZTdGF0ZSwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5iYXNlU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY2xhc3NDb21wb25lbnRVcGRhdGVyID0gewogICAgICAgICAgaXNNb3VudGVkLAogICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihpbnN0LCBwYXlsb2FkLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAic2V0U3RhdGUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihpbnN0LCBwYXlsb2FkLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gUmVwbGFjZVN0YXRlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihpbnN0LCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5zaG91bGRDb21wb25lbnRVcGRhdGUoKTogUmV0dXJuZWQgdW5kZWZpbmVkIGluc3RlYWQgb2YgYSBib29sZWFuIHZhbHVlLiBNYWtlIHN1cmUgdG8gcmV0dXJuIHRydWUgb3IgZmFsc2UuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiBjdG9yLnByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4gIXNoYWxsb3dFcXVhbDIob2xkUHJvcHMsIG5ld1Byb3BzKSB8fCAhc2hhbGxvd0VxdWFsMihvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgdmFyIHJlbmRlclByZXNlbnQgPSBpbnN0YW5jZS5yZW5kZXI7CiAgICAgICAgICAgIGlmICghcmVuZGVyUHJlc2VudCkgewogICAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiB0eXBlb2YgY3Rvci5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IGRpZCB5b3UgYWNjaWRlbnRhbGx5IHJldHVybiBhbiBvYmplY3QgZnJvbSB0aGUgY29uc3RydWN0b3I/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBkZWZpbmUgYHJlbmRlcmAuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUgJiYgIWluc3RhbmNlLmdldEluaXRpYWxTdGF0ZS5pc1JlYWN0Q2xhc3NBcHByb3ZlZCAmJiAhaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0SW5pdGlhbFN0YXRlIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gRGlkIHlvdSBtZWFuIHRvIGRlZmluZSBhIHN0YXRlIHByb3BlcnR5IGluc3RlYWQ/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldERlZmF1bHRQcm9wcyAmJiAhaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgZGVmYXVsdFByb3BzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BUeXBlcykgewogICAgICAgICAgICAgIGVycm9yKCJwcm9wVHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgcHJvcFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdG9yLmNoaWxkQ29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNoaWxkQ29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSBpbnN0ZWFkXG5cbi5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgd2l0aCBzdGF0aWMgY29udGV4dFR5cGUgaW5zdGVhZC5cblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlICYmIGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWNsYXJlcyBib3RoIGNvbnRleHRUeXBlcyBhbmQgY29udGV4dFR5cGUgc3RhdGljIHByb3BlcnRpZXMuIFRoZSBsZWdhY3kgY29udGV4dFR5cGVzIHByb3BlcnR5IHdpbGwgYmUgaWdub3JlZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRTaG91bGRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRTaG91bGRVcGRhdGUoKS4gRGlkIHlvdSBtZWFuIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpPyBUaGUgbmFtZSBpcyBwaHJhc2VkIGFzIGEgcXVlc3Rpb24gYmVjYXVzZSB0aGUgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgdmFsdWUuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ICYmIHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkuIHNob3VsZENvbXBvbmVudFVwZGF0ZSBzaG91bGQgbm90IGJlIHVzZWQgd2hlbiBleHRlbmRpbmcgUmVhY3QuUHVyZUNvbXBvbmVudC4gUGxlYXNlIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaWYgc2hvdWxkQ29tcG9uZW50VXBkYXRlIGlzIHVzZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJBIHB1cmUgY29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkVW5tb3VudCgpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFVubW91bnQoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFJlY2VpdmVQcm9wcygpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBJZiB5b3UgbWVhbnQgdG8gdXBkYXRlIHRoZSBzdGF0ZSBpbiByZXNwb25zZSB0byBjaGFuZ2luZyBwcm9wcywgdXNlIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKS4gSWYgeW91IG1lYW50IHRvIGZldGNoIGRhdGEgb3IgcnVuIHNpZGUtZWZmZWN0cyBvciBtdXRhdGlvbnMgYWZ0ZXIgUmVhY3QgaGFzIHVwZGF0ZWQgdGhlIFVJLCB1c2UgY29tcG9uZW50RGlkVXBkYXRlKCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTXV0YXRlZFByb3BzID0gaW5zdGFuY2UucHJvcHMgIT09IG5ld1Byb3BzOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IHZvaWQgMCAmJiBoYXNNdXRhdGVkUHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogV2hlbiBjYWxsaW5nIHN1cGVyKCkgaW4gYCVzYCwgbWFrZSBzdXJlIHRvIHBhc3MgdXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCJTZXR0aW5nIGRlZmF1bHRQcm9wcyBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICFkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmFkZChjdG9yKTsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgc2hvdWxkIGJlIHVzZWQgd2l0aCBjb21wb25lbnREaWRVcGRhdGUoKS4gVGhpcyBjb21wb25lbnQgZGVmaW5lcyBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIG9ubHkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBpcyBkZWZpbmVkIGFzIGEgc3RhdGljIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGFuIGluc3RhbmNlIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3N0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgIGlmIChfc3RhdGUgJiYgKHR5cGVvZiBfc3RhdGUgIT09ICJvYmplY3QiIHx8IGlzQXJyYXkyKF9zdGF0ZSkpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLnN0YXRlOiBtdXN0IGJlIHNldCB0byBhbiBvYmplY3Qgb3IgbnVsbCIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBjdG9yLmNoaWxkQ29udGV4dFR5cGVzICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRDaGlsZENvbnRleHQoKTogY2hpbGRDb250ZXh0VHlwZXMgbXVzdCBiZSBkZWZpbmVkIGluIG9yZGVyIHRvIHVzZSBnZXRDaGlsZENvbnRleHQoKS4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZG9wdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UudXBkYXRlciA9IGNsYXNzQ29tcG9uZW50VXBkYXRlcjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgIHNldDMoaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIGluc3RhbmNlLl9yZWFjdEludGVybmFsSW5zdGFuY2UgPSBmYWtlSW50ZXJuYWxJbnN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHByb3BzKSB7CiAgICAgICAgICB2YXIgaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgiY29udGV4dFR5cGUiIGluIGN0b3IpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9ICgKICAgICAgICAgICAgICAgIC8vIEFsbG93IG51bGwgZm9yIGNvbmRpdGlvbmFsIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICBjb250ZXh0VHlwZSA9PT0gbnVsbCB8fCBjb250ZXh0VHlwZSAhPT0gdm9pZCAwICYmIGNvbnRleHRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgJiYgY29udGV4dFR5cGUuX2NvbnRleHQgPT09IHZvaWQgMAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkICYmICFkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgdmFyIGFkZGVuZHVtID0gIiI7CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dFR5cGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIHVuZGVmaW5lZC4gVGhpcyBjYW4gYmUgY2F1c2VkIGJ5IGEgdHlwbyBvciBieSBtaXhpbmcgdXAgbmFtZWQgYW5kIGRlZmF1bHQgaW1wb3J0cy4gVGhpcyBjYW4gYWxzbyBoYXBwZW4gZHVlIHRvIGEgY2lyY3VsYXIgZGVwZW5kZW5jeSwgc28gdHJ5IG1vdmluZyB0aGUgY3JlYXRlQ29udGV4dCgpIGNhbGwgdG8gYSBzZXBhcmF0ZSBmaWxlLiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhICIgKyB0eXBlb2YgY29udGV4dFR5cGUgKyAiLiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBwYXNzIHRoZSBDb250ZXh0LlByb3ZpZGVyIGluc3RlYWQ/IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGV4dFR5cGUuX2NvbnRleHQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Db25zdW1lciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIGFuIG9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhjb250ZXh0VHlwZSkuam9pbigiLCAiKSArICJ9LiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgZGVmaW5lcyBhbiBpbnZhbGlkIGNvbnRleHRUeXBlLiBjb250ZXh0VHlwZSBzaG91bGQgcG9pbnQgdG8gdGhlIENvbnRleHQgb2JqZWN0IHJldHVybmVkIGJ5IFJlYWN0LmNyZWF0ZUNvbnRleHQoKS4lcyIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IiwgYWRkZW5kdW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgY29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gY3Rvci5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gY29udGV4dFR5cGVzICE9PSBudWxsICYmIGNvbnRleHRUeXBlcyAhPT0gdm9pZCAwOwogICAgICAgICAgICBjb250ZXh0ID0gaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPyBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KSA6IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5ldyBjdG9yKHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZSA9IG5ldyBjdG9yKHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSAhPT0gbnVsbCAmJiBpbnN0YW5jZS5zdGF0ZSAhPT0gdm9pZCAwID8gaW5zdGFuY2Uuc3RhdGUgOiBudWxsOwogICAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iICYmIHN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoImAlc2AgdXNlcyBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBidXQgaXRzIGluaXRpYWwgc3RhdGUgaXMgJXMuIFRoaXMgaXMgbm90IHJlY29tbWVuZGVkLiBJbnN0ZWFkLCBkZWZpbmUgdGhlIGluaXRpYWwgc3RhdGUgYnkgYXNzaWduaW5nIGFuIG9iamVjdCB0byBgdGhpcy5zdGF0ZWAgaW4gdGhlIGNvbnN0cnVjdG9yIG9mIGAlc2AuIFRoaXMgZW5zdXJlcyB0aGF0IGBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHNgIGFyZ3VtZW50cyBoYXZlIGEgY29uc2lzdGVudCBzaGFwZS4iLCBjb21wb25lbnROYW1lLCBpbnN0YW5jZS5zdGF0ZSA9PT0gbnVsbCA/ICJudWxsIiA6ICJ1bmRlZmluZWQiLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsTW91bnROYW1lID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFVwZGF0ZU5hbWUgPSBudWxsOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudC5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxNb3VudE5hbWUgPSAiY29tcG9uZW50V2lsbE1vdW50IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxNb3VudE5hbWUgPSAiVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSAiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSAiVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxVcGRhdGVOYW1lID0gImNvbXBvbmVudFdpbGxVcGRhdGUiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxVcGRhdGVOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZvdW5kV2lsbE1vdW50TmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lICE9PSBudWxsIHx8IGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgIHZhciBuZXdBcGlOYW1lID0gdHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iID8gImdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcygpIiA6ICJnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZS5oYXMoX2NvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuYWRkKF9jb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuc2FmZSBsZWdhY3kgbGlmZWN5Y2xlcyB3aWxsIG5vdCBiZSBjYWxsZWQgZm9yIGNvbXBvbmVudHMgdXNpbmcgbmV3IGNvbXBvbmVudCBBUElzLlxuXG4lcyB1c2VzICVzIGJ1dCBhbHNvIGNvbnRhaW5zIHRoZSBmb2xsb3dpbmcgbGVnYWN5IGxpZmVjeWNsZXM6JXMlcyVzXG5cblRoZSBhYm92ZSBsaWZlY3ljbGVzIHNob3VsZCBiZSByZW1vdmVkLiBMZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOlxuaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyIsIF9jb21wb25lbnROYW1lLCBuZXdBcGlOYW1lLCBmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxNb3VudE5hbWUgOiAiIiwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgOiAiIiwgZm91bmRXaWxsVXBkYXRlTmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbFVwZGF0ZU5hbWUgOiAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIpIHsKICAgICAgICAgICAgY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxNb3VudCh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbGRTdGF0ZSAhPT0gaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCIlcy5jb21wb25lbnRXaWxsTW91bnQoKTogQXNzaWduaW5nIGRpcmVjdGx5IHRvIHRoaXMuc3RhdGUgaXMgZGVwcmVjYXRlZCAoZXhjZXB0IGluc2lkZSBhIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yKS4gVXNlIHNldFN0YXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbGFzc0NvbXBvbmVudFVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gb2xkU3RhdGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjbGFzc0NvbXBvbmVudFVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLnJlZnMgPSB7fTsKICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlID09PSBuZXdQcm9wcykgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZS5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEl0IGlzIG5vdCByZWNvbW1lbmRlZCB0byBhc3NpZ24gcHJvcHMgZGlyZWN0bHkgdG8gc3RhdGUgYmVjYXVzZSB1cGRhdGVzIHRvIHByb3BzIHdvbid0IGJlIHJlZmxlY3RlZCBpbiBzdGF0ZS4gSW4gbW9zdCBjYXNlcywgaXQgaXMgYmV0dGVyIHRvIHVzZSBwcm9wcyBkaXJlY3RseS4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wczsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSAhPT0gImZ1bmN0aW9uIiAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxNb3VudCh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkQ29udGV4dCA9IGluc3RhbmNlLmNvbnRleHQ7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBuZXh0Q29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBuZXh0TGVnYWN5VW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wczsKICAgICAgICAgIHZhciBoYXNOZXdMaWZlY3ljbGVzID0gdHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBuZXdQcm9wcyB8fCBvbGRDb250ZXh0ICE9PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCk7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGluc3RhbmNlLnN0YXRlID0gb2xkU3RhdGU7CiAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKG9sZFByb3BzID09PSBuZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgfHwgY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBfZmliZXJGbGFnczsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfZmliZXJGbGFnczIgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFnczIgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBfZmliZXJGbGFnczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciB1bnJlc29sdmVkT2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi50eXBlID09PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPyB1bnJlc29sdmVkT2xkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMih3b3JrSW5Qcm9ncmVzczIudHlwZSwgdW5yZXNvbHZlZE9sZFByb3BzKTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSB1bnJlc29sdmVkTmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgPT09IHVucmVzb2x2ZWROZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSAmJiAhZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbikgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB8fCAvLyBUT0RPOiBJbiBzb21lIGNhc2VzLCB3ZSdsbCBlbmQgdXAgY2hlY2tpbmcgaWYgY29udGV4dCBoYXMgY2hhbmdlZCB0d2ljZSwKICAgICAgICAgIC8vIGJvdGggYmVmb3JlIGFuZCBhZnRlciBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCBoYXMgYmVlbiBjYWxsZWQuIE5vdCBpZGVhbCwKICAgICAgICAgIC8vIGJ1dCBJJ20gbG9hdGggdG8gcmVmYWN0b3IgdGhpcyBmdW5jdGlvbi4gVGhpcyBvbmx5IGhhcHBlbnMgZm9yIG1lbW9pemVkCiAgICAgICAgICAvLyBjb21wb25lbnRzIHNvIGl0J3Mgbm90IHRoYXQgY29tbW9uLgogICAgICAgICAgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbjsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgICAgc3RhY2s6IGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChzb3VyY2UpLAogICAgICAgICAgICBkaWdlc3Q6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWUodmFsdWUsIGRpZ2VzdCwgc3RhY2spIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2U6IG51bGwsCiAgICAgICAgICAgIHN0YWNrOiBzdGFjayAhPSBudWxsID8gc3RhY2sgOiBudWxsLAogICAgICAgICAgICBkaWdlc3Q6IGRpZ2VzdCAhPSBudWxsID8gZGlnZXN0IDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2dDYXB0dXJlZEVycm9yKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgaWYgKGxvZ0Vycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBlcnJvckluZm8uc291cmNlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiI7CiAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gc291cmNlID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihzb3VyY2UpIDogbnVsbDsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZU1lc3NhZ2UgPSBjb21wb25lbnROYW1lID8gIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiB0aGUgPCIgKyBjb21wb25lbnROYW1lICsgIj4gY29tcG9uZW50OiIgOiAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIG9uZSBvZiB5b3VyIFJlYWN0IGNvbXBvbmVudHM6IjsKICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU1lc3NhZ2U7CiAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIkNvbnNpZGVyIGFkZGluZyBhbiBlcnJvciBib3VuZGFyeSB0byB5b3VyIHRyZWUgdG8gY3VzdG9taXplIGVycm9yIGhhbmRsaW5nIGJlaGF2aW9yLlxuVmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Vycm9yLWJvdW5kYXJpZXMgdG8gbGVhcm4gbW9yZSBhYm91dCBlcnJvciBib3VuZGFyaWVzLiI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoYm91bmRhcnkpIHx8ICJBbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiUmVhY3Qgd2lsbCB0cnkgdG8gcmVjcmVhdGUgdGhpcyBjb21wb25lbnQgdHJlZSBmcm9tIHNjcmF0Y2ggIiArICgidXNpbmcgdGhlIGVycm9yIGJvdW5kYXJ5IHlvdSBwcm92aWRlZCwgIiArIGVycm9yQm91bmRhcnlOYW1lICsgIi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9IGNvbXBvbmVudE5hbWVNZXNzYWdlICsgIlxuIiArIGNvbXBvbmVudFN0YWNrICsgIlxuXG4iICsgKCIiICsgZXJyb3JCb3VuZGFyeU1lc3NhZ2UpOwogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oY29tYmluZWRNZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCQxID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3RFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG9uVW5jYXVnaHRFcnJvcihlcnJvcjIpOwogICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPSBmaWJlci50eXBlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvcjsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IkMSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKGluc3QgIT09IG51bGwgJiYgdHlwZW9mIGluc3QuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2soKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBtYXJrTGVnYWN5RXJyb3JCb3VuZGFyeUFzRmFpbGVkKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IkMTIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IkMTIsIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUoZmliZXIubGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogRXJyb3IgYm91bmRhcmllcyBzaG91bGQgaW1wbGVtZW50IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpLiBJbiB0aGF0IG1ldGhvZCwgcmV0dXJuIGEgc3RhdGUgdXBkYXRlIHRvIGRpc3BsYXkgYW4gZXJyb3IgbWVzc2FnZSBvciBmYWxsYmFjayBVSS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGU7CiAgICAgICAgICB2YXIgdGhyZWFkSURzOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwJDEoKTsKICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocmVhZElEcyA9IHBpbmdDYWNoZS5nZXQod2FrZWFibGUpOwogICAgICAgICAgICBpZiAodGhyZWFkSURzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhyZWFkSURzLmhhcyhsYW5lcykpIHsKICAgICAgICAgICAgdGhyZWFkSURzLmFkZChsYW5lcyk7CiAgICAgICAgICAgIHZhciBwaW5nID0gcGluZ1N1c3BlbmRlZFJvb3QuYmluZChudWxsLCByb290Mywgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZS50aGVuKHBpbmcsIHBpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlID0gdXBkYXRlUXVldWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YWtlYWJsZXMuYWRkKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgdmFyIHRhZyA9IHNvdXJjZUZpYmVyLnRhZzsKICAgICAgICAgIGlmICgoc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmICh0YWcgPT09IEZ1bmN0aW9uQ29tcG9uZW50IHx8IHRhZyA9PT0gRm9yd2FyZFJlZjIgfHwgdGFnID09PSBTaW1wbGVNZW1vQ29tcG9uZW50KSkgewogICAgICAgICAgICB2YXIgY3VycmVudFNvdXJjZSA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRTb3VyY2UpIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IGN1cnJlbnRTb3VyY2UudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnRTb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IGN1cnJlbnRTb3VyY2UubGFuZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc291cmNlRmliZXIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHJldHVybkZpYmVyOwogICAgICAgICAgZG8gewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50ICYmIHNob3VsZENhcHR1cmVTdXNwZW5zZShub2RlKSkgewogICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKG5vZGUgIT09IG51bGwpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIGlmICgoc3VzcGVuc2VCb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkgPT09IHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyB8PSBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzICY9IH4oTGlmZWN5Y2xlRWZmZWN0TWFzayB8IEluY29tcGxldGUpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VGaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNvdXJjZUZpYmVyID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTb3VyY2VGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci50YWcgPSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZVVwZGF0ZShzb3VyY2VGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhzb3VyY2VGaWJlci5sYW5lcywgU3luY0xhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdXNwZW5zZUJvdW5kYXJ5OwogICAgICAgICAgfQogICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5sYW5lcyA9IHJvb3RSZW5kZXJMYW5lczsKICAgICAgICAgIHJldHVybiBzdXNwZW5zZUJvdW5kYXJ5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd0V4Y2VwdGlvbihyb290MywgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCB2YWx1ZSwgcm9vdFJlbmRlckxhbmVzKSB7CiAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdmFsdWUudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgd2FrZWFibGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzICY9IH5Gb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFBpbmdMaXN0ZW5lcihyb290Mywgd2FrZWFibGUsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGF0dGFjaFJldHJ5TGlzdGVuZXIoc3VzcGVuc2VCb3VuZGFyeSwgcm9vdDMsIHdha2VhYmxlKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpbmNsdWRlc1N5bmNMYW5lKHJvb3RSZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFBpbmdMaXN0ZW5lcihyb290Mywgd2FrZWFibGUsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB1bmNhdWdodFN1c3BlbnNlRXJyb3IgPSBuZXcgRXJyb3IoIkEgY29tcG9uZW50IHN1c3BlbmRlZCB3aGlsZSByZXNwb25kaW5nIHRvIHN5bmNocm9ub3VzIGlucHV0LiBUaGlzIHdpbGwgY2F1c2UgdGhlIFVJIHRvIGJlIHJlcGxhY2VkIHdpdGggYSBsb2FkaW5nIGluZGljYXRvci4gVG8gZml4LCB1cGRhdGVzIHRoYXQgc3VzcGVuZCBzaG91bGQgYmUgd3JhcHBlZCB3aXRoIHN0YXJ0VHJhbnNpdGlvbi4iKTsKICAgICAgICAgICAgICB2YWx1ZSA9IHVuY2F1Z2h0U3VzcGVuc2VFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgbWFya0RpZFRocm93V2hpbGVIeWRyYXRpbmdERVYoKTsKICAgICAgICAgICAgICB2YXIgX3N1c3BlbnNlQm91bmRhcnkgPSBnZXROZWFyZXN0U3VzcGVuc2VCb3VuZGFyeVRvQ2FwdHVyZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgaWYgKF9zdXNwZW5zZUJvdW5kYXJ5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoKF9zdXNwZW5zZUJvdW5kYXJ5LmZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoX3N1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcikpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcih2YWx1ZSwgc291cmNlRmliZXIpOwogICAgICAgICAgcmVuZGVyRGlkRXJyb3IodmFsdWUpOwogICAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzMiA9IHJldHVybkZpYmVyOwogICAgICAgICAgZG8gewogICAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgX2Vycm9ySW5mbyA9IHZhbHVlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgX2Vycm9ySW5mbywgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgdmFyIGVycm9ySW5mbyA9IHZhbHVlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzICYmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIgfHwgaW5zdGFuY2UgIT09IG51bGwgJiYgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZENhdGNoID09PSAiZnVuY3Rpb24iICYmICFpc0FscmVhZHlGYWlsZWRMZWdhY3lFcnJvckJvdW5kYXJ5KGluc3RhbmNlKSkpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHZhciBfbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIHZhciBfdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGVycm9ySW5mbywgX2xhbmUpOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfdXBkYXRlKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKHdvcmtJblByb2dyZXNzMiAhPT0gbnVsbCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZENhY2hlKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRCYWRDbGFzczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRCYWRDbGFzcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudCA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnMgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9ucyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudCA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRm9yd2FyZFJlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlbmRlcjIgPSBDb21wb25lbnQucmVuZGVyOwogICAgICAgICAgdmFyIHJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyMiwgbmV4dFByb3BzLCByZWYsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyMiwgbmV4dFByb3BzLCByZWYsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdHlwZSA9IENvbXBvbmVudC50eXBlOwogICAgICAgICAgICBpZiAoaXNTaW1wbGVGdW5jdGlvbkNvbXBvbmVudCh0eXBlKSAmJiBDb21wb25lbnQuY29tcGFyZSA9PT0gbnVsbCAmJiAvLyBTaW1wbGVNZW1vQ29tcG9uZW50IGNvZGVwYXRoIGRvZXNuJ3QgcmVzb2x2ZSBvdXRlciBwcm9wcyBlaXRoZXIuCiAgICAgICAgICAgIENvbXBvbmVudC5kZWZhdWx0UHJvcHMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciByZXNvbHZlZFR5cGUgPSB0eXBlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IFNpbXBsZU1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlZFR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlc29sdmVkVHlwZSwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKENvbXBvbmVudC5kZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogU3VwcG9ydCBmb3IgZGVmYXVsdFByb3BzIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIG1lbW8gY29tcG9uZW50cyBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBVc2UgSmF2YVNjcmlwdCBkZWZhdWx0IHBhcmFtZXRlcnMgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyhDb21wb25lbnQudHlwZSwgbnVsbCwgbmV4dFByb3BzLCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5tb2RlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjaGlsZC5yZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfdHlwZSA9IENvbXBvbmVudC50eXBlOwogICAgICAgICAgICB2YXIgX2lubmVyUHJvcFR5cGVzID0gX3R5cGUucHJvcFR5cGVzOwogICAgICAgICAgICBpZiAoX2lubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICBfaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50Q2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHZhciBoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQgPSBjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50Q2hpbGQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgdmFyIGNvbXBhcmUgPSBDb21wb25lbnQuY29tcGFyZTsKICAgICAgICAgICAgY29tcGFyZSA9IGNvbXBhcmUgIT09IG51bGwgPyBjb21wYXJlIDogc2hhbGxvd0VxdWFsMjsKICAgICAgICAgICAgaWYgKGNvbXBhcmUocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQ0LnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBuZXh0UHJvcHMpOwogICAgICAgICAgbmV3Q2hpbGQucmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG5ld0NoaWxkOwogICAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgb3V0ZXJNZW1vVHlwZSA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgICBpZiAob3V0ZXJNZW1vVHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IG91dGVyTWVtb1R5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBvdXRlck1lbW9UeXBlID0gaW5pdChwYXlsb2FkKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gb3V0ZXJNZW1vVHlwZSAmJiBvdXRlck1lbW9UeXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgKFNpbXBsZU1lbW9Db21wb25lbnQgaGFzIG5vIGRlZmF1bHRQcm9wcykKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG91dGVyTWVtb1R5cGUpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChzaGFsbG93RXF1YWwyKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50NC5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYgJiYgLy8gUHJldmVudCBiYWlsb3V0IGlmIHRoZSBpbXBsZW1lbnRhdGlvbiBjaGFuZ2VkIGR1ZSB0byBob3QgcmVsb2FkLgogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzID0gbmV4dFByb3BzID0gcHJldlByb3BzOwogICAgICAgICAgICAgIGlmICghY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKChjdXJyZW50NC5mbGFncyAmIEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2UpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSA6IG51bGw7CiAgICAgICAgICBpZiAobmV4dFByb3BzLm1vZGUgPT09ICJoaWRkZW4iIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV4dFN0YXRlOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgIHZhciBzcGF3bmVkQ2FjaGVQb29sID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV4dEJhc2VMYW5lczsKICAgICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkJhc2VMYW5lcyA9IHByZXZTdGF0ZS5iYXNlTGFuZXM7CiAgICAgICAgICAgICAgICBuZXh0QmFzZUxhbmVzID0gbWVyZ2VMYW5lcyhwcmV2QmFzZUxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXh0QmFzZUxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBuZXh0QmFzZUxhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBzcGF3bmVkQ2FjaGVQb29sLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIG5leHRCYXNlTGFuZXMpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlMiA9IHsKICAgICAgICAgICAgICAgIGJhc2VMYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGNhY2hlUG9vbDogbnVsbCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IF9uZXh0U3RhdGUyOwogICAgICAgICAgICAgIHZhciBzdWJ0cmVlUmVuZGVyTGFuZXMyID0gcHJldlN0YXRlICE9PSBudWxsID8gcHJldlN0YXRlLmJhc2VMYW5lcyA6IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCBzdWJ0cmVlUmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zdWJ0cmVlUmVuZGVyTGFuZXM7CiAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBfc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhwcmV2U3RhdGUuYmFzZUxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBfc3VidHJlZVJlbmRlckxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIF9zdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVByb2ZpbGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCAmJiByZWYgIT09IG51bGwgfHwgY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQucmVmICE9PSByZWYpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZjI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udGV4dDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChzaG91bGRFcnJvcih3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgY2FzZSBmYWxzZTogewogICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIHRlbXBJbnN0YW5jZSA9IG5ldyBjdG9yKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLCBfaW5zdGFuY2UuY29udGV4dCk7CiAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB0ZW1wSW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgICAgICBfaW5zdGFuY2UudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUoX2luc3RhbmNlLCBzdGF0ZSwgbnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSB0cnVlOiB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSBuZXcgRXJyb3IoIlNpbXVsYXRlZCBlcnJvciBjb21pbmcgZnJvbSBEZXZUb29scyIpOwogICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIGxhbmUpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvciQxLCB3b3JrSW5Qcm9ncmVzczIpLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaGFzQ29udGV4dDsKICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZTsKICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMpOwogICAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gcmVzdW1lTW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRVbml0T2ZXb3JrID0gZmluaXNoQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBzaG91bGRVcGRhdGUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0ID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSAmJiBpbnN0LnByb3BzICE9PSBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJdCBsb29rcyBsaWtlICVzIGlzIHJlYXNzaWduaW5nIGl0cyBvd24gYHRoaXMucHJvcHNgIHdoaWxlIHJlbmRlcmluZy4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCBjYW4gbGVhZCB0byBjb25mdXNpbmcgYnVncy4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgImEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV4dFVuaXRPZldvcms7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIG1hcmtSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgZGlkQ2FwdHVyZUVycm9yID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgaWYgKCFzaG91bGRVcGRhdGUgJiYgIWRpZENhcHR1cmVFcnJvcikgewogICAgICAgICAgICBpZiAoaGFzQ29udGV4dCkgewogICAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICBpZiAoZGlkQ2FwdHVyZUVycm9yICYmIHR5cGVvZiBDb21wb25lbnQuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiBkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChyb290My5wZW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzMiwgcm9vdDMucGVuZGluZ0NvbnRleHQsIHJvb3QzLnBlbmRpbmdDb250ZXh0ICE9PSByb290My5jb250ZXh0KTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdDMuY29udGV4dCkgewogICAgICAgICAgICBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGV4dCwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCByb290My5jb250YWluZXJJbmZvKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9zdFJvb3QoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIGN1cnJlbnQgZmliZXIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwcmV2Q2hpbGRyZW4gPSBwcmV2U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJvcHMsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRTdGF0ZS5lbGVtZW50OwogICAgICAgICAgaWYgKHByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQpIHsKICAgICAgICAgICAgdmFyIG92ZXJyaWRlU3RhdGUgPSB7CiAgICAgICAgICAgICAgZWxlbWVudDogbmV4dENoaWxkcmVuLAogICAgICAgICAgICAgIGlzRGVoeWRyYXRlZDogZmFsc2UsCiAgICAgICAgICAgICAgY2FjaGU6IG5leHRTdGF0ZS5jYWNoZSwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBuZXh0U3RhdGUucGVuZGluZ1N1c3BlbnNlQm91bmRhcmllcywKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbmV4dFN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgdXBkYXRlUXVldWUuYmFzZVN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBvdmVycmlkZVN0YXRlOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZy4gQmVjYXVzZSB0aGUgZXJyb3IgaGFwcGVuZWQgb3V0c2lkZSBvZiBhIFN1c3BlbnNlIGJvdW5kYXJ5LCB0aGUgZW50aXJlIHJvb3Qgd2lsbCBzd2l0Y2ggdG8gY2xpZW50IHJlbmRlcmluZy4iKSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRDaGlsZHJlbiAhPT0gcHJldkNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgdmFyIF9yZWNvdmVyYWJsZUVycm9yID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIobmV3IEVycm9yKCJUaGlzIHJvb3QgcmVjZWl2ZWQgYW4gZWFybHkgdXBkYXRlLCBiZWZvcmUgYW55dGhpbmcgd2FzIGFibGUgaHlkcmF0ZS4gU3dpdGNoZWQgdGhlIGVudGlyZSByb290IHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCBfcmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZW50ZXJIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSBjaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICAgICAgbm9kZS5mbGFncyA9IG5vZGUuZmxhZ3MgJiB+UGxhY2VtZW50IHwgSHlkcmF0aW5nOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgaWYgKG5leHRDaGlsZHJlbiA9PT0gcHJldkNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgcmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgcXVldWVIeWRyYXRpb25FcnJvcihyZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG51bGw7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIGlzRGlyZWN0VGV4dENoaWxkID0gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgbmV4dFByb3BzKTsKICAgICAgICAgIGlmIChpc0RpcmVjdFRleHRDaGlsZCkgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfSBlbHNlIGlmIChwcmV2UHJvcHMgIT09IG51bGwgJiYgc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJldlByb3BzKSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ29udGVudFJlc2V0OwogICAgICAgICAgfQogICAgICAgICAgbWFya1JlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TGF6eUNvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBlbGVtZW50VHlwZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gZWxlbWVudFR5cGU7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gaW5pdChwYXlsb2FkKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50OwogICAgICAgICAgdmFyIHJlc29sdmVkVGFnID0gd29ya0luUHJvZ3Jlc3MyLnRhZyA9IHJlc29sdmVMYXp5Q29tcG9uZW50VGFnKENvbXBvbmVudCk7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgc3dpdGNoIChyZXNvbHZlZFRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUNsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUZvcndhcmRSZWYobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgZm9yIG91dGVyIG9ubHkKICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZU1lbW9Db21wb25lbnQoCiAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgQ29tcG9uZW50LAogICAgICAgICAgICAgICAgcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LnR5cGUsIHJlc29sdmVkUHJvcHMpLAogICAgICAgICAgICAgICAgLy8gVGhlIGlubmVyIHR5cGUgY2FuIGhhdmUgZGVmYXVsdHMgdG9vCiAgICAgICAgICAgICAgICByZW5kZXJMYW5lczIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhpbnQgPSAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudCAhPT0gbnVsbCAmJiB0eXBlb2YgQ29tcG9uZW50ID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgIGhpbnQgPSAiIERpZCB5b3Ugd3JhcCBhIGNvbXBvbmVudCBpbiBSZWFjdC5sYXp5KCkgbW9yZSB0aGFuIG9uY2U/IjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbGVtZW50IHR5cGUgaXMgaW52YWxpZC4gUmVjZWl2ZWQgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG86ICIgKyBDb21wb25lbnQgKyAiLiAiICsgKCJMYXp5IGVsZW1lbnQgdHlwZSBtdXN0IHJlc29sdmUgdG8gYSBjbGFzcyBvciBmdW5jdGlvbi4iICsgaGludCkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluY29tcGxldGVDbGFzc0NvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IENsYXNzQ29tcG9uZW50OwogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGZhbHNlKTsKICAgICAgICAgICAgY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29tcG9uZW50LnByb3RvdHlwZSAmJiB0eXBlb2YgQ29tcG9uZW50LnByb3RvdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBoYXZlIGEgcmVuZGVyIG1ldGhvZCwgYnV0IGRvZXNuJ3QgZXh0ZW5kIFJlYWN0LkNvbXBvbmVudC4gVGhpcyBpcyBsaWtlbHkgdG8gY2F1c2UgZXJyb3JzLiBDaGFuZ2UgJXMgdG8gZXh0ZW5kIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0QmFkQ2xhc3NbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkTGVnYWN5Q29udGV4dFdhcm5pbmcod29ya0luUHJvZ3Jlc3MyLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIgJiYgdmFsdWUuJCR0eXBlb2YgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBiZSBhIGZ1bmN0aW9uIGNvbXBvbmVudCB0aGF0IHJldHVybnMgYSBjbGFzcyBpbnN0YW5jZS4gQ2hhbmdlICVzIHRvIGEgY2xhc3MgdGhhdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiBJZiB5b3UgY2FuJ3QgdXNlIGEgY2xhc3MgdHJ5IGFzc2lnbmluZyB0aGUgcHJvdG90eXBlIG9uIHRoZSBmdW5jdGlvbiBhcyBhIHdvcmthcm91bmQuIGAlcy5wcm90b3R5cGUgPSBSZWFjdC5Db21wb25lbnQucHJvdG90eXBlYC4gRG9uJ3QgdXNlIGFuIGFycm93IGZ1bmN0aW9uIHNpbmNlIGl0IGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBgbmV3YCBieSBSZWFjdC4iLCBfY29tcG9uZW50TmFtZSwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgKICAgICAgICAgICAgLy8gUnVuIHRoZXNlIGNoZWNrcyBpbiBwcm9kdWN0aW9uIG9ubHkgaWYgdGhlIGZsYWcgaXMgb2ZmLgogICAgICAgICAgICAvLyBFdmVudHVhbGx5IHdlJ2xsIGRlbGV0ZSB0aGlzIGJyYW5jaCBhbHRvZ2V0aGVyLgogICAgICAgICAgICB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIgJiYgdmFsdWUuJCR0eXBlb2YgPT09IHZvaWQgMAogICAgICAgICAgKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUyID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTJdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBiZSBhIGZ1bmN0aW9uIGNvbXBvbmVudCB0aGF0IHJldHVybnMgYSBjbGFzcyBpbnN0YW5jZS4gQ2hhbmdlICVzIHRvIGEgY2xhc3MgdGhhdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiBJZiB5b3UgY2FuJ3QgdXNlIGEgY2xhc3MgdHJ5IGFzc2lnbmluZyB0aGUgcHJvdG90eXBlIG9uIHRoZSBmdW5jdGlvbiBhcyBhIHdvcmthcm91bmQuIGAlcy5wcm90b3R5cGUgPSBSZWFjdC5Db21wb25lbnQucHJvdG90eXBlYC4gRG9uJ3QgdXNlIGFuIGFycm93IGZ1bmN0aW9uIHNpbmNlIGl0IGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBgbmV3YCBieSBSZWFjdC4iLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMiwgX2NvbXBvbmVudE5hbWUyKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICB2YXIgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgIGhhc0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSB2YWx1ZS5zdGF0ZSAhPT0gbnVsbCAmJiB2YWx1ZS5zdGF0ZSAhPT0gdm9pZCAwID8gdmFsdWUuc3RhdGUgOiBudWxsOwogICAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgdmFsdWUpOwogICAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gZmluaXNoQ2xhc3NDb21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlID0gcmVuZGVyV2l0aEhvb2tzKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIHZhbHVlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudCkgewogICAgICAgICAgICAgIGlmIChDb21wb25lbnQuY2hpbGRDb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBjaGlsZENvbnRleHRUeXBlcyBjYW5ub3QgYmUgZGVmaW5lZCBvbiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4iLCBDb21wb25lbnQuZGlzcGxheU5hbWUgfHwgQ29tcG9uZW50Lm5hbWUgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgdmFyIG93bmVyTmFtZSA9IGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCk7CiAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBvd25lck5hbWUgfHwgIiI7CiAgICAgICAgICAgICAgdmFyIGRlYnVnU291cmNlID0gd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICBpZiAoZGVidWdTb3VyY2UpIHsKICAgICAgICAgICAgICAgIHdhcm5pbmdLZXkgPSBkZWJ1Z1NvdXJjZS5maWxlTmFtZSArICI6IiArIGRlYnVnU291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnNbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMuIEF0dGVtcHRzIHRvIGFjY2VzcyB0aGlzIHJlZiB3aWxsIGZhaWwuIERpZCB5b3UgbWVhbiB0byB1c2UgUmVhY3QuZm9yd2FyZFJlZigpPyVzIiwgaW5mbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChDb21wb25lbnQuZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogU3VwcG9ydCBmb3IgZGVmYXVsdFByb3BzIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIGZ1bmN0aW9uIGNvbXBvbmVudHMgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVXNlIEphdmFTY3JpcHQgZGVmYXVsdCBwYXJhbWV0ZXJzIGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMyA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBGdW5jdGlvbiBjb21wb25lbnRzIGRvIG5vdCBzdXBwb3J0IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4iLCBfY29tcG9uZW50TmFtZTMpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTNdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQuY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIENvbXBvbmVudC5jb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTQgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWU0XSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBGdW5jdGlvbiBjb21wb25lbnRzIGRvIG5vdCBzdXBwb3J0IGNvbnRleHRUeXBlLiIsIF9jb21wb25lbnROYW1lNCk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWU0XSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBTVVNQRU5ERURfTUFSS0VSID0gewogICAgICAgICAgZGVoeWRyYXRlZDogbnVsbCwKICAgICAgICAgIHRyZWVDb250ZXh0OiBudWxsLAogICAgICAgICAgcmV0cnlMYW5lOiBOb0xhbmUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJhc2VMYW5lczogcmVuZGVyTGFuZXMyLAogICAgICAgICAgICBjYWNoZVBvb2w6IGdldFN1c3BlbmRlZENhY2hlKCksCiAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY2FjaGVQb29sID0gbnVsbDsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJhc2VMYW5lczogbWVyZ2VMYW5lcyhwcmV2T2Zmc2NyZWVuU3RhdGUuYmFzZUxhbmVzLCByZW5kZXJMYW5lczIpLAogICAgICAgICAgICBjYWNoZVBvb2wsCiAgICAgICAgICAgIHRyYW5zaXRpb25zOiBwcmV2T2Zmc2NyZWVuU3RhdGUudHJhbnNpdGlvbnMKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVtYWluaW5nV29ya0luUHJpbWFyeVRyZWUoY3VycmVudDQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmV0dXJuIHJlbW92ZUxhbmVzKGN1cnJlbnQ0LmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChzaG91bGRTdXNwZW5kKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG93RmFsbGJhY2sgPSBmYWxzZTsKICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgaWYgKGRpZFN1c3BlbmQgfHwgc2hvdWxkUmVtYWluT25GYWxsYmFjayhzdXNwZW5zZUNvbnRleHQsIGN1cnJlbnQ0KSkgewogICAgICAgICAgICBzaG93RmFsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkRpZENhcHR1cmU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IGFkZFN1YnRyZWVTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGRlaHlkcmF0ZWQgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgaWYgKGRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudERlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudCh3b3JrSW5Qcm9ncmVzczIsIGRlaHlkcmF0ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICBpZiAoc2hvd0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdmFyIGZhbGxiYWNrRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4sIG5leHRGYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5tZW1vaXplZFN0YXRlID0gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0ZyYWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIF9kZWh5ZHJhdGVkID0gcHJldlN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgaWYgKF9kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGRpZFN1c3BlbmQsIG5leHRQcm9wcywgX2RlaHlkcmF0ZWQsIHByZXZTdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgICAgdmFyIF9uZXh0UHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSB1cGRhdGVTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4sIF9uZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50MiA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN0YXRlID0gY3VycmVudDQuY2hpbGQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLm1lbW9pemVkU3RhdGUgPSBwcmV2T2Zmc2NyZWVuU3RhdGUgPT09IG51bGwgPyBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSA6IHVwZGF0ZVN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocHJldk9mZnNjcmVlblN0YXRlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIuY2hpbGRMYW5lcyA9IGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbjIgPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDMgPSB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfbmV4dFByaW1hcnlDaGlsZHJlbjIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybiBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBtb2RlKTsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50OwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucGVuZGluZ1Byb3BzID0gcHJpbWFyeUNoaWxkUHJvcHM7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKG9mZnNjcmVlblByb3BzLCBtb2RlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ob2Zmc2NyZWVuUHJvcHMsIG1vZGUsIE5vTGFuZXMsIG51bGwpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnQ0LCBvZmZzY3JlZW5Qcm9wcykgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQ0LCBvZmZzY3JlZW5Qcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50ID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQsIHsKICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgIH0KICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgaWYgKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gW2N1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnRdOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogImhpZGRlbiIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEluIGxlZ2FjeSBtb2RlLCB3ZSBjb21taXQgdGhlIHByaW1hcnkgdHJlZSBhcyBpZiBpdCBzdWNjZXNzZnVsbHkKICAgICAgICAgICAgLy8gY29tcGxldGVkLCBldmVuIHRob3VnaCBpdCdzIGluIGFuIGluY29uc2lzdGVudCBzdGF0ZS4KICAgICAgICAgICAgKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiAvLyBNYWtlIHN1cmUgd2UncmUgb24gdGhlIHNlY29uZCBwYXNzLCBpLmUuIHRoZSBwcmltYXJ5IGNoaWxkIGZyYWdtZW50IHdhcwogICAgICAgICAgICAvLyBhbHJlYWR5IGNsb25lZC4gSW4gbGVnYWN5IG1vZGUsIHRoZSBvbmx5IGNhc2Ugd2hlcmUgdGhpcyBpc24ndCB0cnVlIGlzCiAgICAgICAgICAgIC8vIHdoZW4gRGV2VG9vbHMgZm9yY2VzIHVzIHRvIGRpc3BsYXkgYSBmYWxsYmFjazsgd2Ugc2tpcCB0aGUgZmlyc3QgcmVuZGVyCiAgICAgICAgICAgIC8vIHBhc3MgZW50aXJlbHkgYW5kIGdvIHN0cmFpZ2h0IHRvIHJlbmRlcmluZyB0aGUgZmFsbGJhY2suIChJbiBDb25jdXJyZW50CiAgICAgICAgICAgIC8vIE1vZGUsIFN1c3BlbnNlTGlzdCBjYW4gYWxzbyB0cmlnZ2VyIHRoaXMgc2NlbmFyaW8sIGJ1dCB0aGlzIGlzIGEgbGVnYWN5LQogICAgICAgICAgICAvLyBvbmx5IGNvZGVwYXRoLikKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkICE9PSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQKICAgICAgICAgICkgewogICAgICAgICAgICB2YXIgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50OwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucGVuZGluZ1Byb3BzID0gcHJpbWFyeUNoaWxkUHJvcHM7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCBwcmltYXJ5Q2hpbGRQcm9wcyk7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnN1YnRyZWVGbGFncyA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQsIGZhbGxiYWNrQ2hpbGRyZW4pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgbW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9yICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbik7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VGYWxsYmFja0FmdGVyUmV0cnlXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgZmliZXJNb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgZmliZXJNb2RlKTsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBmaWJlck1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUluc3RhbmNlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCBoeWRyYXRlIFN1c3BlbnNlIGluIGxlZ2FjeSBtb2RlLiBTd2l0Y2ggZnJvbSBSZWFjdERPTS5oeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcikgdG8gUmVhY3RET01DbGllbnQuaHlkcmF0ZVJvb3QoY29udGFpbmVyLCA8QXBwIC8+KS5yZW5kZXIoZWxlbWVudCkgb3IgcmVtb3ZlIHRoZSBTdXNwZW5zZSBjb21wb25lbnRzIGZyb20gdGhlIHNlcnZlciByZW5kZXJlZCBjb21wb25lbnRzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKFN5bmNMYW5lKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbGFuZVRvTGFuZXMoRGVmYXVsdEh5ZHJhdGlvbkxhbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGRpZFN1c3BlbmQsIG5leHRQcm9wcywgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoIWRpZFN1c3BlbmQpIHsKICAgICAgICAgICAgd2FybklmSHlkcmF0aW5nKCk7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZygKICAgICAgICAgICAgICAgIGN1cnJlbnQ0LAogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyLAogICAgICAgICAgICAgICAgLy8gVE9ETzogV2hlbiB3ZSBkZWxldGUgbGVnYWN5IG1vZGUsIHdlIHNob3VsZCBtYWtlIHRoaXMgZXJyb3IgYXJndW1lbnQKICAgICAgICAgICAgICAgIC8vIHJlcXVpcmVkIOKAlCBldmVyeSBjb25jdXJyZW50IG1vZGUgcGF0aCB0aGF0IGNhdXNlcyBoeWRyYXRpb24gdG8KICAgICAgICAgICAgICAgIC8vIGRlLW9wdCB0byBjbGllbnQgcmVuZGVyaW5nIHNob3VsZCBoYXZlIGFuIGVycm9yIG1lc3NhZ2UuCiAgICAgICAgICAgICAgICBudWxsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICB2YXIgZGlnZXN0LCBtZXNzYWdlLCBzdGFjazsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX2dldFN1c3BlbnNlSW5zdGFuY2VGID0gZ2V0U3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrRXJyb3JEZXRhaWxzKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgZGlnZXN0ID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLmRpZ2VzdDsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYubWVzc2FnZTsKICAgICAgICAgICAgICAgIHN0YWNrID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLnN0YWNrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IyOwogICAgICAgICAgICAgIGlmIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IobWVzc2FnZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcigiVGhlIHNlcnZlciBjb3VsZCBub3QgZmluaXNoIHRoaXMgU3VzcGVuc2UgYm91bmRhcnksIGxpa2VseSBkdWUgdG8gYW4gZXJyb3IgZHVyaW5nIHNlcnZlciByZW5kZXJpbmcuIFN3aXRjaGVkIHRvIGNsaWVudCByZW5kZXJpbmcuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjYXB0dXJlZFZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShlcnJvcjIsIGRpZ2VzdCwgc3RhY2spOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIGNhcHR1cmVkVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNDb250ZXh0Q2hhbmdlZDIgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgY3VycmVudDQuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgIGlmIChkaWRSZWNlaXZlVXBkYXRlIHx8IGhhc0NvbnRleHRDaGFuZ2VkMikgewogICAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdExhbmUgPSBnZXRCdW1wZWRMYW5lRm9ySHlkcmF0aW9uKHJvb3QzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRIeWRyYXRpb25BdExhbmUgIT09IE5vTGFuZSAmJiBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSkgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSA9IGF0dGVtcHRIeWRyYXRpb25BdExhbmU7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGN1cnJlbnQ0LCBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lKTsKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBjdXJyZW50NCwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUobmV3IEVycm9yKCJUaGlzIFN1c3BlbnNlIGJvdW5kYXJ5IHJlY2VpdmVkIGFuIHVwZGF0ZSBiZWZvcmUgaXQgZmluaXNoZWQgaHlkcmF0aW5nLiBUaGlzIGNhdXNlZCB0aGUgYm91bmRhcnkgdG8gc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIFRoZSB1c3VhbCB3YXkgdG8gZml4IHRoaXMgaXMgdG8gd3JhcCB0aGUgb3JpZ2luYWwgdXBkYXRlIGluIHN0YXJ0VHJhbnNpdGlvbi4iKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgX2NhcHR1cmVkVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgICAgICB2YXIgcmV0cnkgPSByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5LmJpbmQobnVsbCwgY3VycmVudDQpOwogICAgICAgICAgICAgIHJlZ2lzdGVyU3VzcGVuc2VJbnN0YW5jZVJldHJ5KHN1c3BlbnNlSW5zdGFuY2UsIHJldHJ5KTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUluc3RhbmNlLCBzdXNwZW5zZVN0YXRlLnRyZWVDb250ZXh0KTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmZsYWdzIHw9IEh5ZHJhdGluZzsKICAgICAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JjZUNsaWVudFJlbmRlcikgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+Rm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgdmFyIF9jYXB0dXJlZFZhbHVlMiA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUobmV3IEVycm9yKCJUaGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgaHlkcmF0aW5nIHRoaXMgU3VzcGVuc2UgYm91bmRhcnkuIFN3aXRjaGVkIHRvIGNsaWVudCByZW5kZXJpbmcuIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VGYWxsYmFja0FmdGVyUmV0cnlXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4sIG5leHRGYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihmaWJlciwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhmaWJlci5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgZmlyc3RDaGlsZCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVTdXNwZW5zZVdvcmtPbkZpYmVyKG5vZGUsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlTGlzdENvbXBvbmVudCkgewogICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kTGFzdENvbnRlbnRSb3coZmlyc3RDaGlsZCkgewogICAgICAgICAgdmFyIHJvdyA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBudWxsOwogICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFJvdyA9IHJvdy5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50Um93ICE9PSBudWxsICYmIGZpbmRGaXJzdFN1c3BlbmRlZChjdXJyZW50Um93KSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RDb250ZW50Um93ID0gcm93OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhc3RDb250ZW50Um93OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXZlYWxPcmRlciAhPT0gdm9pZCAwICYmIHJldmVhbE9yZGVyICE9PSAiZm9yd2FyZHMiICYmIHJldmVhbE9yZGVyICE9PSAiYmFja3dhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gInRvZ2V0aGVyIiAmJiAhZGlkV2FybkFib3V0UmV2ZWFsT3JkZXJbcmV2ZWFsT3JkZXJdKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXJbcmV2ZWFsT3JkZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldmVhbE9yZGVyID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgc3dpdGNoIChyZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOgogICAgICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgdmFsaWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIFVzZSBsb3dlcmNhc2UgIiVzIiBpbnN0ZWFkLicsIHJldmVhbE9yZGVyLCByZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmQiOiB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgdmFsaWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIFJlYWN0IHVzZXMgdGhlIC1zIHN1ZmZpeCBpbiB0aGUgc3BlbGxpbmcuIFVzZSAiJXNzIiBpbnN0ZWFkLicsIHJldmVhbE9yZGVyLCByZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCclcyBpcyBub3QgYSBzdXBwb3J0ZWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIERpZCB5b3UgbWVhbiAidG9nZXRoZXIiLCAiZm9yd2FyZHMiIG9yICJiYWNrd2FyZHMiPycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVUYWlsT3B0aW9ucyh0YWlsTW9kZSwgcmV2ZWFsT3JkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHRhaWxNb2RlICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSkgewogICAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gImNvbGxhcHNlZCIgJiYgdGFpbE1vZGUgIT09ICJoaWRkZW4iKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciB0YWlsIG9uIDxTdXNwZW5zZUxpc3QgLz4uIERpZCB5b3UgbWVhbiAiY29sbGFwc2VkIiBvciAiaGlkZGVuIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignPFN1c3BlbnNlTGlzdCB0YWlsPSIlcyIgLz4gaXMgb25seSB2YWxpZCBpZiByZXZlYWxPcmRlciBpcyAiZm9yd2FyZHMiIG9yICJiYWNrd2FyZHMiLiBEaWQgeW91IG1lYW4gdG8gc3BlY2lmeSByZXZlYWxPcmRlcj0iZm9yd2FyZHMiPycsIHRhaWxNb2RlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChjaGlsZFNsb3QsIGluZGV4MikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNBbkFycmF5ID0gaXNBcnJheTIoY2hpbGRTbG90KTsKICAgICAgICAgICAgdmFyIGlzSXRlcmFibGUgPSAhaXNBbkFycmF5ICYmIHR5cGVvZiBnZXRJdGVyYXRvckZuKGNoaWxkU2xvdCkgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIGlmIChpc0FuQXJyYXkgfHwgaXNJdGVyYWJsZSkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gaXNBbkFycmF5ID8gImFycmF5IiA6ICJpdGVyYWJsZSI7CiAgICAgICAgICAgICAgZXJyb3IoIkEgbmVzdGVkICVzIHdhcyBwYXNzZWQgdG8gcm93ICMlcyBpbiA8U3VzcGVuc2VMaXN0IC8+LiBXcmFwIGl0IGluIGFuIGFkZGl0aW9uYWwgU3VzcGVuc2VMaXN0IHRvIGNvbmZpZ3VyZSBpdHMgcmV2ZWFsT3JkZXI6IDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPiAuLi4gPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+eyVzfTwvU3VzcGVuc2VMaXN0PiAuLi4gPC9TdXNwZW5zZUxpc3Q+IiwgdHlwZSwgaW5kZXgyLCB0eXBlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKGNoaWxkcmVuLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKHJldmVhbE9yZGVyID09PSAiZm9yd2FyZHMiIHx8IHJldmVhbE9yZGVyID09PSAiYmFja3dhcmRzIikgJiYgY2hpbGRyZW4gIT09IHZvaWQgMCAmJiBjaGlsZHJlbiAhPT0gbnVsbCAmJiBjaGlsZHJlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChjaGlsZHJlbltpXSwgaSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB2YXIgY2hpbGRyZW5JdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChjaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbkl0ZXJhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2kgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBzdGVwID0gY2hpbGRyZW5JdGVyYXRvci5uZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChzdGVwLnZhbHVlLCBfaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgX2krKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCdBIHNpbmdsZSByb3cgd2FzIHBhc3NlZCB0byBhIDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9IiVzIiAvPi4gVGhpcyBpcyBub3QgdXNlZnVsIHNpbmNlIGl0IG5lZWRzIG11bHRpcGxlIHJvd3MuIERpZCB5b3UgbWVhbiB0byBwYXNzIG11bHRpcGxlIGNoaWxkcmVuIG9yIGFuIGFycmF5PycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKHdvcmtJblByb2dyZXNzMiwgaXNCYWNrd2FyZHMsIHRhaWwsIGxhc3RDb250ZW50Um93LCB0YWlsTW9kZSkgewogICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocmVuZGVyU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSB7CiAgICAgICAgICAgICAgaXNCYWNrd2FyZHMsCiAgICAgICAgICAgICAgcmVuZGVyaW5nOiBudWxsLAogICAgICAgICAgICAgIHJlbmRlcmluZ1N0YXJ0VGltZTogMCwKICAgICAgICAgICAgICBsYXN0OiBsYXN0Q29udGVudFJvdywKICAgICAgICAgICAgICB0YWlsLAogICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZW5kZXJTdGF0ZS5pc0JhY2t3YXJkcyA9IGlzQmFja3dhcmRzOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBudWxsOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPSAwOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gbGFzdENvbnRlbnRSb3c7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSB0YWlsOwogICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsTW9kZSA9IHRhaWxNb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZXZlYWxPcmRlciA9IG5leHRQcm9wcy5yZXZlYWxPcmRlcjsKICAgICAgICAgIHZhciB0YWlsTW9kZSA9IG5leHRQcm9wcy50YWlsOwogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcik7CiAgICAgICAgICB2YWxpZGF0ZVRhaWxPcHRpb25zKHRhaWxNb2RlLCByZXZlYWxPcmRlcik7CiAgICAgICAgICB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKG5ld0NoaWxkcmVuLCByZXZlYWxPcmRlcik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvdWxkRm9yY2VGYWxsYmFjayA9IGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICBpZiAoc2hvdWxkRm9yY2VGYWxsYmFjaykgewogICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoIChyZXZlYWxPcmRlcikgewogICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjogewogICAgICAgICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gZmluZExhc3RDb250ZW50Um93KHdvcmtJblByb2dyZXNzMi5jaGlsZCk7CiAgICAgICAgICAgICAgICB2YXIgdGFpbDsKICAgICAgICAgICAgICAgIGlmIChsYXN0Q29udGVudFJvdyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0YWlsID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGFpbCA9IGxhc3RDb250ZW50Um93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICB0YWlsLAogICAgICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdywKICAgICAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgdmFyIF90YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciByb3cgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJvdyA9IHJvdy5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Um93ICE9PSBudWxsICYmIGZpbmRGaXJzdFN1c3BlbmRlZChjdXJyZW50Um93KSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJvdzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbmV4dFJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICByb3cuc2libGluZyA9IF90YWlsOwogICAgICAgICAgICAgICAgICBfdGFpbCA9IHJvdzsKICAgICAgICAgICAgICAgICAgcm93ID0gbmV4dFJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBfdGFpbCwKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgLy8gbGFzdAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6IHsKICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgLy8gdGFpbAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHZvaWQgMAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRleHRQcm92aWRlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBwcm92aWRlclR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcHJvdmlkZXJUeXBlLl9jb250ZXh0OwogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gbmV3UHJvcHMudmFsdWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghKCJ2YWx1ZSIgaW4gbmV3UHJvcHMpKSB7CiAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgdmFsdWVgIHByb3AgaXMgcmVxdWlyZWQgZm9yIHRoZSBgPENvbnRleHQuUHJvdmlkZXI+YC4gRGlkIHlvdSBtaXNzcGVsbCBpdCBvciBmb3JnZXQgdG8gcGFzcyBpdD8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3ZpZGVyUHJvcFR5cGVzID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICBpZiAocHJvdmlkZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm92aWRlclByb3BUeXBlcywgbmV3UHJvcHMsICJwcm9wIiwgIkNvbnRleHQuUHJvdmlkZXIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBvbGRQcm9wcy52YWx1ZTsKICAgICAgICAgICAgICBpZiAob2JqZWN0SXMob2xkVmFsdWUsIG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKG9sZFByb3BzLmNoaWxkcmVuID09PSBuZXdQcm9wcy5jaGlsZHJlbiAmJiAhaGFzQ29udGV4dENoYW5nZWQoKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDaGlsZHJlbiA9IG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dENvbnN1bWVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvbnRleHQuX2NvbnRleHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmIChjb250ZXh0ICE9PSBjb250ZXh0LkNvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lcikgewogICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0PiBkaXJlY3RseSBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQuX2NvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlbmRlcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb250ZXh0IGNvbnN1bWVyIHdhcyByZW5kZXJlZCB3aXRoIG11bHRpcGxlIGNoaWxkcmVuLCBvciBhIGNoaWxkIHRoYXQgaXNuJ3QgYSBmdW5jdGlvbi4gQSBjb250ZXh0IGNvbnN1bWVyIGV4cGVjdHMgYSBzaW5nbGUgY2hpbGQgdGhhdCBpcyBhIGZ1bmN0aW9uLiBJZiB5b3UgZGlkIHBhc3MgYSBmdW5jdGlvbiwgbWFrZSBzdXJlIHRoZXJlIGlzIG5vIHRyYWlsaW5nIG9yIGxlYWRpbmcgd2hpdGVzcGFjZSBhcm91bmQgaXQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXdDaGlsZHJlbiA9IHJlbmRlcjIobmV3VmFsdWUpOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKSB7CiAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnQ0LmRlcGVuZGVuY2llczsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzKTsKICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNsb25lQ2hpbGRGaWJlcnMoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdW50RmliZXIoY3VycmVudDQsIG9sZFdvcmtJblByb2dyZXNzLCBuZXdXb3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHN3YXAgdGhlIHJvb3QgZmliZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgb2xkV29ya0luUHJvZ3Jlc3MuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MuaW5kZXggPSBvbGRXb3JrSW5Qcm9ncmVzcy5pbmRleDsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3Muc2libGluZyA9IG9sZFdvcmtJblByb2dyZXNzLnNpYmxpbmc7CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnJldHVybiA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmVmID0gb2xkV29ya0luUHJvZ3Jlc3MucmVmOwogICAgICAgICAgICBpZiAob2xkV29ya0luUHJvZ3Jlc3MgPT09IHJldHVybkZpYmVyLmNoaWxkKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuY2hpbGQgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcHJldlNpYmxpbmcgPSByZXR1cm5GaWJlci5jaGlsZDsKICAgICAgICAgICAgICBpZiAocHJldlNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcGFyZW50IHRvIGhhdmUgYSBjaGlsZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHByZXZTaWJsaW5nLnNpYmxpbmcgIT09IG9sZFdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICBwcmV2U2libGluZyA9IHByZXZTaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgICBpZiAocHJldlNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIHRoZSBwcmV2aW91cyBzaWJsaW5nLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2U2libGluZy5zaWJsaW5nID0gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHJldHVybkZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjdXJyZW50NF07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50NCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICByZXR1cm4gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciB1cGRhdGVMYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUodXBkYXRlTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6IHsKICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy52YWx1ZTsKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHB1c2hQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBoYXNDaGlsZFdvcmsgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICAgICAgaWYgKGhhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRMYW5lcyA9IHByaW1hcnlDaGlsZEZyYWdtZW50LmNoaWxkTGFuZXM7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHByaW1hcnlDaGlsZExhbmVzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRCZWZvcmUgPSAoY3VycmVudDQuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICB2YXIgX2hhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRCZWZvcmUpIHsKICAgICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3RFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoX2hhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmVnaW5Xb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCAmJiBjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiByZW1vdW50RmliZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIua2V5LCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnT3duZXIgfHwgbnVsbCwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHdvcmtJblByb2dyZXNzMi5sYW5lcykpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBuZXdQcm9wcyB8fCBoYXNDb250ZXh0Q2hhbmdlZCgpIHx8IC8vIEZvcmNlIGEgcmUtcmVuZGVyIGlmIHRoZSBpbXBsZW1lbnRhdGlvbiBjaGFuZ2VkIGR1ZSB0byBob3QgcmVsb2FkOgogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQgPSBjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCAmJiAvLyBJZiB0aGlzIGlzIHRoZSBzZWNvbmQgcGFzcyBvZiBhbiBlcnJvciBvciBzdXNwZW5zZSBib3VuZGFyeSwgdGhlcmUKICAgICAgICAgICAgICAvLyBtYXkgbm90IGJlIHdvcmsgc2NoZWR1bGVkIG9uIGBjdXJyZW50YCwgc28gd2UgY2hlY2sgZm9yIHRoaXMgZmxhZy4KICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybiBhdHRlbXB0RWFybHlCYWlsb3V0SWZOb1NjaGVkdWxlZFVwZGF0ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSB3b3JrSW5Qcm9ncmVzczIuaW5kZXg7CiAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBnZXRGb3Jrc0F0TGV2ZWwoKTsKICAgICAgICAgICAgICBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcywgc2xvdEluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXp5Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGVsZW1lbnRUeXBlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIHVucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IENvbXBvbmVudCA/IHVucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgdW5yZXNvbHZlZFByb3BzKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX0NvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IF9Db21wb25lbnQgPyBfdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoX0NvbXBvbmVudCwgX3VucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQsIF9yZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0VGV4dChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjogewogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMyID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMyID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSB0eXBlID8gX3VucmVzb2x2ZWRQcm9wczIgOiByZXNvbHZlRGVmYXVsdFByb3BzMih0eXBlLCBfdW5yZXNvbHZlZFByb3BzMik7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZvcndhcmRSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgdHlwZSwgX3Jlc29sdmVkUHJvcHMyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQxMDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNb2RlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVByb2ZpbGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0UHJvdmlkZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNvbnRleHRDb25zdW1lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX3R5cGUyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMzID0gcmVzb2x2ZURlZmF1bHRQcm9wczIoX3R5cGUyLCBfdW5yZXNvbHZlZFByb3BzMyk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gX3R5cGUyLnByb3BUeXBlczsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICAgIF9yZXNvbHZlZFByb3BzMywKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIGZvciBvdXRlciBvbmx5CiAgICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoX3R5cGUyKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgX3Jlc29sdmVkUHJvcHMzID0gcmVzb2x2ZURlZmF1bHRQcm9wczIoX3R5cGUyLnR5cGUsIF9yZXNvbHZlZFByb3BzMyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX3R5cGUyLCBfcmVzb2x2ZWRQcm9wczMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX0NvbXBvbmVudDIgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczQgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczQgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IF9Db21wb25lbnQyID8gX3VucmVzb2x2ZWRQcm9wczQgOiByZXNvbHZlRGVmYXVsdFByb3BzMihfQ29tcG9uZW50MiwgX3VucmVzb2x2ZWRQcm9wczQpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluY29tcGxldGVDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfQ29tcG9uZW50MiwgX3Jlc29sdmVkUHJvcHM0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmMjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZlN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGFwcGVuZEFsbENoaWxkcmVuOwogICAgICAgIHZhciB1cGRhdGVIb3N0Q29udGFpbmVyOwogICAgICAgIHZhciB1cGRhdGVIb3N0Q29tcG9uZW50JDE7CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RUZXh0JDE7CiAgICAgICAgewogICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4gPSBmdW5jdGlvbihwYXJlbnQsIHdvcmtJblByb2dyZXNzMiwgbmVlZHNWaXNpYmlsaXR5VG9nZ2xlLCBpc0hpZGRlbikgewogICAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICBhcHBlbmRJbml0aWFsQ2hpbGQocGFyZW50LCBub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gSG9zdFBvcnRhbCkgOwogICAgICAgICAgICAgIGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIgPSBmdW5jdGlvbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudCQxID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgdHlwZSwgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICBpZiAob2xkUHJvcHMgPT09IG5ld1Byb3BzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50SG9zdENvbnRleHQgPSBnZXRIb3N0Q29udGV4dCgpOwogICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IHByZXBhcmVVcGRhdGUoaW5zdGFuY2UsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCkgewogICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0JDEgPSBmdW5jdGlvbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBvbGRUZXh0LCBuZXdUZXh0KSB7CiAgICAgICAgICAgIGlmIChvbGRUZXh0ICE9PSBuZXdUZXh0KSB7CiAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGhhc1JlbmRlcmVkQVRhaWxGYWxsYmFjaykgewogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChyZW5kZXJTdGF0ZS50YWlsTW9kZSkgewogICAgICAgICAgICBjYXNlICJoaWRkZW4iOiB7CiAgICAgICAgICAgICAgdmFyIHRhaWxOb2RlID0gcmVuZGVyU3RhdGUudGFpbDsKICAgICAgICAgICAgICB2YXIgbGFzdFRhaWxOb2RlID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAodGFpbE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0YWlsTm9kZS5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGFzdFRhaWxOb2RlID0gdGFpbE5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YWlsTm9kZSA9IHRhaWxOb2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYXN0VGFpbE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsYXN0VGFpbE5vZGUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImNvbGxhcHNlZCI6IHsKICAgICAgICAgICAgICB2YXIgX3RhaWxOb2RlID0gcmVuZGVyU3RhdGUudGFpbDsKICAgICAgICAgICAgICB2YXIgX2xhc3RUYWlsTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgd2hpbGUgKF90YWlsTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKF90YWlsTm9kZS5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgX2xhc3RUYWlsTm9kZSA9IF90YWlsTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF90YWlsTm9kZSA9IF90YWlsTm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoX2xhc3RUYWlsTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFoYXNSZW5kZXJlZEFUYWlsRmFsbGJhY2sgJiYgcmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9sYXN0VGFpbE5vZGUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJ1YmJsZVByb3BlcnRpZXMoY29tcGxldGVkV29yaykgewogICAgICAgICAgdmFyIGRpZEJhaWxvdXQgPSBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZSAhPT0gbnVsbCAmJiBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZS5jaGlsZCA9PT0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgIHZhciBuZXdDaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciBzdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgaWYgKCFkaWRCYWlsb3V0KSB7CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgYWN0dWFsRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIHZhciB0cmVlQmFzZUR1cmF0aW9uID0gY29tcGxldGVkV29yay5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKGNoaWxkLmxhbmVzLCBjaGlsZC5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gY2hpbGQuc3VidHJlZUZsYWdzOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IGNoaWxkLmZsYWdzOwogICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICB0cmVlQmFzZUR1cmF0aW9uICs9IGNoaWxkLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24gPSB0cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY2hpbGQgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoX2NoaWxkLmxhbmVzLCBfY2hpbGQuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZC5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkLmZsYWdzOwogICAgICAgICAgICAgICAgX2NoaWxkLnJldHVybiA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yay5zdWJ0cmVlRmxhZ3MgfD0gc3VidHJlZUZsYWdzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBfdHJlZUJhc2VEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgX2NoaWxkMiA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoX2NoaWxkMi5sYW5lcywgX2NoaWxkMi5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMi5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDIuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgX3RyZWVCYXNlRHVyYXRpb24gKz0gX2NoaWxkMi50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgX2NoaWxkMiA9IF9jaGlsZDIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay50cmVlQmFzZUR1cmF0aW9uID0gX3RyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jaGlsZDMgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZDMubGFuZXMsIF9jaGlsZDMuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDMuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQzLmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIF9jaGlsZDMucmV0dXJuID0gY29tcGxldGVkV29yazsKICAgICAgICAgICAgICAgIF9jaGlsZDMgPSBfY2hpbGQzLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuc3VidHJlZUZsYWdzIHw9IHN1YnRyZWVGbGFnczsKICAgICAgICAgIH0KICAgICAgICAgIGNvbXBsZXRlZFdvcmsuY2hpbGRMYW5lcyA9IG5ld0NoaWxkTGFuZXM7CiAgICAgICAgICByZXR1cm4gZGlkQmFpbG91dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0U3RhdGUpIHsKICAgICAgICAgIGlmIChoYXNVbmh5ZHJhdGVkVGFpbE5vZGVzKCkgJiYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUgJiYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXIgfCBJbmNvbXBsZXRlIHwgU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIGlmIChuZXh0U3RhdGUgIT09IG51bGwgJiYgbmV4dFN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKCF3YXNIeWRyYXRlZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBIGRlaHlkcmF0ZWQgc3VzcGVuc2UgY29tcG9uZW50IHdhcyBjb21wbGV0ZWQgd2l0aG91dCBhIGh5ZHJhdGVkIG5vZGUuIFRoaXMgaXMgcHJvYmFibHkgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGlzVGltZWRPdXRTdXNwZW5zZSA9IG5leHRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKGlzVGltZWRPdXRTdXNwZW5zZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pc1RpbWVkT3V0U3VzcGVuc2UgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChfaXNUaW1lZE91dFN1c3BlbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAoX3ByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBfcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGdyYWRlSHlkcmF0aW9uRXJyb3JzVG9SZWNvdmVyYWJsZSgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDEwOgogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyUm9vdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGlmIChmaWJlclJvb3QucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5jb250ZXh0ID0gZmliZXJSb290LnBlbmRpbmdDb250ZXh0OwogICAgICAgICAgICAgICAgZmliZXJSb290LnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgaWYgKHdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBjbGllbnQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgIXByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQgfHwgLy8gQ2hlY2sgaWYgd2UgcmV2ZXJ0ZWQgdG8gY2xpZW50IHJlbmRlcmluZyAoZS5nLiBkdWUgdG8gYW4gZXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpICE9PSBOb0ZsYWdzCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgICAgICAgICB1cGdyYWRlSHlkcmF0aW9uRXJyb3JzVG9SZWNvdmVyYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudCQxKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LnJlZiAhPT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFuZXdQcm9wcykgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlKHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4oaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMiwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICBpZiAoZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oaW5zdGFuY2UsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IG5ld1Byb3BzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0JDEoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VGV4dCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICAgIHZhciBfY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICAgIHZhciBfd2FzSHlkcmF0ZWQyID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3JlYXRlVGV4dEluc3RhbmNlKG5ld1RleHQsIF9yb290Q29udGFpbmVySW5zdGFuY2UsIF9jdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGggPSBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dERpZFRpbWVvdXQgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIHByZXZEaWRUaW1lb3V0ID0gY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQgIT09IHByZXZEaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5GaWJlcjIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5GaWJlcjIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCA9IGN1cnJlbnQ0ID09PSBudWxsICYmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy51bnN0YWJsZV9hdm9pZFRoaXNGYWxsYmFjayAhPT0gdHJ1ZSB8fCAhZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCB8fCBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZXBhcmVQb3J0YWxNb3VudCh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoX0NvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRBbHJlYWR5ID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZFRhaWwgPSByZW5kZXJTdGF0ZS5yZW5kZXJpbmc7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkVGFpbCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgY2Fubm90QmVTdXNwZW5kZWQgPSByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSAmJiAoY3VycmVudDQgPT09IG51bGwgfHwgKGN1cnJlbnQ0LmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpOwogICAgICAgICAgICAgICAgICBpZiAoIWNhbm5vdEJlU3VzcGVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJvdyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGhlbmFibGVzID0gc3VzcGVuZGVkLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3VGhlbmFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbmV3VGhlbmFibGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjaykpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcm93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsICYmIG5vdygpID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IFNvbWVSZXRyeUxhbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJlbmRlcmVkVGFpbCk7CiAgICAgICAgICAgICAgICAgIGlmIChfc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBfbmV3VGhlbmFibGVzID0gX3N1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoX25ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gX25ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLnRhaWwgPT09IG51bGwgJiYgcmVuZGVyU3RhdGUudGFpbE1vZGUgPT09ICJoaWRkZW4iICYmICFyZW5kZXJlZFRhaWwuYWx0ZXJuYXRlICYmICFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHRpbWUgaXQgdG9vayB0byByZW5kZXIgbGFzdCByb3cgaXMgZ3JlYXRlciB0aGFuIHRoZSByZW1haW5pbmcKICAgICAgICAgICAgICAgICAgICAvLyB0aW1lIHdlIGhhdmUgdG8gcmVuZGVyLiBTbyByZW5kZXJpbmcgb25lIG1vcmUgcm93IHdvdWxkIGxpa2VseQogICAgICAgICAgICAgICAgICAgIC8vIGV4Y2VlZCBpdC4KICAgICAgICAgICAgICAgICAgICBub3coKSAqIDIgLSByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgJiYgcmVuZGVyTGFuZXMyICE9PSBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUuaXNCYWNrd2FyZHMpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyZWRUYWlsLnNpYmxpbmcgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSByZW5kZXJTdGF0ZS5sYXN0OwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nLnNpYmxpbmcgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBuZXh0OwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG5leHQuc2libGluZzsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IG5vdygpOwogICAgICAgICAgICAgICAgbmV4dC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgdmFyIG5leHRJc0hpZGRlbiA9IF9uZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgcHJldklzSGlkZGVuID0gX3ByZXZTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwcmV2SXNIaWRkZW4gIT09IG5leHRJc0hpZGRlbiAmJiAvLyBMZWdhY3lIaWRkZW4gZG9lc24ndCBkbyBhbnkgaGlkaW5nIOKAlCBpdCBvbmx5IHByZS1yZW5kZXJzLgogICAgICAgICAgICAgICAgIWVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFuZXh0SXNIaWRkZW4gfHwgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoc3VidHJlZVJlbmRlckxhbmVzLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyAmIChQbGFjZW1lbnQgfCBVcGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIHZhciBfZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKChfZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSAhPT0gTm9GbGFncyAmJiAoX2ZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IF9mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRocmV3IGluIG5ld2x5IG1vdW50ZWQgZGVoeWRyYXRlZCBjb21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9mbGFnczIgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKF9mbGFnczIgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MyICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICBwb3BQcm92aWRlcihjb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQ0LCBpbnRlcnJ1cHRlZFdvcmssIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcG9wVHJlZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgIHN3aXRjaCAoaW50ZXJydXB0ZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgICAgaWYgKGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGludGVycnVwdGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmRlZmluZWRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICB2YXIgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgUG9zc2libHlXZWFrU2V0ID0gdHlwZW9mIFdlYWtTZXQgPT09ICJmdW5jdGlvbiIgPyBXZWFrU2V0IDogU2V0OwogICAgICAgIHZhciBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlcG9ydFVuY2F1Z2h0RXJyb3JJbkRFVihlcnJvcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNhbGxDb21wb25lbnRXaWxsVW5tb3VudFdpdGhUaW1lciA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0Lm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCwgY3VycmVudDQpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIoY3VycmVudDQsIGluc3RhbmNlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5QXR0YWNoUmVmKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoY3VycmVudDQpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciByZWYgPSBjdXJyZW50NC5yZWY7CiAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZW5hYmxlUHJvZmlsZXJDb21taXRIb29rcyAmJiBjdXJyZW50NC5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudDQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxEZXN0cm95KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IHByZXBhcmVGb3JDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpOwogICAgICAgICAgdmFyIHNob3VsZEZpcmUgPSBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXI7CiAgICAgICAgICBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRmlyZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2JlZ2luKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgQmVmb3JlTXV0YXRpb25NYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoKGZsYWdzICYgU25hcHNob3QpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzbmFwc2hvdCA9IGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlKGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBwcmV2UHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihmaW5pc2hlZFdvcmsudHlwZSwgcHJldlByb3BzKSwgcHJldlN0YXRlKTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBkaWRXYXJuU2V0ID0gZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNuYXBzaG90ID09PSB2b2lkIDAgJiYgIWRpZFdhcm5TZXQuaGFzKGZpbmlzaGVkV29yay50eXBlKSkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2FyblNldC5hZGQoZmluaXNoZWRXb3JrLnR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCk6IEEgc25hcHNob3QgdmFsdWUgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IHNuYXBzaG90OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgY2xlYXJDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmssIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgIGVmZmVjdC5kZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdCh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlZmZlY3QgPSBlZmZlY3QubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoZmxhZ3MsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSB1cGRhdGVRdWV1ZSAhPT0gbnVsbCA/IHVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgOiBudWxsOwogICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICB2YXIgZWZmZWN0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBmbGFncykgPT09IGZsYWdzKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNyZWF0ZSA9IGVmZmVjdC5jcmVhdGU7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVmZmVjdC5kZXN0cm95ID0gY3JlYXRlKCk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgZGVzdHJveSA9IGVmZmVjdC5kZXN0cm95OwogICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSAhPT0gdm9pZCAwICYmIHR5cGVvZiBkZXN0cm95ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gdm9pZCAwOwogICAgICAgICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIExheW91dCkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZWZmZWN0LnRhZyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIFlvdSByZXR1cm5lZCBudWxsLiBJZiB5b3VyIGVmZmVjdCBkb2VzIG5vdCByZXF1aXJlIGNsZWFuIHVwLCByZXR1cm4gdW5kZWZpbmVkIChvciBub3RoaW5nKS4iOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlc3Ryb3kudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiXG5cbkl0IGxvb2tzIGxpa2UgeW91IHdyb3RlICIgKyBob29rTmFtZSArICIoYXN5bmMgKCkgPT4gLi4uKSBvciByZXR1cm5lZCBhIFByb21pc2UuIEluc3RlYWQsIHdyaXRlIHRoZSBhc3luYyBmdW5jdGlvbiBpbnNpZGUgeW91ciBlZmZlY3QgYW5kIGNhbGwgaXQgaW1tZWRpYXRlbHk6XG5cbiIgKyBob29rTmFtZSArICIoKCkgPT4ge1xuICBhc3luYyBmdW5jdGlvbiBmZXRjaERhdGEoKSB7XG4gICAgLy8gWW91IGNhbiBhd2FpdCBoZXJlXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBNeUFQSS5nZXREYXRhKHNvbWVJZCk7XG4gICAgLy8gLi4uXG4gIH1cbiAgZmV0Y2hEYXRhKCk7XG59LCBbc29tZUlkXSk7IC8vIE9yIFtdIGlmIGVmZmVjdCBkb2Vzbid0IG5lZWQgcHJvcHMgb3Igc3RhdGVcblxuTGVhcm4gbW9yZSBhYm91dCBkYXRhIGZldGNoaW5nIHdpdGggSG9va3M6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ob29rcy1kYXRhLWZldGNoaW5nIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIFlvdSByZXR1cm5lZDogIiArIGRlc3Ryb3k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBtdXN0IG5vdCByZXR1cm4gYW55dGhpbmcgYmVzaWRlcyBhIGZ1bmN0aW9uLCB3aGljaCBpcyB1c2VkIGZvciBjbGVhbi11cC4lcyIsIGhvb2tOYW1lLCBhZGRlbmR1bSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLmZsYWdzICYgVXBkYXRlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjogewogICAgICAgICAgICAgICAgICB2YXIgcGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgIHZhciBfZmluaXNoZWRXb3JrJG1lbW9pemUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcywgaWQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUuaWQsIG9uUG9zdENvbW1pdCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZS5vblBvc3RDb21taXQ7CiAgICAgICAgICAgICAgICAgIHZhciBjb21taXRUaW1lMiA9IGdldENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgICAgICAgdmFyIHBoYXNlID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZSA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25Qb3N0Q29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgb25Qb3N0Q29tbWl0KGlkLCBwaGFzZSwgcGFzc2l2ZUVmZmVjdER1cmF0aW9uLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmluaXNoZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgICAgb3V0ZXI6IHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvb3QzLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBwYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBwYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0T25GaWJlcihmaW5pc2hlZFJvb3QsIGN1cnJlbnQ0LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihmaW5pc2hlZFdvcmsudHlwZSwgY3VycmVudDQubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZFVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSB1cGRhdGUgcXVldWUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIHVwZGF0ZVF1ZXVlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIF91cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmIChfdXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay5jaGlsZC50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZ2V0UHVibGljSW5zdGFuY2UoZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgX3VwZGF0ZVF1ZXVlLCBfaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsICYmIGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgY29tbWl0TW91bnQoX2luc3RhbmNlMiwgdHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmluaXNoZWRXb3JrJG1lbW9pemUyID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIG9uQ29tbWl0ID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vbkNvbW1pdCwgb25SZW5kZXIgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUyLm9uUmVuZGVyOwogICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0RHVyYXRpb24gPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGN1cnJlbnQ0ID09PSBudWxsID8gIm1vdW50IiA6ICJ1cGRhdGUiOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBwaGFzZSA9ICJuZXN0ZWQtdXBkYXRlIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvblJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUmVuZGVyKGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZmluaXNoZWRXb3JrLmFjdHVhbER1cmF0aW9uLCBmaW5pc2hlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiwgZmluaXNoZWRXb3JrLmFjdHVhbFN0YXJ0VGltZSwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uQ29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICBvbkNvbW1pdChmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcy5pZCwgcGhhc2UsIGVmZmVjdER1cmF0aW9uLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVucXVldWVQZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmluaXNoZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgICAgICBvdXRlcjogd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICByb290My5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGNvbW1pdFN1c3BlbnNlSHlkcmF0aW9uQ2FsbGJhY2tzKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgdW5pdCBvZiB3b3JrIHRhZyBzaG91bGQgbm90IGhhdmUgc2lkZS1lZmZlY3RzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihub2RlKSB7CiAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihub2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KG5vZGUsIG5vZGUucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgc2FmZWx5QXR0YWNoUmVmKG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihmaW5pc2hlZFdvcmssIGlzSGlkZGVuKSB7CiAgICAgICAgICB2YXIgaG9zdFN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVJbnN0YW5jZShub2RlLnN0YXRlTm9kZSwgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHVuaGlkZVRleHRJbnN0YW5jZShfaW5zdGFuY2UzLCBub2RlLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgobm9kZS50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gTGVnYWN5SGlkZGVuQ29tcG9uZW50KSAmJiBub2RlLm1lbW9pemVkU3RhdGUgIT09IG51bGwgJiYgbm9kZSAhPT0gZmluaXNoZWRXb3JrKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEF0dGFjaFJlZihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciByZWYgPSBmaW5pc2hlZFdvcmsucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBpbnN0YW5jZVRvVXNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgcmV0VmFsOwogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXRWYWwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmV0dXJuIHZhbHVlIGZyb20gYSBjYWxsYmFjayByZWYgaW4gJXMuIEEgY2FsbGJhY2sgcmVmIHNob3VsZCBub3QgcmV0dXJuIGEgZnVuY3Rpb24uIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFyZWYuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZWYgb2JqZWN0IHByb3ZpZGVkIGZvciAlcy4gVXNlIGVpdGhlciBhIHJlZi1zZXR0ZXIgZnVuY3Rpb24gb3IgUmVhY3QuY3JlYXRlUmVmKCkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBpbnN0YW5jZVRvVXNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyTXV0YXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5yZXR1cm4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGFsdGVybmF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRldGFjaERlbGV0ZWRJbnN0YW5jZShob3N0SW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlci5yZXR1cm4gPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UGFyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0hvc3RQYXJlbnQocGFyZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hvc3RQYXJlbnQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgZmliZXIudGFnID09PSBIb3N0Um9vdCB8fCBmaWJlci50YWcgPT09IEhvc3RQb3J0YWw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RTaWJsaW5nKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgc2libGluZ3M6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgaXNIb3N0UGFyZW50KG5vZGUucmV0dXJuKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBub2RlLnRhZyAhPT0gSG9zdFRleHQgJiYgbm9kZS50YWcgIT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGQgPT09IG51bGwgfHwgbm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEobm9kZS5mbGFncyAmIFBsYWNlbWVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZ2V0SG9zdFBhcmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChwYXJlbnQpOwogICAgICAgICAgICAgICAgcGFyZW50RmliZXIuZmxhZ3MgJj0gfkNvbnRlbnRSZXNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJlZm9yZSA9IGdldEhvc3RTaWJsaW5nKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKGZpbmlzaGVkV29yaywgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHZhciBfcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgdmFyIF9iZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIoZmluaXNoZWRXb3JrLCBfYmVmb3JlLCBfcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBob3N0IHBhcmVudCBmaWJlci4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRJbkNvbnRhaW5lckJlZm9yZShwYXJlbnQsIHN0YXRlTm9kZSwgYmVmb3JlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGNoaWxkLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIHdoaWxlIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGQocGFyZW50LCBzdGF0ZU5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFBvcnRhbCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICB2YXIgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCByZXR1cm5GaWJlciwgZGVsZXRlZEZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgZmluZFBhcmVudDogd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50LnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhayBmaW5kUGFyZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0UGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgaG9zdCBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGRldGFjaEZpYmVyTXV0YXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIHBhcmVudCkgewogICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBjaGlsZCk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgb25Db21taXRVbm1vdW50KGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICBzd2l0Y2ggKGRlbGV0ZWRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2SG9zdFBhcmVudCA9IGhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBwcmV2SG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZUNoaWxkRnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZChob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudElzQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5RnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIF9wcmV2SG9zdFBhcmVudElzQ29udGFpbmVyID0gaG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBfcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBkZWxldGVkRmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0OwogICAgICAgICAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgdmFyIF9lZmZlY3QgPSBlZmZlY3QsIGRlc3Ryb3kgPSBfZWZmZWN0LmRlc3Ryb3ksIHRhZyA9IF9lZmZlY3QudGFnOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRhZyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsZXRlZEZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZGVsZXRlZEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgZGVsZXRlZEZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiB8fCBkZWxldGVkRmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFN1c3BlbnNlSHlkcmF0aW9uQ2FsbGJhY2tzKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29tbWl0SHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHdha2VhYmxlcyA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh3YWtlYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHJldHJ5Q2FjaGUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAocmV0cnlDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlID0gbmV3IFBvc3NpYmx5V2Vha1NldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdha2VhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uKHdha2VhYmxlKSB7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmVzb2x2ZVJldHJ5V2FrZWFibGUuYmluZChudWxsLCBmaW5pc2hlZFdvcmssIHdha2VhYmxlKTsKICAgICAgICAgICAgICBpZiAoIXJldHJ5Q2FjaGUuaGFzKHdha2VhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0cnlDYWNoZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5Qcm9ncmVzc0xhbmVzICE9PSBudWxsICYmIGluUHJvZ3Jlc3NSb290ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKGluUHJvZ3Jlc3NSb290LCBpblByb2dyZXNzTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiRXhwZWN0ZWQgZmluaXNoZWQgcm9vdCBhbmQgbGFuZXMgdG8gYmUgc2V0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FrZWFibGUudGhlbihyZXRyeSwgcmV0cnkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gY29tbWl0dGVkTGFuZXM7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkV29yaywgcm9vdDMpOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBwYXJlbnRGaWJlciwgbGFuZXMpIHsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBwYXJlbnRGaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY2hpbGRUb0RlbGV0ZSwgcGFyZW50RmliZXIsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkRlYnVnRmliZXIgPSBnZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5zdWJ0cmVlRmxhZ3MgJiBNdXRhdGlvbk1hc2spIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50RmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjaGlsZCk7CiAgICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihjaGlsZCwgcm9vdDMpOwogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHByZXZEZWJ1Z0ZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgIHZhciBmbGFncyA9IGZpbmlzaGVkV29yay5mbGFnczsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoSW5zZXJ0aW9uIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBjdXJyZW50NC5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBjdXJyZW50NC5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmZsYWdzICYgQ29udGVudFJlc2V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2U0ID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZTQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXdQcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG5ld1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlKF9pbnN0YW5jZTQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgc2hvdWxkIGhhdmUgYSB0ZXh0IG5vZGUgaW5pdGlhbGl6ZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHZhciBuZXdUZXh0ID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogbmV3VGV4dDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2Um9vdFN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldlJvb3RTdGF0ZS5pc0RlaHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5GaWJlciA9IGZpbmlzaGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuRmliZXIuZmxhZ3MgJiBWaXNpYmlsaXR5KSB7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuSW5zdGFuY2UgPSBvZmZzY3JlZW5GaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBvZmZzY3JlZW5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gbmV3U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5JbnN0YW5jZS5pc0hpZGRlbiA9IGlzSGlkZGVuOwogICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YXNIaWRkZW4gPSBvZmZzY3JlZW5GaWJlci5hbHRlcm5hdGUgIT09IG51bGwgJiYgb2Zmc2NyZWVuRmliZXIuYWx0ZXJuYXRlLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmICghd2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbW1pdFRpbWVPZkZhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX3dhc0hpZGRlbiA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgZGVhZCBmbGFnCiAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsubW9kZSAmIENvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuIHx8IF93YXNIaWRkZW47CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBWaXNpYmlsaXR5KSB7CiAgICAgICAgICAgICAgICB2YXIgX29mZnNjcmVlbkluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBfbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfaXNIaWRkZW4gPSBfbmV3U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuQm91bmRhcnkgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBfaXNIaWRkZW47CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChfaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIV93YXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICgob2Zmc2NyZWVuQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBvZmZzY3JlZW5Cb3VuZGFyeTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQm91bmRhcnkuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvZmZzY3JlZW5DaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBvZmZzY3JlZW5DaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKG9mZnNjcmVlbkNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzY3JlZW5DaGlsZCA9IG9mZnNjcmVlbkNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4ob2Zmc2NyZWVuQm91bmRhcnksIF9pc0hpZGRlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoZmxhZ3MgJiBQbGFjZW1lbnQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRQbGFjZW1lbnQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+UGxhY2VtZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZsYWdzICYgSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+SHlkcmF0aW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBjb21taXR0ZWRMYW5lczsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSAoc3VidHJlZVJvb3QubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gT2Zmc2NyZWVuQ29tcG9uZW50ICYmIGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGlzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICBpZiAobmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgbmV3T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHdhc0hpZGRlbiB8fCBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gbmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG5ld09mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiAmJiAhcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oCiAgICAgICAgICAgICAgICAgICAgY2hpbGQsCiAgICAgICAgICAgICAgICAgICAgLy8gTmV3IHJvb3Q7IGJ1YmJsZSBiYWNrIHVwIHRvIGhlcmUgYW5kIHN0b3AuCiAgICAgICAgICAgICAgICAgICAgcm9vdDMsCiAgICAgICAgICAgICAgICAgICAgY29tbWl0dGVkTGFuZXMKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzICYmIGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIocm9vdDMsIGN1cnJlbnQ0LCBmaWJlciwgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaWJlcik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGZpYmVyLCBmaWJlci5yZXR1cm4sIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gZmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRpc2FwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc2FwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzICYmIGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmICgoZmliZXIuZmxhZ3MgJiBQYXNzaXZlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIocm9vdDMsIGZpYmVyLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50T25GaWJlcihmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzKGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2JlZ2luKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKG5leHRFZmZlY3QuZmxhZ3MgJiBDaGlsZERlbGV0aW9uKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBmaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpYmVyVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlclRvRGVsZXRlOwogICAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGZpYmVyVG9EZWxldGUsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkQ2hpbGQgPSBwcmV2aW91c0ZpYmVyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0ZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkU2libGluZyA9IGRldGFjaGVkQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZCA9IGRldGFjaGVkU2libGluZzsKICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRldGFjaGVkQ2hpbGQgIT09IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihkZWxldGVkU3VidHJlZVJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9jb21wbGV0ZShkZWxldGVkU3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpOwogICAgICAgICAgICAgIGlmIChmaWJlciA9PT0gZGVsZXRlZFN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICBzd2l0Y2ggKGN1cnJlbnQ0LnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSwgY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSwgY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXlvdXRFZmZlY3RNb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGZpYmVyLCBmaWJlci5yZXR1cm4sIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENPTVBPTkVOVF9UWVBFID0gMDsKICAgICAgICB2YXIgSEFTX1BTRVVET19DTEFTU19UWVBFID0gMTsKICAgICAgICB2YXIgUk9MRV9UWVBFID0gMjsKICAgICAgICB2YXIgVEVTVF9OQU1FX1RZUEUgPSAzOwogICAgICAgIHZhciBURVhUX1RZUEUgPSA0OwogICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5mb3IpIHsKICAgICAgICAgIHZhciBzeW1ib2xGb3IgPSBTeW1ib2wuZm9yOwogICAgICAgICAgQ09NUE9ORU5UX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLmNvbXBvbmVudCIpOwogICAgICAgICAgSEFTX1BTRVVET19DTEFTU19UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5oYXNfcHNldWRvX2NsYXNzIik7CiAgICAgICAgICBST0xFX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnJvbGUiKTsKICAgICAgICAgIFRFU1RfTkFNRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXN0X2lkIik7CiAgICAgICAgICBURVhUX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnRleHQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbW1pdEhvb2tzID0gW107CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290JDEoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbW1pdEhvb2tzLmZvckVhY2goZnVuY3Rpb24oY29tbWl0SG9vaykgewogICAgICAgICAgICAgIHJldHVybiBjb21taXRIb29rKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICBmdW5jdGlvbiBpc0xlZ2FjeUFjdEVudmlyb25tZW50KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgPSAoCiAgICAgICAgICAgICAgLy8gJEZsb3dFeHBlY3RlZEVycm9yIOKAkyBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgZ2xvYmFsCiAgICAgICAgICAgICAgdHlwZW9mIElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCAhPT0gInVuZGVmaW5lZCIgPyBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgOiB2b2lkIDAKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIGplc3RJc0RlZmluZWQgPSB0eXBlb2YgamVzdCAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIHJldHVybiBqZXN0SXNEZWZpbmVkICYmIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAhPT0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGN1cnJlbnQgdGVzdGluZyBlbnZpcm9ubWVudCBpcyBub3QgY29uZmlndXJlZCB0byBzdXBwb3J0IGFjdCguLi4pIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNlaWwgPSBNYXRoLmNlaWw7CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXIsIFJlYWN0Q3VycmVudE93bmVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lciwgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLCBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgdmFyIE5vQ29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgQmF0Y2hlZENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUmVuZGVyQ29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgQ29tbWl0Q29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUm9vdEluUHJvZ3Jlc3MgPSAwOwogICAgICAgIHZhciBSb290RmF0YWxFcnJvcmVkID0gMTsKICAgICAgICB2YXIgUm9vdEVycm9yZWQgPSAyOwogICAgICAgIHZhciBSb290U3VzcGVuZGVkID0gMzsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZFdpdGhEZWxheSA9IDQ7CiAgICAgICAgdmFyIFJvb3RDb21wbGV0ZWQgPSA1OwogICAgICAgIHZhciBSb290RGlkTm90Q29tcGxldGUgPSA2OwogICAgICAgIHZhciBleGVjdXRpb25Db250ZXh0ID0gTm9Db250ZXh0OwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5vTGFuZXMpOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgdmFyIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSAwOwogICAgICAgIHZhciBGQUxMQkFDS19USFJPVFRMRV9NUyA9IDUwMDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyVGFyZ2V0VGltZSA9IEluZmluaXR5OwogICAgICAgIHZhciBSRU5ERVJfVElNRU9VVF9NUyA9IDUwMDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVzZXRSZW5kZXJUaW1lcigpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBub3coKSArIFJFTkRFUl9USU1FT1VUX01TOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWU7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNVbmNhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGZpcnN0VW5jYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICB2YXIgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICB2YXIgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSBudWxsOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgdmFyIHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIHZhciBORVNURURfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICB2YXIgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICB2YXIgTkVTVEVEX1BBU1NJVkVfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgdmFyIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgdmFyIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID0gTm9MYW5lczsKICAgICAgICB2YXIgaXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEV2ZW50VGltZSgpIHsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIG5vdygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRFdmVudFRpbWUgIT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IG5vdygpOwogICAgICAgICAgcmV0dXJuIGN1cnJlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9IGVsc2UgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCAmJiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gcGlja0FyYml0cmFyeUxhbmUod29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzVHJhbnNpdGlvbiA9IHJlcXVlc3RDdXJyZW50VHJhbnNpdGlvbigpICE9PSBOb1RyYW5zaXRpb247CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgICBpZiAoIXRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMpIHsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID09PSBOb0xhbmUpIHsKICAgICAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRMYW5lID0gZ2V0Q3VycmVudEV2ZW50UHJpb3JpdHkoKTsKICAgICAgICAgIHJldHVybiBldmVudExhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RSZXRyeUxhbmUoZmliZXIpIHsKICAgICAgICAgIHZhciBtb2RlID0gZmliZXIubW9kZTsKICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBTeW5jTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjbGFpbU5leHRSZXRyeUxhbmUoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICBjaGVja0Zvck5lc3RlZFVwZGF0ZXMoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCkgewogICAgICAgICAgICAgIGVycm9yKCJ1c2VJbnNlcnRpb25FZmZlY3QgbXVzdCBub3Qgc2NoZWR1bGUgdXBkYXRlcy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0xhbmVzICYmIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QpIHsKICAgICAgICAgICAgd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcik7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICBpZiAobGFuZSA9PT0gU3luY0xhbmUgJiYgZXhlY3V0aW9uQ29udGV4dCA9PT0gTm9Db250ZXh0ICYmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHJvb3QzLmN1cnJlbnQ7CiAgICAgICAgICBjdXJyZW50NC5sYW5lcyA9IGxhbmU7CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIGV2ZW50VGltZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVW5zYWZlQ2xhc3NSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikgewogICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIG91dGRhdGVkIGRlZmVyUmVuZGVyUGhhc2VVcGRhdGVUb05leHRCYXRjaCBleHBlcmltZW50LiBXZQogICAgICAgICAgICAvLyBkZWNpZGVkIG5vdCB0byBlbmFibGUgaXQuCiAgICAgICAgICAgIChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgbWFya1N0YXJ2ZWRMYW5lc0FzRXhwaXJlZChyb290MywgY3VycmVudFRpbWUpOwogICAgICAgICAgdmFyIG5leHRMYW5lcyA9IGdldE5leHRMYW5lcyhyb290Mywgcm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCA/IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzIDogTm9MYW5lcyk7CiAgICAgICAgICBpZiAobmV4dExhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0NhbGxiYWNrTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNhbmNlbENhbGxiYWNrJDEoZXhpc3RpbmdDYWxsYmFja05vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDYWxsYmFja1ByaW9yaXR5ID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShuZXh0TGFuZXMpOwogICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9IHJvb3QzLmNhbGxiYWNrUHJpb3JpdHk7CiAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ID09PSBuZXdDYWxsYmFja1ByaW9yaXR5ICYmIC8vIFNwZWNpYWwgY2FzZSByZWxhdGVkIHRvIGBhY3RgLiBJZiB0aGUgY3VycmVudGx5IHNjaGVkdWxlZCB0YXNrIGlzIGEKICAgICAgICAgIC8vIFNjaGVkdWxlciB0YXNrLCByYXRoZXIgdGhhbiBhbiBgYWN0YCB0YXNrLCBjYW5jZWwgaXQgYW5kIHJlLXNjaGVkdWxlZAogICAgICAgICAgLy8gb24gdGhlIGBhY3RgIHF1ZXVlLgogICAgICAgICAgIShSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IGZha2VBY3RDYWxsYmFja05vZGUpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgPT0gbnVsbCAmJiBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgIT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgc2NoZWR1bGVkIGNhbGxiYWNrIHRvIGV4aXN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT0gbnVsbCkgewogICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDYWxsYmFja05vZGU7CiAgICAgICAgICBpZiAobmV3Q2FsbGJhY2tQcmlvcml0eSA9PT0gU3luY0xhbmUpIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyA9PT0gTGVnYWN5Um9vdCkgewogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjaGVkdWxlU3luY0NhbGxiYWNrKHBlcmZvcm1TeW5jV29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudC5wdXNoKGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlTWljcm90YXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIHN3aXRjaCAobGFuZXNUb0V2ZW50UHJpb3JpdHkobmV4dExhbmVzKSkgewogICAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIElkbGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IElkbGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBzY2hlZHVsZUNhbGxiYWNrJDEoc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCwgcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBuZXdDYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tOb2RlID0gbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3Qocm9vdDMsIGRpZFRpbWVvdXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVzZXROZXN0ZWRVcGRhdGVGbGFnKCk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFja05vZGUgPSByb290My5jYWxsYmFja05vZGU7CiAgICAgICAgICB2YXIgZGlkRmx1c2hQYXNzaXZlRWZmZWN0cyA9IGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIGlmIChkaWRGbHVzaFBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgIT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290Mywgcm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCA/IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzIDogTm9MYW5lcyk7CiAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVGltZVNsaWNlID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSAmJiAhZGlkVGltZW91dDsKICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gc2hvdWxkVGltZVNsaWNlID8gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSA6IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICBpZiAoZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICB2YXIgZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RGlkTm90Q29tcGxldGUpIHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJlbmRlcldhc0NvbmN1cnJlbnQgPSAhaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuY3VycmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcldhc0NvbmN1cnJlbnQgJiYgIWlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspKSB7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Vycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICAgICAgaWYgKF9lcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgICAgICBsYW5lcyA9IF9lcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlY292ZXJGcm9tQ29uY3VycmVudEVycm9yKHJvb3QzLCBfZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9mYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICAgICAgICB0aHJvdyBfZmF0YWxFcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgICBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgaWYgKHJvb3QzLmNhbGxiYWNrTm9kZSA9PT0gb3JpZ2luYWxDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKSB7CiAgICAgICAgICB2YXIgZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdCA9IHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnM7CiAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgdmFyIHJvb3RXb3JrSW5Qcm9ncmVzcyA9IHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBlcnJvclJldHJ5TGFuZXMpOwogICAgICAgICAgICByb290V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvckh5ZHJhdGluZ0NvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4aXRTdGF0dXMgPSByZW5kZXJSb290U3luYyhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgIGlmIChleGl0U3RhdHVzICE9PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICB2YXIgZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9yczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBlcnJvcnNGcm9tRmlyc3RBdHRlbXB0OwogICAgICAgICAgICBpZiAoZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoZXJyb3JzMykgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzMzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLnB1c2guYXBwbHkod29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIGVycm9yczMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcykgewogICAgICAgICAgc3dpdGNoIChleGl0U3RhdHVzKSB7CiAgICAgICAgICAgIGNhc2UgUm9vdEluUHJvZ3Jlc3M6CiAgICAgICAgICAgIGNhc2UgUm9vdEZhdGFsRXJyb3JlZDogewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUm9vdCBkaWQgbm90IGNvbXBsZXRlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdEVycm9yZWQ6IHsKICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290U3VzcGVuZGVkOiB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChpbmNsdWRlc09ubHlSZXRyaWVzKGxhbmVzKSAmJiAvLyBkbyBub3QgZGVsYXkgaWYgd2UncmUgaW5zaWRlIGFuIGFjdCgpIHNjb3BlCiAgICAgICAgICAgICAgIXNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpKSB7CiAgICAgICAgICAgICAgICB2YXIgbXNVbnRpbFRpbWVvdXQgPSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lICsgRkFMTEJBQ0tfVEhST1RUTEVfTVMgLSBub3coKTsKICAgICAgICAgICAgICAgIGlmIChtc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgICBpZiAobmV4dExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHN1c3BlbmRlZExhbmVzLCBsYW5lcykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgICAgIG1hcmtSb290UGluZ2VkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IHNjaGVkdWxlVGltZW91dChjb21taXRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKSwgbXNVbnRpbFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZFdpdGhEZWxheTogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1vc3RSZWNlbnRFdmVudFRpbWUgPSBnZXRNb3N0UmVjZW50RXZlbnRUaW1lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lTXMgPSBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgICAgICAgICAgdmFyIHRpbWVFbGFwc2VkTXMgPSBub3coKSAtIGV2ZW50VGltZU1zOwogICAgICAgICAgICAgICAgdmFyIF9tc1VudGlsVGltZW91dCA9IGpuZCh0aW1lRWxhcHNlZE1zKSAtIHRpbWVFbGFwc2VkTXM7CiAgICAgICAgICAgICAgICBpZiAoX21zVW50aWxUaW1lb3V0ID4gMTApIHsKICAgICAgICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IHNjaGVkdWxlVGltZW91dChjb21taXRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKSwgX21zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RDb21wbGV0ZWQ6IHsKICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByb290IGV4aXQgc3RhdHVzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgaWYgKG5vZGUuZmxhZ3MgJiBTdG9yZUNvbnNpc3RlbmN5KSB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gbm9kZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBjaGVja3MgPSB1cGRhdGVRdWV1ZS5zdG9yZXM7CiAgICAgICAgICAgICAgICBpZiAoY2hlY2tzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hlY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoZWNrID0gY2hlY2tzW2ldOwogICAgICAgICAgICAgICAgICAgIHZhciBnZXRTbmFwc2hvdCA9IGNoZWNrLmdldFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZFZhbHVlID0gY2hlY2sudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMoZ2V0U25hcHNob3QoKSwgcmVuZGVyZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAobm9kZS5zdWJ0cmVlRmxhZ3MgJiBTdG9yZUNvbnNpc3RlbmN5ICYmIGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQkMShyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgIHN1c3BlbmRlZExhbmVzID0gcmVtb3ZlTGFuZXMoc3VzcGVuZGVkTGFuZXMsIHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzKTsKICAgICAgICAgIHN1c3BlbmRlZExhbmVzID0gcmVtb3ZlTGFuZXMoc3VzcGVuZGVkTGFuZXMsIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzKTsKICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1TeW5jV29ya09uUm9vdChyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBzeW5jTmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgdmFyIGxhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShsYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgIGlmIChyb290My50YWcgIT09IExlZ2FjeVJvb3QgJiYgZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIGxhbmVzID0gZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIHRocm93IGZhdGFsRXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUm9vdCBkaWQgbm90IGNvbXBsZXRlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hSb290KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKGxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBtZXJnZUxhbmVzKGxhbmVzLCBTeW5jTGFuZSkpOwogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXRjaGVkVXBkYXRlcyQxKGZuLCBhKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBmbihhKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAvLyBUcmVhdCBgYWN0YCBhcyBpZiBpdCdzIGluc2lkZSBgYmF0Y2hlZFVwZGF0ZXNgLCBldmVuIGluIGxlZ2FjeSBtb2RlLgogICAgICAgICAgICAhUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5KSB7CiAgICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNjcmV0ZVVwZGF0ZXMoZm4sIGEsIGIsIGMsIGQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIsIGMsIGQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMoZm4pIHsKICAgICAgICAgIGlmIChyb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyAhPT0gbnVsbCAmJiByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cy50YWcgPT09IExlZ2FjeVJvb3QgJiYgKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IEJhdGNoZWRDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FscmVhZHlSZW5kZXJpbmcoKSB7CiAgICAgICAgICByZXR1cm4gKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoUmVuZGVyTGFuZXMoZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBwdXNoKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgc3VidHJlZVJlbmRlckxhbmVzLCBmaWJlcik7CiAgICAgICAgICBzdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHN1YnRyZWVSZW5kZXJMYW5lcywgbGFuZXMpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcywgbGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BSZW5kZXJMYW5lcyhmaWJlcikgewogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICBwb3Aoc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHRpbWVvdXRIYW5kbGUgPSByb290My50aW1lb3V0SGFuZGxlOwogICAgICAgICAgaWYgKHRpbWVvdXRIYW5kbGUgIT09IG5vVGltZW91dCkgewogICAgICAgICAgICByb290My50aW1lb3V0SGFuZGxlID0gbm9UaW1lb3V0OwogICAgICAgICAgICBjYW5jZWxUaW1lb3V0KHRpbWVvdXRIYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBpbnRlcnJ1cHRlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChpbnRlcnJ1cHRlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDQgPSBpbnRlcnJ1cHRlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50NCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBpbnRlcnJ1cHRlZFdvcmsgPSBpbnRlcnJ1cHRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhyb290My5jdXJyZW50LCBudWxsKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gcm9vdFdvcmtJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBzdWJ0cmVlUmVuZGVyTGFuZXMgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gbnVsbDsKICAgICAgICAgIGZpbmlzaFF1ZXVlaW5nQ29uY3VycmVudFVwZGF0ZXMoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncygpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgIGlmIChlcnJvcmVkV29yayA9PT0gbnVsbCB8fCBlcnJvcmVkV29yay5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RmF0YWxFcnJvcmVkOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lciAmJiBlcnJvcmVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZXJyb3JlZFdvcmssIHRydWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5hYmxlU2NoZWR1bGluZ1Byb2ZpbGVyKSB7CiAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICAgICAgaWYgKHRocm93blZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB0aHJvd25WYWx1ZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHRocm93blZhbHVlLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHdha2VhYmxlID0gdGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRTdXNwZW5kZWQoZXJyb3JlZFdvcmssIHdha2VhYmxlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50RXJyb3JlZChlcnJvcmVkV29yaywgdGhyb3duVmFsdWUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dFeGNlcHRpb24ocm9vdDMsIGVycm9yZWRXb3JrLnJldHVybiwgZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKGVycm9yZWRXb3JrKTsKICAgICAgICAgICAgfSBjYXRjaCAoeWV0QW5vdGhlclRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgdGhyb3duVmFsdWUgPSB5ZXRBbm90aGVyVGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzID09PSBlcnJvcmVkV29yayAmJiBlcnJvcmVkV29yayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSBlcnJvcmVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGVycm9yZWRXb3JrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaERpc3BhdGNoZXIoKSB7CiAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudDsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgaWYgKHByZXZEaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpIHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpIHsKICAgICAgICAgIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSBub3coKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1NraXBwZWRVcGRhdGVMYW5lcyhsYW5lKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBtZXJnZUxhbmVzKGxhbmUsIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZFN1c3BlbmQoKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IG51bGwgJiYgKGluY2x1ZGVzTm9uSWRsZVdvcmsod29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzKSB8fCBpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzKSkpIHsKICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMSh3b3JrSW5Qcm9ncmVzc1Jvb3QsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyAhPT0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEVycm9yZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gW2Vycm9yMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IFJlbmRlckNvbnRleHQ7CiAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBwdXNoRGlzcGF0Y2hlcigpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCAhPT0gcm9vdDMgfHwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgICAgICAgIGlmIChtZW1vaXplZFVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBnZXRUcmFuc2l0aW9uc0ZvckxhbmVzKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcFN5bmMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgY29tbWl0IGFuIGluY29tcGxldGUgcm9vdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BTeW5jKCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcENvbmN1cnJlbnQoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtSZW5kZXJZaWVsZGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFJvb3RJblByb2dyZXNzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BDb25jdXJyZW50KCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsICYmICFzaG91bGRZaWVsZCgpKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gdW5pdE9mV29yay5hbHRlcm5hdGU7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIodW5pdE9mV29yayk7CiAgICAgICAgICB2YXIgbmV4dDsKICAgICAgICAgIGlmICgodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgc3RhcnRQcm9maWxlclRpbWVyKHVuaXRPZldvcmspOwogICAgICAgICAgICBuZXh0ID0gYmVnaW5Xb3JrJDEoY3VycmVudDQsIHVuaXRPZldvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEodW5pdE9mV29yaywgdHJ1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0ID0gYmVnaW5Xb3JrJDEoY3VycmVudDQsIHVuaXRPZldvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgdW5pdE9mV29yay5tZW1vaXplZFByb3BzID0gdW5pdE9mV29yay5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBpZiAobmV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yayk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgdmFyIGNvbXBsZXRlZFdvcmsgPSB1bml0T2ZXb3JrOwogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gY29tcGxldGVkV29yay5yZXR1cm47CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5mbGFncyAmIEluY29tcGxldGUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNvbXBsZXRlZFdvcmspOwogICAgICAgICAgICAgIHZhciBuZXh0ID0gdm9pZCAwOwogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDQsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDQsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGNvbXBsZXRlZFdvcmssIGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICBpZiAobmV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHQgPSB1bndpbmRXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoX25leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIF9uZXh0LmZsYWdzICY9IEhvc3RFZmZlY3RNYXNrOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBfbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB2YXIgYWN0dWFsRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3REaWROb3RDb21wbGV0ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmdGaWJlciA9IGNvbXBsZXRlZFdvcmsuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmdGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gc2libGluZ0ZpYmVyOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gY29tcGxldGVkV29yazsKICAgICAgICAgIH0gd2hpbGUgKGNvbXBsZXRlZFdvcmsgIT09IG51bGwpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290Q29tcGxldGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290KHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHJlbmRlclByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgfSB3aGlsZSAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpOwogICAgICAgICAgZmx1c2hSZW5kZXJQaGFzZVN0cmljdE1vZGVXYXJuaW5nc0luREVWKCk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuZmluaXNoZWRXb3JrOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdDMuZmluaXNoZWRMYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJyb290LmZpbmlzaGVkTGFuZXMgc2hvdWxkIG5vdCBiZSBlbXB0eSBkdXJpbmcgYSBjb21taXQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByb290My5maW5pc2hlZFdvcmsgPSBudWxsOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrID09PSByb290My5jdXJyZW50KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCB0aGUgc2FtZSB0cmVlIGFzIGJlZm9yZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgdmFyIHJlbWFpbmluZ0xhbmVzID0gbWVyZ2VMYW5lcyhmaW5pc2hlZFdvcmsubGFuZXMsIGZpbmlzaGVkV29yay5jaGlsZExhbmVzKTsKICAgICAgICAgIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKTsKICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzIHx8IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgaWYgKCFyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gdHJhbnNpdGlvbnM7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3VidHJlZUhhc0VmZmVjdHMgPSAoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIChCZWZvcmVNdXRhdGlvbk1hc2sgfCBNdXRhdGlvbk1hc2sgfCBMYXlvdXRNYXNrIHwgUGFzc2l2ZU1hc2spKSAhPT0gTm9GbGFnczsKICAgICAgICAgIHZhciByb290SGFzRWZmZWN0ID0gKGZpbmlzaGVkV29yay5mbGFncyAmIChCZWZvcmVNdXRhdGlvbk1hc2sgfCBNdXRhdGlvbk1hc2sgfCBMYXlvdXRNYXNrIHwgUGFzc2l2ZU1hc2spKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChzdWJ0cmVlSGFzRWZmZWN0cyB8fCByb290SGFzRWZmZWN0KSB7CiAgICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHNob3VsZEZpcmVBZnRlckFjdGl2ZUluc3RhbmNlQmx1cjIgPSBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGxhbmVzKTsKICAgICAgICAgICAgcmVzZXRBZnRlckNvbW1pdChyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXF1ZXN0UGFpbnQoKTsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJlY29yZENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3REaWRIYXZlUGFzc2l2ZUVmZmVjdHMgPSByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0czsKICAgICAgICAgIGlmIChyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IHJvb3QzOwogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IGxhbmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHJlbWFpbmluZ0xhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFyb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgb25Db21taXRSb290KGZpbmlzaGVkV29yay5zdGF0ZU5vZGUsIHJlbmRlclByaW9yaXR5TGV2ZWwpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICByb290My5tZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgb25Db21taXRSb290JDEoKTsKICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgaWYgKHJlY292ZXJhYmxlRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSByb290My5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3ZlcmFibGVFcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcmVjb3ZlcmFibGVFcnJvciA9IHJlY292ZXJhYmxlRXJyb3JzW2ldOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnRTdGFjayA9IHJlY292ZXJhYmxlRXJyb3Iuc3RhY2s7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCA9IHJlY292ZXJhYmxlRXJyb3IuZGlnZXN0OwogICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvcihyZWNvdmVyYWJsZUVycm9yLnZhbHVlLCB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRTdGFjaywKICAgICAgICAgICAgICAgIGRpZ2VzdAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzVW5jYXVnaHRFcnJvcikgewogICAgICAgICAgICBoYXNVbmNhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZmlyc3RVbmNhdWdodEVycm9yOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvciQxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMsIFN5bmNMYW5lKSAmJiByb290My50YWcgIT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgfQogICAgICAgICAgcmVtYWluaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShyZW1haW5pbmdMYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTmVzdGVkVXBkYXRlU2NoZWR1bGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aE5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0cygpIHsKICAgICAgICAgIGlmIChyb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcmVuZGVyUHJpb3JpdHkgPSBsYW5lc1RvRXZlbnRQcmlvcml0eShwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyk7CiAgICAgICAgICAgIHZhciBwcmlvcml0eSA9IGxvd2VyRXZlbnRQcmlvcml0eShEZWZhdWx0RXZlbnRQcmlvcml0eSwgcmVuZGVyUHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJpb3JpdHkpOwogICAgICAgICAgICAgIHJldHVybiBmbHVzaFBhc3NpdmVFZmZlY3RzSW1wbCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlUGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgaWYgKCFyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrJDEoTm9ybWFsUHJpb3JpdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYW5zaXRpb25zID0gcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9uczsKICAgICAgICAgIHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgICAgdmFyIHJvb3QzID0gcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lczsKICAgICAgICAgIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICAgIHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmx1c2ggcGFzc2l2ZSBlZmZlY3RzIHdoaWxlIGFscmVhZHkgcmVuZGVyaW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhyb290My5jdXJyZW50KTsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIHJvb3QzLmN1cnJlbnQsIGxhbmVzLCB0cmFuc2l0aW9ucyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9maWxlckVmZmVjdHMgPSBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0czsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9maWxlckVmZmVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyID0gcHJvZmlsZXJFZmZlY3RzW2ldOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVFZmZlY3REdXJhdGlvbnMocm9vdDMsIF9maWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYocm9vdDMuY3VycmVudCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpZiAocm9vdDMgPT09IHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IHJvb3QzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBvblBvc3RDb21taXRSb290KHJvb3QzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHJvb3QzLmN1cnJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FscmVhZHlGYWlsZWRMZWdhY3lFcnJvckJvdW5kYXJ5KGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQgIT09IG51bGwgJiYgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuaGFzKGluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xlZ2FjeUVycm9yQm91bmRhcnlBc0ZhaWxlZChpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID09PSBudWxsKSB7CiAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2luc3RhbmNlXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZC5hZGQoaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoIWhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IHRydWU7CiAgICAgICAgICAgIGZpcnN0VW5jYXVnaHRFcnJvciA9IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9uVW5jYXVnaHRFcnJvciA9IHByZXBhcmVUb1Rocm93VW5jYXVnaHRFcnJvcjsKICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChyb290RmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvcjIpIHsKICAgICAgICAgIHZhciBlcnJvckluZm8gPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvcjIsIHNvdXJjZUZpYmVyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUocm9vdEZpYmVyLCBlcnJvckluZm8sIFN5bmNMYW5lKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUocm9vdEZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihzb3VyY2VGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IkMSkgewogICAgICAgICAgewogICAgICAgICAgICByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IkMSk7CiAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlRmliZXIudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChzb3VyY2VGaWJlciwgc291cmNlRmliZXIsIGVycm9yJDEpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlciA9IG5lYXJlc3RNb3VudGVkQW5jZXN0b3I7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChmaWJlciwgc291cmNlRmliZXIsIGVycm9yJDEpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGN0b3IgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckluZm8gPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvciQxLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBBdHRlbXB0ZWQgdG8gY2FwdHVyZSBhIGNvbW1pdCBwaGFzZSBlcnJvciBpbnNpZGUgYSBkZXRhY2hlZCB0cmVlLiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdC4gTGlrZWx5IGNhdXNlcyBpbmNsdWRlIGRlbGV0aW5nIHRoZSBzYW1lIGZpYmVyIG1vcmUgdGhhbiBvbmNlLCBjb21taXR0aW5nIGFuIGFscmVhZHktZmluaXNoZWQgdHJlZSwgb3IgYW4gaW5jb25zaXN0ZW50IHJldHVybiBwb2ludGVyLlxuXG5FcnJvciBtZXNzYWdlOlxuXG4lcyIsIGVycm9yJDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaW5nU3VzcGVuZGVkUm9vdChyb290Mywgd2FrZWFibGUsIHBpbmdlZExhbmVzKSB7CiAgICAgICAgICB2YXIgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSAhPT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUuZGVsZXRlKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMpOwogICAgICAgICAgd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCA9PT0gcm9vdDMgJiYgaXNTdWJzZXRPZkxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzLCBwaW5nZWRMYW5lcykpIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCAmJiBpbmNsdWRlc09ubHlSZXRyaWVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKSAmJiBub3coKSAtIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPCBGQUxMQkFDS19USFJPVFRMRV9NUykgewogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeVRpbWVkT3V0Qm91bmRhcnkoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICBpZiAocmV0cnlMYW5lID09PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0cnlMYW5lID0gcmVxdWVzdFJldHJ5TGFuZShib3VuZGFyeUZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIHJldHJ5TGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gYm91bmRhcnlGaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVSZXRyeVdha2VhYmxlKGJvdW5kYXJ5RmliZXIsIHdha2VhYmxlKSB7CiAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gTm9MYW5lOwogICAgICAgICAgdmFyIHJldHJ5Q2FjaGU7CiAgICAgICAgICBzd2l0Y2ggKGJvdW5kYXJ5RmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0cnlDYWNoZSA9IGJvdW5kYXJ5RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gYm91bmRhcnlGaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBpbmdlZCB1bmtub3duIHN1c3BlbnNlIGJvdW5kYXJ5IHR5cGUuIFRoaXMgaXMgcHJvYmFibHkgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmV0cnlDYWNoZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUNhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXRyeVRpbWVkT3V0Qm91bmRhcnkoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gam5kKHRpbWVFbGFwc2VkKSB7CiAgICAgICAgICByZXR1cm4gdGltZUVsYXBzZWQgPCAxMjAgPyAxMjAgOiB0aW1lRWxhcHNlZCA8IDQ4MCA/IDQ4MCA6IHRpbWVFbGFwc2VkIDwgMTA4MCA/IDEwODAgOiB0aW1lRWxhcHNlZCA8IDE5MjAgPyAxOTIwIDogdGltZUVsYXBzZWQgPCAzZTMgPyAzZTMgOiB0aW1lRWxhcHNlZCA8IDQzMjAgPyA0MzIwIDogY2VpbCh0aW1lRWxhcHNlZCAvIDE5NjApICogMTk2MDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCkgewogICAgICAgICAgaWYgKG5lc3RlZFVwZGF0ZUNvdW50ID4gTkVTVEVEX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWF4aW11bSB1cGRhdGUgZGVwdGggZXhjZWVkZWQuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGEgY29tcG9uZW50IHJlcGVhdGVkbHkgY2FsbHMgc2V0U3RhdGUgaW5zaWRlIGNvbXBvbmVudFdpbGxVcGRhdGUgb3IgY29tcG9uZW50RGlkVXBkYXRlLiBSZWFjdCBsaW1pdHMgdGhlIG51bWJlciBvZiBuZXN0ZWQgdXBkYXRlcyB0byBwcmV2ZW50IGluZmluaXRlIGxvb3BzLiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID4gTkVTVEVEX1BBU1NJVkVfVVBEQVRFX0xJTUlUKSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICAgICAgICBlcnJvcigiTWF4aW11bSB1cGRhdGUgZGVwdGggZXhjZWVkZWQuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGEgY29tcG9uZW50IGNhbGxzIHNldFN0YXRlIGluc2lkZSB1c2VFZmZlY3QsIGJ1dCB1c2VFZmZlY3QgZWl0aGVyIGRvZXNuJ3QgaGF2ZSBhIGRlcGVuZGVuY3kgYXJyYXksIG9yIG9uZSBvZiB0aGUgZGVwZW5kZW5jaWVzIGNoYW5nZXMgb24gZXZlcnkgcmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZygpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYoZmliZXIsIGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRMYXlvdXREZXYsIGludm9rZUxheW91dEVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RNb3VudEluREVWKTsKICAgICAgICAgICAgaWYgKGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudFBhc3NpdmVEZXYsIGludm9rZVBhc3NpdmVFZmZlY3RNb3VudEluREVWKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VFZmZlY3RzSW5EZXYoZmlyc3RDaGlsZCwgZmliZXJGbGFncywgaW52b2tlRWZmZWN0Rm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIHN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlTdWJ0cmVlRmxhZyA9IGN1cnJlbnQ0LnN1YnRyZWVGbGFncyAmIGZpYmVyRmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBzdWJ0cmVlUm9vdCAmJiBjdXJyZW50NC5jaGlsZCAhPT0gbnVsbCAmJiBwcmltYXJ5U3VidHJlZUZsYWcgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQ0ID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICgoY3VycmVudDQuZmxhZ3MgJiBmaWJlckZsYWdzKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBpbnZva2VFZmZlY3RGbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjdXJyZW50NCA9IGN1cnJlbnQ0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50NCA9IHN1YnRyZWVSb290ID0gY3VycmVudDQucmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRhZyA9IGZpYmVyLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyAhPT0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCAmJiB0YWcgIT09IEhvc3RSb290ICYmIHRhZyAhPT0gQ2xhc3NDb21wb25lbnQgJiYgdGFnICE9PSBGdW5jdGlvbkNvbXBvbmVudCAmJiB0YWcgIT09IEZvcndhcmRSZWYyICYmIHRhZyAhPT0gTWVtb0NvbXBvbmVudCAmJiB0YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiUmVhY3RDb21wb25lbnQiOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2NvbXBvbmVudE5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldmlvdXNGaWJlciA9IGN1cnJlbnQzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgZXJyb3IoIkNhbid0IHBlcmZvcm0gYSBSZWFjdCBzdGF0ZSB1cGRhdGUgb24gYSBjb21wb25lbnQgdGhhdCBoYXNuJ3QgbW91bnRlZCB5ZXQuIFRoaXMgaW5kaWNhdGVzIHRoYXQgeW91IGhhdmUgYSBzaWRlLWVmZmVjdCBpbiB5b3VyIHJlbmRlciBmdW5jdGlvbiB0aGF0IGFzeW5jaHJvbm91c2x5IGxhdGVyIGNhbGxzIHRyaWVzIHRvIHVwZGF0ZSB0aGUgY29tcG9uZW50LiBNb3ZlIHRoaXMgd29yayB0byB1c2VFZmZlY3QgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJlZ2luV29yayQxOwogICAgICAgIHsKICAgICAgICAgIHZhciBkdW1teUZpYmVyID0gbnVsbDsKICAgICAgICAgIGJlZ2luV29yayQxID0gZnVuY3Rpb24oY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSA9IGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKGR1bW15RmliZXIsIHVuaXRPZldvcmspOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBiZWdpbldvcmsoY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgfSBjYXRjaCAob3JpZ2luYWxFcnJvcikgewogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgfHwgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgb3JpZ2luYWxFcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCk7CiAgICAgICAgICAgICAgcmVzZXRIb29rc0FmdGVyVGhyb3coKTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDQsIHVuaXRPZldvcmspOwogICAgICAgICAgICAgIGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKHVuaXRPZldvcmssIG9yaWdpbmFsV29ya0luUHJvZ3Jlc3NDb3B5KTsKICAgICAgICAgICAgICBpZiAodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGJlZ2luV29yaywgbnVsbCwgY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaGFzQ2F1Z2h0RXJyb3IoKSkgewogICAgICAgICAgICAgICAgdmFyIHJlcGxheUVycm9yID0gY2xlYXJDYXVnaHRFcnJvcigpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXBsYXlFcnJvciA9PT0gIm9iamVjdCIgJiYgcmVwbGF5RXJyb3IgIT09IG51bGwgJiYgcmVwbGF5RXJyb3IuX3N1cHByZXNzTG9nZ2luZyAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiAhb3JpZ2luYWxFcnJvci5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQ7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyaW5nICYmICFnZXRJc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlSW5ERVYoKSkgewogICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyaW5nQ29tcG9uZW50TmFtZSA9IHdvcmtJblByb2dyZXNzICYmIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgICAgdmFyIGRlZHVwZUtleSA9IHJlbmRlcmluZ0NvbXBvbmVudE5hbWU7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmhhcyhkZWR1cGVLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmFkZChkZWR1cGVLZXkpOwogICAgICAgICAgICAgICAgICAgIHZhciBzZXRTdGF0ZUNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgYSBjb21wb25lbnQgKGAlc2ApIHdoaWxlIHJlbmRlcmluZyBhIGRpZmZlcmVudCBjb21wb25lbnQgKGAlc2ApLiBUbyBsb2NhdGUgdGhlIGJhZCBzZXRTdGF0ZSgpIGNhbGwgaW5zaWRlIGAlc2AsIGZvbGxvdyB0aGUgc3RhY2sgdHJhY2UgYXMgZGVzY3JpYmVkIGluIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zZXRzdGF0ZS1pbi1yZW5kZXIiLCBzZXRTdGF0ZUNvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgZHVyaW5nIGFuIGV4aXN0aW5nIHN0YXRlIHRyYW5zaXRpb24gKHN1Y2ggYXMgd2l0aGluIGByZW5kZXJgKS4gUmVuZGVyIG1ldGhvZHMgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIik7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5mb3JFYWNoKGZ1bmN0aW9uKHNjaGVkdWxpbmdGaWJlcikgewogICAgICAgICAgICAgICAgYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBzY2hlZHVsaW5nRmliZXIsIGxhbmVzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmFrZUFjdENhbGxiYWNrTm9kZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2skMShwcmlvcml0eUxldmVsLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWN0UXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChhY3RRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGFjdFF1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICAgIHJldHVybiBmYWtlQWN0Q2FsbGJhY2tOb2RlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxDYWxsYmFjayQxKGNhbGxiYWNrTm9kZSkgewogICAgICAgICAgaWYgKGNhbGxiYWNrTm9kZSA9PT0gZmFrZUFjdENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2FuY2VsQ2FsbGJhY2soY2FsbGJhY2tOb2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkgewogICAgICAgICAgcmV0dXJuIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVXBkYXRlc05vdFdyYXBwZWRXaXRoQWN0REVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBpZiAoIWlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpc0xlZ2FjeUFjdEVudmlyb25tZW50KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBGdW5jdGlvbkNvbXBvbmVudCAmJiBmaWJlci50YWcgIT09IEZvcndhcmRSZWYyICYmIGZpYmVyLnRhZyAhPT0gU2ltcGxlTWVtb0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgdG8gJXMgaW5zaWRlIGEgdGVzdCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IGNhdXNlcyBSZWFjdCBzdGF0ZSB1cGRhdGVzIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpcmUgZXZlbnRzIHRoYXQgdXBkYXRlIHN0YXRlICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdXNwZW5zZVJlc29sdXRpb25Ob3RXcmFwcGVkV2l0aEFjdERFVihyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgJiYgUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgc3VzcGVuZGVkIHJlc291cmNlIGZpbmlzaGVkIGxvYWRpbmcgaW5zaWRlIGEgdGVzdCwgYnV0IHRoZSBldmVudCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IHJlc29sdmVzIHN1c3BlbmRlZCBkYXRhIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpbmlzaCBsb2FkaW5nIHN1c3BlbmRlZCBkYXRhICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoaXNSdW5uaW5nKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGlzUnVubmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlc29sdmVGYW1pbHkgPSBudWxsOwogICAgICAgIHZhciBmYWlsZWRCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICB2YXIgc2V0UmVmcmVzaEhhbmRsZXIgPSBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc29sdmVGYW1pbHkgPSBoYW5kbGVyOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmYW1pbHkgPSByZXNvbHZlRmFtaWx5KHR5cGUpOwogICAgICAgICAgICBpZiAoZmFtaWx5ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAodHlwZSAhPT0gbnVsbCAmJiB0eXBlICE9PSB2b2lkIDAgJiYgdHlwZW9mIHR5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJlbmRlciA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgICBpZiAodHlwZS5yZW5kZXIgIT09IGN1cnJlbnRSZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHN5bnRoZXRpY1R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyLAogICAgICAgICAgICAgICAgICAgIHJlbmRlcjogY3VycmVudFJlbmRlcgogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAodHlwZS5kaXNwbGF5TmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgc3ludGhldGljVHlwZS5kaXNwbGF5TmFtZSA9IHR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY1R5cGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGZpYmVyLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2VHlwZSA9IGZpYmVyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICB2YXIgbmV4dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IGZhbHNlOwogICAgICAgICAgICB2YXIgJCR0eXBlb2ZOZXh0VHlwZSA9IHR5cGVvZiBuZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgbmV4dFR5cGUgIT09IG51bGwgPyBuZXh0VHlwZS4kJHR5cGVvZiA6IG51bGw7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0VHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0VHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTUVNT19UWVBFMikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVlZHNDb21wYXJlRmFtaWxpZXMpIHsKICAgICAgICAgICAgICB2YXIgcHJldkZhbWlseSA9IHJlc29sdmVGYW1pbHkocHJldlR5cGUpOwogICAgICAgICAgICAgIGlmIChwcmV2RmFtaWx5ICE9PSB2b2lkIDAgJiYgcHJldkZhbWlseSA9PT0gcmVzb2x2ZUZhbWlseShuZXh0VHlwZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgV2Vha1NldCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZhaWxlZEJvdW5kYXJpZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzLmFkZChmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVJlZnJlc2ggPSBmdW5jdGlvbihyb290MywgdXBkYXRlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdGFsZUZhbWlsaWVzID0gdXBkYXRlLnN0YWxlRmFtaWxpZXMsIHVwZGF0ZWRGYW1pbGllcyA9IHVwZGF0ZS51cGRhdGVkRmFtaWxpZXM7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkocm9vdDMuY3VycmVudCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgc2NoZWR1bGVSb290ID0gZnVuY3Rpb24ocm9vdDMsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLmNvbnRleHQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoZmliZXIsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlLCBjaGlsZCA9IGZpYmVyLmNoaWxkLCBzaWJsaW5nID0gZmliZXIuc2libGluZywgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZVR5cGUgPSBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVzb2x2ZUZhbWlseSB0byBiZSBzZXQgZHVyaW5nIGhvdCByZWxvYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5lZWRzUmVuZGVyID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBuZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseShjYW5kaWRhdGVUeXBlKTsKICAgICAgICAgICAgICBpZiAoZmFtaWx5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGlmIChzdGFsZUZhbWlsaWVzLmhhcyhmYW1pbHkpKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZWRGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBpZiAodGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZHNSZW5kZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMuaGFzKGZpYmVyKSB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgZmFpbGVkQm91bmRhcmllcy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgbmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCkgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCB8fCBuZWVkc1JlbmRlcikgewogICAgICAgICAgICAgIHZhciBfcm9vdCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChfcm9vdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKF9yb290LCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsICYmICFuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGNoaWxkLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShzaWJsaW5nLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2ggPSBmdW5jdGlvbihyb290MywgZmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgdHlwZXMgPSBuZXcgU2V0KGZhbWlsaWVzLm1hcChmdW5jdGlvbihmYW1pbHkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgcmV0dXJuIGhvc3RJbnN0YW5jZXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkoZmliZXIsIHR5cGVzLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkLCBzaWJsaW5nID0gZmliZXIuc2libGluZywgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZVR5cGUgPSBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGlkTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZXMuaGFzKGNhbmRpZGF0ZVR5cGUpKSB7CiAgICAgICAgICAgICAgICBkaWRNYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRNYXRjaCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGNoaWxkLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHNpYmxpbmcsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmaW5kQ2hpbGRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICBpZiAoZm91bmRIb3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byByZWFjaCByb290IGZpcnN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIGZvdW5kSG9zdEluc3RhbmNlcyA9IHRydWU7CiAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvdW5kSG9zdEluc3RhbmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc0JhZE1hcFBvbHlmaWxsOwogICAgICAgIHsKICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gZmFsc2U7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbm9uRXh0ZW5zaWJsZU9iamVjdCA9IE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyh7fSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKFtbbm9uRXh0ZW5zaWJsZU9iamVjdCwgbnVsbF1dKTsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW25vbkV4dGVuc2libGVPYmplY3RdKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaGFzQmFkTWFwUG9seWZpbGwgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgIHRoaXMuZWxlbWVudFR5cGUgPSBudWxsOwogICAgICAgICAgdGhpcy50eXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMucmV0dXJuID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2hpbGQgPSBudWxsOwogICAgICAgICAgdGhpcy5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgICAgdGhpcy5yZWYgPSBudWxsOwogICAgICAgICAgdGhpcy5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICB0aGlzLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgdGhpcy51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB0aGlzLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgdGhpcy5tb2RlID0gbW9kZTsKICAgICAgICAgIHRoaXMuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgdGhpcy5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnNlbGZCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnRyZWVCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZGVidWdTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdOZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fZGVidWdIb29rVHlwZXMgPSBudWxsOwogICAgICAgICAgICBpZiAoIWhhc0JhZE1hcFBvbHlmaWxsICYmIHR5cGVvZiBPYmplY3QucHJldmVudEV4dGVuc2lvbnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBPYmplY3QucHJldmVudEV4dGVuc2lvbnModGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUZpYmVyID0gZnVuY3Rpb24odGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2ltcGxlRnVuY3Rpb25Db21wb25lbnQodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iICYmICFzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSAmJiB0eXBlLmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpID8gQ2xhc3NDb21wb25lbnQgOiBGdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoQ29tcG9uZW50ICE9PSB2b2lkIDAgJiYgQ29tcG9uZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciAkJHR5cGVvZiA9IENvbXBvbmVudC4kJHR5cGVvZjsKICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMikgewogICAgICAgICAgICAgIHJldHVybiBGb3J3YXJkUmVmMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpIHsKICAgICAgICAgICAgICByZXR1cm4gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQ0LCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzczIgPSBjdXJyZW50NC5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiA9IGNyZWF0ZUZpYmVyKGN1cnJlbnQ0LnRhZywgcGVuZGluZ1Byb3BzLCBjdXJyZW50NC5rZXksIGN1cnJlbnQ0Lm1vZGUpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPSBjdXJyZW50NC5lbGVtZW50VHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3VycmVudDQuc3RhdGVOb2RlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZSA9IGN1cnJlbnQ0Ll9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnT3duZXIgPSBjdXJyZW50NC5fZGVidWdPd25lcjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gY3VycmVudDQuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBjdXJyZW50NDsKICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gY3VycmVudDQuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50NC5jaGlsZExhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnREZXBlbmRlbmNpZXMgPSBjdXJyZW50NC5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICBmaXJzdENvbnRleHQ6IGN1cnJlbnREZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNpYmxpbmcgPSBjdXJyZW50NC5zaWJsaW5nOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmluZGV4ID0gY3VycmVudDQuaW5kZXg7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucmVmID0gY3VycmVudDQucmVmOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IGN1cnJlbnQ0Ll9kZWJ1Z05lZWRzUmVtb3VudDsKICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhjdXJyZW50NC50eXBlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFdvcmtJblByb2dyZXNzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gU3RhdGljTWFzayB8IFBsYWNlbWVudDsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50NC5jaGlsZExhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBjdXJyZW50NC5sYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IGN1cnJlbnQ0LnR5cGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgICAgbGFuZXM6IGN1cnJlbnREZXBlbmRlbmNpZXMubGFuZXMsCiAgICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50NC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSkgewogICAgICAgICAgdmFyIG1vZGU7CiAgICAgICAgICBpZiAodGFnID09PSBDb25jdXJyZW50Um9vdCkgewogICAgICAgICAgICBtb2RlID0gQ29uY3VycmVudE1vZGU7CiAgICAgICAgICAgIGlmIChpc1N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RFZmZlY3RzTW9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1vZGUgPSBOb01vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgbW9kZSB8PSBQcm9maWxlTW9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlcihIb3N0Um9vdCwgbnVsbCwgbnVsbCwgbW9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyh0eXBlLCBrZXksIHBlbmRpbmdQcm9wcywgb3duZXIsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXJUYWcgPSBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENvbnN0cnVjdCQxKHR5cGUpKSB7CiAgICAgICAgICAgICAgZmliZXJUYWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcocmVzb2x2ZWRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICBmaWJlclRhZyA9IEhvc3RDb21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZXRUYWc6IHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21GcmFnbWVudChwZW5kaW5nUHJvcHMuY2hpbGRyZW4sIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTW9kZTsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0TGVnYWN5TW9kZTsKICAgICAgICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tUHJvZmlsZXIocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZUxpc3QocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX09GRlNDUkVFTl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEVHQUNZX0hJRERFTl9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU0NPUEVfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NBQ0hFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfREVCVUdfVFJBQ0lOR19NT0RFX1RZUEU6CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBDb250ZXh0Q29uc3VtZXI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gRm9yd2FyZFJlZjI7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBNZW1vQ29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBMYXp5Q29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG93bmVyTmFtZSA9IG93bmVyID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcikgOiBudWxsOwogICAgICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbGVtZW50IHR5cGUgaXMgaW52YWxpZDogZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpICIgKyAoImJ1dCBnb3Q6ICIgKyAodHlwZSA9PSBudWxsID8gdHlwZSA6IHR5cGVvZiB0eXBlKSArICIuIiArIGluZm8pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKGZpYmVyVGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IHR5cGU7CiAgICAgICAgICBmaWJlci50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBvd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIG93bmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHBlbmRpbmdQcm9wcyA9IGVsZW1lbnQucHJvcHM7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEZyYWdtZW50MTAsIGVsZW1lbnRzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUHJvZmlsZXIocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGVuZGluZ1Byb3BzLmlkICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGVycm9yKCdQcm9maWxlciBtdXN0IHNwZWNpZnkgYW4gImlkIiBvZiB0eXBlIGBzdHJpbmdgIGFzIGEgcHJvcC4gUmVjZWl2ZWQgdGhlIHR5cGUgYCVzYCBpbnN0ZWFkLicsIHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihQcm9maWxlciwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUgfCBQcm9maWxlTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1BST0ZJTEVSX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB7CiAgICAgICAgICAgICAgZWZmZWN0RHVyYXRpb246IDAsCiAgICAgICAgICAgICAgcGFzc2l2ZUVmZmVjdER1cmF0aW9uOiAwCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VDb21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfU1VTUEVOU0VfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlTGlzdChwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFN1c3BlbnNlTGlzdENvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihPZmZzY3JlZW5Db21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEluc3RhbmNlID0gewogICAgICAgICAgICBpc0hpZGRlbjogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBwcmltYXJ5Q2hpbGRJbnN0YW5jZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tVGV4dChjb250ZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoSG9zdFRleHQsIGNvbnRlbnQsIG51bGwsIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tSG9zdEluc3RhbmNlRm9yRGVsZXRpb24oKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0Q29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSAiREVMRVRFRCI7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbURlaHlkcmF0ZWRGcmFnbWVudChkZWh5ZHJhdGVkTm9kZSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoRGVoeWRyYXRlZEZyYWdtZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gZGVoeWRyYXRlZE5vZGU7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ1Byb3BzID0gcG9ydGFsLmNoaWxkcmVuICE9PSBudWxsID8gcG9ydGFsLmNoaWxkcmVuIDogW107CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0UG9ydGFsLCBwZW5kaW5nUHJvcHMsIHBvcnRhbC5rZXksIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgY29udGFpbmVySW5mbzogcG9ydGFsLmNvbnRhaW5lckluZm8sCiAgICAgICAgICAgIHBlbmRpbmdDaGlsZHJlbjogbnVsbCwKICAgICAgICAgICAgLy8gVXNlZCBieSBwZXJzaXN0ZW50IHVwZGF0ZXMKICAgICAgICAgICAgaW1wbGVtZW50YXRpb246IHBvcnRhbC5pbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXNzaWduRmliZXJQcm9wZXJ0aWVzSW5ERVYodGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgICAgIGlmICh0YXJnZXQgPT09IG51bGwpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gY3JlYXRlRmliZXIoSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCwgbnVsbCwgbnVsbCwgTm9Nb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldC50YWcgPSBzb3VyY2UudGFnOwogICAgICAgICAgdGFyZ2V0LmtleSA9IHNvdXJjZS5rZXk7CiAgICAgICAgICB0YXJnZXQuZWxlbWVudFR5cGUgPSBzb3VyY2UuZWxlbWVudFR5cGU7CiAgICAgICAgICB0YXJnZXQudHlwZSA9IHNvdXJjZS50eXBlOwogICAgICAgICAgdGFyZ2V0LnN0YXRlTm9kZSA9IHNvdXJjZS5zdGF0ZU5vZGU7CiAgICAgICAgICB0YXJnZXQucmV0dXJuID0gc291cmNlLnJldHVybjsKICAgICAgICAgIHRhcmdldC5jaGlsZCA9IHNvdXJjZS5jaGlsZDsKICAgICAgICAgIHRhcmdldC5zaWJsaW5nID0gc291cmNlLnNpYmxpbmc7CiAgICAgICAgICB0YXJnZXQuaW5kZXggPSBzb3VyY2UuaW5kZXg7CiAgICAgICAgICB0YXJnZXQucmVmID0gc291cmNlLnJlZjsKICAgICAgICAgIHRhcmdldC5wZW5kaW5nUHJvcHMgPSBzb3VyY2UucGVuZGluZ1Byb3BzOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkUHJvcHMgPSBzb3VyY2UubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHRhcmdldC51cGRhdGVRdWV1ZSA9IHNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgIHRhcmdldC5tZW1vaXplZFN0YXRlID0gc291cmNlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB0YXJnZXQuZGVwZW5kZW5jaWVzID0gc291cmNlLmRlcGVuZGVuY2llczsKICAgICAgICAgIHRhcmdldC5tb2RlID0gc291cmNlLm1vZGU7CiAgICAgICAgICB0YXJnZXQuZmxhZ3MgPSBzb3VyY2UuZmxhZ3M7CiAgICAgICAgICB0YXJnZXQuc3VidHJlZUZsYWdzID0gc291cmNlLnN1YnRyZWVGbGFnczsKICAgICAgICAgIHRhcmdldC5kZWxldGlvbnMgPSBzb3VyY2UuZGVsZXRpb25zOwogICAgICAgICAgdGFyZ2V0LmxhbmVzID0gc291cmNlLmxhbmVzOwogICAgICAgICAgdGFyZ2V0LmNoaWxkTGFuZXMgPSBzb3VyY2UuY2hpbGRMYW5lczsKICAgICAgICAgIHRhcmdldC5hbHRlcm5hdGUgPSBzb3VyY2UuYWx0ZXJuYXRlOwogICAgICAgICAgewogICAgICAgICAgICB0YXJnZXQuYWN0dWFsRHVyYXRpb24gPSBzb3VyY2UuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxTdGFydFRpbWUgPSBzb3VyY2UuYWN0dWFsU3RhcnRUaW1lOwogICAgICAgICAgICB0YXJnZXQuc2VsZkJhc2VEdXJhdGlvbiA9IHNvdXJjZS5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB0YXJnZXQudHJlZUJhc2VEdXJhdGlvbiA9IHNvdXJjZS50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z1NvdXJjZSA9IHNvdXJjZS5fZGVidWdTb3VyY2U7CiAgICAgICAgICB0YXJnZXQuX2RlYnVnT3duZXIgPSBzb3VyY2UuX2RlYnVnT3duZXI7CiAgICAgICAgICB0YXJnZXQuX2RlYnVnTmVlZHNSZW1vdW50ID0gc291cmNlLl9kZWJ1Z05lZWRzUmVtb3VudDsKICAgICAgICAgIHRhcmdldC5fZGVidWdIb29rVHlwZXMgPSBzb3VyY2UuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRmliZXJSb290Tm9kZShjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgdGhpcy5jb250YWluZXJJbmZvID0gY29udGFpbmVySW5mbzsKICAgICAgICAgIHRoaXMucGVuZGluZ0NoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHRoaXMuY3VycmVudCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBpbmdDYWNoZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICB0aGlzLnRpbWVvdXRIYW5kbGUgPSBub1RpbWVvdXQ7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICB0aGlzLmV2ZW50VGltZXMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5leHBpcmF0aW9uVGltZXMgPSBjcmVhdGVMYW5lTWFwKE5vVGltZXN0YW1wKTsKICAgICAgICAgIHRoaXMucGVuZGluZ0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5waW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmV4cGlyZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLm11dGFibGVSZWFkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZW50YW5nbGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZW1lbnRzID0gY3JlYXRlTGFuZU1hcChOb0xhbmVzKTsKICAgICAgICAgIHRoaXMuaWRlbnRpZmllclByZWZpeCA9IGlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICB0aGlzLm9uUmVjb3ZlcmFibGVFcnJvciA9IG9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tZW1vaXplZFVwZGF0ZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSB0aGlzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IFRvdGFsTGFuZXM7IF9pKyspIHsKICAgICAgICAgICAgICBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwLnB1c2goLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIENvbmN1cnJlbnRSb290OgogICAgICAgICAgICAgICAgdGhpcy5fZGVidWdSb290VHlwZSA9IGh5ZHJhdGUyID8gImh5ZHJhdGVSb290KCkiIDogImNyZWF0ZVJvb3QoKSI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIExlZ2FjeVJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZSgpIiA6ICJyZW5kZXIoKSI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSBuZXcgRmliZXJSb290Tm9kZShjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgdmFyIHVuaW5pdGlhbGl6ZWRGaWJlciA9IGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUpOwogICAgICAgICAgcm9vdDMuY3VycmVudCA9IHVuaW5pdGlhbGl6ZWRGaWJlcjsKICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5zdGF0ZU5vZGUgPSByb290MzsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9pbml0aWFsU3RhdGUgPSB7CiAgICAgICAgICAgICAgZWxlbWVudDogaW5pdGlhbENoaWxkcmVuLAogICAgICAgICAgICAgIGlzRGVoeWRyYXRlZDogaHlkcmF0ZTIsCiAgICAgICAgICAgICAgY2FjaGU6IG51bGwsCiAgICAgICAgICAgICAgLy8gbm90IGVuYWJsZWQgeWV0CiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICB1bmluaXRpYWxpemVkRmliZXIubWVtb2l6ZWRTdGF0ZSA9IF9pbml0aWFsU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUodW5pbml0aWFsaXplZEZpYmVyKTsKICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxOC4zLjEiOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbDMoY2hpbGRyZW4sIGNvbnRhaW5lckluZm8sIGltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbM10gOiBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvdyB1cyB0byB1bmlxdWVseSBpZGVudGlmeSB0aGlzIGFzIGEgUmVhY3QgUG9ydGFsCiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QT1JUQUxfVFlQRSwKICAgICAgICAgICAga2V5OiBrZXkgPT0gbnVsbCA/IG51bGwgOiAiIiArIGtleSwKICAgICAgICAgICAgY2hpbGRyZW4sCiAgICAgICAgICAgIGNvbnRhaW5lckluZm8sCiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGU7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGUgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dEZvclN1YnRyZWUocGFyZW50Q29tcG9uZW50KSB7CiAgICAgICAgICBpZiAoIXBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NShwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgdmFyIHBhcmVudENvbnRleHQgPSBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcik7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gZmliZXIudHlwZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgQ29tcG9uZW50LCBwYXJlbnRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnQsIG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NShjb21wb25lbnQpOwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY29tcG9uZW50LnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoY29tcG9uZW50KS5qb2luKCIsIik7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50IGFwcGVhcnMgdG8gbm90IGJlIGEgUmVhY3RDb21wb25lbnQuIEtleXM6ICIgKyBrZXlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0RmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDM7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoaG9zdEZpYmVyKTsKICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGRlcHJlY2F0ZWQgaW4gU3RyaWN0TW9kZS4gJXMgd2FzIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiAlcyB3aGljaCBpcyBpbnNpZGUgU3RyaWN0TW9kZS4gSW5zdGVhZCwgYWRkIGEgcmVmIGRpcmVjdGx5IHRvIHRoZSBlbGVtZW50IHlvdSB3YW50IHRvIHJlZmVyZW5jZS4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtZmluZC1ub2RlIiwgbWV0aG9kTmFtZSwgbWV0aG9kTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGRlcHJlY2F0ZWQgaW4gU3RyaWN0TW9kZS4gJXMgd2FzIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiAlcyB3aGljaCByZW5kZXJzIFN0cmljdE1vZGUgY2hpbGRyZW4uIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihwcmV2aW91c0ZpYmVyKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDb250YWluZXIoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgaHlkcmF0ZTIgPSBmYWxzZTsKICAgICAgICAgIHZhciBpbml0aWFsQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVIeWRyYXRpb25Db250YWluZXIoaW5pdGlhbENoaWxkcmVuLCBjYWxsYmFjaywgY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgaHlkcmF0ZTIgPSB0cnVlOwogICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGluaXRpYWxDaGlsZHJlbiwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICByb290My5jb250ZXh0ID0gZ2V0Q29udGV4dEZvclN1YnRyZWUobnVsbCk7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSByb290My5jdXJyZW50OwogICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoY3VycmVudDQpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCA/IGNhbGxiYWNrIDogbnVsbDsKICAgICAgICAgIGVucXVldWVVcGRhdGUoY3VycmVudDQsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICBzY2hlZHVsZUluaXRpYWxIeWRyYXRpb25PblJvb3Qocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRhaW5lcihlbGVtZW50LCBjb250YWluZXIyLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uU2NoZWR1bGVSb290KGNvbnRhaW5lcjIsIGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnQkMSA9IGNvbnRhaW5lcjIuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQkMSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCk7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5jb250ZXh0ID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLnBlbmRpbmdDb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyaW5nICYmIGN1cnJlbnQzICE9PSBudWxsICYmICFkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlOyB0cmlnZ2VyaW5nIG5lc3RlZCBjb21wb25lbnQgdXBkYXRlcyBmcm9tIHJlbmRlciBpcyBub3QgYWxsb3dlZC4gSWYgbmVjZXNzYXJ5LCB0cmlnZ2VyIG5lc3RlZCB1cGRhdGVzIGluIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgJXMuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50MykgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQKICAgICAgICAgIH07CiAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrID09PSB2b2lkIDAgPyBudWxsIDogY2FsbGJhY2s7CiAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShjdXJyZW50JDEsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBjdXJyZW50JDEsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHVibGljUm9vdEluc3RhbmNlKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHZhciBjb250YWluZXJGaWJlciA9IGNvbnRhaW5lcjIuY3VycmVudDsKICAgICAgICAgIGlmICghY29udGFpbmVyRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGNvbnRhaW5lckZpYmVyLmNoaWxkLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGdldFB1YmxpY0luc3RhbmNlKGNvbnRhaW5lckZpYmVyLmNoaWxkLnN0YXRlTm9kZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lckZpYmVyLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEoZmliZXIpIHsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlQZW5kaW5nTGFuZXMocm9vdDMpOwogICAgICAgICAgICAgICAgZmx1c2hSb290KHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDQgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIGlmIChyb290NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDQsIGZpYmVyLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gU3luY0xhbmU7CiAgICAgICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JldHJ5TGFuZUltcGwoZmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lID0gaGlnaGVyUHJpb3JpdHlMYW5lKHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGFsdGVybmF0ZSwgcmV0cnlMYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMShmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzKGZpYmVyKTsKICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB9CiAgICAgICAgdmFyIHNob3VsZEVycm9ySW1wbCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNob3VsZEVycm9yKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRXJyb3JJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNob3VsZFN1c3BlbmRJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFN1c3BlbmQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRTdXNwZW5kSW1wbChmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBvdmVycmlkZUhvb2tTdGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHMgPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgc2NoZWR1bGVVcGRhdGUgPSBudWxsOwogICAgICAgIHZhciBzZXRFcnJvckhhbmRsZXIgPSBudWxsOwogICAgICAgIHZhciBzZXRTdXNwZW5zZUhhbmRsZXIgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIHZhciBjb3B5V2l0aERlbGV0ZUltcGwgPSBmdW5jdGlvbihvYmosIHBhdGgyLCBpbmRleDIpIHsKICAgICAgICAgICAgdmFyIGtleSA9IHBhdGgyW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheTIob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduMih7fSwgb2JqKTsKICAgICAgICAgICAgaWYgKGluZGV4MiArIDEgPT09IHBhdGgyLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5Mih1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uoa2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhEZWxldGVJbXBsKG9ialtrZXldLCBwYXRoMiwgaW5kZXgyICsgMSk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aERlbGV0ZSA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoRGVsZXRlSW1wbChvYmosIHBhdGgyLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhSZW5hbWVJbXBsID0gZnVuY3Rpb24ob2JqLCBvbGRQYXRoLCBuZXdQYXRoLCBpbmRleDIpIHsKICAgICAgICAgICAgdmFyIG9sZEtleSA9IG9sZFBhdGhbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5MihvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24yKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gb2xkUGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbmV3S2V5ID0gbmV3UGF0aFtpbmRleDJdOwogICAgICAgICAgICAgIHVwZGF0ZWRbbmV3S2V5XSA9IHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICBpZiAoaXNBcnJheTIodXBkYXRlZCkpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZWQuc3BsaWNlKG9sZEtleSwgMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB1cGRhdGVkW29sZEtleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZWRbb2xkS2V5XSA9IGNvcHlXaXRoUmVuYW1lSW1wbCgKICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgbnVtYmVyIG9yIHN0cmluZyBpcyBmaW5lIGhlcmUKICAgICAgICAgICAgICAgIG9ialtvbGRLZXldLAogICAgICAgICAgICAgICAgb2xkUGF0aCwKICAgICAgICAgICAgICAgIG5ld1BhdGgsCiAgICAgICAgICAgICAgICBpbmRleDIgKyAxCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhSZW5hbWUgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgaWYgKG9sZFBhdGgubGVuZ3RoICE9PSBuZXdQYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIHdhcm4zKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgb2YgdGhlIHNhbWUgbGVuZ3RoIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3UGF0aC5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChvbGRQYXRoW2ldICE9PSBuZXdQYXRoW2ldKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4zKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgdG8gYmUgdGhlIHNhbWUgZXhjZXB0IGZvciB0aGUgZGVlcGVzdCBrZXkiKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29weVdpdGhSZW5hbWVJbXBsKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCwgMCk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoU2V0SW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIsIGluZGV4MiwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGluZGV4MiA+PSBwYXRoMi5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IHBhdGgyW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheTIob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduMih7fSwgb2JqKTsKICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhTZXRJbXBsKG9ialtrZXldLCBwYXRoMiwgaW5kZXgyICsgMSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXQgPSBmdW5jdGlvbihvYmosIHBhdGgyLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gY29weVdpdGhTZXRJbXBsKG9iaiwgcGF0aDIsIDAsIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEhvb2sgPSBmdW5jdGlvbihmaWJlciwgaWQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb29rMiA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50SG9vazIgIT09IG51bGwgJiYgaWQgPiAwKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2syID0gY3VycmVudEhvb2syLm5leHQ7CiAgICAgICAgICAgICAgaWQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY3VycmVudEhvb2syOwogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoMiwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoU2V0KGhvb2subWVtb2l6ZWRTdGF0ZSwgcGF0aDIsIHZhbHVlKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24yKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoMikgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhEZWxldGUoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoMik7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduMih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhSZW5hbWUoaG9vay5tZW1vaXplZFN0YXRlLCBvbGRQYXRoLCBuZXdQYXRoKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24yKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wcyA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoMiwgdmFsdWUpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhTZXQoZmliZXIubWVtb2l6ZWRQcm9wcywgcGF0aDIsIHZhbHVlKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoMikgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aERlbGV0ZShmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoMik7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBmdW5jdGlvbihmaWJlciwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aFJlbmFtZShmaWJlci5tZW1vaXplZFByb3BzLCBvbGRQYXRoLCBuZXdQYXRoKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBzY2hlZHVsZVVwZGF0ZSA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgc2V0RXJyb3JIYW5kbGVyID0gZnVuY3Rpb24obmV3U2hvdWxkRXJyb3JJbXBsKSB7CiAgICAgICAgICAgIHNob3VsZEVycm9ySW1wbCA9IG5ld1Nob3VsZEVycm9ySW1wbDsKICAgICAgICAgIH07CiAgICAgICAgICBzZXRTdXNwZW5zZUhhbmRsZXIgPSBmdW5jdGlvbihuZXdTaG91bGRTdXNwZW5kSW1wbCkgewogICAgICAgICAgICBzaG91bGRTdXNwZW5kSW1wbCA9IG5ld1Nob3VsZFN1c3BlbmRJbXBsOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZUJ5RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcihmaWJlcik7CiAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhvc3RGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJGb3JEZXZUb29scygpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50MzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0SW50b0RldlRvb2xzKGRldlRvb2xzQ29uZmlnKSB7CiAgICAgICAgICB2YXIgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgPSBkZXZUb29sc0NvbmZpZy5maW5kRmliZXJCeUhvc3RJbnN0YW5jZTsKICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgICByZXR1cm4gaW5qZWN0SW50ZXJuYWxzKHsKICAgICAgICAgICAgYnVuZGxlVHlwZTogZGV2VG9vbHNDb25maWcuYnVuZGxlVHlwZSwKICAgICAgICAgICAgdmVyc2lvbjogZGV2VG9vbHNDb25maWcudmVyc2lvbiwKICAgICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogZGV2VG9vbHNDb25maWcucmVuZGVyZXJQYWNrYWdlTmFtZSwKICAgICAgICAgICAgcmVuZGVyZXJDb25maWc6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyQ29uZmlnLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHMsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCwKICAgICAgICAgICAgc2V0RXJyb3JIYW5kbGVyLAogICAgICAgICAgICBzZXRTdXNwZW5zZUhhbmRsZXIsCiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlLAogICAgICAgICAgICBjdXJyZW50RGlzcGF0Y2hlclJlZjogUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIsCiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyLAogICAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgfHwgZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZSwKICAgICAgICAgICAgLy8gUmVhY3QgUmVmcmVzaAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUmVmcmVzaCwKICAgICAgICAgICAgc2NoZWR1bGVSb290LAogICAgICAgICAgICBzZXRSZWZyZXNoSGFuZGxlciwKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBhcHBlbmQgb3duZXIgc3RhY2tzIHRvIGVycm9yIG1lc3NhZ2VzIGluIERFViBtb2RlLgogICAgICAgICAgICBnZXRDdXJyZW50RmliZXI6IGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzLAogICAgICAgICAgICAvLyBFbmFibGVzIERldlRvb2xzIHRvIGRldGVjdCByZWNvbmNpbGVyIHZlcnNpb24gcmF0aGVyIHRoYW4gcmVuZGVyZXIgdmVyc2lvbgogICAgICAgICAgICAvLyB3aGljaCBtYXkgbm90IG1hdGNoIGZvciB0aGlyZCBwYXJ0eSByZW5kZXJlcnMuCiAgICAgICAgICAgIHJlY29uY2lsZXJWZXJzaW9uOiBSZWFjdFZlcnNpb24KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvciA9IHR5cGVvZiByZXBvcnRFcnJvciA9PT0gImZ1bmN0aW9uIiA/ICgKICAgICAgICAgIC8vIEluIG1vZGVybiBicm93c2VycywgcmVwb3J0RXJyb3Igd2lsbCBkaXNwYXRjaCBhbiBlcnJvciBldmVudCwKICAgICAgICAgIC8vIGVtdWxhdGluZyBhbiB1bmNhdWdodCBKYXZhU2NyaXB0IGVycm9yLgogICAgICAgICAgcmVwb3J0RXJyb3IKICAgICAgICApIDogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBSZWFjdERPTVJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUucmVuZGVyID0gUmVhY3RET01Sb290LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHVwZGF0ZSBhbiB1bm1vdW50ZWQgcm9vdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IGRvZXMgbm90IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZENvbnRhaW5lcihhcmd1bWVudHNbMV0pKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBjb250YWluZXIgdG8gdGhlIHNlY29uZCBhcmd1bWVudCBvZiByb290LnJlbmRlciguLi4pLiBZb3UgZG9uJ3QgbmVlZCB0byBwYXNzIGl0IGFnYWluIHNpbmNlIHlvdSBhbHJlYWR5IHBhc3NlZCBpdCB0byBjcmVhdGUgdGhlIHJvb3QuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIHNlY29uZCBhcmd1bWVudCB0byByb290LnJlbmRlciguLi4pIGJ1dCBpdCBvbmx5IGFjY2VwdHMgb25lIGFyZ3VtZW50LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhyb290My5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlLnBhcmVudE5vZGUgIT09IGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBJdCBsb29rcyBsaWtlIHRoZSBSZWFjdC1yZW5kZXJlZCBjb250ZW50IG9mIHRoZSByb290IGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIHJvb3QudW5tb3VudCgpIHRvIGVtcHR5IGEgcm9vdCdzIGNvbnRhaW5lci4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihjaGlsZHJlbiwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgIH07CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS51bm1vdW50ID0gUmVhY3RET01Sb290LnByb3RvdHlwZS51bm1vdW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInVubW91bnQoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCBhIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkF0dGVtcHRlZCB0byBzeW5jaHJvbm91c2x5IHVubW91bnQgYSByb290IHdoaWxlIFJlYWN0IHdhcyBhbHJlYWR5IHJlbmRlcmluZy4gUmVhY3QgY2Fubm90IGZpbmlzaCB1bm1vdW50aW5nIHRoZSByb290IHVudGlsIHRoZSBjdXJyZW50IHJlbmRlciBoYXMgY29tcGxldGVkLCB3aGljaCBtYXkgbGVhZCB0byBhIHJhY2UgY29uZGl0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKG51bGwsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHVubWFya0NvbnRhaW5lckFzUm9vdChjb250YWluZXIyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjcmVhdGVSb290KC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpOwogICAgICAgICAgdmFyIGlzU3RyaWN0TW9kZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gIiI7CiAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uQ2FsbGJhY2tzID0gbnVsbDsKICAgICAgICAgIGlmIChvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczIuaHlkcmF0ZSkgewogICAgICAgICAgICAgICAgd2FybjMoImh5ZHJhdGUgdGhyb3VnaCBjcmVhdGVSb290IGlzIGRlcHJlY2F0ZWQuIFVzZSBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uczIgPT09ICJvYmplY3QiICYmIG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBKU1ggZWxlbWVudCB0byBjcmVhdGVSb290LiBZb3UgcHJvYmFibHkgbWVhbnQgdG8gY2FsbCByb290LnJlbmRlciBpbnN0ZWFkLiBFeGFtcGxlIHVzYWdlOlxuXG4gIGxldCByb290ID0gY3JlYXRlUm9vdChkb21Db250YWluZXIpO1xuICByb290LnJlbmRlcig8QXBwIC8+KTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3MgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyYW5zaXRpb25DYWxsYmFja3MgPSBvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVDb250YWluZXIoY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIG51bGwsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTVJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBSZWFjdERPTUh5ZHJhdGlvblJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSHlkcmF0aW9uKHRhcmdldCkgewogICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICBxdWV1ZUV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5zdGFibGVfc2NoZWR1bGVIeWRyYXRpb24gPSBzY2hlZHVsZUh5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJoeWRyYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluaXRpYWxDaGlsZHJlbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoIk11c3QgcHJvdmlkZSBpbml0aWFsIGNoaWxkcmVuIGFzIHNlY29uZCBhcmd1bWVudCB0byBoeWRyYXRlUm9vdC4gRXhhbXBsZSB1c2FnZTogaHlkcmF0ZVJvb3QoZG9tQ29udGFpbmVyLCA8QXBwIC8+KSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaHlkcmF0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIgIT0gbnVsbCA/IG9wdGlvbnMyIDogbnVsbDsKICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlcyA9IG9wdGlvbnMyICE9IG51bGwgJiYgb3B0aW9uczIuaHlkcmF0ZWRTb3VyY2VzIHx8IG51bGw7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIG51bGwsIGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhjb250YWluZXIyKTsKICAgICAgICAgIGlmIChtdXRhYmxlU291cmNlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG11dGFibGVTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSBtdXRhYmxlU291cmNlc1tpXTsKICAgICAgICAgICAgICByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NSHlkcmF0aW9uUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXIobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgIWRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gIiByZWFjdC1tb3VudC1wb2ludC11bnN0YWJsZSAiKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNyZWF0ZVJvb3QoKTogQ3JlYXRpbmcgcm9vdHMgZGlyZWN0bHkgd2l0aCBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgdXNpbmcgYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTS5yZW5kZXIoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gcGFzc2VkIHRvIGNyZWF0ZVJvb3QoKSBiZWZvcmUuIEluc3RlYWQsIGNhbGwgcm9vdC5yZW5kZXIoKSBvbiB0aGUgZXhpc3Rpbmcgcm9vdCBpbnN0ZWFkIGlmIHlvdSB3YW50IHRvIHVwZGF0ZSBpdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgdG9wTGV2ZWxVcGRhdGVXYXJuaW5nczsKICAgICAgICB7CiAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzID0gZnVuY3Rpb24oY29udGFpbmVyMikgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyICYmIGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGlzIGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUgdG8gZW1wdHkgYSBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0ID0gISFjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKHJvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCkpOwogICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQgJiYgIWlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IFJlcGxhY2luZyBSZWFjdC1yZW5kZXJlZCBjaGlsZHJlbiB3aXRoIGEgbmV3IHJvb3QgY29tcG9uZW50LiBJZiB5b3UgaW50ZW5kZWQgdG8gdXBkYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGlzIG5vZGUsIHlvdSBzaG91bGQgaW5zdGVhZCBoYXZlIHRoZSBleGlzdGluZyBjaGlsZHJlbiB1cGRhdGUgdGhlaXIgc3RhdGUgYW5kIHJlbmRlciB0aGUgbmV3IGNvbXBvbmVudHMgaW5zdGVhZCBvZiBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlcigpOiBSZW5kZXJpbmcgY29tcG9uZW50cyBkaXJlY3RseSBpbnRvIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSByZW5kZXJpbmcgaW50byBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgaWYgKCFjb250YWluZXIyKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcE9uUmVjb3ZlcmFibGVFcnJvcigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgaWYgKGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcigKICAgICAgICAgICAgICBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSByb290MzsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoKTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3RTaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAocm9vdFNpYmxpbmcgPSBjb250YWluZXIyLmxhc3RDaGlsZCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQocm9vdFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX29yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKF9yb290KTsKICAgICAgICAgICAgICAgIF9vcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9yb290ID0gY3JlYXRlQ29udGFpbmVyKAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gX3Jvb3Q7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3QoX3Jvb3QuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhfcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgX3Jvb3QsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIF9yb290OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgdHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgY2hpbGRyZW4sIGNvbnRhaW5lcjIsIGZvcmNlSHlkcmF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyhjb250YWluZXIyKTsKICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjaywgInJlbmRlciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlUm9vdCA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIHZhciByb290MzsKICAgICAgICAgIGlmICghbWF5YmVSb290KSB7CiAgICAgICAgICAgIHJvb3QzID0gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGZvcmNlSHlkcmF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290MyA9IG1heWJlUm9vdDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluZERPTU5vZGUoY29tcG9uZW50T3JFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZERPTU5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoImZpbmRET01Ob2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lciQzLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyOwogICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgZmluZERPTU5vZGUgaW5zaWRlIGl0cyByZW5kZXIoKS4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3duZXIudHlwZSkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50Lm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9yRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnRPckVsZW1lbnQsICJmaW5kRE9NTm9kZSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5oeWRyYXRlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBoeWRyYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5oeWRyYXRlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIGh5ZHJhdGVSb290KGNvbnRhaW5lciwgZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcihlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00ucmVuZGVyIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBjcmVhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlcigpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnJlbmRlcihlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKCkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gQ29uc2lkZXIgdXNpbmcgYSBwb3J0YWwgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCA9PSBudWxsIHx8ICFoYXMzKHBhcmVudENvbXBvbmVudCkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJwYXJlbnRDb21wb25lbnQgbXVzdCBiZSBhIHZhbGlkIFJlYWN0IENvbXBvbmVudCIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgZmFsc2UsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1bm1vdW50Q29tcG9uZW50QXROb2RlKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEkuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSAmJiBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMDsKICAgICAgICAgICAgaWYgKGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00udW5tb3VudENvbXBvbmVudEF0Tm9kZSgpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnVubW91bnQoKT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHJvb3RFbCA9IGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKTsKICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRCeURpZmZlcmVudFJlYWN0ID0gcm9vdEVsICYmICFnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCk7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkQnlEaWZmZXJlbnRSZWFjdCkgewogICAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoKTogVGhlIG5vZGUgeW91J3JlIGF0dGVtcHRpbmcgdG8gdW5tb3VudCB3YXMgcmVuZGVyZWQgYnkgYW5vdGhlciBjb3B5IG9mIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgbnVsbCwgY29udGFpbmVyMiwgZmFsc2UsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgICAgIHVubWFya0NvbnRhaW5lckFzUm9vdChjb250YWluZXIyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBfcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKF9yb290RWwgJiYgZ2V0SW5zdGFuY2VGcm9tTm9kZShfcm9vdEVsKSk7CiAgICAgICAgICAgICAgdmFyIGlzQ29udGFpbmVyUmVhY3RSb290ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMi5wYXJlbnROb2RlKSAmJiAhIWNvbnRhaW5lcjIucGFyZW50Tm9kZS5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgICAgIGlmIChoYXNOb25Sb290UmVhY3RDaGlsZCkgewogICAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoKTogVGhlIG5vZGUgeW91J3JlIGF0dGVtcHRpbmcgdG8gdW5tb3VudCB3YXMgcmVuZGVyZWQgYnkgUmVhY3QgYW5kIGlzIG5vdCBhIHRvcC1sZXZlbCBjb250YWluZXIuICVzIiwgaXNDb250YWluZXJSZWFjdFJvb3QgPyAiWW91IG1heSBoYXZlIGFjY2lkZW50YWxseSBwYXNzZWQgaW4gYSBSZWFjdCByb290IG5vZGUgaW5zdGVhZCBvZiBpdHMgY29udGFpbmVyLiIgOiAiSW5zdGVhZCwgaGF2ZSB0aGUgcGFyZW50IGNvbXBvbmVudCB1cGRhdGUgaXRzIHN0YXRlIGFuZCByZXJlbmRlciBpbiBvcmRlciB0byByZW1vdmUgdGhpcyBjb21wb25lbnQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbiQxKTsKICAgICAgICBzZXRBdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKTsKICAgICAgICBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5JDEpOwogICAgICAgIHNldEdldEN1cnJlbnRVcGRhdGVQcmlvcml0eShnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KHJ1bldpdGhQcmlvcml0eSk7CiAgICAgICAgewogICAgICAgICAgaWYgKHR5cGVvZiBNYXAgIT09ICJmdW5jdGlvbiIgfHwgLy8gJEZsb3dJc3N1ZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBNYXAgaGFzIG5vIHByb3RvdHlwZQogICAgICAgICAgTWFwLnByb3RvdHlwZSA9PSBudWxsIHx8IHR5cGVvZiBNYXAucHJvdG90eXBlLmZvckVhY2ggIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIFNldCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIFNldCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBTZXQucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIFNldC5wcm90b3R5cGUuY2xlYXIgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIFNldC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBlcnJvcigiUmVhY3QgZGVwZW5kcyBvbiBNYXAgYW5kIFNldCBidWlsdC1pbiB0eXBlcy4gTWFrZSBzdXJlIHRoYXQgeW91IGxvYWQgYSBwb2x5ZmlsbCBpbiBvbGRlciBicm93c2Vycy4gaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LXBvbHlmaWxscyIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24ocmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQzKTsKICAgICAgICBzZXRCYXRjaGluZ0ltcGxlbWVudGF0aW9uKGJhdGNoZWRVcGRhdGVzJDEsIGRpc2NyZXRlVXBkYXRlcywgZmx1c2hTeW5jKTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVQb3J0YWwkMShjaGlsZHJlbiwgY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lcihjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlUG9ydGFsMyhjaGlsZHJlbiwgY29udGFpbmVyMiwgbnVsbCwga2V5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgSW50ZXJuYWxzID0gewogICAgICAgICAgdXNpbmdDbGllbnRFbnRyeVBvaW50OiBmYWxzZSwKICAgICAgICAgIC8vIEtlZXAgaW4gc3luYyB3aXRoIFJlYWN0VGVzdFV0aWxzLmpzLgogICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnJheSBmb3IgYmV0dGVyIG1pbmlmaWNhdGlvbi4KICAgICAgICAgIEV2ZW50czogW2dldEluc3RhbmNlRnJvbU5vZGUsIGdldE5vZGVGcm9tSW5zdGFuY2UsIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUsIGVucXVldWVTdGF0ZVJlc3RvcmUsIHJlc3RvcmVTdGF0ZUlmTmVlZGVkLCBiYXRjaGVkVXBkYXRlcyQxXQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUm9vdCQxKGNvbnRhaW5lcjIsIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGNyZWF0ZVJvb3QgZnJvbSAicmVhY3QtZG9tIiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkLiBZb3Ugc2hvdWxkIGluc3RlYWQgaW1wb3J0IGl0IGZyb20gInJlYWN0LWRvbS9jbGllbnQiLicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlUm9vdDIoY29udGFpbmVyMiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdCQxKGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFJbnRlcm5hbHMudXNpbmdDbGllbnRFbnRyeVBvaW50ICYmIHRydWUpIHsKICAgICAgICAgICAgICBlcnJvcignWW91IGFyZSBpbXBvcnRpbmcgaHlkcmF0ZVJvb3QgZnJvbSAicmVhY3QtZG9tIiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkLiBZb3Ugc2hvdWxkIGluc3RlYWQgaW1wb3J0IGl0IGZyb20gInJlYWN0LWRvbS9jbGllbnQiLicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaHlkcmF0ZVJvb3QoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBvcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luYyQxKGZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgIGVycm9yKCJmbHVzaFN5bmMgd2FzIGNhbGxlZCBmcm9tIGluc2lkZSBhIGxpZmVjeWNsZSBtZXRob2QuIFJlYWN0IGNhbm5vdCBmbHVzaCB3aGVuIFJlYWN0IGlzIGFscmVhZHkgcmVuZGVyaW5nLiBDb25zaWRlciBtb3ZpbmcgdGhpcyBjYWxsIHRvIGEgc2NoZWR1bGVyIHRhc2sgb3IgbWljcm8gdGFzay4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZsdXNoU3luYyhmbik7CiAgICAgICAgfQogICAgICAgIHZhciBmb3VuZERldlRvb2xzID0gaW5qZWN0SW50b0RldlRvb2xzKHsKICAgICAgICAgIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOiBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZSwKICAgICAgICAgIGJ1bmRsZVR5cGU6IDEsCiAgICAgICAgICB2ZXJzaW9uOiBSZWFjdFZlcnNpb24sCiAgICAgICAgICByZW5kZXJlclBhY2thZ2VOYW1lOiAicmVhY3QtZG9tIgogICAgICAgIH0pOwogICAgICAgIHsKICAgICAgICAgIGlmICghZm91bmREZXZUb29scyAmJiBjYW5Vc2VET00yICYmIHdpbmRvdy50b3AgPT09IHdpbmRvdy5zZWxmKSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpID4gLTEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJFZGdlIikgPT09IC0xIHx8IG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpIHsKICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgICAgICAgaWYgKC9eKGh0dHBzP3xmaWxlKTokLy50ZXN0KHByb3RvY29sKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCIlY0Rvd25sb2FkIHRoZSBSZWFjdCBEZXZUb29scyBmb3IgYSBiZXR0ZXIgZGV2ZWxvcG1lbnQgZXhwZXJpZW5jZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIiArIChwcm90b2NvbCA9PT0gImZpbGU6IiA/ICJcbllvdSBtaWdodCBuZWVkIHRvIHVzZSBhIGxvY2FsIEhUVFAgc2VydmVyIChpbnN0ZWFkIG9mIGZpbGU6Ly8pOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMtZmFxIiA6ICIiKSwgImZvbnQtd2VpZ2h0OmJvbGQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IEludGVybmFsczsKICAgICAgICBleHBvcnRzLmNyZWF0ZVBvcnRhbCA9IGNyZWF0ZVBvcnRhbCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGNyZWF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLmZpbmRET01Ob2RlID0gZmluZERPTU5vZGU7CiAgICAgICAgZXhwb3J0cy5mbHVzaFN5bmMgPSBmbHVzaFN5bmMkMTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGUgPSBoeWRyYXRlOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBoeWRyYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMucmVuZGVyID0gcmVuZGVyOwogICAgICAgIGV4cG9ydHMudW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHVubW91bnRDb21wb25lbnRBdE5vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9iYXRjaGVkVXBkYXRlcyA9IGJhdGNoZWRVcGRhdGVzJDE7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciA9IHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMKdmFyIHJlcXVpcmVfcmVhY3RfZG9tID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGNoZWNrRENFKCk7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMKdmFyIHJlcXVpcmVfY2xpZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2xpZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgbSA9IHJlcXVpcmVfcmVhY3RfZG9tKCk7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gbS5jcmVhdGVSb290OwogICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gbS5oeWRyYXRlUm9vdDsKICAgIH0gZWxzZSB7CiAgICAgIGkgPSBtLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBmdW5jdGlvbihjLCBvKSB7CiAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gbS5jcmVhdGVSb290KGMsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IGZ1bmN0aW9uKGMsIGgsIG8pIHsKICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtLmh5ZHJhdGVSb290KGMsIGgsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHZhciBpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L19pbnRlcm5hbC9pc1Vuc2FmZVByb3BlcnR5LmpzCnZhciByZXF1aXJlX2lzVW5zYWZlUHJvcGVydHkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9faW50ZXJuYWwvaXNVbnNhZmVQcm9wZXJ0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1Vuc2FmZVByb3BlcnR5KGtleSkgewogICAgICByZXR1cm4ga2V5ID09PSAiX19wcm90b19fIjsKICAgIH0KICAgIGV4cG9ydHMuaXNVbnNhZmVQcm9wZXJ0eSA9IGlzVW5zYWZlUHJvcGVydHk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0RlZXBLZXkuanMKdmFyIHJlcXVpcmVfaXNEZWVwS2V5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0RlZXBLZXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNEZWVwS2V5KGtleSkgewogICAgICBzd2l0Y2ggKHR5cGVvZiBrZXkpIHsKICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgIGNhc2UgInN5bWJvbCI6IHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3RyaW5nIjogewogICAgICAgICAgcmV0dXJuIGtleS5pbmNsdWRlcygiLiIpIHx8IGtleS5pbmNsdWRlcygiWyIpIHx8IGtleS5pbmNsdWRlcygiXSIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZXhwb3J0cy5pc0RlZXBLZXkgPSBpc0RlZXBLZXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0tleS5qcwp2YXIgcmVxdWlyZV90b0tleSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9LZXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdG9LZXkodmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbHVlID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBpZiAoT2JqZWN0LmlzKHZhbHVlPy52YWx1ZU9mPy4oKSwgLTApKSB7CiAgICAgICAgcmV0dXJuICItMCI7CiAgICAgIH0KICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLnRvS2V5ID0gdG9LZXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9TdHJpbmcuanMKdmFyIHJlcXVpcmVfdG9TdHJpbmcgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1N0cmluZy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b1N0cmluZyh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAiIjsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdmFsdWUubWFwKHRvU3RyaW5nKS5qb2luKCIsIik7CiAgICAgIH0KICAgICAgY29uc3QgcmVzdWx0ID0gU3RyaW5nKHZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCA9PT0gIjAiICYmIE9iamVjdC5pcyhOdW1iZXIodmFsdWUpLCAtMCkpIHsKICAgICAgICByZXR1cm4gIi0wIjsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy50b1N0cmluZyA9IHRvU3RyaW5nOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvUGF0aC5qcwp2YXIgcmVxdWlyZV90b1BhdGggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1BhdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIHRvU3RyaW5nID0gcmVxdWlyZV90b1N0cmluZygpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgZnVuY3Rpb24gdG9QYXRoKGRlZXBLZXkpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGVlcEtleSkpIHsKICAgICAgICByZXR1cm4gZGVlcEtleS5tYXAodG9LZXkudG9LZXkpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgZGVlcEtleSA9PT0gInN5bWJvbCIpIHsKICAgICAgICByZXR1cm4gW2RlZXBLZXldOwogICAgICB9CiAgICAgIGRlZXBLZXkgPSB0b1N0cmluZy50b1N0cmluZyhkZWVwS2V5KTsKICAgICAgY29uc3QgcmVzdWx0ID0gW107CiAgICAgIGNvbnN0IGxlbmd0aCA9IGRlZXBLZXkubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBsZXQgaW5kZXggPSAwOwogICAgICBsZXQga2V5ID0gIiI7CiAgICAgIGxldCBxdW90ZUNoYXIgPSAiIjsKICAgICAgbGV0IGJyYWNrZXQgPSBmYWxzZTsKICAgICAgaWYgKGRlZXBLZXkuY2hhckNvZGVBdCgwKSA9PT0gNDYpIHsKICAgICAgICByZXN1bHQucHVzaCgiIik7CiAgICAgICAgaW5kZXgrKzsKICAgICAgfQogICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBjb25zdCBjaGFyID0gZGVlcEtleVtpbmRleF07CiAgICAgICAgaWYgKHF1b3RlQ2hhcikgewogICAgICAgICAgaWYgKGNoYXIgPT09ICJcXCIgJiYgaW5kZXggKyAxIDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGtleSArPSBkZWVwS2V5W2luZGV4XTsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gcXVvdGVDaGFyKSB7CiAgICAgICAgICAgIHF1b3RlQ2hhciA9ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChicmFja2V0KSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gJyInIHx8IGNoYXIgPT09ICInIikgewogICAgICAgICAgICBxdW90ZUNoYXIgPSBjaGFyOwogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAiXSIpIHsKICAgICAgICAgICAgYnJhY2tldCA9IGZhbHNlOwogICAgICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSArPSBjaGFyOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gIlsiKSB7CiAgICAgICAgICAgIGJyYWNrZXQgPSB0cnVlOwogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAiLiIpIHsKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgICAgICAgICAga2V5ID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSArPSBjaGFyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbmRleCsrOwogICAgICB9CiAgICAgIGlmIChrZXkpIHsKICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnRvUGF0aCA9IHRvUGF0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2dldC5qcwp2YXIgcmVxdWlyZV9nZXQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2dldC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNVbnNhZmVQcm9wZXJ0eSA9IHJlcXVpcmVfaXNVbnNhZmVQcm9wZXJ0eSgpOwogICAgdmFyIGlzRGVlcEtleSA9IHJlcXVpcmVfaXNEZWVwS2V5KCk7CiAgICB2YXIgdG9LZXkgPSByZXF1aXJlX3RvS2V5KCk7CiAgICB2YXIgdG9QYXRoID0gcmVxdWlyZV90b1BhdGgoKTsKICAgIGZ1bmN0aW9uIGdldDUob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmIChvYmplY3QgPT0gbnVsbCkgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2YgcGF0aDIpIHsKICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICBpZiAoaXNVbnNhZmVQcm9wZXJ0eS5pc1Vuc2FmZVByb3BlcnR5KHBhdGgyKSkgewogICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzdWx0ID0gb2JqZWN0W3BhdGgyXTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoaXNEZWVwS2V5LmlzRGVlcEtleShwYXRoMikpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0NShvYmplY3QsIHRvUGF0aC50b1BhdGgocGF0aDIpLCBkZWZhdWx0VmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgaWYgKHR5cGVvZiBwYXRoMiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgcGF0aDIgPSB0b0tleS50b0tleShwYXRoMik7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwYXRoMikpIHsKICAgICAgICAgICAgcmV0dXJuIGdldFdpdGhQYXRoKG9iamVjdCwgcGF0aDIsIGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoT2JqZWN0LmlzKHBhdGgyPy52YWx1ZU9mKCksIC0wKSkgewogICAgICAgICAgICBwYXRoMiA9ICItMCI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXRoMiA9IFN0cmluZyhwYXRoMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNVbnNhZmVQcm9wZXJ0eS5pc1Vuc2FmZVByb3BlcnR5KHBhdGgyKSkgewogICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzdWx0ID0gb2JqZWN0W3BhdGgyXTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldFdpdGhQYXRoKG9iamVjdCwgcGF0aDIsIGRlZmF1bHRWYWx1ZSkgewogICAgICBpZiAocGF0aDIubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgICBsZXQgY3VycmVudDMgPSBvYmplY3Q7CiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBwYXRoMi5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICBpZiAoY3VycmVudDMgPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzVW5zYWZlUHJvcGVydHkuaXNVbnNhZmVQcm9wZXJ0eShwYXRoMltpbmRleF0pKSB7CiAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgICBjdXJyZW50MyA9IGN1cnJlbnQzW3BhdGgyW2luZGV4XV07CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQzID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBjdXJyZW50MzsKICAgIH0KICAgIGV4cG9ydHMuZ2V0ID0gZ2V0NTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2dldC5qcwp2YXIgcmVxdWlyZV9nZXQyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9nZXQuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX2dldCgpLmdldDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS91bmlxQnkuanMKdmFyIHJlcXVpcmVfdW5pcUJ5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvdW5pcUJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHVuaXFCeTIoYXJyLCBtYXBwZXIpIHsKICAgICAgY29uc3QgbWFwMyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IGFycltpXTsKICAgICAgICBjb25zdCBrZXkgPSBtYXBwZXIoaXRlbSk7CiAgICAgICAgaWYgKCFtYXAzLmhhcyhrZXkpKSB7CiAgICAgICAgICBtYXAzLnNldChrZXksIGl0ZW0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gQXJyYXkuZnJvbShtYXAzLnZhbHVlcygpKTsKICAgIH0KICAgIGV4cG9ydHMudW5pcUJ5ID0gdW5pcUJ5MjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9mdW5jdGlvbi9pZGVudGl0eS5qcwp2YXIgcmVxdWlyZV9pZGVudGl0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2Z1bmN0aW9uL2lkZW50aXR5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlkZW50aXR5NCh4MikgewogICAgICByZXR1cm4geDI7CiAgICB9CiAgICBleHBvcnRzLmlkZW50aXR5ID0gaWRlbnRpdHk0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L3ByZWRpY2F0ZS9pc0xlbmd0aC5qcwp2YXIgcmVxdWlyZV9pc0xlbmd0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L3ByZWRpY2F0ZS9pc0xlbmd0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc0xlbmd0aCh2YWx1ZSkgewogICAgICByZXR1cm4gTnVtYmVyLmlzU2FmZUludGVnZXIodmFsdWUpICYmIHZhbHVlID49IDA7CiAgICB9CiAgICBleHBvcnRzLmlzTGVuZ3RoID0gaXNMZW5ndGg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZS5qcwp2YXIgcmVxdWlyZV9pc0FycmF5TGlrZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcnJheUxpa2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTGVuZ3RoID0gcmVxdWlyZV9pc0xlbmd0aCgpOwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2UodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICE9IG51bGwgJiYgdHlwZW9mIHZhbHVlICE9PSAiZnVuY3Rpb24iICYmIGlzTGVuZ3RoLmlzTGVuZ3RoKHZhbHVlLmxlbmd0aCk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlMaWtlID0gaXNBcnJheUxpa2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdExpa2UuanMKdmFyIHJlcXVpcmVfaXNPYmplY3RMaWtlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdExpa2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNPYmplY3RMaWtlKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsOwogICAgfQogICAgZXhwb3J0cy5pc09iamVjdExpa2UgPSBpc09iamVjdExpa2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZU9iamVjdC5qcwp2YXIgcmVxdWlyZV9pc0FycmF5TGlrZU9iamVjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcnJheUxpa2VPYmplY3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgdmFyIGlzT2JqZWN0TGlrZSA9IHJlcXVpcmVfaXNPYmplY3RMaWtlKCk7CiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZU9iamVjdCh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlLmlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgaXNBcnJheUxpa2UuaXNBcnJheUxpa2UodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZU9iamVjdCA9IGlzQXJyYXlMaWtlT2JqZWN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvcHJvcGVydHkuanMKdmFyIHJlcXVpcmVfcHJvcGVydHkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L3Byb3BlcnR5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBnZXQ1ID0gcmVxdWlyZV9nZXQoKTsKICAgIGZ1bmN0aW9uIHByb3BlcnR5KHBhdGgyKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gZ2V0NS5nZXQob2JqZWN0LCBwYXRoMik7CiAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLnByb3BlcnR5ID0gcHJvcGVydHk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdC5qcwp2YXIgcmVxdWlyZV9pc09iamVjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNPYmplY3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsICYmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIik7CiAgICB9CiAgICBleHBvcnRzLmlzT2JqZWN0ID0gaXNPYmplY3Q7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzUHJpbWl0aXZlLmpzCnZhciByZXF1aXJlX2lzUHJpbWl0aXZlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzUHJpbWl0aXZlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzUHJpbWl0aXZlKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIHZhbHVlICE9PSAiZnVuY3Rpb24iOwogICAgfQogICAgZXhwb3J0cy5pc1ByaW1pdGl2ZSA9IGlzUHJpbWl0aXZlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL2VxLmpzCnZhciByZXF1aXJlX2VxID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvZXEuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZXEodmFsdWUsIG90aGVyKSB7CiAgICAgIHJldHVybiB2YWx1ZSA9PT0gb3RoZXIgfHwgTnVtYmVyLmlzTmFOKHZhbHVlKSAmJiBOdW1iZXIuaXNOYU4ob3RoZXIpOwogICAgfQogICAgZXhwb3J0cy5lcSA9IGVxOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaFdpdGguanMKdmFyIHJlcXVpcmVfaXNNYXRjaFdpdGggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzTWF0Y2hXaXRoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc09iamVjdCA9IHJlcXVpcmVfaXNPYmplY3QoKTsKICAgIHZhciBpc1ByaW1pdGl2ZSA9IHJlcXVpcmVfaXNQcmltaXRpdmUoKTsKICAgIHZhciBlcSA9IHJlcXVpcmVfZXEoKTsKICAgIGZ1bmN0aW9uIGlzTWF0Y2hXaXRoKHRhcmdldCwgc291cmNlLCBjb21wYXJlKSB7CiAgICAgIGlmICh0eXBlb2YgY29tcGFyZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHJldHVybiBpc01hdGNoV2l0aCh0YXJnZXQsIHNvdXJjZSwgKCkgPT4gdm9pZCAwKTsKICAgICAgfQogICAgICByZXR1cm4gaXNNYXRjaFdpdGhJbnRlcm5hbCh0YXJnZXQsIHNvdXJjZSwgZnVuY3Rpb24gZG9lc01hdGNoKG9ialZhbHVlLCBzcmNWYWx1ZSwga2V5LCBvYmplY3QsIHNvdXJjZTIsIHN0YWNrKSB7CiAgICAgICAgY29uc3QgaXNFcXVhbCA9IGNvbXBhcmUob2JqVmFsdWUsIHNyY1ZhbHVlLCBrZXksIG9iamVjdCwgc291cmNlMiwgc3RhY2spOwogICAgICAgIGlmIChpc0VxdWFsICE9PSB2b2lkIDApIHsKICAgICAgICAgIHJldHVybiBCb29sZWFuKGlzRXF1YWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNNYXRjaFdpdGhJbnRlcm5hbChvYmpWYWx1ZSwgc3JjVmFsdWUsIGRvZXNNYXRjaCwgc3RhY2spOwogICAgICB9LCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpKTsKICAgIH0KICAgIGZ1bmN0aW9uIGlzTWF0Y2hXaXRoSW50ZXJuYWwodGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKSB7CiAgICAgIGlmIChzb3VyY2UgPT09IHRhcmdldCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHN3aXRjaCAodHlwZW9mIHNvdXJjZSkgewogICAgICAgIGNhc2UgIm9iamVjdCI6IHsKICAgICAgICAgIHJldHVybiBpc09iamVjdE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjayk7CiAgICAgICAgfQogICAgICAgIGNhc2UgImZ1bmN0aW9uIjogewogICAgICAgICAgY29uc3Qgc291cmNlS2V5cyA9IE9iamVjdC5rZXlzKHNvdXJjZSk7CiAgICAgICAgICBpZiAoc291cmNlS2V5cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKHRhcmdldCwgeyAuLi5zb3VyY2UgfSwgY29tcGFyZSwgc3RhY2spOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVxLmVxKHRhcmdldCwgc291cmNlKTsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgaWYgKCFpc09iamVjdC5pc09iamVjdCh0YXJnZXQpKSB7CiAgICAgICAgICAgIHJldHVybiBlcS5lcSh0YXJnZXQsIHNvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHNvdXJjZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHNvdXJjZSA9PT0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGlzT2JqZWN0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKSB7CiAgICAgIGlmIChzb3VyY2UgPT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICByZXR1cm4gaXNBcnJheU1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjayk7CiAgICAgIH0KICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIE1hcCkgewogICAgICAgIHJldHVybiBpc01hcE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjayk7CiAgICAgIH0KICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIFNldCkgewogICAgICAgIHJldHVybiBpc1NldE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjayk7CiAgICAgIH0KICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHNvdXJjZSk7CiAgICAgIGlmICh0YXJnZXQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiBrZXlzLmxlbmd0aCA9PT0gMDsKICAgICAgfQogICAgICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoc3RhY2s/Lmhhcyhzb3VyY2UpKSB7CiAgICAgICAgcmV0dXJuIHN0YWNrLmdldChzb3VyY2UpID09PSB0YXJnZXQ7CiAgICAgIH0KICAgICAgc3RhY2s/LnNldChzb3VyY2UsIHRhcmdldCk7CiAgICAgIHRyeSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgaWYgKCFpc1ByaW1pdGl2ZS5pc1ByaW1pdGl2ZSh0YXJnZXQpICYmICEoa2V5IGluIHRhcmdldCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZVtrZXldID09PSB2b2lkIDAgJiYgdGFyZ2V0W2tleV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlW2tleV0gPT09IG51bGwgJiYgdGFyZ2V0W2tleV0gIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaXNFcXVhbCA9IGNvbXBhcmUodGFyZ2V0W2tleV0sIHNvdXJjZVtrZXldLCBrZXksIHRhcmdldCwgc291cmNlLCBzdGFjayk7CiAgICAgICAgICBpZiAoIWlzRXF1YWwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBzdGFjaz8uZGVsZXRlKHNvdXJjZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGlzTWFwTWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKSB7CiAgICAgIGlmIChzb3VyY2Uuc2l6ZSA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICghKHRhcmdldCBpbnN0YW5jZW9mIE1hcCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgZm9yIChjb25zdCBba2V5LCBzb3VyY2VWYWx1ZV0gb2Ygc291cmNlLmVudHJpZXMoKSkgewogICAgICAgIGNvbnN0IHRhcmdldFZhbHVlID0gdGFyZ2V0LmdldChrZXkpOwogICAgICAgIGNvbnN0IGlzRXF1YWwgPSBjb21wYXJlKHRhcmdldFZhbHVlLCBzb3VyY2VWYWx1ZSwga2V5LCB0YXJnZXQsIHNvdXJjZSwgc3RhY2spOwogICAgICAgIGlmIChpc0VxdWFsID09PSBmYWxzZSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGlzQXJyYXlNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZS5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodGFyZ2V0KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBjb25zdCBjb3VudGVkSW5kZXggPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNvdXJjZS5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHNvdXJjZUl0ZW0gPSBzb3VyY2VbaV07CiAgICAgICAgbGV0IGZvdW5kID0gZmFsc2U7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0YXJnZXQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChjb3VudGVkSW5kZXguaGFzKGopKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgdGFyZ2V0SXRlbSA9IHRhcmdldFtqXTsKICAgICAgICAgIGxldCBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgY29uc3QgaXNFcXVhbCA9IGNvbXBhcmUodGFyZ2V0SXRlbSwgc291cmNlSXRlbSwgaSwgdGFyZ2V0LCBzb3VyY2UsIHN0YWNrKTsKICAgICAgICAgIGlmIChpc0VxdWFsKSB7CiAgICAgICAgICAgIG1hdGNoZXMyID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXRjaGVzMikgewogICAgICAgICAgICBjb3VudGVkSW5kZXguYWRkKGopOwogICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZnVuY3Rpb24gaXNTZXRNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZS5zaXplID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKCEodGFyZ2V0IGluc3RhbmNlb2YgU2V0KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gaXNBcnJheU1hdGNoKFsuLi50YXJnZXRdLCBbLi4uc291cmNlXSwgY29tcGFyZSwgc3RhY2spOwogICAgfQogICAgZXhwb3J0cy5pc01hdGNoV2l0aCA9IGlzTWF0Y2hXaXRoOwogICAgZXhwb3J0cy5pc1NldE1hdGNoID0gaXNTZXRNYXRjaDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzTWF0Y2guanMKdmFyIHJlcXVpcmVfaXNNYXRjaCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNNYXRjaFdpdGggPSByZXF1aXJlX2lzTWF0Y2hXaXRoKCk7CiAgICBmdW5jdGlvbiBpc01hdGNoKHRhcmdldCwgc291cmNlKSB7CiAgICAgIHJldHVybiBpc01hdGNoV2l0aC5pc01hdGNoV2l0aCh0YXJnZXQsIHNvdXJjZSwgKCkgPT4gdm9pZCAwKTsKICAgIH0KICAgIGV4cG9ydHMuaXNNYXRjaCA9IGlzTWF0Y2g7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9nZXRTeW1ib2xzLmpzCnZhciByZXF1aXJlX2dldFN5bWJvbHMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFN5bWJvbHMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZ2V0U3ltYm9scyhvYmplY3QpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMob2JqZWN0KS5maWx0ZXIoKHN5bWJvbCkgPT4gT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKG9iamVjdCwgc3ltYm9sKSk7CiAgICB9CiAgICBleHBvcnRzLmdldFN5bWJvbHMgPSBnZXRTeW1ib2xzOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0VGFnLmpzCnZhciByZXF1aXJlX2dldFRhZyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0VGFnLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGdldFRhZyh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdm9pZCAwID8gIltvYmplY3QgVW5kZWZpbmVkXSIgOiAiW29iamVjdCBOdWxsXSI7CiAgICAgIH0KICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLmdldFRhZyA9IGdldFRhZzsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RhZ3MuanMKdmFyIHJlcXVpcmVfdGFncyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdGFncy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgcmVnZXhwVGFnID0gIltvYmplY3QgUmVnRXhwXSI7CiAgICB2YXIgc3RyaW5nVGFnID0gIltvYmplY3QgU3RyaW5nXSI7CiAgICB2YXIgbnVtYmVyVGFnID0gIltvYmplY3QgTnVtYmVyXSI7CiAgICB2YXIgYm9vbGVhblRhZyA9ICJbb2JqZWN0IEJvb2xlYW5dIjsKICAgIHZhciBhcmd1bWVudHNUYWcgPSAiW29iamVjdCBBcmd1bWVudHNdIjsKICAgIHZhciBzeW1ib2xUYWcgPSAiW29iamVjdCBTeW1ib2xdIjsKICAgIHZhciBkYXRlVGFnID0gIltvYmplY3QgRGF0ZV0iOwogICAgdmFyIG1hcFRhZyA9ICJbb2JqZWN0IE1hcF0iOwogICAgdmFyIHNldFRhZyA9ICJbb2JqZWN0IFNldF0iOwogICAgdmFyIGFycmF5VGFnID0gIltvYmplY3QgQXJyYXldIjsKICAgIHZhciBmdW5jdGlvblRhZyA9ICJbb2JqZWN0IEZ1bmN0aW9uXSI7CiAgICB2YXIgYXJyYXlCdWZmZXJUYWcgPSAiW29iamVjdCBBcnJheUJ1ZmZlcl0iOwogICAgdmFyIG9iamVjdFRhZyA9ICJbb2JqZWN0IE9iamVjdF0iOwogICAgdmFyIGVycm9yVGFnID0gIltvYmplY3QgRXJyb3JdIjsKICAgIHZhciBkYXRhVmlld1RhZyA9ICJbb2JqZWN0IERhdGFWaWV3XSI7CiAgICB2YXIgdWludDhBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQ4QXJyYXldIjsKICAgIHZhciB1aW50OENsYW1wZWRBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XSI7CiAgICB2YXIgdWludDE2QXJyYXlUYWcgPSAiW29iamVjdCBVaW50MTZBcnJheV0iOwogICAgdmFyIHVpbnQzMkFycmF5VGFnID0gIltvYmplY3QgVWludDMyQXJyYXldIjsKICAgIHZhciBiaWdVaW50NjRBcnJheVRhZyA9ICJbb2JqZWN0IEJpZ1VpbnQ2NEFycmF5XSI7CiAgICB2YXIgaW50OEFycmF5VGFnID0gIltvYmplY3QgSW50OEFycmF5XSI7CiAgICB2YXIgaW50MTZBcnJheVRhZyA9ICJbb2JqZWN0IEludDE2QXJyYXldIjsKICAgIHZhciBpbnQzMkFycmF5VGFnID0gIltvYmplY3QgSW50MzJBcnJheV0iOwogICAgdmFyIGJpZ0ludDY0QXJyYXlUYWcgPSAiW29iamVjdCBCaWdJbnQ2NEFycmF5XSI7CiAgICB2YXIgZmxvYXQzMkFycmF5VGFnID0gIltvYmplY3QgRmxvYXQzMkFycmF5XSI7CiAgICB2YXIgZmxvYXQ2NEFycmF5VGFnID0gIltvYmplY3QgRmxvYXQ2NEFycmF5XSI7CiAgICBleHBvcnRzLmFyZ3VtZW50c1RhZyA9IGFyZ3VtZW50c1RhZzsKICAgIGV4cG9ydHMuYXJyYXlCdWZmZXJUYWcgPSBhcnJheUJ1ZmZlclRhZzsKICAgIGV4cG9ydHMuYXJyYXlUYWcgPSBhcnJheVRhZzsKICAgIGV4cG9ydHMuYmlnSW50NjRBcnJheVRhZyA9IGJpZ0ludDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmJpZ1VpbnQ2NEFycmF5VGFnID0gYmlnVWludDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmJvb2xlYW5UYWcgPSBib29sZWFuVGFnOwogICAgZXhwb3J0cy5kYXRhVmlld1RhZyA9IGRhdGFWaWV3VGFnOwogICAgZXhwb3J0cy5kYXRlVGFnID0gZGF0ZVRhZzsKICAgIGV4cG9ydHMuZXJyb3JUYWcgPSBlcnJvclRhZzsKICAgIGV4cG9ydHMuZmxvYXQzMkFycmF5VGFnID0gZmxvYXQzMkFycmF5VGFnOwogICAgZXhwb3J0cy5mbG9hdDY0QXJyYXlUYWcgPSBmbG9hdDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmZ1bmN0aW9uVGFnID0gZnVuY3Rpb25UYWc7CiAgICBleHBvcnRzLmludDE2QXJyYXlUYWcgPSBpbnQxNkFycmF5VGFnOwogICAgZXhwb3J0cy5pbnQzMkFycmF5VGFnID0gaW50MzJBcnJheVRhZzsKICAgIGV4cG9ydHMuaW50OEFycmF5VGFnID0gaW50OEFycmF5VGFnOwogICAgZXhwb3J0cy5tYXBUYWcgPSBtYXBUYWc7CiAgICBleHBvcnRzLm51bWJlclRhZyA9IG51bWJlclRhZzsKICAgIGV4cG9ydHMub2JqZWN0VGFnID0gb2JqZWN0VGFnOwogICAgZXhwb3J0cy5yZWdleHBUYWcgPSByZWdleHBUYWc7CiAgICBleHBvcnRzLnNldFRhZyA9IHNldFRhZzsKICAgIGV4cG9ydHMuc3RyaW5nVGFnID0gc3RyaW5nVGFnOwogICAgZXhwb3J0cy5zeW1ib2xUYWcgPSBzeW1ib2xUYWc7CiAgICBleHBvcnRzLnVpbnQxNkFycmF5VGFnID0gdWludDE2QXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQzMkFycmF5VGFnID0gdWludDMyQXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQ4QXJyYXlUYWcgPSB1aW50OEFycmF5VGFnOwogICAgZXhwb3J0cy51aW50OENsYW1wZWRBcnJheVRhZyA9IHVpbnQ4Q2xhbXBlZEFycmF5VGFnOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L3ByZWRpY2F0ZS9pc1R5cGVkQXJyYXkuanMKdmFyIHJlcXVpcmVfaXNUeXBlZEFycmF5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzVHlwZWRBcnJheS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1R5cGVkQXJyYXkoeDIpIHsKICAgICAgcmV0dXJuIEFycmF5QnVmZmVyLmlzVmlldyh4MikgJiYgISh4MiBpbnN0YW5jZW9mIERhdGFWaWV3KTsKICAgIH0KICAgIGV4cG9ydHMuaXNUeXBlZEFycmF5ID0gaXNUeXBlZEFycmF5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzCnZhciByZXF1aXJlX2Nsb25lRGVlcFdpdGggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgZ2V0U3ltYm9scyA9IHJlcXVpcmVfZ2V0U3ltYm9scygpOwogICAgdmFyIGdldFRhZyA9IHJlcXVpcmVfZ2V0VGFnKCk7CiAgICB2YXIgdGFncyA9IHJlcXVpcmVfdGFncygpOwogICAgdmFyIGlzUHJpbWl0aXZlID0gcmVxdWlyZV9pc1ByaW1pdGl2ZSgpOwogICAgdmFyIGlzVHlwZWRBcnJheSA9IHJlcXVpcmVfaXNUeXBlZEFycmF5KCk7CiAgICBmdW5jdGlvbiBjbG9uZURlZXBXaXRoKG9iaiwgY2xvbmVWYWx1ZSkgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aEltcGwob2JqLCB2b2lkIDAsIG9iaiwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSwgY2xvbmVWYWx1ZSk7CiAgICB9CiAgICBmdW5jdGlvbiBjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZVRvQ2xvbmUsIGtleVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSwgY2xvbmVWYWx1ZSA9IHZvaWQgMCkgewogICAgICBjb25zdCBjbG9uZWQgPSBjbG9uZVZhbHVlPy4odmFsdWVUb0Nsb25lLCBrZXlUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjayk7CiAgICAgIGlmIChjbG9uZWQgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBjbG9uZWQ7CiAgICAgIH0KICAgICAgaWYgKGlzUHJpbWl0aXZlLmlzUHJpbWl0aXZlKHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICByZXR1cm4gdmFsdWVUb0Nsb25lOwogICAgICB9CiAgICAgIGlmIChzdGFjay5oYXModmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiBzdGFjay5nZXQodmFsdWVUb0Nsb25lKTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KHZhbHVlVG9DbG9uZS5sZW5ndGgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZVRvQ2xvbmUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlc3VsdFtpXSA9IGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlVG9DbG9uZVtpXSwgaSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIH0KICAgICAgICBpZiAoT2JqZWN0Lmhhc093bih2YWx1ZVRvQ2xvbmUsICJpbmRleCIpKSB7CiAgICAgICAgICByZXN1bHQuaW5kZXggPSB2YWx1ZVRvQ2xvbmUuaW5kZXg7CiAgICAgICAgfQogICAgICAgIGlmIChPYmplY3QuaGFzT3duKHZhbHVlVG9DbG9uZSwgImlucHV0IikpIHsKICAgICAgICAgIHJlc3VsdC5pbnB1dCA9IHZhbHVlVG9DbG9uZS5pbnB1dDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZVRvQ2xvbmUuZ2V0VGltZSgpKTsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFJlZ0V4cCh2YWx1ZVRvQ2xvbmUuc291cmNlLCB2YWx1ZVRvQ2xvbmUuZmxhZ3MpOwogICAgICAgIHJlc3VsdC5sYXN0SW5kZXggPSB2YWx1ZVRvQ2xvbmUubGFzdEluZGV4OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIE1hcCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB2YWx1ZVRvQ2xvbmUpIHsKICAgICAgICAgIHJlc3VsdC5zZXQoa2V5LCBjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZSwga2V5LCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBTZXQpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZVRvQ2xvbmUpIHsKICAgICAgICAgIHJlc3VsdC5hZGQoY2xvbmVEZWVwV2l0aEltcGwodmFsdWUsIHZvaWQgMCwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIEJ1ZmZlciAhPT0gInVuZGVmaW5lZCIgJiYgQnVmZmVyLmlzQnVmZmVyKHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICByZXR1cm4gdmFsdWVUb0Nsb25lLnN1YmFycmF5KCk7CiAgICAgIH0KICAgICAgaWYgKGlzVHlwZWRBcnJheS5pc1R5cGVkQXJyYXkodmFsdWVUb0Nsb25lKSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyAoT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbHVlVG9DbG9uZSkpLmNvbnN0cnVjdG9yKHZhbHVlVG9DbG9uZS5sZW5ndGgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZVRvQ2xvbmUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlc3VsdFtpXSA9IGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlVG9DbG9uZVtpXSwgaSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciB8fCB0eXBlb2YgU2hhcmVkQXJyYXlCdWZmZXIgIT09ICJ1bmRlZmluZWQiICYmIHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIFNoYXJlZEFycmF5QnVmZmVyKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlVG9DbG9uZS5zbGljZSgwKTsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRGF0YVZpZXcpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgRGF0YVZpZXcodmFsdWVUb0Nsb25lLmJ1ZmZlci5zbGljZSgwKSwgdmFsdWVUb0Nsb25lLmJ5dGVPZmZzZXQsIHZhbHVlVG9DbG9uZS5ieXRlTGVuZ3RoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIEZpbGUgIT09ICJ1bmRlZmluZWQiICYmIHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEZpbGUpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgRmlsZShbdmFsdWVUb0Nsb25lXSwgdmFsdWVUb0Nsb25lLm5hbWUsIHsKICAgICAgICAgIHR5cGU6IHZhbHVlVG9DbG9uZS50eXBlCiAgICAgICAgfSk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBCbG9iICE9PSAidW5kZWZpbmVkIiAmJiB2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBCbG9iKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEJsb2IoW3ZhbHVlVG9DbG9uZV0sIHsgdHlwZTogdmFsdWVUb0Nsb25lLnR5cGUgfSk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IHZhbHVlVG9DbG9uZS5jb25zdHJ1Y3RvcigpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0Lm1lc3NhZ2UgPSB2YWx1ZVRvQ2xvbmUubWVzc2FnZTsKICAgICAgICByZXN1bHQubmFtZSA9IHZhbHVlVG9DbG9uZS5uYW1lOwogICAgICAgIHJlc3VsdC5zdGFjayA9IHZhbHVlVG9DbG9uZS5zdGFjazsKICAgICAgICByZXN1bHQuY2F1c2UgPSB2YWx1ZVRvQ2xvbmUuY2F1c2U7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBCb29sZWFuKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEJvb2xlYW4odmFsdWVUb0Nsb25lLnZhbHVlT2YoKSk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIE51bWJlcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBOdW1iZXIodmFsdWVUb0Nsb25lLnZhbHVlT2YoKSk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIFN0cmluZykgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBTdHJpbmcodmFsdWVUb0Nsb25lLnZhbHVlT2YoKSk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB2YWx1ZVRvQ2xvbmUgPT09ICJvYmplY3QiICYmIGlzQ2xvbmVhYmxlT2JqZWN0KHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBPYmplY3QuY3JlYXRlKE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWx1ZVRvQ2xvbmUpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWVUb0Nsb25lOwogICAgfQogICAgZnVuY3Rpb24gY29weVByb3BlcnRpZXModGFyZ2V0LCBzb3VyY2UsIG9iamVjdFRvQ2xvbmUgPSB0YXJnZXQsIHN0YWNrLCBjbG9uZVZhbHVlKSB7CiAgICAgIGNvbnN0IGtleXMgPSBbLi4uT2JqZWN0LmtleXMoc291cmNlKSwgLi4uZ2V0U3ltYm9scy5nZXRTeW1ib2xzKHNvdXJjZSldOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICAgIGNvbnN0IGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KTsKICAgICAgICBpZiAoZGVzY3JpcHRvciA9PSBudWxsIHx8IGRlc2NyaXB0b3Iud3JpdGFibGUpIHsKICAgICAgICAgIHRhcmdldFtrZXldID0gY2xvbmVEZWVwV2l0aEltcGwoc291cmNlW2tleV0sIGtleSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNDbG9uZWFibGVPYmplY3Qob2JqZWN0KSB7CiAgICAgIHN3aXRjaCAoZ2V0VGFnLmdldFRhZyhvYmplY3QpKSB7CiAgICAgICAgY2FzZSB0YWdzLmFyZ3VtZW50c1RhZzoKICAgICAgICBjYXNlIHRhZ3MuYXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmFycmF5QnVmZmVyVGFnOgogICAgICAgIGNhc2UgdGFncy5kYXRhVmlld1RhZzoKICAgICAgICBjYXNlIHRhZ3MuYm9vbGVhblRhZzoKICAgICAgICBjYXNlIHRhZ3MuZGF0ZVRhZzoKICAgICAgICBjYXNlIHRhZ3MuZmxvYXQzMkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5mbG9hdDY0QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmludDhBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuaW50MTZBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuaW50MzJBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MubWFwVGFnOgogICAgICAgIGNhc2UgdGFncy5udW1iZXJUYWc6CiAgICAgICAgY2FzZSB0YWdzLm9iamVjdFRhZzoKICAgICAgICBjYXNlIHRhZ3MucmVnZXhwVGFnOgogICAgICAgIGNhc2UgdGFncy5zZXRUYWc6CiAgICAgICAgY2FzZSB0YWdzLnN0cmluZ1RhZzoKICAgICAgICBjYXNlIHRhZ3Muc3ltYm9sVGFnOgogICAgICAgIGNhc2UgdGFncy51aW50OEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy51aW50OENsYW1wZWRBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDE2QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQzMkFycmF5VGFnOiB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoID0gY2xvbmVEZWVwV2l0aDsKICAgIGV4cG9ydHMuY2xvbmVEZWVwV2l0aEltcGwgPSBjbG9uZURlZXBXaXRoSW1wbDsKICAgIGV4cG9ydHMuY29weVByb3BlcnRpZXMgPSBjb3B5UHJvcGVydGllczsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9vYmplY3QvY2xvbmVEZWVwLmpzCnZhciByZXF1aXJlX2Nsb25lRGVlcCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXAuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGNsb25lRGVlcFdpdGggPSByZXF1aXJlX2Nsb25lRGVlcFdpdGgoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcChvYmopIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGguY2xvbmVEZWVwV2l0aEltcGwob2JqLCB2b2lkIDAsIG9iaiwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSwgdm9pZCAwKTsKICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwID0gY2xvbmVEZWVwOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvbWF0Y2hlcy5qcwp2YXIgcmVxdWlyZV9tYXRjaGVzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc01hdGNoID0gcmVxdWlyZV9pc01hdGNoKCk7CiAgICB2YXIgY2xvbmVEZWVwID0gcmVxdWlyZV9jbG9uZURlZXAoKTsKICAgIGZ1bmN0aW9uIG1hdGNoZXMyKHNvdXJjZSkgewogICAgICBzb3VyY2UgPSBjbG9uZURlZXAuY2xvbmVEZWVwKHNvdXJjZSk7CiAgICAgIHJldHVybiAodGFyZ2V0KSA9PiB7CiAgICAgICAgcmV0dXJuIGlzTWF0Y2guaXNNYXRjaCh0YXJnZXQsIHNvdXJjZSk7CiAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLm1hdGNoZXMgPSBtYXRjaGVzMjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwV2l0aDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGNsb25lRGVlcFdpdGgkMSA9IHJlcXVpcmVfY2xvbmVEZWVwV2l0aCgpOwogICAgdmFyIHRhZ3MgPSByZXF1aXJlX3RhZ3MoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGgob2JqLCBjdXN0b21pemVyKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoJDEuY2xvbmVEZWVwV2l0aChvYmosICh2YWx1ZSwga2V5LCBvYmplY3QsIHN0YWNrKSA9PiB7CiAgICAgICAgY29uc3QgY2xvbmVkID0gY3VzdG9taXplcj8uKHZhbHVlLCBrZXksIG9iamVjdCwgc3RhY2spOwogICAgICAgIGlmIChjbG9uZWQgIT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIGNsb25lZDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBvYmogIT09ICJvYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopKSB7CiAgICAgICAgICBjYXNlIHRhZ3MubnVtYmVyVGFnOgogICAgICAgICAgY2FzZSB0YWdzLnN0cmluZ1RhZzoKICAgICAgICAgIGNhc2UgdGFncy5ib29sZWFuVGFnOiB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBvYmouY29uc3RydWN0b3Iob2JqPy52YWx1ZU9mKCkpOwogICAgICAgICAgICBjbG9uZURlZXBXaXRoJDEuY29weVByb3BlcnRpZXMocmVzdWx0LCBvYmopOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgY2FzZSB0YWdzLmFyZ3VtZW50c1RhZzogewogICAgICAgICAgICBjb25zdCByZXN1bHQgPSB7fTsKICAgICAgICAgICAgY2xvbmVEZWVwV2l0aCQxLmNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgb2JqKTsKICAgICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICAgICAgICAgIHJlc3VsdFtTeW1ib2wuaXRlcmF0b3JdID0gb2JqW1N5bWJvbC5pdGVyYXRvcl07CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwV2l0aCA9IGNsb25lRGVlcFdpdGg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9jbG9uZURlZXAuanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjbG9uZURlZXBXaXRoID0gcmVxdWlyZV9jbG9uZURlZXBXaXRoMigpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwKG9iaikgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aC5jbG9uZURlZXBXaXRoKG9iaik7CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzSW5kZXguanMKdmFyIHJlcXVpcmVfaXNJbmRleCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJbmRleC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgSVNfVU5TSUdORURfSU5URUdFUiA9IC9eKD86MHxbMS05XVxkKikkLzsKICAgIGZ1bmN0aW9uIGlzSW5kZXgodmFsdWUsIGxlbmd0aCA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcmV0dXJuIE51bWJlci5pc0ludGVnZXIodmFsdWUpICYmIHZhbHVlID49IDAgJiYgdmFsdWUgPCBsZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNhc2UgInN5bWJvbCI6IHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3RyaW5nIjogewogICAgICAgICAgcmV0dXJuIElTX1VOU0lHTkVEX0lOVEVHRVIudGVzdCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmlzSW5kZXggPSBpc0luZGV4OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcmd1bWVudHMuanMKdmFyIHJlcXVpcmVfaXNBcmd1bWVudHMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJndW1lbnRzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBnZXRUYWcgPSByZXF1aXJlX2dldFRhZygpOwogICAgZnVuY3Rpb24gaXNBcmd1bWVudHModmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgZ2V0VGFnLmdldFRhZyh2YWx1ZSkgPT09ICJbb2JqZWN0IEFyZ3VtZW50c10iOwogICAgfQogICAgZXhwb3J0cy5pc0FyZ3VtZW50cyA9IGlzQXJndW1lbnRzOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvaGFzLmpzCnZhciByZXF1aXJlX2hhcyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvaGFzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc0RlZXBLZXkgPSByZXF1aXJlX2lzRGVlcEtleSgpOwogICAgdmFyIGlzSW5kZXggPSByZXF1aXJlX2lzSW5kZXgoKTsKICAgIHZhciBpc0FyZ3VtZW50cyA9IHJlcXVpcmVfaXNBcmd1bWVudHMoKTsKICAgIHZhciB0b1BhdGggPSByZXF1aXJlX3RvUGF0aCgpOwogICAgZnVuY3Rpb24gaGFzMyhvYmplY3QsIHBhdGgyKSB7CiAgICAgIGxldCByZXNvbHZlZFBhdGg7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGgyKSkgewogICAgICAgIHJlc29sdmVkUGF0aCA9IHBhdGgyOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXRoMiA9PT0gInN0cmluZyIgJiYgaXNEZWVwS2V5LmlzRGVlcEtleShwYXRoMikgJiYgb2JqZWN0Py5bcGF0aDJdID09IG51bGwpIHsKICAgICAgICByZXNvbHZlZFBhdGggPSB0b1BhdGgudG9QYXRoKHBhdGgyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNvbHZlZFBhdGggPSBbcGF0aDJdOwogICAgICB9CiAgICAgIGlmIChyZXNvbHZlZFBhdGgubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGxldCBjdXJyZW50MyA9IG9iamVjdDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXNvbHZlZFBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBrZXkgPSByZXNvbHZlZFBhdGhbaV07CiAgICAgICAgaWYgKGN1cnJlbnQzID09IG51bGwgfHwgIU9iamVjdC5oYXNPd24oY3VycmVudDMsIGtleSkpIHsKICAgICAgICAgIGNvbnN0IGlzU3BhcnNlSW5kZXggPSAoQXJyYXkuaXNBcnJheShjdXJyZW50MykgfHwgaXNBcmd1bWVudHMuaXNBcmd1bWVudHMoY3VycmVudDMpKSAmJiBpc0luZGV4LmlzSW5kZXgoa2V5KSAmJiBrZXkgPCBjdXJyZW50My5sZW5ndGg7CiAgICAgICAgICBpZiAoIWlzU3BhcnNlSW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjdXJyZW50MyA9IGN1cnJlbnQzW2tleV07CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBleHBvcnRzLmhhcyA9IGhhczM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzUHJvcGVydHkuanMKdmFyIHJlcXVpcmVfbWF0Y2hlc1Byb3BlcnR5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzUHJvcGVydHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTWF0Y2ggPSByZXF1aXJlX2lzTWF0Y2goKTsKICAgIHZhciB0b0tleSA9IHJlcXVpcmVfdG9LZXkoKTsKICAgIHZhciBjbG9uZURlZXAgPSByZXF1aXJlX2Nsb25lRGVlcDIoKTsKICAgIHZhciBnZXQ1ID0gcmVxdWlyZV9nZXQoKTsKICAgIHZhciBoYXMzID0gcmVxdWlyZV9oYXMoKTsKICAgIGZ1bmN0aW9uIG1hdGNoZXNQcm9wZXJ0eShwcm9wZXJ0eSwgc291cmNlKSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIHByb3BlcnR5KSB7CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgaWYgKE9iamVjdC5pcyhwcm9wZXJ0eT8udmFsdWVPZigpLCAtMCkpIHsKICAgICAgICAgICAgcHJvcGVydHkgPSAiLTAiOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNhc2UgIm51bWJlciI6IHsKICAgICAgICAgIHByb3BlcnR5ID0gdG9LZXkudG9LZXkocHJvcGVydHkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHNvdXJjZSA9IGNsb25lRGVlcC5jbG9uZURlZXAoc291cmNlKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRhcmdldCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IGdldDUuZ2V0KHRhcmdldCwgcHJvcGVydHkpOwogICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIGhhczMuaGFzKHRhcmdldCwgcHJvcGVydHkpOwogICAgICAgIH0KICAgICAgICBpZiAoc291cmNlID09PSB2b2lkIDApIHsKICAgICAgICAgIHJldHVybiByZXN1bHQgPT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzTWF0Y2guaXNNYXRjaChyZXN1bHQsIHNvdXJjZSk7CiAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLm1hdGNoZXNQcm9wZXJ0eSA9IG1hdGNoZXNQcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9pdGVyYXRlZS5qcwp2YXIgcmVxdWlyZV9pdGVyYXRlZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL2l0ZXJhdGVlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpZGVudGl0eTQgPSByZXF1aXJlX2lkZW50aXR5KCk7CiAgICB2YXIgcHJvcGVydHkgPSByZXF1aXJlX3Byb3BlcnR5KCk7CiAgICB2YXIgbWF0Y2hlczIgPSByZXF1aXJlX21hdGNoZXMoKTsKICAgIHZhciBtYXRjaGVzUHJvcGVydHkgPSByZXF1aXJlX21hdGNoZXNQcm9wZXJ0eSgpOwogICAgZnVuY3Rpb24gaXRlcmF0ZWUodmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICByZXR1cm4gaWRlbnRpdHk0LmlkZW50aXR5OwogICAgICB9CiAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGNhc2UgIm9iamVjdCI6IHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXNQcm9wZXJ0eS5tYXRjaGVzUHJvcGVydHkodmFsdWVbMF0sIHZhbHVlWzFdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaGVzMi5tYXRjaGVzKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICBjYXNlICJzeW1ib2wiOgogICAgICAgIGNhc2UgIm51bWJlciI6IHsKICAgICAgICAgIHJldHVybiBwcm9wZXJ0eS5wcm9wZXJ0eSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLml0ZXJhdGVlID0gaXRlcmF0ZWU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3VuaXFCeS5qcwp2YXIgcmVxdWlyZV91bmlxQnkyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3VuaXFCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgdW5pcUJ5JDEgPSByZXF1aXJlX3VuaXFCeSgpOwogICAgdmFyIGlkZW50aXR5NCA9IHJlcXVpcmVfaWRlbnRpdHkoKTsKICAgIHZhciBpc0FycmF5TGlrZU9iamVjdCA9IHJlcXVpcmVfaXNBcnJheUxpa2VPYmplY3QoKTsKICAgIHZhciBpdGVyYXRlZSA9IHJlcXVpcmVfaXRlcmF0ZWUoKTsKICAgIGZ1bmN0aW9uIHVuaXFCeTIoYXJyYXksIGl0ZXJhdGVlJDEgPSBpZGVudGl0eTQuaWRlbnRpdHkpIHsKICAgICAgaWYgKCFpc0FycmF5TGlrZU9iamVjdC5pc0FycmF5TGlrZU9iamVjdChhcnJheSkpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgcmV0dXJuIHVuaXFCeSQxLnVuaXFCeShBcnJheS5mcm9tKGFycmF5KSwgaXRlcmF0ZWUuaXRlcmF0ZWUoaXRlcmF0ZWUkMSkpOwogICAgfQogICAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnkyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdW5pcUJ5LmpzCnZhciByZXF1aXJlX3VuaXFCeTMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3VuaXFCeS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfdW5pcUJ5MigpLnVuaXFCeTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3NoaW1fZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICAoZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIGlzNCh4MiwgeTIpIHsKICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICgwICE9PSB4MiB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQyKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpIHsKICAgICAgICBkaWRXYXJuT2xkMThBbHBoYSB8fCB2b2lkIDAgPT09IFJlYWN0Mzkuc3RhcnRUcmFuc2l0aW9uIHx8IChkaWRXYXJuT2xkMThBbHBoYSA9IHRydWUsIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAiWW91IGFyZSB1c2luZyBhbiBvdXRkYXRlZCwgcHJlLXJlbGVhc2UgYWxwaGEgb2YgUmVhY3QgMTggdGhhdCBkb2VzIG5vdCBzdXBwb3J0IHVzZVN5bmNFeHRlcm5hbFN0b3JlLiBUaGUgdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUgc2hpbSB3aWxsIG5vdCB3b3JrIGNvcnJlY3RseS4gVXBncmFkZSB0byBhIG5ld2VyIHByZS1yZWxlYXNlLiIKICAgICAgICApKTsKICAgICAgICB2YXIgdmFsdWUgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgIHZhciBjYWNoZWRWYWx1ZSA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICBvYmplY3RJcyh2YWx1ZSwgY2FjaGVkVmFsdWUpIHx8IChjb25zb2xlLmVycm9yKAogICAgICAgICAgICAiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiCiAgICAgICAgICApLCBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWUpOwogICAgICAgIH0KICAgICAgICBjYWNoZWRWYWx1ZSA9IHVzZVN0YXRlMTIoewogICAgICAgICAgaW5zdDogeyB2YWx1ZSwgZ2V0U25hcHNob3QgfQogICAgICAgIH0pOwogICAgICAgIHZhciBpbnN0ID0gY2FjaGVkVmFsdWVbMF0uaW5zdCwgZm9yY2VVcGRhdGUgPSBjYWNoZWRWYWx1ZVsxXTsKICAgICAgICB1c2VMYXlvdXRFZmZlY3Q5KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgaW5zdC5nZXRTbmFwc2hvdCA9IGdldFNuYXBzaG90OwogICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBbc3Vic2NyaWJlLCB2YWx1ZSwgZ2V0U25hcHNob3RdCiAgICAgICAgKTsKICAgICAgICB1c2VFZmZlY3QxNSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgICAgcmV0dXJuIHN1YnNjcmliZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgW3N1YnNjcmliZV0KICAgICAgICApOwogICAgICAgIHVzZURlYnVnVmFsdWUyKHZhbHVlKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSB7CiAgICAgICAgdmFyIGxhdGVzdEdldFNuYXBzaG90ID0gaW5zdC5nZXRTbmFwc2hvdDsKICAgICAgICBpbnN0ID0gaW5zdC52YWx1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGxhdGVzdEdldFNuYXBzaG90KCk7CiAgICAgICAgICByZXR1cm4gIW9iamVjdElzKGluc3QsIG5leHRWYWx1ZSk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQxKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpIHsKICAgICAgICByZXR1cm4gZ2V0U25hcHNob3QoKTsKICAgICAgfQogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KEVycm9yKCkpOwogICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTdGF0ZTEyID0gUmVhY3QzOS51c2VTdGF0ZSwgdXNlRWZmZWN0MTUgPSBSZWFjdDM5LnVzZUVmZmVjdCwgdXNlTGF5b3V0RWZmZWN0OSA9IFJlYWN0MzkudXNlTGF5b3V0RWZmZWN0LCB1c2VEZWJ1Z1ZhbHVlMiA9IFJlYWN0MzkudXNlRGVidWdWYWx1ZSwgZGlkV2Fybk9sZDE4QWxwaGEgPSBmYWxzZSwgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSBmYWxzZSwgc2hpbSA9ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93IHx8ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93LmRvY3VtZW50IHx8ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgPyB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQxIDogdXNlU3luY0V4dGVybmFsU3RvcmUkMjsKICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHZvaWQgMCAhPT0gUmVhY3QzOS51c2VTeW5jRXh0ZXJuYWxTdG9yZSA/IFJlYWN0MzkudXNlU3luY0V4dGVybmFsU3RvcmUgOiBzaGltOwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL2luZGV4LmpzCnZhciByZXF1aXJlX3NoaW0gPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV91c2Vfc3luY19leHRlcm5hbF9zdG9yZV9zaGltX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIChmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKDAgIT09IHgyIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICB9CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQoRXJyb3IoKSk7CiAgICAgIHZhciBSZWFjdDM5ID0gcmVxdWlyZV9yZWFjdCgpLCBzaGltID0gcmVxdWlyZV9zaGltKCksIG9iamVjdElzID0gImZ1bmN0aW9uIiA9PT0gdHlwZW9mIE9iamVjdC5pcyA/IE9iamVjdC5pcyA6IGlzNCwgdXNlU3luY0V4dGVybmFsU3RvcmUyID0gc2hpbS51c2VTeW5jRXh0ZXJuYWxTdG9yZSwgdXNlUmVmMTUgPSBSZWFjdDM5LnVzZVJlZiwgdXNlRWZmZWN0MTUgPSBSZWFjdDM5LnVzZUVmZmVjdCwgdXNlTWVtbzggPSBSZWFjdDM5LnVzZU1lbW8sIHVzZURlYnVnVmFsdWUyID0gUmVhY3QzOS51c2VEZWJ1Z1ZhbHVlOwogICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlV2l0aFNlbGVjdG9yID0gZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsKSB7CiAgICAgICAgdmFyIGluc3RSZWYgPSB1c2VSZWYxNShudWxsKTsKICAgICAgICBpZiAobnVsbCA9PT0gaW5zdFJlZi5jdXJyZW50KSB7CiAgICAgICAgICB2YXIgaW5zdCA9IHsgaGFzVmFsdWU6IGZhbHNlLCB2YWx1ZTogbnVsbCB9OwogICAgICAgICAgaW5zdFJlZi5jdXJyZW50ID0gaW5zdDsKICAgICAgICB9IGVsc2UgaW5zdCA9IGluc3RSZWYuY3VycmVudDsKICAgICAgICBpbnN0UmVmID0gdXNlTWVtbzgoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZnVuY3Rpb24gbWVtb2l6ZWRTZWxlY3RvcihuZXh0U25hcHNob3QpIHsKICAgICAgICAgICAgICBpZiAoIWhhc01lbW8pIHsKICAgICAgICAgICAgICAgIGhhc01lbW8gPSB0cnVlOwogICAgICAgICAgICAgICAgbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IHNlbGVjdG9yKG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGluc3QuaGFzVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTZWxlY3Rpb24gPSBpbnN0LnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAoaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRTZWxlY3Rpb24gPSBtZW1vaXplZFNlbGVjdGlvbjsKICAgICAgICAgICAgICBpZiAob2JqZWN0SXMobWVtb2l6ZWRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KSkKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIHZhciBuZXh0U2VsZWN0aW9uID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGlzRXF1YWwoY3VycmVudFNlbGVjdGlvbiwgbmV4dFNlbGVjdGlvbikpCiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdCwgY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTZWxlY3Rpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc01lbW8gPSBmYWxzZSwgbWVtb2l6ZWRTbmFwc2hvdCwgbWVtb2l6ZWRTZWxlY3Rpb24sIG1heWJlR2V0U2VydmVyU25hcHNob3QgPSB2b2lkIDAgPT09IGdldFNlcnZlclNuYXBzaG90ID8gbnVsbCA6IGdldFNlcnZlclNuYXBzaG90OwogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0b3IoZ2V0U25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBudWxsID09PSBtYXliZUdldFNlcnZlclNuYXBzaG90ID8gdm9pZCAwIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihtYXliZUdldFNlcnZlclNuYXBzaG90KCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgXTsKICAgICAgICAgIH0sCiAgICAgICAgICBbZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90LCBzZWxlY3RvciwgaXNFcXVhbF0KICAgICAgICApOwogICAgICAgIHZhciB2YWx1ZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMihzdWJzY3JpYmUsIGluc3RSZWZbMF0sIGluc3RSZWZbMV0pOwogICAgICAgIHVzZUVmZmVjdDE1KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGluc3QuaGFzVmFsdWUgPSB0cnVlOwogICAgICAgICAgICBpbnN0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9LAogICAgICAgICAgW3ZhbHVlXQogICAgICAgICk7CiAgICAgICAgdXNlRGVidWdWYWx1ZTIodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfTsKICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AoRXJyb3IoKSk7CiAgICB9KSgpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvc2hpbS93aXRoLXNlbGVjdG9yLmpzCnZhciByZXF1aXJlX3dpdGhfc2VsZWN0b3IgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vd2l0aC1zZWxlY3Rvci5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2NvbXBhcmVWYWx1ZXMuanMKdmFyIHJlcXVpcmVfY29tcGFyZVZhbHVlcyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvY29tcGFyZVZhbHVlcy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRQcmlvcml0eShhKSB7CiAgICAgIGlmICh0eXBlb2YgYSA9PT0gInN5bWJvbCIpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBpZiAoYSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiAyOwogICAgICB9CiAgICAgIGlmIChhID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gMzsKICAgICAgfQogICAgICBpZiAoYSAhPT0gYSkgewogICAgICAgIHJldHVybiA0OwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfQogICAgdmFyIGNvbXBhcmVWYWx1ZXMgPSAoYSwgYiwgb3JkZXIpID0+IHsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBjb25zdCBhUHJpb3JpdHkgPSBnZXRQcmlvcml0eShhKTsKICAgICAgICBjb25zdCBiUHJpb3JpdHkgPSBnZXRQcmlvcml0eShiKTsKICAgICAgICBpZiAoYVByaW9yaXR5ID09PSBiUHJpb3JpdHkgJiYgYVByaW9yaXR5ID09PSAwKSB7CiAgICAgICAgICBpZiAoYSA8IGIpIHsKICAgICAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyAxIDogLTE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYSA+IGIpIHsKICAgICAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyAtMSA6IDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvcmRlciA9PT0gImRlc2MiID8gYlByaW9yaXR5IC0gYVByaW9yaXR5IDogYVByaW9yaXR5IC0gYlByaW9yaXR5OwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfTsKICAgIGV4cG9ydHMuY29tcGFyZVZhbHVlcyA9IGNvbXBhcmVWYWx1ZXM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc1N5bWJvbC5qcwp2YXIgcmVxdWlyZV9pc1N5bWJvbCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNTeW1ib2wuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNTeW1ib2wodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gInN5bWJvbCIgfHwgdmFsdWUgaW5zdGFuY2VvZiBTeW1ib2w7CiAgICB9CiAgICBleHBvcnRzLmlzU3ltYm9sID0gaXNTeW1ib2w7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0tleS5qcwp2YXIgcmVxdWlyZV9pc0tleSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNLZXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzU3ltYm9sID0gcmVxdWlyZV9pc1N5bWJvbCgpOwogICAgdmFyIHJlZ2V4SXNEZWVwUHJvcCA9IC9cLnxcWyg/OlteW1xdXSp8KFsiJ10pKD86KD8hXDEpW15cXF18XFwuKSo/XDEpXF0vOwogICAgdmFyIHJlZ2V4SXNQbGFpblByb3AgPSAvXlx3KiQvOwogICAgZnVuY3Rpb24gaXNLZXkodmFsdWUsIG9iamVjdCkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT0gbnVsbCB8fCBpc1N5bWJvbC5pc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAocmVnZXhJc1BsYWluUHJvcC50ZXN0KHZhbHVlKSB8fCAhcmVnZXhJc0RlZXBQcm9wLnRlc3QodmFsdWUpKSB8fCBvYmplY3QgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duKG9iamVjdCwgdmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5pc0tleSA9IGlzS2V5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9vcmRlckJ5LmpzCnZhciByZXF1aXJlX29yZGVyQnkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvb3JkZXJCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY29tcGFyZVZhbHVlcyA9IHJlcXVpcmVfY29tcGFyZVZhbHVlcygpOwogICAgdmFyIGlzS2V5ID0gcmVxdWlyZV9pc0tleSgpOwogICAgdmFyIHRvUGF0aCA9IHJlcXVpcmVfdG9QYXRoKCk7CiAgICBmdW5jdGlvbiBvcmRlckJ5KGNvbGxlY3Rpb24sIGNyaXRlcmlhLCBvcmRlcnMsIGd1YXJkKSB7CiAgICAgIGlmIChjb2xsZWN0aW9uID09IG51bGwpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgb3JkZXJzID0gZ3VhcmQgPyB2b2lkIDAgOiBvcmRlcnM7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIGNvbGxlY3Rpb24gPSBPYmplY3QudmFsdWVzKGNvbGxlY3Rpb24pOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShjcml0ZXJpYSkpIHsKICAgICAgICBjcml0ZXJpYSA9IGNyaXRlcmlhID09IG51bGwgPyBbbnVsbF0gOiBbY3JpdGVyaWFdOwogICAgICB9CiAgICAgIGlmIChjcml0ZXJpYS5sZW5ndGggPT09IDApIHsKICAgICAgICBjcml0ZXJpYSA9IFtudWxsXTsKICAgICAgfQogICAgICBpZiAoIUFycmF5LmlzQXJyYXkob3JkZXJzKSkgewogICAgICAgIG9yZGVycyA9IG9yZGVycyA9PSBudWxsID8gW10gOiBbb3JkZXJzXTsKICAgICAgfQogICAgICBvcmRlcnMgPSBvcmRlcnMubWFwKChvcmRlcikgPT4gU3RyaW5nKG9yZGVyKSk7CiAgICAgIGNvbnN0IGdldFZhbHVlQnlOZXN0ZWRQYXRoID0gKG9iamVjdCwgcGF0aDIpID0+IHsKICAgICAgICBsZXQgdGFyZ2V0ID0gb2JqZWN0OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aDIubGVuZ3RoICYmIHRhcmdldCAhPSBudWxsOyArK2kpIHsKICAgICAgICAgIHRhcmdldCA9IHRhcmdldFtwYXRoMltpXV07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH07CiAgICAgIGNvbnN0IGdldFZhbHVlQnlDcml0ZXJpb24gPSAoY3JpdGVyaW9uLCBvYmplY3QpID0+IHsKICAgICAgICBpZiAob2JqZWN0ID09IG51bGwgfHwgY3JpdGVyaW9uID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY3JpdGVyaW9uID09PSAib2JqZWN0IiAmJiAia2V5IiBpbiBjcml0ZXJpb24pIHsKICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duKG9iamVjdCwgY3JpdGVyaW9uLmtleSkpIHsKICAgICAgICAgICAgcmV0dXJuIG9iamVjdFtjcml0ZXJpb24ua2V5XTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRWYWx1ZUJ5TmVzdGVkUGF0aChvYmplY3QsIGNyaXRlcmlvbi5wYXRoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjcml0ZXJpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHJldHVybiBjcml0ZXJpb24ob2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSkgewogICAgICAgICAgcmV0dXJuIGdldFZhbHVlQnlOZXN0ZWRQYXRoKG9iamVjdCwgY3JpdGVyaW9uKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0W2NyaXRlcmlvbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH07CiAgICAgIGNvbnN0IHByZXBhcmVkQ3JpdGVyaWEgPSBjcml0ZXJpYS5tYXAoKGNyaXRlcmlvbikgPT4gewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNyaXRlcmlvbikgJiYgY3JpdGVyaW9uLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgY3JpdGVyaW9uID0gY3JpdGVyaW9uWzBdOwogICAgICAgIH0KICAgICAgICBpZiAoY3JpdGVyaW9uID09IG51bGwgfHwgdHlwZW9mIGNyaXRlcmlvbiA9PT0gImZ1bmN0aW9uIiB8fCBBcnJheS5pc0FycmF5KGNyaXRlcmlvbikgfHwgaXNLZXkuaXNLZXkoY3JpdGVyaW9uKSkgewogICAgICAgICAgcmV0dXJuIGNyaXRlcmlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsga2V5OiBjcml0ZXJpb24sIHBhdGg6IHRvUGF0aC50b1BhdGgoY3JpdGVyaW9uKSB9OwogICAgICB9KTsKICAgICAgY29uc3QgcHJlcGFyZWRDb2xsZWN0aW9uID0gY29sbGVjdGlvbi5tYXAoKGl0ZW0pID0+ICh7CiAgICAgICAgb3JpZ2luYWw6IGl0ZW0sCiAgICAgICAgY3JpdGVyaWE6IHByZXBhcmVkQ3JpdGVyaWEubWFwKChjcml0ZXJpb24pID0+IGdldFZhbHVlQnlDcml0ZXJpb24oY3JpdGVyaW9uLCBpdGVtKSkKICAgICAgfSkpOwogICAgICByZXR1cm4gcHJlcGFyZWRDb2xsZWN0aW9uLnNsaWNlKCkuc29ydCgoYSwgYikgPT4gewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJlcGFyZWRDcml0ZXJpYS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgY29tcGFyZWRSZXN1bHQgPSBjb21wYXJlVmFsdWVzLmNvbXBhcmVWYWx1ZXMoYS5jcml0ZXJpYVtpXSwgYi5jcml0ZXJpYVtpXSwgb3JkZXJzW2ldKTsKICAgICAgICAgIGlmIChjb21wYXJlZFJlc3VsdCAhPT0gMCkgewogICAgICAgICAgICByZXR1cm4gY29tcGFyZWRSZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9KS5tYXAoKGl0ZW0pID0+IGl0ZW0ub3JpZ2luYWwpOwogICAgfQogICAgZXhwb3J0cy5vcmRlckJ5ID0gb3JkZXJCeTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS9mbGF0dGVuLmpzCnZhciByZXF1aXJlX2ZsYXR0ZW4gPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS9mbGF0dGVuLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGZsYXR0ZW4oYXJyLCBkZXB0aCA9IDEpIHsKICAgICAgY29uc3QgcmVzdWx0ID0gW107CiAgICAgIGNvbnN0IGZsb29yZWREZXB0aCA9IE1hdGguZmxvb3IoZGVwdGgpOwogICAgICBjb25zdCByZWN1cnNpdmUgPSAoYXJyMiwgY3VycmVudERlcHRoKSA9PiB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBpdGVtID0gYXJyMltpXTsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZW0pICYmIGN1cnJlbnREZXB0aCA8IGZsb29yZWREZXB0aCkgewogICAgICAgICAgICByZWN1cnNpdmUoaXRlbSwgY3VycmVudERlcHRoICsgMSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIHJlY3Vyc2l2ZShhcnIsIDApOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5mbGF0dGVuID0gZmxhdHRlbjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzSXRlcmF0ZWVDYWxsLmpzCnZhciByZXF1aXJlX2lzSXRlcmF0ZWVDYWxsID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0l0ZXJhdGVlQ2FsbC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNJbmRleCA9IHJlcXVpcmVfaXNJbmRleCgpOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgdmFyIGlzT2JqZWN0ID0gcmVxdWlyZV9pc09iamVjdCgpOwogICAgdmFyIGVxID0gcmVxdWlyZV9lcSgpOwogICAgZnVuY3Rpb24gaXNJdGVyYXRlZUNhbGwodmFsdWUsIGluZGV4LCBvYmplY3QpIHsKICAgICAgaWYgKCFpc09iamVjdC5pc09iamVjdChvYmplY3QpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgaW5kZXggPT09ICJudW1iZXIiICYmIGlzQXJyYXlMaWtlLmlzQXJyYXlMaWtlKG9iamVjdCkgJiYgaXNJbmRleC5pc0luZGV4KGluZGV4KSAmJiBpbmRleCA8IG9iamVjdC5sZW5ndGggfHwgdHlwZW9mIGluZGV4ID09PSAic3RyaW5nIiAmJiBpbmRleCBpbiBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZXEuZXEob2JqZWN0W2luZGV4XSwgdmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGV4cG9ydHMuaXNJdGVyYXRlZUNhbGwgPSBpc0l0ZXJhdGVlQ2FsbDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvc29ydEJ5LmpzCnZhciByZXF1aXJlX3NvcnRCeSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9zb3J0QnkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIG9yZGVyQnkgPSByZXF1aXJlX29yZGVyQnkoKTsKICAgIHZhciBmbGF0dGVuID0gcmVxdWlyZV9mbGF0dGVuKCk7CiAgICB2YXIgaXNJdGVyYXRlZUNhbGwgPSByZXF1aXJlX2lzSXRlcmF0ZWVDYWxsKCk7CiAgICBmdW5jdGlvbiBzb3J0Qnk1KGNvbGxlY3Rpb24sIC4uLmNyaXRlcmlhKSB7CiAgICAgIGNvbnN0IGxlbmd0aCA9IGNyaXRlcmlhLmxlbmd0aDsKICAgICAgaWYgKGxlbmd0aCA+IDEgJiYgaXNJdGVyYXRlZUNhbGwuaXNJdGVyYXRlZUNhbGwoY29sbGVjdGlvbiwgY3JpdGVyaWFbMF0sIGNyaXRlcmlhWzFdKSkgewogICAgICAgIGNyaXRlcmlhID0gW107CiAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID4gMiAmJiBpc0l0ZXJhdGVlQ2FsbC5pc0l0ZXJhdGVlQ2FsbChjcml0ZXJpYVswXSwgY3JpdGVyaWFbMV0sIGNyaXRlcmlhWzJdKSkgewogICAgICAgIGNyaXRlcmlhID0gW2NyaXRlcmlhWzBdXTsKICAgICAgfQogICAgICByZXR1cm4gb3JkZXJCeS5vcmRlckJ5KGNvbGxlY3Rpb24sIGZsYXR0ZW4uZmxhdHRlbihjcml0ZXJpYSksIFsiYXNjIl0pOwogICAgfQogICAgZXhwb3J0cy5zb3J0QnkgPSBzb3J0Qnk1OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvc29ydEJ5LmpzCnZhciByZXF1aXJlX3NvcnRCeTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3NvcnRCeS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfc29ydEJ5KCkuc29ydEJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2Z1bmN0aW9uL2RlYm91bmNlLmpzCnZhciByZXF1aXJlX2RlYm91bmNlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vZGVib3VuY2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgZGVib3VuY2VNcywgeyBzaWduYWwsIGVkZ2VzIH0gPSB7fSkgewogICAgICBsZXQgcGVuZGluZ1RoaXMgPSB2b2lkIDA7CiAgICAgIGxldCBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgIGNvbnN0IGxlYWRpbmcgPSBlZGdlcyAhPSBudWxsICYmIGVkZ2VzLmluY2x1ZGVzKCJsZWFkaW5nIik7CiAgICAgIGNvbnN0IHRyYWlsaW5nID0gZWRnZXMgPT0gbnVsbCB8fCBlZGdlcy5pbmNsdWRlcygidHJhaWxpbmciKTsKICAgICAgY29uc3QgaW52b2tlID0gKCkgPT4gewogICAgICAgIGlmIChwZW5kaW5nQXJncyAhPT0gbnVsbCkgewogICAgICAgICAgZnVuYy5hcHBseShwZW5kaW5nVGhpcywgcGVuZGluZ0FyZ3MpOwogICAgICAgICAgcGVuZGluZ1RoaXMgPSB2b2lkIDA7CiAgICAgICAgICBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBvblRpbWVyRW5kID0gKCkgPT4gewogICAgICAgIGlmICh0cmFpbGluZykgewogICAgICAgICAgaW52b2tlKCk7CiAgICAgICAgfQogICAgICAgIGNhbmNlbCgpOwogICAgICB9OwogICAgICBsZXQgdGltZW91dElkID0gbnVsbDsKICAgICAgY29uc3Qgc2NoZWR1bGUgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRpbWVvdXRJZCAhPSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICB9CiAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICAgICAgb25UaW1lckVuZCgpOwogICAgICAgIH0sIGRlYm91bmNlTXMpOwogICAgICB9OwogICAgICBjb25zdCBjYW5jZWxUaW1lciA9ICgpID0+IHsKICAgICAgICBpZiAodGltZW91dElkICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICAgIHRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBjYW5jZWwgPSAoKSA9PiB7CiAgICAgICAgY2FuY2VsVGltZXIoKTsKICAgICAgICBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgICBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgIH07CiAgICAgIGNvbnN0IGZsdXNoID0gKCkgPT4gewogICAgICAgIGludm9rZSgpOwogICAgICB9OwogICAgICBjb25zdCBkZWJvdW5jZWQgPSBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgaWYgKHNpZ25hbD8uYWJvcnRlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBwZW5kaW5nVGhpcyA9IHRoaXM7CiAgICAgICAgcGVuZGluZ0FyZ3MgPSBhcmdzOwogICAgICAgIGNvbnN0IGlzRmlyc3RDYWxsID0gdGltZW91dElkID09IG51bGw7CiAgICAgICAgc2NoZWR1bGUoKTsKICAgICAgICBpZiAobGVhZGluZyAmJiBpc0ZpcnN0Q2FsbCkgewogICAgICAgICAgaW52b2tlKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBkZWJvdW5jZWQuc2NoZWR1bGUgPSBzY2hlZHVsZTsKICAgICAgZGVib3VuY2VkLmNhbmNlbCA9IGNhbmNlbDsKICAgICAgZGVib3VuY2VkLmZsdXNoID0gZmx1c2g7CiAgICAgIHNpZ25hbD8uYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBjYW5jZWwsIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vZGVib3VuY2UuanMKdmFyIHJlcXVpcmVfZGVib3VuY2UyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2Z1bmN0aW9uL2RlYm91bmNlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBkZWJvdW5jZSQxID0gcmVxdWlyZV9kZWJvdW5jZSgpOwogICAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgZGVib3VuY2VNcyA9IDAsIG9wdGlvbnMgPSB7fSkgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CiAgICAgIGNvbnN0IHsgbGVhZGluZyA9IGZhbHNlLCB0cmFpbGluZyA9IHRydWUsIG1heFdhaXQgfSA9IG9wdGlvbnM7CiAgICAgIGNvbnN0IGVkZ2VzID0gQXJyYXkoMik7CiAgICAgIGlmIChsZWFkaW5nKSB7CiAgICAgICAgZWRnZXNbMF0gPSAibGVhZGluZyI7CiAgICAgIH0KICAgICAgaWYgKHRyYWlsaW5nKSB7CiAgICAgICAgZWRnZXNbMV0gPSAidHJhaWxpbmciOwogICAgICB9CiAgICAgIGxldCByZXN1bHQgPSB2b2lkIDA7CiAgICAgIGxldCBwZW5kaW5nQXQgPSBudWxsOwogICAgICBjb25zdCBfZGVib3VuY2VkID0gZGVib3VuY2UkMS5kZWJvdW5jZShmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICBwZW5kaW5nQXQgPSBudWxsOwogICAgICB9LCBkZWJvdW5jZU1zLCB7IGVkZ2VzIH0pOwogICAgICBjb25zdCBkZWJvdW5jZWQgPSBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgaWYgKG1heFdhaXQgIT0gbnVsbCkgewogICAgICAgICAgaWYgKHBlbmRpbmdBdCA9PT0gbnVsbCkgewogICAgICAgICAgICBwZW5kaW5nQXQgPSBEYXRlLm5vdygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKERhdGUubm93KCkgLSBwZW5kaW5nQXQgPj0gbWF4V2FpdCkgewogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICBwZW5kaW5nQXQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBfZGVib3VuY2VkLmNhbmNlbCgpOwogICAgICAgICAgICBfZGVib3VuY2VkLnNjaGVkdWxlKCk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIF9kZWJvdW5jZWQuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgY29uc3QgZmx1c2ggPSAoKSA9PiB7CiAgICAgICAgX2RlYm91bmNlZC5mbHVzaCgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGRlYm91bmNlZC5jYW5jZWwgPSBfZGVib3VuY2VkLmNhbmNlbDsKICAgICAgZGVib3VuY2VkLmZsdXNoID0gZmx1c2g7CiAgICAgIHJldHVybiBkZWJvdW5jZWQ7CiAgICB9CiAgICBleHBvcnRzLmRlYm91bmNlID0gZGVib3VuY2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2Z1bmN0aW9uL3Rocm90dGxlLmpzCnZhciByZXF1aXJlX3Rocm90dGxlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2Z1bmN0aW9uL3Rocm90dGxlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBkZWJvdW5jZSA9IHJlcXVpcmVfZGVib3VuY2UyKCk7CiAgICBmdW5jdGlvbiB0aHJvdHRsZTIoZnVuYywgdGhyb3R0bGVNcyA9IDAsIG9wdGlvbnMgPSB7fSkgewogICAgICBjb25zdCB7IGxlYWRpbmcgPSB0cnVlLCB0cmFpbGluZyA9IHRydWUgfSA9IG9wdGlvbnM7CiAgICAgIHJldHVybiBkZWJvdW5jZS5kZWJvdW5jZShmdW5jLCB0aHJvdHRsZU1zLCB7CiAgICAgICAgbGVhZGluZywKICAgICAgICBtYXhXYWl0OiB0aHJvdHRsZU1zLAogICAgICAgIHRyYWlsaW5nCiAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy50aHJvdHRsZSA9IHRocm90dGxlMjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3Rocm90dGxlLmpzCnZhciByZXF1aXJlX3Rocm90dGxlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdGhyb3R0bGUuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3Rocm90dGxlKCkudGhyb3R0bGU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9OdW1iZXIuanMKdmFyIHJlcXVpcmVfdG9OdW1iZXIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b051bWJlci5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNTeW1ib2wgPSByZXF1aXJlX2lzU3ltYm9sKCk7CiAgICBmdW5jdGlvbiB0b051bWJlcih2YWx1ZSkgewogICAgICBpZiAoaXNTeW1ib2wuaXNTeW1ib2wodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIE5hTjsKICAgICAgfQogICAgICByZXR1cm4gTnVtYmVyKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9OdW1iZXIgPSB0b051bWJlcjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b0Zpbml0ZS5qcwp2YXIgcmVxdWlyZV90b0Zpbml0ZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvRmluaXRlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciB0b051bWJlciA9IHJlcXVpcmVfdG9OdW1iZXIoKTsKICAgIGZ1bmN0aW9uIHRvRmluaXRlKHZhbHVlKSB7CiAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09IDAgPyB2YWx1ZSA6IDA7CiAgICAgIH0KICAgICAgdmFsdWUgPSB0b051bWJlci50b051bWJlcih2YWx1ZSk7CiAgICAgIGlmICh2YWx1ZSA9PT0gSW5maW5pdHkgfHwgdmFsdWUgPT09IC1JbmZpbml0eSkgewogICAgICAgIGNvbnN0IHNpZ24yID0gdmFsdWUgPCAwID8gLTEgOiAxOwogICAgICAgIHJldHVybiBzaWduMiAqIE51bWJlci5NQVhfVkFMVUU7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlID09PSB2YWx1ZSA/IHZhbHVlIDogMDsKICAgIH0KICAgIGV4cG9ydHMudG9GaW5pdGUgPSB0b0Zpbml0ZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvbWF0aC9yYW5nZS5qcwp2YXIgcmVxdWlyZV9yYW5nZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9tYXRoL3JhbmdlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc0l0ZXJhdGVlQ2FsbCA9IHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwoKTsKICAgIHZhciB0b0Zpbml0ZSA9IHJlcXVpcmVfdG9GaW5pdGUoKTsKICAgIGZ1bmN0aW9uIHJhbmdlNChzdGFydCwgZW5kLCBzdGVwKSB7CiAgICAgIGlmIChzdGVwICYmIHR5cGVvZiBzdGVwICE9PSAibnVtYmVyIiAmJiBpc0l0ZXJhdGVlQ2FsbC5pc0l0ZXJhdGVlQ2FsbChzdGFydCwgZW5kLCBzdGVwKSkgewogICAgICAgIGVuZCA9IHN0ZXAgPSB2b2lkIDA7CiAgICAgIH0KICAgICAgc3RhcnQgPSB0b0Zpbml0ZS50b0Zpbml0ZShzdGFydCk7CiAgICAgIGlmIChlbmQgPT09IHZvaWQgMCkgewogICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgIHN0YXJ0ID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmQgPSB0b0Zpbml0ZS50b0Zpbml0ZShlbmQpOwogICAgICB9CiAgICAgIHN0ZXAgPSBzdGVwID09PSB2b2lkIDAgPyBzdGFydCA8IGVuZCA/IDEgOiAtMSA6IHRvRmluaXRlLnRvRmluaXRlKHN0ZXApOwogICAgICBjb25zdCBsZW5ndGggPSBNYXRoLm1heChNYXRoLmNlaWwoKGVuZCAtIHN0YXJ0KSAvIChzdGVwIHx8IDEpKSwgMCk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IHN0YXJ0OwogICAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMucmFuZ2UgPSByYW5nZTQ7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9yYW5nZS5qcwp2YXIgcmVxdWlyZV9yYW5nZTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yYW5nZSgpLnJhbmdlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzCnZhciByZXF1aXJlX2RlY2ltYWwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2RlY2ltYWwuanMtbGlnaHQvZGVjaW1hbC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAoZnVuY3Rpb24oZ2xvYmFsU2NvcGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgTUFYX0RJR0lUUyA9IDFlOSwgRGVjaW1hbDMgPSB7CiAgICAgICAgLy8gVGhlc2UgdmFsdWVzIG11c3QgYmUgaW50ZWdlcnMgd2l0aGluIHRoZSBzdGF0ZWQgcmFuZ2VzIChpbmNsdXNpdmUpLgogICAgICAgIC8vIE1vc3Qgb2YgdGhlc2UgdmFsdWVzIGNhbiBiZSBjaGFuZ2VkIGR1cmluZyBydW4tdGltZSB1c2luZyBgRGVjaW1hbC5jb25maWdgLgogICAgICAgIC8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBzaWduaWZpY2FudCBkaWdpdHMgb2YgdGhlIHJlc3VsdCBvZiBhIGNhbGN1bGF0aW9uIG9yIGJhc2UgY29udmVyc2lvbi4KICAgICAgICAvLyBFLmcuIGBEZWNpbWFsLmNvbmZpZyh7IHByZWNpc2lvbjogMjAgfSk7YAogICAgICAgIHByZWNpc2lvbjogMjAsCiAgICAgICAgLy8gMSB0byBNQVhfRElHSVRTCiAgICAgICAgLy8gVGhlIHJvdW5kaW5nIG1vZGUgdXNlZCBieSBkZWZhdWx0IGJ5IGB0b0ludGVnZXJgLCBgdG9EZWNpbWFsUGxhY2VzYCwgYHRvRXhwb25lbnRpYWxgLAogICAgICAgIC8vIGB0b0ZpeGVkYCwgYHRvUHJlY2lzaW9uYCBhbmQgYHRvU2lnbmlmaWNhbnREaWdpdHNgLgogICAgICAgIC8vCiAgICAgICAgLy8gUk9VTkRfVVAgICAgICAgICAwIEF3YXkgZnJvbSB6ZXJvLgogICAgICAgIC8vIFJPVU5EX0RPV04gICAgICAgMSBUb3dhcmRzIHplcm8uCiAgICAgICAgLy8gUk9VTkRfQ0VJTCAgICAgICAyIFRvd2FyZHMgK0luZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0ZMT09SICAgICAgMyBUb3dhcmRzIC1JbmZpbml0eS4KICAgICAgICAvLyBST1VORF9IQUxGX1VQICAgIDQgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHVwLgogICAgICAgIC8vIFJPVU5EX0hBTEZfRE9XTiAgNSBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgZG93bi4KICAgICAgICAvLyBST1VORF9IQUxGX0VWRU4gIDYgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgZXZlbiBuZWlnaGJvdXIuCiAgICAgICAgLy8gUk9VTkRfSEFMRl9DRUlMICA3IFRvd2FyZHMgbmVhcmVzdCBuZWlnaGJvdXIuIElmIGVxdWlkaXN0YW50LCB0b3dhcmRzICtJbmZpbml0eS4KICAgICAgICAvLyBST1VORF9IQUxGX0ZMT09SIDggVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgLUluZmluaXR5LgogICAgICAgIC8vCiAgICAgICAgLy8gRS5nLgogICAgICAgIC8vIGBEZWNpbWFsLnJvdW5kaW5nID0gNDtgCiAgICAgICAgLy8gYERlY2ltYWwucm91bmRpbmcgPSBEZWNpbWFsLlJPVU5EX0hBTEZfVVA7YAogICAgICAgIHJvdW5kaW5nOiA0LAogICAgICAgIC8vIDAgdG8gOAogICAgICAgIC8vIFRoZSBleHBvbmVudCB2YWx1ZSBhdCBhbmQgYmVuZWF0aCB3aGljaCBgdG9TdHJpbmdgIHJldHVybnMgZXhwb25lbnRpYWwgbm90YXRpb24uCiAgICAgICAgLy8gSmF2YVNjcmlwdCBudW1iZXJzOiAtNwogICAgICAgIHRvRXhwTmVnOiAtNywKICAgICAgICAvLyAwIHRvIC1NQVhfRQogICAgICAgIC8vIFRoZSBleHBvbmVudCB2YWx1ZSBhdCBhbmQgYWJvdmUgd2hpY2ggYHRvU3RyaW5nYCByZXR1cm5zIGV4cG9uZW50aWFsIG5vdGF0aW9uLgogICAgICAgIC8vIEphdmFTY3JpcHQgbnVtYmVyczogMjEKICAgICAgICB0b0V4cFBvczogMjEsCiAgICAgICAgLy8gMCB0byBNQVhfRQogICAgICAgIC8vIFRoZSBuYXR1cmFsIGxvZ2FyaXRobSBvZiAxMC4KICAgICAgICAvLyAxMTUgZGlnaXRzCiAgICAgICAgTE4xMDogIjIuMzAyNTg1MDkyOTk0MDQ1Njg0MDE3OTkxNDU0Njg0MzY0MjA3NjAxMTAxNDg4NjI4NzcyOTc2MDMzMzI3OTAwOTY3NTcyNjA5Njc3MzUyNDgwMjM1OTk3MjA1MDg5NTk4Mjk4MzQxOTY3Nzg0MDQyMjg2IgogICAgICB9LCBleHRlcm5hbCA9IHRydWUsIGRlY2ltYWxFcnJvciA9ICJbRGVjaW1hbEVycm9yXSAiLCBpbnZhbGlkQXJndW1lbnQgPSBkZWNpbWFsRXJyb3IgKyAiSW52YWxpZCBhcmd1bWVudDogIiwgZXhwb25lbnRPdXRPZlJhbmdlID0gZGVjaW1hbEVycm9yICsgIkV4cG9uZW50IG91dCBvZiByYW5nZTogIiwgbWF0aGZsb29yID0gTWF0aC5mbG9vciwgbWF0aHBvdyA9IE1hdGgucG93LCBpc0RlY2ltYWwgPSAvXihcZCsoXC5cZCopP3xcLlxkKykoZVsrLV0/XGQrKT8kL2ksIE9ORSwgQkFTRSA9IDFlNywgTE9HX0JBU0UgPSA3LCBNQVhfU0FGRV9JTlRFR0VSID0gOTAwNzE5OTI1NDc0MDk5MSwgTUFYX0UgPSBtYXRoZmxvb3IoTUFYX1NBRkVfSU5URUdFUiAvIExPR19CQVNFKSwgUCA9IHt9OwogICAgICBQLmFic29sdXRlVmFsdWUgPSBQLmFicyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMpOwogICAgICAgIGlmICh4Mi5zKSB4Mi5zID0gMTsKICAgICAgICByZXR1cm4geDI7CiAgICAgIH07CiAgICAgIFAuY29tcGFyZWRUbyA9IFAuY21wID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgaSwgaiwgeGRMLCB5ZEwsIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgaWYgKHgyLnMgIT09IHkyLnMpIHJldHVybiB4Mi5zIHx8IC15Mi5zOwogICAgICAgIGlmICh4Mi5lICE9PSB5Mi5lKSByZXR1cm4geDIuZSA+IHkyLmUgXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgICB4ZEwgPSB4Mi5kLmxlbmd0aDsKICAgICAgICB5ZEwgPSB5Mi5kLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwLCBqID0geGRMIDwgeWRMID8geGRMIDogeWRMOyBpIDwgajsgKytpKSB7CiAgICAgICAgICBpZiAoeDIuZFtpXSAhPT0geTIuZFtpXSkgcmV0dXJuIHgyLmRbaV0gPiB5Mi5kW2ldIF4geDIucyA8IDAgPyAxIDogLTE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB4ZEwgPT09IHlkTCA/IDAgOiB4ZEwgPiB5ZEwgXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgfTsKICAgICAgUC5kZWNpbWFsUGxhY2VzID0gUC5kcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIHcgPSB4Mi5kLmxlbmd0aCAtIDEsIGRwID0gKHcgLSB4Mi5lKSAqIExPR19CQVNFOwogICAgICAgIHcgPSB4Mi5kW3ddOwogICAgICAgIGlmICh3KSBmb3IgKDsgdyAlIDEwID09IDA7IHcgLz0gMTApIGRwLS07CiAgICAgICAgcmV0dXJuIGRwIDwgMCA/IDAgOiBkcDsKICAgICAgfTsKICAgICAgUC5kaXZpZGVkQnkgPSBQLmRpdiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIGRpdmlkZSh0aGlzLCBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih5MikpOwogICAgICB9OwogICAgICBQLmRpdmlkZWRUb0ludGVnZXJCeSA9IFAuaWRpdiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiByb3VuZChkaXZpZGUoeDIsIG5ldyBDdG9yKHkyKSwgMCwgMSksIEN0b3IucHJlY2lzaW9uKTsKICAgICAgfTsKICAgICAgUC5lcXVhbHMgPSBQLmVxID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gIXRoaXMuY21wKHkyKTsKICAgICAgfTsKICAgICAgUC5leHBvbmVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRCYXNlMTBFeHBvbmVudCh0aGlzKTsKICAgICAgfTsKICAgICAgUC5ncmVhdGVyVGhhbiA9IFAuZ3QgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiB0aGlzLmNtcCh5MikgPiAwOwogICAgICB9OwogICAgICBQLmdyZWF0ZXJUaGFuT3JFcXVhbFRvID0gUC5ndGUgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiB0aGlzLmNtcCh5MikgPj0gMDsKICAgICAgfTsKICAgICAgUC5pc0ludGVnZXIgPSBQLmlzaW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZSA+IHRoaXMuZC5sZW5ndGggLSAyOwogICAgICB9OwogICAgICBQLmlzTmVnYXRpdmUgPSBQLmlzbmVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucyA8IDA7CiAgICAgIH07CiAgICAgIFAuaXNQb3NpdGl2ZSA9IFAuaXNwb3MgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zID4gMDsKICAgICAgfTsKICAgICAgUC5pc1plcm8gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zID09PSAwOwogICAgICB9OwogICAgICBQLmxlc3NUaGFuID0gUC5sdCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA8IDA7CiAgICAgIH07CiAgICAgIFAubGVzc1RoYW5PckVxdWFsVG8gPSBQLmx0ZSA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA8IDE7CiAgICAgIH07CiAgICAgIFAubG9nYXJpdGhtID0gUC5sb2cgPSBmdW5jdGlvbihiYXNlKSB7CiAgICAgICAgdmFyIHIyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbiwgd3ByID0gcHIgKyA1OwogICAgICAgIGlmIChiYXNlID09PSB2b2lkIDApIHsKICAgICAgICAgIGJhc2UgPSBuZXcgQ3RvcigxMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2UgPSBuZXcgQ3RvcihiYXNlKTsKICAgICAgICAgIGlmIChiYXNlLnMgPCAxIHx8IGJhc2UuZXEoT05FKSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0KICAgICAgICBpZiAoeDIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4Mi5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4Mi5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICByMiA9IGRpdmlkZShsbih4Miwgd3ByKSwgbG4oYmFzZSwgd3ByKSwgd3ByKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHJvdW5kKHIyLCBwcik7CiAgICAgIH07CiAgICAgIFAubWludXMgPSBQLnN1YiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgcmV0dXJuIHgyLnMgPT0geTIucyA/IHN1YnRyYWN0KHgyLCB5MikgOiBhZGQoeDIsICh5Mi5zID0gLXkyLnMsIHkyKSk7CiAgICAgIH07CiAgICAgIFAubW9kdWxvID0gUC5tb2QgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBxLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICB5MiA9IG5ldyBDdG9yKHkyKTsKICAgICAgICBpZiAoIXkyLnMpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICBpZiAoIXgyLnMpIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIHByKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHEgPSBkaXZpZGUoeDIsIHkyLCAwLCAxKS50aW1lcyh5Mik7CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiB4Mi5taW51cyhxKTsKICAgICAgfTsKICAgICAgUC5uYXR1cmFsRXhwb25lbnRpYWwgPSBQLmV4cCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBleHAodGhpcyk7CiAgICAgIH07CiAgICAgIFAubmF0dXJhbExvZ2FyaXRobSA9IFAubG4gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbG4odGhpcyk7CiAgICAgIH07CiAgICAgIFAubmVnYXRlZCA9IFAubmVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcyk7CiAgICAgICAgeDIucyA9IC14Mi5zIHx8IDA7CiAgICAgICAgcmV0dXJuIHgyOwogICAgICB9OwogICAgICBQLnBsdXMgPSBQLmFkZCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgcmV0dXJuIHgyLnMgPT0geTIucyA/IGFkZCh4MiwgeTIpIDogc3VidHJhY3QoeDIsICh5Mi5zID0gLXkyLnMsIHkyKSk7CiAgICAgIH07CiAgICAgIFAucHJlY2lzaW9uID0gUC5zZCA9IGZ1bmN0aW9uKHopIHsKICAgICAgICB2YXIgZSwgc2QsIHcsIHgyID0gdGhpczsKICAgICAgICBpZiAoeiAhPT0gdm9pZCAwICYmIHogIT09ICEheiAmJiB6ICE9PSAxICYmIHogIT09IDApIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHopOwogICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxOwogICAgICAgIHcgPSB4Mi5kLmxlbmd0aCAtIDE7CiAgICAgICAgc2QgPSB3ICogTE9HX0JBU0UgKyAxOwogICAgICAgIHcgPSB4Mi5kW3ddOwogICAgICAgIGlmICh3KSB7CiAgICAgICAgICBmb3IgKDsgdyAlIDEwID09IDA7IHcgLz0gMTApIHNkLS07CiAgICAgICAgICBmb3IgKHcgPSB4Mi5kWzBdOyB3ID49IDEwOyB3IC89IDEwKSBzZCsrOwogICAgICAgIH0KICAgICAgICByZXR1cm4geiAmJiBlID4gc2QgPyBlIDogc2Q7CiAgICAgIH07CiAgICAgIFAuc3F1YXJlUm9vdCA9IFAuc3FydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBlLCBuLCBwciwgcjIsIHMsIHQsIHdwciwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHgyLnMgPCAxKSB7CiAgICAgICAgICBpZiAoIXgyLnMpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICAgIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICB9CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHMgPSBNYXRoLnNxcnQoK3gyKTsKICAgICAgICBpZiAocyA9PSAwIHx8IHMgPT0gMSAvIDApIHsKICAgICAgICAgIG4gPSBkaWdpdHNUb1N0cmluZyh4Mi5kKTsKICAgICAgICAgIGlmICgobi5sZW5ndGggKyBlKSAlIDIgPT0gMCkgbiArPSAiMCI7CiAgICAgICAgICBzID0gTWF0aC5zcXJ0KG4pOwogICAgICAgICAgZSA9IG1hdGhmbG9vcigoZSArIDEpIC8gMikgLSAoZSA8IDAgfHwgZSAlIDIpOwogICAgICAgICAgaWYgKHMgPT0gMSAvIDApIHsKICAgICAgICAgICAgbiA9ICI1ZSIgKyBlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbiA9IHMudG9FeHBvbmVudGlhbCgpOwogICAgICAgICAgICBuID0gbi5zbGljZSgwLCBuLmluZGV4T2YoImUiKSArIDEpICsgZTsKICAgICAgICAgIH0KICAgICAgICAgIHIyID0gbmV3IEN0b3Iobik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHIyID0gbmV3IEN0b3Iocy50b1N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBzID0gd3ByID0gcHIgKyAzOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgdCA9IHIyOwogICAgICAgICAgcjIgPSB0LnBsdXMoZGl2aWRlKHgyLCB0LCB3cHIgKyAyKSkudGltZXMoMC41KTsKICAgICAgICAgIGlmIChkaWdpdHNUb1N0cmluZyh0LmQpLnNsaWNlKDAsIHdwcikgPT09IChuID0gZGlnaXRzVG9TdHJpbmcocjIuZCkpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgbiA9IG4uc2xpY2Uod3ByIC0gMywgd3ByICsgMSk7CiAgICAgICAgICAgIGlmIChzID09IHdwciAmJiBuID09ICI0OTk5IikgewogICAgICAgICAgICAgIHJvdW5kKHQsIHByICsgMSwgMCk7CiAgICAgICAgICAgICAgaWYgKHQudGltZXModCkuZXEoeDIpKSB7CiAgICAgICAgICAgICAgICByMiA9IHQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobiAhPSAiOTk5OSIpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cHIgKz0gNDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiByb3VuZChyMiwgcHIpOwogICAgICB9OwogICAgICBQLnRpbWVzID0gUC5tdWwgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBjYXJyeSwgZSwgaSwgaywgcjIsIHJMLCB0LCB4ZEwsIHlkTCwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHhkID0geDIuZCwgeWQgPSAoeTIgPSBuZXcgQ3Rvcih5MikpLmQ7CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgeTIucyAqPSB4Mi5zOwogICAgICAgIGUgPSB4Mi5lICsgeTIuZTsKICAgICAgICB4ZEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgeWRMID0geWQubGVuZ3RoOwogICAgICAgIGlmICh4ZEwgPCB5ZEwpIHsKICAgICAgICAgIHIyID0geGQ7CiAgICAgICAgICB4ZCA9IHlkOwogICAgICAgICAgeWQgPSByMjsKICAgICAgICAgIHJMID0geGRMOwogICAgICAgICAgeGRMID0geWRMOwogICAgICAgICAgeWRMID0gckw7CiAgICAgICAgfQogICAgICAgIHIyID0gW107CiAgICAgICAgckwgPSB4ZEwgKyB5ZEw7CiAgICAgICAgZm9yIChpID0gckw7IGktLTsgKSByMi5wdXNoKDApOwogICAgICAgIGZvciAoaSA9IHlkTDsgLS1pID49IDA7ICkgewogICAgICAgICAgY2FycnkgPSAwOwogICAgICAgICAgZm9yIChrID0geGRMICsgaTsgayA+IGk7ICkgewogICAgICAgICAgICB0ID0gcjJba10gKyB5ZFtpXSAqIHhkW2sgLSBpIC0gMV0gKyBjYXJyeTsKICAgICAgICAgICAgcjJbay0tXSA9IHQgJSBCQVNFIHwgMDsKICAgICAgICAgICAgY2FycnkgPSB0IC8gQkFTRSB8IDA7CiAgICAgICAgICB9CiAgICAgICAgICByMltrXSA9IChyMltrXSArIGNhcnJ5KSAlIEJBU0UgfCAwOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgIXIyWy0tckxdOyApIHIyLnBvcCgpOwogICAgICAgIGlmIChjYXJyeSkgKytlOwogICAgICAgIGVsc2UgcjIuc2hpZnQoKTsKICAgICAgICB5Mi5kID0gcjI7CiAgICAgICAgeTIuZSA9IGU7CiAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIEN0b3IucHJlY2lzaW9uKSA6IHkyOwogICAgICB9OwogICAgICBQLnRvRGVjaW1hbFBsYWNlcyA9IFAudG9kcCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICB4MiA9IG5ldyBDdG9yKHgyKTsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgcmV0dXJuIHgyOwogICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICByZXR1cm4gcm91bmQoeDIsIGRwICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpICsgMSwgcm0pOwogICAgICB9OwogICAgICBQLnRvRXhwb25lbnRpYWwgPSBmdW5jdGlvbihkcCwgcm0pIHsKICAgICAgICB2YXIgc3RyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgewogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja0ludDMyKGRwLCAwLCBNQVhfRElHSVRTKTsKICAgICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgICAgeDIgPSByb3VuZChuZXcgQ3Rvcih4MiksIGRwICsgMSwgcm0pOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHRydWUsIGRwICsgMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9GaXhlZCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciBzdHIsIHkyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgcmV0dXJuIHRvU3RyaW5nKHgyKTsKICAgICAgICBjaGVja0ludDMyKGRwLCAwLCBNQVhfRElHSVRTKTsKICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgeTIgPSByb3VuZChuZXcgQ3Rvcih4MiksIGRwICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpICsgMSwgcm0pOwogICAgICAgIHN0ciA9IHRvU3RyaW5nKHkyLmFicygpLCBmYWxzZSwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh5MikgKyAxKTsKICAgICAgICByZXR1cm4geDIuaXNuZWcoKSAmJiAheDIuaXNaZXJvKCkgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9JbnRlZ2VyID0gUC50b2ludCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICByZXR1cm4gcm91bmQobmV3IEN0b3IoeDIpLCBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBDdG9yLnJvdW5kaW5nKTsKICAgICAgfTsKICAgICAgUC50b051bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiArdGhpczsKICAgICAgfTsKICAgICAgUC50b1Bvd2VyID0gUC5wb3cgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBlLCBrLCBwciwgcjIsIHNpZ24yLCB5SXNJbnQsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBndWFyZCA9IDEyLCB5biA9ICsoeTIgPSBuZXcgQ3Rvcih5MikpOwogICAgICAgIGlmICgheTIucykgcmV0dXJuIG5ldyBDdG9yKE9ORSk7CiAgICAgICAgeDIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgaWYgKCF4Mi5zKSB7CiAgICAgICAgICBpZiAoeTIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJJbmZpbml0eSIpOwogICAgICAgICAgcmV0dXJuIHgyOwogICAgICAgIH0KICAgICAgICBpZiAoeDIuZXEoT05FKSkgcmV0dXJuIHgyOwogICAgICAgIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKHkyLmVxKE9ORSkpIHJldHVybiByb3VuZCh4MiwgcHIpOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIGsgPSB5Mi5kLmxlbmd0aCAtIDE7CiAgICAgICAgeUlzSW50ID0gZSA+PSBrOwogICAgICAgIHNpZ24yID0geDIuczsKICAgICAgICBpZiAoIXlJc0ludCkgewogICAgICAgICAgaWYgKHNpZ24yIDwgMCkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0gZWxzZSBpZiAoKGsgPSB5biA8IDAgPyAteW4gOiB5bikgPD0gTUFYX1NBRkVfSU5URUdFUikgewogICAgICAgICAgcjIgPSBuZXcgQ3RvcihPTkUpOwogICAgICAgICAgZSA9IE1hdGguY2VpbChwciAvIExPR19CQVNFICsgNCk7CiAgICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgIGlmIChrICUgMikgewogICAgICAgICAgICAgIHIyID0gcjIudGltZXMoeDIpOwogICAgICAgICAgICAgIHRydW5jYXRlKHIyLmQsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGsgPSBtYXRoZmxvb3IoayAvIDIpOwogICAgICAgICAgICBpZiAoayA9PT0gMCkgYnJlYWs7CiAgICAgICAgICAgIHgyID0geDIudGltZXMoeDIpOwogICAgICAgICAgICB0cnVuY2F0ZSh4Mi5kLCBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiB5Mi5zIDwgMCA/IG5ldyBDdG9yKE9ORSkuZGl2KHIyKSA6IHJvdW5kKHIyLCBwcik7CiAgICAgICAgfQogICAgICAgIHNpZ24yID0gc2lnbjIgPCAwICYmIHkyLmRbTWF0aC5tYXgoZSwgayldICYgMSA/IC0xIDogMTsKICAgICAgICB4Mi5zID0gMTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHIyID0geTIudGltZXMobG4oeDIsIHByICsgZ3VhcmQpKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcjIgPSBleHAocjIpOwogICAgICAgIHIyLnMgPSBzaWduMjsKICAgICAgICByZXR1cm4gcjI7CiAgICAgIH07CiAgICAgIFAudG9QcmVjaXNpb24gPSBmdW5jdGlvbihzZCwgcm0pIHsKICAgICAgICB2YXIgZSwgc3RyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoc2QgPT09IHZvaWQgMCkgewogICAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICAgIHN0ciA9IHRvU3RyaW5nKHgyLCBlIDw9IEN0b3IudG9FeHBOZWcgfHwgZSA+PSBDdG9yLnRvRXhwUG9zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2tJbnQzMihzZCwgMSwgTUFYX0RJR0lUUyk7CiAgICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICAgIHgyID0gcm91bmQobmV3IEN0b3IoeDIpLCBzZCwgcm0pOwogICAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICAgIHN0ciA9IHRvU3RyaW5nKHgyLCBzZCA8PSBlIHx8IGUgPD0gQ3Rvci50b0V4cE5lZywgc2QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9OwogICAgICBQLnRvU2lnbmlmaWNhbnREaWdpdHMgPSBQLnRvc2QgPSBmdW5jdGlvbihzZCwgcm0pIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHNkID09PSB2b2lkIDApIHsKICAgICAgICAgIHNkID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgICBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoZWNrSW50MzIoc2QsIDEsIE1BWF9ESUdJVFMpOwogICAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIHNkLCBybSk7CiAgICAgIH07CiAgICAgIFAudG9TdHJpbmcgPSBQLnZhbHVlT2YgPSBQLnZhbCA9IFAudG9KU09OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKSwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiB0b1N0cmluZyh4MiwgZSA8PSBDdG9yLnRvRXhwTmVnIHx8IGUgPj0gQ3Rvci50b0V4cFBvcyk7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGFkZCh4MiwgeTIpIHsKICAgICAgICB2YXIgY2FycnksIGQsIGUsIGksIGssIGxlbiwgeGQsIHlkLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSB7CiAgICAgICAgICBpZiAoIXkyLnMpIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGsgPSB4Mi5lOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIHhkID0geGQuc2xpY2UoKTsKICAgICAgICBpID0gayAtIGU7CiAgICAgICAgaWYgKGkpIHsKICAgICAgICAgIGlmIChpIDwgMCkgewogICAgICAgICAgICBkID0geGQ7CiAgICAgICAgICAgIGkgPSAtaTsKICAgICAgICAgICAgbGVuID0geWQubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZCA9IHlkOwogICAgICAgICAgICBlID0gazsKICAgICAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgayA9IE1hdGguY2VpbChwciAvIExPR19CQVNFKTsKICAgICAgICAgIGxlbiA9IGsgPiBsZW4gPyBrICsgMSA6IGxlbiArIDE7CiAgICAgICAgICBpZiAoaSA+IGxlbikgewogICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBkLmxlbmd0aCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICAgIGZvciAoOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBpID0geWQubGVuZ3RoOwogICAgICAgIGlmIChsZW4gLSBpIDwgMCkgewogICAgICAgICAgaSA9IGxlbjsKICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgIHlkID0geGQ7CiAgICAgICAgICB4ZCA9IGQ7CiAgICAgICAgfQogICAgICAgIGZvciAoY2FycnkgPSAwOyBpOyApIHsKICAgICAgICAgIGNhcnJ5ID0gKHhkWy0taV0gPSB4ZFtpXSArIHlkW2ldICsgY2FycnkpIC8gQkFTRSB8IDA7CiAgICAgICAgICB4ZFtpXSAlPSBCQVNFOwogICAgICAgIH0KICAgICAgICBpZiAoY2FycnkpIHsKICAgICAgICAgIHhkLnVuc2hpZnQoY2FycnkpOwogICAgICAgICAgKytlOwogICAgICAgIH0KICAgICAgICBmb3IgKGxlbiA9IHhkLmxlbmd0aDsgeGRbLS1sZW5dID09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgeTIuZCA9IHhkOwogICAgICAgIHkyLmUgPSBlOwogICAgICAgIHJldHVybiBleHRlcm5hbCA/IHJvdW5kKHkyLCBwcikgOiB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0ludDMyKGksIG1pbjIsIG1heDIpIHsKICAgICAgICBpZiAoaSAhPT0gfn5pIHx8IGkgPCBtaW4yIHx8IGkgPiBtYXgyKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyBpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZGlnaXRzVG9TdHJpbmcoZCkgewogICAgICAgIHZhciBpLCBrLCB3cywgaW5kZXhPZkxhc3RXb3JkID0gZC5sZW5ndGggLSAxLCBzdHIgPSAiIiwgdyA9IGRbMF07CiAgICAgICAgaWYgKGluZGV4T2ZMYXN0V29yZCA+IDApIHsKICAgICAgICAgIHN0ciArPSB3OwogICAgICAgICAgZm9yIChpID0gMTsgaSA8IGluZGV4T2ZMYXN0V29yZDsgaSsrKSB7CiAgICAgICAgICAgIHdzID0gZFtpXSArICIiOwogICAgICAgICAgICBrID0gTE9HX0JBU0UgLSB3cy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChrKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICAgICAgc3RyICs9IHdzOwogICAgICAgICAgfQogICAgICAgICAgdyA9IGRbaV07CiAgICAgICAgICB3cyA9IHcgKyAiIjsKICAgICAgICAgIGsgPSBMT0dfQkFTRSAtIHdzLmxlbmd0aDsKICAgICAgICAgIGlmIChrKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICB9IGVsc2UgaWYgKHcgPT09IDApIHsKICAgICAgICAgIHJldHVybiAiMCI7CiAgICAgICAgfQogICAgICAgIGZvciAoOyB3ICUgMTAgPT09IDA7ICkgdyAvPSAxMDsKICAgICAgICByZXR1cm4gc3RyICsgdzsKICAgICAgfQogICAgICB2YXIgZGl2aWRlID0gLyogQF9fUFVSRV9fICovIGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmN0aW9uIG11bHRpcGx5SW50ZWdlcih4MiwgaykgewogICAgICAgICAgdmFyIHRlbXAsIGNhcnJ5ID0gMCwgaSA9IHgyLmxlbmd0aDsKICAgICAgICAgIGZvciAoeDIgPSB4Mi5zbGljZSgpOyBpLS07ICkgewogICAgICAgICAgICB0ZW1wID0geDJbaV0gKiBrICsgY2Fycnk7CiAgICAgICAgICAgIHgyW2ldID0gdGVtcCAlIEJBU0UgfCAwOwogICAgICAgICAgICBjYXJyeSA9IHRlbXAgLyBCQVNFIHwgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYXJyeSkgeDIudW5zaGlmdChjYXJyeSk7CiAgICAgICAgICByZXR1cm4geDI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUoYSwgYiwgYUwsIGJMKSB7CiAgICAgICAgICB2YXIgaSwgcjI7CiAgICAgICAgICBpZiAoYUwgIT0gYkwpIHsKICAgICAgICAgICAgcjIgPSBhTCA+IGJMID8gMSA6IC0xOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpID0gcjIgPSAwOyBpIDwgYUw7IGkrKykgewogICAgICAgICAgICAgIGlmIChhW2ldICE9IGJbaV0pIHsKICAgICAgICAgICAgICAgIHIyID0gYVtpXSA+IGJbaV0gPyAxIDogLTE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3VidHJhY3QyKGEsIGIsIGFMKSB7CiAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICBmb3IgKDsgYUwtLTsgKSB7CiAgICAgICAgICAgIGFbYUxdIC09IGk7CiAgICAgICAgICAgIGkgPSBhW2FMXSA8IGJbYUxdID8gMSA6IDA7CiAgICAgICAgICAgIGFbYUxdID0gaSAqIEJBU0UgKyBhW2FMXSAtIGJbYUxdOwogICAgICAgICAgfQogICAgICAgICAgZm9yICg7ICFhWzBdICYmIGEubGVuZ3RoID4gMTsgKSBhLnNoaWZ0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmdW5jdGlvbih4MiwgeTIsIHByLCBkcCkgewogICAgICAgICAgdmFyIGNtcCwgZSwgaSwgaywgcHJvZCwgcHJvZEwsIHEsIHFkLCByZW0sIHJlbUwsIHJlbTAsIHNkLCB0LCB4aSwgeEwsIHlkMCwgeUwsIHl6LCBDdG9yID0geDIuY29uc3RydWN0b3IsIHNpZ24yID0geDIucyA9PSB5Mi5zID8gMSA6IC0xLCB4ZCA9IHgyLmQsIHlkID0geTIuZDsKICAgICAgICAgIGlmICgheDIucykgcmV0dXJuIG5ldyBDdG9yKHgyKTsKICAgICAgICAgIGlmICgheTIucykgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIkRpdmlzaW9uIGJ5IHplcm8iKTsKICAgICAgICAgIGUgPSB4Mi5lIC0geTIuZTsKICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgeEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBxID0gbmV3IEN0b3Ioc2lnbjIpOwogICAgICAgICAgcWQgPSBxLmQgPSBbXTsKICAgICAgICAgIGZvciAoaSA9IDA7IHlkW2ldID09ICh4ZFtpXSB8fCAwKTsgKSArK2k7CiAgICAgICAgICBpZiAoeWRbaV0gPiAoeGRbaV0gfHwgMCkpIC0tZTsKICAgICAgICAgIGlmIChwciA9PSBudWxsKSB7CiAgICAgICAgICAgIHNkID0gcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICAgIH0gZWxzZSBpZiAoZHApIHsKICAgICAgICAgICAgc2QgPSBwciArIChnZXRCYXNlMTBFeHBvbmVudCh4MikgLSBnZXRCYXNlMTBFeHBvbmVudCh5MikpICsgMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNkID0gcHI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2QgPCAwKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgICBzZCA9IHNkIC8gTE9HX0JBU0UgKyAyIHwgMDsKICAgICAgICAgIGkgPSAwOwogICAgICAgICAgaWYgKHlMID09IDEpIHsKICAgICAgICAgICAgayA9IDA7CiAgICAgICAgICAgIHlkID0geWRbMF07CiAgICAgICAgICAgIHNkKys7CiAgICAgICAgICAgIGZvciAoOyAoaSA8IHhMIHx8IGspICYmIHNkLS07IGkrKykgewogICAgICAgICAgICAgIHQgPSBrICogQkFTRSArICh4ZFtpXSB8fCAwKTsKICAgICAgICAgICAgICBxZFtpXSA9IHQgLyB5ZCB8IDA7CiAgICAgICAgICAgICAgayA9IHQgJSB5ZCB8IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGsgPSBCQVNFIC8gKHlkWzBdICsgMSkgfCAwOwogICAgICAgICAgICBpZiAoayA+IDEpIHsKICAgICAgICAgICAgICB5ZCA9IG11bHRpcGx5SW50ZWdlcih5ZCwgayk7CiAgICAgICAgICAgICAgeGQgPSBtdWx0aXBseUludGVnZXIoeGQsIGspOwogICAgICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgICAgIHhMID0geGQubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHhpID0geUw7CiAgICAgICAgICAgIHJlbSA9IHhkLnNsaWNlKDAsIHlMKTsKICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyByZW1MIDwgeUw7ICkgcmVtW3JlbUwrK10gPSAwOwogICAgICAgICAgICB5eiA9IHlkLnNsaWNlKCk7CiAgICAgICAgICAgIHl6LnVuc2hpZnQoMCk7CiAgICAgICAgICAgIHlkMCA9IHlkWzBdOwogICAgICAgICAgICBpZiAoeWRbMV0gPj0gQkFTRSAvIDIpICsreWQwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgayA9IDA7CiAgICAgICAgICAgICAgY21wID0gY29tcGFyZSh5ZCwgcmVtLCB5TCwgcmVtTCk7CiAgICAgICAgICAgICAgaWYgKGNtcCA8IDApIHsKICAgICAgICAgICAgICAgIHJlbTAgPSByZW1bMF07CiAgICAgICAgICAgICAgICBpZiAoeUwgIT0gcmVtTCkgcmVtMCA9IHJlbTAgKiBCQVNFICsgKHJlbVsxXSB8fCAwKTsKICAgICAgICAgICAgICAgIGsgPSByZW0wIC8geWQwIHwgMDsKICAgICAgICAgICAgICAgIGlmIChrID4gMSkgewogICAgICAgICAgICAgICAgICBpZiAoayA+PSBCQVNFKSBrID0gQkFTRSAtIDE7CiAgICAgICAgICAgICAgICAgIHByb2QgPSBtdWx0aXBseUludGVnZXIoeWQsIGspOwogICAgICAgICAgICAgICAgICBwcm9kTCA9IHByb2QubGVuZ3RoOwogICAgICAgICAgICAgICAgICByZW1MID0gcmVtLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgY21wID0gY29tcGFyZShwcm9kLCByZW0sIHByb2RMLCByZW1MKTsKICAgICAgICAgICAgICAgICAgaWYgKGNtcCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgay0tOwogICAgICAgICAgICAgICAgICAgIHN1YnRyYWN0Mihwcm9kLCB5TCA8IHByb2RMID8geXogOiB5ZCwgcHJvZEwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoayA9PSAwKSBjbXAgPSBrID0gMTsKICAgICAgICAgICAgICAgICAgcHJvZCA9IHlkLnNsaWNlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcm9kTCA9IHByb2QubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKHByb2RMIDwgcmVtTCkgcHJvZC51bnNoaWZ0KDApOwogICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgcHJvZCwgcmVtTCk7CiAgICAgICAgICAgICAgICBpZiAoY21wID09IC0xKSB7CiAgICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHlkLCByZW0sIHlMLCByZW1MKTsKICAgICAgICAgICAgICAgICAgaWYgKGNtcCA8IDEpIHsKICAgICAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgeUwgPCByZW1MID8geXogOiB5ZCwgcmVtTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoY21wID09PSAwKSB7CiAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICByZW0gPSBbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHFkW2krK10gPSBrOwogICAgICAgICAgICAgIGlmIChjbXAgJiYgcmVtWzBdKSB7CiAgICAgICAgICAgICAgICByZW1bcmVtTCsrXSA9IHhkW3hpXSB8fCAwOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZW0gPSBbeGRbeGldXTsKICAgICAgICAgICAgICAgIHJlbUwgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoKHhpKysgPCB4TCB8fCByZW1bMF0gIT09IHZvaWQgMCkgJiYgc2QtLSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXFkWzBdKSBxZC5zaGlmdCgpOwogICAgICAgICAgcS5lID0gZTsKICAgICAgICAgIHJldHVybiByb3VuZChxLCBkcCA/IHByICsgZ2V0QmFzZTEwRXhwb25lbnQocSkgKyAxIDogcHIpOwogICAgICAgIH07CiAgICAgIH0oKTsKICAgICAgZnVuY3Rpb24gZXhwKHgyLCBzZCkgewogICAgICAgIHZhciBkZW5vbWluYXRvciwgZ3VhcmQsIHBvdzIsIHN1bSwgdCwgd3ByLCBpID0gMCwgayA9IDAsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoZ2V0QmFzZTEwRXhwb25lbnQoeDIpID4gMTYpIHRocm93IEVycm9yKGV4cG9uZW50T3V0T2ZSYW5nZSArIGdldEJhc2UxMEV4cG9uZW50KHgyKSk7CiAgICAgICAgaWYgKCF4Mi5zKSByZXR1cm4gbmV3IEN0b3IoT05FKTsKICAgICAgICBpZiAoc2QgPT0gbnVsbCkgewogICAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICAgIHdwciA9IHByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3cHIgPSBzZDsKICAgICAgICB9CiAgICAgICAgdCA9IG5ldyBDdG9yKDAuMDMxMjUpOwogICAgICAgIHdoaWxlICh4Mi5hYnMoKS5ndGUoMC4xKSkgewogICAgICAgICAgeDIgPSB4Mi50aW1lcyh0KTsKICAgICAgICAgIGsgKz0gNTsKICAgICAgICB9CiAgICAgICAgZ3VhcmQgPSBNYXRoLmxvZyhtYXRocG93KDIsIGspKSAvIE1hdGguTE4xMCAqIDIgKyA1IHwgMDsKICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgZGVub21pbmF0b3IgPSBwb3cyID0gc3VtID0gbmV3IEN0b3IoT05FKTsKICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHdwcjsKICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgIHBvdzIgPSByb3VuZChwb3cyLnRpbWVzKHgyKSwgd3ByKTsKICAgICAgICAgIGRlbm9taW5hdG9yID0gZGVub21pbmF0b3IudGltZXMoKytpKTsKICAgICAgICAgIHQgPSBzdW0ucGx1cyhkaXZpZGUocG93MiwgZGVub21pbmF0b3IsIHdwcikpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gZGlnaXRzVG9TdHJpbmcoc3VtLmQpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgd2hpbGUgKGstLSkgc3VtID0gcm91bmQoc3VtLnRpbWVzKHN1bSksIHdwcik7CiAgICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICAgIHJldHVybiBzZCA9PSBudWxsID8gKGV4dGVybmFsID0gdHJ1ZSwgcm91bmQoc3VtLCBwcikpIDogc3VtOwogICAgICAgICAgfQogICAgICAgICAgc3VtID0gdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0QmFzZTEwRXhwb25lbnQoeDIpIHsKICAgICAgICB2YXIgZSA9IHgyLmUgKiBMT0dfQkFTRSwgdyA9IHgyLmRbMF07CiAgICAgICAgZm9yICg7IHcgPj0gMTA7IHcgLz0gMTApIGUrKzsKICAgICAgICByZXR1cm4gZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRMbjEwKEN0b3IsIHNkLCBwcikgewogICAgICAgIGlmIChzZCA+IEN0b3IuTE4xMC5zZCgpKSB7CiAgICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICBpZiAocHIpIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTE4xMCBwcmVjaXNpb24gbGltaXQgZXhjZWVkZWQiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKEN0b3IuTE4xMCksIHNkKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRaZXJvU3RyaW5nKGspIHsKICAgICAgICB2YXIgenMgPSAiIjsKICAgICAgICBmb3IgKDsgay0tOyApIHpzICs9ICIwIjsKICAgICAgICByZXR1cm4genM7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbG4oeTIsIHNkKSB7CiAgICAgICAgdmFyIGMsIGMwLCBkZW5vbWluYXRvciwgZSwgbnVtZXJhdG9yLCBzdW0sIHQsIHdwciwgeDIsIG4gPSAxLCBndWFyZCA9IDEwLCB4MyA9IHkyLCB4ZCA9IHgzLmQsIEN0b3IgPSB4My5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoeDMucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4My5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4My5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgaWYgKHNkID09IG51bGwpIHsKICAgICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgICB3cHIgPSBwcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd3ByID0gc2Q7CiAgICAgICAgfQogICAgICAgIGlmICh4My5lcSgxMCkpIHsKICAgICAgICAgIGlmIChzZCA9PSBudWxsKSBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICByZXR1cm4gZ2V0TG4xMChDdG9yLCB3cHIpOwogICAgICAgIH0KICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgQ3Rvci5wcmVjaXNpb24gPSB3cHI7CiAgICAgICAgYyA9IGRpZ2l0c1RvU3RyaW5nKHhkKTsKICAgICAgICBjMCA9IGMuY2hhckF0KDApOwogICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4Myk7CiAgICAgICAgaWYgKE1hdGguYWJzKGUpIDwgMTVlMTQpIHsKICAgICAgICAgIHdoaWxlIChjMCA8IDcgJiYgYzAgIT0gMSB8fCBjMCA9PSAxICYmIGMuY2hhckF0KDEpID4gMykgewogICAgICAgICAgICB4MyA9IHgzLnRpbWVzKHkyKTsKICAgICAgICAgICAgYyA9IGRpZ2l0c1RvU3RyaW5nKHgzLmQpOwogICAgICAgICAgICBjMCA9IGMuY2hhckF0KDApOwogICAgICAgICAgICBuKys7CiAgICAgICAgICB9CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDMpOwogICAgICAgICAgaWYgKGMwID4gMSkgewogICAgICAgICAgICB4MyA9IG5ldyBDdG9yKCIwLiIgKyBjKTsKICAgICAgICAgICAgZSsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeDMgPSBuZXcgQ3RvcihjMCArICIuIiArIGMuc2xpY2UoMSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0ID0gZ2V0TG4xMChDdG9yLCB3cHIgKyAyLCBwcikudGltZXMoZSArICIiKTsKICAgICAgICAgIHgzID0gbG4obmV3IEN0b3IoYzAgKyAiLiIgKyBjLnNsaWNlKDEpKSwgd3ByIC0gZ3VhcmQpLnBsdXModCk7CiAgICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHByOwogICAgICAgICAgcmV0dXJuIHNkID09IG51bGwgPyAoZXh0ZXJuYWwgPSB0cnVlLCByb3VuZCh4MywgcHIpKSA6IHgzOwogICAgICAgIH0KICAgICAgICBzdW0gPSBudW1lcmF0b3IgPSB4MyA9IGRpdmlkZSh4My5taW51cyhPTkUpLCB4My5wbHVzKE9ORSksIHdwcik7CiAgICAgICAgeDIgPSByb3VuZCh4My50aW1lcyh4MyksIHdwcik7CiAgICAgICAgZGVub21pbmF0b3IgPSAzOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgbnVtZXJhdG9yID0gcm91bmQobnVtZXJhdG9yLnRpbWVzKHgyKSwgd3ByKTsKICAgICAgICAgIHQgPSBzdW0ucGx1cyhkaXZpZGUobnVtZXJhdG9yLCBuZXcgQ3RvcihkZW5vbWluYXRvciksIHdwcikpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gZGlnaXRzVG9TdHJpbmcoc3VtLmQpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgc3VtID0gc3VtLnRpbWVzKDIpOwogICAgICAgICAgICBpZiAoZSAhPT0gMCkgc3VtID0gc3VtLnBsdXMoZ2V0TG4xMChDdG9yLCB3cHIgKyAyLCBwcikudGltZXMoZSArICIiKSk7CiAgICAgICAgICAgIHN1bSA9IGRpdmlkZShzdW0sIG5ldyBDdG9yKG4pLCB3cHIpOwogICAgICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHByOwogICAgICAgICAgICByZXR1cm4gc2QgPT0gbnVsbCA/IChleHRlcm5hbCA9IHRydWUsIHJvdW5kKHN1bSwgcHIpKSA6IHN1bTsKICAgICAgICAgIH0KICAgICAgICAgIHN1bSA9IHQ7CiAgICAgICAgICBkZW5vbWluYXRvciArPSAyOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZURlY2ltYWwoeDIsIHN0cikgewogICAgICAgIHZhciBlLCBpLCBsZW47CiAgICAgICAgaWYgKChlID0gc3RyLmluZGV4T2YoIi4iKSkgPiAtMSkgc3RyID0gc3RyLnJlcGxhY2UoIi4iLCAiIik7CiAgICAgICAgaWYgKChpID0gc3RyLnNlYXJjaCgvZS9pKSkgPiAwKSB7CiAgICAgICAgICBpZiAoZSA8IDApIGUgPSBpOwogICAgICAgICAgZSArPSArc3RyLnNsaWNlKGkgKyAxKTsKICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgaSk7CiAgICAgICAgfSBlbHNlIGlmIChlIDwgMCkgewogICAgICAgICAgZSA9IHN0ci5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IHN0ci5jaGFyQ29kZUF0KGkpID09PSA0ODsgKSArK2k7CiAgICAgICAgZm9yIChsZW4gPSBzdHIubGVuZ3RoOyBzdHIuY2hhckNvZGVBdChsZW4gLSAxKSA9PT0gNDg7ICkgLS1sZW47CiAgICAgICAgc3RyID0gc3RyLnNsaWNlKGksIGxlbik7CiAgICAgICAgaWYgKHN0cikgewogICAgICAgICAgbGVuIC09IGk7CiAgICAgICAgICBlID0gZSAtIGkgLSAxOwogICAgICAgICAgeDIuZSA9IG1hdGhmbG9vcihlIC8gTE9HX0JBU0UpOwogICAgICAgICAgeDIuZCA9IFtdOwogICAgICAgICAgaSA9IChlICsgMSkgJSBMT0dfQkFTRTsKICAgICAgICAgIGlmIChlIDwgMCkgaSArPSBMT0dfQkFTRTsKICAgICAgICAgIGlmIChpIDwgbGVuKSB7CiAgICAgICAgICAgIGlmIChpKSB4Mi5kLnB1c2goK3N0ci5zbGljZSgwLCBpKSk7CiAgICAgICAgICAgIGZvciAobGVuIC09IExPR19CQVNFOyBpIDwgbGVuOyApIHgyLmQucHVzaCgrc3RyLnNsaWNlKGksIGkgKz0gTE9HX0JBU0UpKTsKICAgICAgICAgICAgc3RyID0gc3RyLnNsaWNlKGkpOwogICAgICAgICAgICBpID0gTE9HX0JBU0UgLSBzdHIubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaSAtPSBsZW47CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKDsgaS0tOyApIHN0ciArPSAiMCI7CiAgICAgICAgICB4Mi5kLnB1c2goK3N0cik7CiAgICAgICAgICBpZiAoZXh0ZXJuYWwgJiYgKHgyLmUgPiBNQVhfRSB8fCB4Mi5lIDwgLU1BWF9FKSkgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHgyLnMgPSAwOwogICAgICAgICAgeDIuZSA9IDA7CiAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4geDI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcm91bmQoeDIsIHNkLCBybSkgewogICAgICAgIHZhciBpLCBqLCBrLCBuLCByZCwgZG9Sb3VuZCwgdywgeGRpLCB4ZCA9IHgyLmQ7CiAgICAgICAgZm9yIChuID0gMSwgayA9IHhkWzBdOyBrID49IDEwOyBrIC89IDEwKSBuKys7CiAgICAgICAgaSA9IHNkIC0gbjsKICAgICAgICBpZiAoaSA8IDApIHsKICAgICAgICAgIGkgKz0gTE9HX0JBU0U7CiAgICAgICAgICBqID0gc2Q7CiAgICAgICAgICB3ID0geGRbeGRpID0gMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHhkaSA9IE1hdGguY2VpbCgoaSArIDEpIC8gTE9HX0JBU0UpOwogICAgICAgICAgayA9IHhkLmxlbmd0aDsKICAgICAgICAgIGlmICh4ZGkgPj0gaykgcmV0dXJuIHgyOwogICAgICAgICAgdyA9IGsgPSB4ZFt4ZGldOwogICAgICAgICAgZm9yIChuID0gMTsgayA+PSAxMDsgayAvPSAxMCkgbisrOwogICAgICAgICAgaSAlPSBMT0dfQkFTRTsKICAgICAgICAgIGogPSBpIC0gTE9HX0JBU0UgKyBuOwogICAgICAgIH0KICAgICAgICBpZiAocm0gIT09IHZvaWQgMCkgewogICAgICAgICAgayA9IG1hdGhwb3coMTAsIG4gLSBqIC0gMSk7CiAgICAgICAgICByZCA9IHcgLyBrICUgMTAgfCAwOwogICAgICAgICAgZG9Sb3VuZCA9IHNkIDwgMCB8fCB4ZFt4ZGkgKyAxXSAhPT0gdm9pZCAwIHx8IHcgJSBrOwogICAgICAgICAgZG9Sb3VuZCA9IHJtIDwgNCA/IChyZCB8fCBkb1JvdW5kKSAmJiAocm0gPT0gMCB8fCBybSA9PSAoeDIucyA8IDAgPyAzIDogMikpIDogcmQgPiA1IHx8IHJkID09IDUgJiYgKHJtID09IDQgfHwgZG9Sb3VuZCB8fCBybSA9PSA2ICYmIC8vIENoZWNrIHdoZXRoZXIgdGhlIGRpZ2l0IHRvIHRoZSBsZWZ0IG9mIHRoZSByb3VuZGluZyBkaWdpdCBpcyBvZGQuCiAgICAgICAgICAoaSA+IDAgPyBqID4gMCA/IHcgLyBtYXRocG93KDEwLCBuIC0gaikgOiAwIDogeGRbeGRpIC0gMV0pICUgMTAgJiAxIHx8IHJtID09ICh4Mi5zIDwgMCA/IDggOiA3KSk7CiAgICAgICAgfQogICAgICAgIGlmIChzZCA8IDEgfHwgIXhkWzBdKSB7CiAgICAgICAgICBpZiAoZG9Sb3VuZCkgewogICAgICAgICAgICBrID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICBzZCA9IHNkIC0gayAtIDE7CiAgICAgICAgICAgIHhkWzBdID0gbWF0aHBvdygxMCwgKExPR19CQVNFIC0gc2QgJSBMT0dfQkFTRSkgJSBMT0dfQkFTRSk7CiAgICAgICAgICAgIHgyLmUgPSBtYXRoZmxvb3IoLXNkIC8gTE9HX0JBU0UpIHx8IDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICB4ZFswXSA9IHgyLmUgPSB4Mi5zID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB4MjsKICAgICAgICB9CiAgICAgICAgaWYgKGkgPT0gMCkgewogICAgICAgICAgeGQubGVuZ3RoID0geGRpOwogICAgICAgICAgayA9IDE7CiAgICAgICAgICB4ZGktLTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGQubGVuZ3RoID0geGRpICsgMTsKICAgICAgICAgIGsgPSBtYXRocG93KDEwLCBMT0dfQkFTRSAtIGkpOwogICAgICAgICAgeGRbeGRpXSA9IGogPiAwID8gKHcgLyBtYXRocG93KDEwLCBuIC0gaikgJSBtYXRocG93KDEwLCBqKSB8IDApICogayA6IDA7CiAgICAgICAgfQogICAgICAgIGlmIChkb1JvdW5kKSB7CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgaWYgKHhkaSA9PSAwKSB7CiAgICAgICAgICAgICAgaWYgKCh4ZFswXSArPSBrKSA9PSBCQVNFKSB7CiAgICAgICAgICAgICAgICB4ZFswXSA9IDE7CiAgICAgICAgICAgICAgICArK3gyLmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHhkW3hkaV0gKz0gazsKICAgICAgICAgICAgICBpZiAoeGRbeGRpXSAhPSBCQVNFKSBicmVhazsKICAgICAgICAgICAgICB4ZFt4ZGktLV0gPSAwOwogICAgICAgICAgICAgIGsgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IHhkLmxlbmd0aDsgeGRbLS1pXSA9PT0gMDsgKSB4ZC5wb3AoKTsKICAgICAgICBpZiAoZXh0ZXJuYWwgJiYgKHgyLmUgPiBNQVhfRSB8fCB4Mi5lIDwgLU1BWF9FKSkgewogICAgICAgICAgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHgyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHN1YnRyYWN0KHgyLCB5MikgewogICAgICAgIHZhciBkLCBlLCBpLCBqLCBrLCBsZW4sIHhkLCB4ZSwgeExUeSwgeWQsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoIXgyLnMgfHwgIXkyLnMpIHsKICAgICAgICAgIGlmICh5Mi5zKSB5Mi5zID0gLXkyLnM7CiAgICAgICAgICBlbHNlIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIHhlID0geDIuZTsKICAgICAgICB4ZCA9IHhkLnNsaWNlKCk7CiAgICAgICAgayA9IHhlIC0gZTsKICAgICAgICBpZiAoaykgewogICAgICAgICAgeExUeSA9IGsgPCAwOwogICAgICAgICAgaWYgKHhMVHkpIHsKICAgICAgICAgICAgZCA9IHhkOwogICAgICAgICAgICBrID0gLWs7CiAgICAgICAgICAgIGxlbiA9IHlkLmxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgICAgZSA9IHhlOwogICAgICAgICAgICBsZW4gPSB4ZC5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBpID0gTWF0aC5tYXgoTWF0aC5jZWlsKHByIC8gTE9HX0JBU0UpLCBsZW4pICsgMjsKICAgICAgICAgIGlmIChrID4gaSkgewogICAgICAgICAgICBrID0gaTsKICAgICAgICAgICAgZC5sZW5ndGggPSAxOwogICAgICAgICAgfQogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgICBmb3IgKGkgPSBrOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGkgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBsZW4gPSB5ZC5sZW5ndGg7CiAgICAgICAgICB4TFR5ID0gaSA8IGxlbjsKICAgICAgICAgIGlmICh4TFR5KSBsZW4gPSBpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmICh4ZFtpXSAhPSB5ZFtpXSkgewogICAgICAgICAgICAgIHhMVHkgPSB4ZFtpXSA8IHlkW2ldOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBrID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKHhMVHkpIHsKICAgICAgICAgIGQgPSB4ZDsKICAgICAgICAgIHhkID0geWQ7CiAgICAgICAgICB5ZCA9IGQ7CiAgICAgICAgICB5Mi5zID0gLXkyLnM7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSB5ZC5sZW5ndGggLSBsZW47IGkgPiAwOyAtLWkpIHhkW2xlbisrXSA9IDA7CiAgICAgICAgZm9yIChpID0geWQubGVuZ3RoOyBpID4gazsgKSB7CiAgICAgICAgICBpZiAoeGRbLS1pXSA8IHlkW2ldKSB7CiAgICAgICAgICAgIGZvciAoaiA9IGk7IGogJiYgeGRbLS1qXSA9PT0gMDsgKSB4ZFtqXSA9IEJBU0UgLSAxOwogICAgICAgICAgICAtLXhkW2pdOwogICAgICAgICAgICB4ZFtpXSArPSBCQVNFOwogICAgICAgICAgfQogICAgICAgICAgeGRbaV0gLT0geWRbaV07CiAgICAgICAgfQogICAgICAgIGZvciAoOyB4ZFstLWxlbl0gPT09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgZm9yICg7IHhkWzBdID09PSAwOyB4ZC5zaGlmdCgpKSAtLWU7CiAgICAgICAgaWYgKCF4ZFswXSkgcmV0dXJuIG5ldyBDdG9yKDApOwogICAgICAgIHkyLmQgPSB4ZDsKICAgICAgICB5Mi5lID0gZTsKICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdG9TdHJpbmcoeDIsIGlzRXhwLCBzZCkgewogICAgICAgIHZhciBrLCBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpLCBzdHIgPSBkaWdpdHNUb1N0cmluZyh4Mi5kKSwgbGVuID0gc3RyLmxlbmd0aDsKICAgICAgICBpZiAoaXNFeHApIHsKICAgICAgICAgIGlmIChzZCAmJiAoayA9IHNkIC0gbGVuKSA+IDApIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKSArIGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgICB9IGVsc2UgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKTsKICAgICAgICAgIH0KICAgICAgICAgIHN0ciA9IHN0ciArIChlIDwgMCA/ICJlIiA6ICJlKyIpICsgZTsKICAgICAgICB9IGVsc2UgaWYgKGUgPCAwKSB7CiAgICAgICAgICBzdHIgPSAiMC4iICsgZ2V0WmVyb1N0cmluZygtZSAtIDEpICsgc3RyOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBsZW4pID4gMCkgc3RyICs9IGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgfSBlbHNlIGlmIChlID49IGxlbikgewogICAgICAgICAgc3RyICs9IGdldFplcm9TdHJpbmcoZSArIDEgLSBsZW4pOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBlIC0gMSkgPiAwKSBzdHIgPSBzdHIgKyAiLiIgKyBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoKGsgPSBlICsgMSkgPCBsZW4pIHN0ciA9IHN0ci5zbGljZSgwLCBrKSArICIuIiArIHN0ci5zbGljZShrKTsKICAgICAgICAgIGlmIChzZCAmJiAoayA9IHNkIC0gbGVuKSA+IDApIHsKICAgICAgICAgICAgaWYgKGUgKyAxID09PSBsZW4pIHN0ciArPSAiLiI7CiAgICAgICAgICAgIHN0ciArPSBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4geDIucyA8IDAgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdHJ1bmNhdGUoYXJyLCBsZW4pIHsKICAgICAgICBpZiAoYXJyLmxlbmd0aCA+IGxlbikgewogICAgICAgICAgYXJyLmxlbmd0aCA9IGxlbjsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjbG9uZShvYmopIHsKICAgICAgICB2YXIgaSwgcCwgcHM7CiAgICAgICAgZnVuY3Rpb24gRGVjaW1hbDQodmFsdWUpIHsKICAgICAgICAgIHZhciB4MiA9IHRoaXM7CiAgICAgICAgICBpZiAoISh4MiBpbnN0YW5jZW9mIERlY2ltYWw0KSkgcmV0dXJuIG5ldyBEZWNpbWFsNCh2YWx1ZSk7CiAgICAgICAgICB4Mi5jb25zdHJ1Y3RvciA9IERlY2ltYWw0OwogICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGVjaW1hbDQpIHsKICAgICAgICAgICAgeDIucyA9IHZhbHVlLnM7CiAgICAgICAgICAgIHgyLmUgPSB2YWx1ZS5lOwogICAgICAgICAgICB4Mi5kID0gKHZhbHVlID0gdmFsdWUuZCkgPyB2YWx1ZS5zbGljZSgpIDogdmFsdWU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAqIDAgIT09IDApIHsKICAgICAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID4gMCkgewogICAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIDwgMCkgewogICAgICAgICAgICAgIHZhbHVlID0gLXZhbHVlOwogICAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB4Mi5zID0gMDsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPT09IH5+dmFsdWUgJiYgdmFsdWUgPCAxZTcpIHsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gW3ZhbHVlXTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhcnNlRGVjaW1hbCh4MiwgdmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlLmNoYXJDb2RlQXQoMCkgPT09IDQ1KSB7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGVjaW1hbC50ZXN0KHZhbHVlKSkgcGFyc2VEZWNpbWFsKHgyLCB2YWx1ZSk7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQucHJvdG90eXBlID0gUDsKICAgICAgICBEZWNpbWFsNC5ST1VORF9VUCA9IDA7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRE9XTiA9IDE7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfQ0VJTCA9IDI7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRkxPT1IgPSAzOwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfVVAgPSA0OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRE9XTiA9IDU7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9FVkVOID0gNjsKICAgICAgICBEZWNpbWFsNC5ST1VORF9IQUxGX0NFSUwgPSA3OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRkxPT1IgPSA4OwogICAgICAgIERlY2ltYWw0LmNsb25lID0gY2xvbmU7CiAgICAgICAgRGVjaW1hbDQuY29uZmlnID0gRGVjaW1hbDQuc2V0ID0gY29uZmlnOwogICAgICAgIGlmIChvYmogPT09IHZvaWQgMCkgb2JqID0ge307CiAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgcHMgPSBbInByZWNpc2lvbiIsICJyb3VuZGluZyIsICJ0b0V4cE5lZyIsICJ0b0V4cFBvcyIsICJMTjEwIl07CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyApIGlmICghb2JqLmhhc093blByb3BlcnR5KHAgPSBwc1tpKytdKSkgb2JqW3BdID0gdGhpc1twXTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQuY29uZmlnKG9iaik7CiAgICAgICAgcmV0dXJuIERlY2ltYWw0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbmZpZyhvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgewogICAgICAgICAgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk9iamVjdCBleHBlY3RlZCIpOwogICAgICAgIH0KICAgICAgICB2YXIgaSwgcCwgdiwgcHMgPSBbCiAgICAgICAgICAicHJlY2lzaW9uIiwKICAgICAgICAgIDEsCiAgICAgICAgICBNQVhfRElHSVRTLAogICAgICAgICAgInJvdW5kaW5nIiwKICAgICAgICAgIDAsCiAgICAgICAgICA4LAogICAgICAgICAgInRvRXhwTmVnIiwKICAgICAgICAgIC0xIC8gMCwKICAgICAgICAgIDAsCiAgICAgICAgICAidG9FeHBQb3MiLAogICAgICAgICAgMCwKICAgICAgICAgIDEgLyAwCiAgICAgICAgXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGlmICgodiA9IG9ialtwID0gcHNbaV1dKSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChtYXRoZmxvb3IodikgPT09IHYgJiYgdiA+PSBwc1tpICsgMV0gJiYgdiA8PSBwc1tpICsgMl0pIHRoaXNbcF0gPSB2OwogICAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgodiA9IG9ialtwID0gIkxOMTAiXSkgIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHYgPT0gTWF0aC5MTjEwKSB0aGlzW3BdID0gbmV3IHRoaXModik7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIERlY2ltYWwzID0gY2xvbmUoRGVjaW1hbDMpOwogICAgICBEZWNpbWFsM1siZGVmYXVsdCJdID0gRGVjaW1hbDMuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICBPTkUgPSBuZXcgRGVjaW1hbDMoMSk7CiAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZShmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBEZWNpbWFsMzsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBEZWNpbWFsMzsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIWdsb2JhbFNjb3BlKSB7CiAgICAgICAgICBnbG9iYWxTY29wZSA9IHR5cGVvZiBzZWxmICE9ICJ1bmRlZmluZWQiICYmIHNlbGYgJiYgc2VsZi5zZWxmID09IHNlbGYgPyBzZWxmIDogRnVuY3Rpb24oInJldHVybiB0aGlzIikoKTsKICAgICAgICB9CiAgICAgICAgZ2xvYmFsU2NvcGUuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICB9CiAgICB9KShleHBvcnRzKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXguanMKdmFyIHJlcXVpcmVfZXZlbnRlbWl0dGVyMyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgaGFzMyA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgcHJlZml4ID0gIn4iOwogICAgZnVuY3Rpb24gRXZlbnRzKCkgewogICAgfQogICAgaWYgKE9iamVjdC5jcmVhdGUpIHsKICAgICAgRXZlbnRzLnByb3RvdHlwZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBpZiAoIW5ldyBFdmVudHMoKS5fX3Byb3RvX18pIHByZWZpeCA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gRUUoZm4sIGNvbnRleHQsIG9uY2UpIHsKICAgICAgdGhpcy5mbiA9IGZuOwogICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICB0aGlzLm9uY2UgPSBvbmNlIHx8IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gYWRkTGlzdGVuZXIyKGVtaXR0ZXIsIGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIGxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICB9CiAgICAgIHZhciBsaXN0ZW5lcjIgPSBuZXcgRUUoZm4sIGNvbnRleHQgfHwgZW1pdHRlciwgb25jZSksIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0pIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gbGlzdGVuZXIyLCBlbWl0dGVyLl9ldmVudHNDb3VudCsrOwogICAgICBlbHNlIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0uZm4pIGVtaXR0ZXIuX2V2ZW50c1tldnRdLnB1c2gobGlzdGVuZXIyKTsKICAgICAgZWxzZSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IFtlbWl0dGVyLl9ldmVudHNbZXZ0XSwgbGlzdGVuZXIyXTsKICAgICAgcmV0dXJuIGVtaXR0ZXI7CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckV2ZW50KGVtaXR0ZXIsIGV2dCkgewogICAgICBpZiAoLS1lbWl0dGVyLl9ldmVudHNDb3VudCA9PT0gMCkgZW1pdHRlci5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICBlbHNlIGRlbGV0ZSBlbWl0dGVyLl9ldmVudHNbZXZ0XTsKICAgIH0KICAgIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcjIoKSB7CiAgICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTsKICAgICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwOwogICAgfQogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZXZlbnROYW1lcyA9IGZ1bmN0aW9uIGV2ZW50TmFtZXMoKSB7CiAgICAgIHZhciBuYW1lcyA9IFtdLCBldmVudHMsIG5hbWU7CiAgICAgIGlmICh0aGlzLl9ldmVudHNDb3VudCA9PT0gMCkgcmV0dXJuIG5hbWVzOwogICAgICBmb3IgKG5hbWUgaW4gZXZlbnRzID0gdGhpcy5fZXZlbnRzKSB7CiAgICAgICAgaWYgKGhhczMuY2FsbChldmVudHMsIG5hbWUpKSBuYW1lcy5wdXNoKHByZWZpeCA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lKTsKICAgICAgfQogICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgICAgIHJldHVybiBuYW1lcy5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhldmVudHMpKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBoYW5kbGVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAoIWhhbmRsZXJzKSByZXR1cm4gW107CiAgICAgIGlmIChoYW5kbGVycy5mbikgcmV0dXJuIFtoYW5kbGVycy5mbl07CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaGFuZGxlcnMubGVuZ3RoLCBlZSA9IG5ldyBBcnJheShsKTsgaSA8IGw7IGkrKykgewogICAgICAgIGVlW2ldID0gaGFuZGxlcnNbaV0uZm47CiAgICAgIH0KICAgICAgcmV0dXJuIGVlOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XTsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybiAwOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSByZXR1cm4gMTsKICAgICAgcmV0dXJuIGxpc3RlbmVycy5sZW5ndGg7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIGExLCBhMiwgYTMsIGE0LCBhNSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF0sIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MsIGk7CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHsKICAgICAgICBpZiAobGlzdGVuZXJzLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVycy5mbiwgdm9pZCAwLCB0cnVlKTsKICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQpLCB0cnVlOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExKSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIpLCB0cnVlOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMpLCB0cnVlOwogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0KSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCwgYTUpLCB0cnVlOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgICBsaXN0ZW5lcnMuZm4uYXBwbHkobGlzdGVuZXJzLmNvbnRleHQsIGFyZ3MpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoLCBqOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vbmNlKSB0aGlzLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcnNbaV0uZm4sIHZvaWQgMCwgdHJ1ZSk7CiAgICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMiwgYTMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICghYXJncykgZm9yIChqID0gMSwgYXJncyA9IG5ldyBBcnJheShsZW4gLSAxKTsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW2ogLSAxXSA9IGFyZ3VtZW50c1tqXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmFwcGx5KGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub24gPSBmdW5jdGlvbiBvbihldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIGZhbHNlKTsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gb25jZShldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIHRydWUpOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIyKGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghZm4pIHsKICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSB7CiAgICAgICAgaWYgKGxpc3RlbmVycy5mbiA9PT0gZm4gJiYgKCFvbmNlIHx8IGxpc3RlbmVycy5vbmNlKSAmJiAoIWNvbnRleHQgfHwgbGlzdGVuZXJzLmNvbnRleHQgPT09IGNvbnRleHQpKSB7CiAgICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudHMgPSBbXSwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldLmZuICE9PSBmbiB8fCBvbmNlICYmICFsaXN0ZW5lcnNbaV0ub25jZSB8fCBjb250ZXh0ICYmIGxpc3RlbmVyc1tpXS5jb250ZXh0ICE9PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGV2ZW50cy5wdXNoKGxpc3RlbmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudHMubGVuZ3RoKSB0aGlzLl9ldmVudHNbZXZ0XSA9IGV2ZW50cy5sZW5ndGggPT09IDEgPyBldmVudHNbMF0gOiBldmVudHM7CiAgICAgICAgZWxzZSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQ7CiAgICAgIGlmIChldmVudCkgewogICAgICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgICAgaWYgKHRoaXMuX2V2ZW50c1tldnRdKSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vZmYgPSBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub247CiAgICBFdmVudEVtaXR0ZXIyLnByZWZpeGVkID0gcHJlZml4OwogICAgRXZlbnRFbWl0dGVyMi5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXIyOwogICAgaWYgKCJ1bmRlZmluZWQiICE9PSB0eXBlb2YgbW9kdWxlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyMjsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS9sYXN0LmpzCnZhciByZXF1aXJlX2xhc3QgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS9sYXN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGxhc3QyKGFycikgewogICAgICByZXR1cm4gYXJyW2Fyci5sZW5ndGggLSAxXTsKICAgIH0KICAgIGV4cG9ydHMubGFzdCA9IGxhc3QyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9BcnJheS5qcwp2YXIgcmVxdWlyZV90b0FycmF5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0FycmF5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHRvQXJyYXkodmFsdWUpIHsKICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpID8gdmFsdWUgOiBBcnJheS5mcm9tKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9BcnJheSA9IHRvQXJyYXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L2xhc3QuanMKdmFyIHJlcXVpcmVfbGFzdDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvbGFzdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgbGFzdCQxID0gcmVxdWlyZV9sYXN0KCk7CiAgICB2YXIgdG9BcnJheSA9IHJlcXVpcmVfdG9BcnJheSgpOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyYXkpIHsKICAgICAgaWYgKCFpc0FycmF5TGlrZS5pc0FycmF5TGlrZShhcnJheSkpIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJldHVybiBsYXN0JDEubGFzdCh0b0FycmF5LnRvQXJyYXkoYXJyYXkpKTsKICAgIH0KICAgIGV4cG9ydHMubGFzdCA9IGxhc3QyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvbGFzdC5qcwp2YXIgcmVxdWlyZV9sYXN0MyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvbGFzdC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfbGFzdDIoKS5sYXN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXdpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfd2l0aF9zZWxlY3Rvcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXdpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIChmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKDAgIT09IHgyIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICB9CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQoRXJyb3IoKSk7CiAgICAgIHZhciBSZWFjdDM5ID0gcmVxdWlyZV9yZWFjdCgpLCBvYmplY3RJcyA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBPYmplY3QuaXMgPyBPYmplY3QuaXMgOiBpczQsIHVzZVN5bmNFeHRlcm5hbFN0b3JlMiA9IFJlYWN0MzkudXNlU3luY0V4dGVybmFsU3RvcmUsIHVzZVJlZjE1ID0gUmVhY3QzOS51c2VSZWYsIHVzZUVmZmVjdDE1ID0gUmVhY3QzOS51c2VFZmZlY3QsIHVzZU1lbW84ID0gUmVhY3QzOS51c2VNZW1vLCB1c2VEZWJ1Z1ZhbHVlMiA9IFJlYWN0MzkudXNlRGVidWdWYWx1ZTsKICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZVdpdGhTZWxlY3RvciA9IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90LCBzZWxlY3RvciwgaXNFcXVhbCkgewogICAgICAgIHZhciBpbnN0UmVmID0gdXNlUmVmMTUobnVsbCk7CiAgICAgICAgaWYgKG51bGwgPT09IGluc3RSZWYuY3VycmVudCkgewogICAgICAgICAgdmFyIGluc3QgPSB7IGhhc1ZhbHVlOiBmYWxzZSwgdmFsdWU6IG51bGwgfTsKICAgICAgICAgIGluc3RSZWYuY3VycmVudCA9IGluc3Q7CiAgICAgICAgfSBlbHNlIGluc3QgPSBpbnN0UmVmLmN1cnJlbnQ7CiAgICAgICAgaW5zdFJlZiA9IHVzZU1lbW84KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIG1lbW9pemVkU2VsZWN0b3IobmV4dFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgaWYgKCFoYXNNZW1vKSB7CiAgICAgICAgICAgICAgICBoYXNNZW1vID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgICBuZXh0U25hcHNob3QgPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gaXNFcXVhbCAmJiBpbnN0Lmhhc1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U2VsZWN0aW9uID0gaW5zdC52YWx1ZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzRXF1YWwoY3VycmVudFNlbGVjdGlvbiwgbmV4dFNuYXBzaG90KSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50U2VsZWN0aW9uID0gbWVtb2l6ZWRTZWxlY3Rpb247CiAgICAgICAgICAgICAgaWYgKG9iamVjdElzKG1lbW9pemVkU25hcHNob3QsIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICB2YXIgbmV4dFNlbGVjdGlvbiA9IHNlbGVjdG9yKG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gaXNFcXVhbCAmJiBpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTZWxlY3Rpb24pKQogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3QsIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBuZXh0U2VsZWN0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNNZW1vID0gZmFsc2UsIG1lbW9pemVkU25hcHNob3QsIG1lbW9pemVkU2VsZWN0aW9uLCBtYXliZUdldFNlcnZlclNuYXBzaG90ID0gdm9pZCAwID09PSBnZXRTZXJ2ZXJTbmFwc2hvdCA/IG51bGwgOiBnZXRTZXJ2ZXJTbmFwc2hvdDsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKGdldFNuYXBzaG90KCkpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbnVsbCA9PT0gbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA/IHZvaWQgMCA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0b3IobWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIF07CiAgICAgICAgICB9LAogICAgICAgICAgW2dldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWxdCiAgICAgICAgKTsKICAgICAgICB2YXIgdmFsdWUgPSB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIoc3Vic2NyaWJlLCBpbnN0UmVmWzBdLCBpbnN0UmVmWzFdKTsKICAgICAgICB1c2VFZmZlY3QxNSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnN0Lmhhc1ZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgaW5zdC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgfSwKICAgICAgICAgIFt2YWx1ZV0KICAgICAgICApOwogICAgICAgIHVzZURlYnVnVmFsdWUyKHZhbHVlKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH07CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKEVycm9yKCkpOwogICAgfSkoKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3dpdGgtc2VsZWN0b3IuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3RvcjIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3dpdGgtc2VsZWN0b3IuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV91c2Vfc3luY19leHRlcm5hbF9zdG9yZV93aXRoX3NlbGVjdG9yX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfanN4X3J1bnRpbWVfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZSIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZV9saXN0Iik7CiAgICAgICAgdmFyIFJFQUNUX01FTU9fVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5vZmZzY3JlZW4iKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSBSZWFjdDM5Ll9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQyLCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdDIgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0Mik7CiAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBlbmFibGVTY29wZUFQSSA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVDYWNoZUVsZW1lbnQgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlTGVnYWN5SGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZURlYnVnVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFOwogICAgICAgIHsKICAgICAgICAgIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgPSBTeW1ib2wuZm9yKCJyZWFjdC5tb2R1bGUucmVmZXJlbmNlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfUFJPRklMRVJfVFlQRSB8fCBlbmFibGVEZWJ1Z1RyYWNpbmcgfHwgdHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSB8fCBlbmFibGVMZWdhY3lIaWRkZW4gfHwgdHlwZSA9PT0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgfHwgZW5hYmxlU2NvcGVBUEkgfHwgZW5hYmxlQ2FjaGVFbGVtZW50IHx8IGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMiB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBUaGlzIG5lZWRzIHRvIGluY2x1ZGUgYWxsIHBvc3NpYmxlIG1vZHVsZSByZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgIC8vIHR5cGVzIHN1cHBvcnRlZCBieSBhbnkgRmxpZ2h0IGNvbmZpZ3VyYXRpb24gYW55d2hlcmUgc2luY2UKICAgICAgICAgICAgLy8gd2UgZG9uJ3Qga25vdyB3aGljaCBGbGlnaHQgYnVpbGQgdGhpcyB3aWxsIGVuZCB1cCBiZWluZyB1c2VkCiAgICAgICAgICAgIC8vIHdpdGguCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgfHwgdHlwZS5nZXRNb2R1bGVJZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BUeXBlcyh0eXBlU3BlY3MsIHZhbHVlcywgbG9jYXRpb24sIGNvbXBvbmVudE5hbWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhczMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhczModHlwZVNwZWNzLCB0eXBlU3BlY05hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gRXJyb3IoKGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIikgKyAiOiAiICsgbG9jYXRpb24gKyAiIHR5cGUgYCIgKyB0eXBlU3BlY05hbWUgKyAiYCBpcyBpbnZhbGlkOyBpdCBtdXN0IGJlIGEgZnVuY3Rpb24sIHVzdWFsbHkgZnJvbSB0aGUgYHByb3AtdHlwZXNgIHBhY2thZ2UsIGJ1dCByZWNlaXZlZCBgIiArIHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSArICJgLlRoaXMgb2Z0ZW4gaGFwcGVucyBiZWNhdXNlIG9mIHR5cG9zIHN1Y2ggYXMgYFByb3BUeXBlcy5mdW5jdGlvbmAgaW5zdGVhZCBvZiBgUHJvcFR5cGVzLmZ1bmNgLiIpOwogICAgICAgICAgICAgICAgICAgIGVyci5uYW1lID0gIkludmFyaWFudCBWaW9sYXRpb24iOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvciQxID0gdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0odmFsdWVzLCB0eXBlU3BlY05hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBudWxsLCAiU0VDUkVUX0RPX05PVF9QQVNTX1RISVNfT1JfWU9VX1dJTExfQkVfRklSRUQiKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSBleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxICYmICEoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yKSkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiB0eXBlIHNwZWNpZmljYXRpb24gb2YgJXMgYCVzYCBpcyBpbnZhbGlkOyB0aGUgdHlwZSBjaGVja2VyIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGBudWxsYCBvciBhbiBgRXJyb3JgIGJ1dCByZXR1cm5lZCBhICVzLiBZb3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIHBhc3MgYW4gYXJndW1lbnQgdG8gdGhlIHR5cGUgY2hlY2tlciBjcmVhdG9yIChhcnJheU9mLCBpbnN0YW5jZU9mLCBvYmplY3RPZiwgb25lT2YsIG9uZU9mVHlwZSwgYW5kIHNoYXBlIGFsbCByZXF1aXJlIGFuIGFyZ3VtZW50KS4iLCBjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIsIGxvY2F0aW9uLCB0eXBlU3BlY05hbWUsIHR5cGVvZiBlcnJvciQxKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yICYmICEoZXJyb3IkMS5tZXNzYWdlIGluIGxvZ2dlZFR5cGVGYWlsdXJlcykpIHsKICAgICAgICAgICAgICAgICAgbG9nZ2VkVHlwZUZhaWx1cmVzW2Vycm9yJDEubWVzc2FnZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkZhaWxlZCAlcyB0eXBlOiAlcyIsIGxvY2F0aW9uLCBlcnJvciQxLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgICByZWY6IHRydWUsCiAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duOwogICAgICAgIHZhciBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bjsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgInJlZiIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5yZWYgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgImtleSIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgc2VsZjIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC5zdGF0ZU5vZGUgIT09IHNlbGYyKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVGhpcyBjYXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbi4gV2UgYXNrIHlvdSB0byBtYW51YWxseSBmaXggdGhpcyBjYXNlIGJ5IHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKSwgY29uZmlnLnJlZik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGBrZXlgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJrZXkiLCB7CiAgICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXksCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ1JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYHJlZmAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ1JlZiwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbih0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYyCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zb3VyY2UiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNvdXJjZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24ganN4REVWKHR5cGUsIGNvbmZpZywgbWF5YmVLZXksIHNvdXJjZSwgc2VsZjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgICB2YXIgcHJvcHMgPSB7fTsKICAgICAgICAgICAgdmFyIGtleSA9IG51bGw7CiAgICAgICAgICAgIHZhciByZWYgPSBudWxsOwogICAgICAgICAgICBpZiAobWF5YmVLZXkgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWF5YmVLZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIG1heWJlS2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnLCBzZWxmMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQsIHByb3BzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50MTYob2JqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE93bmVyID0gIiI7CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQpIHsKICAgICAgICAgICAgICBjaGlsZE93bmVyID0gIiBJdCB3YXMgcGFzc2VkIGEgY2hpbGQgZnJvbSAiICsgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGVsZW1lbnQuX293bmVyLnR5cGUpICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNBcnJheTIobm9kZSkpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNihjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShjaGlsZCwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRFbGVtZW50MTYobm9kZSkpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICAgIG5vZGUuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obm9kZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChub2RlKTsKICAgICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNihzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShzdGVwLnZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIE5vdGU6IE1lbW8gb25seSBjaGVja3Mgb3V0ZXIgcHJvcHMgaGVyZS4KICAgICAgICAgICAgLy8gSW5uZXIgcHJvcHMgYXJlIGNoZWNrZWQgaW4gdGhlIHJlY29uY2lsZXIuCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEtleVNwcmVhZCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIGlzU3RhdGljQ2hpbGRyZW4sIHNvdXJjZSwgc2VsZjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgICAgaWYgKCF2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKTsKICAgICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgICAgaW5mbyArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgdHlwZVN0cmluZzsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJudWxsIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkyKHR5cGUpKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiPCIgKyAoZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IHR5cGUgaXMgaW52YWxpZCAtLSBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMiLCB0eXBlU3RyaW5nLCBpbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGpzeERFVih0eXBlLCBwcm9wcywga2V5LCBzb3VyY2UsIHNlbGYyKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RhdGljQ2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuW2ldLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiBTdGF0aWMgY2hpbGRyZW4gc2hvdWxkIGFsd2F5cyBiZSBhbiBhcnJheS4gWW91IGFyZSBsaWtlbHkgZXhwbGljaXRseSBjYWxsaW5nIFJlYWN0LmpzeHMgb3IgUmVhY3QuanN4REVWLiBVc2UgdGhlIEJhYmVsIHRyYW5zZm9ybSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhjaGlsZHJlbiwgdHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChwcm9wcywgImtleSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcHMpLmZpbHRlcihmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBrICE9PSAia2V5IjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIGJlZm9yZUV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAie2tleTogc29tZUtleSwgIiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie2tleTogc29tZUtleX0iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdKSB7CiAgICAgICAgICAgICAgICAgIHZhciBhZnRlckV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAieyIgKyBrZXlzLmpvaW4oIjogLi4uLCAiKSArICI6IC4uLn0iIDogInt9IjsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0EgcHJvcHMgb2JqZWN0IGNvbnRhaW5pbmcgYSAia2V5IiBwcm9wIGlzIGJlaW5nIHNwcmVhZCBpbnRvIEpTWDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyB7Li4ucHJvcHN9IC8+XG5SZWFjdCBrZXlzIG11c3QgYmUgcGFzc2VkIGRpcmVjdGx5IHRvIEpTWCB3aXRob3V0IHVzaW5nIHNwcmVhZDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyBrZXk9e3NvbWVLZXl9IHsuLi5wcm9wc30gLz4nLCBiZWZvcmVFeGFtcGxlLCBjb21wb25lbnROYW1lLCBhZnRlckV4YW1wbGUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljKHR5cGUsIHByb3BzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBqc3hXaXRoVmFsaWRhdGlvbkR5bmFtaWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIganN4MyA9IGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYzsKICAgICAgICB2YXIganN4czMgPSBqc3hXaXRoVmFsaWRhdGlvblN0YXRpYzsKICAgICAgICBleHBvcnRzLkZyYWdtZW50ID0gUkVBQ1RfRlJBR01FTlRfVFlQRTsKICAgICAgICBleHBvcnRzLmpzeCA9IGpzeDM7CiAgICAgICAgZXhwb3J0cy5qc3hzID0ganN4czM7CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9qc3gtcnVudGltZS5qcwp2YXIgcmVxdWlyZV9qc3hfcnVudGltZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvanN4LXJ1bnRpbWUuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9qc3hfcnVudGltZV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9yZWFjdDUzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCksIDEpOwp2YXIgaW1wb3J0X2NsaWVudCA9IF9fdG9FU00ocmVxdWlyZV9jbGllbnQoKSwgMSk7CgovLyBzcmMvY29tcG9uZW50LnRzeAp2YXIgaW1wb3J0X3JlYWN0NTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2NyZWF0ZUx1Y2lkZUljb24uanMKdmFyIGltcG9ydF9yZWFjdDIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL3NoYXJlZC9zcmMvdXRpbHMuanMKdmFyIHRvS2ViYWJDYXNlID0gKHN0cmluZykgPT4gc3RyaW5nLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICIkMS0kMiIpLnRvTG93ZXJDYXNlKCk7CnZhciB0b0NhbWVsQ2FzZSA9IChzdHJpbmcpID0+IHN0cmluZy5yZXBsYWNlKAogIC9eKFtBLVpdKXxbXHMtX10rKFx3KS9nLAogIChtYXRjaCwgcDEsIHAyKSA9PiBwMiA/IHAyLnRvVXBwZXJDYXNlKCkgOiBwMS50b0xvd2VyQ2FzZSgpCik7CnZhciB0b1Bhc2NhbENhc2UgPSAoc3RyaW5nKSA9PiB7CiAgY29uc3QgY2FtZWxDYXNlID0gdG9DYW1lbENhc2Uoc3RyaW5nKTsKICByZXR1cm4gY2FtZWxDYXNlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgY2FtZWxDYXNlLnNsaWNlKDEpOwp9Owp2YXIgbWVyZ2VDbGFzc2VzID0gKC4uLmNsYXNzZXMpID0+IGNsYXNzZXMuZmlsdGVyKChjbGFzc05hbWUsIGluZGV4LCBhcnJheSkgPT4gewogIHJldHVybiBCb29sZWFuKGNsYXNzTmFtZSkgJiYgY2xhc3NOYW1lLnRyaW0oKSAhPT0gIiIgJiYgYXJyYXkuaW5kZXhPZihjbGFzc05hbWUpID09PSBpbmRleDsKfSkuam9pbigiICIpLnRyaW0oKTsKdmFyIGhhc0ExMXlQcm9wID0gKHByb3BzKSA9PiB7CiAgZm9yIChjb25zdCBwcm9wIGluIHByb3BzKSB7CiAgICBpZiAocHJvcC5zdGFydHNXaXRoKCJhcmlhLSIpIHx8IHByb3AgPT09ICJyb2xlIiB8fCBwcm9wID09PSAidGl0bGUiKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9kZWZhdWx0QXR0cmlidXRlcy5qcwp2YXIgZGVmYXVsdEF0dHJpYnV0ZXMgPSB7CiAgeG1sbnM6ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsCiAgd2lkdGg6IDI0LAogIGhlaWdodDogMjQsCiAgdmlld0JveDogIjAgMCAyNCAyNCIsCiAgZmlsbDogIm5vbmUiLAogIHN0cm9rZTogImN1cnJlbnRDb2xvciIsCiAgc3Ryb2tlV2lkdGg6IDIsCiAgc3Ryb2tlTGluZWNhcDogInJvdW5kIiwKICBzdHJva2VMaW5lam9pbjogInJvdW5kIgp9OwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzCnZhciBJY29uID0gKDAsIGltcG9ydF9yZWFjdC5mb3J3YXJkUmVmKSgKICAoewogICAgY29sb3I6IGNvbG9yMiA9ICJjdXJyZW50Q29sb3IiLAogICAgc2l6ZSA9IDI0LAogICAgc3Ryb2tlV2lkdGggPSAyLAogICAgYWJzb2x1dGVTdHJva2VXaWR0aCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgY2hpbGRyZW4sCiAgICBpY29uTm9kZSwKICAgIC4uLnJlc3QKICB9LCByZWYpID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkoCiAgICAic3ZnIiwKICAgIHsKICAgICAgcmVmLAogICAgICAuLi5kZWZhdWx0QXR0cmlidXRlcywKICAgICAgd2lkdGg6IHNpemUsCiAgICAgIGhlaWdodDogc2l6ZSwKICAgICAgc3Ryb2tlOiBjb2xvcjIsCiAgICAgIHN0cm9rZVdpZHRoOiBhYnNvbHV0ZVN0cm9rZVdpZHRoID8gTnVtYmVyKHN0cm9rZVdpZHRoKSAqIDI0IC8gTnVtYmVyKHNpemUpIDogc3Ryb2tlV2lkdGgsCiAgICAgIGNsYXNzTmFtZTogbWVyZ2VDbGFzc2VzKCJsdWNpZGUiLCBjbGFzc05hbWUpLAogICAgICAuLi4hY2hpbGRyZW4gJiYgIWhhc0ExMXlQcm9wKHJlc3QpICYmIHsgImFyaWEtaGlkZGVuIjogInRydWUiIH0sCiAgICAgIC4uLnJlc3QKICAgIH0sCiAgICBbCiAgICAgIC4uLmljb25Ob2RlLm1hcCgoW3RhZywgYXR0cnNdKSA9PiAoMCwgaW1wb3J0X3JlYWN0LmNyZWF0ZUVsZW1lbnQpKHRhZywgYXR0cnMpKSwKICAgICAgLi4uQXJyYXkuaXNBcnJheShjaGlsZHJlbikgPyBjaGlsZHJlbiA6IFtjaGlsZHJlbl0KICAgIF0KICApCik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2NyZWF0ZUx1Y2lkZUljb24uanMKdmFyIGNyZWF0ZUx1Y2lkZUljb24gPSAoaWNvbk5hbWUsIGljb25Ob2RlKSA9PiB7CiAgY29uc3QgQ29tcG9uZW50ID0gKDAsIGltcG9ydF9yZWFjdDIuZm9yd2FyZFJlZikoCiAgICAoeyBjbGFzc05hbWUsIC4uLnByb3BzIH0sIHJlZikgPT4gKDAsIGltcG9ydF9yZWFjdDIuY3JlYXRlRWxlbWVudCkoSWNvbiwgewogICAgICByZWYsCiAgICAgIGljb25Ob2RlLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygKICAgICAgICBgbHVjaWRlLSR7dG9LZWJhYkNhc2UodG9QYXNjYWxDYXNlKGljb25OYW1lKSl9YCwKICAgICAgICBgbHVjaWRlLSR7aWNvbk5hbWV9YCwKICAgICAgICBjbGFzc05hbWUKICAgICAgKSwKICAgICAgLi4ucHJvcHMKICAgIH0pCiAgKTsKICBDb21wb25lbnQuZGlzcGxheU5hbWUgPSB0b1Bhc2NhbENhc2UoaWNvbk5hbWUpOwogIHJldHVybiBDb21wb25lbnQ7Cn07CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Fycm93LXJpZ2h0LmpzCnZhciBfX2ljb25Ob2RlID0gWwogIFsicGF0aCIsIHsgZDogIk01IDEyaDE0Iiwga2V5OiAiMWF5czBoIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtMTIgNSA3IDctNyA3Iiwga2V5OiAieHF1ejRjIiB9XQpdOwp2YXIgQXJyb3dSaWdodCA9IGNyZWF0ZUx1Y2lkZUljb24oImFycm93LXJpZ2h0IiwgX19pY29uTm9kZSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NoZXZyb24tZG93bi5qcwp2YXIgX19pY29uTm9kZTIgPSBbWyJwYXRoIiwgeyBkOiAibTYgOSA2IDYgNi02Iiwga2V5OiAicXJ1bnNsIiB9XV07CnZhciBDaGV2cm9uRG93biA9IGNyZWF0ZUx1Y2lkZUljb24oImNoZXZyb24tZG93biIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanMKdmFyIF9faWNvbk5vZGUzID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yIDkuNWE1LjUgNS41IDAgMCAxIDkuNTkxLTMuNjc2LjU2LjU2IDAgMCAwIC44MTggMEE1LjQ5IDUuNDkgMCAwIDEgMjIgOS41YzAgMi4yOS0xLjUgNC0zIDUuNWwtNS40OTIgNS4zMTNhMiAyIDAgMCAxLTMgLjAxOUw1IDE1Yy0xLjUtMS41LTMtMy4yLTMtNS41IiwKICAgICAga2V5OiAibXZyMWEwIgogICAgfQogIF0KXTsKdmFyIEhlYXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigiaGVhcnQiLCBfX2ljb25Ob2RlMyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvYWRlci5qcwp2YXIgX19pY29uTm9kZTQgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDJ2NCIsIGtleTogIjM0MjdpYyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTE2LjIgNy44IDIuOS0yLjkiLCBrZXk6ICJyNzAwYW8iIH1dLAogIFsicGF0aCIsIHsgZDogIk0xOCAxMmg0Iiwga2V5OiAid2o5eWtoIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtMTYuMiAxNi4yIDIuOSAyLjkiLCBrZXk6ICIxYnhnNXQiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiAxOHY0Iiwga2V5OiAiamFkbXZ6IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtNC45IDE5LjEgMi45LTIuOSIsIGtleTogImJ3aXg5cSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTIgMTJoNCIsIGtleTogImowOXNpaSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTQuOSA0LjkgMi45IDIuOSIsIGtleTogImdpeXVmciIgfV0KXTsKdmFyIExvYWRlciA9IGNyZWF0ZUx1Y2lkZUljb24oImxvYWRlciIsIF9faWNvbk5vZGU0KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWFpbC5qcwp2YXIgX19pY29uTm9kZTUgPSBbCiAgWyJwYXRoIiwgeyBkOiAibTIyIDctOC45OTEgNS43MjdhMiAyIDAgMCAxLTIuMDA5IDBMMiA3Iiwga2V5OiAiMTMycTdxIiB9XSwKICBbInJlY3QiLCB7IHg6ICIyIiwgeTogIjQiLCB3aWR0aDogIjIwIiwgaGVpZ2h0OiAiMTYiLCByeDogIjIiLCBrZXk6ICJpenhsYW8iIH1dCl07CnZhciBNYWlsID0gY3JlYXRlTHVjaWRlSWNvbigibWFpbCIsIF9faWNvbk5vZGU1KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWVzc2FnZS1zcXVhcmUuanMKdmFyIF9faWNvbk5vZGU2ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yMiAxN2EyIDIgMCAwIDEtMiAySDYuODI4YTIgMiAwIDAgMC0xLjQxNC41ODZsLTIuMjAyIDIuMjAyQS43MS43MSAwIDAgMSAyIDIxLjI4NlY1YTIgMiAwIDAgMSAyLTJoMTZhMiAyIDAgMCAxIDIgMnoiLAogICAgICBrZXk6ICIxODg4N3AiCiAgICB9CiAgXQpdOwp2YXIgTWVzc2FnZVNxdWFyZSA9IGNyZWF0ZUx1Y2lkZUljb24oIm1lc3NhZ2Utc3F1YXJlIiwgX19pY29uTm9kZTYpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9taW51cy5qcwp2YXIgX19pY29uTm9kZTcgPSBbWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dXTsKdmFyIE1pbnVzID0gY3JlYXRlTHVjaWRlSWNvbigibWludXMiLCBfX2ljb25Ob2RlNyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsYXkuanMKdmFyIF9faWNvbk5vZGU4ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk01IDVhMiAyIDAgMCAxIDMuMDA4LTEuNzI4bDExLjk5NyA2Ljk5OGEyIDIgMCAwIDEgLjAwMyAzLjQ1OGwtMTIgN0EyIDIgMCAwIDEgNSAxOXoiLAogICAgICBrZXk6ICIxMGlrZjEiCiAgICB9CiAgXQpdOwp2YXIgUGxheSA9IGNyZWF0ZUx1Y2lkZUljb24oInBsYXkiLCBfX2ljb25Ob2RlOCk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsdXMuanMKdmFyIF9faWNvbk5vZGU5ID0gWwogIFsicGF0aCIsIHsgZDogIk01IDEyaDE0Iiwga2V5OiAiMWF5czBoIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTIgNXYxNCIsIGtleTogInM2OTlsZSIgfV0KXTsKdmFyIFBsdXMgPSBjcmVhdGVMdWNpZGVJY29uKCJwbHVzIiwgX19pY29uTm9kZTkpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wcmludGVyLmpzCnZhciBfX2ljb25Ob2RlMTAgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTYgMThINGEyIDIgMCAwIDEtMi0ydi01YTIgMiAwIDAgMSAyLTJoMTZhMiAyIDAgMCAxIDIgMnY1YTIgMiAwIDAgMS0yIDJoLTIiLAogICAgICBrZXk6ICIxNDN3eWQiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNNiA5VjNhMSAxIDAgMCAxIDEtMWgxMGExIDEgMCAwIDEgMSAxdjYiLCBrZXk6ICIxaXRuZTciIH1dLAogIFsicmVjdCIsIHsgeDogIjYiLCB5OiAiMTQiLCB3aWR0aDogIjEyIiwgaGVpZ2h0OiAiOCIsIHJ4OiAiMSIsIGtleTogIjF1ZTB0ZyIgfV0KXTsKdmFyIFByaW50ZXIgPSBjcmVhdGVMdWNpZGVJY29uKCJwcmludGVyIiwgX19pY29uTm9kZTEwKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcm90YXRlLWNjdy5qcwp2YXIgX19pY29uTm9kZTExID0gWwogIFsicGF0aCIsIHsgZDogIk0zIDEyYTkgOSAwIDEgMCA5LTkgOS43NSA5Ljc1IDAgMCAwLTYuNzQgMi43NEwzIDgiLCBrZXk6ICIxMzU3ZTMiIH1dLAogIFsicGF0aCIsIHsgZDogIk0zIDN2NWg1Iiwga2V5OiAiMXhocThhIiB9XQpdOwp2YXIgUm90YXRlQ2N3ID0gY3JlYXRlTHVjaWRlSWNvbigicm90YXRlLWNjdyIsIF9faWNvbk5vZGUxMSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9TdXJmYWNlLmpzCnZhciBSZWFjdCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvY2xzeC9kaXN0L2Nsc3gubWpzCmZ1bmN0aW9uIHIoZSkgewogIHZhciB0LCBmLCBuID0gIiI7CiAgaWYgKCJzdHJpbmciID09IHR5cGVvZiBlIHx8ICJudW1iZXIiID09IHR5cGVvZiBlKSBuICs9IGU7CiAgZWxzZSBpZiAoIm9iamVjdCIgPT0gdHlwZW9mIGUpIGlmIChBcnJheS5pc0FycmF5KGUpKSB7CiAgICB2YXIgbyA9IGUubGVuZ3RoOwogICAgZm9yICh0ID0gMDsgdCA8IG87IHQrKykgZVt0XSAmJiAoZiA9IHIoZVt0XSkpICYmIChuICYmIChuICs9ICIgIiksIG4gKz0gZik7CiAgfSBlbHNlIGZvciAoZiBpbiBlKSBlW2ZdICYmIChuICYmIChuICs9ICIgIiksIG4gKz0gZik7CiAgcmV0dXJuIG47Cn0KZnVuY3Rpb24gY2xzeCgpIHsKICBmb3IgKHZhciBlLCB0LCBmID0gMCwgbiA9ICIiLCBvID0gYXJndW1lbnRzLmxlbmd0aDsgZiA8IG87IGYrKykgKGUgPSBhcmd1bWVudHNbZl0pICYmICh0ID0gcihlKSkgJiYgKG4gJiYgKG4gKz0gIiAiKSwgbiArPSB0KTsKICByZXR1cm4gbjsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3N2Z1Byb3BlcnRpZXNBbmRFdmVudHMuanMKdmFyIGltcG9ydF9yZWFjdDQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZXhjbHVkZUV2ZW50UHJvcHMuanMKdmFyIEV2ZW50S2V5cyA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAib25Db3B5IiwgIm9uQ29weUNhcHR1cmUiLCAib25DdXQiLCAib25DdXRDYXB0dXJlIiwgIm9uUGFzdGUiLCAib25QYXN0ZUNhcHR1cmUiLCAib25Db21wb3NpdGlvbkVuZCIsICJvbkNvbXBvc2l0aW9uRW5kQ2FwdHVyZSIsICJvbkNvbXBvc2l0aW9uU3RhcnQiLCAib25Db21wb3NpdGlvblN0YXJ0Q2FwdHVyZSIsICJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgIm9uQ29tcG9zaXRpb25VcGRhdGVDYXB0dXJlIiwgIm9uRm9jdXMiLCAib25Gb2N1c0NhcHR1cmUiLCAib25CbHVyIiwgIm9uQmx1ckNhcHR1cmUiLCAib25DaGFuZ2UiLCAib25DaGFuZ2VDYXB0dXJlIiwgIm9uQmVmb3JlSW5wdXQiLCAib25CZWZvcmVJbnB1dENhcHR1cmUiLCAib25JbnB1dCIsICJvbklucHV0Q2FwdHVyZSIsICJvblJlc2V0IiwgIm9uUmVzZXRDYXB0dXJlIiwgIm9uU3VibWl0IiwgIm9uU3VibWl0Q2FwdHVyZSIsICJvbkludmFsaWQiLCAib25JbnZhbGlkQ2FwdHVyZSIsICJvbkxvYWQiLCAib25Mb2FkQ2FwdHVyZSIsICJvbkVycm9yIiwgIm9uRXJyb3JDYXB0dXJlIiwgIm9uS2V5RG93biIsICJvbktleURvd25DYXB0dXJlIiwgIm9uS2V5UHJlc3MiLCAib25LZXlQcmVzc0NhcHR1cmUiLCAib25LZXlVcCIsICJvbktleVVwQ2FwdHVyZSIsICJvbkFib3J0IiwgIm9uQWJvcnRDYXB0dXJlIiwgIm9uQ2FuUGxheSIsICJvbkNhblBsYXlDYXB0dXJlIiwgIm9uQ2FuUGxheVRocm91Z2giLCAib25DYW5QbGF5VGhyb3VnaENhcHR1cmUiLCAib25EdXJhdGlvbkNoYW5nZSIsICJvbkR1cmF0aW9uQ2hhbmdlQ2FwdHVyZSIsICJvbkVtcHRpZWQiLCAib25FbXB0aWVkQ2FwdHVyZSIsICJvbkVuY3J5cHRlZCIsICJvbkVuY3J5cHRlZENhcHR1cmUiLCAib25FbmRlZCIsICJvbkVuZGVkQ2FwdHVyZSIsICJvbkxvYWRlZERhdGEiLCAib25Mb2FkZWREYXRhQ2FwdHVyZSIsICJvbkxvYWRlZE1ldGFkYXRhIiwgIm9uTG9hZGVkTWV0YWRhdGFDYXB0dXJlIiwgIm9uTG9hZFN0YXJ0IiwgIm9uTG9hZFN0YXJ0Q2FwdHVyZSIsICJvblBhdXNlIiwgIm9uUGF1c2VDYXB0dXJlIiwgIm9uUGxheSIsICJvblBsYXlDYXB0dXJlIiwgIm9uUGxheWluZyIsICJvblBsYXlpbmdDYXB0dXJlIiwgIm9uUHJvZ3Jlc3MiLCAib25Qcm9ncmVzc0NhcHR1cmUiLCAib25SYXRlQ2hhbmdlIiwgIm9uUmF0ZUNoYW5nZUNhcHR1cmUiLCAib25TZWVrZWQiLCAib25TZWVrZWRDYXB0dXJlIiwgIm9uU2Vla2luZyIsICJvblNlZWtpbmdDYXB0dXJlIiwgIm9uU3RhbGxlZCIsICJvblN0YWxsZWRDYXB0dXJlIiwgIm9uU3VzcGVuZCIsICJvblN1c3BlbmRDYXB0dXJlIiwgIm9uVGltZVVwZGF0ZSIsICJvblRpbWVVcGRhdGVDYXB0dXJlIiwgIm9uVm9sdW1lQ2hhbmdlIiwgIm9uVm9sdW1lQ2hhbmdlQ2FwdHVyZSIsICJvbldhaXRpbmciLCAib25XYWl0aW5nQ2FwdHVyZSIsICJvbkF1eENsaWNrIiwgIm9uQXV4Q2xpY2tDYXB0dXJlIiwgIm9uQ2xpY2siLCAib25DbGlja0NhcHR1cmUiLCAib25Db250ZXh0TWVudSIsICJvbkNvbnRleHRNZW51Q2FwdHVyZSIsICJvbkRvdWJsZUNsaWNrIiwgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIiwgIm9uRHJhZyIsICJvbkRyYWdDYXB0dXJlIiwgIm9uRHJhZ0VuZCIsICJvbkRyYWdFbmRDYXB0dXJlIiwgIm9uRHJhZ0VudGVyIiwgIm9uRHJhZ0VudGVyQ2FwdHVyZSIsICJvbkRyYWdFeGl0IiwgIm9uRHJhZ0V4aXRDYXB0dXJlIiwgIm9uRHJhZ0xlYXZlIiwgIm9uRHJhZ0xlYXZlQ2FwdHVyZSIsICJvbkRyYWdPdmVyIiwgIm9uRHJhZ092ZXJDYXB0dXJlIiwgIm9uRHJhZ1N0YXJ0IiwgIm9uRHJhZ1N0YXJ0Q2FwdHVyZSIsICJvbkRyb3AiLCAib25Ecm9wQ2FwdHVyZSIsICJvbk1vdXNlRG93biIsICJvbk1vdXNlRG93bkNhcHR1cmUiLCAib25Nb3VzZUVudGVyIiwgIm9uTW91c2VMZWF2ZSIsICJvbk1vdXNlTW92ZSIsICJvbk1vdXNlTW92ZUNhcHR1cmUiLCAib25Nb3VzZU91dCIsICJvbk1vdXNlT3V0Q2FwdHVyZSIsICJvbk1vdXNlT3ZlciIsICJvbk1vdXNlT3ZlckNhcHR1cmUiLCAib25Nb3VzZVVwIiwgIm9uTW91c2VVcENhcHR1cmUiLCAib25TZWxlY3QiLCAib25TZWxlY3RDYXB0dXJlIiwgIm9uVG91Y2hDYW5jZWwiLCAib25Ub3VjaENhbmNlbENhcHR1cmUiLCAib25Ub3VjaEVuZCIsICJvblRvdWNoRW5kQ2FwdHVyZSIsICJvblRvdWNoTW92ZSIsICJvblRvdWNoTW92ZUNhcHR1cmUiLCAib25Ub3VjaFN0YXJ0IiwgIm9uVG91Y2hTdGFydENhcHR1cmUiLCAib25Qb2ludGVyRG93biIsICJvblBvaW50ZXJEb3duQ2FwdHVyZSIsICJvblBvaW50ZXJNb3ZlIiwgIm9uUG9pbnRlck1vdmVDYXB0dXJlIiwgIm9uUG9pbnRlclVwIiwgIm9uUG9pbnRlclVwQ2FwdHVyZSIsICJvblBvaW50ZXJDYW5jZWwiLCAib25Qb2ludGVyQ2FuY2VsQ2FwdHVyZSIsICJvblBvaW50ZXJFbnRlciIsICJvblBvaW50ZXJFbnRlckNhcHR1cmUiLCAib25Qb2ludGVyTGVhdmUiLCAib25Qb2ludGVyTGVhdmVDYXB0dXJlIiwgIm9uUG9pbnRlck92ZXIiLCAib25Qb2ludGVyT3ZlckNhcHR1cmUiLCAib25Qb2ludGVyT3V0IiwgIm9uUG9pbnRlck91dENhcHR1cmUiLCAib25Hb3RQb2ludGVyQ2FwdHVyZSIsICJvbkdvdFBvaW50ZXJDYXB0dXJlQ2FwdHVyZSIsICJvbkxvc3RQb2ludGVyQ2FwdHVyZSIsICJvbkxvc3RQb2ludGVyQ2FwdHVyZUNhcHR1cmUiLCAib25TY3JvbGwiLCAib25TY3JvbGxDYXB0dXJlIiwgIm9uV2hlZWwiLCAib25XaGVlbENhcHR1cmUiLCAib25BbmltYXRpb25TdGFydCIsICJvbkFuaW1hdGlvblN0YXJ0Q2FwdHVyZSIsICJvbkFuaW1hdGlvbkVuZCIsICJvbkFuaW1hdGlvbkVuZENhcHR1cmUiLCAib25BbmltYXRpb25JdGVyYXRpb24iLCAib25BbmltYXRpb25JdGVyYXRpb25DYXB0dXJlIiwgIm9uVHJhbnNpdGlvbkVuZCIsICJvblRyYW5zaXRpb25FbmRDYXB0dXJlIl07CmZ1bmN0aW9uIGlzRXZlbnRLZXkoa2V5KSB7CiAgaWYgKHR5cGVvZiBrZXkgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBhbGxvd2VkRXZlbnRLZXlzID0gRXZlbnRLZXlzOwogIHJldHVybiBhbGxvd2VkRXZlbnRLZXlzLmluY2x1ZGVzKGtleSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zdmdQcm9wZXJ0aWVzTm9FdmVudHMuanMKdmFyIGltcG9ydF9yZWFjdDMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBTVkdFbGVtZW50UHJvcEtleXMgPSBbCiAgImFyaWEtYWN0aXZlZGVzY2VuZGFudCIsCiAgImFyaWEtYXRvbWljIiwKICAiYXJpYS1hdXRvY29tcGxldGUiLAogICJhcmlhLWJ1c3kiLAogICJhcmlhLWNoZWNrZWQiLAogICJhcmlhLWNvbGNvdW50IiwKICAiYXJpYS1jb2xpbmRleCIsCiAgImFyaWEtY29sc3BhbiIsCiAgImFyaWEtY29udHJvbHMiLAogICJhcmlhLWN1cnJlbnQiLAogICJhcmlhLWRlc2NyaWJlZGJ5IiwKICAiYXJpYS1kZXRhaWxzIiwKICAiYXJpYS1kaXNhYmxlZCIsCiAgImFyaWEtZXJyb3JtZXNzYWdlIiwKICAiYXJpYS1leHBhbmRlZCIsCiAgImFyaWEtZmxvd3RvIiwKICAiYXJpYS1oYXNwb3B1cCIsCiAgImFyaWEtaGlkZGVuIiwKICAiYXJpYS1pbnZhbGlkIiwKICAiYXJpYS1rZXlzaG9ydGN1dHMiLAogICJhcmlhLWxhYmVsIiwKICAiYXJpYS1sYWJlbGxlZGJ5IiwKICAiYXJpYS1sZXZlbCIsCiAgImFyaWEtbGl2ZSIsCiAgImFyaWEtbW9kYWwiLAogICJhcmlhLW11bHRpbGluZSIsCiAgImFyaWEtbXVsdGlzZWxlY3RhYmxlIiwKICAiYXJpYS1vcmllbnRhdGlvbiIsCiAgImFyaWEtb3ducyIsCiAgImFyaWEtcGxhY2Vob2xkZXIiLAogICJhcmlhLXBvc2luc2V0IiwKICAiYXJpYS1wcmVzc2VkIiwKICAiYXJpYS1yZWFkb25seSIsCiAgImFyaWEtcmVsZXZhbnQiLAogICJhcmlhLXJlcXVpcmVkIiwKICAiYXJpYS1yb2xlZGVzY3JpcHRpb24iLAogICJhcmlhLXJvd2NvdW50IiwKICAiYXJpYS1yb3dpbmRleCIsCiAgImFyaWEtcm93c3BhbiIsCiAgImFyaWEtc2VsZWN0ZWQiLAogICJhcmlhLXNldHNpemUiLAogICJhcmlhLXNvcnQiLAogICJhcmlhLXZhbHVlbWF4IiwKICAiYXJpYS12YWx1ZW1pbiIsCiAgImFyaWEtdmFsdWVub3ciLAogICJhcmlhLXZhbHVldGV4dCIsCiAgImNsYXNzTmFtZSIsCiAgImNvbG9yIiwKICAiaGVpZ2h0IiwKICAiaWQiLAogICJsYW5nIiwKICAibWF4IiwKICAibWVkaWEiLAogICJtZXRob2QiLAogICJtaW4iLAogICJuYW1lIiwKICAic3R5bGUiLAogIC8qCiAgICogcmVtb3ZlZCAndHlwZScgU1ZHRWxlbWVudFByb3BLZXkgYmVjYXVzZSB3ZSBkbyBub3QgY3VycmVudGx5IHVzZSBhbnkgU1ZHIGVsZW1lbnRzCiAgICogdGhhdCBjYW4gdXNlIGl0LCBhbmQgaXQgY29uZmxpY3RzIHdpdGggdGhlIHJlY2hhcnRzIHByb3AgJ3R5cGUnCiAgICogaHR0cHM6Ly9naXRodWIuY29tL3JlY2hhcnRzL3JlY2hhcnRzL3B1bGwvMzMyNwogICAqIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL1NWRy9BdHRyaWJ1dGUvdHlwZQogICAqLwogIC8vICd0eXBlJywKICAidGFyZ2V0IiwKICAid2lkdGgiLAogICJyb2xlIiwKICAidGFiSW5kZXgiLAogICJhY2NlbnRIZWlnaHQiLAogICJhY2N1bXVsYXRlIiwKICAiYWRkaXRpdmUiLAogICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgImFsbG93UmVvcmRlciIsCiAgImFscGhhYmV0aWMiLAogICJhbXBsaXR1ZGUiLAogICJhcmFiaWNGb3JtIiwKICAiYXNjZW50IiwKICAiYXR0cmlidXRlTmFtZSIsCiAgImF0dHJpYnV0ZVR5cGUiLAogICJhdXRvUmV2ZXJzZSIsCiAgImF6aW11dGgiLAogICJiYXNlRnJlcXVlbmN5IiwKICAiYmFzZWxpbmVTaGlmdCIsCiAgImJhc2VQcm9maWxlIiwKICAiYmJveCIsCiAgImJlZ2luIiwKICAiYmlhcyIsCiAgImJ5IiwKICAiY2FsY01vZGUiLAogICJjYXBIZWlnaHQiLAogICJjbGlwIiwKICAiY2xpcFBhdGgiLAogICJjbGlwUGF0aFVuaXRzIiwKICAiY2xpcFJ1bGUiLAogICJjb2xvckludGVycG9sYXRpb24iLAogICJjb2xvckludGVycG9sYXRpb25GaWx0ZXJzIiwKICAiY29sb3JQcm9maWxlIiwKICAiY29sb3JSZW5kZXJpbmciLAogICJjb250ZW50U2NyaXB0VHlwZSIsCiAgImNvbnRlbnRTdHlsZVR5cGUiLAogICJjdXJzb3IiLAogICJjeCIsCiAgImN5IiwKICAiZCIsCiAgImRlY2VsZXJhdGUiLAogICJkZXNjZW50IiwKICAiZGlmZnVzZUNvbnN0YW50IiwKICAiZGlyZWN0aW9uIiwKICAiZGlzcGxheSIsCiAgImRpdmlzb3IiLAogICJkb21pbmFudEJhc2VsaW5lIiwKICAiZHVyIiwKICAiZHgiLAogICJkeSIsCiAgImVkZ2VNb2RlIiwKICAiZWxldmF0aW9uIiwKICAiZW5hYmxlQmFja2dyb3VuZCIsCiAgImVuZCIsCiAgImV4cG9uZW50IiwKICAiZXh0ZXJuYWxSZXNvdXJjZXNSZXF1aXJlZCIsCiAgImZpbGwiLAogICJmaWxsT3BhY2l0eSIsCiAgImZpbGxSdWxlIiwKICAiZmlsdGVyIiwKICAiZmlsdGVyUmVzIiwKICAiZmlsdGVyVW5pdHMiLAogICJmbG9vZENvbG9yIiwKICAiZmxvb2RPcGFjaXR5IiwKICAiZm9jdXNhYmxlIiwKICAiZm9udEZhbWlseSIsCiAgImZvbnRTaXplIiwKICAiZm9udFNpemVBZGp1c3QiLAogICJmb250U3RyZXRjaCIsCiAgImZvbnRTdHlsZSIsCiAgImZvbnRWYXJpYW50IiwKICAiZm9udFdlaWdodCIsCiAgImZvcm1hdCIsCiAgImZyb20iLAogICJmeCIsCiAgImZ5IiwKICAiZzEiLAogICJnMiIsCiAgImdseXBoTmFtZSIsCiAgImdseXBoT3JpZW50YXRpb25Ib3Jpem9udGFsIiwKICAiZ2x5cGhPcmllbnRhdGlvblZlcnRpY2FsIiwKICAiZ2x5cGhSZWYiLAogICJncmFkaWVudFRyYW5zZm9ybSIsCiAgImdyYWRpZW50VW5pdHMiLAogICJoYW5naW5nIiwKICAiaG9yaXpBZHZYIiwKICAiaG9yaXpPcmlnaW5YIiwKICAiaHJlZiIsCiAgImlkZW9ncmFwaGljIiwKICAiaW1hZ2VSZW5kZXJpbmciLAogICJpbjIiLAogICJpbiIsCiAgImludGVyY2VwdCIsCiAgImsxIiwKICAiazIiLAogICJrMyIsCiAgIms0IiwKICAiayIsCiAgImtlcm5lbE1hdHJpeCIsCiAgImtlcm5lbFVuaXRMZW5ndGgiLAogICJrZXJuaW5nIiwKICAia2V5UG9pbnRzIiwKICAia2V5U3BsaW5lcyIsCiAgImtleVRpbWVzIiwKICAibGVuZ3RoQWRqdXN0IiwKICAibGV0dGVyU3BhY2luZyIsCiAgImxpZ2h0aW5nQ29sb3IiLAogICJsaW1pdGluZ0NvbmVBbmdsZSIsCiAgImxvY2FsIiwKICAibWFya2VyRW5kIiwKICAibWFya2VySGVpZ2h0IiwKICAibWFya2VyTWlkIiwKICAibWFya2VyU3RhcnQiLAogICJtYXJrZXJVbml0cyIsCiAgIm1hcmtlcldpZHRoIiwKICAibWFzayIsCiAgIm1hc2tDb250ZW50VW5pdHMiLAogICJtYXNrVW5pdHMiLAogICJtYXRoZW1hdGljYWwiLAogICJtb2RlIiwKICAibnVtT2N0YXZlcyIsCiAgIm9mZnNldCIsCiAgIm9wYWNpdHkiLAogICJvcGVyYXRvciIsCiAgIm9yZGVyIiwKICAib3JpZW50IiwKICAib3JpZW50YXRpb24iLAogICJvcmlnaW4iLAogICJvdmVyZmxvdyIsCiAgIm92ZXJsaW5lUG9zaXRpb24iLAogICJvdmVybGluZVRoaWNrbmVzcyIsCiAgInBhaW50T3JkZXIiLAogICJwYW5vc2UxIiwKICAicGF0aExlbmd0aCIsCiAgInBhdHRlcm5Db250ZW50VW5pdHMiLAogICJwYXR0ZXJuVHJhbnNmb3JtIiwKICAicGF0dGVyblVuaXRzIiwKICAicG9pbnRlckV2ZW50cyIsCiAgInBvaW50c0F0WCIsCiAgInBvaW50c0F0WSIsCiAgInBvaW50c0F0WiIsCiAgInByZXNlcnZlQWxwaGEiLAogICJwcmVzZXJ2ZUFzcGVjdFJhdGlvIiwKICAicHJpbWl0aXZlVW5pdHMiLAogICJyIiwKICAicmFkaXVzIiwKICAicmVmWCIsCiAgInJlZlkiLAogICJyZW5kZXJpbmdJbnRlbnQiLAogICJyZXBlYXRDb3VudCIsCiAgInJlcGVhdER1ciIsCiAgInJlcXVpcmVkRXh0ZW5zaW9ucyIsCiAgInJlcXVpcmVkRmVhdHVyZXMiLAogICJyZXN0YXJ0IiwKICAicmVzdWx0IiwKICAicm90YXRlIiwKICAicngiLAogICJyeSIsCiAgInNlZWQiLAogICJzaGFwZVJlbmRlcmluZyIsCiAgInNsb3BlIiwKICAic3BhY2luZyIsCiAgInNwZWN1bGFyQ29uc3RhbnQiLAogICJzcGVjdWxhckV4cG9uZW50IiwKICAic3BlZWQiLAogICJzcHJlYWRNZXRob2QiLAogICJzdGFydE9mZnNldCIsCiAgInN0ZERldmlhdGlvbiIsCiAgInN0ZW1oIiwKICAic3RlbXYiLAogICJzdGl0Y2hUaWxlcyIsCiAgInN0b3BDb2xvciIsCiAgInN0b3BPcGFjaXR5IiwKICAic3RyaWtldGhyb3VnaFBvc2l0aW9uIiwKICAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgInN0cmluZyIsCiAgInN0cm9rZSIsCiAgInN0cm9rZURhc2hhcnJheSIsCiAgInN0cm9rZURhc2hvZmZzZXQiLAogICJzdHJva2VMaW5lY2FwIiwKICAic3Ryb2tlTGluZWpvaW4iLAogICJzdHJva2VNaXRlcmxpbWl0IiwKICAic3Ryb2tlT3BhY2l0eSIsCiAgInN0cm9rZVdpZHRoIiwKICAic3VyZmFjZVNjYWxlIiwKICAic3lzdGVtTGFuZ3VhZ2UiLAogICJ0YWJsZVZhbHVlcyIsCiAgInRhcmdldFgiLAogICJ0YXJnZXRZIiwKICAidGV4dEFuY2hvciIsCiAgInRleHREZWNvcmF0aW9uIiwKICAidGV4dExlbmd0aCIsCiAgInRleHRSZW5kZXJpbmciLAogICJ0byIsCiAgInRyYW5zZm9ybSIsCiAgInUxIiwKICAidTIiLAogICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgInVuZGVybGluZVRoaWNrbmVzcyIsCiAgInVuaWNvZGUiLAogICJ1bmljb2RlQmlkaSIsCiAgInVuaWNvZGVSYW5nZSIsCiAgInVuaXRzUGVyRW0iLAogICJ2QWxwaGFiZXRpYyIsCiAgInZhbHVlcyIsCiAgInZlY3RvckVmZmVjdCIsCiAgInZlcnNpb24iLAogICJ2ZXJ0QWR2WSIsCiAgInZlcnRPcmlnaW5YIiwKICAidmVydE9yaWdpblkiLAogICJ2SGFuZ2luZyIsCiAgInZJZGVvZ3JhcGhpYyIsCiAgInZpZXdUYXJnZXQiLAogICJ2aXNpYmlsaXR5IiwKICAidk1hdGhlbWF0aWNhbCIsCiAgIndpZHRocyIsCiAgIndvcmRTcGFjaW5nIiwKICAid3JpdGluZ01vZGUiLAogICJ4MSIsCiAgIngyIiwKICAieCIsCiAgInhDaGFubmVsU2VsZWN0b3IiLAogICJ4SGVpZ2h0IiwKICAieGxpbmtBY3R1YXRlIiwKICAieGxpbmtBcmNyb2xlIiwKICAieGxpbmtIcmVmIiwKICAieGxpbmtSb2xlIiwKICAieGxpbmtTaG93IiwKICAieGxpbmtUaXRsZSIsCiAgInhsaW5rVHlwZSIsCiAgInhtbEJhc2UiLAogICJ4bWxMYW5nIiwKICAieG1sbnMiLAogICJ4bWxuc1hsaW5rIiwKICAieG1sU3BhY2UiLAogICJ5MSIsCiAgInkyIiwKICAieSIsCiAgInlDaGFubmVsU2VsZWN0b3IiLAogICJ6IiwKICAiem9vbUFuZFBhbiIsCiAgInJlZiIsCiAgImtleSIsCiAgImFuZ2xlIgpdOwp2YXIgU1ZHRWxlbWVudFByb3BLZXlTZXQgPSBuZXcgU2V0KFNWR0VsZW1lbnRQcm9wS2V5cyk7CmZ1bmN0aW9uIGlzU3ZnRWxlbWVudFByb3BLZXkoa2V5KSB7CiAgaWYgKHR5cGVvZiBrZXkgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiBTVkdFbGVtZW50UHJvcEtleVNldC5oYXMoa2V5KTsKfQpmdW5jdGlvbiBpc0RhdGFBdHRyaWJ1dGUoa2V5KSB7CiAgcmV0dXJuIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICYmIGtleS5zdGFydHNXaXRoKCJkYXRhLSIpOwp9CmZ1bmN0aW9uIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhvYmopIHsKICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIgfHwgb2JqID09PSBudWxsKSB7CiAgICByZXR1cm4ge307CiAgfQogIHZhciByZXN1bHQgPSB7fTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgewogICAgICBpZiAoaXNTdmdFbGVtZW50UHJvcEtleShrZXkpIHx8IGlzRGF0YUF0dHJpYnV0ZShrZXkpKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSBvYmpba2V5XTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKGlucHV0KSB7CiAgaWYgKGlucHV0ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzLmlzVmFsaWRFbGVtZW50KShpbnB1dCkgJiYgdHlwZW9mIGlucHV0LnByb3BzID09PSAib2JqZWN0IiAmJiBpbnB1dC5wcm9wcyAhPT0gbnVsbCkgewogICAgdmFyIHAgPSBpbnB1dC5wcm9wczsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocCk7CiAgfQogIGlmICh0eXBlb2YgaW5wdXQgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KGlucHV0KSkgewogICAgcmV0dXJuIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhpbnB1dCk7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc0FuZEV2ZW50cy5qcwpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKG9iaikgewogIHZhciByZXN1bHQgPSB7fTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgewogICAgICBpZiAoaXNTdmdFbGVtZW50UHJvcEtleShrZXkpIHx8IGlzRGF0YUF0dHJpYnV0ZShrZXkpIHx8IGlzRXZlbnRLZXkoa2V5KSkgewogICAgICAgIHJlc3VsdFtrZXldID0gb2JqW2tleV07CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzRnJvbVVua25vd24oaW5wdXQpIHsKICBpZiAoaW5wdXQgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQuaXNWYWxpZEVsZW1lbnQpKGlucHV0KSkgewogICAgcmV0dXJuIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMoaW5wdXQucHJvcHMpOwogIH0KICBpZiAodHlwZW9mIGlucHV0ID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShpbnB1dCkpIHsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKGlucHV0KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1N1cmZhY2UuanMKdmFyIF9leGNsdWRlZCA9IFsiY2hpbGRyZW4iLCAid2lkdGgiLCAiaGVpZ2h0IiwgInZpZXdCb3giLCAiY2xhc3NOYW1lIiwgInN0eWxlIiwgInRpdGxlIiwgImRlc2MiXTsKZnVuY3Rpb24gX2V4dGVuZHMoKSB7CiAgcmV0dXJuIF9leHRlbmRzID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgU3VyZmFjZSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NS5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgdmlld0JveCwKICAgIGNsYXNzTmFtZSwKICAgIHN0eWxlLAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMocHJvcHMsIF9leGNsdWRlZCk7CiAgdmFyIHN2Z1ZpZXcgPSB2aWV3Qm94IHx8IHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgeDogMCwKICAgIHk6IDAKICB9OwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtc3VyZmFjZSIsIGNsYXNzTmFtZSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdC5jcmVhdGVFbGVtZW50KCJzdmciLCBfZXh0ZW5kcyh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvdGhlcnMpLCB7CiAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHN0eWxlLAogICAgdmlld0JveDogIiIuY29uY2F0KHN2Z1ZpZXcueCwgIiAiKS5jb25jYXQoc3ZnVmlldy55LCAiICIpLmNvbmNhdChzdmdWaWV3LndpZHRoLCAiICIpLmNvbmNhdChzdmdWaWV3LmhlaWdodCksCiAgICByZWYKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0LmNyZWF0ZUVsZW1lbnQoInRpdGxlIiwgbnVsbCwgdGl0bGUpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QuY3JlYXRlRWxlbWVudCgiZGVzYyIsIG51bGwsIGRlc2MpLCBjaGlsZHJlbik7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvTGF5ZXIuanMKdmFyIFJlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9leGNsdWRlZDIgPSBbImNoaWxkcmVuIiwgImNsYXNzTmFtZSJdOwpmdW5jdGlvbiBfZXh0ZW5kczIoKSB7CiAgcmV0dXJuIF9leHRlbmRzMiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczIoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTIoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTIocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBMYXllciA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIuZm9yd2FyZFJlZigocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wcywgb3RoZXJzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMihwcm9wcywgX2V4Y2x1ZGVkMik7CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1sYXllciIsIGNsYXNzTmFtZSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIuY3JlYXRlRWxlbWVudCgiZyIsIF9leHRlbmRzMih7CiAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MKICB9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKG90aGVycyksIHsKICAgIHJlZgogIH0pLCBjaGlsZHJlbik7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2xlZ2VuZFBvcnRhbENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBMZWdlbmRQb3J0YWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q2LmNyZWF0ZUNvbnRleHQpKG51bGwpOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jb25zdGFudC5qcwpmdW5jdGlvbiBjb25zdGFudF9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbnN0YW50KCkgewogICAgcmV0dXJuIHgyOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1wYXRoL3NyYy9wYXRoLmpzCnZhciBwaSA9IE1hdGguUEk7CnZhciB0YXUgPSAyICogcGk7CnZhciBlcHNpbG9uID0gMWUtNjsKdmFyIHRhdUVwc2lsb24gPSB0YXUgLSBlcHNpbG9uOwpmdW5jdGlvbiBhcHBlbmQoc3RyaW5ncykgewogIHRoaXMuXyArPSBzdHJpbmdzWzBdOwogIGZvciAobGV0IGkgPSAxLCBuID0gc3RyaW5ncy5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgIHRoaXMuXyArPSBhcmd1bWVudHNbaV0gKyBzdHJpbmdzW2ldOwogIH0KfQpmdW5jdGlvbiBhcHBlbmRSb3VuZChkaWdpdHMpIHsKICBsZXQgZCA9IE1hdGguZmxvb3IoZGlnaXRzKTsKICBpZiAoIShkID49IDApKSB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgZGlnaXRzOiAke2RpZ2l0c31gKTsKICBpZiAoZCA+IDE1KSByZXR1cm4gYXBwZW5kOwogIGNvbnN0IGsgPSAxMCAqKiBkOwogIHJldHVybiBmdW5jdGlvbihzdHJpbmdzKSB7CiAgICB0aGlzLl8gKz0gc3RyaW5nc1swXTsKICAgIGZvciAobGV0IGkgPSAxLCBuID0gc3RyaW5ncy5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgICAgdGhpcy5fICs9IE1hdGgucm91bmQoYXJndW1lbnRzW2ldICogaykgLyBrICsgc3RyaW5nc1tpXTsKICAgIH0KICB9Owp9CnZhciBQYXRoID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGRpZ2l0cykgewogICAgdGhpcy5feDAgPSB0aGlzLl95MCA9IC8vIHN0YXJ0IG9mIGN1cnJlbnQgc3VicGF0aAogICAgdGhpcy5feDEgPSB0aGlzLl95MSA9IG51bGw7CiAgICB0aGlzLl8gPSAiIjsKICAgIHRoaXMuX2FwcGVuZCA9IGRpZ2l0cyA9PSBudWxsID8gYXBwZW5kIDogYXBwZW5kUm91bmQoZGlnaXRzKTsKICB9CiAgbW92ZVRvKHgyLCB5MikgewogICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gwID0gdGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTAgPSB0aGlzLl95MSA9ICt5Mn1gOwogIH0KICBjbG9zZVBhdGgoKSB7CiAgICBpZiAodGhpcy5feDEgIT09IG51bGwpIHsKICAgICAgdGhpcy5feDEgPSB0aGlzLl94MCwgdGhpcy5feTEgPSB0aGlzLl95MDsKICAgICAgdGhpcy5fYXBwZW5kYFpgOwogICAgfQogIH0KICBsaW5lVG8oeDIsIHkyKSB7CiAgICB0aGlzLl9hcHBlbmRgTCR7dGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTEgPSAreTJ9YDsKICB9CiAgcXVhZHJhdGljQ3VydmVUbyh4MSwgeTEsIHgyLCB5MikgewogICAgdGhpcy5fYXBwZW5kYFEkeyt4MX0sJHsreTF9LCR7dGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTEgPSAreTJ9YDsKICB9CiAgYmV6aWVyQ3VydmVUbyh4MSwgeTEsIHgyLCB5MiwgeDMsIHkzKSB7CiAgICB0aGlzLl9hcHBlbmRgQyR7K3gxfSwkeyt5MX0sJHsreDJ9LCR7K3kyfSwke3RoaXMuX3gxID0gK3gzfSwke3RoaXMuX3kxID0gK3kzfWA7CiAgfQogIGFyY1RvKHgxLCB5MSwgeDIsIHkyLCByMikgewogICAgeDEgPSAreDEsIHkxID0gK3kxLCB4MiA9ICt4MiwgeTIgPSAreTIsIHIyID0gK3IyOwogICAgaWYgKHIyIDwgMCkgdGhyb3cgbmV3IEVycm9yKGBuZWdhdGl2ZSByYWRpdXM6ICR7cjJ9YCk7CiAgICBsZXQgeDAgPSB0aGlzLl94MSwgeTAgPSB0aGlzLl95MSwgeDIxID0geDIgLSB4MSwgeTIxID0geTIgLSB5MSwgeDAxID0geDAgLSB4MSwgeTAxID0geTAgLSB5MSwgbDAxXzIgPSB4MDEgKiB4MDEgKyB5MDEgKiB5MDE7CiAgICBpZiAodGhpcy5feDEgPT09IG51bGwpIHsKICAgICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gxID0geDF9LCR7dGhpcy5feTEgPSB5MX1gOwogICAgfSBlbHNlIGlmICghKGwwMV8yID4gZXBzaWxvbikpIDsKICAgIGVsc2UgaWYgKCEoTWF0aC5hYnMoeTAxICogeDIxIC0geTIxICogeDAxKSA+IGVwc2lsb24pIHx8ICFyMikgewogICAgICB0aGlzLl9hcHBlbmRgTCR7dGhpcy5feDEgPSB4MX0sJHt0aGlzLl95MSA9IHkxfWA7CiAgICB9IGVsc2UgewogICAgICBsZXQgeDIwID0geDIgLSB4MCwgeTIwID0geTIgLSB5MCwgbDIxXzIgPSB4MjEgKiB4MjEgKyB5MjEgKiB5MjEsIGwyMF8yID0geDIwICogeDIwICsgeTIwICogeTIwLCBsMjEgPSBNYXRoLnNxcnQobDIxXzIpLCBsMDEgPSBNYXRoLnNxcnQobDAxXzIpLCBsID0gcjIgKiBNYXRoLnRhbigocGkgLSBNYXRoLmFjb3MoKGwyMV8yICsgbDAxXzIgLSBsMjBfMikgLyAoMiAqIGwyMSAqIGwwMSkpKSAvIDIpLCB0MDEgPSBsIC8gbDAxLCB0MjEgPSBsIC8gbDIxOwogICAgICBpZiAoTWF0aC5hYnModDAxIC0gMSkgPiBlcHNpbG9uKSB7CiAgICAgICAgdGhpcy5fYXBwZW5kYEwke3gxICsgdDAxICogeDAxfSwke3kxICsgdDAxICogeTAxfWA7CiAgICAgIH0KICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLDAsJHsrKHkwMSAqIHgyMCA+IHgwMSAqIHkyMCl9LCR7dGhpcy5feDEgPSB4MSArIHQyMSAqIHgyMX0sJHt0aGlzLl95MSA9IHkxICsgdDIxICogeTIxfWA7CiAgICB9CiAgfQogIGFyYyh4MiwgeTIsIHIyLCBhMCwgYTEsIGNjdykgewogICAgeDIgPSAreDIsIHkyID0gK3kyLCByMiA9ICtyMiwgY2N3ID0gISFjY3c7CiAgICBpZiAocjIgPCAwKSB0aHJvdyBuZXcgRXJyb3IoYG5lZ2F0aXZlIHJhZGl1czogJHtyMn1gKTsKICAgIGxldCBkeCA9IHIyICogTWF0aC5jb3MoYTApLCBkeSA9IHIyICogTWF0aC5zaW4oYTApLCB4MCA9IHgyICsgZHgsIHkwID0geTIgKyBkeSwgY3cgPSAxIF4gY2N3LCBkYSA9IGNjdyA/IGEwIC0gYTEgOiBhMSAtIGEwOwogICAgaWYgKHRoaXMuX3gxID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBNJHt4MH0sJHt5MH1gOwogICAgfSBlbHNlIGlmIChNYXRoLmFicyh0aGlzLl94MSAtIHgwKSA+IGVwc2lsb24gfHwgTWF0aC5hYnModGhpcy5feTEgLSB5MCkgPiBlcHNpbG9uKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBMJHt4MH0sJHt5MH1gOwogICAgfQogICAgaWYgKCFyMikgcmV0dXJuOwogICAgaWYgKGRhIDwgMCkgZGEgPSBkYSAlIHRhdSArIHRhdTsKICAgIGlmIChkYSA+IHRhdUVwc2lsb24pIHsKICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLDEsJHtjd30sJHt4MiAtIGR4fSwke3kyIC0gZHl9QSR7cjJ9LCR7cjJ9LDAsMSwke2N3fSwke3RoaXMuX3gxID0geDB9LCR7dGhpcy5feTEgPSB5MH1gOwogICAgfSBlbHNlIGlmIChkYSA+IGVwc2lsb24pIHsKICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLCR7KyhkYSA+PSBwaSl9LCR7Y3d9LCR7dGhpcy5feDEgPSB4MiArIHIyICogTWF0aC5jb3MoYTEpfSwke3RoaXMuX3kxID0geTIgKyByMiAqIE1hdGguc2luKGExKX1gOwogICAgfQogIH0KICByZWN0KHgyLCB5MiwgdywgaCkgewogICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gwID0gdGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTAgPSB0aGlzLl95MSA9ICt5Mn1oJHt3ID0gK3d9diR7K2h9aCR7LXd9WmA7CiAgfQogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuXzsKICB9Cn07CmZ1bmN0aW9uIHBhdGgoKSB7CiAgcmV0dXJuIG5ldyBQYXRoKCk7Cn0KcGF0aC5wcm90b3R5cGUgPSBQYXRoLnByb3RvdHlwZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvcGF0aC5qcwpmdW5jdGlvbiB3aXRoUGF0aChzaGFwZSkgewogIGxldCBkaWdpdHMgPSAzOwogIHNoYXBlLmRpZ2l0cyA9IGZ1bmN0aW9uKF8pIHsKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGRpZ2l0czsKICAgIGlmIChfID09IG51bGwpIHsKICAgICAgZGlnaXRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGQgPSBNYXRoLmZsb29yKF8pOwogICAgICBpZiAoIShkID49IDApKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcihgaW52YWxpZCBkaWdpdHM6ICR7X31gKTsKICAgICAgZGlnaXRzID0gZDsKICAgIH0KICAgIHJldHVybiBzaGFwZTsKICB9OwogIHJldHVybiAoKSA9PiBuZXcgUGF0aChkaWdpdHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2FycmF5LmpzCnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKZnVuY3Rpb24gYXJyYXlfZGVmYXVsdCh4MikgewogIHJldHVybiB0eXBlb2YgeDIgPT09ICJvYmplY3QiICYmICJsZW5ndGgiIGluIHgyID8geDIgOiBBcnJheS5mcm9tKHgyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9saW5lYXIuanMKZnVuY3Rpb24gTGluZWFyKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpMaW5lYXIucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQp9OwpmdW5jdGlvbiBsaW5lYXJfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBMaW5lYXIoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvcG9pbnQuanMKZnVuY3Rpb24geChwKSB7CiAgcmV0dXJuIHBbMF07Cn0KZnVuY3Rpb24geShwKSB7CiAgcmV0dXJuIHBbMV07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvbGluZS5qcwpmdW5jdGlvbiBsaW5lX2RlZmF1bHQoeDIsIHkyKSB7CiAgdmFyIGRlZmluZWQyID0gY29uc3RhbnRfZGVmYXVsdCh0cnVlKSwgY29udGV4dCA9IG51bGwsIGN1cnZlID0gbGluZWFyX2RlZmF1bHQsIG91dHB1dCA9IG51bGwsIHBhdGgyID0gd2l0aFBhdGgobGluZSk7CiAgeDIgPSB0eXBlb2YgeDIgPT09ICJmdW5jdGlvbiIgPyB4MiA6IHgyID09PSB2b2lkIDAgPyB4IDogY29uc3RhbnRfZGVmYXVsdCh4Mik7CiAgeTIgPSB0eXBlb2YgeTIgPT09ICJmdW5jdGlvbiIgPyB5MiA6IHkyID09PSB2b2lkIDAgPyB5IDogY29uc3RhbnRfZGVmYXVsdCh5Mik7CiAgZnVuY3Rpb24gbGluZShkYXRhKSB7CiAgICB2YXIgaSwgbiA9IChkYXRhID0gYXJyYXlfZGVmYXVsdChkYXRhKSkubGVuZ3RoLCBkLCBkZWZpbmVkMCA9IGZhbHNlLCBidWZmZXI7CiAgICBpZiAoY29udGV4dCA9PSBudWxsKSBvdXRwdXQgPSBjdXJ2ZShidWZmZXIgPSBwYXRoMigpKTsKICAgIGZvciAoaSA9IDA7IGkgPD0gbjsgKytpKSB7CiAgICAgIGlmICghKGkgPCBuICYmIGRlZmluZWQyKGQgPSBkYXRhW2ldLCBpLCBkYXRhKSkgPT09IGRlZmluZWQwKSB7CiAgICAgICAgaWYgKGRlZmluZWQwID0gIWRlZmluZWQwKSBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgZWxzZSBvdXRwdXQubGluZUVuZCgpOwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkMCkgb3V0cHV0LnBvaW50KCt4MihkLCBpLCBkYXRhKSwgK3kyKGQsIGksIGRhdGEpKTsKICAgIH0KICAgIGlmIChidWZmZXIpIHJldHVybiBvdXRwdXQgPSBudWxsLCBidWZmZXIgKyAiIiB8fCBudWxsOwogIH0KICBsaW5lLnggPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBsaW5lKSA6IHgyOwogIH07CiAgbGluZS55ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeTIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgbGluZSkgOiB5MjsKICB9OwogIGxpbmUuZGVmaW5lZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRlZmluZWQyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCghIV8pLCBsaW5lKSA6IGRlZmluZWQyOwogIH07CiAgbGluZS5jdXJ2ZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGN1cnZlID0gXywgY29udGV4dCAhPSBudWxsICYmIChvdXRwdXQgPSBjdXJ2ZShjb250ZXh0KSksIGxpbmUpIDogY3VydmU7CiAgfTsKICBsaW5lLmNvbnRleHQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChfID09IG51bGwgPyBjb250ZXh0ID0gb3V0cHV0ID0gbnVsbCA6IG91dHB1dCA9IGN1cnZlKGNvbnRleHQgPSBfKSwgbGluZSkgOiBjb250ZXh0OwogIH07CiAgcmV0dXJuIGxpbmU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvYXJlYS5qcwpmdW5jdGlvbiBhcmVhX2RlZmF1bHQoeDAsIHkwLCB5MSkgewogIHZhciB4MSA9IG51bGwsIGRlZmluZWQyID0gY29uc3RhbnRfZGVmYXVsdCh0cnVlKSwgY29udGV4dCA9IG51bGwsIGN1cnZlID0gbGluZWFyX2RlZmF1bHQsIG91dHB1dCA9IG51bGwsIHBhdGgyID0gd2l0aFBhdGgoYXJlYSk7CiAgeDAgPSB0eXBlb2YgeDAgPT09ICJmdW5jdGlvbiIgPyB4MCA6IHgwID09PSB2b2lkIDAgPyB4IDogY29uc3RhbnRfZGVmYXVsdCgreDApOwogIHkwID0gdHlwZW9mIHkwID09PSAiZnVuY3Rpb24iID8geTAgOiB5MCA9PT0gdm9pZCAwID8gY29uc3RhbnRfZGVmYXVsdCgwKSA6IGNvbnN0YW50X2RlZmF1bHQoK3kwKTsKICB5MSA9IHR5cGVvZiB5MSA9PT0gImZ1bmN0aW9uIiA/IHkxIDogeTEgPT09IHZvaWQgMCA/IHkgOiBjb25zdGFudF9kZWZhdWx0KCt5MSk7CiAgZnVuY3Rpb24gYXJlYShkYXRhKSB7CiAgICB2YXIgaSwgaiwgaywgbiA9IChkYXRhID0gYXJyYXlfZGVmYXVsdChkYXRhKSkubGVuZ3RoLCBkLCBkZWZpbmVkMCA9IGZhbHNlLCBidWZmZXIsIHgweiA9IG5ldyBBcnJheShuKSwgeTB6ID0gbmV3IEFycmF5KG4pOwogICAgaWYgKGNvbnRleHQgPT0gbnVsbCkgb3V0cHV0ID0gY3VydmUoYnVmZmVyID0gcGF0aDIoKSk7CiAgICBmb3IgKGkgPSAwOyBpIDw9IG47ICsraSkgewogICAgICBpZiAoIShpIDwgbiAmJiBkZWZpbmVkMihkID0gZGF0YVtpXSwgaSwgZGF0YSkpID09PSBkZWZpbmVkMCkgewogICAgICAgIGlmIChkZWZpbmVkMCA9ICFkZWZpbmVkMCkgewogICAgICAgICAgaiA9IGk7CiAgICAgICAgICBvdXRwdXQuYXJlYVN0YXJ0KCk7CiAgICAgICAgICBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG91dHB1dC5saW5lRW5kKCk7CiAgICAgICAgICBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgICBmb3IgKGsgPSBpIC0gMTsgayA+PSBqOyAtLWspIHsKICAgICAgICAgICAgb3V0cHV0LnBvaW50KHgweltrXSwgeTB6W2tdKTsKICAgICAgICAgIH0KICAgICAgICAgIG91dHB1dC5saW5lRW5kKCk7CiAgICAgICAgICBvdXRwdXQuYXJlYUVuZCgpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZGVmaW5lZDApIHsKICAgICAgICB4MHpbaV0gPSAreDAoZCwgaSwgZGF0YSksIHkweltpXSA9ICt5MChkLCBpLCBkYXRhKTsKICAgICAgICBvdXRwdXQucG9pbnQoeDEgPyAreDEoZCwgaSwgZGF0YSkgOiB4MHpbaV0sIHkxID8gK3kxKGQsIGksIGRhdGEpIDogeTB6W2ldKTsKICAgICAgfQogICAgfQogICAgaWYgKGJ1ZmZlcikgcmV0dXJuIG91dHB1dCA9IG51bGwsIGJ1ZmZlciArICIiIHx8IG51bGw7CiAgfQogIGZ1bmN0aW9uIGFyZWFsaW5lKCkgewogICAgcmV0dXJuIGxpbmVfZGVmYXVsdCgpLmRlZmluZWQoZGVmaW5lZDIpLmN1cnZlKGN1cnZlKS5jb250ZXh0KGNvbnRleHQpOwogIH0KICBhcmVhLnggPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCB4MSA9IG51bGwsIGFyZWEpIDogeDA7CiAgfTsKICBhcmVhLngwID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB4MDsKICB9OwogIGFyZWEueDEgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MSA9IF8gPT0gbnVsbCA/IG51bGwgOiB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB4MTsKICB9OwogIGFyZWEueSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkwID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIHkxID0gbnVsbCwgYXJlYSkgOiB5MDsKICB9OwogIGFyZWEueTAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHkwOwogIH07CiAgYXJlYS55MSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkxID0gXyA9PSBudWxsID8gbnVsbCA6IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHkxOwogIH07CiAgYXJlYS5saW5lWDAgPSBhcmVhLmxpbmVZMCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MCkueSh5MCk7CiAgfTsKICBhcmVhLmxpbmVZMSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MCkueSh5MSk7CiAgfTsKICBhcmVhLmxpbmVYMSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MSkueSh5MCk7CiAgfTsKICBhcmVhLmRlZmluZWQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkZWZpbmVkMiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoISFfKSwgYXJlYSkgOiBkZWZpbmVkMjsKICB9OwogIGFyZWEuY3VydmUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjdXJ2ZSA9IF8sIGNvbnRleHQgIT0gbnVsbCAmJiAob3V0cHV0ID0gY3VydmUoY29udGV4dCkpLCBhcmVhKSA6IGN1cnZlOwogIH07CiAgYXJlYS5jb250ZXh0ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoXyA9PSBudWxsID8gY29udGV4dCA9IG91dHB1dCA9IG51bGwgOiBvdXRwdXQgPSBjdXJ2ZShjb250ZXh0ID0gXyksIGFyZWEpIDogY29udGV4dDsKICB9OwogIHJldHVybiBhcmVhOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2J1bXAuanMKdmFyIEJ1bXAgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29udGV4dCwgeDIpIHsKICAgIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0OwogICAgdGhpcy5feCA9IHgyOwogIH0KICBhcmVhU3RhcnQoKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9CiAgYXJlYUVuZCgpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfQogIGxpbmVTdGFydCgpIHsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9CiAgbGluZUVuZCgpIHsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfQogIHBvaW50KHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6IHsKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgaWYgKHRoaXMuX2xpbmUpIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgZWxzZSB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICBpZiAodGhpcy5feCkgdGhpcy5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHRoaXMuX3gwID0gKHRoaXMuX3gwICsgeDIpIC8gMiwgdGhpcy5feTAsIHRoaXMuX3gwLCB5MiwgeDIsIHkyKTsKICAgICAgICBlbHNlIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh0aGlzLl94MCwgdGhpcy5feTAgPSAodGhpcy5feTAgKyB5MikgLyAyLCB4MiwgdGhpcy5feTAsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3gwID0geDIsIHRoaXMuX3kwID0geTI7CiAgfQp9OwpmdW5jdGlvbiBidW1wWChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCdW1wKGNvbnRleHQsIHRydWUpOwp9CmZ1bmN0aW9uIGJ1bXBZKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJ1bXAoY29udGV4dCwgZmFsc2UpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL25vb3AuanMKZnVuY3Rpb24gbm9vcF9kZWZhdWx0KCkgewp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2Jhc2lzLmpzCmZ1bmN0aW9uIHBvaW50KHRoYXQsIHgyLCB5MikgewogIHRoYXQuX2NvbnRleHQuYmV6aWVyQ3VydmVUbygKICAgICgyICogdGhhdC5feDAgKyB0aGF0Ll94MSkgLyAzLAogICAgKDIgKiB0aGF0Ll95MCArIHRoYXQuX3kxKSAvIDMsCiAgICAodGhhdC5feDAgKyAyICogdGhhdC5feDEpIC8gMywKICAgICh0aGF0Ll95MCArIDIgKiB0aGF0Ll95MSkgLyAzLAogICAgKHRoYXQuX3gwICsgNCAqIHRoYXQuX3gxICsgeDIpIC8gNiwKICAgICh0aGF0Ll95MCArIDQgKiB0aGF0Ll95MSArIHkyKSAvIDYKICApOwp9CmZ1bmN0aW9uIEJhc2lzKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpCYXNpcy5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMzoKICAgICAgICBwb2ludCh0aGlzLCB0aGlzLl94MSwgdGhpcy5feTEpOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8odGhpcy5feDEsIHRoaXMuX3kxKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAzOwogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKCg1ICogdGhpcy5feDAgKyB0aGlzLl94MSkgLyA2LCAoNSAqIHRoaXMuX3kwICsgdGhpcy5feTEpIC8gNik7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQodGhpcywgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYmFzaXNfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCYXNpcyhjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9iYXNpc0Nsb3NlZC5qcwpmdW5jdGlvbiBCYXNpc0Nsb3NlZChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KQmFzaXNDbG9zZWQucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogbm9vcF9kZWZhdWx0LAogIGFyZWFFbmQ6IG5vb3BfZGVmYXVsdCwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feDAgPSB0aGlzLl94MSA9IHRoaXMuX3gyID0gdGhpcy5feDMgPSB0aGlzLl94NCA9IHRoaXMuX3kwID0gdGhpcy5feTEgPSB0aGlzLl95MiA9IHRoaXMuX3kzID0gdGhpcy5feTQgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAxOiB7CiAgICAgICAgdGhpcy5fY29udGV4dC5tb3ZlVG8odGhpcy5feDIsIHRoaXMuX3kyKTsKICAgICAgICB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgMjogewogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKCh0aGlzLl94MiArIDIgKiB0aGlzLl94MykgLyAzLCAodGhpcy5feTIgKyAyICogdGhpcy5feTMpIC8gMyk7CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oKHRoaXMuX3gzICsgMiAqIHRoaXMuX3gyKSAvIDMsICh0aGlzLl95MyArIDIgKiB0aGlzLl95MikgLyAzKTsKICAgICAgICB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgMzogewogICAgICAgIHRoaXMucG9pbnQodGhpcy5feDIsIHRoaXMuX3kyKTsKICAgICAgICB0aGlzLnBvaW50KHRoaXMuX3gzLCB0aGlzLl95Myk7CiAgICAgICAgdGhpcy5wb2ludCh0aGlzLl94NCwgdGhpcy5feTQpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5feDIgPSB4MiwgdGhpcy5feTIgPSB5MjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICB0aGlzLl94MyA9IHgyLCB0aGlzLl95MyA9IHkyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAzOwogICAgICAgIHRoaXMuX3g0ID0geDIsIHRoaXMuX3k0ID0geTI7CiAgICAgICAgdGhpcy5fY29udGV4dC5tb3ZlVG8oKHRoaXMuX3gwICsgNCAqIHRoaXMuX3gxICsgeDIpIC8gNiwgKHRoaXMuX3kwICsgNCAqIHRoaXMuX3kxICsgeTIpIC8gNik7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQodGhpcywgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYmFzaXNDbG9zZWRfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCYXNpc0Nsb3NlZChjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9iYXNpc09wZW4uanMKZnVuY3Rpb24gQmFzaXNPcGVuKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpCYXNpc09wZW4ucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMykgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB2YXIgeDAgPSAodGhpcy5feDAgKyA0ICogdGhpcy5feDEgKyB4MikgLyA2LCB5MCA9ICh0aGlzLl95MCArIDQgKiB0aGlzLl95MSArIHkyKSAvIDY7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgwLCB5MCkgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MCwgeTApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgdGhpcy5fcG9pbnQgPSA0OwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzT3Blbl9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJhc2lzT3Blbihjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9saW5lYXJDbG9zZWQuanMKZnVuY3Rpb24gTGluZWFyQ2xvc2VkKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpMaW5lYXJDbG9zZWQucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogbm9vcF9kZWZhdWx0LAogIGFyZWFFbmQ6IG5vb3BfZGVmYXVsdCwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fcG9pbnQpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBpZiAodGhpcy5fcG9pbnQpIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICBlbHNlIHRoaXMuX3BvaW50ID0gMSwgdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICB9Cn07CmZ1bmN0aW9uIGxpbmVhckNsb3NlZF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IExpbmVhckNsb3NlZChjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9tb25vdG9uZS5qcwpmdW5jdGlvbiBzaWduKHgyKSB7CiAgcmV0dXJuIHgyIDwgMCA/IC0xIDogMTsKfQpmdW5jdGlvbiBzbG9wZTModGhhdCwgeDIsIHkyKSB7CiAgdmFyIGgwID0gdGhhdC5feDEgLSB0aGF0Ll94MCwgaDEgPSB4MiAtIHRoYXQuX3gxLCBzMCA9ICh0aGF0Ll95MSAtIHRoYXQuX3kwKSAvIChoMCB8fCBoMSA8IDAgJiYgLTApLCBzMSA9ICh5MiAtIHRoYXQuX3kxKSAvIChoMSB8fCBoMCA8IDAgJiYgLTApLCBwID0gKHMwICogaDEgKyBzMSAqIGgwKSAvIChoMCArIGgxKTsKICByZXR1cm4gKHNpZ24oczApICsgc2lnbihzMSkpICogTWF0aC5taW4oTWF0aC5hYnMoczApLCBNYXRoLmFicyhzMSksIDAuNSAqIE1hdGguYWJzKHApKSB8fCAwOwp9CmZ1bmN0aW9uIHNsb3BlMih0aGF0LCB0KSB7CiAgdmFyIGggPSB0aGF0Ll94MSAtIHRoYXQuX3gwOwogIHJldHVybiBoID8gKDMgKiAodGhhdC5feTEgLSB0aGF0Ll95MCkgLyBoIC0gdCkgLyAyIDogdDsKfQpmdW5jdGlvbiBwb2ludDIodGhhdCwgdDAyLCB0MTIpIHsKICB2YXIgeDAgPSB0aGF0Ll94MCwgeTAgPSB0aGF0Ll95MCwgeDEgPSB0aGF0Ll94MSwgeTEgPSB0aGF0Ll95MSwgZHggPSAoeDEgLSB4MCkgLyAzOwogIHRoYXQuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh4MCArIGR4LCB5MCArIGR4ICogdDAyLCB4MSAtIGR4LCB5MSAtIGR4ICogdDEyLCB4MSwgeTEpOwp9CmZ1bmN0aW9uIE1vbm90b25lWChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KTW9ub3RvbmVYLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feDAgPSB0aGlzLl94MSA9IHRoaXMuX3kwID0gdGhpcy5feTEgPSB0aGlzLl90MCA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8odGhpcy5feDEsIHRoaXMuX3kxKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIHBvaW50Mih0aGlzLCB0aGlzLl90MCwgc2xvcGUyKHRoaXMsIHRoaXMuX3QwKSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdmFyIHQxMiA9IE5hTjsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIGlmICh4MiA9PT0gdGhpcy5feDEgJiYgeTIgPT09IHRoaXMuX3kxKSByZXR1cm47CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAzOwogICAgICAgIHBvaW50Mih0aGlzLCBzbG9wZTIodGhpcywgdDEyID0gc2xvcGUzKHRoaXMsIHgyLCB5MikpLCB0MTIpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50Mih0aGlzLCB0aGlzLl90MCwgdDEyID0gc2xvcGUzKHRoaXMsIHgyLCB5MikpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgdGhpcy5feDAgPSB0aGlzLl94MSwgdGhpcy5feDEgPSB4MjsKICAgIHRoaXMuX3kwID0gdGhpcy5feTEsIHRoaXMuX3kxID0geTI7CiAgICB0aGlzLl90MCA9IHQxMjsKICB9Cn07CmZ1bmN0aW9uIE1vbm90b25lWShjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IG5ldyBSZWZsZWN0Q29udGV4dChjb250ZXh0KTsKfQooTW9ub3RvbmVZLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoTW9ub3RvbmVYLnByb3RvdHlwZSkpLnBvaW50ID0gZnVuY3Rpb24oeDIsIHkyKSB7CiAgTW9ub3RvbmVYLnByb3RvdHlwZS5wb2ludC5jYWxsKHRoaXMsIHkyLCB4Mik7Cn07CmZ1bmN0aW9uIFJlZmxlY3RDb250ZXh0KGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpSZWZsZWN0Q29udGV4dC5wcm90b3R5cGUgPSB7CiAgbW92ZVRvOiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKHkyLCB4Mik7CiAgfSwKICBjbG9zZVBhdGg6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICB9LAogIGxpbmVUbzogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh5MiwgeDIpOwogIH0sCiAgYmV6aWVyQ3VydmVUbzogZnVuY3Rpb24oeDEsIHkxLCB4MiwgeTIsIHgzLCB5MykgewogICAgdGhpcy5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHkxLCB4MSwgeTIsIHgyLCB5MywgeDMpOwogIH0KfTsKZnVuY3Rpb24gbW9ub3RvbmVYKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IE1vbm90b25lWChjb250ZXh0KTsKfQpmdW5jdGlvbiBtb25vdG9uZVkoY29udGV4dCkgewogIHJldHVybiBuZXcgTW9ub3RvbmVZKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL25hdHVyYWwuanMKZnVuY3Rpb24gTmF0dXJhbChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KTmF0dXJhbC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3ggPSBbXTsKICAgIHRoaXMuX3kgPSBbXTsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIHgyID0gdGhpcy5feCwgeTIgPSB0aGlzLl95LCBuID0geDIubGVuZ3RoOwogICAgaWYgKG4pIHsKICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyWzBdLCB5MlswXSkgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MlswXSwgeTJbMF0pOwogICAgICBpZiAobiA9PT0gMikgewogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyWzFdLCB5MlsxXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHB4ID0gY29udHJvbFBvaW50cyh4MiksIHB5ID0gY29udHJvbFBvaW50cyh5Mik7CiAgICAgICAgZm9yICh2YXIgaTAgPSAwLCBpMSA9IDE7IGkxIDwgbjsgKytpMCwgKytpMSkgewogICAgICAgICAgdGhpcy5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHB4WzBdW2kwXSwgcHlbMF1baTBdLCBweFsxXVtpMF0sIHB5WzFdW2kwXSwgeDJbaTFdLCB5MltpMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiBuID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogICAgdGhpcy5feCA9IHRoaXMuX3kgPSBudWxsOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdGhpcy5feC5wdXNoKCt4Mik7CiAgICB0aGlzLl95LnB1c2goK3kyKTsKICB9Cn07CmZ1bmN0aW9uIGNvbnRyb2xQb2ludHMoeDIpIHsKICB2YXIgaSwgbiA9IHgyLmxlbmd0aCAtIDEsIG0sIGEgPSBuZXcgQXJyYXkobiksIGIgPSBuZXcgQXJyYXkobiksIHIyID0gbmV3IEFycmF5KG4pOwogIGFbMF0gPSAwLCBiWzBdID0gMiwgcjJbMF0gPSB4MlswXSArIDIgKiB4MlsxXTsKICBmb3IgKGkgPSAxOyBpIDwgbiAtIDE7ICsraSkgYVtpXSA9IDEsIGJbaV0gPSA0LCByMltpXSA9IDQgKiB4MltpXSArIDIgKiB4MltpICsgMV07CiAgYVtuIC0gMV0gPSAyLCBiW24gLSAxXSA9IDcsIHIyW24gLSAxXSA9IDggKiB4MltuIC0gMV0gKyB4MltuXTsKICBmb3IgKGkgPSAxOyBpIDwgbjsgKytpKSBtID0gYVtpXSAvIGJbaSAtIDFdLCBiW2ldIC09IG0sIHIyW2ldIC09IG0gKiByMltpIC0gMV07CiAgYVtuIC0gMV0gPSByMltuIC0gMV0gLyBiW24gLSAxXTsKICBmb3IgKGkgPSBuIC0gMjsgaSA+PSAwOyAtLWkpIGFbaV0gPSAocjJbaV0gLSBhW2kgKyAxXSkgLyBiW2ldOwogIGJbbiAtIDFdID0gKHgyW25dICsgYVtuIC0gMV0pIC8gMjsKICBmb3IgKGkgPSAwOyBpIDwgbiAtIDE7ICsraSkgYltpXSA9IDIgKiB4MltpICsgMV0gLSBhW2kgKyAxXTsKICByZXR1cm4gW2EsIGJdOwp9CmZ1bmN0aW9uIG5hdHVyYWxfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBOYXR1cmFsKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL3N0ZXAuanMKZnVuY3Rpb24gU3RlcChjb250ZXh0LCB0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7CiAgdGhpcy5fdCA9IHQ7Cn0KU3RlcC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3ggPSB0aGlzLl95ID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAoMCA8IHRoaXMuX3QgJiYgdGhpcy5fdCA8IDEgJiYgdGhpcy5fcG9pbnQgPT09IDIpIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gsIHRoaXMuX3kpOwogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIGlmICh0aGlzLl9saW5lID49IDApIHRoaXMuX3QgPSAxIC0gdGhpcy5fdCwgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgZGVmYXVsdDogewogICAgICAgIGlmICh0aGlzLl90IDw9IDApIHsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gsIHkyKTsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciB4MSA9IHRoaXMuX3ggKiAoMSAtIHRoaXMuX3QpICsgeDIgKiB0aGlzLl90OwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDEsIHRoaXMuX3kpOwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDEsIHkyKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3ggPSB4MiwgdGhpcy5feSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gc3RlcF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMC41KTsKfQpmdW5jdGlvbiBzdGVwQmVmb3JlKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMCk7Cn0KZnVuY3Rpb24gc3RlcEFmdGVyKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb2Zmc2V0L25vbmUuanMKZnVuY3Rpb24gbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMSkpIHJldHVybjsKICBmb3IgKHZhciBpID0gMSwgaiwgczAsIHMxID0gc2VyaWVzW29yZGVyWzBdXSwgbiwgbSA9IHMxLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgczAgPSBzMSwgczEgPSBzZXJpZXNbb3JkZXJbaV1dOwogICAgZm9yIChqID0gMDsgaiA8IG07ICsraikgewogICAgICBzMVtqXVsxXSArPSBzMVtqXVswXSA9IGlzTmFOKHMwW2pdWzFdKSA/IHMwW2pdWzBdIDogczBbal1bMV07CiAgICB9CiAgfQp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29yZGVyL25vbmUuanMKZnVuY3Rpb24gbm9uZV9kZWZhdWx0MihzZXJpZXMpIHsKICB2YXIgbiA9IHNlcmllcy5sZW5ndGgsIG8gPSBuZXcgQXJyYXkobik7CiAgd2hpbGUgKC0tbiA+PSAwKSBvW25dID0gbjsKICByZXR1cm4gbzsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9zdGFjay5qcwpmdW5jdGlvbiBzdGFja1ZhbHVlKGQsIGtleSkgewogIHJldHVybiBkW2tleV07Cn0KZnVuY3Rpb24gc3RhY2tTZXJpZXMoa2V5KSB7CiAgY29uc3Qgc2VyaWVzID0gW107CiAgc2VyaWVzLmtleSA9IGtleTsKICByZXR1cm4gc2VyaWVzOwp9CmZ1bmN0aW9uIHN0YWNrX2RlZmF1bHQoKSB7CiAgdmFyIGtleXMgPSBjb25zdGFudF9kZWZhdWx0KFtdKSwgb3JkZXIgPSBub25lX2RlZmF1bHQyLCBvZmZzZXQgPSBub25lX2RlZmF1bHQsIHZhbHVlID0gc3RhY2tWYWx1ZTsKICBmdW5jdGlvbiBzdGFjayhkYXRhKSB7CiAgICB2YXIgc3ogPSBBcnJheS5mcm9tKGtleXMuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgc3RhY2tTZXJpZXMpLCBpLCBuID0gc3oubGVuZ3RoLCBqID0gLTEsIG96OwogICAgZm9yIChjb25zdCBkIG9mIGRhdGEpIHsKICAgICAgZm9yIChpID0gMCwgKytqOyBpIDwgbjsgKytpKSB7CiAgICAgICAgKHN6W2ldW2pdID0gWzAsICt2YWx1ZShkLCBzeltpXS5rZXksIGosIGRhdGEpXSkuZGF0YSA9IGQ7CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IDAsIG96ID0gYXJyYXlfZGVmYXVsdChvcmRlcihzeikpOyBpIDwgbjsgKytpKSB7CiAgICAgIHN6W296W2ldXS5pbmRleCA9IGk7CiAgICB9CiAgICBvZmZzZXQoc3osIG96KTsKICAgIHJldHVybiBzejsKICB9CiAgc3RhY2sua2V5cyA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGtleXMgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KEFycmF5LmZyb20oXykpLCBzdGFjaykgOiBrZXlzOwogIH07CiAgc3RhY2sudmFsdWUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh2YWx1ZSA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBzdGFjaykgOiB2YWx1ZTsKICB9OwogIHN0YWNrLm9yZGVyID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAob3JkZXIgPSBfID09IG51bGwgPyBub25lX2RlZmF1bHQyIDogdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdChBcnJheS5mcm9tKF8pKSwgc3RhY2spIDogb3JkZXI7CiAgfTsKICBzdGFjay5vZmZzZXQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChvZmZzZXQgPSBfID09IG51bGwgPyBub25lX2RlZmF1bHQgOiBfLCBzdGFjaykgOiBvZmZzZXQ7CiAgfTsKICByZXR1cm4gc3RhY2s7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb2Zmc2V0L2V4cGFuZC5qcwpmdW5jdGlvbiBleHBhbmRfZGVmYXVsdChzZXJpZXMsIG9yZGVyKSB7CiAgaWYgKCEoKG4gPSBzZXJpZXMubGVuZ3RoKSA+IDApKSByZXR1cm47CiAgZm9yICh2YXIgaSwgbiwgaiA9IDAsIG0gPSBzZXJpZXNbMF0ubGVuZ3RoLCB5MjsgaiA8IG07ICsraikgewogICAgZm9yICh5MiA9IGkgPSAwOyBpIDwgbjsgKytpKSB5MiArPSBzZXJpZXNbaV1bal1bMV0gfHwgMDsKICAgIGlmICh5MikgZm9yIChpID0gMDsgaSA8IG47ICsraSkgc2VyaWVzW2ldW2pdWzFdIC89IHkyOwogIH0KICBub25lX2RlZmF1bHQoc2VyaWVzLCBvcmRlcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb2Zmc2V0L3NpbGhvdWV0dGUuanMKZnVuY3Rpb24gc2lsaG91ZXR0ZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMCkpIHJldHVybjsKICBmb3IgKHZhciBqID0gMCwgczAgPSBzZXJpZXNbb3JkZXJbMF1dLCBuLCBtID0gczAubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHZhciBpID0gMCwgeTIgPSAwOyBpIDwgbjsgKytpKSB5MiArPSBzZXJpZXNbaV1bal1bMV0gfHwgMDsKICAgIHMwW2pdWzFdICs9IHMwW2pdWzBdID0gLXkyIC8gMjsKICB9CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC93aWdnbGUuanMKZnVuY3Rpb24gd2lnZ2xlX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSB8fCAhKChtID0gKHMwID0gc2VyaWVzW29yZGVyWzBdXSkubGVuZ3RoKSA+IDApKSByZXR1cm47CiAgZm9yICh2YXIgeTIgPSAwLCBqID0gMSwgczAsIG0sIG47IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGkgPSAwLCBzMSA9IDAsIHMyID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YXIgc2kgPSBzZXJpZXNbb3JkZXJbaV1dLCBzaWowID0gc2lbal1bMV0gfHwgMCwgc2lqMSA9IHNpW2ogLSAxXVsxXSB8fCAwLCBzMyA9IChzaWowIC0gc2lqMSkgLyAyOwogICAgICBmb3IgKHZhciBrID0gMDsgayA8IGk7ICsraykgewogICAgICAgIHZhciBzayA9IHNlcmllc1tvcmRlcltrXV0sIHNrajAgPSBza1tqXVsxXSB8fCAwLCBza2oxID0gc2tbaiAtIDFdWzFdIHx8IDA7CiAgICAgICAgczMgKz0gc2tqMCAtIHNrajE7CiAgICAgIH0KICAgICAgczEgKz0gc2lqMCwgczIgKz0gczMgKiBzaWowOwogICAgfQogICAgczBbaiAtIDFdWzFdICs9IHMwW2ogLSAxXVswXSA9IHkyOwogICAgaWYgKHMxKSB5MiAtPSBzMiAvIHMxOwogIH0KICBzMFtqIC0gMV1bMV0gKz0gczBbaiAtIDFdWzBdID0geTI7CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvRGF0YVV0aWxzLmpzCnZhciBpbXBvcnRfZ2V0ID0gX190b0VTTShyZXF1aXJlX2dldDIoKSk7CnZhciBtYXRoU2lnbiA9ICh2YWx1ZSkgPT4gewogIGlmICh2YWx1ZSA9PT0gMCkgewogICAgcmV0dXJuIDA7CiAgfQogIGlmICh2YWx1ZSA+IDApIHsKICAgIHJldHVybiAxOwogIH0KICByZXR1cm4gLTE7Cn07CnZhciBpc05hbiA9ICh2YWx1ZSkgPT4gewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gIm51bWJlciIgJiYgdmFsdWUgIT0gK3ZhbHVlOwp9Owp2YXIgaXNQZXJjZW50ID0gKHZhbHVlKSA9PiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIiUiKSA9PT0gdmFsdWUubGVuZ3RoIC0gMTsKdmFyIGlzTnVtYmVyID0gKHZhbHVlKSA9PiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiB8fCB2YWx1ZSBpbnN0YW5jZW9mIE51bWJlcikgJiYgIWlzTmFuKHZhbHVlKTsKdmFyIGlzTnVtT3JTdHIgPSAodmFsdWUpID0+IGlzTnVtYmVyKHZhbHVlKSB8fCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciOwp2YXIgaWRDb3VudGVyID0gMDsKdmFyIHVuaXF1ZUlkID0gKHByZWZpeCkgPT4gewogIHZhciBpZCA9ICsraWRDb3VudGVyOwogIHJldHVybiAiIi5jb25jYXQocHJlZml4IHx8ICIiKS5jb25jYXQoaWQpOwp9Owp2YXIgZ2V0UGVyY2VudFZhbHVlID0gZnVuY3Rpb24gZ2V0UGVyY2VudFZhbHVlMihwZXJjZW50LCB0b3RhbFZhbHVlKSB7CiAgdmFyIGRlZmF1bHRWYWx1ZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogMDsKICB2YXIgdmFsaWRhdGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiBhcmd1bWVudHNbM10gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1szXSA6IGZhbHNlOwogIGlmICghaXNOdW1iZXIocGVyY2VudCkgJiYgdHlwZW9mIHBlcmNlbnQgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogIH0KICB2YXIgdmFsdWU7CiAgaWYgKGlzUGVyY2VudChwZXJjZW50KSkgewogICAgaWYgKHRvdGFsVmFsdWUgPT0gbnVsbCkgewogICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgfQogICAgdmFyIGluZGV4ID0gcGVyY2VudC5pbmRleE9mKCIlIik7CiAgICB2YWx1ZSA9IHRvdGFsVmFsdWUgKiBwYXJzZUZsb2F0KHBlcmNlbnQuc2xpY2UoMCwgaW5kZXgpKSAvIDEwMDsKICB9IGVsc2UgewogICAgdmFsdWUgPSArcGVyY2VudDsKICB9CiAgaWYgKGlzTmFuKHZhbHVlKSkgewogICAgdmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgfQogIGlmICh2YWxpZGF0ZSAmJiB0b3RhbFZhbHVlICE9IG51bGwgJiYgdmFsdWUgPiB0b3RhbFZhbHVlKSB7CiAgICB2YWx1ZSA9IHRvdGFsVmFsdWU7CiAgfQogIHJldHVybiB2YWx1ZTsKfTsKdmFyIGhhc0R1cGxpY2F0ZSA9IChhcnkpID0+IHsKICBpZiAoIUFycmF5LmlzQXJyYXkoYXJ5KSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgbGVuID0gYXJ5Lmxlbmd0aDsKICB2YXIgY2FjaGUgPSB7fTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICBpZiAoIWNhY2hlW2FyeVtpXV0pIHsKICAgICAgY2FjaGVbYXJ5W2ldXSA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwpmdW5jdGlvbiBpbnRlcnBvbGF0ZShzdGFydCwgZW5kLCB0KSB7CiAgaWYgKGlzTnVtYmVyKHN0YXJ0KSAmJiBpc051bWJlcihlbmQpKSB7CiAgICByZXR1cm4gc3RhcnQgKyB0ICogKGVuZCAtIHN0YXJ0KTsKICB9CiAgcmV0dXJuIGVuZDsKfQpmdW5jdGlvbiBmaW5kRW50cnlJbkFycmF5KGFyeSwgc3BlY2lmaWVkS2V5LCBzcGVjaWZpZWRWYWx1ZSkgewogIGlmICghYXJ5IHx8ICFhcnkubGVuZ3RoKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gYXJ5LmZpbmQoKGVudHJ5KSA9PiBlbnRyeSAmJiAodHlwZW9mIHNwZWNpZmllZEtleSA9PT0gImZ1bmN0aW9uIiA/IHNwZWNpZmllZEtleShlbnRyeSkgOiAoMCwgaW1wb3J0X2dldC5kZWZhdWx0KShlbnRyeSwgc3BlY2lmaWVkS2V5KSkgPT09IHNwZWNpZmllZFZhbHVlKTsKfQp2YXIgaXNOdWxsaXNoID0gKHZhbHVlKSA9PiB7CiAgcmV0dXJuIHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCI7Cn07CnZhciB1cHBlckZpcnN0ID0gKHZhbHVlKSA9PiB7CiAgaWYgKGlzTnVsbGlzaCh2YWx1ZSkpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgcmV0dXJuICIiLmNvbmNhdCh2YWx1ZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSkuY29uY2F0KHZhbHVlLnNsaWNlKDEpKTsKfTsKZnVuY3Rpb24gaXNOb3ROaWwodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgIT0gbnVsbDsKfQpmdW5jdGlvbiBub29wKCkgewp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdHlwZXMuanMKdmFyIGltcG9ydF9yZWFjdDcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpc1BvbGFyQ29vcmRpbmF0ZSA9IChjKSA9PiB7CiAgcmV0dXJuICJyYWRpdXMiIGluIGMgJiYgInN0YXJ0QW5nbGUiIGluIGMgJiYgImVuZEFuZ2xlIiBpbiBjOwp9Owp2YXIgYWRhcHRFdmVudEhhbmRsZXJzID0gKHByb3BzLCBuZXdIYW5kbGVyKSA9PiB7CiAgaWYgKCFwcm9wcyB8fCB0eXBlb2YgcHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIHByb3BzID09PSAiYm9vbGVhbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgaW5wdXRQcm9wcyA9IHByb3BzOwogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDcuaXNWYWxpZEVsZW1lbnQpKHByb3BzKSkgewogICAgaW5wdXRQcm9wcyA9IHByb3BzLnByb3BzOwogIH0KICBpZiAodHlwZW9mIGlucHV0UHJvcHMgIT09ICJvYmplY3QiICYmIHR5cGVvZiBpbnB1dFByb3BzICE9PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIG91dCA9IHt9OwogIE9iamVjdC5rZXlzKGlucHV0UHJvcHMpLmZvckVhY2goKGtleSkgPT4gewogICAgaWYgKGlzRXZlbnRLZXkoa2V5KSkgewogICAgICBvdXRba2V5XSA9IG5ld0hhbmRsZXIgfHwgKChlKSA9PiBpbnB1dFByb3BzW2tleV0oaW5wdXRQcm9wcywgZSkpOwogICAgfQogIH0pOwogIHJldHVybiBvdXQ7Cn07CnZhciBnZXRFdmVudEhhbmRsZXJPZkNoaWxkID0gKG9yaWdpbmFsSGFuZGxlciwgZGF0YSwgaW5kZXgpID0+IChlKSA9PiB7CiAgb3JpZ2luYWxIYW5kbGVyKGRhdGEsIGluZGV4LCBlKTsKICByZXR1cm4gbnVsbDsKfTsKdmFyIGFkYXB0RXZlbnRzT2ZDaGlsZCA9IChwcm9wcywgZGF0YSwgaW5kZXgpID0+IHsKICBpZiAocHJvcHMgPT09IG51bGwgfHwgdHlwZW9mIHByb3BzICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgcHJvcHMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgb3V0ID0gbnVsbDsKICBPYmplY3Qua2V5cyhwcm9wcykuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICB2YXIgaXRlbSA9IHByb3BzW2tleV07CiAgICBpZiAoaXNFdmVudEtleShrZXkpICYmIHR5cGVvZiBpdGVtID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGlmICghb3V0KSBvdXQgPSB7fTsKICAgICAgb3V0W2tleV0gPSBnZXRFdmVudEhhbmRsZXJPZkNoaWxkKGl0ZW0sIGRhdGEsIGluZGV4KTsKICAgIH0KICB9KTsKICByZXR1cm4gb3V0Owp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3Jlc29sdmVEZWZhdWx0UHJvcHMuanMKZnVuY3Rpb24gb3duS2V5cyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5cyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5cyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiByZXNvbHZlRGVmYXVsdFByb3BzKHJlYWxQcm9wcywgZGVmYXVsdFByb3BzKSB7CiAgdmFyIHJlc29sdmVkUHJvcHMgPSBfb2JqZWN0U3ByZWFkKHt9LCByZWFsUHJvcHMpOwogIHZhciBkcCA9IGRlZmF1bHRQcm9wczsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRlZmF1bHRQcm9wcyk7CiAgdmFyIHdpdGhEZWZhdWx0cyA9IGtleXMucmVkdWNlKChhY2MsIGtleSkgPT4gewogICAgaWYgKGFjY1trZXldID09PSB2b2lkIDAgJiYgZHBba2V5XSAhPT0gdm9pZCAwKSB7CiAgICAgIGFjY1trZXldID0gZHBba2V5XTsKICAgIH0KICAgIHJldHVybiBhY2M7CiAgfSwgcmVzb2x2ZWRQcm9wcyk7CiAgcmV0dXJuIHdpdGhEZWZhdWx0czsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3BheWxvYWQvZ2V0VW5pcVBheWxvYWQuanMKdmFyIGltcG9ydF91bmlxQnkgPSBfX3RvRVNNKHJlcXVpcmVfdW5pcUJ5MygpKTsKZnVuY3Rpb24gZ2V0VW5pcVBheWxvYWQocGF5bG9hZCwgb3B0aW9uLCBkZWZhdWx0VW5pcUJ5MikgewogIGlmIChvcHRpb24gPT09IHRydWUpIHsKICAgIHJldHVybiAoMCwgaW1wb3J0X3VuaXFCeS5kZWZhdWx0KShwYXlsb2FkLCBkZWZhdWx0VW5pcUJ5Mik7CiAgfQogIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF91bmlxQnkuZGVmYXVsdCkocGF5bG9hZCwgb3B0aW9uKTsKICB9CiAgcmV0dXJuIHBheWxvYWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvaG9va3MuanMKdmFyIGltcG9ydF93aXRoX3NlbGVjdG9yID0gX190b0VTTShyZXF1aXJlX3dpdGhfc2VsZWN0b3IoKSk7CnZhciBpbXBvcnRfcmVhY3Q5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1JlZHV4Q29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0OCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFJlY2hhcnRzUmVkdXhDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q4LmNyZWF0ZUNvbnRleHQpKG51bGwpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9ob29rcy5qcwp2YXIgbm9vcERpc3BhdGNoID0gKGEpID0+IGE7CnZhciB1c2VBcHBEaXNwYXRjaCA9ICgpID0+IHsKICB2YXIgY29udGV4dCA9ICgwLCBpbXBvcnRfcmVhY3Q5LnVzZUNvbnRleHQpKFJlY2hhcnRzUmVkdXhDb250ZXh0KTsKICBpZiAoY29udGV4dCkgewogICAgcmV0dXJuIGNvbnRleHQuc3RvcmUuZGlzcGF0Y2g7CiAgfQogIHJldHVybiBub29wRGlzcGF0Y2g7Cn07CnZhciBub29wMiA9ICgpID0+IHsKfTsKdmFyIGFkZE5lc3RlZFN1Yk5vb3AgPSAoKSA9PiBub29wMjsKdmFyIHJlZkVxdWFsaXR5ID0gKGEsIGIpID0+IGEgPT09IGI7CmZ1bmN0aW9uIHVzZUFwcFNlbGVjdG9yKHNlbGVjdG9yKSB7CiAgdmFyIGNvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0OS51c2VDb250ZXh0KShSZWNoYXJ0c1JlZHV4Q29udGV4dCk7CiAgcmV0dXJuICgwLCBpbXBvcnRfd2l0aF9zZWxlY3Rvci51c2VTeW5jRXh0ZXJuYWxTdG9yZVdpdGhTZWxlY3RvcikoY29udGV4dCA/IGNvbnRleHQuc3Vic2NyaXB0aW9uLmFkZE5lc3RlZFN1YiA6IGFkZE5lc3RlZFN1Yk5vb3AsIGNvbnRleHQgPyBjb250ZXh0LnN0b3JlLmdldFN0YXRlIDogbm9vcDIsIGNvbnRleHQgPyBjb250ZXh0LnN0b3JlLmdldFN0YXRlIDogbm9vcDIsIGNvbnRleHQgPyBzZWxlY3RvciA6IG5vb3AyLCByZWZFcXVhbGl0eSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZXNlbGVjdC9kaXN0L3Jlc2VsZWN0Lm1qcwp2YXIgcnVuSWRlbnRpdHlGdW5jdGlvbkNoZWNrID0gKHJlc3VsdEZ1bmMsIGlucHV0U2VsZWN0b3JzUmVzdWx0cywgb3V0cHV0U2VsZWN0b3JSZXN1bHQpID0+IHsKICBpZiAoaW5wdXRTZWxlY3RvcnNSZXN1bHRzLmxlbmd0aCA9PT0gMSAmJiBpbnB1dFNlbGVjdG9yc1Jlc3VsdHNbMF0gPT09IG91dHB1dFNlbGVjdG9yUmVzdWx0KSB7CiAgICBsZXQgaXNJbnB1dFNhbWVBc091dHB1dCA9IGZhbHNlOwogICAgdHJ5IHsKICAgICAgY29uc3QgZW1wdHlPYmplY3QgPSB7fTsKICAgICAgaWYgKHJlc3VsdEZ1bmMoZW1wdHlPYmplY3QpID09PSBlbXB0eU9iamVjdCkKICAgICAgICBpc0lucHV0U2FtZUFzT3V0cHV0ID0gdHJ1ZTsKICAgIH0gY2F0Y2ggewogICAgfQogICAgaWYgKGlzSW5wdXRTYW1lQXNPdXRwdXQpIHsKICAgICAgbGV0IHN0YWNrID0gdm9pZCAwOwogICAgICB0cnkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgOwogICAgICAgICh7IHN0YWNrIH0gPSBlKTsKICAgICAgfQogICAgICBjb25zb2xlLndhcm4oCiAgICAgICAgIlRoZSByZXN1bHQgZnVuY3Rpb24gcmV0dXJuZWQgaXRzIG93biBpbnB1dHMgd2l0aG91dCBtb2RpZmljYXRpb24uIGUuZ1xuYGNyZWF0ZVNlbGVjdG9yKFtzdGF0ZSA9PiBzdGF0ZS50b2Rvc10sIHRvZG9zID0+IHRvZG9zKWBcblRoaXMgY291bGQgbGVhZCB0byBpbmVmZmljaWVudCBtZW1vaXphdGlvbiBhbmQgdW5uZWNlc3NhcnkgcmUtcmVuZGVycy5cbkVuc3VyZSB0cmFuc2Zvcm1hdGlvbiBsb2dpYyBpcyBpbiB0aGUgcmVzdWx0IGZ1bmN0aW9uLCBhbmQgZXh0cmFjdGlvbiBsb2dpYyBpcyBpbiB0aGUgaW5wdXQgc2VsZWN0b3JzLiIsCiAgICAgICAgeyBzdGFjayB9CiAgICAgICk7CiAgICB9CiAgfQp9Owp2YXIgcnVuSW5wdXRTdGFiaWxpdHlDaGVjayA9IChpbnB1dFNlbGVjdG9yUmVzdWx0c09iamVjdCwgb3B0aW9ucywgaW5wdXRTZWxlY3RvckFyZ3MpID0+IHsKICBjb25zdCB7IG1lbW9pemUsIG1lbW9pemVPcHRpb25zIH0gPSBvcHRpb25zOwogIGNvbnN0IHsgaW5wdXRTZWxlY3RvclJlc3VsdHMsIGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSB9ID0gaW5wdXRTZWxlY3RvclJlc3VsdHNPYmplY3Q7CiAgY29uc3QgY3JlYXRlQW5FbXB0eU9iamVjdCA9IG1lbW9pemUoKCkgPT4gKHt9KSwgLi4ubWVtb2l6ZU9wdGlvbnMpOwogIGNvbnN0IGFyZUlucHV0U2VsZWN0b3JSZXN1bHRzRXF1YWwgPSBjcmVhdGVBbkVtcHR5T2JqZWN0LmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JSZXN1bHRzKSA9PT0gY3JlYXRlQW5FbXB0eU9iamVjdC5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkpOwogIGlmICghYXJlSW5wdXRTZWxlY3RvclJlc3VsdHNFcXVhbCkgewogICAgbGV0IHN0YWNrID0gdm9pZCAwOwogICAgdHJ5IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIDsKICAgICAgKHsgc3RhY2sgfSA9IGUpOwogICAgfQogICAgY29uc29sZS53YXJuKAogICAgICAiQW4gaW5wdXQgc2VsZWN0b3IgcmV0dXJuZWQgYSBkaWZmZXJlbnQgcmVzdWx0IHdoZW4gcGFzc2VkIHNhbWUgYXJndW1lbnRzLlxuVGhpcyBtZWFucyB5b3VyIG91dHB1dCBzZWxlY3RvciB3aWxsIGxpa2VseSBydW4gbW9yZSBmcmVxdWVudGx5IHRoYW4gaW50ZW5kZWQuXG5Bdm9pZCByZXR1cm5pbmcgYSBuZXcgcmVmZXJlbmNlIGluc2lkZSB5b3VyIGlucHV0IHNlbGVjdG9yLCBlLmcuXG5gY3JlYXRlU2VsZWN0b3IoW3N0YXRlID0+IHN0YXRlLnRvZG9zLm1hcCh0b2RvID0+IHRvZG8uaWQpXSwgdG9kb0lkcyA9PiB0b2RvSWRzLmxlbmd0aClgIiwKICAgICAgewogICAgICAgIGFyZ3VtZW50czogaW5wdXRTZWxlY3RvckFyZ3MsCiAgICAgICAgZmlyc3RJbnB1dHM6IGlucHV0U2VsZWN0b3JSZXN1bHRzLAogICAgICAgIHNlY29uZElucHV0czogaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5LAogICAgICAgIHN0YWNrCiAgICAgIH0KICAgICk7CiAgfQp9Owp2YXIgZ2xvYmFsRGV2TW9kZUNoZWNrcyA9IHsKICBpbnB1dFN0YWJpbGl0eUNoZWNrOiAib25jZSIsCiAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrOiAib25jZSIKfTsKZnVuY3Rpb24gYXNzZXJ0SXNGdW5jdGlvbihmdW5jLCBlcnJvck1lc3NhZ2UgPSBgZXhwZWN0ZWQgYSBmdW5jdGlvbiwgaW5zdGVhZCByZWNlaXZlZCAke3R5cGVvZiBmdW5jfWApIHsKICBpZiAodHlwZW9mIGZ1bmMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoZXJyb3JNZXNzYWdlKTsKICB9Cn0KZnVuY3Rpb24gYXNzZXJ0SXNPYmplY3Qob2JqZWN0LCBlcnJvck1lc3NhZ2UgPSBgZXhwZWN0ZWQgYW4gb2JqZWN0LCBpbnN0ZWFkIHJlY2VpdmVkICR7dHlwZW9mIG9iamVjdH1gKSB7CiAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICJvYmplY3QiKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGVycm9yTWVzc2FnZSk7CiAgfQp9CmZ1bmN0aW9uIGFzc2VydElzQXJyYXlPZkZ1bmN0aW9ucyhhcnJheSwgZXJyb3JNZXNzYWdlID0gYGV4cGVjdGVkIGFsbCBpdGVtcyB0byBiZSBmdW5jdGlvbnMsIGluc3RlYWQgcmVjZWl2ZWQgdGhlIGZvbGxvd2luZyB0eXBlczogYCkgewogIGlmICghYXJyYXkuZXZlcnkoKGl0ZW0pID0+IHR5cGVvZiBpdGVtID09PSAiZnVuY3Rpb24iKSkgewogICAgY29uc3QgaXRlbVR5cGVzID0gYXJyYXkubWFwKAogICAgICAoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIgPyBgZnVuY3Rpb24gJHtpdGVtLm5hbWUgfHwgInVubmFtZWQifSgpYCA6IHR5cGVvZiBpdGVtCiAgICApLmpvaW4oIiwgIik7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGAke2Vycm9yTWVzc2FnZX1bJHtpdGVtVHlwZXN9XWApOwogIH0KfQp2YXIgZW5zdXJlSXNBcnJheSA9IChpdGVtKSA9PiB7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoaXRlbSkgPyBpdGVtIDogW2l0ZW1dOwp9OwpmdW5jdGlvbiBnZXREZXBlbmRlbmNpZXMoY3JlYXRlU2VsZWN0b3JBcmdzKSB7CiAgY29uc3QgZGVwZW5kZW5jaWVzID0gQXJyYXkuaXNBcnJheShjcmVhdGVTZWxlY3RvckFyZ3NbMF0pID8gY3JlYXRlU2VsZWN0b3JBcmdzWzBdIDogY3JlYXRlU2VsZWN0b3JBcmdzOwogIGFzc2VydElzQXJyYXlPZkZ1bmN0aW9ucygKICAgIGRlcGVuZGVuY2llcywKICAgIGBjcmVhdGVTZWxlY3RvciBleHBlY3RzIGFsbCBpbnB1dC1zZWxlY3RvcnMgdG8gYmUgZnVuY3Rpb25zLCBidXQgcmVjZWl2ZWQgdGhlIGZvbGxvd2luZyB0eXBlczogYAogICk7CiAgcmV0dXJuIGRlcGVuZGVuY2llczsKfQpmdW5jdGlvbiBjb2xsZWN0SW5wdXRTZWxlY3RvclJlc3VsdHMoZGVwZW5kZW5jaWVzLCBpbnB1dFNlbGVjdG9yQXJncykgewogIGNvbnN0IGlucHV0U2VsZWN0b3JSZXN1bHRzID0gW107CiAgY29uc3QgeyBsZW5ndGggfSA9IGRlcGVuZGVuY2llczsKICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBpbnB1dFNlbGVjdG9yUmVzdWx0cy5wdXNoKGRlcGVuZGVuY2llc1tpXS5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yQXJncykpOwogIH0KICByZXR1cm4gaW5wdXRTZWxlY3RvclJlc3VsdHM7Cn0KdmFyIGdldERldk1vZGVDaGVja3NFeGVjdXRpb25JbmZvID0gKGZpcnN0UnVuLCBkZXZNb2RlQ2hlY2tzKSA9PiB7CiAgY29uc3QgeyBpZGVudGl0eUZ1bmN0aW9uQ2hlY2ssIGlucHV0U3RhYmlsaXR5Q2hlY2sgfSA9IHsKICAgIC4uLmdsb2JhbERldk1vZGVDaGVja3MsCiAgICAuLi5kZXZNb2RlQ2hlY2tzCiAgfTsKICByZXR1cm4gewogICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrOiB7CiAgICAgIHNob3VsZFJ1bjogaWRlbnRpdHlGdW5jdGlvbkNoZWNrID09PSAiYWx3YXlzIiB8fCBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPT09ICJvbmNlIiAmJiBmaXJzdFJ1biwKICAgICAgcnVuOiBydW5JZGVudGl0eUZ1bmN0aW9uQ2hlY2sKICAgIH0sCiAgICBpbnB1dFN0YWJpbGl0eUNoZWNrOiB7CiAgICAgIHNob3VsZFJ1bjogaW5wdXRTdGFiaWxpdHlDaGVjayA9PT0gImFsd2F5cyIgfHwgaW5wdXRTdGFiaWxpdHlDaGVjayA9PT0gIm9uY2UiICYmIGZpcnN0UnVuLAogICAgICBydW46IHJ1bklucHV0U3RhYmlsaXR5Q2hlY2sKICAgIH0KICB9Owp9Owp2YXIgUkVEVVhfUFJPWFlfTEFCRUwgPSBTeW1ib2woKTsKdmFyIHByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHt9KTsKdmFyIFN0cm9uZ1JlZiA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcih2YWx1ZSkgewogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH0KICBkZXJlZigpIHsKICAgIHJldHVybiB0aGlzLnZhbHVlOwogIH0KfTsKdmFyIFJlZiA9IHR5cGVvZiBXZWFrUmVmICE9PSAidW5kZWZpbmVkIiA/IFdlYWtSZWYgOiBTdHJvbmdSZWY7CnZhciBVTlRFUk1JTkFURUQgPSAwOwp2YXIgVEVSTUlOQVRFRCA9IDE7CmZ1bmN0aW9uIGNyZWF0ZUNhY2hlTm9kZSgpIHsKICByZXR1cm4gewogICAgczogVU5URVJNSU5BVEVELAogICAgdjogdm9pZCAwLAogICAgbzogbnVsbCwKICAgIHA6IG51bGwKICB9Owp9CmZ1bmN0aW9uIHdlYWtNYXBNZW1vaXplKGZ1bmMsIG9wdGlvbnMgPSB7fSkgewogIGxldCBmbk5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICBjb25zdCB7IHJlc3VsdEVxdWFsaXR5Q2hlY2sgfSA9IG9wdGlvbnM7CiAgbGV0IGxhc3RSZXN1bHQ7CiAgbGV0IHJlc3VsdHNDb3VudCA9IDA7CiAgZnVuY3Rpb24gbWVtb2l6ZWQoKSB7CiAgICBsZXQgY2FjaGVOb2RlID0gZm5Ob2RlOwogICAgY29uc3QgeyBsZW5ndGggfSA9IGFyZ3VtZW50czsKICAgIGZvciAobGV0IGkgPSAwLCBsID0gbGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGNvbnN0IGFyZyA9IGFyZ3VtZW50c1tpXTsKICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGFyZyA9PT0gIm9iamVjdCIgJiYgYXJnICE9PSBudWxsKSB7CiAgICAgICAgbGV0IG9iamVjdENhY2hlID0gY2FjaGVOb2RlLm87CiAgICAgICAgaWYgKG9iamVjdENhY2hlID09PSBudWxsKSB7CiAgICAgICAgICBjYWNoZU5vZGUubyA9IG9iamVjdENhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9iamVjdE5vZGUgPSBvYmplY3RDYWNoZS5nZXQoYXJnKTsKICAgICAgICBpZiAob2JqZWN0Tm9kZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBjYWNoZU5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICAgICAgICAgIG9iamVjdENhY2hlLnNldChhcmcsIGNhY2hlTm9kZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IG9iamVjdE5vZGU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGxldCBwcmltaXRpdmVDYWNoZSA9IGNhY2hlTm9kZS5wOwogICAgICAgIGlmIChwcmltaXRpdmVDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgY2FjaGVOb2RlLnAgPSBwcmltaXRpdmVDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHByaW1pdGl2ZU5vZGUgPSBwcmltaXRpdmVDYWNoZS5nZXQoYXJnKTsKICAgICAgICBpZiAocHJpbWl0aXZlTm9kZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBjYWNoZU5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICAgICAgICAgIHByaW1pdGl2ZUNhY2hlLnNldChhcmcsIGNhY2hlTm9kZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IHByaW1pdGl2ZU5vZGU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjb25zdCB0ZXJtaW5hdGVkTm9kZSA9IGNhY2hlTm9kZTsKICAgIGxldCByZXN1bHQ7CiAgICBpZiAoY2FjaGVOb2RlLnMgPT09IFRFUk1JTkFURUQpIHsKICAgICAgcmVzdWx0ID0gY2FjaGVOb2RlLnY7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgIHJlc3VsdHNDb3VudCsrOwogICAgICBpZiAocmVzdWx0RXF1YWxpdHlDaGVjaykgewogICAgICAgIGNvbnN0IGxhc3RSZXN1bHRWYWx1ZSA9IGxhc3RSZXN1bHQ/LmRlcmVmPy4oKSA/PyBsYXN0UmVzdWx0OwogICAgICAgIGlmIChsYXN0UmVzdWx0VmFsdWUgIT0gbnVsbCAmJiByZXN1bHRFcXVhbGl0eUNoZWNrKGxhc3RSZXN1bHRWYWx1ZSwgcmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbGFzdFJlc3VsdFZhbHVlOwogICAgICAgICAgcmVzdWx0c0NvdW50ICE9PSAwICYmIHJlc3VsdHNDb3VudC0tOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZWVkc1dlYWtSZWYgPSB0eXBlb2YgcmVzdWx0ID09PSAib2JqZWN0IiAmJiByZXN1bHQgIT09IG51bGwgfHwgdHlwZW9mIHJlc3VsdCA9PT0gImZ1bmN0aW9uIjsKICAgICAgICBsYXN0UmVzdWx0ID0gbmVlZHNXZWFrUmVmID8gbmV3IFJlZihyZXN1bHQpIDogcmVzdWx0OwogICAgICB9CiAgICB9CiAgICB0ZXJtaW5hdGVkTm9kZS5zID0gVEVSTUlOQVRFRDsKICAgIHRlcm1pbmF0ZWROb2RlLnYgPSByZXN1bHQ7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBtZW1vaXplZC5jbGVhckNhY2hlID0gKCkgPT4gewogICAgZm5Ob2RlID0gY3JlYXRlQ2FjaGVOb2RlKCk7CiAgICBtZW1vaXplZC5yZXNldFJlc3VsdHNDb3VudCgpOwogIH07CiAgbWVtb2l6ZWQucmVzdWx0c0NvdW50ID0gKCkgPT4gcmVzdWx0c0NvdW50OwogIG1lbW9pemVkLnJlc2V0UmVzdWx0c0NvdW50ID0gKCkgPT4gewogICAgcmVzdWx0c0NvdW50ID0gMDsKICB9OwogIHJldHVybiBtZW1vaXplZDsKfQpmdW5jdGlvbiBjcmVhdGVTZWxlY3RvckNyZWF0b3IobWVtb2l6ZU9yT3B0aW9ucywgLi4ubWVtb2l6ZU9wdGlvbnNGcm9tQXJncykgewogIGNvbnN0IGNyZWF0ZVNlbGVjdG9yQ3JlYXRvck9wdGlvbnMgPSB0eXBlb2YgbWVtb2l6ZU9yT3B0aW9ucyA9PT0gImZ1bmN0aW9uIiA/IHsKICAgIG1lbW9pemU6IG1lbW9pemVPck9wdGlvbnMsCiAgICBtZW1vaXplT3B0aW9uczogbWVtb2l6ZU9wdGlvbnNGcm9tQXJncwogIH0gOiBtZW1vaXplT3JPcHRpb25zOwogIGNvbnN0IGNyZWF0ZVNlbGVjdG9yMiA9ICguLi5jcmVhdGVTZWxlY3RvckFyZ3MpID0+IHsKICAgIGxldCByZWNvbXB1dGF0aW9ucyA9IDA7CiAgICBsZXQgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zID0gMDsKICAgIGxldCBsYXN0UmVzdWx0OwogICAgbGV0IGRpcmVjdGx5UGFzc2VkT3B0aW9ucyA9IHt9OwogICAgbGV0IHJlc3VsdEZ1bmMgPSBjcmVhdGVTZWxlY3RvckFyZ3MucG9wKCk7CiAgICBpZiAodHlwZW9mIHJlc3VsdEZ1bmMgPT09ICJvYmplY3QiKSB7CiAgICAgIGRpcmVjdGx5UGFzc2VkT3B0aW9ucyA9IHJlc3VsdEZ1bmM7CiAgICAgIHJlc3VsdEZ1bmMgPSBjcmVhdGVTZWxlY3RvckFyZ3MucG9wKCk7CiAgICB9CiAgICBhc3NlcnRJc0Z1bmN0aW9uKAogICAgICByZXN1bHRGdW5jLAogICAgICBgY3JlYXRlU2VsZWN0b3IgZXhwZWN0cyBhbiBvdXRwdXQgZnVuY3Rpb24gYWZ0ZXIgdGhlIGlucHV0cywgYnV0IHJlY2VpdmVkOiBbJHt0eXBlb2YgcmVzdWx0RnVuY31dYAogICAgKTsKICAgIGNvbnN0IGNvbWJpbmVkT3B0aW9ucyA9IHsKICAgICAgLi4uY3JlYXRlU2VsZWN0b3JDcmVhdG9yT3B0aW9ucywKICAgICAgLi4uZGlyZWN0bHlQYXNzZWRPcHRpb25zCiAgICB9OwogICAgY29uc3QgewogICAgICBtZW1vaXplLAogICAgICBtZW1vaXplT3B0aW9ucyA9IFtdLAogICAgICBhcmdzTWVtb2l6ZSA9IHdlYWtNYXBNZW1vaXplLAogICAgICBhcmdzTWVtb2l6ZU9wdGlvbnMgPSBbXSwKICAgICAgZGV2TW9kZUNoZWNrcyA9IHt9CiAgICB9ID0gY29tYmluZWRPcHRpb25zOwogICAgY29uc3QgZmluYWxNZW1vaXplT3B0aW9ucyA9IGVuc3VyZUlzQXJyYXkobWVtb2l6ZU9wdGlvbnMpOwogICAgY29uc3QgZmluYWxBcmdzTWVtb2l6ZU9wdGlvbnMgPSBlbnN1cmVJc0FycmF5KGFyZ3NNZW1vaXplT3B0aW9ucyk7CiAgICBjb25zdCBkZXBlbmRlbmNpZXMgPSBnZXREZXBlbmRlbmNpZXMoY3JlYXRlU2VsZWN0b3JBcmdzKTsKICAgIGNvbnN0IG1lbW9pemVkUmVzdWx0RnVuYyA9IG1lbW9pemUoZnVuY3Rpb24gcmVjb21wdXRhdGlvbldyYXBwZXIoKSB7CiAgICAgIHJlY29tcHV0YXRpb25zKys7CiAgICAgIHJldHVybiByZXN1bHRGdW5jLmFwcGx5KAogICAgICAgIG51bGwsCiAgICAgICAgYXJndW1lbnRzCiAgICAgICk7CiAgICB9LCAuLi5maW5hbE1lbW9pemVPcHRpb25zKTsKICAgIGxldCBmaXJzdFJ1biA9IHRydWU7CiAgICBjb25zdCBzZWxlY3RvciA9IGFyZ3NNZW1vaXplKGZ1bmN0aW9uIGRlcGVuZGVuY2llc0NoZWNrZXIoKSB7CiAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9ucysrOwogICAgICBjb25zdCBpbnB1dFNlbGVjdG9yUmVzdWx0cyA9IGNvbGxlY3RJbnB1dFNlbGVjdG9yUmVzdWx0cygKICAgICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICAgYXJndW1lbnRzCiAgICAgICk7CiAgICAgIGxhc3RSZXN1bHQgPSBtZW1vaXplZFJlc3VsdEZ1bmMuYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvclJlc3VsdHMpOwogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGNvbnN0IHsgaWRlbnRpdHlGdW5jdGlvbkNoZWNrLCBpbnB1dFN0YWJpbGl0eUNoZWNrIH0gPSBnZXREZXZNb2RlQ2hlY2tzRXhlY3V0aW9uSW5mbyhmaXJzdFJ1biwgZGV2TW9kZUNoZWNrcyk7CiAgICAgICAgaWYgKGlkZW50aXR5RnVuY3Rpb25DaGVjay5zaG91bGRSdW4pIHsKICAgICAgICAgIGlkZW50aXR5RnVuY3Rpb25DaGVjay5ydW4oCiAgICAgICAgICAgIHJlc3VsdEZ1bmMsCiAgICAgICAgICAgIGlucHV0U2VsZWN0b3JSZXN1bHRzLAogICAgICAgICAgICBsYXN0UmVzdWx0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoaW5wdXRTdGFiaWxpdHlDaGVjay5zaG91bGRSdW4pIHsKICAgICAgICAgIGNvbnN0IGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSA9IGNvbGxlY3RJbnB1dFNlbGVjdG9yUmVzdWx0cygKICAgICAgICAgICAgZGVwZW5kZW5jaWVzLAogICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICk7CiAgICAgICAgICBpbnB1dFN0YWJpbGl0eUNoZWNrLnJ1bigKICAgICAgICAgICAgeyBpbnB1dFNlbGVjdG9yUmVzdWx0cywgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5IH0sCiAgICAgICAgICAgIHsgbWVtb2l6ZSwgbWVtb2l6ZU9wdGlvbnM6IGZpbmFsTWVtb2l6ZU9wdGlvbnMgfSwKICAgICAgICAgICAgYXJndW1lbnRzCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZmlyc3RSdW4pCiAgICAgICAgICBmaXJzdFJ1biA9IGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBsYXN0UmVzdWx0OwogICAgfSwgLi4uZmluYWxBcmdzTWVtb2l6ZU9wdGlvbnMpOwogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oc2VsZWN0b3IsIHsKICAgICAgcmVzdWx0RnVuYywKICAgICAgbWVtb2l6ZWRSZXN1bHRGdW5jLAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9uczogKCkgPT4gZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zLAogICAgICByZXNldERlcGVuZGVuY3lSZWNvbXB1dGF0aW9uczogKCkgPT4gewogICAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9ucyA9IDA7CiAgICAgIH0sCiAgICAgIGxhc3RSZXN1bHQ6ICgpID0+IGxhc3RSZXN1bHQsCiAgICAgIHJlY29tcHV0YXRpb25zOiAoKSA9PiByZWNvbXB1dGF0aW9ucywKICAgICAgcmVzZXRSZWNvbXB1dGF0aW9uczogKCkgPT4gewogICAgICAgIHJlY29tcHV0YXRpb25zID0gMDsKICAgICAgfSwKICAgICAgbWVtb2l6ZSwKICAgICAgYXJnc01lbW9pemUKICAgIH0pOwogIH07CiAgT2JqZWN0LmFzc2lnbihjcmVhdGVTZWxlY3RvcjIsIHsKICAgIHdpdGhUeXBlczogKCkgPT4gY3JlYXRlU2VsZWN0b3IyCiAgfSk7CiAgcmV0dXJuIGNyZWF0ZVNlbGVjdG9yMjsKfQp2YXIgY3JlYXRlU2VsZWN0b3IgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlU2VsZWN0b3JDcmVhdG9yKHdlYWtNYXBNZW1vaXplKTsKdmFyIGNyZWF0ZVN0cnVjdHVyZWRTZWxlY3RvciA9IE9iamVjdC5hc3NpZ24oCiAgKGlucHV0U2VsZWN0b3JzT2JqZWN0LCBzZWxlY3RvckNyZWF0b3IgPSBjcmVhdGVTZWxlY3RvcikgPT4gewogICAgYXNzZXJ0SXNPYmplY3QoCiAgICAgIGlucHV0U2VsZWN0b3JzT2JqZWN0LAogICAgICBgY3JlYXRlU3RydWN0dXJlZFNlbGVjdG9yIGV4cGVjdHMgZmlyc3QgYXJndW1lbnQgdG8gYmUgYW4gb2JqZWN0IHdoZXJlIGVhY2ggcHJvcGVydHkgaXMgYSBzZWxlY3RvciwgaW5zdGVhZCByZWNlaXZlZCBhICR7dHlwZW9mIGlucHV0U2VsZWN0b3JzT2JqZWN0fWAKICAgICk7CiAgICBjb25zdCBpbnB1dFNlbGVjdG9yS2V5cyA9IE9iamVjdC5rZXlzKGlucHV0U2VsZWN0b3JzT2JqZWN0KTsKICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IGlucHV0U2VsZWN0b3JLZXlzLm1hcCgKICAgICAgKGtleSkgPT4gaW5wdXRTZWxlY3RvcnNPYmplY3Rba2V5XQogICAgKTsKICAgIGNvbnN0IHN0cnVjdHVyZWRTZWxlY3RvciA9IHNlbGVjdG9yQ3JlYXRvcigKICAgICAgZGVwZW5kZW5jaWVzLAogICAgICAoLi4uaW5wdXRTZWxlY3RvclJlc3VsdHMpID0+IHsKICAgICAgICByZXR1cm4gaW5wdXRTZWxlY3RvclJlc3VsdHMucmVkdWNlKChjb21wb3NpdGlvbiwgdmFsdWUsIGluZGV4KSA9PiB7CiAgICAgICAgICBjb21wb3NpdGlvbltpbnB1dFNlbGVjdG9yS2V5c1tpbmRleF1dID0gdmFsdWU7CiAgICAgICAgICByZXR1cm4gY29tcG9zaXRpb247CiAgICAgICAgfSwge30pOwogICAgICB9CiAgICApOwogICAgcmV0dXJuIHN0cnVjdHVyZWRTZWxlY3RvcjsKICB9LAogIHsgd2l0aFR5cGVzOiAoKSA9PiBjcmVhdGVTdHJ1Y3R1cmVkU2VsZWN0b3IgfQopOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvbGVnZW5kU2VsZWN0b3JzLmpzCnZhciBpbXBvcnRfc29ydEJ5ID0gX190b0VTTShyZXF1aXJlX3NvcnRCeTIoKSk7CnZhciBzZWxlY3RMZWdlbmRTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnNldHRpbmdzOwp2YXIgc2VsZWN0TGVnZW5kU2l6ZSA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnNpemU7CnZhciBzZWxlY3RBbGxMZWdlbmRQYXlsb2FkMkRBcnJheSA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnBheWxvYWQ7CnZhciBzZWxlY3RMZWdlbmRQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbExlZ2VuZFBheWxvYWQyREFycmF5LCBzZWxlY3RMZWdlbmRTZXR0aW5nc10sIChwYXlsb2FkcywgX3JlZjIpID0+IHsKICB2YXIgewogICAgaXRlbVNvcnRlcgogIH0gPSBfcmVmMjsKICB2YXIgZmxhdCA9IHBheWxvYWRzLmZsYXQoMSk7CiAgcmV0dXJuIGl0ZW1Tb3J0ZXIgPyAoMCwgaW1wb3J0X3NvcnRCeS5kZWZhdWx0KShmbGF0LCBpdGVtU29ydGVyKSA6IGZsYXQ7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3VzZUVsZW1lbnRPZmZzZXQuanMKdmFyIGltcG9ydF9yZWFjdDEwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgRVBTID0gMTsKZnVuY3Rpb24gdXNlRWxlbWVudE9mZnNldCgpIHsKICB2YXIgZXh0cmFEZXBlbmRlbmNpZXMgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1swXSA6IFtdOwogIHZhciBbbGFzdEJvdW5kaW5nQm94LCBzZXRMYXN0Qm91bmRpbmdCb3hdID0gKDAsIGltcG9ydF9yZWFjdDEwLnVzZVN0YXRlKSh7CiAgICBoZWlnaHQ6IDAsCiAgICBsZWZ0OiAwLAogICAgdG9wOiAwLAogICAgd2lkdGg6IDAKICB9KTsKICB2YXIgdXBkYXRlQm91bmRpbmdCb3ggPSAoMCwgaW1wb3J0X3JlYWN0MTAudXNlQ2FsbGJhY2spKAogICAgKG5vZGUpID0+IHsKICAgICAgaWYgKG5vZGUgIT0gbnVsbCkgewogICAgICAgIHZhciByZWN0ID0gbm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICB2YXIgYm94ID0gewogICAgICAgICAgaGVpZ2h0OiByZWN0LmhlaWdodCwKICAgICAgICAgIGxlZnQ6IHJlY3QubGVmdCwKICAgICAgICAgIHRvcDogcmVjdC50b3AsCiAgICAgICAgICB3aWR0aDogcmVjdC53aWR0aAogICAgICAgIH07CiAgICAgICAgaWYgKE1hdGguYWJzKGJveC5oZWlnaHQgLSBsYXN0Qm91bmRpbmdCb3guaGVpZ2h0KSA+IEVQUyB8fCBNYXRoLmFicyhib3gubGVmdCAtIGxhc3RCb3VuZGluZ0JveC5sZWZ0KSA+IEVQUyB8fCBNYXRoLmFicyhib3gudG9wIC0gbGFzdEJvdW5kaW5nQm94LnRvcCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LndpZHRoIC0gbGFzdEJvdW5kaW5nQm94LndpZHRoKSA+IEVQUykgewogICAgICAgICAgc2V0TGFzdEJvdW5kaW5nQm94KHsKICAgICAgICAgICAgaGVpZ2h0OiBib3guaGVpZ2h0LAogICAgICAgICAgICBsZWZ0OiBib3gubGVmdCwKICAgICAgICAgICAgdG9wOiBib3gudG9wLAogICAgICAgICAgICB3aWR0aDogYm94LndpZHRoCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzCiAgICBbbGFzdEJvdW5kaW5nQm94LndpZHRoLCBsYXN0Qm91bmRpbmdCb3guaGVpZ2h0LCBsYXN0Qm91bmRpbmdCb3gudG9wLCBsYXN0Qm91bmRpbmdCb3gubGVmdCwgLi4uZXh0cmFEZXBlbmRlbmNpZXNdCiAgKTsKICByZXR1cm4gW2xhc3RCb3VuZGluZ0JveCwgdXBkYXRlQm91bmRpbmdCb3hdOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvY2hhcnRMYXlvdXRDb250ZXh0LmpzCnZhciBpbXBvcnRfcmVhY3QxMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWR1eC9kaXN0L3JlZHV4Lm1qcwp2YXIgJCRvYnNlcnZhYmxlID0gLyogQF9fUFVSRV9fICovICgoKSA9PiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5vYnNlcnZhYmxlIHx8ICJAQG9ic2VydmFibGUiKSgpOwp2YXIgc3ltYm9sX29ic2VydmFibGVfZGVmYXVsdCA9ICQkb2JzZXJ2YWJsZTsKdmFyIHJhbmRvbVN0cmluZyA9ICgpID0+IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KS5zcGxpdCgiIikuam9pbigiLiIpOwp2YXIgQWN0aW9uVHlwZXMgPSB7CiAgSU5JVDogYEBAcmVkdXgvSU5JVCR7LyogQF9fUFVSRV9fICovIHJhbmRvbVN0cmluZygpfWAsCiAgUkVQTEFDRTogYEBAcmVkdXgvUkVQTEFDRSR7LyogQF9fUFVSRV9fICovIHJhbmRvbVN0cmluZygpfWAsCiAgUFJPQkVfVU5LTk9XTl9BQ1RJT046ICgpID0+IGBAQHJlZHV4L1BST0JFX1VOS05PV05fQUNUSU9OJHtyYW5kb21TdHJpbmcoKX1gCn07CnZhciBhY3Rpb25UeXBlc19kZWZhdWx0ID0gQWN0aW9uVHlwZXM7CmZ1bmN0aW9uIGlzUGxhaW5PYmplY3Qob2JqKSB7CiAgaWYgKHR5cGVvZiBvYmogIT09ICJvYmplY3QiIHx8IG9iaiA9PT0gbnVsbCkKICAgIHJldHVybiBmYWxzZTsKICBsZXQgcHJvdG8yID0gb2JqOwogIHdoaWxlIChPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8yKSAhPT0gbnVsbCkgewogICAgcHJvdG8yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvMik7CiAgfQogIHJldHVybiBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSA9PT0gcHJvdG8yIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmopID09PSBudWxsOwp9CmZ1bmN0aW9uIG1pbmlLaW5kT2YodmFsKSB7CiAgaWYgKHZhbCA9PT0gdm9pZCAwKQogICAgcmV0dXJuICJ1bmRlZmluZWQiOwogIGlmICh2YWwgPT09IG51bGwpCiAgICByZXR1cm4gIm51bGwiOwogIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsOwogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSAiYm9vbGVhbiI6CiAgICBjYXNlICJzdHJpbmciOgogICAgY2FzZSAibnVtYmVyIjoKICAgIGNhc2UgInN5bWJvbCI6CiAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgcmV0dXJuIHR5cGU7CiAgICB9CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHZhbCkpCiAgICByZXR1cm4gImFycmF5IjsKICBpZiAoaXNEYXRlKHZhbCkpCiAgICByZXR1cm4gImRhdGUiOwogIGlmIChpc0Vycm9yKHZhbCkpCiAgICByZXR1cm4gImVycm9yIjsKICBjb25zdCBjb25zdHJ1Y3Rvck5hbWUgPSBjdG9yTmFtZSh2YWwpOwogIHN3aXRjaCAoY29uc3RydWN0b3JOYW1lKSB7CiAgICBjYXNlICJTeW1ib2wiOgogICAgY2FzZSAiUHJvbWlzZSI6CiAgICBjYXNlICJXZWFrTWFwIjoKICAgIGNhc2UgIldlYWtTZXQiOgogICAgY2FzZSAiTWFwIjoKICAgIGNhc2UgIlNldCI6CiAgICAgIHJldHVybiBjb25zdHJ1Y3Rvck5hbWU7CiAgfQogIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9ccy9nLCAiIik7Cn0KZnVuY3Rpb24gY3Rvck5hbWUodmFsKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWwuY29uc3RydWN0b3IgPT09ICJmdW5jdGlvbiIgPyB2YWwuY29uc3RydWN0b3IubmFtZSA6IG51bGw7Cn0KZnVuY3Rpb24gaXNFcnJvcih2YWwpIHsKICByZXR1cm4gdmFsIGluc3RhbmNlb2YgRXJyb3IgfHwgdHlwZW9mIHZhbC5tZXNzYWdlID09PSAic3RyaW5nIiAmJiB2YWwuY29uc3RydWN0b3IgJiYgdHlwZW9mIHZhbC5jb25zdHJ1Y3Rvci5zdGFja1RyYWNlTGltaXQgPT09ICJudW1iZXIiOwp9CmZ1bmN0aW9uIGlzRGF0ZSh2YWwpIHsKICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkKICAgIHJldHVybiB0cnVlOwogIHJldHVybiB0eXBlb2YgdmFsLnRvRGF0ZVN0cmluZyA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgdmFsLmdldERhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHZhbC5zZXREYXRlID09PSAiZnVuY3Rpb24iOwp9CmZ1bmN0aW9uIGtpbmRPZih2YWwpIHsKICBsZXQgdHlwZU9mVmFsID0gdHlwZW9mIHZhbDsKICBpZiAodHJ1ZSkgewogICAgdHlwZU9mVmFsID0gbWluaUtpbmRPZih2YWwpOwogIH0KICByZXR1cm4gdHlwZU9mVmFsOwp9CmZ1bmN0aW9uIGNyZWF0ZVN0b3JlKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlLCBlbmhhbmNlcikgewogIGlmICh0eXBlb2YgcmVkdWNlciAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyKSA6IGBFeHBlY3RlZCB0aGUgcm9vdCByZWR1Y2VyIHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2YocmVkdWNlcil9J2ApOwogIH0KICBpZiAodHlwZW9mIHByZWxvYWRlZFN0YXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBlbmhhbmNlciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgZW5oYW5jZXIgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgwKSA6ICJJdCBsb29rcyBsaWtlIHlvdSBhcmUgcGFzc2luZyBzZXZlcmFsIHN0b3JlIGVuaGFuY2VycyB0byBjcmVhdGVTdG9yZSgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIEluc3RlYWQsIGNvbXBvc2UgdGhlbSB0b2dldGhlciB0byBhIHNpbmdsZSBmdW5jdGlvbi4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC00LXN0b3JlI2NyZWF0aW5nLWEtc3RvcmUtd2l0aC1lbmhhbmNlcnMgZm9yIGFuIGV4YW1wbGUuIik7CiAgfQogIGlmICh0eXBlb2YgcHJlbG9hZGVkU3RhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGVuaGFuY2VyID09PSAidW5kZWZpbmVkIikgewogICAgZW5oYW5jZXIgPSBwcmVsb2FkZWRTdGF0ZTsKICAgIHByZWxvYWRlZFN0YXRlID0gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIGVuaGFuY2VyICE9PSAidW5kZWZpbmVkIikgewogICAgaWYgKHR5cGVvZiBlbmhhbmNlciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEpIDogYEV4cGVjdGVkIHRoZSBlbmhhbmNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKGVuaGFuY2VyKX0nYCk7CiAgICB9CiAgICByZXR1cm4gZW5oYW5jZXIoY3JlYXRlU3RvcmUpKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlKTsKICB9CiAgbGV0IGN1cnJlbnRSZWR1Y2VyID0gcmVkdWNlcjsKICBsZXQgY3VycmVudFN0YXRlID0gcHJlbG9hZGVkU3RhdGU7CiAgbGV0IGN1cnJlbnRMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGxldCBuZXh0TGlzdGVuZXJzID0gY3VycmVudExpc3RlbmVyczsKICBsZXQgbGlzdGVuZXJJZENvdW50ZXIgPSAwOwogIGxldCBpc0Rpc3BhdGNoaW5nID0gZmFsc2U7CiAgZnVuY3Rpb24gZW5zdXJlQ2FuTXV0YXRlTmV4dExpc3RlbmVycygpIHsKICAgIGlmIChuZXh0TGlzdGVuZXJzID09PSBjdXJyZW50TGlzdGVuZXJzKSB7CiAgICAgIG5leHRMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBjdXJyZW50TGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVyMiwga2V5KSA9PiB7CiAgICAgICAgbmV4dExpc3RlbmVycy5zZXQoa2V5LCBsaXN0ZW5lcjIpOwogICAgICB9KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0U3RhdGUoKSB7CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMpIDogIllvdSBtYXkgbm90IGNhbGwgc3RvcmUuZ2V0U3RhdGUoKSB3aGlsZSB0aGUgcmVkdWNlciBpcyBleGVjdXRpbmcuIFRoZSByZWR1Y2VyIGhhcyBhbHJlYWR5IHJlY2VpdmVkIHRoZSBzdGF0ZSBhcyBhbiBhcmd1bWVudC4gUGFzcyBpdCBkb3duIGZyb20gdGhlIHRvcCByZWR1Y2VyIGluc3RlYWQgb2YgcmVhZGluZyBpdCBmcm9tIHRoZSBzdG9yZS4iKTsKICAgIH0KICAgIHJldHVybiBjdXJyZW50U3RhdGU7CiAgfQogIGZ1bmN0aW9uIHN1YnNjcmliZShsaXN0ZW5lcjIpIHsKICAgIGlmICh0eXBlb2YgbGlzdGVuZXIyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNCkgOiBgRXhwZWN0ZWQgdGhlIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2YobGlzdGVuZXIyKX0nYCk7CiAgICB9CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDUpIDogIllvdSBtYXkgbm90IGNhbGwgc3RvcmUuc3Vic2NyaWJlKCkgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBJZiB5b3Ugd291bGQgbGlrZSB0byBiZSBub3RpZmllZCBhZnRlciB0aGUgc3RvcmUgaGFzIGJlZW4gdXBkYXRlZCwgc3Vic2NyaWJlIGZyb20gYSBjb21wb25lbnQgYW5kIGludm9rZSBzdG9yZS5nZXRTdGF0ZSgpIGluIHRoZSBjYWxsYmFjayB0byBhY2Nlc3MgdGhlIGxhdGVzdCBzdGF0ZS4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2FwaS9zdG9yZSNzdWJzY3JpYmVsaXN0ZW5lciBmb3IgbW9yZSBkZXRhaWxzLiIpOwogICAgfQogICAgbGV0IGlzU3Vic2NyaWJlZCA9IHRydWU7CiAgICBlbnN1cmVDYW5NdXRhdGVOZXh0TGlzdGVuZXJzKCk7CiAgICBjb25zdCBsaXN0ZW5lcklkID0gbGlzdGVuZXJJZENvdW50ZXIrKzsKICAgIG5leHRMaXN0ZW5lcnMuc2V0KGxpc3RlbmVySWQsIGxpc3RlbmVyMik7CiAgICByZXR1cm4gZnVuY3Rpb24gdW5zdWJzY3JpYmUoKSB7CiAgICAgIGlmICghaXNTdWJzY3JpYmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChpc0Rpc3BhdGNoaW5nKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg2KSA6ICJZb3UgbWF5IG5vdCB1bnN1YnNjcmliZSBmcm9tIGEgc3RvcmUgbGlzdGVuZXIgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvYXBpL3N0b3JlI3N1YnNjcmliZWxpc3RlbmVyIGZvciBtb3JlIGRldGFpbHMuIik7CiAgICAgIH0KICAgICAgaXNTdWJzY3JpYmVkID0gZmFsc2U7CiAgICAgIGVuc3VyZUNhbk11dGF0ZU5leHRMaXN0ZW5lcnMoKTsKICAgICAgbmV4dExpc3RlbmVycy5kZWxldGUobGlzdGVuZXJJZCk7CiAgICAgIGN1cnJlbnRMaXN0ZW5lcnMgPSBudWxsOwogICAgfTsKICB9CiAgZnVuY3Rpb24gZGlzcGF0Y2goYWN0aW9uKSB7CiAgICBpZiAoIWlzUGxhaW5PYmplY3QoYWN0aW9uKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDcpIDogYEFjdGlvbnMgbXVzdCBiZSBwbGFpbiBvYmplY3RzLiBJbnN0ZWFkLCB0aGUgYWN0dWFsIHR5cGUgd2FzOiAnJHtraW5kT2YoYWN0aW9uKX0nLiBZb3UgbWF5IG5lZWQgdG8gYWRkIG1pZGRsZXdhcmUgdG8geW91ciBzdG9yZSBzZXR1cCB0byBoYW5kbGUgZGlzcGF0Y2hpbmcgb3RoZXIgdmFsdWVzLCBzdWNoIGFzICdyZWR1eC10aHVuaycgdG8gaGFuZGxlIGRpc3BhdGNoaW5nIGZ1bmN0aW9ucy4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC00LXN0b3JlI21pZGRsZXdhcmUgYW5kIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC02LWFzeW5jLWxvZ2ljI3VzaW5nLXRoZS1yZWR1eC10aHVuay1taWRkbGV3YXJlIGZvciBleGFtcGxlcy5gKTsKICAgIH0KICAgIGlmICh0eXBlb2YgYWN0aW9uLnR5cGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoOCkgOiAnQWN0aW9ucyBtYXkgbm90IGhhdmUgYW4gdW5kZWZpbmVkICJ0eXBlIiBwcm9wZXJ0eS4gWW91IG1heSBoYXZlIG1pc3NwZWxsZWQgYW4gYWN0aW9uIHR5cGUgc3RyaW5nIGNvbnN0YW50LicpOwogICAgfQogICAgaWYgKHR5cGVvZiBhY3Rpb24udHlwZSAhPT0gInN0cmluZyIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNykgOiBgQWN0aW9uICJ0eXBlIiBwcm9wZXJ0eSBtdXN0IGJlIGEgc3RyaW5nLiBJbnN0ZWFkLCB0aGUgYWN0dWFsIHR5cGUgd2FzOiAnJHtraW5kT2YoYWN0aW9uLnR5cGUpfScuIFZhbHVlIHdhczogJyR7YWN0aW9uLnR5cGV9JyAoc3RyaW5naWZpZWQpYCk7CiAgICB9CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDkpIDogIlJlZHVjZXJzIG1heSBub3QgZGlzcGF0Y2ggYWN0aW9ucy4iKTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGlzRGlzcGF0Y2hpbmcgPSB0cnVlOwogICAgICBjdXJyZW50U3RhdGUgPSBjdXJyZW50UmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICB9IGZpbmFsbHkgewogICAgICBpc0Rpc3BhdGNoaW5nID0gZmFsc2U7CiAgICB9CiAgICBjb25zdCBsaXN0ZW5lcnMgPSBjdXJyZW50TGlzdGVuZXJzID0gbmV4dExpc3RlbmVyczsKICAgIGxpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcjIpID0+IHsKICAgICAgbGlzdGVuZXIyKCk7CiAgICB9KTsKICAgIHJldHVybiBhY3Rpb247CiAgfQogIGZ1bmN0aW9uIHJlcGxhY2VSZWR1Y2VyKG5leHRSZWR1Y2VyKSB7CiAgICBpZiAodHlwZW9mIG5leHRSZWR1Y2VyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTApIDogYEV4cGVjdGVkIHRoZSBuZXh0UmVkdWNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKG5leHRSZWR1Y2VyKX1gKTsKICAgIH0KICAgIGN1cnJlbnRSZWR1Y2VyID0gbmV4dFJlZHVjZXI7CiAgICBkaXNwYXRjaCh7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuUkVQTEFDRQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CiAgICBjb25zdCBvdXRlclN1YnNjcmliZSA9IHN1YnNjcmliZTsKICAgIHJldHVybiB7CiAgICAgIC8qKgogICAgICAgKiBUaGUgbWluaW1hbCBvYnNlcnZhYmxlIHN1YnNjcmlwdGlvbiBtZXRob2QuCiAgICAgICAqIEBwYXJhbSBvYnNlcnZlciBBbnkgb2JqZWN0IHRoYXQgY2FuIGJlIHVzZWQgYXMgYW4gb2JzZXJ2ZXIuCiAgICAgICAqIFRoZSBvYnNlcnZlciBvYmplY3Qgc2hvdWxkIGhhdmUgYSBgbmV4dGAgbWV0aG9kLgogICAgICAgKiBAcmV0dXJucyBBbiBvYmplY3Qgd2l0aCBhbiBgdW5zdWJzY3JpYmVgIG1ldGhvZCB0aGF0IGNhbgogICAgICAgKiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlIHRoZSBvYnNlcnZhYmxlIGZyb20gdGhlIHN0b3JlLCBhbmQgcHJldmVudCBmdXJ0aGVyCiAgICAgICAqIGVtaXNzaW9uIG9mIHZhbHVlcyBmcm9tIHRoZSBvYnNlcnZhYmxlLgogICAgICAgKi8KICAgICAgc3Vic2NyaWJlKG9ic2VydmVyKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYnNlcnZlciAhPT0gIm9iamVjdCIgfHwgb2JzZXJ2ZXIgPT09IG51bGwpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTEpIDogYEV4cGVjdGVkIHRoZSBvYnNlcnZlciB0byBiZSBhbiBvYmplY3QuIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2Yob2JzZXJ2ZXIpfSdgKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb2JzZXJ2ZVN0YXRlKCkgewogICAgICAgICAgY29uc3Qgb2JzZXJ2ZXJBc09ic2VydmVyID0gb2JzZXJ2ZXI7CiAgICAgICAgICBpZiAob2JzZXJ2ZXJBc09ic2VydmVyLm5leHQpIHsKICAgICAgICAgICAgb2JzZXJ2ZXJBc09ic2VydmVyLm5leHQoZ2V0U3RhdGUoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG9ic2VydmVTdGF0ZSgpOwogICAgICAgIGNvbnN0IHVuc3Vic2NyaWJlID0gb3V0ZXJTdWJzY3JpYmUob2JzZXJ2ZVN0YXRlKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdW5zdWJzY3JpYmUKICAgICAgICB9OwogICAgICB9LAogICAgICBbc3ltYm9sX29ic2VydmFibGVfZGVmYXVsdF0oKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH07CiAgfQogIGRpc3BhdGNoKHsKICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuSU5JVAogIH0pOwogIGNvbnN0IHN0b3JlID0gewogICAgZGlzcGF0Y2gsCiAgICBzdWJzY3JpYmUsCiAgICBnZXRTdGF0ZSwKICAgIHJlcGxhY2VSZWR1Y2VyLAogICAgW3N5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHRdOiBvYnNlcnZhYmxlCiAgfTsKICByZXR1cm4gc3RvcmU7Cn0KZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7CiAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsKICB9CiAgdHJ5IHsKICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTsKICB9IGNhdGNoIChlKSB7CiAgfQp9CmZ1bmN0aW9uIGdldFVuZXhwZWN0ZWRTdGF0ZVNoYXBlV2FybmluZ01lc3NhZ2UoaW5wdXRTdGF0ZSwgcmVkdWNlcnMsIGFjdGlvbiwgdW5leHBlY3RlZEtleUNhY2hlKSB7CiAgY29uc3QgcmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhyZWR1Y2Vycyk7CiAgY29uc3QgYXJndW1lbnROYW1lID0gYWN0aW9uICYmIGFjdGlvbi50eXBlID09PSBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQgPyAicHJlbG9hZGVkU3RhdGUgYXJndW1lbnQgcGFzc2VkIHRvIGNyZWF0ZVN0b3JlIiA6ICJwcmV2aW91cyBzdGF0ZSByZWNlaXZlZCBieSB0aGUgcmVkdWNlciI7CiAgaWYgKHJlZHVjZXJLZXlzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuICJTdG9yZSBkb2VzIG5vdCBoYXZlIGEgdmFsaWQgcmVkdWNlci4gTWFrZSBzdXJlIHRoZSBhcmd1bWVudCBwYXNzZWQgdG8gY29tYmluZVJlZHVjZXJzIGlzIGFuIG9iamVjdCB3aG9zZSB2YWx1ZXMgYXJlIHJlZHVjZXJzLiI7CiAgfQogIGlmICghaXNQbGFpbk9iamVjdChpbnB1dFN0YXRlKSkgewogICAgcmV0dXJuIGBUaGUgJHthcmd1bWVudE5hbWV9IGhhcyB1bmV4cGVjdGVkIHR5cGUgb2YgIiR7a2luZE9mKGlucHV0U3RhdGUpfSIuIEV4cGVjdGVkIGFyZ3VtZW50IHRvIGJlIGFuIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcga2V5czogIiR7cmVkdWNlcktleXMuam9pbignIiwgIicpfSJgOwogIH0KICBjb25zdCB1bmV4cGVjdGVkS2V5cyA9IE9iamVjdC5rZXlzKGlucHV0U3RhdGUpLmZpbHRlcigoa2V5KSA9PiAhcmVkdWNlcnMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhdW5leHBlY3RlZEtleUNhY2hlW2tleV0pOwogIHVuZXhwZWN0ZWRLZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgdW5leHBlY3RlZEtleUNhY2hlW2tleV0gPSB0cnVlOwogIH0pOwogIGlmIChhY3Rpb24gJiYgYWN0aW9uLnR5cGUgPT09IGFjdGlvblR5cGVzX2RlZmF1bHQuUkVQTEFDRSkKICAgIHJldHVybjsKICBpZiAodW5leHBlY3RlZEtleXMubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGBVbmV4cGVjdGVkICR7dW5leHBlY3RlZEtleXMubGVuZ3RoID4gMSA/ICJrZXlzIiA6ICJrZXkifSAiJHt1bmV4cGVjdGVkS2V5cy5qb2luKCciLCAiJyl9IiBmb3VuZCBpbiAke2FyZ3VtZW50TmFtZX0uIEV4cGVjdGVkIHRvIGZpbmQgb25lIG9mIHRoZSBrbm93biByZWR1Y2VyIGtleXMgaW5zdGVhZDogIiR7cmVkdWNlcktleXMuam9pbignIiwgIicpfSIuIFVuZXhwZWN0ZWQga2V5cyB3aWxsIGJlIGlnbm9yZWQuYDsKICB9Cn0KZnVuY3Rpb24gYXNzZXJ0UmVkdWNlclNoYXBlKHJlZHVjZXJzKSB7CiAgT2JqZWN0LmtleXMocmVkdWNlcnMpLmZvckVhY2goKGtleSkgPT4gewogICAgY29uc3QgcmVkdWNlciA9IHJlZHVjZXJzW2tleV07CiAgICBjb25zdCBpbml0aWFsU3RhdGUxMyA9IHJlZHVjZXIodm9pZCAwLCB7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuSU5JVAogICAgfSk7CiAgICBpZiAodHlwZW9mIGluaXRpYWxTdGF0ZTEzID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEyKSA6IGBUaGUgc2xpY2UgcmVkdWNlciBmb3Iga2V5ICIke2tleX0iIHJldHVybmVkIHVuZGVmaW5lZCBkdXJpbmcgaW5pdGlhbGl6YXRpb24uIElmIHRoZSBzdGF0ZSBwYXNzZWQgdG8gdGhlIHJlZHVjZXIgaXMgdW5kZWZpbmVkLCB5b3UgbXVzdCBleHBsaWNpdGx5IHJldHVybiB0aGUgaW5pdGlhbCBzdGF0ZS4gVGhlIGluaXRpYWwgc3RhdGUgbWF5IG5vdCBiZSB1bmRlZmluZWQuIElmIHlvdSBkb24ndCB3YW50IHRvIHNldCBhIHZhbHVlIGZvciB0aGlzIHJlZHVjZXIsIHlvdSBjYW4gdXNlIG51bGwgaW5zdGVhZCBvZiB1bmRlZmluZWQuYCk7CiAgICB9CiAgICBpZiAodHlwZW9mIHJlZHVjZXIodm9pZCAwLCB7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuUFJPQkVfVU5LTk9XTl9BQ1RJT04oKQogICAgfSkgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTMpIDogYFRoZSBzbGljZSByZWR1Y2VyIGZvciBrZXkgIiR7a2V5fSIgcmV0dXJuZWQgdW5kZWZpbmVkIHdoZW4gcHJvYmVkIHdpdGggYSByYW5kb20gdHlwZS4gRG9uJ3QgdHJ5IHRvIGhhbmRsZSAnJHthY3Rpb25UeXBlc19kZWZhdWx0LklOSVR9JyBvciBvdGhlciBhY3Rpb25zIGluICJyZWR1eC8qIiBuYW1lc3BhY2UuIFRoZXkgYXJlIGNvbnNpZGVyZWQgcHJpdmF0ZS4gSW5zdGVhZCwgeW91IG11c3QgcmV0dXJuIHRoZSBjdXJyZW50IHN0YXRlIGZvciBhbnkgdW5rbm93biBhY3Rpb25zLCB1bmxlc3MgaXQgaXMgdW5kZWZpbmVkLCBpbiB3aGljaCBjYXNlIHlvdSBtdXN0IHJldHVybiB0aGUgaW5pdGlhbCBzdGF0ZSwgcmVnYXJkbGVzcyBvZiB0aGUgYWN0aW9uIHR5cGUuIFRoZSBpbml0aWFsIHN0YXRlIG1heSBub3QgYmUgdW5kZWZpbmVkLCBidXQgY2FuIGJlIG51bGwuYCk7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gY29tYmluZVJlZHVjZXJzKHJlZHVjZXJzKSB7CiAgY29uc3QgcmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhyZWR1Y2Vycyk7CiAgY29uc3QgZmluYWxSZWR1Y2VycyA9IHt9OwogIGZvciAobGV0IGkgPSAwOyBpIDwgcmVkdWNlcktleXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGtleSA9IHJlZHVjZXJLZXlzW2ldOwogICAgaWYgKHRydWUpIHsKICAgICAgaWYgKHR5cGVvZiByZWR1Y2Vyc1trZXldID09PSAidW5kZWZpbmVkIikgewogICAgICAgIHdhcm5pbmcoYE5vIHJlZHVjZXIgcHJvdmlkZWQgZm9yIGtleSAiJHtrZXl9ImApOwogICAgICB9CiAgICB9CiAgICBpZiAodHlwZW9mIHJlZHVjZXJzW2tleV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZmluYWxSZWR1Y2Vyc1trZXldID0gcmVkdWNlcnNba2V5XTsKICAgIH0KICB9CiAgY29uc3QgZmluYWxSZWR1Y2VyS2V5cyA9IE9iamVjdC5rZXlzKGZpbmFsUmVkdWNlcnMpOwogIGxldCB1bmV4cGVjdGVkS2V5Q2FjaGU7CiAgaWYgKHRydWUpIHsKICAgIHVuZXhwZWN0ZWRLZXlDYWNoZSA9IHt9OwogIH0KICBsZXQgc2hhcGVBc3NlcnRpb25FcnJvcjsKICB0cnkgewogICAgYXNzZXJ0UmVkdWNlclNoYXBlKGZpbmFsUmVkdWNlcnMpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHNoYXBlQXNzZXJ0aW9uRXJyb3IgPSBlOwogIH0KICByZXR1cm4gZnVuY3Rpb24gY29tYmluYXRpb24oc3RhdGUgPSB7fSwgYWN0aW9uKSB7CiAgICBpZiAoc2hhcGVBc3NlcnRpb25FcnJvcikgewogICAgICB0aHJvdyBzaGFwZUFzc2VydGlvbkVycm9yOwogICAgfQogICAgaWYgKHRydWUpIHsKICAgICAgY29uc3Qgd2FybmluZ01lc3NhZ2UgPSBnZXRVbmV4cGVjdGVkU3RhdGVTaGFwZVdhcm5pbmdNZXNzYWdlKHN0YXRlLCBmaW5hbFJlZHVjZXJzLCBhY3Rpb24sIHVuZXhwZWN0ZWRLZXlDYWNoZSk7CiAgICAgIGlmICh3YXJuaW5nTWVzc2FnZSkgewogICAgICAgIHdhcm5pbmcod2FybmluZ01lc3NhZ2UpOwogICAgICB9CiAgICB9CiAgICBsZXQgaGFzQ2hhbmdlZCA9IGZhbHNlOwogICAgY29uc3QgbmV4dFN0YXRlID0ge307CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbmFsUmVkdWNlcktleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0gZmluYWxSZWR1Y2VyS2V5c1tpXTsKICAgICAgY29uc3QgcmVkdWNlciA9IGZpbmFsUmVkdWNlcnNba2V5XTsKICAgICAgY29uc3QgcHJldmlvdXNTdGF0ZUZvcktleSA9IHN0YXRlW2tleV07CiAgICAgIGNvbnN0IG5leHRTdGF0ZUZvcktleSA9IHJlZHVjZXIocHJldmlvdXNTdGF0ZUZvcktleSwgYWN0aW9uKTsKICAgICAgaWYgKHR5cGVvZiBuZXh0U3RhdGVGb3JLZXkgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgY29uc3QgYWN0aW9uVHlwZSA9IGFjdGlvbiAmJiBhY3Rpb24udHlwZTsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE0KSA6IGBXaGVuIGNhbGxlZCB3aXRoIGFuIGFjdGlvbiBvZiB0eXBlICR7YWN0aW9uVHlwZSA/IGAiJHtTdHJpbmcoYWN0aW9uVHlwZSl9ImAgOiAiKHVua25vd24gdHlwZSkifSwgdGhlIHNsaWNlIHJlZHVjZXIgZm9yIGtleSAiJHtrZXl9IiByZXR1cm5lZCB1bmRlZmluZWQuIFRvIGlnbm9yZSBhbiBhY3Rpb24sIHlvdSBtdXN0IGV4cGxpY2l0bHkgcmV0dXJuIHRoZSBwcmV2aW91cyBzdGF0ZS4gSWYgeW91IHdhbnQgdGhpcyByZWR1Y2VyIHRvIGhvbGQgbm8gdmFsdWUsIHlvdSBjYW4gcmV0dXJuIG51bGwgaW5zdGVhZCBvZiB1bmRlZmluZWQuYCk7CiAgICAgIH0KICAgICAgbmV4dFN0YXRlW2tleV0gPSBuZXh0U3RhdGVGb3JLZXk7CiAgICAgIGhhc0NoYW5nZWQgPSBoYXNDaGFuZ2VkIHx8IG5leHRTdGF0ZUZvcktleSAhPT0gcHJldmlvdXNTdGF0ZUZvcktleTsKICAgIH0KICAgIGhhc0NoYW5nZWQgPSBoYXNDaGFuZ2VkIHx8IGZpbmFsUmVkdWNlcktleXMubGVuZ3RoICE9PSBPYmplY3Qua2V5cyhzdGF0ZSkubGVuZ3RoOwogICAgcmV0dXJuIGhhc0NoYW5nZWQgPyBuZXh0U3RhdGUgOiBzdGF0ZTsKICB9Owp9CmZ1bmN0aW9uIGNvbXBvc2UoLi4uZnVuY3MpIHsKICBpZiAoZnVuY3MubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gKGFyZykgPT4gYXJnOwogIH0KICBpZiAoZnVuY3MubGVuZ3RoID09PSAxKSB7CiAgICByZXR1cm4gZnVuY3NbMF07CiAgfQogIHJldHVybiBmdW5jcy5yZWR1Y2UoKGEsIGIpID0+ICguLi5hcmdzKSA9PiBhKGIoLi4uYXJncykpKTsKfQpmdW5jdGlvbiBhcHBseU1pZGRsZXdhcmUoLi4ubWlkZGxld2FyZXMpIHsKICByZXR1cm4gKGNyZWF0ZVN0b3JlMikgPT4gKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlKSA9PiB7CiAgICBjb25zdCBzdG9yZSA9IGNyZWF0ZVN0b3JlMihyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSk7CiAgICBsZXQgZGlzcGF0Y2ggPSAoKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTUpIDogIkRpc3BhdGNoaW5nIHdoaWxlIGNvbnN0cnVjdGluZyB5b3VyIG1pZGRsZXdhcmUgaXMgbm90IGFsbG93ZWQuIE90aGVyIG1pZGRsZXdhcmUgd291bGQgbm90IGJlIGFwcGxpZWQgdG8gdGhpcyBkaXNwYXRjaC4iKTsKICAgIH07CiAgICBjb25zdCBtaWRkbGV3YXJlQVBJID0gewogICAgICBnZXRTdGF0ZTogc3RvcmUuZ2V0U3RhdGUsCiAgICAgIGRpc3BhdGNoOiAoYWN0aW9uLCAuLi5hcmdzKSA9PiBkaXNwYXRjaChhY3Rpb24sIC4uLmFyZ3MpCiAgICB9OwogICAgY29uc3QgY2hhaW4gPSBtaWRkbGV3YXJlcy5tYXAoKG1pZGRsZXdhcmUpID0+IG1pZGRsZXdhcmUobWlkZGxld2FyZUFQSSkpOwogICAgZGlzcGF0Y2ggPSBjb21wb3NlKC4uLmNoYWluKShzdG9yZS5kaXNwYXRjaCk7CiAgICByZXR1cm4gewogICAgICAuLi5zdG9yZSwKICAgICAgZGlzcGF0Y2gKICAgIH07CiAgfTsKfQpmdW5jdGlvbiBpc0FjdGlvbihhY3Rpb24pIHsKICByZXR1cm4gaXNQbGFpbk9iamVjdChhY3Rpb24pICYmICJ0eXBlIiBpbiBhY3Rpb24gJiYgdHlwZW9mIGFjdGlvbi50eXBlID09PSAic3RyaW5nIjsKfQoKLy8gbm9kZV9tb2R1bGVzL0ByZWR1eGpzL3Rvb2xraXQvbm9kZV9tb2R1bGVzL2ltbWVyL2Rpc3QvaW1tZXIubWpzCnZhciBOT1RISU5HID0gU3ltYm9sLmZvcigiaW1tZXItbm90aGluZyIpOwp2YXIgRFJBRlRBQkxFID0gU3ltYm9sLmZvcigiaW1tZXItZHJhZnRhYmxlIik7CnZhciBEUkFGVF9TVEFURSA9IFN5bWJvbC5mb3IoImltbWVyLXN0YXRlIik7CnZhciBlcnJvcnMgPSB0cnVlID8gWwogIC8vIEFsbCBlcnJvciBjb2Rlcywgc3RhcnRpbmcgYnkgMDoKICBmdW5jdGlvbihwbHVnaW4pIHsKICAgIHJldHVybiBgVGhlIHBsdWdpbiBmb3IgJyR7cGx1Z2lufScgaGFzIG5vdCBiZWVuIGxvYWRlZCBpbnRvIEltbWVyLiBUbyBlbmFibGUgdGhlIHBsdWdpbiwgaW1wb3J0IGFuZCBjYWxsIFxgZW5hYmxlJHtwbHVnaW59KClcYCB3aGVuIGluaXRpYWxpemluZyB5b3VyIGFwcGxpY2F0aW9uLmA7CiAgfSwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGBwcm9kdWNlIGNhbiBvbmx5IGJlIGNhbGxlZCBvbiB0aGluZ3MgdGhhdCBhcmUgZHJhZnRhYmxlOiBwbGFpbiBvYmplY3RzLCBhcnJheXMsIE1hcCwgU2V0IG9yIGNsYXNzZXMgdGhhdCBhcmUgbWFya2VkIHdpdGggJ1tpbW1lcmFibGVdOiB0cnVlJy4gR290ICcke3RoaW5nfSdgOwogIH0sCiAgIlRoaXMgb2JqZWN0IGhhcyBiZWVuIGZyb3plbiBhbmQgc2hvdWxkIG5vdCBiZSBtdXRhdGVkIiwKICBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gIkNhbm5vdCB1c2UgYSBwcm94eSB0aGF0IGhhcyBiZWVuIHJldm9rZWQuIERpZCB5b3UgcGFzcyBhbiBvYmplY3QgZnJvbSBpbnNpZGUgYW4gaW1tZXIgZnVuY3Rpb24gdG8gYW4gYXN5bmMgcHJvY2Vzcz8gIiArIGRhdGE7CiAgfSwKICAiQW4gaW1tZXIgcHJvZHVjZXIgcmV0dXJuZWQgYSBuZXcgdmFsdWUgKmFuZCogbW9kaWZpZWQgaXRzIGRyYWZ0LiBFaXRoZXIgcmV0dXJuIGEgbmV3IHZhbHVlICpvciogbW9kaWZ5IHRoZSBkcmFmdC4iLAogICJJbW1lciBmb3JiaWRzIGNpcmN1bGFyIHJlZmVyZW5jZXMiLAogICJUaGUgZmlyc3Qgb3Igc2Vjb25kIGFyZ3VtZW50IHRvIGBwcm9kdWNlYCBtdXN0IGJlIGEgZnVuY3Rpb24iLAogICJUaGUgdGhpcmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiBvciB1bmRlZmluZWQiLAogICJGaXJzdCBhcmd1bWVudCB0byBgY3JlYXRlRHJhZnRgIG11c3QgYmUgYSBwbGFpbiBvYmplY3QsIGFuIGFycmF5LCBvciBhbiBpbW1lcmFibGUgb2JqZWN0IiwKICAiRmlyc3QgYXJndW1lbnQgdG8gYGZpbmlzaERyYWZ0YCBtdXN0IGJlIGEgZHJhZnQgcmV0dXJuZWQgYnkgYGNyZWF0ZURyYWZ0YCIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ2N1cnJlbnQnIGV4cGVjdHMgYSBkcmFmdCwgZ290OiAke3RoaW5nfWA7CiAgfSwKICAiT2JqZWN0LmRlZmluZVByb3BlcnR5KCkgY2Fubm90IGJlIHVzZWQgb24gYW4gSW1tZXIgZHJhZnQiLAogICJPYmplY3Quc2V0UHJvdG90eXBlT2YoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgZGVsZXRpbmcgYXJyYXkgaW5kaWNlcyIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgc2V0dGluZyBhcnJheSBpbmRpY2VzIGFuZCB0aGUgJ2xlbmd0aCcgcHJvcGVydHkiLAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYCdvcmlnaW5hbCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9CiAgLy8gTm90ZTogaWYgbW9yZSBlcnJvcnMgYXJlIGFkZGVkLCB0aGUgZXJyb3JPZmZzZXQgaW4gUGF0Y2hlcy50cyBzaG91bGQgYmUgaW5jcmVhc2VkCiAgLy8gU2VlIFBhdGNoZXMudHMgZm9yIGFkZGl0aW9uYWwgZXJyb3JzCl0gOiBbXTsKZnVuY3Rpb24gZGllKGVycm9yLCAuLi5hcmdzKSB7CiAgaWYgKHRydWUpIHsKICAgIGNvbnN0IGUgPSBlcnJvcnNbZXJyb3JdOwogICAgY29uc3QgbXNnID0gaXNGdW5jdGlvbihlKSA/IGUuYXBwbHkobnVsbCwgYXJncykgOiBlOwogICAgdGhyb3cgbmV3IEVycm9yKGBbSW1tZXJdICR7bXNnfWApOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoCiAgICBgW0ltbWVyXSBtaW5pZmllZCBlcnJvciBucjogJHtlcnJvcn0uIEZ1bGwgZXJyb3IgYXQ6IGh0dHBzOi8vYml0Lmx5LzNjWEVLV2ZgCiAgKTsKfQp2YXIgTyA9IE9iamVjdDsKdmFyIGdldFByb3RvdHlwZU9mID0gTy5nZXRQcm90b3R5cGVPZjsKdmFyIENPTlNUUlVDVE9SID0gImNvbnN0cnVjdG9yIjsKdmFyIFBST1RPVFlQRSA9ICJwcm90b3R5cGUiOwp2YXIgQ09ORklHVVJBQkxFID0gImNvbmZpZ3VyYWJsZSI7CnZhciBFTlVNRVJBQkxFID0gImVudW1lcmFibGUiOwp2YXIgV1JJVEFCTEUgPSAid3JpdGFibGUiOwp2YXIgVkFMVUUgPSAidmFsdWUiOwp2YXIgaXNEcmFmdCA9ICh2YWx1ZSkgPT4gISF2YWx1ZSAmJiAhIXZhbHVlW0RSQUZUX1NUQVRFXTsKZnVuY3Rpb24gaXNEcmFmdGFibGUodmFsdWUpIHsKICBpZiAoIXZhbHVlKQogICAgcmV0dXJuIGZhbHNlOwogIHJldHVybiBpc1BsYWluT2JqZWN0Mih2YWx1ZSkgfHwgaXNBcnJheSh2YWx1ZSkgfHwgISF2YWx1ZVtEUkFGVEFCTEVdIHx8ICEhdmFsdWVbQ09OU1RSVUNUT1JdPy5bRFJBRlRBQkxFXSB8fCBpc01hcCh2YWx1ZSkgfHwgaXNTZXQodmFsdWUpOwp9CnZhciBvYmplY3RDdG9yU3RyaW5nID0gT1tQUk9UT1RZUEVdW0NPTlNUUlVDVE9SXS50b1N0cmluZygpOwp2YXIgY2FjaGVkQ3RvclN0cmluZ3MgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKZnVuY3Rpb24gaXNQbGFpbk9iamVjdDIodmFsdWUpIHsKICBpZiAoIXZhbHVlIHx8ICFpc09iamVjdGlzaCh2YWx1ZSkpCiAgICByZXR1cm4gZmFsc2U7CiAgY29uc3QgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YodmFsdWUpOwogIGlmIChwcm90bzIgPT09IG51bGwgfHwgcHJvdG8yID09PSBPW1BST1RPVFlQRV0pCiAgICByZXR1cm4gdHJ1ZTsKICBjb25zdCBDdG9yID0gTy5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3RvMiwgQ09OU1RSVUNUT1IpICYmIHByb3RvMltDT05TVFJVQ1RPUl07CiAgaWYgKEN0b3IgPT09IE9iamVjdCkKICAgIHJldHVybiB0cnVlOwogIGlmICghaXNGdW5jdGlvbihDdG9yKSkKICAgIHJldHVybiBmYWxzZTsKICBsZXQgY3RvclN0cmluZyA9IGNhY2hlZEN0b3JTdHJpbmdzLmdldChDdG9yKTsKICBpZiAoY3RvclN0cmluZyA9PT0gdm9pZCAwKSB7CiAgICBjdG9yU3RyaW5nID0gRnVuY3Rpb24udG9TdHJpbmcuY2FsbChDdG9yKTsKICAgIGNhY2hlZEN0b3JTdHJpbmdzLnNldChDdG9yLCBjdG9yU3RyaW5nKTsKICB9CiAgcmV0dXJuIGN0b3JTdHJpbmcgPT09IG9iamVjdEN0b3JTdHJpbmc7Cn0KZnVuY3Rpb24gZWFjaChvYmosIGl0ZXIsIHN0cmljdCA9IHRydWUpIHsKICBpZiAoZ2V0QXJjaHR5cGUob2JqKSA9PT0gMCkgewogICAgY29uc3Qga2V5cyA9IHN0cmljdCA/IFJlZmxlY3Qub3duS2V5cyhvYmopIDogTy5rZXlzKG9iaik7CiAgICBrZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgICBpdGVyKGtleSwgb2JqW2tleV0sIG9iaik7CiAgICB9KTsKICB9IGVsc2UgewogICAgb2JqLmZvckVhY2goKGVudHJ5LCBpbmRleCkgPT4gaXRlcihpbmRleCwgZW50cnksIG9iaikpOwogIH0KfQpmdW5jdGlvbiBnZXRBcmNodHlwZSh0aGluZykgewogIGNvbnN0IHN0YXRlID0gdGhpbmdbRFJBRlRfU1RBVEVdOwogIHJldHVybiBzdGF0ZSA/IHN0YXRlLnR5cGVfIDogaXNBcnJheSh0aGluZykgPyAxIDogaXNNYXAodGhpbmcpID8gMiA6IGlzU2V0KHRoaW5nKSA/IDMgOiAwOwp9CnZhciBoYXMgPSAodGhpbmcsIHByb3AsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+IHR5cGUgPT09IDIgPyB0aGluZy5oYXMocHJvcCkgOiBPW1BST1RPVFlQRV0uaGFzT3duUHJvcGVydHkuY2FsbCh0aGluZywgcHJvcCk7CnZhciBnZXQyID0gKHRoaW5nLCBwcm9wLCB0eXBlID0gZ2V0QXJjaHR5cGUodGhpbmcpKSA9PiAoCiAgLy8gQHRzLWlnbm9yZQogIHR5cGUgPT09IDIgPyB0aGluZy5nZXQocHJvcCkgOiB0aGluZ1twcm9wXQopOwp2YXIgc2V0ID0gKHRoaW5nLCBwcm9wT3JPbGRWYWx1ZSwgdmFsdWUsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+IHsKICBpZiAodHlwZSA9PT0gMikKICAgIHRoaW5nLnNldChwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpOwogIGVsc2UgaWYgKHR5cGUgPT09IDMpIHsKICAgIHRoaW5nLmFkZCh2YWx1ZSk7CiAgfSBlbHNlCiAgICB0aGluZ1twcm9wT3JPbGRWYWx1ZV0gPSB2YWx1ZTsKfTsKZnVuY3Rpb24gaXMoeDIsIHkyKSB7CiAgaWYgKHgyID09PSB5MikgewogICAgcmV0dXJuIHgyICE9PSAwIHx8IDEgLyB4MiA9PT0gMSAvIHkyOwogIH0gZWxzZSB7CiAgICByZXR1cm4geDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9Cn0KdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5Owp2YXIgaXNNYXAgPSAodGFyZ2V0KSA9PiB0YXJnZXQgaW5zdGFuY2VvZiBNYXA7CnZhciBpc1NldCA9ICh0YXJnZXQpID0+IHRhcmdldCBpbnN0YW5jZW9mIFNldDsKdmFyIGlzT2JqZWN0aXNoID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gIm9iamVjdCI7CnZhciBpc0Z1bmN0aW9uID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gImZ1bmN0aW9uIjsKdmFyIGlzQm9vbGVhbiA9ICh0YXJnZXQpID0+IHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIjsKdmFyIGxhdGVzdCA9IChzdGF0ZSkgPT4gc3RhdGUuY29weV8gfHwgc3RhdGUuYmFzZV87CnZhciBnZXRGaW5hbFZhbHVlID0gKHN0YXRlKSA9PiBzdGF0ZS5tb2RpZmllZF8gPyBzdGF0ZS5jb3B5XyA6IHN0YXRlLmJhc2VfOwpmdW5jdGlvbiBzaGFsbG93Q29weShiYXNlLCBzdHJpY3QpIHsKICBpZiAoaXNNYXAoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgTWFwKGJhc2UpOwogIH0KICBpZiAoaXNTZXQoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgU2V0KGJhc2UpOwogIH0KICBpZiAoaXNBcnJheShiYXNlKSkKICAgIHJldHVybiBBcnJheVtQUk9UT1RZUEVdLnNsaWNlLmNhbGwoYmFzZSk7CiAgY29uc3QgaXNQbGFpbjIgPSBpc1BsYWluT2JqZWN0MihiYXNlKTsKICBpZiAoc3RyaWN0ID09PSB0cnVlIHx8IHN0cmljdCA9PT0gImNsYXNzX29ubHkiICYmICFpc1BsYWluMikgewogICAgY29uc3QgZGVzY3JpcHRvcnMgPSBPLmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoYmFzZSk7CiAgICBkZWxldGUgZGVzY3JpcHRvcnNbRFJBRlRfU1RBVEVdOwogICAgbGV0IGtleXMgPSBSZWZsZWN0Lm93bktleXMoZGVzY3JpcHRvcnMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgIGNvbnN0IGRlc2MgPSBkZXNjcmlwdG9yc1trZXldOwogICAgICBpZiAoZGVzY1tXUklUQUJMRV0gPT09IGZhbHNlKSB7CiAgICAgICAgZGVzY1tXUklUQUJMRV0gPSB0cnVlOwogICAgICAgIGRlc2NbQ09ORklHVVJBQkxFXSA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KQogICAgICAgIGRlc2NyaXB0b3JzW2tleV0gPSB7CiAgICAgICAgICBbQ09ORklHVVJBQkxFXTogdHJ1ZSwKICAgICAgICAgIFtXUklUQUJMRV06IHRydWUsCiAgICAgICAgICAvLyBjb3VsZCBsaXZlIHdpdGggISFkZXNjLnNldCBhcyB3ZWxsIGhlcmUuLi4KICAgICAgICAgIFtFTlVNRVJBQkxFXTogZGVzY1tFTlVNRVJBQkxFXSwKICAgICAgICAgIFtWQUxVRV06IGJhc2Vba2V5XQogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gTy5jcmVhdGUoZ2V0UHJvdG90eXBlT2YoYmFzZSksIGRlc2NyaXB0b3JzKTsKICB9IGVsc2UgewogICAgY29uc3QgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YoYmFzZSk7CiAgICBpZiAocHJvdG8yICE9PSBudWxsICYmIGlzUGxhaW4yKSB7CiAgICAgIHJldHVybiB7IC4uLmJhc2UgfTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IE8uY3JlYXRlKHByb3RvMik7CiAgICByZXR1cm4gTy5hc3NpZ24ob2JqLCBiYXNlKTsKICB9Cn0KZnVuY3Rpb24gZnJlZXplKG9iaiwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKGlzRnJvemVuKG9iaikgfHwgaXNEcmFmdChvYmopIHx8ICFpc0RyYWZ0YWJsZShvYmopKQogICAgcmV0dXJuIG9iajsKICBpZiAoZ2V0QXJjaHR5cGUob2JqKSA+IDEpIHsKICAgIE8uZGVmaW5lUHJvcGVydGllcyhvYmosIHsKICAgICAgc2V0OiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGFkZDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlLAogICAgICBjbGVhcjogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlLAogICAgICBkZWxldGU6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZQogICAgfSk7CiAgfQogIE8uZnJlZXplKG9iaik7CiAgaWYgKGRlZXApCiAgICBlYWNoKAogICAgICBvYmosCiAgICAgIChfa2V5LCB2YWx1ZSkgPT4gewogICAgICAgIGZyZWV6ZSh2YWx1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGZhbHNlCiAgICApOwogIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zKCkgewogIGRpZSgyKTsKfQp2YXIgZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlID0gewogIFtWQUxVRV06IGRvbnRNdXRhdGVGcm96ZW5Db2xsZWN0aW9ucwp9OwpmdW5jdGlvbiBpc0Zyb3plbihvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8ICFpc09iamVjdGlzaChvYmopKQogICAgcmV0dXJuIHRydWU7CiAgcmV0dXJuIE8uaXNGcm96ZW4ob2JqKTsKfQp2YXIgUGx1Z2luTWFwU2V0ID0gIk1hcFNldCI7CnZhciBQbHVnaW5QYXRjaGVzID0gIlBhdGNoZXMiOwp2YXIgcGx1Z2lucyA9IHt9OwpmdW5jdGlvbiBnZXRQbHVnaW4ocGx1Z2luS2V5KSB7CiAgY29uc3QgcGx1Z2luID0gcGx1Z2luc1twbHVnaW5LZXldOwogIGlmICghcGx1Z2luKSB7CiAgICBkaWUoMCwgcGx1Z2luS2V5KTsKICB9CiAgcmV0dXJuIHBsdWdpbjsKfQp2YXIgaXNQbHVnaW5Mb2FkZWQgPSAocGx1Z2luS2V5KSA9PiAhIXBsdWdpbnNbcGx1Z2luS2V5XTsKdmFyIGN1cnJlbnRTY29wZTsKdmFyIGdldEN1cnJlbnRTY29wZSA9ICgpID0+IGN1cnJlbnRTY29wZTsKdmFyIGNyZWF0ZVNjb3BlID0gKHBhcmVudF8sIGltbWVyXykgPT4gKHsKICBkcmFmdHNfOiBbXSwKICBwYXJlbnRfLAogIGltbWVyXywKICAvLyBXaGVuZXZlciB0aGUgbW9kaWZpZWQgZHJhZnQgY29udGFpbnMgYSBkcmFmdCBmcm9tIGFub3RoZXIgc2NvcGUsIHdlCiAgLy8gbmVlZCB0byBwcmV2ZW50IGF1dG8tZnJlZXppbmcgc28gdGhlIHVub3duZWQgZHJhZnQgY2FuIGJlIGZpbmFsaXplZC4KICBjYW5BdXRvRnJlZXplXzogdHJ1ZSwKICB1bmZpbmFsaXplZERyYWZ0c186IDAsCiAgaGFuZGxlZFNldF86IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgcHJvY2Vzc2VkRm9yUGF0Y2hlc186IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgbWFwU2V0UGx1Z2luXzogaXNQbHVnaW5Mb2FkZWQoUGx1Z2luTWFwU2V0KSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpIDogdm9pZCAwCn0pOwpmdW5jdGlvbiB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcikgewogIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICBzY29wZS5wYXRjaFBsdWdpbl8gPSBnZXRQbHVnaW4oUGx1Z2luUGF0Y2hlcyk7CiAgICBzY29wZS5wYXRjaGVzXyA9IFtdOwogICAgc2NvcGUuaW52ZXJzZVBhdGNoZXNfID0gW107CiAgICBzY29wZS5wYXRjaExpc3RlbmVyXyA9IHBhdGNoTGlzdGVuZXI7CiAgfQp9CmZ1bmN0aW9uIHJldm9rZVNjb3BlKHNjb3BlKSB7CiAgbGVhdmVTY29wZShzY29wZSk7CiAgc2NvcGUuZHJhZnRzXy5mb3JFYWNoKHJldm9rZURyYWZ0KTsKICBzY29wZS5kcmFmdHNfID0gbnVsbDsKfQpmdW5jdGlvbiBsZWF2ZVNjb3BlKHNjb3BlKSB7CiAgaWYgKHNjb3BlID09PSBjdXJyZW50U2NvcGUpIHsKICAgIGN1cnJlbnRTY29wZSA9IHNjb3BlLnBhcmVudF87CiAgfQp9CnZhciBlbnRlclNjb3BlID0gKGltbWVyMjIpID0+IGN1cnJlbnRTY29wZSA9IGNyZWF0ZVNjb3BlKGN1cnJlbnRTY29wZSwgaW1tZXIyMik7CmZ1bmN0aW9uIHJldm9rZURyYWZ0KGRyYWZ0KSB7CiAgY29uc3Qgc3RhdGUgPSBkcmFmdFtEUkFGVF9TVEFURV07CiAgaWYgKHN0YXRlLnR5cGVfID09PSAwIHx8IHN0YXRlLnR5cGVfID09PSAxKQogICAgc3RhdGUucmV2b2tlXygpOwogIGVsc2UKICAgIHN0YXRlLnJldm9rZWRfID0gdHJ1ZTsKfQpmdW5jdGlvbiBwcm9jZXNzUmVzdWx0KHJlc3VsdCwgc2NvcGUpIHsKICBzY29wZS51bmZpbmFsaXplZERyYWZ0c18gPSBzY29wZS5kcmFmdHNfLmxlbmd0aDsKICBjb25zdCBiYXNlRHJhZnQgPSBzY29wZS5kcmFmdHNfWzBdOwogIGNvbnN0IGlzUmVwbGFjZWQgPSByZXN1bHQgIT09IHZvaWQgMCAmJiByZXN1bHQgIT09IGJhc2VEcmFmdDsKICBpZiAoaXNSZXBsYWNlZCkgewogICAgaWYgKGJhc2VEcmFmdFtEUkFGVF9TVEFURV0ubW9kaWZpZWRfKSB7CiAgICAgIHJldm9rZVNjb3BlKHNjb3BlKTsKICAgICAgZGllKDQpOwogICAgfQogICAgaWYgKGlzRHJhZnRhYmxlKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gZmluYWxpemUoc2NvcGUsIHJlc3VsdCk7CiAgICB9CiAgICBjb25zdCB7IHBhdGNoUGx1Z2luXyB9ID0gc2NvcGU7CiAgICBpZiAocGF0Y2hQbHVnaW5fKSB7CiAgICAgIHBhdGNoUGx1Z2luXy5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oCiAgICAgICAgYmFzZURyYWZ0W0RSQUZUX1NUQVRFXS5iYXNlXywKICAgICAgICByZXN1bHQsCiAgICAgICAgc2NvcGUKICAgICAgKTsKICAgIH0KICB9IGVsc2UgewogICAgcmVzdWx0ID0gZmluYWxpemUoc2NvcGUsIGJhc2VEcmFmdCk7CiAgfQogIG1heWJlRnJlZXplKHNjb3BlLCByZXN1bHQsIHRydWUpOwogIHJldm9rZVNjb3BlKHNjb3BlKTsKICBpZiAoc2NvcGUucGF0Y2hlc18pIHsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfKHNjb3BlLnBhdGNoZXNfLCBzY29wZS5pbnZlcnNlUGF0Y2hlc18pOwogIH0KICByZXR1cm4gcmVzdWx0ICE9PSBOT1RISU5HID8gcmVzdWx0IDogdm9pZCAwOwp9CmZ1bmN0aW9uIGZpbmFsaXplKHJvb3RTY29wZSwgdmFsdWUpIHsKICBpZiAoaXNGcm96ZW4odmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogIGlmICghc3RhdGUpIHsKICAgIGNvbnN0IGZpbmFsVmFsdWUgPSBoYW5kbGVWYWx1ZSh2YWx1ZSwgcm9vdFNjb3BlLmhhbmRsZWRTZXRfLCByb290U2NvcGUpOwogICAgcmV0dXJuIGZpbmFsVmFsdWU7CiAgfQogIGlmICghaXNTYW1lU2NvcGUoc3RhdGUsIHJvb3RTY29wZSkpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICB9CiAgaWYgKCFzdGF0ZS5maW5hbGl6ZWRfKSB7CiAgICBjb25zdCB7IGNhbGxiYWNrc18gfSA9IHN0YXRlOwogICAgaWYgKGNhbGxiYWNrc18pIHsKICAgICAgd2hpbGUgKGNhbGxiYWNrc18ubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IGNhbGxiYWNrID0gY2FsbGJhY2tzXy5wb3AoKTsKICAgICAgICBjYWxsYmFjayhyb290U2NvcGUpOwogICAgICB9CiAgICB9CiAgICBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKTsKICB9CiAgcmV0dXJuIHN0YXRlLmNvcHlfOwp9CmZ1bmN0aW9uIG1heWJlRnJlZXplKHNjb3BlLCB2YWx1ZSwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKCFzY29wZS5wYXJlbnRfICYmIHNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiBzY29wZS5jYW5BdXRvRnJlZXplXykgewogICAgZnJlZXplKHZhbHVlLCBkZWVwKTsKICB9Cn0KZnVuY3Rpb24gbWFya1N0YXRlRmluYWxpemVkKHN0YXRlKSB7CiAgc3RhdGUuZmluYWxpemVkXyA9IHRydWU7CiAgc3RhdGUuc2NvcGVfLnVuZmluYWxpemVkRHJhZnRzXy0tOwp9CnZhciBpc1NhbWVTY29wZSA9IChzdGF0ZSwgcm9vdFNjb3BlKSA9PiBzdGF0ZS5zY29wZV8gPT09IHJvb3RTY29wZTsKdmFyIEVNUFRZX0xPQ0FUSU9OU19SRVNVTFQgPSBbXTsKZnVuY3Rpb24gdXBkYXRlRHJhZnRJblBhcmVudChwYXJlbnQsIGRyYWZ0VmFsdWUsIGZpbmFsaXplZFZhbHVlLCBvcmlnaW5hbEtleSkgewogIGNvbnN0IHBhcmVudENvcHkgPSBsYXRlc3QocGFyZW50KTsKICBjb25zdCBwYXJlbnRUeXBlID0gcGFyZW50LnR5cGVfOwogIGlmIChvcmlnaW5hbEtleSAhPT0gdm9pZCAwKSB7CiAgICBjb25zdCBjdXJyZW50VmFsdWUgPSBnZXQyKHBhcmVudENvcHksIG9yaWdpbmFsS2V5LCBwYXJlbnRUeXBlKTsKICAgIGlmIChjdXJyZW50VmFsdWUgPT09IGRyYWZ0VmFsdWUpIHsKICAgICAgc2V0KHBhcmVudENvcHksIG9yaWdpbmFsS2V5LCBmaW5hbGl6ZWRWYWx1ZSwgcGFyZW50VHlwZSk7CiAgICAgIHJldHVybjsKICAgIH0KICB9CiAgaWYgKCFwYXJlbnQuZHJhZnRMb2NhdGlvbnNfKSB7CiAgICBjb25zdCBkcmFmdExvY2F0aW9ucyA9IHBhcmVudC5kcmFmdExvY2F0aW9uc18gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgZWFjaChwYXJlbnRDb3B5LCAoa2V5LCB2YWx1ZSkgPT4gewogICAgICBpZiAoaXNEcmFmdCh2YWx1ZSkpIHsKICAgICAgICBjb25zdCBrZXlzID0gZHJhZnRMb2NhdGlvbnMuZ2V0KHZhbHVlKSB8fCBbXTsKICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICBkcmFmdExvY2F0aW9ucy5zZXQodmFsdWUsIGtleXMpOwogICAgICB9CiAgICB9KTsKICB9CiAgY29uc3QgbG9jYXRpb25zID0gcGFyZW50LmRyYWZ0TG9jYXRpb25zXy5nZXQoZHJhZnRWYWx1ZSkgPz8gRU1QVFlfTE9DQVRJT05TX1JFU1VMVDsKICBmb3IgKGNvbnN0IGxvY2F0aW9uIG9mIGxvY2F0aW9ucykgewogICAgc2V0KHBhcmVudENvcHksIGxvY2F0aW9uLCBmaW5hbGl6ZWRWYWx1ZSwgcGFyZW50VHlwZSk7CiAgfQp9CmZ1bmN0aW9uIHJlZ2lzdGVyQ2hpbGRGaW5hbGl6YXRpb25DYWxsYmFjayhwYXJlbnQsIGNoaWxkLCBrZXkpIHsKICBwYXJlbnQuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIGNoaWxkQ2xlYW51cChyb290U2NvcGUpIHsKICAgIGNvbnN0IHN0YXRlID0gY2hpbGQ7CiAgICBpZiAoIXN0YXRlIHx8ICFpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByb290U2NvcGUubWFwU2V0UGx1Z2luXz8uZml4U2V0Q29udGVudHMoc3RhdGUpOwogICAgY29uc3QgZmluYWxpemVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgIHVwZGF0ZURyYWZ0SW5QYXJlbnQocGFyZW50LCBzdGF0ZS5kcmFmdF8gPz8gc3RhdGUsIGZpbmFsaXplZFZhbHVlLCBrZXkpOwogICAgZ2VuZXJhdGVQYXRjaGVzQW5kRmluYWxpemUoc3RhdGUsIHJvb3RTY29wZSk7CiAgfSk7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVQYXRjaGVzQW5kRmluYWxpemUoc3RhdGUsIHJvb3RTY29wZSkgewogIGNvbnN0IHNob3VsZEZpbmFsaXplID0gc3RhdGUubW9kaWZpZWRfICYmICFzdGF0ZS5maW5hbGl6ZWRfICYmIChzdGF0ZS50eXBlXyA9PT0gMyB8fCAoc3RhdGUuYXNzaWduZWRfPy5zaXplID8/IDApID4gMCk7CiAgaWYgKHNob3VsZEZpbmFsaXplKSB7CiAgICBjb25zdCB7IHBhdGNoUGx1Z2luXyB9ID0gcm9vdFNjb3BlOwogICAgaWYgKHBhdGNoUGx1Z2luXykgewogICAgICBjb25zdCBiYXNlUGF0aCA9IHBhdGNoUGx1Z2luXy5nZXRQYXRoKHN0YXRlKTsKICAgICAgaWYgKGJhc2VQYXRoKSB7CiAgICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUGF0Y2hlc18oc3RhdGUsIGJhc2VQYXRoLCByb290U2NvcGUpOwogICAgICB9CiAgICB9CiAgICBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpOwogIH0KfQpmdW5jdGlvbiBoYW5kbGVDcm9zc1JlZmVyZW5jZSh0YXJnZXQsIGtleSwgdmFsdWUpIHsKICBjb25zdCB7IHNjb3BlXyB9ID0gdGFyZ2V0OwogIGlmIChpc0RyYWZ0KHZhbHVlKSkgewogICAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgICBpZiAoaXNTYW1lU2NvcGUoc3RhdGUsIHNjb3BlXykpIHsKICAgICAgc3RhdGUuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIGNyb3NzUmVmZXJlbmNlQ2xlYW51cCgpIHsKICAgICAgICBwcmVwYXJlQ29weSh0YXJnZXQpOwogICAgICAgIGNvbnN0IGZpbmFsaXplZFZhbHVlID0gZ2V0RmluYWxWYWx1ZShzdGF0ZSk7CiAgICAgICAgdXBkYXRlRHJhZnRJblBhcmVudCh0YXJnZXQsIHZhbHVlLCBmaW5hbGl6ZWRWYWx1ZSwga2V5KTsKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChpc0RyYWZ0YWJsZSh2YWx1ZSkpIHsKICAgIHRhcmdldC5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gbmVzdGVkRHJhZnRDbGVhbnVwKCkgewogICAgICBjb25zdCB0YXJnZXRDb3B5ID0gbGF0ZXN0KHRhcmdldCk7CiAgICAgIGlmIChnZXQyKHRhcmdldENvcHksIGtleSwgdGFyZ2V0LnR5cGVfKSA9PT0gdmFsdWUpIHsKICAgICAgICBpZiAoc2NvcGVfLmRyYWZ0c18ubGVuZ3RoID4gMSAmJiAodGFyZ2V0LmFzc2lnbmVkXy5nZXQoa2V5KSA/PyBmYWxzZSkgPT09IHRydWUgJiYgdGFyZ2V0LmNvcHlfKSB7CiAgICAgICAgICBoYW5kbGVWYWx1ZSgKICAgICAgICAgICAgZ2V0Mih0YXJnZXQuY29weV8sIGtleSwgdGFyZ2V0LnR5cGVfKSwKICAgICAgICAgICAgc2NvcGVfLmhhbmRsZWRTZXRfLAogICAgICAgICAgICBzY29wZV8KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9Cn0KZnVuY3Rpb24gaGFuZGxlVmFsdWUodGFyZ2V0LCBoYW5kbGVkU2V0LCByb290U2NvcGUpIHsKICBpZiAoIXJvb3RTY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgcm9vdFNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA8IDEpIHsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIGlmIChpc0RyYWZ0KHRhcmdldCkgfHwgaGFuZGxlZFNldC5oYXModGFyZ2V0KSB8fCAhaXNEcmFmdGFibGUodGFyZ2V0KSB8fCBpc0Zyb3plbih0YXJnZXQpKSB7CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KICBoYW5kbGVkU2V0LmFkZCh0YXJnZXQpOwogIGVhY2godGFyZ2V0LCAoa2V5LCB2YWx1ZSkgPT4gewogICAgaWYgKGlzRHJhZnQodmFsdWUpKSB7CiAgICAgIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogICAgICBpZiAoaXNTYW1lU2NvcGUoc3RhdGUsIHJvb3RTY29wZSkpIHsKICAgICAgICBjb25zdCB1cGRhdGVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgICAgICBzZXQodGFyZ2V0LCBrZXksIHVwZGF0ZWRWYWx1ZSwgdGFyZ2V0LnR5cGVfKTsKICAgICAgICBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgICBoYW5kbGVWYWx1ZSh2YWx1ZSwgaGFuZGxlZFNldCwgcm9vdFNjb3BlKTsKICAgIH0KICB9KTsKICByZXR1cm4gdGFyZ2V0Owp9CmZ1bmN0aW9uIGNyZWF0ZVByb3h5UHJveHkoYmFzZSwgcGFyZW50KSB7CiAgY29uc3QgYmFzZUlzQXJyYXkgPSBpc0FycmF5KGJhc2UpOwogIGNvbnN0IHN0YXRlID0gewogICAgdHlwZV86IGJhc2VJc0FycmF5ID8gMSA6IDAsCiAgICAvLyBUcmFjayB3aGljaCBwcm9kdWNlIGNhbGwgdGhpcyBpcyBhc3NvY2lhdGVkIHdpdGguCiAgICBzY29wZV86IHBhcmVudCA/IHBhcmVudC5zY29wZV8gOiBnZXRDdXJyZW50U2NvcGUoKSwKICAgIC8vIFRydWUgZm9yIGJvdGggc2hhbGxvdyBhbmQgZGVlcCBjaGFuZ2VzLgogICAgbW9kaWZpZWRfOiBmYWxzZSwKICAgIC8vIFVzZWQgZHVyaW5nIGZpbmFsaXphdGlvbi4KICAgIGZpbmFsaXplZF86IGZhbHNlLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvcGVydGllcyBoYXZlIGJlZW4gYXNzaWduZWQgKHRydWUpIG9yIGRlbGV0ZWQgKGZhbHNlKS4KICAgIC8vIGFjdHVhbGx5IGluc3RhbnRpYXRlZCBpbiBgcHJlcGFyZUNvcHkoKWAKICAgIGFzc2lnbmVkXzogdm9pZCAwLAogICAgLy8gVGhlIHBhcmVudCBkcmFmdCBzdGF0ZS4KICAgIHBhcmVudF86IHBhcmVudCwKICAgIC8vIFRoZSBiYXNlIHN0YXRlLgogICAgYmFzZV86IGJhc2UsCiAgICAvLyBUaGUgYmFzZSBwcm94eS4KICAgIGRyYWZ0XzogbnVsbCwKICAgIC8vIHNldCBiZWxvdwogICAgLy8gVGhlIGJhc2UgY29weSB3aXRoIGFueSB1cGRhdGVkIHZhbHVlcy4KICAgIGNvcHlfOiBudWxsLAogICAgLy8gQ2FsbGVkIGJ5IHRoZSBgcHJvZHVjZWAgZnVuY3Rpb24uCiAgICByZXZva2VfOiBudWxsLAogICAgaXNNYW51YWxfOiBmYWxzZSwKICAgIC8vIGBjYWxsYmFja3NgIGFjdHVhbGx5IGdldHMgYXNzaWduZWQgaW4gYGNyZWF0ZVByb3h5YAogICAgY2FsbGJhY2tzXzogdm9pZCAwCiAgfTsKICBsZXQgdGFyZ2V0ID0gc3RhdGU7CiAgbGV0IHRyYXBzID0gb2JqZWN0VHJhcHM7CiAgaWYgKGJhc2VJc0FycmF5KSB7CiAgICB0YXJnZXQgPSBbc3RhdGVdOwogICAgdHJhcHMgPSBhcnJheVRyYXBzOwogIH0KICBjb25zdCB7IHJldm9rZSwgcHJveHkgfSA9IFByb3h5LnJldm9jYWJsZSh0YXJnZXQsIHRyYXBzKTsKICBzdGF0ZS5kcmFmdF8gPSBwcm94eTsKICBzdGF0ZS5yZXZva2VfID0gcmV2b2tlOwogIHJldHVybiBbcHJveHksIHN0YXRlXTsKfQp2YXIgb2JqZWN0VHJhcHMgPSB7CiAgZ2V0KHN0YXRlLCBwcm9wKSB7CiAgICBpZiAocHJvcCA9PT0gRFJBRlRfU1RBVEUpCiAgICAgIHJldHVybiBzdGF0ZTsKICAgIGNvbnN0IHNvdXJjZSA9IGxhdGVzdChzdGF0ZSk7CiAgICBpZiAoIWhhcyhzb3VyY2UsIHByb3AsIHN0YXRlLnR5cGVfKSkgewogICAgICByZXR1cm4gcmVhZFByb3BGcm9tUHJvdG8oc3RhdGUsIHNvdXJjZSwgcHJvcCk7CiAgICB9CiAgICBjb25zdCB2YWx1ZSA9IHNvdXJjZVtwcm9wXTsKICAgIGlmIChzdGF0ZS5maW5hbGl6ZWRfIHx8ICFpc0RyYWZ0YWJsZSh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKHZhbHVlID09PSBwZWVrKHN0YXRlLmJhc2VfLCBwcm9wKSkgewogICAgICBwcmVwYXJlQ29weShzdGF0ZSk7CiAgICAgIGNvbnN0IGNoaWxkS2V5ID0gc3RhdGUudHlwZV8gPT09IDEgPyArcHJvcCA6IHByb3A7CiAgICAgIGNvbnN0IGNoaWxkRHJhZnQgPSBjcmVhdGVQcm94eShzdGF0ZS5zY29wZV8sIHZhbHVlLCBzdGF0ZSwgY2hpbGRLZXkpOwogICAgICByZXR1cm4gc3RhdGUuY29weV9bY2hpbGRLZXldID0gY2hpbGREcmFmdDsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9LAogIGhhcyhzdGF0ZSwgcHJvcCkgewogICAgcmV0dXJuIHByb3AgaW4gbGF0ZXN0KHN0YXRlKTsKICB9LAogIG93bktleXMoc3RhdGUpIHsKICAgIHJldHVybiBSZWZsZWN0Lm93bktleXMobGF0ZXN0KHN0YXRlKSk7CiAgfSwKICBzZXQoc3RhdGUsIHByb3AsIHZhbHVlKSB7CiAgICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90byhsYXRlc3Qoc3RhdGUpLCBwcm9wKTsKICAgIGlmIChkZXNjPy5zZXQpIHsKICAgICAgZGVzYy5zZXQuY2FsbChzdGF0ZS5kcmFmdF8sIHZhbHVlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgICBjb25zdCBjdXJyZW50MjIgPSBwZWVrKGxhdGVzdChzdGF0ZSksIHByb3ApOwogICAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBjdXJyZW50MjI/LltEUkFGVF9TVEFURV07CiAgICAgIGlmIChjdXJyZW50U3RhdGUgJiYgY3VycmVudFN0YXRlLmJhc2VfID09PSB2YWx1ZSkgewogICAgICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICAgICAgc3RhdGUuYXNzaWduZWRfLnNldChwcm9wLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzKHZhbHVlLCBjdXJyZW50MjIpICYmICh2YWx1ZSAhPT0gdm9pZCAwIHx8IGhhcyhzdGF0ZS5iYXNlXywgcHJvcCwgc3RhdGUudHlwZV8pKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgcHJlcGFyZUNvcHkoc3RhdGUpOwogICAgICBtYXJrQ2hhbmdlZChzdGF0ZSk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV9bcHJvcF0gPT09IHZhbHVlICYmIC8vIHNwZWNpYWwgY2FzZTogaGFuZGxlIG5ldyBwcm9wcyB3aXRoIHZhbHVlICd1bmRlZmluZWQnCiAgICAodmFsdWUgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmNvcHlfKSB8fCAvLyBzcGVjaWFsIGNhc2U6IE5hTgogICAgTnVtYmVyLmlzTmFOKHZhbHVlKSAmJiBOdW1iZXIuaXNOYU4oc3RhdGUuY29weV9bcHJvcF0pKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIHRydWUpOwogICAgaGFuZGxlQ3Jvc3NSZWZlcmVuY2Uoc3RhdGUsIHByb3AsIHZhbHVlKTsKICAgIHJldHVybiB0cnVlOwogIH0sCiAgZGVsZXRlUHJvcGVydHkoc3RhdGUsIHByb3ApIHsKICAgIHByZXBhcmVDb3B5KHN0YXRlKTsKICAgIGlmIChwZWVrKHN0YXRlLmJhc2VfLCBwcm9wKSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuYmFzZV8pIHsKICAgICAgc3RhdGUuYXNzaWduZWRfLnNldChwcm9wLCBmYWxzZSk7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YXRlLmFzc2lnbmVkXy5kZWxldGUocHJvcCk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV8pIHsKICAgICAgZGVsZXRlIHN0YXRlLmNvcHlfW3Byb3BdOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfSwKICAvLyBOb3RlOiBXZSBuZXZlciBjb2VyY2UgYGRlc2MudmFsdWVgIGludG8gYW4gSW1tZXIgZHJhZnQsIGJlY2F1c2Ugd2UgY2FuJ3QgbWFrZQogIC8vIHRoZSBzYW1lIGd1YXJhbnRlZSBpbiBFUzUgbW9kZS4KICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc3RhdGUsIHByb3ApIHsKICAgIGNvbnN0IG93bmVyID0gbGF0ZXN0KHN0YXRlKTsKICAgIGNvbnN0IGRlc2MgPSBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvd25lciwgcHJvcCk7CiAgICBpZiAoIWRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcmV0dXJuIHsKICAgICAgW1dSSVRBQkxFXTogdHJ1ZSwKICAgICAgW0NPTkZJR1VSQUJMRV06IHN0YXRlLnR5cGVfICE9PSAxIHx8IHByb3AgIT09ICJsZW5ndGgiLAogICAgICBbRU5VTUVSQUJMRV06IGRlc2NbRU5VTUVSQUJMRV0sCiAgICAgIFtWQUxVRV06IG93bmVyW3Byb3BdCiAgICB9OwogIH0sCiAgZGVmaW5lUHJvcGVydHkoKSB7CiAgICBkaWUoMTEpOwogIH0sCiAgZ2V0UHJvdG90eXBlT2Yoc3RhdGUpIHsKICAgIHJldHVybiBnZXRQcm90b3R5cGVPZihzdGF0ZS5iYXNlXyk7CiAgfSwKICBzZXRQcm90b3R5cGVPZigpIHsKICAgIGRpZSgxMik7CiAgfQp9Owp2YXIgYXJyYXlUcmFwcyA9IHt9OwplYWNoKG9iamVjdFRyYXBzLCAoa2V5LCBmbikgPT4gewogIGFycmF5VHJhcHNba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgY29uc3QgYXJncyA9IGFyZ3VtZW50czsKICAgIGFyZ3NbMF0gPSBhcmdzWzBdWzBdOwogICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwogIH07Cn0pOwphcnJheVRyYXBzLmRlbGV0ZVByb3BlcnR5ID0gZnVuY3Rpb24oc3RhdGUsIHByb3ApIHsKICBpZiAoaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllKDEzKTsKICByZXR1cm4gYXJyYXlUcmFwcy5zZXQuY2FsbCh0aGlzLCBzdGF0ZSwgcHJvcCwgdm9pZCAwKTsKfTsKYXJyYXlUcmFwcy5zZXQgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICBpZiAocHJvcCAhPT0gImxlbmd0aCIgJiYgaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllKDE0KTsKICByZXR1cm4gb2JqZWN0VHJhcHMuc2V0LmNhbGwodGhpcywgc3RhdGVbMF0sIHByb3AsIHZhbHVlLCBzdGF0ZVswXSk7Cn07CmZ1bmN0aW9uIHBlZWsoZHJhZnQsIHByb3ApIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFXTsKICBjb25zdCBzb3VyY2UgPSBzdGF0ZSA/IGxhdGVzdChzdGF0ZSkgOiBkcmFmdDsKICByZXR1cm4gc291cmNlW3Byb3BdOwp9CmZ1bmN0aW9uIHJlYWRQcm9wRnJvbVByb3RvKHN0YXRlLCBzb3VyY2UsIHByb3ApIHsKICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90byhzb3VyY2UsIHByb3ApOwogIHJldHVybiBkZXNjID8gVkFMVUUgaW4gZGVzYyA/IGRlc2NbVkFMVUVdIDogKAogICAgLy8gVGhpcyBpcyBhIHZlcnkgc3BlY2lhbCBjYXNlLCBpZiB0aGUgcHJvcCBpcyBhIGdldHRlciBkZWZpbmVkIGJ5IHRoZQogICAgLy8gcHJvdG90eXBlLCB3ZSBzaG91bGQgaW52b2tlIGl0IHdpdGggdGhlIGRyYWZ0IGFzIGNvbnRleHQhCiAgICBkZXNjLmdldD8uY2FsbChzdGF0ZS5kcmFmdF8pCiAgKSA6IHZvaWQgMDsKfQpmdW5jdGlvbiBnZXREZXNjcmlwdG9yRnJvbVByb3RvKHNvdXJjZSwgcHJvcCkgewogIGlmICghKHByb3AgaW4gc291cmNlKSkKICAgIHJldHVybiB2b2lkIDA7CiAgbGV0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mKHNvdXJjZSk7CiAgd2hpbGUgKHByb3RvMikgewogICAgY29uc3QgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdG8yLCBwcm9wKTsKICAgIGlmIChkZXNjKQogICAgICByZXR1cm4gZGVzYzsKICAgIHByb3RvMiA9IGdldFByb3RvdHlwZU9mKHByb3RvMik7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFya0NoYW5nZWQoc3RhdGUpIHsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgc3RhdGUubW9kaWZpZWRfID0gdHJ1ZTsKICAgIGlmIChzdGF0ZS5wYXJlbnRfKSB7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlLnBhcmVudF8pOwogICAgfQogIH0KfQpmdW5jdGlvbiBwcmVwYXJlQ29weShzdGF0ZSkgewogIGlmICghc3RhdGUuY29weV8pIHsKICAgIHN0YXRlLmFzc2lnbmVkXyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBzdGF0ZS5jb3B5XyA9IHNoYWxsb3dDb3B5KAogICAgICBzdGF0ZS5iYXNlXywKICAgICAgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8KICAgICk7CiAgfQp9CnZhciBJbW1lcjIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29uZmlnKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdHJ1ZTsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gZmFsc2U7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSBmYWxzZTsKICAgIHRoaXMucHJvZHVjZSA9IChiYXNlLCByZWNpcGUsIHBhdGNoTGlzdGVuZXIpID0+IHsKICAgICAgaWYgKGlzRnVuY3Rpb24oYmFzZSkgJiYgIWlzRnVuY3Rpb24ocmVjaXBlKSkgewogICAgICAgIGNvbnN0IGRlZmF1bHRCYXNlID0gcmVjaXBlOwogICAgICAgIHJlY2lwZSA9IGJhc2U7CiAgICAgICAgY29uc3Qgc2VsZjIgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBjdXJyaWVkUHJvZHVjZShiYXNlMiA9IGRlZmF1bHRCYXNlLCAuLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gc2VsZjIucHJvZHVjZShiYXNlMiwgKGRyYWZ0KSA9PiByZWNpcGUuY2FsbCh0aGlzLCBkcmFmdCwgLi4uYXJncykpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKCFpc0Z1bmN0aW9uKHJlY2lwZSkpCiAgICAgICAgZGllKDYpOwogICAgICBpZiAocGF0Y2hMaXN0ZW5lciAhPT0gdm9pZCAwICYmICFpc0Z1bmN0aW9uKHBhdGNoTGlzdGVuZXIpKQogICAgICAgIGRpZSg3KTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgaWYgKGlzRHJhZnRhYmxlKGJhc2UpKSB7CiAgICAgICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlKHRoaXMpOwogICAgICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkoc2NvcGUsIGJhc2UsIHZvaWQgMCk7CiAgICAgICAgbGV0IGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzdWx0ID0gcmVjaXBlKHByb3h5KTsKICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChoYXNFcnJvcikKICAgICAgICAgICAgcmV2b2tlU2NvcGUoc2NvcGUpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICBsZWF2ZVNjb3BlKHNjb3BlKTsKICAgICAgICB9CiAgICAgICAgdXNlUGF0Y2hlc0luU2NvcGUoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgICAgIHJldHVybiBwcm9jZXNzUmVzdWx0KHJlc3VsdCwgc2NvcGUpOwogICAgICB9IGVsc2UgaWYgKCFiYXNlIHx8ICFpc09iamVjdGlzaChiYXNlKSkgewogICAgICAgIHJlc3VsdCA9IHJlY2lwZShiYXNlKTsKICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApCiAgICAgICAgICByZXN1bHQgPSBiYXNlOwogICAgICAgIGlmIChyZXN1bHQgPT09IE5PVEhJTkcpCiAgICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgaWYgKHRoaXMuYXV0b0ZyZWV6ZV8pCiAgICAgICAgICBmcmVlemUocmVzdWx0LCB0cnVlKTsKICAgICAgICBpZiAocGF0Y2hMaXN0ZW5lcikgewogICAgICAgICAgY29uc3QgcCA9IFtdOwogICAgICAgICAgY29uc3QgaXAgPSBbXTsKICAgICAgICAgIGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKS5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oYmFzZSwgcmVzdWx0LCB7CiAgICAgICAgICAgIHBhdGNoZXNfOiBwLAogICAgICAgICAgICBpbnZlcnNlUGF0Y2hlc186IGlwCiAgICAgICAgICB9KTsKICAgICAgICAgIHBhdGNoTGlzdGVuZXIocCwgaXApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9IGVsc2UKICAgICAgICBkaWUoMSwgYmFzZSk7CiAgICB9OwogICAgdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMgPSAoYmFzZSwgcmVjaXBlKSA9PiB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKGJhc2UpKSB7CiAgICAgICAgcmV0dXJuIChzdGF0ZSwgLi4uYXJncykgPT4gdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMoc3RhdGUsIChkcmFmdCkgPT4gYmFzZShkcmFmdCwgLi4uYXJncykpOwogICAgICB9CiAgICAgIGxldCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlczsKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wcm9kdWNlKGJhc2UsIHJlY2lwZSwgKHAsIGlwKSA9PiB7CiAgICAgICAgcGF0Y2hlcyA9IHA7CiAgICAgICAgaW52ZXJzZVBhdGNoZXMgPSBpcDsKICAgICAgfSk7CiAgICAgIHJldHVybiBbcmVzdWx0LCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlc107CiAgICB9OwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LmF1dG9GcmVlemUpKQogICAgICB0aGlzLnNldEF1dG9GcmVlemUoY29uZmlnLmF1dG9GcmVlemUpOwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LnVzZVN0cmljdFNoYWxsb3dDb3B5KSkKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RTaGFsbG93Q29weShjb25maWcudXNlU3RyaWN0U2hhbGxvd0NvcHkpOwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LnVzZVN0cmljdEl0ZXJhdGlvbikpCiAgICAgIHRoaXMuc2V0VXNlU3RyaWN0SXRlcmF0aW9uKGNvbmZpZy51c2VTdHJpY3RJdGVyYXRpb24pOwogIH0KICBjcmVhdGVEcmFmdChiYXNlKSB7CiAgICBpZiAoIWlzRHJhZnRhYmxlKGJhc2UpKQogICAgICBkaWUoOCk7CiAgICBpZiAoaXNEcmFmdChiYXNlKSkKICAgICAgYmFzZSA9IGN1cnJlbnQoYmFzZSk7CiAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUodGhpcyk7CiAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5KHNjb3BlLCBiYXNlLCB2b2lkIDApOwogICAgcHJveHlbRFJBRlRfU1RBVEVdLmlzTWFudWFsXyA9IHRydWU7CiAgICBsZWF2ZVNjb3BlKHNjb3BlKTsKICAgIHJldHVybiBwcm94eTsKICB9CiAgZmluaXNoRHJhZnQoZHJhZnQsIHBhdGNoTGlzdGVuZXIpIHsKICAgIGNvbnN0IHN0YXRlID0gZHJhZnQgJiYgZHJhZnRbRFJBRlRfU1RBVEVdOwogICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuaXNNYW51YWxfKQogICAgICBkaWUoOSk7CiAgICBjb25zdCB7IHNjb3BlXzogc2NvcGUgfSA9IHN0YXRlOwogICAgdXNlUGF0Y2hlc0luU2NvcGUoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQodm9pZCAwLCBzY29wZSk7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBhdXRvbWF0aWNhbGx5IGZyZWV6ZSBhbGwgY29waWVzIGNyZWF0ZWQgYnkgSW1tZXIuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBhdXRvLWZyZWV6aW5nIGlzIGVuYWJsZWQuCiAgICovCiAgc2V0QXV0b0ZyZWV6ZSh2YWx1ZSkgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gZW5hYmxlIHN0cmljdCBzaGFsbG93IGNvcHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBpbW1lciBkb2VzIG5vdCBjb3B5IHRoZSBvYmplY3QgZGVzY3JpcHRvcnMgc3VjaCBhcyBnZXR0ZXIsIHNldHRlciBhbmQgbm9uLWVudW1yYWJsZSBwcm9wZXJ0aWVzLgogICAqLwogIHNldFVzZVN0cmljdFNoYWxsb3dDb3B5KHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIGZhbHNlIHRvIHVzZSBmYXN0ZXIgaXRlcmF0aW9uIHRoYXQgc2tpcHMgbm9uLWVudW1lcmFibGUgcHJvcGVydGllcwogICAqIGJ1dCBzdGlsbCBoYW5kbGVzIHN5bWJvbHMgZm9yIGNvbXBhdGliaWxpdHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBzdHJpY3QgaXRlcmF0aW9uIGlzIGVuYWJsZWQgKGluY2x1ZGVzIGFsbCBvd24gcHJvcGVydGllcykuCiAgICovCiAgc2V0VXNlU3RyaWN0SXRlcmF0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB2YWx1ZTsKICB9CiAgc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCkgewogICAgcmV0dXJuIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXzsKICB9CiAgYXBwbHlQYXRjaGVzKGJhc2UsIHBhdGNoZXMpIHsKICAgIGxldCBpOwogICAgZm9yIChpID0gcGF0Y2hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwYXRjaCA9IHBhdGNoZXNbaV07CiAgICAgIGlmIChwYXRjaC5wYXRoLmxlbmd0aCA9PT0gMCAmJiBwYXRjaC5vcCA9PT0gInJlcGxhY2UiKSB7CiAgICAgICAgYmFzZSA9IHBhdGNoLnZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoaSA+IC0xKSB7CiAgICAgIHBhdGNoZXMgPSBwYXRjaGVzLnNsaWNlKGkgKyAxKTsKICAgIH0KICAgIGNvbnN0IGFwcGx5UGF0Y2hlc0ltcGwgPSBnZXRQbHVnaW4oUGx1Z2luUGF0Y2hlcykuYXBwbHlQYXRjaGVzXzsKICAgIGlmIChpc0RyYWZ0KGJhc2UpKSB7CiAgICAgIHJldHVybiBhcHBseVBhdGNoZXNJbXBsKGJhc2UsIHBhdGNoZXMpOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvZHVjZSgKICAgICAgYmFzZSwKICAgICAgKGRyYWZ0KSA9PiBhcHBseVBhdGNoZXNJbXBsKGRyYWZ0LCBwYXRjaGVzKQogICAgKTsKICB9Cn07CmZ1bmN0aW9uIGNyZWF0ZVByb3h5KHJvb3RTY29wZSwgdmFsdWUsIHBhcmVudCwga2V5KSB7CiAgY29uc3QgW2RyYWZ0LCBzdGF0ZV0gPSBpc01hcCh2YWx1ZSkgPyBnZXRQbHVnaW4oUGx1Z2luTWFwU2V0KS5wcm94eU1hcF8odmFsdWUsIHBhcmVudCkgOiBpc1NldCh2YWx1ZSkgPyBnZXRQbHVnaW4oUGx1Z2luTWFwU2V0KS5wcm94eVNldF8odmFsdWUsIHBhcmVudCkgOiBjcmVhdGVQcm94eVByb3h5KHZhbHVlLCBwYXJlbnQpOwogIGNvbnN0IHNjb3BlID0gcGFyZW50Py5zY29wZV8gPz8gZ2V0Q3VycmVudFNjb3BlKCk7CiAgc2NvcGUuZHJhZnRzXy5wdXNoKGRyYWZ0KTsKICBzdGF0ZS5jYWxsYmFja3NfID0gcGFyZW50Py5jYWxsYmFja3NfID8/IFtdOwogIHN0YXRlLmtleV8gPSBrZXk7CiAgaWYgKHBhcmVudCAmJiBrZXkgIT09IHZvaWQgMCkgewogICAgcmVnaXN0ZXJDaGlsZEZpbmFsaXphdGlvbkNhbGxiYWNrKHBhcmVudCwgc3RhdGUsIGtleSk7CiAgfSBlbHNlIHsKICAgIHN0YXRlLmNhbGxiYWNrc18ucHVzaChmdW5jdGlvbiByb290RHJhZnRDbGVhbnVwKHJvb3RTY29wZTIpIHsKICAgICAgcm9vdFNjb3BlMi5tYXBTZXRQbHVnaW5fPy5maXhTZXRDb250ZW50cyhzdGF0ZSk7CiAgICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSByb290U2NvcGUyOwogICAgICBpZiAoc3RhdGUubW9kaWZpZWRfICYmIHBhdGNoUGx1Z2luXykgewogICAgICAgIHBhdGNoUGx1Z2luXy5nZW5lcmF0ZVBhdGNoZXNfKHN0YXRlLCBbXSwgcm9vdFNjb3BlMik7CiAgICAgIH0KICAgIH0pOwogIH0KICByZXR1cm4gZHJhZnQ7Cn0KZnVuY3Rpb24gY3VycmVudCh2YWx1ZSkgewogIGlmICghaXNEcmFmdCh2YWx1ZSkpCiAgICBkaWUoMTAsIHZhbHVlKTsKICByZXR1cm4gY3VycmVudEltcGwodmFsdWUpOwp9CmZ1bmN0aW9uIGN1cnJlbnRJbXBsKHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0YWJsZSh2YWx1ZSkgfHwgaXNGcm96ZW4odmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogIGxldCBjb3B5MzsKICBsZXQgc3RyaWN0ID0gdHJ1ZTsKICBpZiAoc3RhdGUpIHsKICAgIGlmICghc3RhdGUubW9kaWZpZWRfKQogICAgICByZXR1cm4gc3RhdGUuYmFzZV87CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkodmFsdWUsIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfKTsKICAgIHN0cmljdCA9IHN0YXRlLnNjb3BlXy5pbW1lcl8uc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCk7CiAgfSBlbHNlIHsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkodmFsdWUsIHRydWUpOwogIH0KICBlYWNoKAogICAgY29weTMsCiAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiB7CiAgICAgIHNldChjb3B5Mywga2V5LCBjdXJyZW50SW1wbChjaGlsZFZhbHVlKSk7CiAgICB9LAogICAgc3RyaWN0CiAgKTsKICBpZiAoc3RhdGUpIHsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSBmYWxzZTsKICB9CiAgcmV0dXJuIGNvcHkzOwp9CnZhciBpbW1lciA9IG5ldyBJbW1lcjIoKTsKdmFyIHByb2R1Y2UgPSBpbW1lci5wcm9kdWNlOwoKLy8gbm9kZV9tb2R1bGVzL3JlZHV4LXRodW5rL2Rpc3QvcmVkdXgtdGh1bmsubWpzCmZ1bmN0aW9uIGNyZWF0ZVRodW5rTWlkZGxld2FyZShleHRyYUFyZ3VtZW50KSB7CiAgY29uc3QgbWlkZGxld2FyZSA9ICh7IGRpc3BhdGNoLCBnZXRTdGF0ZSB9KSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIGFjdGlvbihkaXNwYXRjaCwgZ2V0U3RhdGUsIGV4dHJhQXJndW1lbnQpOwogICAgfQogICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICB9OwogIHJldHVybiBtaWRkbGV3YXJlOwp9CnZhciB0aHVuayA9IGNyZWF0ZVRodW5rTWlkZGxld2FyZSgpOwp2YXIgd2l0aEV4dHJhQXJndW1lbnQgPSBjcmVhdGVUaHVua01pZGRsZXdhcmU7CgovLyBub2RlX21vZHVsZXMvQHJlZHV4anMvdG9vbGtpdC9kaXN0L3JlZHV4LXRvb2xraXQubW9kZXJuLm1qcwp2YXIgY29tcG9zZVdpdGhEZXZUb29scyA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9DT01QT1NFX18gPyB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fQ09NUE9TRV9fIDogZnVuY3Rpb24oKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHJldHVybiB2b2lkIDA7CiAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICJvYmplY3QiKSByZXR1cm4gY29tcG9zZTsKICByZXR1cm4gY29tcG9zZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9Owp2YXIgZGV2VG9vbHNFbmhhbmNlciA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9fID8gd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX18gOiBmdW5jdGlvbigpIHsKICByZXR1cm4gZnVuY3Rpb24obm9vcDMyKSB7CiAgICByZXR1cm4gbm9vcDMyOwogIH07Cn07CnZhciBoYXNNYXRjaEZ1bmN0aW9uID0gKHYpID0+IHsKICByZXR1cm4gdiAmJiB0eXBlb2Ygdi5tYXRjaCA9PT0gImZ1bmN0aW9uIjsKfTsKZnVuY3Rpb24gY3JlYXRlQWN0aW9uKHR5cGUsIHByZXBhcmVBY3Rpb24pIHsKICBmdW5jdGlvbiBhY3Rpb25DcmVhdG9yKC4uLmFyZ3MpIHsKICAgIGlmIChwcmVwYXJlQWN0aW9uKSB7CiAgICAgIGxldCBwcmVwYXJlZCA9IHByZXBhcmVBY3Rpb24oLi4uYXJncyk7CiAgICAgIGlmICghcHJlcGFyZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDApIDogInByZXBhcmVBY3Rpb24gZGlkIG5vdCByZXR1cm4gYW4gb2JqZWN0Iik7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB0eXBlLAogICAgICAgIHBheWxvYWQ6IHByZXBhcmVkLnBheWxvYWQsCiAgICAgICAgLi4uIm1ldGEiIGluIHByZXBhcmVkICYmIHsKICAgICAgICAgIG1ldGE6IHByZXBhcmVkLm1ldGEKICAgICAgICB9LAogICAgICAgIC4uLiJlcnJvciIgaW4gcHJlcGFyZWQgJiYgewogICAgICAgICAgZXJyb3I6IHByZXBhcmVkLmVycm9yCiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgcmV0dXJuIHsKICAgICAgdHlwZSwKICAgICAgcGF5bG9hZDogYXJnc1swXQogICAgfTsKICB9CiAgYWN0aW9uQ3JlYXRvci50b1N0cmluZyA9ICgpID0+IGAke3R5cGV9YDsKICBhY3Rpb25DcmVhdG9yLnR5cGUgPSB0eXBlOwogIGFjdGlvbkNyZWF0b3IubWF0Y2ggPSAoYWN0aW9uKSA9PiBpc0FjdGlvbihhY3Rpb24pICYmIGFjdGlvbi50eXBlID09PSB0eXBlOwogIHJldHVybiBhY3Rpb25DcmVhdG9yOwp9CmZ1bmN0aW9uIGlzQWN0aW9uQ3JlYXRvcihhY3Rpb24pIHsKICByZXR1cm4gdHlwZW9mIGFjdGlvbiA9PT0gImZ1bmN0aW9uIiAmJiAidHlwZSIgaW4gYWN0aW9uICYmIC8vIGhhc01hdGNoRnVuY3Rpb24gb25seSB3YW50cyBNYXRjaGVycyBidXQgSSBkb24ndCBzZWUgdGhlIHBvaW50IGluIHJld3JpdGluZyBpdAogIGhhc01hdGNoRnVuY3Rpb24oYWN0aW9uKTsKfQpmdW5jdGlvbiBnZXRNZXNzYWdlKHR5cGUpIHsKICBjb25zdCBzcGxpdFR5cGUgPSB0eXBlID8gYCR7dHlwZX1gLnNwbGl0KCIvIikgOiBbXTsKICBjb25zdCBhY3Rpb25OYW1lID0gc3BsaXRUeXBlW3NwbGl0VHlwZS5sZW5ndGggLSAxXSB8fCAiYWN0aW9uQ3JlYXRvciI7CiAgcmV0dXJuIGBEZXRlY3RlZCBhbiBhY3Rpb24gY3JlYXRvciB3aXRoIHR5cGUgIiR7dHlwZSB8fCAidW5rbm93biJ9IiBiZWluZyBkaXNwYXRjaGVkLiAKTWFrZSBzdXJlIHlvdSdyZSBjYWxsaW5nIHRoZSBhY3Rpb24gY3JlYXRvciBiZWZvcmUgZGlzcGF0Y2hpbmcsIGkuZS4gXGBkaXNwYXRjaCgke2FjdGlvbk5hbWV9KCkpXGAgaW5zdGVhZCBvZiBcYGRpc3BhdGNoKCR7YWN0aW9uTmFtZX0pXGAuIFRoaXMgaXMgbmVjZXNzYXJ5IGV2ZW4gaWYgdGhlIGFjdGlvbiBoYXMgbm8gcGF5bG9hZC5gOwp9CmZ1bmN0aW9uIGNyZWF0ZUFjdGlvbkNyZWF0b3JJbnZhcmlhbnRNaWRkbGV3YXJlKG9wdGlvbnMgPSB7fSkgewogIGlmIChmYWxzZSkgewogICAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiBuZXh0KGFjdGlvbik7CiAgfQogIGNvbnN0IHsKICAgIGlzQWN0aW9uQ3JlYXRvcjogaXNBY3Rpb25DcmVhdG9yMiA9IGlzQWN0aW9uQ3JlYXRvcgogIH0gPSBvcHRpb25zOwogIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgaWYgKGlzQWN0aW9uQ3JlYXRvcjIoYWN0aW9uKSkgewogICAgICBjb25zb2xlLndhcm4oZ2V0TWVzc2FnZShhY3Rpb24udHlwZSkpOwogICAgfQogICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICB9Owp9CmZ1bmN0aW9uIGdldFRpbWVNZWFzdXJlVXRpbHMobWF4RGVsYXksIGZuTmFtZSkgewogIGxldCBlbGFwc2VkID0gMDsKICByZXR1cm4gewogICAgbWVhc3VyZVRpbWUoZm4pIHsKICAgICAgY29uc3Qgc3RhcnRlZCA9IERhdGUubm93KCk7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgY29uc3QgZmluaXNoZWQgPSBEYXRlLm5vdygpOwogICAgICAgIGVsYXBzZWQgKz0gZmluaXNoZWQgLSBzdGFydGVkOwogICAgICB9CiAgICB9LAogICAgd2FybklmRXhjZWVkZWQoKSB7CiAgICAgIGlmIChlbGFwc2VkID4gbWF4RGVsYXkpIHsKICAgICAgICBjb25zb2xlLndhcm4oYCR7Zm5OYW1lfSB0b29rICR7ZWxhcHNlZH1tcywgd2hpY2ggaXMgbW9yZSB0aGFuIHRoZSB3YXJuaW5nIHRocmVzaG9sZCBvZiAke21heERlbGF5fW1zLiAKSWYgeW91ciBzdGF0ZSBvciBhY3Rpb25zIGFyZSB2ZXJ5IGxhcmdlLCB5b3UgbWF5IHdhbnQgdG8gZGlzYWJsZSB0aGUgbWlkZGxld2FyZSBhcyBpdCBtaWdodCBjYXVzZSB0b28gbXVjaCBvZiBhIHNsb3dkb3duIGluIGRldmVsb3BtZW50IG1vZGUuIFNlZSBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL2FwaS9nZXREZWZhdWx0TWlkZGxld2FyZSBmb3IgaW5zdHJ1Y3Rpb25zLgpJdCBpcyBkaXNhYmxlZCBpbiBwcm9kdWN0aW9uIGJ1aWxkcywgc28geW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgdGhhdC5gKTsKICAgICAgfQogICAgfQogIH07Cn0KdmFyIFR1cGxlID0gY2xhc3MgX1R1cGxlIGV4dGVuZHMgQXJyYXkgewogIGNvbnN0cnVjdG9yKC4uLml0ZW1zKSB7CiAgICBzdXBlciguLi5pdGVtcyk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YodGhpcywgX1R1cGxlLnByb3RvdHlwZSk7CiAgfQogIHN0YXRpYyBnZXQgW1N5bWJvbC5zcGVjaWVzXSgpIHsKICAgIHJldHVybiBfVHVwbGU7CiAgfQogIGNvbmNhdCguLi5hcnIpIHsKICAgIHJldHVybiBzdXBlci5jb25jYXQuYXBwbHkodGhpcywgYXJyKTsKICB9CiAgcHJlcGVuZCguLi5hcnIpIHsKICAgIGlmIChhcnIubGVuZ3RoID09PSAxICYmIEFycmF5LmlzQXJyYXkoYXJyWzBdKSkgewogICAgICByZXR1cm4gbmV3IF9UdXBsZSguLi5hcnJbMF0uY29uY2F0KHRoaXMpKTsKICAgIH0KICAgIHJldHVybiBuZXcgX1R1cGxlKC4uLmFyci5jb25jYXQodGhpcykpOwogIH0KfTsKZnVuY3Rpb24gZnJlZXplRHJhZnRhYmxlKHZhbCkgewogIHJldHVybiBpc0RyYWZ0YWJsZSh2YWwpID8gcHJvZHVjZSh2YWwsICgpID0+IHsKICB9KSA6IHZhbDsKfQpmdW5jdGlvbiBnZXRPckluc2VydENvbXB1dGVkKG1hcDMsIGtleSwgY29tcHV0ZSkgewogIGlmIChtYXAzLmhhcyhrZXkpKSByZXR1cm4gbWFwMy5nZXQoa2V5KTsKICByZXR1cm4gbWFwMy5zZXQoa2V5LCBjb21wdXRlKGtleSkpLmdldChrZXkpOwp9CmZ1bmN0aW9uIGlzSW1tdXRhYmxlRGVmYXVsdCh2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiIHx8IHZhbHVlID09IG51bGwgfHwgT2JqZWN0LmlzRnJvemVuKHZhbHVlKTsKfQpmdW5jdGlvbiB0cmFja0Zvck11dGF0aW9ucyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCBvYmopIHsKICBjb25zdCB0cmFja2VkUHJvcGVydGllcyA9IHRyYWNrUHJvcGVydGllcyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCBvYmopOwogIHJldHVybiB7CiAgICBkZXRlY3RNdXRhdGlvbnMoKSB7CiAgICAgIHJldHVybiBkZXRlY3RNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgdHJhY2tlZFByb3BlcnRpZXMsIG9iaik7CiAgICB9CiAgfTsKfQpmdW5jdGlvbiB0cmFja1Byb3BlcnRpZXMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocyA9IFtdLCBvYmosIHBhdGgyID0gIiIsIGNoZWNrZWRPYmplY3RzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSkgewogIGNvbnN0IHRyYWNrZWQgPSB7CiAgICB2YWx1ZTogb2JqCiAgfTsKICBpZiAoIWlzSW1tdXRhYmxlKG9iaikgJiYgIWNoZWNrZWRPYmplY3RzLmhhcyhvYmopKSB7CiAgICBjaGVja2VkT2JqZWN0cy5hZGQob2JqKTsKICAgIHRyYWNrZWQuY2hpbGRyZW4gPSB7fTsKICAgIGNvbnN0IGhhc0lnbm9yZWRQYXRocyA9IGlnbm9yZWRQYXRocy5sZW5ndGggPiAwOwogICAgZm9yIChjb25zdCBrZXkgaW4gb2JqKSB7CiAgICAgIGNvbnN0IG5lc3RlZFBhdGggPSBwYXRoMiA/IHBhdGgyICsgIi4iICsga2V5IDoga2V5OwogICAgICBpZiAoaGFzSWdub3JlZFBhdGhzKSB7CiAgICAgICAgY29uc3QgaGFzTWF0Y2hlcyA9IGlnbm9yZWRQYXRocy5zb21lKChpZ25vcmVkKSA9PiB7CiAgICAgICAgICBpZiAoaWdub3JlZCBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgICByZXR1cm4gaWdub3JlZC50ZXN0KG5lc3RlZFBhdGgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5lc3RlZFBhdGggPT09IGlnbm9yZWQ7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKGhhc01hdGNoZXMpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgfQogICAgICB0cmFja2VkLmNoaWxkcmVuW2tleV0gPSB0cmFja1Byb3BlcnRpZXMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgb2JqW2tleV0sIG5lc3RlZFBhdGgpOwogICAgfQogIH0KICByZXR1cm4gdHJhY2tlZDsKfQpmdW5jdGlvbiBkZXRlY3RNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocyA9IFtdLCB0cmFja2VkUHJvcGVydHksIG9iaiwgc2FtZVBhcmVudFJlZiA9IGZhbHNlLCBwYXRoMiA9ICIiKSB7CiAgY29uc3QgcHJldk9iaiA9IHRyYWNrZWRQcm9wZXJ0eSA/IHRyYWNrZWRQcm9wZXJ0eS52YWx1ZSA6IHZvaWQgMDsKICBjb25zdCBzYW1lUmVmID0gcHJldk9iaiA9PT0gb2JqOwogIGlmIChzYW1lUGFyZW50UmVmICYmICFzYW1lUmVmICYmICFOdW1iZXIuaXNOYU4ob2JqKSkgewogICAgcmV0dXJuIHsKICAgICAgd2FzTXV0YXRlZDogdHJ1ZSwKICAgICAgcGF0aDogcGF0aDIKICAgIH07CiAgfQogIGlmIChpc0ltbXV0YWJsZShwcmV2T2JqKSB8fCBpc0ltbXV0YWJsZShvYmopKSB7CiAgICByZXR1cm4gewogICAgICB3YXNNdXRhdGVkOiBmYWxzZQogICAgfTsKICB9CiAgY29uc3Qga2V5c1RvRGV0ZWN0ID0ge307CiAgZm9yIChsZXQga2V5IGluIHRyYWNrZWRQcm9wZXJ0eS5jaGlsZHJlbikgewogICAga2V5c1RvRGV0ZWN0W2tleV0gPSB0cnVlOwogIH0KICBmb3IgKGxldCBrZXkgaW4gb2JqKSB7CiAgICBrZXlzVG9EZXRlY3Rba2V5XSA9IHRydWU7CiAgfQogIGNvbnN0IGhhc0lnbm9yZWRQYXRocyA9IGlnbm9yZWRQYXRocy5sZW5ndGggPiAwOwogIGZvciAobGV0IGtleSBpbiBrZXlzVG9EZXRlY3QpIHsKICAgIGNvbnN0IG5lc3RlZFBhdGggPSBwYXRoMiA/IHBhdGgyICsgIi4iICsga2V5IDoga2V5OwogICAgaWYgKGhhc0lnbm9yZWRQYXRocykgewogICAgICBjb25zdCBoYXNNYXRjaGVzID0gaWdub3JlZFBhdGhzLnNvbWUoKGlnbm9yZWQpID0+IHsKICAgICAgICBpZiAoaWdub3JlZCBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgcmV0dXJuIGlnbm9yZWQudGVzdChuZXN0ZWRQYXRoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5lc3RlZFBhdGggPT09IGlnbm9yZWQ7CiAgICAgIH0pOwogICAgICBpZiAoaGFzTWF0Y2hlcykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSBkZXRlY3RNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgdHJhY2tlZFByb3BlcnR5LmNoaWxkcmVuW2tleV0sIG9ialtrZXldLCBzYW1lUmVmLCBuZXN0ZWRQYXRoKTsKICAgIGlmIChyZXN1bHQud2FzTXV0YXRlZCkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0KICByZXR1cm4gewogICAgd2FzTXV0YXRlZDogZmFsc2UKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZUltbXV0YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZShvcHRpb25zID0ge30pIHsKICBpZiAoZmFsc2UpIHsKICAgIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gbmV4dChhY3Rpb24pOwogIH0gZWxzZSB7CiAgICBsZXQgc3RyaW5naWZ5MiA9IGZ1bmN0aW9uKG9iaiwgc2VyaWFsaXplciwgaW5kZW50LCBkZWN5Y2xlcikgewogICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqLCBnZXRTZXJpYWxpemUyKHNlcmlhbGl6ZXIsIGRlY3ljbGVyKSwgaW5kZW50KTsKICAgIH0sIGdldFNlcmlhbGl6ZTIgPSBmdW5jdGlvbihzZXJpYWxpemVyLCBkZWN5Y2xlcikgewogICAgICBsZXQgc3RhY2sgPSBbXSwga2V5cyA9IFtdOwogICAgICBpZiAoIWRlY3ljbGVyKSBkZWN5Y2xlciA9IGZ1bmN0aW9uKF8sIHZhbHVlKSB7CiAgICAgICAgaWYgKHN0YWNrWzBdID09PSB2YWx1ZSkgcmV0dXJuICJbQ2lyY3VsYXIgfl0iOwogICAgICAgIHJldHVybiAiW0NpcmN1bGFyIH4uIiArIGtleXMuc2xpY2UoMCwgc3RhY2suaW5kZXhPZih2YWx1ZSkpLmpvaW4oIi4iKSArICJdIjsKICAgICAgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoc3RhY2subGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIHRoaXNQb3MgPSBzdGFjay5pbmRleE9mKHRoaXMpOwogICAgICAgICAgfnRoaXNQb3MgPyBzdGFjay5zcGxpY2UodGhpc1BvcyArIDEpIDogc3RhY2sucHVzaCh0aGlzKTsKICAgICAgICAgIH50aGlzUG9zID8ga2V5cy5zcGxpY2UodGhpc1BvcywgSW5maW5pdHksIGtleSkgOiBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgIGlmICh+c3RhY2suaW5kZXhPZih2YWx1ZSkpIHZhbHVlID0gZGVjeWNsZXIuY2FsbCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgICB9IGVsc2Ugc3RhY2sucHVzaCh2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZXIgPT0gbnVsbCA/IHZhbHVlIDogc2VyaWFsaXplci5jYWxsKHRoaXMsIGtleSwgdmFsdWUpOwogICAgICB9OwogICAgfTsKICAgIHZhciBzdHJpbmdpZnkgPSBzdHJpbmdpZnkyLCBnZXRTZXJpYWxpemUgPSBnZXRTZXJpYWxpemUyOwogICAgbGV0IHsKICAgICAgaXNJbW11dGFibGUgPSBpc0ltbXV0YWJsZURlZmF1bHQsCiAgICAgIGlnbm9yZWRQYXRocywKICAgICAgd2FybkFmdGVyID0gMzIKICAgIH0gPSBvcHRpb25zOwogICAgY29uc3QgdHJhY2sgPSB0cmFja0Zvck11dGF0aW9ucy5iaW5kKG51bGwsIGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMpOwogICAgcmV0dXJuICh7CiAgICAgIGdldFN0YXRlCiAgICB9KSA9PiB7CiAgICAgIGxldCBzdGF0ZSA9IGdldFN0YXRlKCk7CiAgICAgIGxldCB0cmFja2VyID0gdHJhY2soc3RhdGUpOwogICAgICBsZXQgcmVzdWx0OwogICAgICByZXR1cm4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgICAgICBjb25zdCBtZWFzdXJlVXRpbHMgPSBnZXRUaW1lTWVhc3VyZVV0aWxzKHdhcm5BZnRlciwgIkltbXV0YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZSIpOwogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBzdGF0ZSA9IGdldFN0YXRlKCk7CiAgICAgICAgICByZXN1bHQgPSB0cmFja2VyLmRldGVjdE11dGF0aW9ucygpOwogICAgICAgICAgdHJhY2tlciA9IHRyYWNrKHN0YXRlKTsKICAgICAgICAgIGlmIChyZXN1bHQud2FzTXV0YXRlZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE5KSA6IGBBIHN0YXRlIG11dGF0aW9uIHdhcyBkZXRlY3RlZCBiZXR3ZWVuIGRpc3BhdGNoZXMsIGluIHRoZSBwYXRoICcke3Jlc3VsdC5wYXRoIHx8ICIifScuICBUaGlzIG1heSBjYXVzZSBpbmNvcnJlY3QgYmVoYXZpb3IuIChodHRwczovL3JlZHV4LmpzLm9yZy9zdHlsZS1ndWlkZS9zdHlsZS1ndWlkZSNkby1ub3QtbXV0YXRlLXN0YXRlKWApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGRpc3BhdGNoZWRBY3Rpb24gPSBuZXh0KGFjdGlvbik7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIHN0YXRlID0gZ2V0U3RhdGUoKTsKICAgICAgICAgIHJlc3VsdCA9IHRyYWNrZXIuZGV0ZWN0TXV0YXRpb25zKCk7CiAgICAgICAgICB0cmFja2VyID0gdHJhY2soc3RhdGUpOwogICAgICAgICAgaWYgKHJlc3VsdC53YXNNdXRhdGVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjApIDogYEEgc3RhdGUgbXV0YXRpb24gd2FzIGRldGVjdGVkIGluc2lkZSBhIGRpc3BhdGNoLCBpbiB0aGUgcGF0aDogJHtyZXN1bHQucGF0aCB8fCAiIn0uIFRha2UgYSBsb29rIGF0IHRoZSByZWR1Y2VyKHMpIGhhbmRsaW5nIHRoZSBhY3Rpb24gJHtzdHJpbmdpZnkyKGFjdGlvbil9LiAoaHR0cHM6Ly9yZWR1eC5qcy5vcmcvc3R5bGUtZ3VpZGUvc3R5bGUtZ3VpZGUjZG8tbm90LW11dGF0ZS1zdGF0ZSlgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBtZWFzdXJlVXRpbHMud2FybklmRXhjZWVkZWQoKTsKICAgICAgICByZXR1cm4gZGlzcGF0Y2hlZEFjdGlvbjsKICAgICAgfTsKICAgIH07CiAgfQp9CmZ1bmN0aW9uIGlzUGxhaW4odmFsKSB7CiAgY29uc3QgdHlwZSA9IHR5cGVvZiB2YWw7CiAgcmV0dXJuIHZhbCA9PSBudWxsIHx8IHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGUgPT09ICJib29sZWFuIiB8fCB0eXBlID09PSAibnVtYmVyIiB8fCBBcnJheS5pc0FycmF5KHZhbCkgfHwgaXNQbGFpbk9iamVjdCh2YWwpOwp9CmZ1bmN0aW9uIGZpbmROb25TZXJpYWxpemFibGVWYWx1ZSh2YWx1ZSwgcGF0aDIgPSAiIiwgaXNTZXJpYWxpemFibGUgPSBpc1BsYWluLCBnZXRFbnRyaWVzLCBpZ25vcmVkUGF0aHMgPSBbXSwgY2FjaGUpIHsKICBsZXQgZm91bmROZXN0ZWRTZXJpYWxpemFibGU7CiAgaWYgKCFpc1NlcmlhbGl6YWJsZSh2YWx1ZSkpIHsKICAgIHJldHVybiB7CiAgICAgIGtleVBhdGg6IHBhdGgyIHx8ICI8cm9vdD4iLAogICAgICB2YWx1ZQogICAgfTsKICB9CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgfHwgdmFsdWUgPT09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKGNhY2hlPy5oYXModmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgZW50cmllcyA9IGdldEVudHJpZXMgIT0gbnVsbCA/IGdldEVudHJpZXModmFsdWUpIDogT2JqZWN0LmVudHJpZXModmFsdWUpOwogIGNvbnN0IGhhc0lnbm9yZWRQYXRocyA9IGlnbm9yZWRQYXRocy5sZW5ndGggPiAwOwogIGZvciAoY29uc3QgW2tleSwgbmVzdGVkVmFsdWVdIG9mIGVudHJpZXMpIHsKICAgIGNvbnN0IG5lc3RlZFBhdGggPSBwYXRoMiA/IHBhdGgyICsgIi4iICsga2V5IDoga2V5OwogICAgaWYgKGhhc0lnbm9yZWRQYXRocykgewogICAgICBjb25zdCBoYXNNYXRjaGVzID0gaWdub3JlZFBhdGhzLnNvbWUoKGlnbm9yZWQpID0+IHsKICAgICAgICBpZiAoaWdub3JlZCBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgcmV0dXJuIGlnbm9yZWQudGVzdChuZXN0ZWRQYXRoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5lc3RlZFBhdGggPT09IGlnbm9yZWQ7CiAgICAgIH0pOwogICAgICBpZiAoaGFzTWF0Y2hlcykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICB9CiAgICBpZiAoIWlzU2VyaWFsaXphYmxlKG5lc3RlZFZhbHVlKSkgewogICAgICByZXR1cm4gewogICAgICAgIGtleVBhdGg6IG5lc3RlZFBhdGgsCiAgICAgICAgdmFsdWU6IG5lc3RlZFZhbHVlCiAgICAgIH07CiAgICB9CiAgICBpZiAodHlwZW9mIG5lc3RlZFZhbHVlID09PSAib2JqZWN0IikgewogICAgICBmb3VuZE5lc3RlZFNlcmlhbGl6YWJsZSA9IGZpbmROb25TZXJpYWxpemFibGVWYWx1ZShuZXN0ZWRWYWx1ZSwgbmVzdGVkUGF0aCwgaXNTZXJpYWxpemFibGUsIGdldEVudHJpZXMsIGlnbm9yZWRQYXRocywgY2FjaGUpOwogICAgICBpZiAoZm91bmROZXN0ZWRTZXJpYWxpemFibGUpIHsKICAgICAgICByZXR1cm4gZm91bmROZXN0ZWRTZXJpYWxpemFibGU7CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKGNhY2hlICYmIGlzTmVzdGVkRnJvemVuKHZhbHVlKSkgY2FjaGUuYWRkKHZhbHVlKTsKICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gaXNOZXN0ZWRGcm96ZW4odmFsdWUpIHsKICBpZiAoIU9iamVjdC5pc0Zyb3plbih2YWx1ZSkpIHJldHVybiBmYWxzZTsKICBmb3IgKGNvbnN0IG5lc3RlZFZhbHVlIG9mIE9iamVjdC52YWx1ZXModmFsdWUpKSB7CiAgICBpZiAodHlwZW9mIG5lc3RlZFZhbHVlICE9PSAib2JqZWN0IiB8fCBuZXN0ZWRWYWx1ZSA9PT0gbnVsbCkgY29udGludWU7CiAgICBpZiAoIWlzTmVzdGVkRnJvemVuKG5lc3RlZFZhbHVlKSkgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBjcmVhdGVTZXJpYWxpemFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUob3B0aW9ucyA9IHt9KSB7CiAgaWYgKGZhbHNlKSB7CiAgICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IG5leHQoYWN0aW9uKTsKICB9IGVsc2UgewogICAgY29uc3QgewogICAgICBpc1NlcmlhbGl6YWJsZSA9IGlzUGxhaW4sCiAgICAgIGdldEVudHJpZXMsCiAgICAgIGlnbm9yZWRBY3Rpb25zID0gW10sCiAgICAgIGlnbm9yZWRBY3Rpb25QYXRocyA9IFsibWV0YS5hcmciLCAibWV0YS5iYXNlUXVlcnlNZXRhIl0sCiAgICAgIGlnbm9yZWRQYXRocyA9IFtdLAogICAgICB3YXJuQWZ0ZXIgPSAzMiwKICAgICAgaWdub3JlU3RhdGUgPSBmYWxzZSwKICAgICAgaWdub3JlQWN0aW9ucyA9IGZhbHNlLAogICAgICBkaXNhYmxlQ2FjaGUgPSBmYWxzZQogICAgfSA9IG9wdGlvbnM7CiAgICBjb25zdCBjYWNoZSA9ICFkaXNhYmxlQ2FjaGUgJiYgV2Vha1NldCA/IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpIDogdm9pZCAwOwogICAgcmV0dXJuIChzdG9yZUFQSSkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgICAgaWYgKCFpc0FjdGlvbihhY3Rpb24pKSB7CiAgICAgICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICAgICAgfQogICAgICBjb25zdCByZXN1bHQgPSBuZXh0KGFjdGlvbik7CiAgICAgIGNvbnN0IG1lYXN1cmVVdGlscyA9IGdldFRpbWVNZWFzdXJlVXRpbHMod2FybkFmdGVyLCAiU2VyaWFsaXphYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlIik7CiAgICAgIGlmICghaWdub3JlQWN0aW9ucyAmJiAhKGlnbm9yZWRBY3Rpb25zLmxlbmd0aCAmJiBpZ25vcmVkQWN0aW9ucy5pbmRleE9mKGFjdGlvbi50eXBlKSAhPT0gLTEpKSB7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIGNvbnN0IGZvdW5kQWN0aW9uTm9uU2VyaWFsaXphYmxlVmFsdWUgPSBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUoYWN0aW9uLCAiIiwgaXNTZXJpYWxpemFibGUsIGdldEVudHJpZXMsIGlnbm9yZWRBY3Rpb25QYXRocywgY2FjaGUpOwogICAgICAgICAgaWYgKGZvdW5kQWN0aW9uTm9uU2VyaWFsaXphYmxlVmFsdWUpIHsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGtleVBhdGgsCiAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgfSA9IGZvdW5kQWN0aW9uTm9uU2VyaWFsaXphYmxlVmFsdWU7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEEgbm9uLXNlcmlhbGl6YWJsZSB2YWx1ZSB3YXMgZGV0ZWN0ZWQgaW4gYW4gYWN0aW9uLCBpbiB0aGUgcGF0aDogXGAke2tleVBhdGh9XGAuIFZhbHVlOmAsIHZhbHVlLCAiXG5UYWtlIGEgbG9vayBhdCB0aGUgbG9naWMgdGhhdCBkaXNwYXRjaGVkIHRoaXMgYWN0aW9uOiAiLCBhY3Rpb24sICJcbihTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvZmFxL2FjdGlvbnMjd2h5LXNob3VsZC10eXBlLWJlLWEtc3RyaW5nLW9yLWF0LWxlYXN0LXNlcmlhbGl6YWJsZS13aHktc2hvdWxkLW15LWFjdGlvbi10eXBlcy1iZS1jb25zdGFudHMpIiwgIlxuKFRvIGFsbG93IG5vbi1zZXJpYWxpemFibGUgdmFsdWVzIHNlZTogaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy91c2FnZS91c2FnZS1ndWlkZSN3b3JraW5nLXdpdGgtbm9uLXNlcmlhbGl6YWJsZS1kYXRhKSIpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghaWdub3JlU3RhdGUpIHsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgY29uc3Qgc3RhdGUgPSBzdG9yZUFQSS5nZXRTdGF0ZSgpOwogICAgICAgICAgY29uc3QgZm91bmRTdGF0ZU5vblNlcmlhbGl6YWJsZVZhbHVlID0gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKHN0YXRlLCAiIiwgaXNTZXJpYWxpemFibGUsIGdldEVudHJpZXMsIGlnbm9yZWRQYXRocywgY2FjaGUpOwogICAgICAgICAgaWYgKGZvdW5kU3RhdGVOb25TZXJpYWxpemFibGVWYWx1ZSkgewogICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAga2V5UGF0aCwKICAgICAgICAgICAgICB2YWx1ZQogICAgICAgICAgICB9ID0gZm91bmRTdGF0ZU5vblNlcmlhbGl6YWJsZVZhbHVlOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBBIG5vbi1zZXJpYWxpemFibGUgdmFsdWUgd2FzIGRldGVjdGVkIGluIHRoZSBzdGF0ZSwgaW4gdGhlIHBhdGg6IFxgJHtrZXlQYXRofVxgLiBWYWx1ZTpgLCB2YWx1ZSwgYApUYWtlIGEgbG9vayBhdCB0aGUgcmVkdWNlcihzKSBoYW5kbGluZyB0aGlzIGFjdGlvbiB0eXBlOiAke2FjdGlvbi50eXBlfS4KKFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy9mYXEvb3JnYW5pemluZy1zdGF0ZSNjYW4taS1wdXQtZnVuY3Rpb25zLXByb21pc2VzLW9yLW90aGVyLW5vbi1zZXJpYWxpemFibGUtaXRlbXMtaW4tbXktc3RvcmUtc3RhdGUpYCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgbWVhc3VyZVV0aWxzLndhcm5JZkV4Y2VlZGVkKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQp9CmZ1bmN0aW9uIGlzQm9vbGVhbjIoeDIpIHsKICByZXR1cm4gdHlwZW9mIHgyID09PSAiYm9vbGVhbiI7Cn0KdmFyIGJ1aWxkR2V0RGVmYXVsdE1pZGRsZXdhcmUgPSAoKSA9PiBmdW5jdGlvbiBnZXREZWZhdWx0TWlkZGxld2FyZShvcHRpb25zKSB7CiAgY29uc3QgewogICAgdGh1bms6IHRodW5rMiA9IHRydWUsCiAgICBpbW11dGFibGVDaGVjayA9IHRydWUsCiAgICBzZXJpYWxpemFibGVDaGVjayA9IHRydWUsCiAgICBhY3Rpb25DcmVhdG9yQ2hlY2sgPSB0cnVlCiAgfSA9IG9wdGlvbnMgPz8ge307CiAgbGV0IG1pZGRsZXdhcmVBcnJheSA9IG5ldyBUdXBsZSgpOwogIGlmICh0aHVuazIpIHsKICAgIGlmIChpc0Jvb2xlYW4yKHRodW5rMikpIHsKICAgICAgbWlkZGxld2FyZUFycmF5LnB1c2godGh1bmspOwogICAgfSBlbHNlIHsKICAgICAgbWlkZGxld2FyZUFycmF5LnB1c2god2l0aEV4dHJhQXJndW1lbnQodGh1bmsyLmV4dHJhQXJndW1lbnQpKTsKICAgIH0KICB9CiAgaWYgKHRydWUpIHsKICAgIGlmIChpbW11dGFibGVDaGVjaykgewogICAgICBsZXQgaW1tdXRhYmxlT3B0aW9ucyA9IHt9OwogICAgICBpZiAoIWlzQm9vbGVhbjIoaW1tdXRhYmxlQ2hlY2spKSB7CiAgICAgICAgaW1tdXRhYmxlT3B0aW9ucyA9IGltbXV0YWJsZUNoZWNrOwogICAgICB9CiAgICAgIG1pZGRsZXdhcmVBcnJheS51bnNoaWZ0KGNyZWF0ZUltbXV0YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZShpbW11dGFibGVPcHRpb25zKSk7CiAgICB9CiAgICBpZiAoc2VyaWFsaXphYmxlQ2hlY2spIHsKICAgICAgbGV0IHNlcmlhbGl6YWJsZU9wdGlvbnMgPSB7fTsKICAgICAgaWYgKCFpc0Jvb2xlYW4yKHNlcmlhbGl6YWJsZUNoZWNrKSkgewogICAgICAgIHNlcmlhbGl6YWJsZU9wdGlvbnMgPSBzZXJpYWxpemFibGVDaGVjazsKICAgICAgfQogICAgICBtaWRkbGV3YXJlQXJyYXkucHVzaChjcmVhdGVTZXJpYWxpemFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUoc2VyaWFsaXphYmxlT3B0aW9ucykpOwogICAgfQogICAgaWYgKGFjdGlvbkNyZWF0b3JDaGVjaykgewogICAgICBsZXQgYWN0aW9uQ3JlYXRvck9wdGlvbnMgPSB7fTsKICAgICAgaWYgKCFpc0Jvb2xlYW4yKGFjdGlvbkNyZWF0b3JDaGVjaykpIHsKICAgICAgICBhY3Rpb25DcmVhdG9yT3B0aW9ucyA9IGFjdGlvbkNyZWF0b3JDaGVjazsKICAgICAgfQogICAgICBtaWRkbGV3YXJlQXJyYXkudW5zaGlmdChjcmVhdGVBY3Rpb25DcmVhdG9ySW52YXJpYW50TWlkZGxld2FyZShhY3Rpb25DcmVhdG9yT3B0aW9ucykpOwogICAgfQogIH0KICByZXR1cm4gbWlkZGxld2FyZUFycmF5Owp9Owp2YXIgU0hPVUxEX0FVVE9CQVRDSCA9ICJSVEtfYXV0b0JhdGNoIjsKdmFyIHByZXBhcmVBdXRvQmF0Y2hlZCA9ICgpID0+IChwYXlsb2FkKSA9PiAoewogIHBheWxvYWQsCiAgbWV0YTogewogICAgW1NIT1VMRF9BVVRPQkFUQ0hdOiB0cnVlCiAgfQp9KTsKdmFyIGNyZWF0ZVF1ZXVlV2l0aFRpbWVyID0gKHRpbWVvdXQpID0+IHsKICByZXR1cm4gKG5vdGlmeSkgPT4gewogICAgc2V0VGltZW91dChub3RpZnksIHRpbWVvdXQpOwogIH07Cn07CnZhciBhdXRvQmF0Y2hFbmhhbmNlciA9IChvcHRpb25zID0gewogIHR5cGU6ICJyYWYiCn0pID0+IChuZXh0KSA9PiAoLi4uYXJncykgPT4gewogIGNvbnN0IHN0b3JlID0gbmV4dCguLi5hcmdzKTsKICBsZXQgbm90aWZ5aW5nID0gdHJ1ZTsKICBsZXQgc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2sgPSBmYWxzZTsKICBsZXQgbm90aWZpY2F0aW9uUXVldWVkID0gZmFsc2U7CiAgY29uc3QgbGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICBjb25zdCBxdWV1ZUNhbGxiYWNrID0gb3B0aW9ucy50eXBlID09PSAidGljayIgPyBxdWV1ZU1pY3JvdGFzayA6IG9wdGlvbnMudHlwZSA9PT0gInJhZiIgPyAoCiAgICAvLyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgd29uJ3QgZXhpc3QgaW4gU1NSIGVudmlyb25tZW50cy4gRmFsbCBiYWNrIHRvIGEgdmFndWUgYXBwcm94aW1hdGlvbiBqdXN0IHRvIGtlZXAgZnJvbSBlcnJvcmluZy4KICAgIHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPyB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIDogY3JlYXRlUXVldWVXaXRoVGltZXIoMTApCiAgKSA6IG9wdGlvbnMudHlwZSA9PT0gImNhbGxiYWNrIiA/IG9wdGlvbnMucXVldWVOb3RpZmljYXRpb24gOiBjcmVhdGVRdWV1ZVdpdGhUaW1lcihvcHRpb25zLnRpbWVvdXQpOwogIGNvbnN0IG5vdGlmeUxpc3RlbmVycyA9ICgpID0+IHsKICAgIG5vdGlmaWNhdGlvblF1ZXVlZCA9IGZhbHNlOwogICAgaWYgKHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrKSB7CiAgICAgIHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrID0gZmFsc2U7CiAgICAgIGxpc3RlbmVycy5mb3JFYWNoKChsKSA9PiBsKCkpOwogICAgfQogIH07CiAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHN0b3JlLCB7CiAgICAvLyBPdmVycmlkZSB0aGUgYmFzZSBgc3RvcmUuc3Vic2NyaWJlYCBtZXRob2QgdG8ga2VlcCBvcmlnaW5hbCBsaXN0ZW5lcnMKICAgIC8vIGZyb20gcnVubmluZyBpZiB3ZSdyZSBkZWxheWluZyBub3RpZmljYXRpb25zCiAgICBzdWJzY3JpYmUobGlzdGVuZXIyKSB7CiAgICAgIGNvbnN0IHdyYXBwZWRMaXN0ZW5lciA9ICgpID0+IG5vdGlmeWluZyAmJiBsaXN0ZW5lcjIoKTsKICAgICAgY29uc3QgdW5zdWJzY3JpYmUgPSBzdG9yZS5zdWJzY3JpYmUod3JhcHBlZExpc3RlbmVyKTsKICAgICAgbGlzdGVuZXJzLmFkZChsaXN0ZW5lcjIpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICAgICAgbGlzdGVuZXJzLmRlbGV0ZShsaXN0ZW5lcjIpOwogICAgICB9OwogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoZSBiYXNlIGBzdG9yZS5kaXNwYXRjaGAgbWV0aG9kIHNvIHRoYXQgd2UgY2FuIGNoZWNrIGFjdGlvbnMKICAgIC8vIGZvciB0aGUgYHNob3VsZEF1dG9CYXRjaGAgZmxhZyBhbmQgZGV0ZXJtaW5lIGlmIGJhdGNoaW5nIGlzIGFjdGl2ZQogICAgZGlzcGF0Y2goYWN0aW9uKSB7CiAgICAgIHRyeSB7CiAgICAgICAgbm90aWZ5aW5nID0gIWFjdGlvbj8ubWV0YT8uW1NIT1VMRF9BVVRPQkFUQ0hdOwogICAgICAgIHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrID0gIW5vdGlmeWluZzsKICAgICAgICBpZiAoc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2spIHsKICAgICAgICAgIGlmICghbm90aWZpY2F0aW9uUXVldWVkKSB7CiAgICAgICAgICAgIG5vdGlmaWNhdGlvblF1ZXVlZCA9IHRydWU7CiAgICAgICAgICAgIHF1ZXVlQ2FsbGJhY2sobm90aWZ5TGlzdGVuZXJzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0b3JlLmRpc3BhdGNoKGFjdGlvbik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgbm90aWZ5aW5nID0gdHJ1ZTsKICAgICAgfQogICAgfQogIH0pOwp9Owp2YXIgYnVpbGRHZXREZWZhdWx0RW5oYW5jZXJzID0gKG1pZGRsZXdhcmVFbmhhbmNlcikgPT4gZnVuY3Rpb24gZ2V0RGVmYXVsdEVuaGFuY2VycyhvcHRpb25zKSB7CiAgY29uc3QgewogICAgYXV0b0JhdGNoID0gdHJ1ZQogIH0gPSBvcHRpb25zID8/IHt9OwogIGxldCBlbmhhbmNlckFycmF5ID0gbmV3IFR1cGxlKG1pZGRsZXdhcmVFbmhhbmNlcik7CiAgaWYgKGF1dG9CYXRjaCkgewogICAgZW5oYW5jZXJBcnJheS5wdXNoKGF1dG9CYXRjaEVuaGFuY2VyKHR5cGVvZiBhdXRvQmF0Y2ggPT09ICJvYmplY3QiID8gYXV0b0JhdGNoIDogdm9pZCAwKSk7CiAgfQogIHJldHVybiBlbmhhbmNlckFycmF5Owp9OwpmdW5jdGlvbiBjb25maWd1cmVTdG9yZShvcHRpb25zKSB7CiAgY29uc3QgZ2V0RGVmYXVsdE1pZGRsZXdhcmUgPSBidWlsZEdldERlZmF1bHRNaWRkbGV3YXJlKCk7CiAgY29uc3QgewogICAgcmVkdWNlciA9IHZvaWQgMCwKICAgIG1pZGRsZXdhcmUsCiAgICBkZXZUb29scyA9IHRydWUsCiAgICBkdXBsaWNhdGVNaWRkbGV3YXJlQ2hlY2sgPSB0cnVlLAogICAgcHJlbG9hZGVkU3RhdGUgPSB2b2lkIDAsCiAgICBlbmhhbmNlcnMgPSB2b2lkIDAKICB9ID0gb3B0aW9ucyB8fCB7fTsKICBsZXQgcm9vdFJlZHVjZXIyOwogIGlmICh0eXBlb2YgcmVkdWNlciA9PT0gImZ1bmN0aW9uIikgewogICAgcm9vdFJlZHVjZXIyID0gcmVkdWNlcjsKICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QocmVkdWNlcikpIHsKICAgIHJvb3RSZWR1Y2VyMiA9IGNvbWJpbmVSZWR1Y2VycyhyZWR1Y2VyKTsKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxKSA6ICJgcmVkdWNlcmAgaXMgYSByZXF1aXJlZCBhcmd1bWVudCwgYW5kIG11c3QgYmUgYSBmdW5jdGlvbiBvciBhbiBvYmplY3Qgb2YgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIHBhc3NlZCB0byBjb21iaW5lUmVkdWNlcnMiKTsKICB9CiAgaWYgKG1pZGRsZXdhcmUgJiYgdHlwZW9mIG1pZGRsZXdhcmUgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMikgOiAiYG1pZGRsZXdhcmVgIGZpZWxkIG11c3QgYmUgYSBjYWxsYmFjayIpOwogIH0KICBsZXQgZmluYWxNaWRkbGV3YXJlOwogIGlmICh0eXBlb2YgbWlkZGxld2FyZSA9PT0gImZ1bmN0aW9uIikgewogICAgZmluYWxNaWRkbGV3YXJlID0gbWlkZGxld2FyZShnZXREZWZhdWx0TWlkZGxld2FyZSk7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZmluYWxNaWRkbGV3YXJlKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMpIDogIndoZW4gdXNpbmcgYSBtaWRkbGV3YXJlIGJ1aWxkZXIgZnVuY3Rpb24sIGFuIGFycmF5IG9mIG1pZGRsZXdhcmUgbXVzdCBiZSByZXR1cm5lZCIpOwogICAgfQogIH0gZWxzZSB7CiAgICBmaW5hbE1pZGRsZXdhcmUgPSBnZXREZWZhdWx0TWlkZGxld2FyZSgpOwogIH0KICBpZiAoZmluYWxNaWRkbGV3YXJlLnNvbWUoKGl0ZW0pID0+IHR5cGVvZiBpdGVtICE9PSAiZnVuY3Rpb24iKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0KSA6ICJlYWNoIG1pZGRsZXdhcmUgcHJvdmlkZWQgdG8gY29uZmlndXJlU3RvcmUgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgfQogIGlmIChkdXBsaWNhdGVNaWRkbGV3YXJlQ2hlY2spIHsKICAgIGxldCBtaWRkbGV3YXJlUmVmZXJlbmNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBmaW5hbE1pZGRsZXdhcmUuZm9yRWFjaCgobWlkZGxld2FyZTIpID0+IHsKICAgICAgaWYgKG1pZGRsZXdhcmVSZWZlcmVuY2VzLmhhcyhtaWRkbGV3YXJlMikpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQyKSA6ICJEdXBsaWNhdGUgbWlkZGxld2FyZSByZWZlcmVuY2VzIGZvdW5kIHdoZW4gY3JlYXRpbmcgdGhlIHN0b3JlLiBFbnN1cmUgdGhhdCBlYWNoIG1pZGRsZXdhcmUgaXMgb25seSBpbmNsdWRlZCBvbmNlLiIpOwogICAgICB9CiAgICAgIG1pZGRsZXdhcmVSZWZlcmVuY2VzLmFkZChtaWRkbGV3YXJlMik7CiAgICB9KTsKICB9CiAgbGV0IGZpbmFsQ29tcG9zZSA9IGNvbXBvc2U7CiAgaWYgKGRldlRvb2xzKSB7CiAgICBmaW5hbENvbXBvc2UgPSBjb21wb3NlV2l0aERldlRvb2xzKHsKICAgICAgLy8gRW5hYmxlIGNhcHR1cmUgb2Ygc3RhY2sgdHJhY2VzIGZvciBkaXNwYXRjaGVkIFJlZHV4IGFjdGlvbnMKICAgICAgdHJhY2U6IHRydWUsCiAgICAgIC4uLnR5cGVvZiBkZXZUb29scyA9PT0gIm9iamVjdCIgJiYgZGV2VG9vbHMKICAgIH0pOwogIH0KICBjb25zdCBtaWRkbGV3YXJlRW5oYW5jZXIgPSBhcHBseU1pZGRsZXdhcmUoLi4uZmluYWxNaWRkbGV3YXJlKTsKICBjb25zdCBnZXREZWZhdWx0RW5oYW5jZXJzID0gYnVpbGRHZXREZWZhdWx0RW5oYW5jZXJzKG1pZGRsZXdhcmVFbmhhbmNlcik7CiAgaWYgKGVuaGFuY2VycyAmJiB0eXBlb2YgZW5oYW5jZXJzICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDUpIDogImBlbmhhbmNlcnNgIGZpZWxkIG11c3QgYmUgYSBjYWxsYmFjayIpOwogIH0KICBsZXQgc3RvcmVFbmhhbmNlcnMgPSB0eXBlb2YgZW5oYW5jZXJzID09PSAiZnVuY3Rpb24iID8gZW5oYW5jZXJzKGdldERlZmF1bHRFbmhhbmNlcnMpIDogZ2V0RGVmYXVsdEVuaGFuY2VycygpOwogIGlmICghQXJyYXkuaXNBcnJheShzdG9yZUVuaGFuY2VycykpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNikgOiAiYGVuaGFuY2Vyc2AgY2FsbGJhY2sgbXVzdCByZXR1cm4gYW4gYXJyYXkiKTsKICB9CiAgaWYgKHN0b3JlRW5oYW5jZXJzLnNvbWUoKGl0ZW0pID0+IHR5cGVvZiBpdGVtICE9PSAiZnVuY3Rpb24iKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg3KSA6ICJlYWNoIGVuaGFuY2VyIHByb3ZpZGVkIHRvIGNvbmZpZ3VyZVN0b3JlIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogIH0KICBpZiAoZmluYWxNaWRkbGV3YXJlLmxlbmd0aCAmJiAhc3RvcmVFbmhhbmNlcnMuaW5jbHVkZXMobWlkZGxld2FyZUVuaGFuY2VyKSkgewogICAgY29uc29sZS5lcnJvcigibWlkZGxld2FyZXMgd2VyZSBwcm92aWRlZCwgYnV0IG1pZGRsZXdhcmUgZW5oYW5jZXIgd2FzIG5vdCBpbmNsdWRlZCBpbiBmaW5hbCBlbmhhbmNlcnMgLSBtYWtlIHN1cmUgdG8gY2FsbCBgZ2V0RGVmYXVsdEVuaGFuY2Vyc2AiKTsKICB9CiAgY29uc3QgY29tcG9zZWRFbmhhbmNlciA9IGZpbmFsQ29tcG9zZSguLi5zdG9yZUVuaGFuY2Vycyk7CiAgcmV0dXJuIGNyZWF0ZVN0b3JlKHJvb3RSZWR1Y2VyMiwgcHJlbG9hZGVkU3RhdGUsIGNvbXBvc2VkRW5oYW5jZXIpOwp9CmZ1bmN0aW9uIGV4ZWN1dGVSZWR1Y2VyQnVpbGRlckNhbGxiYWNrKGJ1aWxkZXJDYWxsYmFjaykgewogIGNvbnN0IGFjdGlvbnNNYXAgPSB7fTsKICBjb25zdCBhY3Rpb25NYXRjaGVycyA9IFtdOwogIGxldCBkZWZhdWx0Q2FzZVJlZHVjZXI7CiAgY29uc3QgYnVpbGRlciA9IHsKICAgIGFkZENhc2UodHlwZU9yQWN0aW9uQ3JlYXRvciwgcmVkdWNlcikgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChhY3Rpb25NYXRjaGVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI2KSA6ICJgYnVpbGRlci5hZGRDYXNlYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYGJ1aWxkZXIuYWRkTWF0Y2hlcmAiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyNykgOiAiYGJ1aWxkZXIuYWRkQ2FzZWAgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCB0eXBlID0gdHlwZW9mIHR5cGVPckFjdGlvbkNyZWF0b3IgPT09ICJzdHJpbmciID8gdHlwZU9yQWN0aW9uQ3JlYXRvciA6IHR5cGVPckFjdGlvbkNyZWF0b3IudHlwZTsKICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyOCkgOiAiYGJ1aWxkZXIuYWRkQ2FzZWAgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGFuIGVtcHR5IGFjdGlvbiB0eXBlIik7CiAgICAgIH0KICAgICAgaWYgKHR5cGUgaW4gYWN0aW9uc01hcCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjkpIDogYFxgYnVpbGRlci5hZGRDYXNlXGAgY2Fubm90IGJlIGNhbGxlZCB3aXRoIHR3byByZWR1Y2VycyBmb3IgdGhlIHNhbWUgYWN0aW9uIHR5cGUgJyR7dHlwZX0nYCk7CiAgICAgIH0KICAgICAgYWN0aW9uc01hcFt0eXBlXSA9IHJlZHVjZXI7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfSwKICAgIGFkZEFzeW5jVGh1bmsoYXN5bmNUaHVuaywgcmVkdWNlcnMpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQzKSA6ICJgYnVpbGRlci5hZGRBc3luY1RodW5rYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChyZWR1Y2Vycy5wZW5kaW5nKSBhY3Rpb25zTWFwW2FzeW5jVGh1bmsucGVuZGluZy50eXBlXSA9IHJlZHVjZXJzLnBlbmRpbmc7CiAgICAgIGlmIChyZWR1Y2Vycy5yZWplY3RlZCkgYWN0aW9uc01hcFthc3luY1RodW5rLnJlamVjdGVkLnR5cGVdID0gcmVkdWNlcnMucmVqZWN0ZWQ7CiAgICAgIGlmIChyZWR1Y2Vycy5mdWxmaWxsZWQpIGFjdGlvbnNNYXBbYXN5bmNUaHVuay5mdWxmaWxsZWQudHlwZV0gPSByZWR1Y2Vycy5mdWxmaWxsZWQ7CiAgICAgIGlmIChyZWR1Y2Vycy5zZXR0bGVkKSBhY3Rpb25NYXRjaGVycy5wdXNoKHsKICAgICAgICBtYXRjaGVyOiBhc3luY1RodW5rLnNldHRsZWQsCiAgICAgICAgcmVkdWNlcjogcmVkdWNlcnMuc2V0dGxlZAogICAgICB9KTsKICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICB9LAogICAgYWRkTWF0Y2hlcihtYXRjaGVyLCByZWR1Y2VyKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzMCkgOiAiYGJ1aWxkZXIuYWRkTWF0Y2hlcmAgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBhY3Rpb25NYXRjaGVycy5wdXNoKHsKICAgICAgICBtYXRjaGVyLAogICAgICAgIHJlZHVjZXIKICAgICAgfSk7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfSwKICAgIGFkZERlZmF1bHRDYXNlKHJlZHVjZXIpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMxKSA6ICJgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAgY2FuIG9ubHkgYmUgY2FsbGVkIG9uY2UiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZGVmYXVsdENhc2VSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICB9CiAgfTsKICBidWlsZGVyQ2FsbGJhY2soYnVpbGRlcik7CiAgcmV0dXJuIFthY3Rpb25zTWFwLCBhY3Rpb25NYXRjaGVycywgZGVmYXVsdENhc2VSZWR1Y2VyXTsKfQpmdW5jdGlvbiBpc1N0YXRlRnVuY3Rpb24oeDIpIHsKICByZXR1cm4gdHlwZW9mIHgyID09PSAiZnVuY3Rpb24iOwp9CmZ1bmN0aW9uIGNyZWF0ZVJlZHVjZXIoaW5pdGlhbFN0YXRlMTMsIG1hcE9yQnVpbGRlckNhbGxiYWNrKSB7CiAgaWYgKHRydWUpIHsKICAgIGlmICh0eXBlb2YgbWFwT3JCdWlsZGVyQ2FsbGJhY2sgPT09ICJvYmplY3QiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoOCkgOiAiVGhlIG9iamVjdCBub3RhdGlvbiBmb3IgYGNyZWF0ZVJlZHVjZXJgIGhhcyBiZWVuIHJlbW92ZWQuIFBsZWFzZSB1c2UgdGhlICdidWlsZGVyIGNhbGxiYWNrJyBub3RhdGlvbiBpbnN0ZWFkOiBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL2FwaS9jcmVhdGVSZWR1Y2VyIik7CiAgICB9CiAgfQogIGxldCBbYWN0aW9uc01hcCwgZmluYWxBY3Rpb25NYXRjaGVycywgZmluYWxEZWZhdWx0Q2FzZVJlZHVjZXJdID0gZXhlY3V0ZVJlZHVjZXJCdWlsZGVyQ2FsbGJhY2sobWFwT3JCdWlsZGVyQ2FsbGJhY2spOwogIGxldCBnZXRJbml0aWFsU3RhdGU7CiAgaWYgKGlzU3RhdGVGdW5jdGlvbihpbml0aWFsU3RhdGUxMykpIHsKICAgIGdldEluaXRpYWxTdGF0ZSA9ICgpID0+IGZyZWV6ZURyYWZ0YWJsZShpbml0aWFsU3RhdGUxMygpKTsKICB9IGVsc2UgewogICAgY29uc3QgZnJvemVuSW5pdGlhbFN0YXRlID0gZnJlZXplRHJhZnRhYmxlKGluaXRpYWxTdGF0ZTEzKTsKICAgIGdldEluaXRpYWxTdGF0ZSA9ICgpID0+IGZyb3plbkluaXRpYWxTdGF0ZTsKICB9CiAgZnVuY3Rpb24gcmVkdWNlcihzdGF0ZSA9IGdldEluaXRpYWxTdGF0ZSgpLCBhY3Rpb24pIHsKICAgIGxldCBjYXNlUmVkdWNlcnMgPSBbYWN0aW9uc01hcFthY3Rpb24udHlwZV0sIC4uLmZpbmFsQWN0aW9uTWF0Y2hlcnMuZmlsdGVyKCh7CiAgICAgIG1hdGNoZXIKICAgIH0pID0+IG1hdGNoZXIoYWN0aW9uKSkubWFwKCh7CiAgICAgIHJlZHVjZXI6IHJlZHVjZXIyCiAgICB9KSA9PiByZWR1Y2VyMildOwogICAgaWYgKGNhc2VSZWR1Y2Vycy5maWx0ZXIoKGNyKSA9PiAhIWNyKS5sZW5ndGggPT09IDApIHsKICAgICAgY2FzZVJlZHVjZXJzID0gW2ZpbmFsRGVmYXVsdENhc2VSZWR1Y2VyXTsKICAgIH0KICAgIHJldHVybiBjYXNlUmVkdWNlcnMucmVkdWNlKChwcmV2aW91c1N0YXRlLCBjYXNlUmVkdWNlcikgPT4gewogICAgICBpZiAoY2FzZVJlZHVjZXIpIHsKICAgICAgICBpZiAoaXNEcmFmdChwcmV2aW91c1N0YXRlKSkgewogICAgICAgICAgY29uc3QgZHJhZnQgPSBwcmV2aW91c1N0YXRlOwogICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2FzZVJlZHVjZXIoZHJhZnQsIGFjdGlvbik7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0gZWxzZSBpZiAoIWlzRHJhZnRhYmxlKHByZXZpb3VzU3RhdGUpKSB7CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBjYXNlUmVkdWNlcihwcmV2aW91c1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1N0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzU3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkEgY2FzZSByZWR1Y2VyIG9uIGEgbm9uLWRyYWZ0YWJsZSB2YWx1ZSBtdXN0IG5vdCByZXR1cm4gdW5kZWZpbmVkIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gcHJvZHVjZShwcmV2aW91c1N0YXRlLCAoZHJhZnQpID0+IHsKICAgICAgICAgICAgcmV0dXJuIGNhc2VSZWR1Y2VyKGRyYWZ0LCBhY3Rpb24pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBwcmV2aW91c1N0YXRlOwogICAgfSwgc3RhdGUpOwogIH0KICByZWR1Y2VyLmdldEluaXRpYWxTdGF0ZSA9IGdldEluaXRpYWxTdGF0ZTsKICByZXR1cm4gcmVkdWNlcjsKfQp2YXIgbWF0Y2hlcyA9IChtYXRjaGVyLCBhY3Rpb24pID0+IHsKICBpZiAoaGFzTWF0Y2hGdW5jdGlvbihtYXRjaGVyKSkgewogICAgcmV0dXJuIG1hdGNoZXIubWF0Y2goYWN0aW9uKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG1hdGNoZXIoYWN0aW9uKTsKICB9Cn07CmZ1bmN0aW9uIGlzQW55T2YoLi4ubWF0Y2hlcnMpIHsKICByZXR1cm4gKGFjdGlvbikgPT4gewogICAgcmV0dXJuIG1hdGNoZXJzLnNvbWUoKG1hdGNoZXIpID0+IG1hdGNoZXMobWF0Y2hlciwgYWN0aW9uKSk7CiAgfTsKfQp2YXIgdXJsQWxwaGFiZXQgPSAiTW9kdWxlU3ltYmhhc093blByLTAxMjM0NTY3ODlBQkNERUZHSE5SVmZnY3RpVXZ6X0txWVRKa0x4cFpYSWpRVyI7CnZhciBuYW5vaWQgPSAoc2l6ZSA9IDIxKSA9PiB7CiAgbGV0IGlkID0gIiI7CiAgbGV0IGkgPSBzaXplOwogIHdoaWxlIChpLS0pIHsKICAgIGlkICs9IHVybEFscGhhYmV0W01hdGgucmFuZG9tKCkgKiA2NCB8IDBdOwogIH0KICByZXR1cm4gaWQ7Cn07CnZhciBjb21tb25Qcm9wZXJ0aWVzID0gWyJuYW1lIiwgIm1lc3NhZ2UiLCAic3RhY2siLCAiY29kZSJdOwp2YXIgUmVqZWN0V2l0aFZhbHVlID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHBheWxvYWQsIG1ldGEpIHsKICAgIHRoaXMucGF5bG9hZCA9IHBheWxvYWQ7CiAgICB0aGlzLm1ldGEgPSBtZXRhOwogIH0KICAvKgogIHR5cGUtb25seSBwcm9wZXJ0eSB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIFJlamVjdFdpdGhWYWx1ZSBhbmQgRnVsZmlsbFdpdGhNZXRhCiAgZG9lcyBub3QgZXhpc3QgYXQgcnVudGltZQogICovCiAgX3R5cGU7Cn07CnZhciBGdWxmaWxsV2l0aE1ldGEgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IocGF5bG9hZCwgbWV0YSkgewogICAgdGhpcy5wYXlsb2FkID0gcGF5bG9hZDsKICAgIHRoaXMubWV0YSA9IG1ldGE7CiAgfQogIC8qCiAgdHlwZS1vbmx5IHByb3BlcnR5IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gUmVqZWN0V2l0aFZhbHVlIGFuZCBGdWxmaWxsV2l0aE1ldGEKICBkb2VzIG5vdCBleGlzdCBhdCBydW50aW1lCiAgKi8KICBfdHlwZTsKfTsKdmFyIG1pbmlTZXJpYWxpemVFcnJvciA9ICh2YWx1ZSkgPT4gewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICBjb25zdCBzaW1wbGVFcnJvciA9IHt9OwogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBjb21tb25Qcm9wZXJ0aWVzKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWVbcHJvcGVydHldID09PSAic3RyaW5nIikgewogICAgICAgIHNpbXBsZUVycm9yW3Byb3BlcnR5XSA9IHZhbHVlW3Byb3BlcnR5XTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNpbXBsZUVycm9yOwogIH0KICByZXR1cm4gewogICAgbWVzc2FnZTogU3RyaW5nKHZhbHVlKQogIH07Cn07CnZhciBleHRlcm5hbEFib3J0TWVzc2FnZSA9ICJFeHRlcm5hbCBzaWduYWwgd2FzIGFib3J0ZWQiOwp2YXIgY3JlYXRlQXN5bmNUaHVuayA9IC8qIEBfX1BVUkVfXyAqLyAoKCkgPT4gewogIGZ1bmN0aW9uIGNyZWF0ZUFzeW5jVGh1bmsyKHR5cGVQcmVmaXgsIHBheWxvYWRDcmVhdG9yLCBvcHRpb25zKSB7CiAgICBjb25zdCBmdWxmaWxsZWQgPSBjcmVhdGVBY3Rpb24odHlwZVByZWZpeCArICIvZnVsZmlsbGVkIiwgKHBheWxvYWQsIHJlcXVlc3RJZCwgYXJnLCBtZXRhKSA9PiAoewogICAgICBwYXlsb2FkLAogICAgICBtZXRhOiB7CiAgICAgICAgLi4ubWV0YSB8fCB7fSwKICAgICAgICBhcmcsCiAgICAgICAgcmVxdWVzdElkLAogICAgICAgIHJlcXVlc3RTdGF0dXM6ICJmdWxmaWxsZWQiCiAgICAgIH0KICAgIH0pKTsKICAgIGNvbnN0IHBlbmRpbmcgPSBjcmVhdGVBY3Rpb24odHlwZVByZWZpeCArICIvcGVuZGluZyIsIChyZXF1ZXN0SWQsIGFyZywgbWV0YSkgPT4gKHsKICAgICAgcGF5bG9hZDogdm9pZCAwLAogICAgICBtZXRhOiB7CiAgICAgICAgLi4ubWV0YSB8fCB7fSwKICAgICAgICBhcmcsCiAgICAgICAgcmVxdWVzdElkLAogICAgICAgIHJlcXVlc3RTdGF0dXM6ICJwZW5kaW5nIgogICAgICB9CiAgICB9KSk7CiAgICBjb25zdCByZWplY3RlZCA9IGNyZWF0ZUFjdGlvbih0eXBlUHJlZml4ICsgIi9yZWplY3RlZCIsIChlcnJvciwgcmVxdWVzdElkLCBhcmcsIHBheWxvYWQsIG1ldGEpID0+ICh7CiAgICAgIHBheWxvYWQsCiAgICAgIGVycm9yOiAob3B0aW9ucyAmJiBvcHRpb25zLnNlcmlhbGl6ZUVycm9yIHx8IG1pbmlTZXJpYWxpemVFcnJvcikoZXJyb3IgfHwgIlJlamVjdGVkIiksCiAgICAgIG1ldGE6IHsKICAgICAgICAuLi5tZXRhIHx8IHt9LAogICAgICAgIGFyZywKICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgcmVqZWN0ZWRXaXRoVmFsdWU6ICEhcGF5bG9hZCwKICAgICAgICByZXF1ZXN0U3RhdHVzOiAicmVqZWN0ZWQiLAogICAgICAgIGFib3J0ZWQ6IGVycm9yPy5uYW1lID09PSAiQWJvcnRFcnJvciIsCiAgICAgICAgY29uZGl0aW9uOiBlcnJvcj8ubmFtZSA9PT0gIkNvbmRpdGlvbkVycm9yIgogICAgICB9CiAgICB9KSk7CiAgICBmdW5jdGlvbiBhY3Rpb25DcmVhdG9yKGFyZywgewogICAgICBzaWduYWwKICAgIH0gPSB7fSkgewogICAgICByZXR1cm4gKGRpc3BhdGNoLCBnZXRTdGF0ZSwgZXh0cmEpID0+IHsKICAgICAgICBjb25zdCByZXF1ZXN0SWQgPSBvcHRpb25zPy5pZEdlbmVyYXRvciA/IG9wdGlvbnMuaWRHZW5lcmF0b3IoYXJnKSA6IG5hbm9pZCgpOwogICAgICAgIGNvbnN0IGFib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICAgICBsZXQgYWJvcnRIYW5kbGVyOwogICAgICAgIGxldCBhYm9ydFJlYXNvbjsKICAgICAgICBmdW5jdGlvbiBhYm9ydChyZWFzb24pIHsKICAgICAgICAgIGFib3J0UmVhc29uID0gcmVhc29uOwogICAgICAgICAgYWJvcnRDb250cm9sbGVyLmFib3J0KCk7CiAgICAgICAgfQogICAgICAgIGlmIChzaWduYWwpIHsKICAgICAgICAgIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgICAgICAgICBhYm9ydChleHRlcm5hbEFib3J0TWVzc2FnZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCAoKSA9PiBhYm9ydChleHRlcm5hbEFib3J0TWVzc2FnZSksIHsKICAgICAgICAgICAgICBvbmNlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBwcm9taXNlID0gYXN5bmMgZnVuY3Rpb24oKSB7CiAgICAgICAgICBsZXQgZmluYWxBY3Rpb247CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsZXQgY29uZGl0aW9uUmVzdWx0ID0gb3B0aW9ucz8uY29uZGl0aW9uPy4oYXJnLCB7CiAgICAgICAgICAgICAgZ2V0U3RhdGUsCiAgICAgICAgICAgICAgZXh0cmEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChpc1RoZW5hYmxlKGNvbmRpdGlvblJlc3VsdCkpIHsKICAgICAgICAgICAgICBjb25kaXRpb25SZXN1bHQgPSBhd2FpdCBjb25kaXRpb25SZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbmRpdGlvblJlc3VsdCA9PT0gZmFsc2UgfHwgYWJvcnRDb250cm9sbGVyLnNpZ25hbC5hYm9ydGVkKSB7CiAgICAgICAgICAgICAgdGhyb3cgewogICAgICAgICAgICAgICAgbmFtZTogIkNvbmRpdGlvbkVycm9yIiwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICJBYm9ydGVkIGR1ZSB0byBjb25kaXRpb24gY2FsbGJhY2sgcmV0dXJuaW5nIGZhbHNlLiIKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGFib3J0ZWRQcm9taXNlID0gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4gewogICAgICAgICAgICAgIGFib3J0SGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgICAgICAgIG5hbWU6ICJBYm9ydEVycm9yIiwKICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYWJvcnRSZWFzb24gfHwgIkFib3J0ZWQiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGFib3J0Q29udHJvbGxlci5zaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBhYm9ydEhhbmRsZXIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGlzcGF0Y2gocGVuZGluZyhyZXF1ZXN0SWQsIGFyZywgb3B0aW9ucz8uZ2V0UGVuZGluZ01ldGE/Lih7CiAgICAgICAgICAgICAgcmVxdWVzdElkLAogICAgICAgICAgICAgIGFyZwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgZ2V0U3RhdGUsCiAgICAgICAgICAgICAgZXh0cmEKICAgICAgICAgICAgfSkpKTsKICAgICAgICAgICAgZmluYWxBY3Rpb24gPSBhd2FpdCBQcm9taXNlLnJhY2UoW2Fib3J0ZWRQcm9taXNlLCBQcm9taXNlLnJlc29sdmUocGF5bG9hZENyZWF0b3IoYXJnLCB7CiAgICAgICAgICAgICAgZGlzcGF0Y2gsCiAgICAgICAgICAgICAgZ2V0U3RhdGUsCiAgICAgICAgICAgICAgZXh0cmEsCiAgICAgICAgICAgICAgcmVxdWVzdElkLAogICAgICAgICAgICAgIHNpZ25hbDogYWJvcnRDb250cm9sbGVyLnNpZ25hbCwKICAgICAgICAgICAgICBhYm9ydCwKICAgICAgICAgICAgICByZWplY3RXaXRoVmFsdWU6ICh2YWx1ZSwgbWV0YSkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWplY3RXaXRoVmFsdWUodmFsdWUsIG1ldGEpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVsZmlsbFdpdGhWYWx1ZTogKHZhbHVlLCBtZXRhKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEZ1bGZpbGxXaXRoTWV0YSh2YWx1ZSwgbWV0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSkudGhlbigocmVzdWx0KSA9PiB7CiAgICAgICAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFJlamVjdFdpdGhWYWx1ZSkgewogICAgICAgICAgICAgICAgdGhyb3cgcmVzdWx0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgRnVsZmlsbFdpdGhNZXRhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVsZmlsbGVkKHJlc3VsdC5wYXlsb2FkLCByZXF1ZXN0SWQsIGFyZywgcmVzdWx0Lm1ldGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZnVsZmlsbGVkKHJlc3VsdCwgcmVxdWVzdElkLCBhcmcpOwogICAgICAgICAgICB9KV0pOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGZpbmFsQWN0aW9uID0gZXJyIGluc3RhbmNlb2YgUmVqZWN0V2l0aFZhbHVlID8gcmVqZWN0ZWQobnVsbCwgcmVxdWVzdElkLCBhcmcsIGVyci5wYXlsb2FkLCBlcnIubWV0YSkgOiByZWplY3RlZChlcnIsIHJlcXVlc3RJZCwgYXJnKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGlmIChhYm9ydEhhbmRsZXIpIHsKICAgICAgICAgICAgICBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImFib3J0IiwgYWJvcnRIYW5kbGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgc2tpcERpc3BhdGNoID0gb3B0aW9ucyAmJiAhb3B0aW9ucy5kaXNwYXRjaENvbmRpdGlvblJlamVjdGlvbiAmJiByZWplY3RlZC5tYXRjaChmaW5hbEFjdGlvbikgJiYgZmluYWxBY3Rpb24ubWV0YS5jb25kaXRpb247CiAgICAgICAgICBpZiAoIXNraXBEaXNwYXRjaCkgewogICAgICAgICAgICBkaXNwYXRjaChmaW5hbEFjdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmluYWxBY3Rpb247CiAgICAgICAgfSgpOwogICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHByb21pc2UsIHsKICAgICAgICAgIGFib3J0LAogICAgICAgICAgcmVxdWVzdElkLAogICAgICAgICAgYXJnLAogICAgICAgICAgdW53cmFwKCkgewogICAgICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKHVud3JhcFJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihhY3Rpb25DcmVhdG9yLCB7CiAgICAgIHBlbmRpbmcsCiAgICAgIHJlamVjdGVkLAogICAgICBmdWxmaWxsZWQsCiAgICAgIHNldHRsZWQ6IGlzQW55T2YocmVqZWN0ZWQsIGZ1bGZpbGxlZCksCiAgICAgIHR5cGVQcmVmaXgKICAgIH0pOwogIH0KICBjcmVhdGVBc3luY1RodW5rMi53aXRoVHlwZXMgPSAoKSA9PiBjcmVhdGVBc3luY1RodW5rMjsKICByZXR1cm4gY3JlYXRlQXN5bmNUaHVuazI7Cn0pKCk7CmZ1bmN0aW9uIHVud3JhcFJlc3VsdChhY3Rpb24pIHsKICBpZiAoYWN0aW9uLm1ldGEgJiYgYWN0aW9uLm1ldGEucmVqZWN0ZWRXaXRoVmFsdWUpIHsKICAgIHRocm93IGFjdGlvbi5wYXlsb2FkOwogIH0KICBpZiAoYWN0aW9uLmVycm9yKSB7CiAgICB0aHJvdyBhY3Rpb24uZXJyb3I7CiAgfQogIHJldHVybiBhY3Rpb24ucGF5bG9hZDsKfQpmdW5jdGlvbiBpc1RoZW5hYmxlKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHZhbHVlLnRoZW4gPT09ICJmdW5jdGlvbiI7Cn0KdmFyIGFzeW5jVGh1bmtTeW1ib2wgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcigicnRrLXNsaWNlLWNyZWF0ZWFzeW5jdGh1bmsiKTsKdmFyIGFzeW5jVGh1bmtDcmVhdG9yID0gewogIFthc3luY1RodW5rU3ltYm9sXTogY3JlYXRlQXN5bmNUaHVuawp9OwpmdW5jdGlvbiBnZXRUeXBlKHNsaWNlMiwgYWN0aW9uS2V5KSB7CiAgcmV0dXJuIGAke3NsaWNlMn0vJHthY3Rpb25LZXl9YDsKfQpmdW5jdGlvbiBidWlsZENyZWF0ZVNsaWNlKHsKICBjcmVhdG9ycwp9ID0ge30pIHsKICBjb25zdCBjQVQgPSBjcmVhdG9ycz8uYXN5bmNUaHVuaz8uW2FzeW5jVGh1bmtTeW1ib2xdOwogIHJldHVybiBmdW5jdGlvbiBjcmVhdGVTbGljZTIob3B0aW9ucykgewogICAgY29uc3QgewogICAgICBuYW1lLAogICAgICByZWR1Y2VyUGF0aCA9IG5hbWUKICAgIH0gPSBvcHRpb25zOwogICAgaWYgKCFuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTEpIDogImBuYW1lYCBpcyBhIHJlcXVpcmVkIG9wdGlvbiBmb3IgY3JlYXRlU2xpY2UiKTsKICAgIH0KICAgIGlmICh0eXBlb2YgcHJvY2VzcyAhPT0gInVuZGVmaW5lZCIgJiYgdHJ1ZSkgewogICAgICBpZiAob3B0aW9ucy5pbml0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIllvdSBtdXN0IHByb3ZpZGUgYW4gYGluaXRpYWxTdGF0ZWAgdmFsdWUgdGhhdCBpcyBub3QgYHVuZGVmaW5lZGAuIFlvdSBtYXkgaGF2ZSBtaXNzcGVsbGVkIGBpbml0aWFsU3RhdGVgIik7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlZHVjZXJzID0gKHR5cGVvZiBvcHRpb25zLnJlZHVjZXJzID09PSAiZnVuY3Rpb24iID8gb3B0aW9ucy5yZWR1Y2VycyhidWlsZFJlZHVjZXJDcmVhdG9ycygpKSA6IG9wdGlvbnMucmVkdWNlcnMpIHx8IHt9OwogICAgY29uc3QgcmVkdWNlck5hbWVzID0gT2JqZWN0LmtleXMocmVkdWNlcnMpOwogICAgY29uc3QgY29udGV4dCA9IHsKICAgICAgc2xpY2VDYXNlUmVkdWNlcnNCeU5hbWU6IHt9LAogICAgICBzbGljZUNhc2VSZWR1Y2Vyc0J5VHlwZToge30sCiAgICAgIGFjdGlvbkNyZWF0b3JzOiB7fSwKICAgICAgc2xpY2VNYXRjaGVyczogW10KICAgIH07CiAgICBjb25zdCBjb250ZXh0TWV0aG9kcyA9IHsKICAgICAgYWRkQ2FzZSh0eXBlT3JBY3Rpb25DcmVhdG9yLCByZWR1Y2VyMikgewogICAgICAgIGNvbnN0IHR5cGUgPSB0eXBlb2YgdHlwZU9yQWN0aW9uQ3JlYXRvciA9PT0gInN0cmluZyIgPyB0eXBlT3JBY3Rpb25DcmVhdG9yIDogdHlwZU9yQWN0aW9uQ3JlYXRvci50eXBlOwogICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMikgOiAiYGNvbnRleHQuYWRkQ2FzZWAgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGFuIGVtcHR5IGFjdGlvbiB0eXBlIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlIGluIGNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTMpIDogImBjb250ZXh0LmFkZENhc2VgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCB0d28gcmVkdWNlcnMgZm9yIHRoZSBzYW1lIGFjdGlvbiB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgfQogICAgICAgIGNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGVbdHlwZV0gPSByZWR1Y2VyMjsKICAgICAgICByZXR1cm4gY29udGV4dE1ldGhvZHM7CiAgICAgIH0sCiAgICAgIGFkZE1hdGNoZXIobWF0Y2hlciwgcmVkdWNlcjIpIHsKICAgICAgICBjb250ZXh0LnNsaWNlTWF0Y2hlcnMucHVzaCh7CiAgICAgICAgICBtYXRjaGVyLAogICAgICAgICAgcmVkdWNlcjogcmVkdWNlcjIKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY29udGV4dE1ldGhvZHM7CiAgICAgIH0sCiAgICAgIGV4cG9zZUFjdGlvbihuYW1lMiwgYWN0aW9uQ3JlYXRvcikgewogICAgICAgIGNvbnRleHQuYWN0aW9uQ3JlYXRvcnNbbmFtZTJdID0gYWN0aW9uQ3JlYXRvcjsKICAgICAgICByZXR1cm4gY29udGV4dE1ldGhvZHM7CiAgICAgIH0sCiAgICAgIGV4cG9zZUNhc2VSZWR1Y2VyKG5hbWUyLCByZWR1Y2VyMikgewogICAgICAgIGNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeU5hbWVbbmFtZTJdID0gcmVkdWNlcjI7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9CiAgICB9OwogICAgcmVkdWNlck5hbWVzLmZvckVhY2goKHJlZHVjZXJOYW1lKSA9PiB7CiAgICAgIGNvbnN0IHJlZHVjZXJEZWZpbml0aW9uID0gcmVkdWNlcnNbcmVkdWNlck5hbWVdOwogICAgICBjb25zdCByZWR1Y2VyRGV0YWlscyA9IHsKICAgICAgICByZWR1Y2VyTmFtZSwKICAgICAgICB0eXBlOiBnZXRUeXBlKG5hbWUsIHJlZHVjZXJOYW1lKSwKICAgICAgICBjcmVhdGVOb3RhdGlvbjogdHlwZW9mIG9wdGlvbnMucmVkdWNlcnMgPT09ICJmdW5jdGlvbiIKICAgICAgfTsKICAgICAgaWYgKGlzQXN5bmNUaHVua1NsaWNlUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRlZmluaXRpb24pKSB7CiAgICAgICAgaGFuZGxlVGh1bmtDYXNlUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRldGFpbHMsIHJlZHVjZXJEZWZpbml0aW9uLCBjb250ZXh0TWV0aG9kcywgY0FUKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBoYW5kbGVOb3JtYWxSZWR1Y2VyRGVmaW5pdGlvbihyZWR1Y2VyRGV0YWlscywgcmVkdWNlckRlZmluaXRpb24sIGNvbnRleHRNZXRob2RzKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBidWlsZFJlZHVjZXIoKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmV4dHJhUmVkdWNlcnMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE0KSA6ICJUaGUgb2JqZWN0IG5vdGF0aW9uIGZvciBgY3JlYXRlU2xpY2UuZXh0cmFSZWR1Y2Vyc2AgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHVzZSB0aGUgJ2J1aWxkZXIgY2FsbGJhY2snIG5vdGF0aW9uIGluc3RlYWQ6IGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvYXBpL2NyZWF0ZVNsaWNlIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IFtleHRyYVJlZHVjZXJzID0ge30sIGFjdGlvbk1hdGNoZXJzID0gW10sIGRlZmF1bHRDYXNlUmVkdWNlciA9IHZvaWQgMF0gPSB0eXBlb2Ygb3B0aW9ucy5leHRyYVJlZHVjZXJzID09PSAiZnVuY3Rpb24iID8gZXhlY3V0ZVJlZHVjZXJCdWlsZGVyQ2FsbGJhY2sob3B0aW9ucy5leHRyYVJlZHVjZXJzKSA6IFtvcHRpb25zLmV4dHJhUmVkdWNlcnNdOwogICAgICBjb25zdCBmaW5hbENhc2VSZWR1Y2VycyA9IHsKICAgICAgICAuLi5leHRyYVJlZHVjZXJzLAogICAgICAgIC4uLmNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGUKICAgICAgfTsKICAgICAgcmV0dXJuIGNyZWF0ZVJlZHVjZXIob3B0aW9ucy5pbml0aWFsU3RhdGUsIChidWlsZGVyKSA9PiB7CiAgICAgICAgZm9yIChsZXQga2V5IGluIGZpbmFsQ2FzZVJlZHVjZXJzKSB7CiAgICAgICAgICBidWlsZGVyLmFkZENhc2Uoa2V5LCBmaW5hbENhc2VSZWR1Y2Vyc1trZXldKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgc00gb2YgY29udGV4dC5zbGljZU1hdGNoZXJzKSB7CiAgICAgICAgICBidWlsZGVyLmFkZE1hdGNoZXIoc00ubWF0Y2hlciwgc00ucmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IG0gb2YgYWN0aW9uTWF0Y2hlcnMpIHsKICAgICAgICAgIGJ1aWxkZXIuYWRkTWF0Y2hlcihtLm1hdGNoZXIsIG0ucmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIGJ1aWxkZXIuYWRkRGVmYXVsdENhc2UoZGVmYXVsdENhc2VSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgc2VsZWN0U2VsZiA9IChzdGF0ZSkgPT4gc3RhdGU7CiAgICBjb25zdCBpbmplY3RlZFNlbGVjdG9yQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29uc3QgaW5qZWN0ZWRTdGF0ZUNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgICBsZXQgX3JlZHVjZXI7CiAgICBmdW5jdGlvbiByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgaWYgKCFfcmVkdWNlcikgX3JlZHVjZXIgPSBidWlsZFJlZHVjZXIoKTsKICAgICAgcmV0dXJuIF9yZWR1Y2VyKHN0YXRlLCBhY3Rpb24pOwogICAgfQogICAgZnVuY3Rpb24gZ2V0SW5pdGlhbFN0YXRlKCkgewogICAgICBpZiAoIV9yZWR1Y2VyKSBfcmVkdWNlciA9IGJ1aWxkUmVkdWNlcigpOwogICAgICByZXR1cm4gX3JlZHVjZXIuZ2V0SW5pdGlhbFN0YXRlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBtYWtlU2VsZWN0b3JQcm9wcyhyZWR1Y2VyUGF0aDIsIGluamVjdGVkID0gZmFsc2UpIHsKICAgICAgZnVuY3Rpb24gc2VsZWN0U2xpY2Uoc3RhdGUpIHsKICAgICAgICBsZXQgc2xpY2VTdGF0ZSA9IHN0YXRlW3JlZHVjZXJQYXRoMl07CiAgICAgICAgaWYgKHR5cGVvZiBzbGljZVN0YXRlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgaWYgKGluamVjdGVkKSB7CiAgICAgICAgICAgIHNsaWNlU3RhdGUgPSBnZXRPckluc2VydENvbXB1dGVkKGluamVjdGVkU3RhdGVDYWNoZSwgc2VsZWN0U2xpY2UsIGdldEluaXRpYWxTdGF0ZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRydWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNSkgOiAic2VsZWN0U2xpY2UgcmV0dXJuZWQgdW5kZWZpbmVkIGZvciBhbiB1bmluamVjdGVkIHNsaWNlIHJlZHVjZXIiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNsaWNlU3RhdGU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0b3JzKHNlbGVjdFN0YXRlID0gc2VsZWN0U2VsZikgewogICAgICAgIGNvbnN0IHNlbGVjdG9yQ2FjaGUgPSBnZXRPckluc2VydENvbXB1dGVkKGluamVjdGVkU2VsZWN0b3JDYWNoZSwgaW5qZWN0ZWQsICgpID0+IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpKTsKICAgICAgICByZXR1cm4gZ2V0T3JJbnNlcnRDb21wdXRlZChzZWxlY3RvckNhY2hlLCBzZWxlY3RTdGF0ZSwgKCkgPT4gewogICAgICAgICAgY29uc3QgbWFwMyA9IHt9OwogICAgICAgICAgZm9yIChjb25zdCBbbmFtZTIsIHNlbGVjdG9yXSBvZiBPYmplY3QuZW50cmllcyhvcHRpb25zLnNlbGVjdG9ycyA/PyB7fSkpIHsKICAgICAgICAgICAgbWFwM1tuYW1lMl0gPSB3cmFwU2VsZWN0b3Ioc2VsZWN0b3IsIHNlbGVjdFN0YXRlLCAoKSA9PiBnZXRPckluc2VydENvbXB1dGVkKGluamVjdGVkU3RhdGVDYWNoZSwgc2VsZWN0U3RhdGUsIGdldEluaXRpYWxTdGF0ZSksIGluamVjdGVkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXAzOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVkdWNlclBhdGg6IHJlZHVjZXJQYXRoMiwKICAgICAgICBnZXRTZWxlY3RvcnMsCiAgICAgICAgZ2V0IHNlbGVjdG9ycygpIHsKICAgICAgICAgIHJldHVybiBnZXRTZWxlY3RvcnMoc2VsZWN0U2xpY2UpOwogICAgICAgIH0sCiAgICAgICAgc2VsZWN0U2xpY2UKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHNsaWNlMiA9IHsKICAgICAgbmFtZSwKICAgICAgcmVkdWNlciwKICAgICAgYWN0aW9uczogY29udGV4dC5hY3Rpb25DcmVhdG9ycywKICAgICAgY2FzZVJlZHVjZXJzOiBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlOYW1lLAogICAgICBnZXRJbml0aWFsU3RhdGUsCiAgICAgIC4uLm1ha2VTZWxlY3RvclByb3BzKHJlZHVjZXJQYXRoKSwKICAgICAgaW5qZWN0SW50byhpbmplY3RhYmxlLCB7CiAgICAgICAgcmVkdWNlclBhdGg6IHBhdGhPcHQsCiAgICAgICAgLi4uY29uZmlnCiAgICAgIH0gPSB7fSkgewogICAgICAgIGNvbnN0IG5ld1JlZHVjZXJQYXRoID0gcGF0aE9wdCA/PyByZWR1Y2VyUGF0aDsKICAgICAgICBpbmplY3RhYmxlLmluamVjdCh7CiAgICAgICAgICByZWR1Y2VyUGF0aDogbmV3UmVkdWNlclBhdGgsCiAgICAgICAgICByZWR1Y2VyCiAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgLi4uc2xpY2UyLAogICAgICAgICAgLi4ubWFrZVNlbGVjdG9yUHJvcHMobmV3UmVkdWNlclBhdGgsIHRydWUpCiAgICAgICAgfTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiBzbGljZTI7CiAgfTsKfQpmdW5jdGlvbiB3cmFwU2VsZWN0b3Ioc2VsZWN0b3IsIHNlbGVjdFN0YXRlLCBnZXRJbml0aWFsU3RhdGUsIGluamVjdGVkKSB7CiAgZnVuY3Rpb24gd3JhcHBlcihyb290U3RhdGUsIC4uLmFyZ3MpIHsKICAgIGxldCBzbGljZVN0YXRlID0gc2VsZWN0U3RhdGUocm9vdFN0YXRlKTsKICAgIGlmICh0eXBlb2Ygc2xpY2VTdGF0ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgaWYgKGluamVjdGVkKSB7CiAgICAgICAgc2xpY2VTdGF0ZSA9IGdldEluaXRpYWxTdGF0ZSgpOwogICAgICB9IGVsc2UgaWYgKHRydWUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE2KSA6ICJzZWxlY3RTdGF0ZSByZXR1cm5lZCB1bmRlZmluZWQgZm9yIGFuIHVuaW5qZWN0ZWQgc2xpY2UgcmVkdWNlciIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2VsZWN0b3Ioc2xpY2VTdGF0ZSwgLi4uYXJncyk7CiAgfQogIHdyYXBwZXIudW53cmFwcGVkID0gc2VsZWN0b3I7CiAgcmV0dXJuIHdyYXBwZXI7Cn0KdmFyIGNyZWF0ZVNsaWNlID0gLyogQF9fUFVSRV9fICovIGJ1aWxkQ3JlYXRlU2xpY2UoKTsKZnVuY3Rpb24gYnVpbGRSZWR1Y2VyQ3JlYXRvcnMoKSB7CiAgZnVuY3Rpb24gYXN5bmNUaHVuayhwYXlsb2FkQ3JlYXRvciwgY29uZmlnKSB7CiAgICByZXR1cm4gewogICAgICBfcmVkdWNlckRlZmluaXRpb25UeXBlOiAiYXN5bmNUaHVuayIsCiAgICAgIHBheWxvYWRDcmVhdG9yLAogICAgICAuLi5jb25maWcKICAgIH07CiAgfQogIGFzeW5jVGh1bmsud2l0aFR5cGVzID0gKCkgPT4gYXN5bmNUaHVuazsKICByZXR1cm4gewogICAgcmVkdWNlcihjYXNlUmVkdWNlcikgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7CiAgICAgICAgLy8gaGFjayBzbyB0aGUgd3JhcHBpbmcgZnVuY3Rpb24gaGFzIHRoZSBzYW1lIG5hbWUgYXMgdGhlIG9yaWdpbmFsCiAgICAgICAgLy8gd2UgbmVlZCB0byBjcmVhdGUgYSB3cmFwcGVyIHNvIHRoZSBgcmVkdWNlckRlZmluaXRpb25UeXBlYCBpcyBub3QgYXNzaWduZWQgdG8gdGhlIG9yaWdpbmFsCiAgICAgICAgW2Nhc2VSZWR1Y2VyLm5hbWVdKC4uLmFyZ3MpIHsKICAgICAgICAgIHJldHVybiBjYXNlUmVkdWNlciguLi5hcmdzKTsKICAgICAgICB9CiAgICAgIH1bY2FzZVJlZHVjZXIubmFtZV0sIHsKICAgICAgICBfcmVkdWNlckRlZmluaXRpb25UeXBlOiAicmVkdWNlciIKICAgICAgICAvKiByZWR1Y2VyICovCiAgICAgIH0pOwogICAgfSwKICAgIHByZXBhcmVkUmVkdWNlcihwcmVwYXJlLCByZWR1Y2VyKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgX3JlZHVjZXJEZWZpbml0aW9uVHlwZTogInJlZHVjZXJXaXRoUHJlcGFyZSIsCiAgICAgICAgcHJlcGFyZSwKICAgICAgICByZWR1Y2VyCiAgICAgIH07CiAgICB9LAogICAgYXN5bmNUaHVuawogIH07Cn0KZnVuY3Rpb24gaGFuZGxlTm9ybWFsUmVkdWNlckRlZmluaXRpb24oewogIHR5cGUsCiAgcmVkdWNlck5hbWUsCiAgY3JlYXRlTm90YXRpb24KfSwgbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUsIGNvbnRleHQpIHsKICBsZXQgY2FzZVJlZHVjZXI7CiAgbGV0IHByZXBhcmVDYWxsYmFjazsKICBpZiAoInJlZHVjZXIiIGluIG1heWJlUmVkdWNlcldpdGhQcmVwYXJlKSB7CiAgICBpZiAoY3JlYXRlTm90YXRpb24gJiYgIWlzQ2FzZVJlZHVjZXJXaXRoUHJlcGFyZURlZmluaXRpb24obWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTcpIDogIlBsZWFzZSB1c2UgdGhlIGBjcmVhdGUucHJlcGFyZWRSZWR1Y2VyYCBub3RhdGlvbiBmb3IgcHJlcGFyZWQgYWN0aW9uIGNyZWF0b3JzIHdpdGggdGhlIGBjcmVhdGVgIG5vdGF0aW9uLiIpOwogICAgfQogICAgY2FzZVJlZHVjZXIgPSBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZS5yZWR1Y2VyOwogICAgcHJlcGFyZUNhbGxiYWNrID0gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUucHJlcGFyZTsKICB9IGVsc2UgewogICAgY2FzZVJlZHVjZXIgPSBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZTsKICB9CiAgY29udGV4dC5hZGRDYXNlKHR5cGUsIGNhc2VSZWR1Y2VyKS5leHBvc2VDYXNlUmVkdWNlcihyZWR1Y2VyTmFtZSwgY2FzZVJlZHVjZXIpLmV4cG9zZUFjdGlvbihyZWR1Y2VyTmFtZSwgcHJlcGFyZUNhbGxiYWNrID8gY3JlYXRlQWN0aW9uKHR5cGUsIHByZXBhcmVDYWxsYmFjaykgOiBjcmVhdGVBY3Rpb24odHlwZSkpOwp9CmZ1bmN0aW9uIGlzQXN5bmNUaHVua1NsaWNlUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRlZmluaXRpb24pIHsKICByZXR1cm4gcmVkdWNlckRlZmluaXRpb24uX3JlZHVjZXJEZWZpbml0aW9uVHlwZSA9PT0gImFzeW5jVGh1bmsiOwp9CmZ1bmN0aW9uIGlzQ2FzZVJlZHVjZXJXaXRoUHJlcGFyZURlZmluaXRpb24ocmVkdWNlckRlZmluaXRpb24pIHsKICByZXR1cm4gcmVkdWNlckRlZmluaXRpb24uX3JlZHVjZXJEZWZpbml0aW9uVHlwZSA9PT0gInJlZHVjZXJXaXRoUHJlcGFyZSI7Cn0KZnVuY3Rpb24gaGFuZGxlVGh1bmtDYXNlUmVkdWNlckRlZmluaXRpb24oewogIHR5cGUsCiAgcmVkdWNlck5hbWUKfSwgcmVkdWNlckRlZmluaXRpb24sIGNvbnRleHQsIGNBVCkgewogIGlmICghY0FUKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE4KSA6ICJDYW5ub3QgdXNlIGBjcmVhdGUuYXN5bmNUaHVua2AgaW4gdGhlIGJ1aWx0LWluIGBjcmVhdGVTbGljZWAuIFVzZSBgYnVpbGRDcmVhdGVTbGljZSh7IGNyZWF0b3JzOiB7IGFzeW5jVGh1bms6IGFzeW5jVGh1bmtDcmVhdG9yIH0gfSlgIHRvIGNyZWF0ZSBhIGN1c3RvbWlzZWQgdmVyc2lvbiBvZiBgY3JlYXRlU2xpY2VgLiIpOwogIH0KICBjb25zdCB7CiAgICBwYXlsb2FkQ3JlYXRvciwKICAgIGZ1bGZpbGxlZCwKICAgIHBlbmRpbmcsCiAgICByZWplY3RlZCwKICAgIHNldHRsZWQsCiAgICBvcHRpb25zCiAgfSA9IHJlZHVjZXJEZWZpbml0aW9uOwogIGNvbnN0IHRodW5rMiA9IGNBVCh0eXBlLCBwYXlsb2FkQ3JlYXRvciwgb3B0aW9ucyk7CiAgY29udGV4dC5leHBvc2VBY3Rpb24ocmVkdWNlck5hbWUsIHRodW5rMik7CiAgaWYgKGZ1bGZpbGxlZCkgewogICAgY29udGV4dC5hZGRDYXNlKHRodW5rMi5mdWxmaWxsZWQsIGZ1bGZpbGxlZCk7CiAgfQogIGlmIChwZW5kaW5nKSB7CiAgICBjb250ZXh0LmFkZENhc2UodGh1bmsyLnBlbmRpbmcsIHBlbmRpbmcpOwogIH0KICBpZiAocmVqZWN0ZWQpIHsKICAgIGNvbnRleHQuYWRkQ2FzZSh0aHVuazIucmVqZWN0ZWQsIHJlamVjdGVkKTsKICB9CiAgaWYgKHNldHRsZWQpIHsKICAgIGNvbnRleHQuYWRkTWF0Y2hlcih0aHVuazIuc2V0dGxlZCwgc2V0dGxlZCk7CiAgfQogIGNvbnRleHQuZXhwb3NlQ2FzZVJlZHVjZXIocmVkdWNlck5hbWUsIHsKICAgIGZ1bGZpbGxlZDogZnVsZmlsbGVkIHx8IG5vb3AzLAogICAgcGVuZGluZzogcGVuZGluZyB8fCBub29wMywKICAgIHJlamVjdGVkOiByZWplY3RlZCB8fCBub29wMywKICAgIHNldHRsZWQ6IHNldHRsZWQgfHwgbm9vcDMKICB9KTsKfQpmdW5jdGlvbiBub29wMygpIHsKfQp2YXIgdGFzayA9ICJ0YXNrIjsKdmFyIGxpc3RlbmVyID0gImxpc3RlbmVyIjsKdmFyIGNvbXBsZXRlZCA9ICJjb21wbGV0ZWQiOwp2YXIgY2FuY2VsbGVkID0gImNhbmNlbGxlZCI7CnZhciB0YXNrQ2FuY2VsbGVkID0gYHRhc2stJHtjYW5jZWxsZWR9YDsKdmFyIHRhc2tDb21wbGV0ZWQgPSBgdGFzay0ke2NvbXBsZXRlZH1gOwp2YXIgbGlzdGVuZXJDYW5jZWxsZWQgPSBgJHtsaXN0ZW5lcn0tJHtjYW5jZWxsZWR9YDsKdmFyIGxpc3RlbmVyQ29tcGxldGVkID0gYCR7bGlzdGVuZXJ9LSR7Y29tcGxldGVkfWA7CnZhciBUYXNrQWJvcnRFcnJvciA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb2RlKSB7CiAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgdGhpcy5tZXNzYWdlID0gYCR7dGFza30gJHtjYW5jZWxsZWR9IChyZWFzb246ICR7Y29kZX0pYDsKICB9CiAgbmFtZSA9ICJUYXNrQWJvcnRFcnJvciI7CiAgbWVzc2FnZTsKfTsKdmFyIGFzc2VydEZ1bmN0aW9uID0gKGZ1bmMsIGV4cGVjdGVkKSA9PiB7CiAgaWYgKHR5cGVvZiBmdW5jICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzMikgOiBgJHtleHBlY3RlZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKICB9Cn07CnZhciBub29wMjIgPSAoKSA9PiB7Cn07CnZhciBjYXRjaFJlamVjdGlvbiA9IChwcm9taXNlLCBvbkVycm9yID0gbm9vcDIyKSA9PiB7CiAgcHJvbWlzZS5jYXRjaChvbkVycm9yKTsKICByZXR1cm4gcHJvbWlzZTsKfTsKdmFyIGFkZEFib3J0U2lnbmFsTGlzdGVuZXIgPSAoYWJvcnRTaWduYWwsIGNhbGxiYWNrKSA9PiB7CiAgYWJvcnRTaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBjYWxsYmFjaywgewogICAgb25jZTogdHJ1ZQogIH0pOwogIHJldHVybiAoKSA9PiBhYm9ydFNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCJhYm9ydCIsIGNhbGxiYWNrKTsKfTsKdmFyIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24gPSAoYWJvcnRDb250cm9sbGVyLCByZWFzb24pID0+IHsKICBjb25zdCBzaWduYWwgPSBhYm9ydENvbnRyb2xsZXIuc2lnbmFsOwogIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgcmV0dXJuOwogIH0KICBpZiAoISgicmVhc29uIiBpbiBzaWduYWwpKSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc2lnbmFsLCAicmVhc29uIiwgewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZTogcmVhc29uLAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICB9KTsKICB9CiAgOwogIGFib3J0Q29udHJvbGxlci5hYm9ydChyZWFzb24pOwp9Owp2YXIgdmFsaWRhdGVBY3RpdmUgPSAoc2lnbmFsKSA9PiB7CiAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICBjb25zdCB7CiAgICAgIHJlYXNvbgogICAgfSA9IHNpZ25hbDsKICAgIHRocm93IG5ldyBUYXNrQWJvcnRFcnJvcihyZWFzb24pOwogIH0KfTsKZnVuY3Rpb24gcmFjZVdpdGhTaWduYWwoc2lnbmFsLCBwcm9taXNlKSB7CiAgbGV0IGNsZWFudXAgPSBub29wMjI7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGNvbnN0IG5vdGlmeVJlamVjdGlvbiA9ICgpID0+IHJlamVjdChuZXcgVGFza0Fib3J0RXJyb3Ioc2lnbmFsLnJlYXNvbikpOwogICAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICAgIG5vdGlmeVJlamVjdGlvbigpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjbGVhbnVwID0gYWRkQWJvcnRTaWduYWxMaXN0ZW5lcihzaWduYWwsIG5vdGlmeVJlamVjdGlvbik7CiAgICBwcm9taXNlLmZpbmFsbHkoKCkgPT4gY2xlYW51cCgpKS50aGVuKHJlc29sdmUsIHJlamVjdCk7CiAgfSkuZmluYWxseSgoKSA9PiB7CiAgICBjbGVhbnVwID0gbm9vcDIyOwogIH0pOwp9CnZhciBydW5UYXNrID0gYXN5bmMgKHRhc2syLCBjbGVhblVwKSA9PiB7CiAgdHJ5IHsKICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpOwogICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0YXNrMigpOwogICAgcmV0dXJuIHsKICAgICAgc3RhdHVzOiAib2siLAogICAgICB2YWx1ZQogICAgfTsKICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIHsKICAgICAgc3RhdHVzOiBlcnJvciBpbnN0YW5jZW9mIFRhc2tBYm9ydEVycm9yID8gImNhbmNlbGxlZCIgOiAicmVqZWN0ZWQiLAogICAgICBlcnJvcgogICAgfTsKICB9IGZpbmFsbHkgewogICAgY2xlYW5VcD8uKCk7CiAgfQp9Owp2YXIgY3JlYXRlUGF1c2UgPSAoc2lnbmFsKSA9PiB7CiAgcmV0dXJuIChwcm9taXNlKSA9PiB7CiAgICByZXR1cm4gY2F0Y2hSZWplY3Rpb24ocmFjZVdpdGhTaWduYWwoc2lnbmFsLCBwcm9taXNlKS50aGVuKChvdXRwdXQpID0+IHsKICAgICAgdmFsaWRhdGVBY3RpdmUoc2lnbmFsKTsKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0pKTsKICB9Owp9Owp2YXIgY3JlYXRlRGVsYXkgPSAoc2lnbmFsKSA9PiB7CiAgY29uc3QgcGF1c2UgPSBjcmVhdGVQYXVzZShzaWduYWwpOwogIHJldHVybiAodGltZW91dE1zKSA9PiB7CiAgICByZXR1cm4gcGF1c2UobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGltZW91dE1zKSkpOwogIH07Cn07CnZhciB7CiAgYXNzaWduCn0gPSBPYmplY3Q7CnZhciBJTlRFUk5BTF9OSUxfVE9LRU4gPSB7fTsKdmFyIGFsbSA9ICJsaXN0ZW5lck1pZGRsZXdhcmUiOwp2YXIgY3JlYXRlRm9yayA9IChwYXJlbnRBYm9ydFNpZ25hbCwgcGFyZW50QmxvY2tpbmdQcm9taXNlcykgPT4gewogIGNvbnN0IGxpbmtDb250cm9sbGVycyA9IChjb250cm9sbGVyKSA9PiBhZGRBYm9ydFNpZ25hbExpc3RlbmVyKHBhcmVudEFib3J0U2lnbmFsLCAoKSA9PiBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNvbnRyb2xsZXIsIHBhcmVudEFib3J0U2lnbmFsLnJlYXNvbikpOwogIHJldHVybiAodGFza0V4ZWN1dG9yLCBvcHRzKSA9PiB7CiAgICBhc3NlcnRGdW5jdGlvbih0YXNrRXhlY3V0b3IsICJ0YXNrRXhlY3V0b3IiKTsKICAgIGNvbnN0IGNoaWxkQWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgbGlua0NvbnRyb2xsZXJzKGNoaWxkQWJvcnRDb250cm9sbGVyKTsKICAgIGNvbnN0IHJlc3VsdCA9IHJ1blRhc2soYXN5bmMgKCkgPT4gewogICAgICB2YWxpZGF0ZUFjdGl2ZShwYXJlbnRBYm9ydFNpZ25hbCk7CiAgICAgIHZhbGlkYXRlQWN0aXZlKGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbCk7CiAgICAgIGNvbnN0IHJlc3VsdDIgPSBhd2FpdCB0YXNrRXhlY3V0b3IoewogICAgICAgIHBhdXNlOiBjcmVhdGVQYXVzZShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpLAogICAgICAgIGRlbGF5OiBjcmVhdGVEZWxheShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpLAogICAgICAgIHNpZ25hbDogY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsCiAgICAgIH0pOwogICAgICB2YWxpZGF0ZUFjdGl2ZShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpOwogICAgICByZXR1cm4gcmVzdWx0MjsKICAgIH0sICgpID0+IGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY2hpbGRBYm9ydENvbnRyb2xsZXIsIHRhc2tDb21wbGV0ZWQpKTsKICAgIGlmIChvcHRzPy5hdXRvSm9pbikgewogICAgICBwYXJlbnRCbG9ja2luZ1Byb21pc2VzLnB1c2gocmVzdWx0LmNhdGNoKG5vb3AyMikpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcmVzdWx0OiBjcmVhdGVQYXVzZShwYXJlbnRBYm9ydFNpZ25hbCkocmVzdWx0KSwKICAgICAgY2FuY2VsKCkgewogICAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY2hpbGRBYm9ydENvbnRyb2xsZXIsIHRhc2tDYW5jZWxsZWQpOwogICAgICB9CiAgICB9OwogIH07Cn07CnZhciBjcmVhdGVUYWtlUGF0dGVybiA9IChzdGFydExpc3RlbmluZywgc2lnbmFsKSA9PiB7CiAgY29uc3QgdGFrZSA9IGFzeW5jIChwcmVkaWNhdGUsIHRpbWVvdXQpID0+IHsKICAgIHZhbGlkYXRlQWN0aXZlKHNpZ25hbCk7CiAgICBsZXQgdW5zdWJzY3JpYmUgPSAoKSA9PiB7CiAgICB9OwogICAgY29uc3QgdHVwbGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBsZXQgc3RvcExpc3RlbmluZyA9IHN0YXJ0TGlzdGVuaW5nKHsKICAgICAgICBwcmVkaWNhdGUsCiAgICAgICAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgICAgICAgbGlzdGVuZXJBcGkudW5zdWJzY3JpYmUoKTsKICAgICAgICAgIHJlc29sdmUoW2FjdGlvbiwgbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKSwgbGlzdGVuZXJBcGkuZ2V0T3JpZ2luYWxTdGF0ZSgpXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdW5zdWJzY3JpYmUgPSAoKSA9PiB7CiAgICAgICAgc3RvcExpc3RlbmluZygpOwogICAgICAgIHJlamVjdCgpOwogICAgICB9OwogICAgfSk7CiAgICBjb25zdCBwcm9taXNlcyA9IFt0dXBsZVByb21pc2VdOwogICAgaWYgKHRpbWVvdXQgIT0gbnVsbCkgewogICAgICBwcm9taXNlcy5wdXNoKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQsIG51bGwpKSk7CiAgICB9CiAgICB0cnkgewogICAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCByYWNlV2l0aFNpZ25hbChzaWduYWwsIFByb21pc2UucmFjZShwcm9taXNlcykpOwogICAgICB2YWxpZGF0ZUFjdGl2ZShzaWduYWwpOwogICAgICByZXR1cm4gb3V0cHV0OwogICAgfSBmaW5hbGx5IHsKICAgICAgdW5zdWJzY3JpYmUoKTsKICAgIH0KICB9OwogIHJldHVybiAocHJlZGljYXRlLCB0aW1lb3V0KSA9PiBjYXRjaFJlamVjdGlvbih0YWtlKHByZWRpY2F0ZSwgdGltZW91dCkpOwp9Owp2YXIgZ2V0TGlzdGVuZXJFbnRyeVByb3BzRnJvbSA9IChvcHRpb25zKSA9PiB7CiAgbGV0IHsKICAgIHR5cGUsCiAgICBhY3Rpb25DcmVhdG9yLAogICAgbWF0Y2hlciwKICAgIHByZWRpY2F0ZSwKICAgIGVmZmVjdAogIH0gPSBvcHRpb25zOwogIGlmICh0eXBlKSB7CiAgICBwcmVkaWNhdGUgPSBjcmVhdGVBY3Rpb24odHlwZSkubWF0Y2g7CiAgfSBlbHNlIGlmIChhY3Rpb25DcmVhdG9yKSB7CiAgICB0eXBlID0gYWN0aW9uQ3JlYXRvci50eXBlOwogICAgcHJlZGljYXRlID0gYWN0aW9uQ3JlYXRvci5tYXRjaDsKICB9IGVsc2UgaWYgKG1hdGNoZXIpIHsKICAgIHByZWRpY2F0ZSA9IG1hdGNoZXI7CiAgfSBlbHNlIGlmIChwcmVkaWNhdGUpIHsKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMSkgOiAiQ3JlYXRpbmcgb3IgcmVtb3ZpbmcgYSBsaXN0ZW5lciByZXF1aXJlcyBvbmUgb2YgdGhlIGtub3duIGZpZWxkcyBmb3IgbWF0Y2hpbmcgYW4gYWN0aW9uIik7CiAgfQogIGFzc2VydEZ1bmN0aW9uKGVmZmVjdCwgIm9wdGlvbnMubGlzdGVuZXIiKTsKICByZXR1cm4gewogICAgcHJlZGljYXRlLAogICAgdHlwZSwKICAgIGVmZmVjdAogIH07Cn07CnZhciBjcmVhdGVMaXN0ZW5lckVudHJ5ID0gLyogQF9fUFVSRV9fICovIGFzc2lnbigob3B0aW9ucykgPT4gewogIGNvbnN0IHsKICAgIHR5cGUsCiAgICBwcmVkaWNhdGUsCiAgICBlZmZlY3QKICB9ID0gZ2V0TGlzdGVuZXJFbnRyeVByb3BzRnJvbShvcHRpb25zKTsKICBjb25zdCBlbnRyeSA9IHsKICAgIGlkOiBuYW5vaWQoKSwKICAgIGVmZmVjdCwKICAgIHR5cGUsCiAgICBwcmVkaWNhdGUsCiAgICBwZW5kaW5nOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLAogICAgdW5zdWJzY3JpYmU6ICgpID0+IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMikgOiAiVW5zdWJzY3JpYmUgbm90IGluaXRpYWxpemVkIik7CiAgICB9CiAgfTsKICByZXR1cm4gZW50cnk7Cn0sIHsKICB3aXRoVHlwZXM6ICgpID0+IGNyZWF0ZUxpc3RlbmVyRW50cnkKfSk7CnZhciBmaW5kTGlzdGVuZXJFbnRyeSA9IChsaXN0ZW5lck1hcCwgb3B0aW9ucykgPT4gewogIGNvbnN0IHsKICAgIHR5cGUsCiAgICBlZmZlY3QsCiAgICBwcmVkaWNhdGUKICB9ID0gZ2V0TGlzdGVuZXJFbnRyeVByb3BzRnJvbShvcHRpb25zKTsKICByZXR1cm4gQXJyYXkuZnJvbShsaXN0ZW5lck1hcC52YWx1ZXMoKSkuZmluZCgoZW50cnkpID0+IHsKICAgIGNvbnN0IG1hdGNoUHJlZGljYXRlT3JUeXBlID0gdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciID8gZW50cnkudHlwZSA9PT0gdHlwZSA6IGVudHJ5LnByZWRpY2F0ZSA9PT0gcHJlZGljYXRlOwogICAgcmV0dXJuIG1hdGNoUHJlZGljYXRlT3JUeXBlICYmIGVudHJ5LmVmZmVjdCA9PT0gZWZmZWN0OwogIH0pOwp9Owp2YXIgY2FuY2VsQWN0aXZlTGlzdGVuZXJzID0gKGVudHJ5KSA9PiB7CiAgZW50cnkucGVuZGluZy5mb3JFYWNoKChjb250cm9sbGVyKSA9PiB7CiAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNvbnRyb2xsZXIsIGxpc3RlbmVyQ2FuY2VsbGVkKTsKICB9KTsKfTsKdmFyIGNyZWF0ZUNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlID0gKGxpc3RlbmVyTWFwLCBleGVjdXRpbmdMaXN0ZW5lcnMpID0+IHsKICByZXR1cm4gKCkgPT4gewogICAgZm9yIChjb25zdCBsaXN0ZW5lcjIgb2YgZXhlY3V0aW5nTGlzdGVuZXJzLmtleXMoKSkgewogICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMobGlzdGVuZXIyKTsKICAgIH0KICAgIGxpc3RlbmVyTWFwLmNsZWFyKCk7CiAgfTsKfTsKdmFyIHNhZmVseU5vdGlmeUVycm9yID0gKGVycm9ySGFuZGxlciwgZXJyb3JUb05vdGlmeSwgZXJyb3JJbmZvKSA9PiB7CiAgdHJ5IHsKICAgIGVycm9ySGFuZGxlcihlcnJvclRvTm90aWZ5LCBlcnJvckluZm8pOwogIH0gY2F0Y2ggKGVycm9ySGFuZGxlckVycm9yKSB7CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdGhyb3cgZXJyb3JIYW5kbGVyRXJyb3I7CiAgICB9LCAwKTsKICB9Cn07CnZhciBhZGRMaXN0ZW5lciA9IC8qIEBfX1BVUkVfXyAqLyBhc3NpZ24oLyogQF9fUFVSRV9fICovIGNyZWF0ZUFjdGlvbihgJHthbG19L2FkZGApLCB7CiAgd2l0aFR5cGVzOiAoKSA9PiBhZGRMaXN0ZW5lcgp9KTsKdmFyIGNsZWFyQWxsTGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIGNyZWF0ZUFjdGlvbihgJHthbG19L3JlbW92ZUFsbGApOwp2YXIgcmVtb3ZlTGlzdGVuZXIgPSAvKiBAX19QVVJFX18gKi8gYXNzaWduKC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBY3Rpb24oYCR7YWxtfS9yZW1vdmVgKSwgewogIHdpdGhUeXBlczogKCkgPT4gcmVtb3ZlTGlzdGVuZXIKfSk7CnZhciBkZWZhdWx0RXJyb3JIYW5kbGVyID0gKC4uLmFyZ3MpID0+IHsKICBjb25zb2xlLmVycm9yKGAke2FsbX0vZXJyb3JgLCAuLi5hcmdzKTsKfTsKdmFyIGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSA9IChtaWRkbGV3YXJlT3B0aW9ucyA9IHt9KSA9PiB7CiAgY29uc3QgbGlzdGVuZXJNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IGV4ZWN1dGluZ0xpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgdHJhY2tFeGVjdXRpbmdMaXN0ZW5lciA9IChlbnRyeSkgPT4gewogICAgY29uc3QgY291bnQgPSBleGVjdXRpbmdMaXN0ZW5lcnMuZ2V0KGVudHJ5KSA/PyAwOwogICAgZXhlY3V0aW5nTGlzdGVuZXJzLnNldChlbnRyeSwgY291bnQgKyAxKTsKICB9OwogIGNvbnN0IHVudHJhY2tFeGVjdXRpbmdMaXN0ZW5lciA9IChlbnRyeSkgPT4gewogICAgY29uc3QgY291bnQgPSBleGVjdXRpbmdMaXN0ZW5lcnMuZ2V0KGVudHJ5KSA/PyAxOwogICAgaWYgKGNvdW50ID09PSAxKSB7CiAgICAgIGV4ZWN1dGluZ0xpc3RlbmVycy5kZWxldGUoZW50cnkpOwogICAgfSBlbHNlIHsKICAgICAgZXhlY3V0aW5nTGlzdGVuZXJzLnNldChlbnRyeSwgY291bnQgLSAxKTsKICAgIH0KICB9OwogIGNvbnN0IHsKICAgIGV4dHJhLAogICAgb25FcnJvciA9IGRlZmF1bHRFcnJvckhhbmRsZXIKICB9ID0gbWlkZGxld2FyZU9wdGlvbnM7CiAgYXNzZXJ0RnVuY3Rpb24ob25FcnJvciwgIm9uRXJyb3IiKTsKICBjb25zdCBpbnNlcnRFbnRyeSA9IChlbnRyeSkgPT4gewogICAgZW50cnkudW5zdWJzY3JpYmUgPSAoKSA9PiBsaXN0ZW5lck1hcC5kZWxldGUoZW50cnkuaWQpOwogICAgbGlzdGVuZXJNYXAuc2V0KGVudHJ5LmlkLCBlbnRyeSk7CiAgICByZXR1cm4gKGNhbmNlbE9wdGlvbnMpID0+IHsKICAgICAgZW50cnkudW5zdWJzY3JpYmUoKTsKICAgICAgaWYgKGNhbmNlbE9wdGlvbnM/LmNhbmNlbEFjdGl2ZSkgewogICAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyhlbnRyeSk7CiAgICAgIH0KICAgIH07CiAgfTsKICBjb25zdCBzdGFydExpc3RlbmluZyA9IChvcHRpb25zKSA9PiB7CiAgICBjb25zdCBlbnRyeSA9IGZpbmRMaXN0ZW5lckVudHJ5KGxpc3RlbmVyTWFwLCBvcHRpb25zKSA/PyBjcmVhdGVMaXN0ZW5lckVudHJ5KG9wdGlvbnMpOwogICAgcmV0dXJuIGluc2VydEVudHJ5KGVudHJ5KTsKICB9OwogIGFzc2lnbihzdGFydExpc3RlbmluZywgewogICAgd2l0aFR5cGVzOiAoKSA9PiBzdGFydExpc3RlbmluZwogIH0pOwogIGNvbnN0IHN0b3BMaXN0ZW5pbmcgPSAob3B0aW9ucykgPT4gewogICAgY29uc3QgZW50cnkgPSBmaW5kTGlzdGVuZXJFbnRyeShsaXN0ZW5lck1hcCwgb3B0aW9ucyk7CiAgICBpZiAoZW50cnkpIHsKICAgICAgZW50cnkudW5zdWJzY3JpYmUoKTsKICAgICAgaWYgKG9wdGlvbnMuY2FuY2VsQWN0aXZlKSB7CiAgICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzKGVudHJ5KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuICEhZW50cnk7CiAgfTsKICBhc3NpZ24oc3RvcExpc3RlbmluZywgewogICAgd2l0aFR5cGVzOiAoKSA9PiBzdG9wTGlzdGVuaW5nCiAgfSk7CiAgY29uc3Qgbm90aWZ5TGlzdGVuZXIgPSBhc3luYyAoZW50cnksIGFjdGlvbiwgYXBpLCBnZXRPcmlnaW5hbFN0YXRlKSA9PiB7CiAgICBjb25zdCBpbnRlcm5hbFRhc2tDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3QgdGFrZSA9IGNyZWF0ZVRha2VQYXR0ZXJuKHN0YXJ0TGlzdGVuaW5nLCBpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCk7CiAgICBjb25zdCBhdXRvSm9pblByb21pc2VzID0gW107CiAgICB0cnkgewogICAgICBlbnRyeS5wZW5kaW5nLmFkZChpbnRlcm5hbFRhc2tDb250cm9sbGVyKTsKICAgICAgdHJhY2tFeGVjdXRpbmdMaXN0ZW5lcihlbnRyeSk7CiAgICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZShlbnRyeS5lZmZlY3QoCiAgICAgICAgYWN0aW9uLAogICAgICAgIC8vIFVzZSBhc3NpZ24oKSByYXRoZXIgdGhhbiAuLi4gdG8gYXZvaWQgZXh0cmEgaGVscGVyIGZ1bmN0aW9ucyBhZGRlZCB0byBidW5kbGUKICAgICAgICBhc3NpZ24oe30sIGFwaSwgewogICAgICAgICAgZ2V0T3JpZ2luYWxTdGF0ZSwKICAgICAgICAgIGNvbmRpdGlvbjogKHByZWRpY2F0ZSwgdGltZW91dCkgPT4gdGFrZShwcmVkaWNhdGUsIHRpbWVvdXQpLnRoZW4oQm9vbGVhbiksCiAgICAgICAgICB0YWtlLAogICAgICAgICAgZGVsYXk6IGNyZWF0ZURlbGF5KGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICAgIHBhdXNlOiBjcmVhdGVQYXVzZShpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgICBleHRyYSwKICAgICAgICAgIHNpZ25hbDogaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwsCiAgICAgICAgICBmb3JrOiBjcmVhdGVGb3JrKGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsLCBhdXRvSm9pblByb21pc2VzKSwKICAgICAgICAgIHVuc3Vic2NyaWJlOiBlbnRyeS51bnN1YnNjcmliZSwKICAgICAgICAgIHN1YnNjcmliZTogKCkgPT4gewogICAgICAgICAgICBsaXN0ZW5lck1hcC5zZXQoZW50cnkuaWQsIGVudHJ5KTsKICAgICAgICAgIH0sCiAgICAgICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnM6ICgpID0+IHsKICAgICAgICAgICAgZW50cnkucGVuZGluZy5mb3JFYWNoKChjb250cm9sbGVyLCBfLCBzZXQzKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGNvbnRyb2xsZXIgIT09IGludGVybmFsVGFza0NvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY29udHJvbGxlciwgbGlzdGVuZXJDYW5jZWxsZWQpOwogICAgICAgICAgICAgICAgc2V0My5kZWxldGUoY29udHJvbGxlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBjYW5jZWw6ICgpID0+IHsKICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihpbnRlcm5hbFRhc2tDb250cm9sbGVyLCBsaXN0ZW5lckNhbmNlbGxlZCk7CiAgICAgICAgICAgIGVudHJ5LnBlbmRpbmcuZGVsZXRlKGludGVybmFsVGFza0NvbnRyb2xsZXIpOwogICAgICAgICAgfSwKICAgICAgICAgIHRocm93SWZDYW5jZWxsZWQ6ICgpID0+IHsKICAgICAgICAgICAgdmFsaWRhdGVBY3RpdmUoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICkpOwogICAgfSBjYXRjaCAobGlzdGVuZXJFcnJvcikgewogICAgICBpZiAoIShsaXN0ZW5lckVycm9yIGluc3RhbmNlb2YgVGFza0Fib3J0RXJyb3IpKSB7CiAgICAgICAgc2FmZWx5Tm90aWZ5RXJyb3Iob25FcnJvciwgbGlzdGVuZXJFcnJvciwgewogICAgICAgICAgcmFpc2VkQnk6ICJlZmZlY3QiCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKGF1dG9Kb2luUHJvbWlzZXMpOwogICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGludGVybmFsVGFza0NvbnRyb2xsZXIsIGxpc3RlbmVyQ29tcGxldGVkKTsKICAgICAgdW50cmFja0V4ZWN1dGluZ0xpc3RlbmVyKGVudHJ5KTsKICAgICAgZW50cnkucGVuZGluZy5kZWxldGUoaW50ZXJuYWxUYXNrQ29udHJvbGxlcik7CiAgICB9CiAgfTsKICBjb25zdCBjbGVhckxpc3RlbmVyTWlkZGxld2FyZSA9IGNyZWF0ZUNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlKGxpc3RlbmVyTWFwLCBleGVjdXRpbmdMaXN0ZW5lcnMpOwogIGNvbnN0IG1pZGRsZXdhcmUgPSAoYXBpKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgaWYgKCFpc0FjdGlvbihhY3Rpb24pKSB7CiAgICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgICB9CiAgICBpZiAoYWRkTGlzdGVuZXIubWF0Y2goYWN0aW9uKSkgewogICAgICByZXR1cm4gc3RhcnRMaXN0ZW5pbmcoYWN0aW9uLnBheWxvYWQpOwogICAgfQogICAgaWYgKGNsZWFyQWxsTGlzdGVuZXJzLm1hdGNoKGFjdGlvbikpIHsKICAgICAgY2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHJlbW92ZUxpc3RlbmVyLm1hdGNoKGFjdGlvbikpIHsKICAgICAgcmV0dXJuIHN0b3BMaXN0ZW5pbmcoYWN0aW9uLnBheWxvYWQpOwogICAgfQogICAgbGV0IG9yaWdpbmFsU3RhdGUgPSBhcGkuZ2V0U3RhdGUoKTsKICAgIGNvbnN0IGdldE9yaWdpbmFsU3RhdGUgPSAoKSA9PiB7CiAgICAgIGlmIChvcmlnaW5hbFN0YXRlID09PSBJTlRFUk5BTF9OSUxfVE9LRU4pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIzKSA6IGAke2FsbX06IGdldE9yaWdpbmFsU3RhdGUgY2FuIG9ubHkgYmUgY2FsbGVkIHN5bmNocm9ub3VzbHlgKTsKICAgICAgfQogICAgICByZXR1cm4gb3JpZ2luYWxTdGF0ZTsKICAgIH07CiAgICBsZXQgcmVzdWx0OwogICAgdHJ5IHsKICAgICAgcmVzdWx0ID0gbmV4dChhY3Rpb24pOwogICAgICBpZiAobGlzdGVuZXJNYXAuc2l6ZSA+IDApIHsKICAgICAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBhcGkuZ2V0U3RhdGUoKTsKICAgICAgICBjb25zdCBsaXN0ZW5lckVudHJpZXMgPSBBcnJheS5mcm9tKGxpc3RlbmVyTWFwLnZhbHVlcygpKTsKICAgICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGxpc3RlbmVyRW50cmllcykgewogICAgICAgICAgbGV0IHJ1bkxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBydW5MaXN0ZW5lciA9IGVudHJ5LnByZWRpY2F0ZShhY3Rpb24sIGN1cnJlbnRTdGF0ZSwgb3JpZ2luYWxTdGF0ZSk7CiAgICAgICAgICB9IGNhdGNoIChwcmVkaWNhdGVFcnJvcikgewogICAgICAgICAgICBydW5MaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgICBzYWZlbHlOb3RpZnlFcnJvcihvbkVycm9yLCBwcmVkaWNhdGVFcnJvciwgewogICAgICAgICAgICAgIHJhaXNlZEJ5OiAicHJlZGljYXRlIgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcnVuTGlzdGVuZXIpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBub3RpZnlMaXN0ZW5lcihlbnRyeSwgYWN0aW9uLCBhcGksIGdldE9yaWdpbmFsU3RhdGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgb3JpZ2luYWxTdGF0ZSA9IElOVEVSTkFMX05JTF9UT0tFTjsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICByZXR1cm4gewogICAgbWlkZGxld2FyZSwKICAgIHN0YXJ0TGlzdGVuaW5nLAogICAgc3RvcExpc3RlbmluZywKICAgIGNsZWFyTGlzdGVuZXJzOiBjbGVhckxpc3RlbmVyTWlkZGxld2FyZQogIH07Cn07CnZhciBPUklHSU5BTF9TVEFURSA9IFN5bWJvbC5mb3IoInJ0ay1zdGF0ZS1wcm94eS1vcmlnaW5hbCIpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9sYXlvdXRTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlID0gewogIGxheW91dFR5cGU6ICJob3Jpem9udGFsIiwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgbWFyZ2luOiB7CiAgICB0b3A6IDUsCiAgICByaWdodDogNSwKICAgIGJvdHRvbTogNSwKICAgIGxlZnQ6IDUKICB9LAogIHNjYWxlOiAxCn07CnZhciBjaGFydExheW91dFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJjaGFydExheW91dCIsCiAgaW5pdGlhbFN0YXRlLAogIHJlZHVjZXJzOiB7CiAgICBzZXRMYXlvdXQoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5sYXlvdXRUeXBlID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0Q2hhcnRTaXplKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUud2lkdGggPSBhY3Rpb24ucGF5bG9hZC53aWR0aDsKICAgICAgc3RhdGUuaGVpZ2h0ID0gYWN0aW9uLnBheWxvYWQuaGVpZ2h0OwogICAgfSwKICAgIHNldE1hcmdpbihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkdG9wLCBfYWN0aW9uJHBheWxvYWQkcmlnaHQsIF9hY3Rpb24kcGF5bG9hZCRib3R0bywgX2FjdGlvbiRwYXlsb2FkJGxlZnQ7CiAgICAgIHN0YXRlLm1hcmdpbi50b3AgPSAoX2FjdGlvbiRwYXlsb2FkJHRvcCA9IGFjdGlvbi5wYXlsb2FkLnRvcCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJHRvcCAhPT0gdm9pZCAwID8gX2FjdGlvbiRwYXlsb2FkJHRvcCA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5yaWdodCA9IChfYWN0aW9uJHBheWxvYWQkcmlnaHQgPSBhY3Rpb24ucGF5bG9hZC5yaWdodCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJHJpZ2h0ICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkcmlnaHQgOiAwOwogICAgICBzdGF0ZS5tYXJnaW4uYm90dG9tID0gKF9hY3Rpb24kcGF5bG9hZCRib3R0byA9IGFjdGlvbi5wYXlsb2FkLmJvdHRvbSkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGJvdHRvICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkYm90dG8gOiAwOwogICAgICBzdGF0ZS5tYXJnaW4ubGVmdCA9IChfYWN0aW9uJHBheWxvYWQkbGVmdCA9IGFjdGlvbi5wYXlsb2FkLmxlZnQpICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCRsZWZ0ICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkbGVmdCA6IDA7CiAgICB9LAogICAgc2V0U2NhbGUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zY2FsZSA9IGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0TWFyZ2luLAogIHNldExheW91dCwKICBzZXRDaGFydFNpemUsCiAgc2V0U2NhbGUKfSA9IGNoYXJ0TGF5b3V0U2xpY2UuYWN0aW9uczsKdmFyIGNoYXJ0TGF5b3V0UmVkdWNlciA9IGNoYXJ0TGF5b3V0U2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9DaGFydFV0aWxzLmpzCnZhciBpbXBvcnRfc29ydEJ5MiA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwp2YXIgaW1wb3J0X2dldDIgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRTbGljZWQuanMKZnVuY3Rpb24gZ2V0U2xpY2VkKGFyciwgc3RhcnRJbmRleCwgZW5kSW5kZXgpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgcmV0dXJuIGFycjsKICB9CiAgaWYgKGFyciAmJiBzdGFydEluZGV4ICsgZW5kSW5kZXggIT09IDApIHsKICAgIHJldHVybiBhcnIuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXggKyAxKTsKICB9CiAgcmV0dXJuIGFycjsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NoYXJ0VXRpbHMuanMKZnVuY3Rpb24gb3duS2V5czIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZ2V0VmFsdWVCeURhdGFLZXkob2JqLCBkYXRhS2V5LCBkZWZhdWx0VmFsdWUpIHsKICBpZiAoaXNOdWxsaXNoKG9iaikgfHwgaXNOdWxsaXNoKGRhdGFLZXkpKSB7CiAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogIH0KICBpZiAoaXNOdW1PclN0cihkYXRhS2V5KSkgewogICAgcmV0dXJuICgwLCBpbXBvcnRfZ2V0Mi5kZWZhdWx0KShvYmosIGRhdGFLZXksIGRlZmF1bHRWYWx1ZSk7CiAgfQogIGlmICh0eXBlb2YgZGF0YUtleSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGRhdGFLZXkob2JqKTsKICB9CiAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKfQp2YXIgYXBwZW5kT2Zmc2V0T2ZMZWdlbmQgPSAob2Zmc2V0LCBsZWdlbmRTZXR0aW5ncywgbGVnZW5kU2l6ZSkgPT4gewogIGlmIChsZWdlbmRTZXR0aW5ncyAmJiBsZWdlbmRTaXplKSB7CiAgICB2YXIgewogICAgICB3aWR0aDogYm94V2lkdGgsCiAgICAgIGhlaWdodDogYm94SGVpZ2h0CiAgICB9ID0gbGVnZW5kU2l6ZTsKICAgIHZhciB7CiAgICAgIGFsaWduLAogICAgICB2ZXJ0aWNhbEFsaWduLAogICAgICBsYXlvdXQKICAgIH0gPSBsZWdlbmRTZXR0aW5nczsKICAgIGlmICgobGF5b3V0ID09PSAidmVydGljYWwiIHx8IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIHZlcnRpY2FsQWxpZ24gPT09ICJtaWRkbGUiKSAmJiBhbGlnbiAhPT0gImNlbnRlciIgJiYgaXNOdW1iZXIob2Zmc2V0W2FsaWduXSkpIHsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyKF9vYmplY3RTcHJlYWQyKHt9LCBvZmZzZXQpLCB7fSwgewogICAgICAgIFthbGlnbl06IG9mZnNldFthbGlnbl0gKyAoYm94V2lkdGggfHwgMCkKICAgICAgfSk7CiAgICB9CiAgICBpZiAoKGxheW91dCA9PT0gImhvcml6b250YWwiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBhbGlnbiA9PT0gImNlbnRlciIpICYmIHZlcnRpY2FsQWxpZ24gIT09ICJtaWRkbGUiICYmIGlzTnVtYmVyKG9mZnNldFt2ZXJ0aWNhbEFsaWduXSkpIHsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyKF9vYmplY3RTcHJlYWQyKHt9LCBvZmZzZXQpLCB7fSwgewogICAgICAgIFt2ZXJ0aWNhbEFsaWduXTogb2Zmc2V0W3ZlcnRpY2FsQWxpZ25dICsgKGJveEhlaWdodCB8fCAwKQogICAgICB9KTsKICAgIH0KICB9CiAgcmV0dXJuIG9mZnNldDsKfTsKdmFyIGlzQ2F0ZWdvcmljYWxBeGlzID0gKGxheW91dCwgYXhpc1R5cGUpID0+IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIGF4aXNUeXBlID09PSAieEF4aXMiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBheGlzVHlwZSA9PT0gInlBeGlzIiB8fCBsYXlvdXQgPT09ICJjZW50cmljIiAmJiBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgfHwgbGF5b3V0ID09PSAicmFkaWFsIiAmJiBheGlzVHlwZSA9PT0gInJhZGl1c0F4aXMiOwp2YXIgZ2V0Q29vcmRpbmF0ZXNPZkdyaWQgPSAodGlja3MyLCBtaW5WYWx1ZSwgbWF4VmFsdWUsIHN5bmNXaXRoVGlja3MpID0+IHsKICBpZiAoc3luY1dpdGhUaWNrcykgewogICAgcmV0dXJuIHRpY2tzMi5tYXAoKGVudHJ5KSA9PiBlbnRyeS5jb29yZGluYXRlKTsKICB9CiAgdmFyIGhhc01pbiwgaGFzTWF4OwogIHZhciB2YWx1ZXMgPSB0aWNrczIubWFwKChlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5LmNvb3JkaW5hdGUgPT09IG1pblZhbHVlKSB7CiAgICAgIGhhc01pbiA9IHRydWU7CiAgICB9CiAgICBpZiAoZW50cnkuY29vcmRpbmF0ZSA9PT0gbWF4VmFsdWUpIHsKICAgICAgaGFzTWF4ID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBlbnRyeS5jb29yZGluYXRlOwogIH0pOwogIGlmICghaGFzTWluKSB7CiAgICB2YWx1ZXMucHVzaChtaW5WYWx1ZSk7CiAgfQogIGlmICghaGFzTWF4KSB7CiAgICB2YWx1ZXMucHVzaChtYXhWYWx1ZSk7CiAgfQogIHJldHVybiB2YWx1ZXM7Cn07CnZhciBnZXRUaWNrc09mQXhpcyA9IChheGlzLCBpc0dyaWQsIGlzQWxsKSA9PiB7CiAgaWYgKCFheGlzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGR1cGxpY2F0ZURvbWFpbiwKICAgIHR5cGUsCiAgICByYW5nZTogcmFuZ2U0LAogICAgc2NhbGUsCiAgICByZWFsU2NhbGVUeXBlLAogICAgaXNDYXRlZ29yaWNhbCwKICAgIGNhdGVnb3JpY2FsRG9tYWluLAogICAgdGlja0NvdW50LAogICAgdGlja3M6IHRpY2tzMiwKICAgIG5pY2VUaWNrcywKICAgIGF4aXNUeXBlCiAgfSA9IGF4aXM7CiAgaWYgKCFzY2FsZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyAyIDogMjsKICB2YXIgb2Zmc2V0ID0gKGlzR3JpZCB8fCBpc0FsbCkgJiYgdHlwZSA9PT0gImNhdGVnb3J5IiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIG9mZnNldEZvckJhbmQgOiAwOwogIG9mZnNldCA9IGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgJiYgcmFuZ2U0Lmxlbmd0aCA+PSAyID8gbWF0aFNpZ24ocmFuZ2U0WzBdIC0gcmFuZ2U0WzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzR3JpZCAmJiAodGlja3MyIHx8IG5pY2VUaWNrcykpIHsKICAgIHZhciByZXN1bHQgPSAodGlja3MyIHx8IG5pY2VUaWNrcyB8fCBbXSkubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgdmFyIHNjYWxlQ29udGVudCA9IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbi5pbmRleE9mKGVudHJ5KSA6IGVudHJ5OwogICAgICByZXR1cm4gewogICAgICAgIC8vIElmIHRoZSBzY2FsZUNvbnRlbnQgaXMgbm90IGEgbnVtYmVyLCB0aGUgY29vcmRpbmF0ZSB3aWxsIGJlIE5hTi4KICAgICAgICAvLyBUaGF0IGNvdWxkIGJlIHRoZSBjYXNlIGZvciBleGFtcGxlIHdpdGggYSBQb2ludFNjYWxlIGFuZCBhIHN0cmluZyBhcyBkb21haW4uCiAgICAgICAgY29vcmRpbmF0ZTogc2NhbGUoc2NhbGVDb250ZW50KSArIG9mZnNldCwKICAgICAgICB2YWx1ZTogZW50cnksCiAgICAgICAgb2Zmc2V0LAogICAgICAgIGluZGV4CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQuZmlsdGVyKChyb3cpID0+ICFpc05hbihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICBpZiAoc2NhbGUudGlja3MgJiYgIWlzQWxsICYmIHRpY2tDb3VudCAhPSBudWxsKSB7CiAgICByZXR1cm4gc2NhbGUudGlja3ModGlja0NvdW50KS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldCwKICAgICAgaW5kZXgKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgRVBTMiA9IDFlLTQ7CnZhciBjaGVja0RvbWFpbk9mU2NhbGUgPSAoc2NhbGUpID0+IHsKICB2YXIgZG9tYWluID0gc2NhbGUuZG9tYWluKCk7CiAgaWYgKCFkb21haW4gfHwgZG9tYWluLmxlbmd0aCA8PSAyKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBsZW4gPSBkb21haW4ubGVuZ3RoOwogIHZhciByYW5nZTQgPSBzY2FsZS5yYW5nZSgpOwogIHZhciBtaW5WYWx1ZSA9IE1hdGgubWluKHJhbmdlNFswXSwgcmFuZ2U0WzFdKSAtIEVQUzI7CiAgdmFyIG1heFZhbHVlID0gTWF0aC5tYXgocmFuZ2U0WzBdLCByYW5nZTRbMV0pICsgRVBTMjsKICB2YXIgZmlyc3QgPSBzY2FsZShkb21haW5bMF0pOwogIHZhciBsYXN0MiA9IHNjYWxlKGRvbWFpbltsZW4gLSAxXSk7CiAgaWYgKGZpcnN0IDwgbWluVmFsdWUgfHwgZmlyc3QgPiBtYXhWYWx1ZSB8fCBsYXN0MiA8IG1pblZhbHVlIHx8IGxhc3QyID4gbWF4VmFsdWUpIHsKICAgIHNjYWxlLmRvbWFpbihbZG9tYWluWzBdLCBkb21haW5bbGVuIC0gMV1dKTsKICB9Cn07CnZhciBvZmZzZXRTaWduID0gKHNlcmllcykgPT4gewogIHZhciBuID0gc2VyaWVzLmxlbmd0aDsKICBpZiAobiA8PSAwKSB7CiAgICByZXR1cm47CiAgfQogIGZvciAodmFyIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aDsgaiA8IG07ICsraikgewogICAgdmFyIHBvc2l0aXZlID0gMDsKICAgIHZhciBuZWdhdGl2ZSA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YXIgdmFsdWUgPSBpc05hbihzZXJpZXNbaV1bal1bMV0pID8gc2VyaWVzW2ldW2pdWzBdIDogc2VyaWVzW2ldW2pdWzFdOwogICAgICBpZiAodmFsdWUgPj0gMCkgewogICAgICAgIHNlcmllc1tpXVtqXVswXSA9IHBvc2l0aXZlOwogICAgICAgIHNlcmllc1tpXVtqXVsxXSA9IHBvc2l0aXZlICsgdmFsdWU7CiAgICAgICAgcG9zaXRpdmUgPSBzZXJpZXNbaV1bal1bMV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gbmVnYXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gbmVnYXRpdmUgKyB2YWx1ZTsKICAgICAgICBuZWdhdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfQogICAgfQogIH0KfTsKdmFyIG9mZnNldFBvc2l0aXZlID0gKHNlcmllcykgPT4gewogIHZhciBuID0gc2VyaWVzLmxlbmd0aDsKICBpZiAobiA8PSAwKSB7CiAgICByZXR1cm47CiAgfQogIGZvciAodmFyIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aDsgaiA8IG07ICsraikgewogICAgdmFyIHBvc2l0aXZlID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIHZhciB2YWx1ZSA9IGlzTmFuKHNlcmllc1tpXVtqXVsxXSkgPyBzZXJpZXNbaV1bal1bMF0gOiBzZXJpZXNbaV1bal1bMV07CiAgICAgIGlmICh2YWx1ZSA+PSAwKSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gcG9zaXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gcG9zaXRpdmUgKyB2YWx1ZTsKICAgICAgICBwb3NpdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSAwOwogICAgICAgIHNlcmllc1tpXVtqXVsxXSA9IDA7CiAgICAgIH0KICAgIH0KICB9Cn07CnZhciBTVEFDS19PRkZTRVRfTUFQID0gewogIHNpZ246IG9mZnNldFNpZ24sCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIGV4cGFuZDogZXhwYW5kX2RlZmF1bHQsCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIG5vbmU6IG5vbmVfZGVmYXVsdCwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgc2lsaG91ZXR0ZTogc2lsaG91ZXR0ZV9kZWZhdWx0LAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZGVmaW5pdGVseXR5cGVkIHR5cGVzIGFyZSBpbmNvcnJlY3QKICB3aWdnbGU6IHdpZ2dsZV9kZWZhdWx0LAogIHBvc2l0aXZlOiBvZmZzZXRQb3NpdGl2ZQp9Owp2YXIgZ2V0U3RhY2tlZERhdGEgPSAoZGF0YSwgZGF0YUtleXMsIG9mZnNldFR5cGUpID0+IHsKICB2YXIgb2Zmc2V0QWNjZXNzb3IgPSBTVEFDS19PRkZTRVRfTUFQW29mZnNldFR5cGVdOwogIHZhciBzdGFjayA9IHN0YWNrX2RlZmF1bHQoKS5rZXlzKGRhdGFLZXlzKS52YWx1ZSgoZCwga2V5KSA9PiBOdW1iZXIoZ2V0VmFsdWVCeURhdGFLZXkoZCwga2V5LCAwKSkpLm9yZGVyKG5vbmVfZGVmYXVsdDIpLm9mZnNldChvZmZzZXRBY2Nlc3Nvcik7CiAgcmV0dXJuIHN0YWNrKGRhdGEpOwp9OwpmdW5jdGlvbiBnZXROb3JtYWxpemVkU3RhY2tJZChwdWJsaWNTdGFja0lkKSB7CiAgcmV0dXJuIHB1YmxpY1N0YWNrSWQgPT0gbnVsbCA/IHZvaWQgMCA6IFN0cmluZyhwdWJsaWNTdGFja0lkKTsKfQpmdW5jdGlvbiBnZXRDYXRlQ29vcmRpbmF0ZU9mTGluZShfcmVmMikgewogIHZhciB7CiAgICBheGlzLAogICAgdGlja3M6IHRpY2tzMiwKICAgIGJhbmRTaXplLAogICAgZW50cnksCiAgICBpbmRleCwKICAgIGRhdGFLZXkKICB9ID0gX3JlZjI7CiAgaWYgKGF4aXMudHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgaWYgKCFheGlzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGF4aXMuZGF0YUtleSAmJiAhaXNOdWxsaXNoKGVudHJ5W2F4aXMuZGF0YUtleV0pKSB7CiAgICAgIHZhciBtYXRjaGVkVGljayA9IGZpbmRFbnRyeUluQXJyYXkodGlja3MyLCAidmFsdWUiLCBlbnRyeVtheGlzLmRhdGFLZXldKTsKICAgICAgaWYgKG1hdGNoZWRUaWNrKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZWRUaWNrLmNvb3JkaW5hdGUgKyBiYW5kU2l6ZSAvIDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aWNrczJbaW5kZXhdID8gdGlja3MyW2luZGV4XS5jb29yZGluYXRlICsgYmFuZFNpemUgLyAyIDogbnVsbDsKICB9CiAgdmFyIHZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksICFpc051bGxpc2goZGF0YUtleSkgPyBkYXRhS2V5IDogYXhpcy5kYXRhS2V5KTsKICByZXR1cm4gIWlzTnVsbGlzaCh2YWx1ZSkgPyBheGlzLnNjYWxlKHZhbHVlKSA6IG51bGw7Cn0KdmFyIGdldERvbWFpbk9mU2luZ2xlID0gKGRhdGEpID0+IHsKICB2YXIgZmxhdCA9IGRhdGEuZmxhdCgyKS5maWx0ZXIoaXNOdW1iZXIpOwogIHJldHVybiBbTWF0aC5taW4oLi4uZmxhdCksIE1hdGgubWF4KC4uLmZsYXQpXTsKfTsKdmFyIG1ha2VEb21haW5GaW5pdGUgPSAoZG9tYWluKSA9PiB7CiAgcmV0dXJuIFtkb21haW5bMF0gPT09IEluZmluaXR5ID8gMCA6IGRvbWFpblswXSwgZG9tYWluWzFdID09PSAtSW5maW5pdHkgPyAwIDogZG9tYWluWzFdXTsKfTsKdmFyIGdldERvbWFpbk9mU3RhY2tHcm91cHMgPSAoc3RhY2tHcm91cHMsIHN0YXJ0SW5kZXgsIGVuZEluZGV4KSA9PiB7CiAgaWYgKHN0YWNrR3JvdXBzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBtYWtlRG9tYWluRmluaXRlKE9iamVjdC5rZXlzKHN0YWNrR3JvdXBzKS5yZWR1Y2UoKHJlc3VsdCwgc3RhY2tJZCkgPT4gewogICAgdmFyIGdyb3VwID0gc3RhY2tHcm91cHNbc3RhY2tJZF07CiAgICB2YXIgewogICAgICBzdGFja2VkRGF0YQogICAgfSA9IGdyb3VwOwogICAgdmFyIGRvbWFpbiA9IHN0YWNrZWREYXRhLnJlZHVjZSgocmVzLCBlbnRyeSkgPT4gewogICAgICB2YXIgc2xpY2VkID0gZ2V0U2xpY2VkKGVudHJ5LCBzdGFydEluZGV4LCBlbmRJbmRleCk7CiAgICAgIHZhciBzID0gZ2V0RG9tYWluT2ZTaW5nbGUoc2xpY2VkKTsKICAgICAgcmV0dXJuIFtNYXRoLm1pbihyZXNbMF0sIHNbMF0pLCBNYXRoLm1heChyZXNbMV0sIHNbMV0pXTsKICAgIH0sIFtJbmZpbml0eSwgLUluZmluaXR5XSk7CiAgICByZXR1cm4gW01hdGgubWluKGRvbWFpblswXSwgcmVzdWx0WzBdKSwgTWF0aC5tYXgoZG9tYWluWzFdLCByZXN1bHRbMV0pXTsKICB9LCBbSW5maW5pdHksIC1JbmZpbml0eV0pKTsKfTsKdmFyIE1JTl9WQUxVRV9SRUcgPSAvXmRhdGFNaW5bXHNdKi1bXHNdKihbMC05XSsoWy5dezF9WzAtOV0rKXswLDF9KSQvOwp2YXIgTUFYX1ZBTFVFX1JFRyA9IC9eZGF0YU1heFtcc10qXCtbXHNdKihbMC05XSsoWy5dezF9WzAtOV0rKXswLDF9KSQvOwp2YXIgZ2V0QmFuZFNpemVPZkF4aXMgPSAoYXhpcywgdGlja3MyLCBpc0JhcikgPT4gewogIGlmIChheGlzICYmIGF4aXMuc2NhbGUgJiYgYXhpcy5zY2FsZS5iYW5kd2lkdGgpIHsKICAgIHZhciBiYW5kV2lkdGggPSBheGlzLnNjYWxlLmJhbmR3aWR0aCgpOwogICAgaWYgKCFpc0JhciB8fCBiYW5kV2lkdGggPiAwKSB7CiAgICAgIHJldHVybiBiYW5kV2lkdGg7CiAgICB9CiAgfQogIGlmIChheGlzICYmIHRpY2tzMiAmJiB0aWNrczIubGVuZ3RoID49IDIpIHsKICAgIHZhciBvcmRlcmVkVGlja3MgPSAoMCwgaW1wb3J0X3NvcnRCeTIuZGVmYXVsdCkodGlja3MyLCAobykgPT4gby5jb29yZGluYXRlKTsKICAgIHZhciBiYW5kU2l6ZSA9IEluZmluaXR5OwogICAgZm9yICh2YXIgaSA9IDEsIGxlbiA9IG9yZGVyZWRUaWNrcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgY3VyID0gb3JkZXJlZFRpY2tzW2ldOwogICAgICB2YXIgcHJldiA9IG9yZGVyZWRUaWNrc1tpIC0gMV07CiAgICAgIGJhbmRTaXplID0gTWF0aC5taW4oKGN1ci5jb29yZGluYXRlIHx8IDApIC0gKHByZXYuY29vcmRpbmF0ZSB8fCAwKSwgYmFuZFNpemUpOwogICAgfQogICAgcmV0dXJuIGJhbmRTaXplID09PSBJbmZpbml0eSA/IDAgOiBiYW5kU2l6ZTsKICB9CiAgcmV0dXJuIGlzQmFyID8gdm9pZCAwIDogMDsKfTsKZnVuY3Rpb24gZ2V0VG9vbHRpcEVudHJ5KF9yZWY0KSB7CiAgdmFyIHsKICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzLAogICAgZGF0YUtleSwKICAgIHBheWxvYWQsCiAgICB2YWx1ZSwKICAgIG5hbWUKICB9ID0gX3JlZjQ7CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQyKF9vYmplY3RTcHJlYWQyKHt9LCB0b29sdGlwRW50cnlTZXR0aW5ncyksIHt9LCB7CiAgICBkYXRhS2V5LAogICAgcGF5bG9hZCwKICAgIHZhbHVlLAogICAgbmFtZQogIH0pOwp9CmZ1bmN0aW9uIGdldFRvb2x0aXBOYW1lUHJvcChuYW1lRnJvbUl0ZW0sIGRhdGFLZXkpIHsKICBpZiAobmFtZUZyb21JdGVtKSB7CiAgICByZXR1cm4gU3RyaW5nKG5hbWVGcm9tSXRlbSk7CiAgfQogIGlmICh0eXBlb2YgZGF0YUtleSA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiBkYXRhS2V5OwogIH0KICByZXR1cm4gdm9pZCAwOwp9CnZhciBjYWxjdWxhdGVDYXJ0ZXNpYW5Ub29sdGlwUG9zID0gKGNvb3JkaW5hdGUsIGxheW91dCkgPT4gewogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIGNvb3JkaW5hdGUuY2hhcnRYOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gY29vcmRpbmF0ZS5jaGFydFk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBjYWxjdWxhdGVQb2xhclRvb2x0aXBQb3MgPSAocmFuZ2VPYmosIGxheW91dCkgPT4gewogIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgcmV0dXJuIHJhbmdlT2JqLmFuZ2xlOwogIH0KICByZXR1cm4gcmFuZ2VPYmoucmFkaXVzOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29udGFpbmVyU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RDaGFydFdpZHRoID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQud2lkdGg7CnZhciBzZWxlY3RDaGFydEhlaWdodCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LmhlaWdodDsKdmFyIHNlbGVjdENvbnRhaW5lclNjYWxlID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQuc2NhbGU7CnZhciBzZWxlY3RNYXJnaW4gPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC5tYXJnaW47CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RBbGxBeGVzLmpzCnZhciBzZWxlY3RBbGxYQXhlcyA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUuY2FydGVzaWFuQXhpcy54QXhpcywgKHhBeGlzTWFwKSA9PiB7CiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoeEF4aXNNYXApOwp9KTsKdmFyIHNlbGVjdEFsbFlBeGVzID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnlBeGlzLCAoeUF4aXNNYXApID0+IHsKICByZXR1cm4gT2JqZWN0LnZhbHVlcyh5QXhpc01hcCk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NvbnN0YW50cy5qcwp2YXIgREFUQV9JVEVNX0lOREVYX0FUVFJJQlVURV9OQU1FID0gImRhdGEtcmVjaGFydHMtaXRlbS1pbmRleCI7CnZhciBEQVRBX0lURU1fREFUQUtFWV9BVFRSSUJVVEVfTkFNRSA9ICJkYXRhLXJlY2hhcnRzLWl0ZW0tZGF0YS1rZXkiOwp2YXIgREVGQVVMVF9ZX0FYSVNfV0lEVEggPSA2MDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwuanMKZnVuY3Rpb24gb3duS2V5czMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHNlbGVjdEJydXNoSGVpZ2h0ID0gKHN0YXRlKSA9PiBzdGF0ZS5icnVzaC5oZWlnaHQ7CmZ1bmN0aW9uIHNlbGVjdExlZnRBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHlBeGVzID0gc2VsZWN0QWxsWUF4ZXMoc3RhdGUpOwogIHJldHVybiB5QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFlbnRyeS5taXJyb3IgJiYgIWVudHJ5LmhpZGUpIHsKICAgICAgdmFyIHdpZHRoID0gdHlwZW9mIGVudHJ5LndpZHRoID09PSAibnVtYmVyIiA/IGVudHJ5LndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgICAgIHJldHVybiByZXN1bHQgKyB3aWR0aDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwgMCk7Cn0KZnVuY3Rpb24gc2VsZWN0UmlnaHRBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHlBeGVzID0gc2VsZWN0QWxsWUF4ZXMoc3RhdGUpOwogIHJldHVybiB5QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHZhciB3aWR0aCA9IHR5cGVvZiBlbnRyeS53aWR0aCA9PT0gIm51bWJlciIgPyBlbnRyeS53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogICAgICByZXR1cm4gcmVzdWx0ICsgd2lkdGg7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdFRvcEF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeEF4ZXMgPSBzZWxlY3RBbGxYQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHhBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbnRyeS5oZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdEJvdHRvbUF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeEF4ZXMgPSBzZWxlY3RBbGxYQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHhBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbnRyeS5oZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CnZhciBzZWxlY3RDaGFydE9mZnNldEludGVybmFsID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RNYXJnaW4sIHNlbGVjdEJydXNoSGVpZ2h0LCBzZWxlY3RMZWZ0QXhlc09mZnNldCwgc2VsZWN0UmlnaHRBeGVzT2Zmc2V0LCBzZWxlY3RUb3BBeGVzT2Zmc2V0LCBzZWxlY3RCb3R0b21BeGVzT2Zmc2V0LCBzZWxlY3RMZWdlbmRTZXR0aW5ncywgc2VsZWN0TGVnZW5kU2l6ZV0sIChjaGFydFdpZHRoLCBjaGFydEhlaWdodCwgbWFyZ2luLCBicnVzaEhlaWdodCwgbGVmdEF4ZXNPZmZzZXQsIHJpZ2h0QXhlc09mZnNldCwgdG9wQXhlc09mZnNldCwgYm90dG9tQXhlc09mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpID0+IHsKICB2YXIgb2Zmc2V0SCA9IHsKICAgIGxlZnQ6IChtYXJnaW4ubGVmdCB8fCAwKSArIGxlZnRBeGVzT2Zmc2V0LAogICAgcmlnaHQ6IChtYXJnaW4ucmlnaHQgfHwgMCkgKyByaWdodEF4ZXNPZmZzZXQKICB9OwogIHZhciBvZmZzZXRWID0gewogICAgdG9wOiAobWFyZ2luLnRvcCB8fCAwKSArIHRvcEF4ZXNPZmZzZXQsCiAgICBib3R0b206IChtYXJnaW4uYm90dG9tIHx8IDApICsgYm90dG9tQXhlc09mZnNldAogIH07CiAgdmFyIG9mZnNldCA9IF9vYmplY3RTcHJlYWQzKF9vYmplY3RTcHJlYWQzKHt9LCBvZmZzZXRWKSwgb2Zmc2V0SCk7CiAgdmFyIGJydXNoQm90dG9tID0gb2Zmc2V0LmJvdHRvbTsKICBvZmZzZXQuYm90dG9tICs9IGJydXNoSGVpZ2h0OwogIG9mZnNldCA9IGFwcGVuZE9mZnNldE9mTGVnZW5kKG9mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpOwogIHZhciBvZmZzZXRXaWR0aCA9IGNoYXJ0V2lkdGggLSBvZmZzZXQubGVmdCAtIG9mZnNldC5yaWdodDsKICB2YXIgb2Zmc2V0SGVpZ2h0ID0gY2hhcnRIZWlnaHQgLSBvZmZzZXQudG9wIC0gb2Zmc2V0LmJvdHRvbTsKICByZXR1cm4gX29iamVjdFNwcmVhZDMoX29iamVjdFNwcmVhZDMoewogICAgYnJ1c2hCb3R0b20KICB9LCBvZmZzZXQpLCB7fSwgewogICAgLy8gbmV2ZXIgcmV0dXJuIG5lZ2F0aXZlIHZhbHVlcyBmb3IgaGVpZ2h0IGFuZCB3aWR0aAogICAgd2lkdGg6IE1hdGgubWF4KG9mZnNldFdpZHRoLCAwKSwKICAgIGhlaWdodDogTWF0aC5tYXgob2Zmc2V0SGVpZ2h0LCAwKQogIH0pOwp9KTsKdmFyIHNlbGVjdENoYXJ0Vmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIChvZmZzZXQpID0+ICh7CiAgeDogb2Zmc2V0LmxlZnQsCiAgeTogb2Zmc2V0LnRvcCwKICB3aWR0aDogb2Zmc2V0LndpZHRoLAogIGhlaWdodDogb2Zmc2V0LmhlaWdodAp9KSk7CnZhciBzZWxlY3RBeGlzVmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCAod2lkdGgsIGhlaWdodCkgPT4gKHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGgsCiAgaGVpZ2h0Cn0pKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9QYW5vcmFtYUNvbnRleHQuanMKdmFyIFJlYWN0MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDExID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgUGFub3JhbWFDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxMS5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIHVzZUlzUGFub3JhbWEgPSAoKSA9PiAoMCwgaW1wb3J0X3JlYWN0MTEudXNlQ29udGV4dCkoUGFub3JhbWFDb250ZXh0KSAhPSBudWxsOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYnJ1c2hTZWxlY3RvcnMuanMKdmFyIHNlbGVjdEJydXNoU2V0dGluZ3MgPSAoc3RhdGUpID0+IHN0YXRlLmJydXNoOwp2YXIgc2VsZWN0QnJ1c2hEaW1lbnNpb25zID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJydXNoU2V0dGluZ3MsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdE1hcmdpbl0sIChicnVzaFNldHRpbmdzLCBvZmZzZXQsIG1hcmdpbikgPT4gKHsKICBoZWlnaHQ6IGJydXNoU2V0dGluZ3MuaGVpZ2h0LAogIHg6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3MueCkgPyBicnVzaFNldHRpbmdzLnggOiBvZmZzZXQubGVmdCwKICB5OiBpc051bWJlcihicnVzaFNldHRpbmdzLnkpID8gYnJ1c2hTZXR0aW5ncy55IDogb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgKyBvZmZzZXQuYnJ1c2hCb3R0b20gLSAoKG1hcmdpbiA9PT0gbnVsbCB8fCBtYXJnaW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IG1hcmdpbi5ib3R0b20pIHx8IDApLAogIHdpZHRoOiBpc051bWJlcihicnVzaFNldHRpbmdzLndpZHRoKSA/IGJydXNoU2V0dGluZ3Mud2lkdGggOiBvZmZzZXQud2lkdGgKfSkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvUmVzcG9uc2l2ZUNvbnRhaW5lci5qcwp2YXIgUmVhY3Q0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfdGhyb3R0bGUgPSBfX3RvRVNNKHJlcXVpcmVfdGhyb3R0bGUyKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0xvZ1V0aWxzLmpzCnZhciBpc0RldiA9IHRydWU7CnZhciB3YXJuID0gZnVuY3Rpb24gd2FybjIoY29uZGl0aW9uLCBmb3JtYXQyKSB7CiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDIgPyBfbGVuIC0gMiA6IDApLCBfa2V5ID0gMjsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgYXJnc1tfa2V5IC0gMl0gPSBhcmd1bWVudHNbX2tleV07CiAgfQogIGlmIChpc0RldiAmJiB0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS53YXJuKSB7CiAgICBpZiAoZm9ybWF0MiA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnNvbGUud2FybigiTG9nVXRpbHMgcmVxdWlyZXMgYW4gZXJyb3IgbWVzc2FnZSBhcmd1bWVudCIpOwogICAgfQogICAgaWYgKCFjb25kaXRpb24pIHsKICAgICAgaWYgKGZvcm1hdDIgPT09IHZvaWQgMCkgewogICAgICAgIGNvbnNvbGUud2FybigiTWluaWZpZWQgZXhjZXB0aW9uIG9jY3VycmVkOyB1c2UgdGhlIG5vbi1taW5pZmllZCBkZXYgZW52aXJvbm1lbnQgZm9yIHRoZSBmdWxsIGVycm9yIG1lc3NhZ2UgYW5kIGFkZGl0aW9uYWwgaGVscGZ1bCB3YXJuaW5ncy4iKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgYXJnSW5kZXggPSAwOwogICAgICAgIGNvbnNvbGUud2Fybihmb3JtYXQyLnJlcGxhY2UoLyVzL2csICgpID0+IGFyZ3NbYXJnSW5kZXgrK10pKTsKICAgICAgfQogICAgfQogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L3Jlc3BvbnNpdmVDb250YWluZXJVdGlscy5qcwp2YXIgY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zID0gKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQsIHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoID0gIjEwMCUiLAogICAgaGVpZ2h0ID0gIjEwMCUiLAogICAgYXNwZWN0LAogICAgbWF4SGVpZ2h0CiAgfSA9IHByb3BzOwogIHZhciBjYWxjdWxhdGVkV2lkdGggPSBpc1BlcmNlbnQod2lkdGgpID8gY29udGFpbmVyV2lkdGggOiBOdW1iZXIod2lkdGgpOwogIHZhciBjYWxjdWxhdGVkSGVpZ2h0ID0gaXNQZXJjZW50KGhlaWdodCkgPyBjb250YWluZXJIZWlnaHQgOiBOdW1iZXIoaGVpZ2h0KTsKICBpZiAoYXNwZWN0ICYmIGFzcGVjdCA+IDApIHsKICAgIGlmIChjYWxjdWxhdGVkV2lkdGgpIHsKICAgICAgY2FsY3VsYXRlZEhlaWdodCA9IGNhbGN1bGF0ZWRXaWR0aCAvIGFzcGVjdDsKICAgIH0gZWxzZSBpZiAoY2FsY3VsYXRlZEhlaWdodCkgewogICAgICBjYWxjdWxhdGVkV2lkdGggPSBjYWxjdWxhdGVkSGVpZ2h0ICogYXNwZWN0OwogICAgfQogICAgaWYgKG1heEhlaWdodCAmJiBjYWxjdWxhdGVkSGVpZ2h0ICE9IG51bGwgJiYgY2FsY3VsYXRlZEhlaWdodCA+IG1heEhlaWdodCkgewogICAgICBjYWxjdWxhdGVkSGVpZ2h0ID0gbWF4SGVpZ2h0OwogICAgfQogIH0KICByZXR1cm4gewogICAgY2FsY3VsYXRlZFdpZHRoLAogICAgY2FsY3VsYXRlZEhlaWdodAogIH07Cn07CnZhciBib3RoT3ZlcmZsb3cgPSB7CiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIG92ZXJmbG93OiAidmlzaWJsZSIKfTsKdmFyIG92ZXJmbG93WCA9IHsKICB3aWR0aDogMCwKICBvdmVyZmxvd1g6ICJ2aXNpYmxlIgp9Owp2YXIgb3ZlcmZsb3dZID0gewogIGhlaWdodDogMCwKICBvdmVyZmxvd1k6ICJ2aXNpYmxlIgp9Owp2YXIgbm9TdHlsZSA9IHt9Owp2YXIgZ2V0SW5uZXJEaXZTdHlsZSA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICB2YXIgaXNXaWR0aFBlcmNlbnQgPSBpc1BlcmNlbnQod2lkdGgpOwogIHZhciBpc0hlaWdodFBlcmNlbnQgPSBpc1BlcmNlbnQoaGVpZ2h0KTsKICBpZiAoaXNXaWR0aFBlcmNlbnQgJiYgaXNIZWlnaHRQZXJjZW50KSB7CiAgICByZXR1cm4gYm90aE92ZXJmbG93OwogIH0KICBpZiAoaXNXaWR0aFBlcmNlbnQpIHsKICAgIHJldHVybiBvdmVyZmxvd1g7CiAgfQogIGlmIChpc0hlaWdodFBlcmNlbnQpIHsKICAgIHJldHVybiBvdmVyZmxvd1k7CiAgfQogIHJldHVybiBub1N0eWxlOwp9OwpmdW5jdGlvbiBnZXREZWZhdWx0V2lkdGhBbmRIZWlnaHQoX3JlZjIpIHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBhc3BlY3QKICB9ID0gX3JlZjI7CiAgdmFyIGNhbGN1bGF0ZWRXaWR0aCA9IHdpZHRoOwogIHZhciBjYWxjdWxhdGVkSGVpZ2h0ID0gaGVpZ2h0OwogIGlmIChjYWxjdWxhdGVkV2lkdGggPT09IHZvaWQgMCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID09PSB2b2lkIDApIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCA9ICIxMDAlIjsKICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSAiMTAwJSI7CiAgfSBlbHNlIGlmIChjYWxjdWxhdGVkV2lkdGggPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZFdpZHRoID0gYXNwZWN0ICYmIGFzcGVjdCA+IDAgPyB2b2lkIDAgOiAiMTAwJSI7CiAgfSBlbHNlIGlmIChjYWxjdWxhdGVkSGVpZ2h0ID09PSB2b2lkIDApIHsKICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSBhc3BlY3QgJiYgYXNwZWN0ID4gMCA/IHZvaWQgMCA6ICIxMDAlIjsKICB9CiAgcmV0dXJuIHsKICAgIHdpZHRoOiBjYWxjdWxhdGVkV2lkdGgsCiAgICBoZWlnaHQ6IGNhbGN1bGF0ZWRIZWlnaHQKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvaXNXZWxsQmVoYXZlZE51bWJlci5qcwpmdW5jdGlvbiBpc1dlbGxCZWhhdmVkTnVtYmVyKG4pIHsKICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKG4pOwp9CmZ1bmN0aW9uIGlzUG9zaXRpdmVOdW1iZXIobikgewogIHJldHVybiB0eXBlb2YgbiA9PT0gIm51bWJlciIgJiYgbiA+IDAgJiYgTnVtYmVyLmlzRmluaXRlKG4pOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9SZXNwb25zaXZlQ29udGFpbmVyLmpzCmZ1bmN0aW9uIF9leHRlbmRzMygpIHsKICByZXR1cm4gX2V4dGVuZHMzID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMzLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czQoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ0KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzNChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5NChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM0KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5NChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk0KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlNCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxMi5jcmVhdGVDb250ZXh0KSh7CiAgd2lkdGg6IC0xLAogIGhlaWdodDogLTEKfSk7CmZ1bmN0aW9uIGlzQWNjZXB0YWJsZVNpemUoc2l6ZSkgewogIHJldHVybiBpc1Bvc2l0aXZlTnVtYmVyKHNpemUud2lkdGgpICYmIGlzUG9zaXRpdmVOdW1iZXIoc2l6ZS5oZWlnaHQpOwp9CmZ1bmN0aW9uIFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0UHJvdmlkZXIoX3JlZjIpIHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBfcmVmMjsKICB2YXIgc2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VNZW1vKSgoKSA9PiAoewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9KSwgW3dpZHRoLCBoZWlnaHRdKTsKICBpZiAoIWlzQWNjZXB0YWJsZVNpemUoc2l6ZSkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NC5jcmVhdGVFbGVtZW50KFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogc2l6ZQogIH0sIGNoaWxkcmVuKTsKfQp2YXIgdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQgPSAoKSA9PiAoMCwgaW1wb3J0X3JlYWN0MTIudXNlQ29udGV4dCkoUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQpOwp2YXIgU2l6ZURldGVjdG9yQ29udGFpbmVyID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxMi5mb3J3YXJkUmVmKSgoX3JlZjIsIHJlZikgPT4gewogIHZhciB7CiAgICBhc3BlY3QsCiAgICBpbml0aWFsRGltZW5zaW9uID0gewogICAgICB3aWR0aDogLTEsCiAgICAgIGhlaWdodDogLTEKICAgIH0sCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIC8qCiAgICAgKiBkZWZhdWx0IG1pbi13aWR0aCB0byAwIGlmIG5vdCBzcGVjaWZpZWQgLSAnYXV0bycgY2F1c2VzIGlzc3VlcyB3aXRoIGZsZXhib3gKICAgICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9pc3N1ZXMvMTcyCiAgICAgKi8KICAgIG1pbldpZHRoID0gMCwKICAgIG1pbkhlaWdodCwKICAgIG1heEhlaWdodCwKICAgIGNoaWxkcmVuLAogICAgZGVib3VuY2UgPSAwLAogICAgaWQsCiAgICBjbGFzc05hbWUsCiAgICBvblJlc2l6ZSwKICAgIHN0eWxlID0ge30KICB9ID0gX3JlZjI7CiAgdmFyIGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VSZWYpKG51bGwpOwogIHZhciBvblJlc2l6ZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VSZWYpKCk7CiAgb25SZXNpemVSZWYuY3VycmVudCA9IG9uUmVzaXplOwogICgwLCBpbXBvcnRfcmVhY3QxMi51c2VJbXBlcmF0aXZlSGFuZGxlKShyZWYsICgpID0+IGNvbnRhaW5lclJlZi5jdXJyZW50KTsKICB2YXIgW3NpemVzLCBzZXRTaXplc10gPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlU3RhdGUpKHsKICAgIGNvbnRhaW5lcldpZHRoOiBpbml0aWFsRGltZW5zaW9uLndpZHRoLAogICAgY29udGFpbmVySGVpZ2h0OiBpbml0aWFsRGltZW5zaW9uLmhlaWdodAogIH0pOwogIHZhciBzZXRDb250YWluZXJTaXplID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZUNhbGxiYWNrKSgobmV3V2lkdGgsIG5ld0hlaWdodCkgPT4gewogICAgc2V0U2l6ZXMoKHByZXZTdGF0ZSkgPT4gewogICAgICB2YXIgcm91bmRlZFdpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCk7CiAgICAgIHZhciByb3VuZGVkSGVpZ2h0ID0gTWF0aC5yb3VuZChuZXdIZWlnaHQpOwogICAgICBpZiAocHJldlN0YXRlLmNvbnRhaW5lcldpZHRoID09PSByb3VuZGVkV2lkdGggJiYgcHJldlN0YXRlLmNvbnRhaW5lckhlaWdodCA9PT0gcm91bmRlZEhlaWdodCkgewogICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjb250YWluZXJXaWR0aDogcm91bmRlZFdpZHRoLAogICAgICAgIGNvbnRhaW5lckhlaWdodDogcm91bmRlZEhlaWdodAogICAgICB9OwogICAgfSk7CiAgfSwgW10pOwogICgwLCBpbXBvcnRfcmVhY3QxMi51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChjb250YWluZXJSZWYuY3VycmVudCA9PSBudWxsIHx8IHR5cGVvZiBSZXNpemVPYnNlcnZlciA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgY2FsbGJhY2sgPSAoZW50cmllcykgPT4gewogICAgICB2YXIgX29uUmVzaXplUmVmJGN1cnJlbnQ7CiAgICAgIHZhciB7CiAgICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoMywKICAgICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodDMKICAgICAgfSA9IGVudHJpZXNbMF0uY29udGVudFJlY3Q7CiAgICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgzLCBjb250YWluZXJIZWlnaHQzKTsKICAgICAgKF9vblJlc2l6ZVJlZiRjdXJyZW50ID0gb25SZXNpemVSZWYuY3VycmVudCkgPT09IG51bGwgfHwgX29uUmVzaXplUmVmJGN1cnJlbnQgPT09IHZvaWQgMCB8fCBfb25SZXNpemVSZWYkY3VycmVudC5jYWxsKG9uUmVzaXplUmVmLCBjb250YWluZXJXaWR0aDMsIGNvbnRhaW5lckhlaWdodDMpOwogICAgfTsKICAgIGlmIChkZWJvdW5jZSA+IDApIHsKICAgICAgY2FsbGJhY2sgPSAoMCwgaW1wb3J0X3Rocm90dGxlLmRlZmF1bHQpKGNhbGxiYWNrLCBkZWJvdW5jZSwgewogICAgICAgIHRyYWlsaW5nOiB0cnVlLAogICAgICAgIGxlYWRpbmc6IGZhbHNlCiAgICAgIH0pOwogICAgfQogICAgdmFyIG9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKGNhbGxiYWNrKTsKICAgIHZhciB7CiAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aDIsCiAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0MgogICAgfSA9IGNvbnRhaW5lclJlZi5jdXJyZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgc2V0Q29udGFpbmVyU2l6ZShjb250YWluZXJXaWR0aDIsIGNvbnRhaW5lckhlaWdodDIpOwogICAgb2JzZXJ2ZXIub2JzZXJ2ZShjb250YWluZXJSZWYuY3VycmVudCk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICB9OwogIH0sIFtzZXRDb250YWluZXJTaXplLCBkZWJvdW5jZV0pOwogIHZhciB7CiAgICBjb250YWluZXJXaWR0aCwKICAgIGNvbnRhaW5lckhlaWdodAogIH0gPSBzaXplczsKICB3YXJuKCFhc3BlY3QgfHwgYXNwZWN0ID4gMCwgIlRoZSBhc3BlY3QoJXMpIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIiwgYXNwZWN0KTsKICB2YXIgewogICAgY2FsY3VsYXRlZFdpZHRoLAogICAgY2FsY3VsYXRlZEhlaWdodAogIH0gPSBjYWxjdWxhdGVDaGFydERpbWVuc2lvbnMoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCwgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBhc3BlY3QsCiAgICBtYXhIZWlnaHQKICB9KTsKICB3YXJuKGNhbGN1bGF0ZWRXaWR0aCAhPSBudWxsICYmIGNhbGN1bGF0ZWRXaWR0aCA+IDAgfHwgY2FsY3VsYXRlZEhlaWdodCAhPSBudWxsICYmIGNhbGN1bGF0ZWRIZWlnaHQgPiAwLCAiVGhlIHdpZHRoKCVzKSBhbmQgaGVpZ2h0KCVzKSBvZiBjaGFydCBzaG91bGQgYmUgZ3JlYXRlciB0aGFuIDAsXG4gICAgICAgcGxlYXNlIGNoZWNrIHRoZSBzdHlsZSBvZiBjb250YWluZXIsIG9yIHRoZSBwcm9wcyB3aWR0aCglcykgYW5kIGhlaWdodCglcyksXG4gICAgICAgb3IgYWRkIGEgbWluV2lkdGgoJXMpIG9yIG1pbkhlaWdodCglcykgb3IgdXNlIGFzcGVjdCglcykgdG8gY29udHJvbCB0aGVcbiAgICAgICBoZWlnaHQgYW5kIHdpZHRoLiIsIGNhbGN1bGF0ZWRXaWR0aCwgY2FsY3VsYXRlZEhlaWdodCwgd2lkdGgsIGhlaWdodCwgbWluV2lkdGgsIG1pbkhlaWdodCwgYXNwZWN0KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NC5jcmVhdGVFbGVtZW50KCJkaXYiLCB7CiAgICBpZDogaWQgPyAiIi5jb25jYXQoaWQpIDogdm9pZCAwLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1yZXNwb25zaXZlLWNvbnRhaW5lciIsIGNsYXNzTmFtZSksCiAgICBzdHlsZTogX29iamVjdFNwcmVhZDQoX29iamVjdFNwcmVhZDQoe30sIHN0eWxlKSwge30sIHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgbWluV2lkdGgsCiAgICAgIG1pbkhlaWdodCwKICAgICAgbWF4SGVpZ2h0CiAgICB9KSwKICAgIHJlZjogY29udGFpbmVyUmVmCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0NC5jcmVhdGVFbGVtZW50KCJkaXYiLCB7CiAgICBzdHlsZTogZ2V0SW5uZXJEaXZTdHlsZSh7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0pCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0NC5jcmVhdGVFbGVtZW50KFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0UHJvdmlkZXIsIHsKICAgIHdpZHRoOiBjYWxjdWxhdGVkV2lkdGgsCiAgICBoZWlnaHQ6IGNhbGN1bGF0ZWRIZWlnaHQKICB9LCBjaGlsZHJlbikpKTsKfSk7CnZhciBSZXNwb25zaXZlQ29udGFpbmVyID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxMi5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciByZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCA9IHVzZVJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0KCk7CiAgaWYgKGlzUG9zaXRpdmVOdW1iZXIocmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQud2lkdGgpICYmIGlzUG9zaXRpdmVOdW1iZXIocmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQuaGVpZ2h0KSkgewogICAgcmV0dXJuIHByb3BzLmNoaWxkcmVuOwogIH0KICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gZ2V0RGVmYXVsdFdpZHRoQW5kSGVpZ2h0KHsKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgYXNwZWN0OiBwcm9wcy5hc3BlY3QKICB9KTsKICB2YXIgewogICAgY2FsY3VsYXRlZFdpZHRoLAogICAgY2FsY3VsYXRlZEhlaWdodAogIH0gPSBjYWxjdWxhdGVDaGFydERpbWVuc2lvbnModm9pZCAwLCB2b2lkIDAsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgYXNwZWN0OiBwcm9wcy5hc3BlY3QsCiAgICBtYXhIZWlnaHQ6IHByb3BzLm1heEhlaWdodAogIH0pOwogIGlmIChpc051bWJlcihjYWxjdWxhdGVkV2lkdGgpICYmIGlzTnVtYmVyKGNhbGN1bGF0ZWRIZWlnaHQpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NC5jcmVhdGVFbGVtZW50KFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0UHJvdmlkZXIsIHsKICAgICAgd2lkdGg6IGNhbGN1bGF0ZWRXaWR0aCwKICAgICAgaGVpZ2h0OiBjYWxjdWxhdGVkSGVpZ2h0CiAgICB9LCBwcm9wcy5jaGlsZHJlbik7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoU2l6ZURldGVjdG9yQ29udGFpbmVyLCBfZXh0ZW5kczMoe30sIHByb3BzLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJlZgogIH0pKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvY2hhcnRMYXlvdXRDb250ZXh0LmpzCmZ1bmN0aW9uIGNhcnRlc2lhblZpZXdCb3hUb1RyYXBlem9pZChib3gpIHsKICBpZiAoIWJveCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHsKICAgIHg6IGJveC54LAogICAgeTogYm94LnksCiAgICB1cHBlcldpZHRoOiAidXBwZXJXaWR0aCIgaW4gYm94ID8gYm94LnVwcGVyV2lkdGggOiBib3gud2lkdGgsCiAgICBsb3dlcldpZHRoOiAibG93ZXJXaWR0aCIgaW4gYm94ID8gYm94Lmxvd2VyV2lkdGggOiBib3gud2lkdGgsCiAgICB3aWR0aDogYm94LndpZHRoLAogICAgaGVpZ2h0OiBib3guaGVpZ2h0CiAgfTsKfQp2YXIgdXNlVmlld0JveCA9ICgpID0+IHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yOwogIHZhciBwYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcm9vdFZpZXdCb3ggPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydFZpZXdCb3gpOwogIHZhciBicnVzaERpbWVuc2lvbnMgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RCcnVzaERpbWVuc2lvbnMpOwogIHZhciBicnVzaFBhZGRpbmcgPSAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QnJ1c2hTZXR0aW5ncykpID09PSBudWxsIHx8IF91c2VBcHBTZWxlY3RvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3VzZUFwcFNlbGVjdG9yLnBhZGRpbmc7CiAgaWYgKCFwYW5vcmFtYSB8fCAhYnJ1c2hEaW1lbnNpb25zIHx8ICFicnVzaFBhZGRpbmcpIHsKICAgIHJldHVybiByb290Vmlld0JveDsKICB9CiAgcmV0dXJuIHsKICAgIHdpZHRoOiBicnVzaERpbWVuc2lvbnMud2lkdGggLSBicnVzaFBhZGRpbmcubGVmdCAtIGJydXNoUGFkZGluZy5yaWdodCwKICAgIGhlaWdodDogYnJ1c2hEaW1lbnNpb25zLmhlaWdodCAtIGJydXNoUGFkZGluZy50b3AgLSBicnVzaFBhZGRpbmcuYm90dG9tLAogICAgeDogYnJ1c2hQYWRkaW5nLmxlZnQsCiAgICB5OiBicnVzaFBhZGRpbmcudG9wCiAgfTsKfTsKdmFyIG1hbnlDb21wb25lbnRzVGhyb3dFcnJvcnNJZk9mZnNldElzVW5kZWZpbmVkID0gewogIHRvcDogMCwKICBib3R0b206IDAsCiAgbGVmdDogMCwKICByaWdodDogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgYnJ1c2hCb3R0b206IDAKfTsKdmFyIHVzZU9mZnNldEludGVybmFsID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3IyOwogIHJldHVybiAoX3VzZUFwcFNlbGVjdG9yMiA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IyICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IyIDogbWFueUNvbXBvbmVudHNUaHJvd0Vycm9yc0lmT2Zmc2V0SXNVbmRlZmluZWQ7Cn07CnZhciB1c2VDaGFydFdpZHRoID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydFdpZHRoKTsKfTsKdmFyIHVzZUNoYXJ0SGVpZ2h0ID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydEhlaWdodCk7Cn07CnZhciBzZWxlY3RDaGFydExheW91dCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LmxheW91dFR5cGU7CnZhciB1c2VDaGFydExheW91dCA9ICgpID0+IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0TGF5b3V0KTsKdmFyIHVzZUNhcnRlc2lhbkNoYXJ0TGF5b3V0ID0gKCkgPT4gewogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIiB8fCBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBsYXlvdXQ7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciB1c2VJc0luQ2hhcnRDb250ZXh0ID0gKCkgPT4gewogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHJldHVybiBsYXlvdXQgIT09IHZvaWQgMDsKfTsKdmFyIFJlcG9ydENoYXJ0U2l6ZSA9IChwcm9wcykgPT4gewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHsKICAgIHdpZHRoOiB3aWR0aEZyb21Qcm9wcywKICAgIGhlaWdodDogaGVpZ2h0RnJvbVByb3BzCiAgfSA9IHByb3BzOwogIHZhciByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID0gdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQoKTsKICB2YXIgd2lkdGggPSB3aWR0aEZyb21Qcm9wczsKICB2YXIgaGVpZ2h0ID0gaGVpZ2h0RnJvbVByb3BzOwogIGlmIChyZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zKSB7CiAgICB3aWR0aCA9IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGggPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCA6IHdpZHRoRnJvbVByb3BzOwogICAgaGVpZ2h0ID0gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQgPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQgOiBoZWlnaHRGcm9tUHJvcHM7CiAgfQogICgwLCBpbXBvcnRfcmVhY3QxMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmICghaXNQYW5vcmFtYSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHdpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKGhlaWdodCkpIHsKICAgICAgZGlzcGF0Y2goc2V0Q2hhcnRTaXplKHsKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQKICAgICAgfSkpOwogICAgfQogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgd2lkdGgsIGhlaWdodF0pOwogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzL2ltbWVyL2Rpc3QvaW1tZXIubWpzCnZhciBOT1RISU5HMiA9IFN5bWJvbC5mb3IoImltbWVyLW5vdGhpbmciKTsKdmFyIERSQUZUQUJMRTIgPSBTeW1ib2wuZm9yKCJpbW1lci1kcmFmdGFibGUiKTsKdmFyIERSQUZUX1NUQVRFMiA9IFN5bWJvbC5mb3IoImltbWVyLXN0YXRlIik7CnZhciBlcnJvcnMyID0gdHJ1ZSA/IFsKICAvLyBBbGwgZXJyb3IgY29kZXMsIHN0YXJ0aW5nIGJ5IDA6CiAgZnVuY3Rpb24ocGx1Z2luKSB7CiAgICByZXR1cm4gYFRoZSBwbHVnaW4gZm9yICcke3BsdWdpbn0nIGhhcyBub3QgYmVlbiBsb2FkZWQgaW50byBJbW1lci4gVG8gZW5hYmxlIHRoZSBwbHVnaW4sIGltcG9ydCBhbmQgY2FsbCBcYGVuYWJsZSR7cGx1Z2lufSgpXGAgd2hlbiBpbml0aWFsaXppbmcgeW91ciBhcHBsaWNhdGlvbi5gOwogIH0sCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgcHJvZHVjZSBjYW4gb25seSBiZSBjYWxsZWQgb24gdGhpbmdzIHRoYXQgYXJlIGRyYWZ0YWJsZTogcGxhaW4gb2JqZWN0cywgYXJyYXlzLCBNYXAsIFNldCBvciBjbGFzc2VzIHRoYXQgYXJlIG1hcmtlZCB3aXRoICdbaW1tZXJhYmxlXTogdHJ1ZScuIEdvdCAnJHt0aGluZ30nYDsKICB9LAogICJUaGlzIG9iamVjdCBoYXMgYmVlbiBmcm96ZW4gYW5kIHNob3VsZCBub3QgYmUgbXV0YXRlZCIsCiAgZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuICJDYW5ub3QgdXNlIGEgcHJveHkgdGhhdCBoYXMgYmVlbiByZXZva2VkLiBEaWQgeW91IHBhc3MgYW4gb2JqZWN0IGZyb20gaW5zaWRlIGFuIGltbWVyIGZ1bmN0aW9uIHRvIGFuIGFzeW5jIHByb2Nlc3M/ICIgKyBkYXRhOwogIH0sCiAgIkFuIGltbWVyIHByb2R1Y2VyIHJldHVybmVkIGEgbmV3IHZhbHVlICphbmQqIG1vZGlmaWVkIGl0cyBkcmFmdC4gRWl0aGVyIHJldHVybiBhIG5ldyB2YWx1ZSAqb3IqIG1vZGlmeSB0aGUgZHJhZnQuIiwKICAiSW1tZXIgZm9yYmlkcyBjaXJjdWxhciByZWZlcmVuY2VzIiwKICAiVGhlIGZpcnN0IG9yIHNlY29uZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIiwKICAiVGhlIHRoaXJkIGFyZ3VtZW50IHRvIGBwcm9kdWNlYCBtdXN0IGJlIGEgZnVuY3Rpb24gb3IgdW5kZWZpbmVkIiwKICAiRmlyc3QgYXJndW1lbnQgdG8gYGNyZWF0ZURyYWZ0YCBtdXN0IGJlIGEgcGxhaW4gb2JqZWN0LCBhbiBhcnJheSwgb3IgYW4gaW1tZXJhYmxlIG9iamVjdCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBmaW5pc2hEcmFmdGAgbXVzdCBiZSBhIGRyYWZ0IHJldHVybmVkIGJ5IGBjcmVhdGVEcmFmdGAiLAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYCdjdXJyZW50JyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0sCiAgIk9iamVjdC5kZWZpbmVQcm9wZXJ0eSgpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiT2JqZWN0LnNldFByb3RvdHlwZU9mKCkgY2Fubm90IGJlIHVzZWQgb24gYW4gSW1tZXIgZHJhZnQiLAogICJJbW1lciBvbmx5IHN1cHBvcnRzIGRlbGV0aW5nIGFycmF5IGluZGljZXMiLAogICJJbW1lciBvbmx5IHN1cHBvcnRzIHNldHRpbmcgYXJyYXkgaW5kaWNlcyBhbmQgdGhlICdsZW5ndGgnIHByb3BlcnR5IiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnb3JpZ2luYWwnIGV4cGVjdHMgYSBkcmFmdCwgZ290OiAke3RoaW5nfWA7CiAgfQogIC8vIE5vdGU6IGlmIG1vcmUgZXJyb3JzIGFyZSBhZGRlZCwgdGhlIGVycm9yT2Zmc2V0IGluIFBhdGNoZXMudHMgc2hvdWxkIGJlIGluY3JlYXNlZAogIC8vIFNlZSBQYXRjaGVzLnRzIGZvciBhZGRpdGlvbmFsIGVycm9ycwpdIDogW107CmZ1bmN0aW9uIGRpZTIoZXJyb3IsIC4uLmFyZ3MpIHsKICBpZiAodHJ1ZSkgewogICAgY29uc3QgZSA9IGVycm9yczJbZXJyb3JdOwogICAgY29uc3QgbXNnID0gdHlwZW9mIGUgPT09ICJmdW5jdGlvbiIgPyBlLmFwcGx5KG51bGwsIGFyZ3MpIDogZTsKICAgIHRocm93IG5ldyBFcnJvcihgW0ltbWVyXSAke21zZ31gKTsKICB9CiAgdGhyb3cgbmV3IEVycm9yKAogICAgYFtJbW1lcl0gbWluaWZpZWQgZXJyb3IgbnI6ICR7ZXJyb3J9LiBGdWxsIGVycm9yIGF0OiBodHRwczovL2JpdC5seS8zY1hFS1dmYAogICk7Cn0KdmFyIGdldFByb3RvdHlwZU9mMiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKZnVuY3Rpb24gaXNEcmFmdDIodmFsdWUpIHsKICByZXR1cm4gISF2YWx1ZSAmJiAhIXZhbHVlW0RSQUZUX1NUQVRFMl07Cn0KZnVuY3Rpb24gaXNEcmFmdGFibGUyKHZhbHVlKSB7CiAgaWYgKCF2YWx1ZSkKICAgIHJldHVybiBmYWxzZTsKICByZXR1cm4gaXNQbGFpbk9iamVjdDModmFsdWUpIHx8IEFycmF5LmlzQXJyYXkodmFsdWUpIHx8ICEhdmFsdWVbRFJBRlRBQkxFMl0gfHwgISF2YWx1ZS5jb25zdHJ1Y3Rvcj8uW0RSQUZUQUJMRTJdIHx8IGlzTWFwMih2YWx1ZSkgfHwgaXNTZXQyKHZhbHVlKTsKfQp2YXIgb2JqZWN0Q3RvclN0cmluZzIgPSBPYmplY3QucHJvdG90eXBlLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCk7CnZhciBjYWNoZWRDdG9yU3RyaW5nczIgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKZnVuY3Rpb24gaXNQbGFpbk9iamVjdDModmFsdWUpIHsKICBpZiAoIXZhbHVlIHx8IHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIpCiAgICByZXR1cm4gZmFsc2U7CiAgY29uc3QgcHJvdG8yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbHVlKTsKICBpZiAocHJvdG8yID09PSBudWxsIHx8IHByb3RvMiA9PT0gT2JqZWN0LnByb3RvdHlwZSkKICAgIHJldHVybiB0cnVlOwogIGNvbnN0IEN0b3IgPSBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChwcm90bzIsICJjb25zdHJ1Y3RvciIpICYmIHByb3RvMi5jb25zdHJ1Y3RvcjsKICBpZiAoQ3RvciA9PT0gT2JqZWN0KQogICAgcmV0dXJuIHRydWU7CiAgaWYgKHR5cGVvZiBDdG9yICE9PSAiZnVuY3Rpb24iKQogICAgcmV0dXJuIGZhbHNlOwogIGxldCBjdG9yU3RyaW5nID0gY2FjaGVkQ3RvclN0cmluZ3MyLmdldChDdG9yKTsKICBpZiAoY3RvclN0cmluZyA9PT0gdm9pZCAwKSB7CiAgICBjdG9yU3RyaW5nID0gRnVuY3Rpb24udG9TdHJpbmcuY2FsbChDdG9yKTsKICAgIGNhY2hlZEN0b3JTdHJpbmdzMi5zZXQoQ3RvciwgY3RvclN0cmluZyk7CiAgfQogIHJldHVybiBjdG9yU3RyaW5nID09PSBvYmplY3RDdG9yU3RyaW5nMjsKfQpmdW5jdGlvbiBlYWNoMihvYmosIGl0ZXIsIHN0cmljdCA9IHRydWUpIHsKICBpZiAoZ2V0QXJjaHR5cGUyKG9iaikgPT09IDApIHsKICAgIGNvbnN0IGtleXMgPSBzdHJpY3QgPyBSZWZsZWN0Lm93bktleXMob2JqKSA6IE9iamVjdC5rZXlzKG9iaik7CiAgICBrZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgICBpdGVyKGtleSwgb2JqW2tleV0sIG9iaik7CiAgICB9KTsKICB9IGVsc2UgewogICAgb2JqLmZvckVhY2goKGVudHJ5LCBpbmRleCkgPT4gaXRlcihpbmRleCwgZW50cnksIG9iaikpOwogIH0KfQpmdW5jdGlvbiBnZXRBcmNodHlwZTIodGhpbmcpIHsKICBjb25zdCBzdGF0ZSA9IHRoaW5nW0RSQUZUX1NUQVRFMl07CiAgcmV0dXJuIHN0YXRlID8gc3RhdGUudHlwZV8gOiBBcnJheS5pc0FycmF5KHRoaW5nKSA/IDEgOiBpc01hcDIodGhpbmcpID8gMiA6IGlzU2V0Mih0aGluZykgPyAzIDogMDsKfQpmdW5jdGlvbiBoYXMyKHRoaW5nLCBwcm9wKSB7CiAgcmV0dXJuIGdldEFyY2h0eXBlMih0aGluZykgPT09IDIgPyB0aGluZy5oYXMocHJvcCkgOiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpbmcsIHByb3ApOwp9CmZ1bmN0aW9uIHNldDIodGhpbmcsIHByb3BPck9sZFZhbHVlLCB2YWx1ZSkgewogIGNvbnN0IHQgPSBnZXRBcmNodHlwZTIodGhpbmcpOwogIGlmICh0ID09PSAyKQogICAgdGhpbmcuc2V0KHByb3BPck9sZFZhbHVlLCB2YWx1ZSk7CiAgZWxzZSBpZiAodCA9PT0gMykgewogICAgdGhpbmcuYWRkKHZhbHVlKTsKICB9IGVsc2UKICAgIHRoaW5nW3Byb3BPck9sZFZhbHVlXSA9IHZhbHVlOwp9CmZ1bmN0aW9uIGlzMih4MiwgeTIpIHsKICBpZiAoeDIgPT09IHkyKSB7CiAgICByZXR1cm4geDIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTI7CiAgfSBlbHNlIHsKICAgIHJldHVybiB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KfQpmdW5jdGlvbiBpc01hcDIodGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldCBpbnN0YW5jZW9mIE1hcDsKfQpmdW5jdGlvbiBpc1NldDIodGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldCBpbnN0YW5jZW9mIFNldDsKfQpmdW5jdGlvbiBsYXRlc3QyKHN0YXRlKSB7CiAgcmV0dXJuIHN0YXRlLmNvcHlfIHx8IHN0YXRlLmJhc2VfOwp9CmZ1bmN0aW9uIHNoYWxsb3dDb3B5MihiYXNlLCBzdHJpY3QpIHsKICBpZiAoaXNNYXAyKGJhc2UpKSB7CiAgICByZXR1cm4gbmV3IE1hcChiYXNlKTsKICB9CiAgaWYgKGlzU2V0MihiYXNlKSkgewogICAgcmV0dXJuIG5ldyBTZXQoYmFzZSk7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KGJhc2UpKQogICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGJhc2UpOwogIGNvbnN0IGlzUGxhaW4yID0gaXNQbGFpbk9iamVjdDMoYmFzZSk7CiAgaWYgKHN0cmljdCA9PT0gdHJ1ZSB8fCBzdHJpY3QgPT09ICJjbGFzc19vbmx5IiAmJiAhaXNQbGFpbjIpIHsKICAgIGNvbnN0IGRlc2NyaXB0b3JzID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoYmFzZSk7CiAgICBkZWxldGUgZGVzY3JpcHRvcnNbRFJBRlRfU1RBVEUyXTsKICAgIGxldCBrZXlzID0gUmVmbGVjdC5vd25LZXlzKGRlc2NyaXB0b3JzKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICBjb25zdCBkZXNjID0gZGVzY3JpcHRvcnNba2V5XTsKICAgICAgaWYgKGRlc2Mud3JpdGFibGUgPT09IGZhbHNlKSB7CiAgICAgICAgZGVzYy53cml0YWJsZSA9IHRydWU7CiAgICAgICAgZGVzYy5jb25maWd1cmFibGUgPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChkZXNjLmdldCB8fCBkZXNjLnNldCkKICAgICAgICBkZXNjcmlwdG9yc1trZXldID0gewogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAvLyBjb3VsZCBsaXZlIHdpdGggISFkZXNjLnNldCBhcyB3ZWxsIGhlcmUuLi4KICAgICAgICAgIGVudW1lcmFibGU6IGRlc2MuZW51bWVyYWJsZSwKICAgICAgICAgIHZhbHVlOiBiYXNlW2tleV0KICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIE9iamVjdC5jcmVhdGUoZ2V0UHJvdG90eXBlT2YyKGJhc2UpLCBkZXNjcmlwdG9ycyk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mMihiYXNlKTsKICAgIGlmIChwcm90bzIgIT09IG51bGwgJiYgaXNQbGFpbjIpIHsKICAgICAgcmV0dXJuIHsgLi4uYmFzZSB9OwogICAgfQogICAgY29uc3Qgb2JqID0gT2JqZWN0LmNyZWF0ZShwcm90bzIpOwogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24ob2JqLCBiYXNlKTsKICB9Cn0KZnVuY3Rpb24gZnJlZXplMihvYmosIGRlZXAgPSBmYWxzZSkgewogIGlmIChpc0Zyb3plbjIob2JqKSB8fCBpc0RyYWZ0MihvYmopIHx8ICFpc0RyYWZ0YWJsZTIob2JqKSkKICAgIHJldHVybiBvYmo7CiAgaWYgKGdldEFyY2h0eXBlMihvYmopID4gMSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMob2JqLCB7CiAgICAgIHNldDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiwKICAgICAgYWRkOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyLAogICAgICBjbGVhcjogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiwKICAgICAgZGVsZXRlOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyCiAgICB9KTsKICB9CiAgT2JqZWN0LmZyZWV6ZShvYmopOwogIGlmIChkZWVwKQogICAgT2JqZWN0LnZhbHVlcyhvYmopLmZvckVhY2goKHZhbHVlKSA9PiBmcmVlemUyKHZhbHVlLCB0cnVlKSk7CiAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMyKCkgewogIGRpZTIoMik7Cn0KdmFyIGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIgPSB7CiAgdmFsdWU6IGRvbnRNdXRhdGVGcm96ZW5Db2xsZWN0aW9uczIKfTsKZnVuY3Rpb24gaXNGcm96ZW4yKG9iaikgewogIGlmIChvYmogPT09IG51bGwgfHwgdHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpCiAgICByZXR1cm4gdHJ1ZTsKICByZXR1cm4gT2JqZWN0LmlzRnJvemVuKG9iaik7Cn0KdmFyIHBsdWdpbnMyID0ge307CmZ1bmN0aW9uIGdldFBsdWdpbjIocGx1Z2luS2V5KSB7CiAgY29uc3QgcGx1Z2luID0gcGx1Z2luczJbcGx1Z2luS2V5XTsKICBpZiAoIXBsdWdpbikgewogICAgZGllMigwLCBwbHVnaW5LZXkpOwogIH0KICByZXR1cm4gcGx1Z2luOwp9CnZhciBjdXJyZW50U2NvcGUyOwpmdW5jdGlvbiBnZXRDdXJyZW50U2NvcGUyKCkgewogIHJldHVybiBjdXJyZW50U2NvcGUyOwp9CmZ1bmN0aW9uIGNyZWF0ZVNjb3BlMihwYXJlbnRfLCBpbW1lcl8pIHsKICByZXR1cm4gewogICAgZHJhZnRzXzogW10sCiAgICBwYXJlbnRfLAogICAgaW1tZXJfLAogICAgLy8gV2hlbmV2ZXIgdGhlIG1vZGlmaWVkIGRyYWZ0IGNvbnRhaW5zIGEgZHJhZnQgZnJvbSBhbm90aGVyIHNjb3BlLCB3ZQogICAgLy8gbmVlZCB0byBwcmV2ZW50IGF1dG8tZnJlZXppbmcgc28gdGhlIHVub3duZWQgZHJhZnQgY2FuIGJlIGZpbmFsaXplZC4KICAgIGNhbkF1dG9GcmVlemVfOiB0cnVlLAogICAgdW5maW5hbGl6ZWREcmFmdHNfOiAwCiAgfTsKfQpmdW5jdGlvbiB1c2VQYXRjaGVzSW5TY29wZTIoc2NvcGUsIHBhdGNoTGlzdGVuZXIpIHsKICBpZiAocGF0Y2hMaXN0ZW5lcikgewogICAgZ2V0UGx1Z2luMigiUGF0Y2hlcyIpOwogICAgc2NvcGUucGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLmludmVyc2VQYXRjaGVzXyA9IFtdOwogICAgc2NvcGUucGF0Y2hMaXN0ZW5lcl8gPSBwYXRjaExpc3RlbmVyOwogIH0KfQpmdW5jdGlvbiByZXZva2VTY29wZTIoc2NvcGUpIHsKICBsZWF2ZVNjb3BlMihzY29wZSk7CiAgc2NvcGUuZHJhZnRzXy5mb3JFYWNoKHJldm9rZURyYWZ0Mik7CiAgc2NvcGUuZHJhZnRzXyA9IG51bGw7Cn0KZnVuY3Rpb24gbGVhdmVTY29wZTIoc2NvcGUpIHsKICBpZiAoc2NvcGUgPT09IGN1cnJlbnRTY29wZTIpIHsKICAgIGN1cnJlbnRTY29wZTIgPSBzY29wZS5wYXJlbnRfOwogIH0KfQpmdW5jdGlvbiBlbnRlclNjb3BlMihpbW1lcjIyKSB7CiAgcmV0dXJuIGN1cnJlbnRTY29wZTIgPSBjcmVhdGVTY29wZTIoY3VycmVudFNjb3BlMiwgaW1tZXIyMik7Cn0KZnVuY3Rpb24gcmV2b2tlRHJhZnQyKGRyYWZ0KSB7CiAgY29uc3Qgc3RhdGUgPSBkcmFmdFtEUkFGVF9TVEFURTJdOwogIGlmIChzdGF0ZS50eXBlXyA9PT0gMCB8fCBzdGF0ZS50eXBlXyA9PT0gMSkKICAgIHN0YXRlLnJldm9rZV8oKTsKICBlbHNlCiAgICBzdGF0ZS5yZXZva2VkXyA9IHRydWU7Cn0KZnVuY3Rpb24gcHJvY2Vzc1Jlc3VsdDIocmVzdWx0LCBzY29wZSkgewogIHNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA9IHNjb3BlLmRyYWZ0c18ubGVuZ3RoOwogIGNvbnN0IGJhc2VEcmFmdCA9IHNjb3BlLmRyYWZ0c19bMF07CiAgY29uc3QgaXNSZXBsYWNlZCA9IHJlc3VsdCAhPT0gdm9pZCAwICYmIHJlc3VsdCAhPT0gYmFzZURyYWZ0OwogIGlmIChpc1JlcGxhY2VkKSB7CiAgICBpZiAoYmFzZURyYWZ0W0RSQUZUX1NUQVRFMl0ubW9kaWZpZWRfKSB7CiAgICAgIHJldm9rZVNjb3BlMihzY29wZSk7CiAgICAgIGRpZTIoNCk7CiAgICB9CiAgICBpZiAoaXNEcmFmdGFibGUyKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gZmluYWxpemUyKHNjb3BlLCByZXN1bHQpOwogICAgICBpZiAoIXNjb3BlLnBhcmVudF8pCiAgICAgICAgbWF5YmVGcmVlemUyKHNjb3BlLCByZXN1bHQpOwogICAgfQogICAgaWYgKHNjb3BlLnBhdGNoZXNfKSB7CiAgICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKS5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oCiAgICAgICAgYmFzZURyYWZ0W0RSQUZUX1NUQVRFMl0uYmFzZV8sCiAgICAgICAgcmVzdWx0LAogICAgICAgIHNjb3BlLnBhdGNoZXNfLAogICAgICAgIHNjb3BlLmludmVyc2VQYXRjaGVzXwogICAgICApOwogICAgfQogIH0gZWxzZSB7CiAgICByZXN1bHQgPSBmaW5hbGl6ZTIoc2NvcGUsIGJhc2VEcmFmdCwgW10pOwogIH0KICByZXZva2VTY29wZTIoc2NvcGUpOwogIGlmIChzY29wZS5wYXRjaGVzXykgewogICAgc2NvcGUucGF0Y2hMaXN0ZW5lcl8oc2NvcGUucGF0Y2hlc18sIHNjb3BlLmludmVyc2VQYXRjaGVzXyk7CiAgfQogIHJldHVybiByZXN1bHQgIT09IE5PVEhJTkcyID8gcmVzdWx0IDogdm9pZCAwOwp9CmZ1bmN0aW9uIGZpbmFsaXplMihyb290U2NvcGUsIHZhbHVlLCBwYXRoMikgewogIGlmIChpc0Zyb3plbjIodmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHVzZVN0cmljdEl0ZXJhdGlvbiA9IHJvb3RTY29wZS5pbW1lcl8uc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCk7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURTJdOwogIGlmICghc3RhdGUpIHsKICAgIGVhY2gyKAogICAgICB2YWx1ZSwKICAgICAgKGtleSwgY2hpbGRWYWx1ZSkgPT4gZmluYWxpemVQcm9wZXJ0eShyb290U2NvcGUsIHN0YXRlLCB2YWx1ZSwga2V5LCBjaGlsZFZhbHVlLCBwYXRoMiksCiAgICAgIHVzZVN0cmljdEl0ZXJhdGlvbgogICAgKTsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgaWYgKHN0YXRlLnNjb3BlXyAhPT0gcm9vdFNjb3BlKQogICAgcmV0dXJuIHZhbHVlOwogIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICBtYXliZUZyZWV6ZTIocm9vdFNjb3BlLCBzdGF0ZS5iYXNlXywgdHJ1ZSk7CiAgICByZXR1cm4gc3RhdGUuYmFzZV87CiAgfQogIGlmICghc3RhdGUuZmluYWxpemVkXykgewogICAgc3RhdGUuZmluYWxpemVkXyA9IHRydWU7CiAgICBzdGF0ZS5zY29wZV8udW5maW5hbGl6ZWREcmFmdHNfLS07CiAgICBjb25zdCByZXN1bHQgPSBzdGF0ZS5jb3B5XzsKICAgIGxldCByZXN1bHRFYWNoID0gcmVzdWx0OwogICAgbGV0IGlzU2V0MjIgPSBmYWxzZTsKICAgIGlmIChzdGF0ZS50eXBlXyA9PT0gMykgewogICAgICByZXN1bHRFYWNoID0gbmV3IFNldChyZXN1bHQpOwogICAgICByZXN1bHQuY2xlYXIoKTsKICAgICAgaXNTZXQyMiA9IHRydWU7CiAgICB9CiAgICBlYWNoMigKICAgICAgcmVzdWx0RWFjaCwKICAgICAgKGtleSwgY2hpbGRWYWx1ZSkgPT4gZmluYWxpemVQcm9wZXJ0eSgKICAgICAgICByb290U2NvcGUsCiAgICAgICAgc3RhdGUsCiAgICAgICAgcmVzdWx0LAogICAgICAgIGtleSwKICAgICAgICBjaGlsZFZhbHVlLAogICAgICAgIHBhdGgyLAogICAgICAgIGlzU2V0MjIKICAgICAgKSwKICAgICAgdXNlU3RyaWN0SXRlcmF0aW9uCiAgICApOwogICAgbWF5YmVGcmVlemUyKHJvb3RTY29wZSwgcmVzdWx0LCBmYWxzZSk7CiAgICBpZiAocGF0aDIgJiYgcm9vdFNjb3BlLnBhdGNoZXNfKSB7CiAgICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKS5nZW5lcmF0ZVBhdGNoZXNfKAogICAgICAgIHN0YXRlLAogICAgICAgIHBhdGgyLAogICAgICAgIHJvb3RTY29wZS5wYXRjaGVzXywKICAgICAgICByb290U2NvcGUuaW52ZXJzZVBhdGNoZXNfCiAgICAgICk7CiAgICB9CiAgfQogIHJldHVybiBzdGF0ZS5jb3B5XzsKfQpmdW5jdGlvbiBmaW5hbGl6ZVByb3BlcnR5KHJvb3RTY29wZSwgcGFyZW50U3RhdGUsIHRhcmdldE9iamVjdCwgcHJvcCwgY2hpbGRWYWx1ZSwgcm9vdFBhdGgsIHRhcmdldElzU2V0KSB7CiAgaWYgKGNoaWxkVmFsdWUgPT0gbnVsbCkgewogICAgcmV0dXJuOwogIH0KICBpZiAodHlwZW9mIGNoaWxkVmFsdWUgIT09ICJvYmplY3QiICYmICF0YXJnZXRJc1NldCkgewogICAgcmV0dXJuOwogIH0KICBjb25zdCBjaGlsZElzRnJvemVuID0gaXNGcm96ZW4yKGNoaWxkVmFsdWUpOwogIGlmIChjaGlsZElzRnJvemVuICYmICF0YXJnZXRJc1NldCkgewogICAgcmV0dXJuOwogIH0KICBpZiAoY2hpbGRWYWx1ZSA9PT0gdGFyZ2V0T2JqZWN0KQogICAgZGllMig1KTsKICBpZiAoaXNEcmFmdDIoY2hpbGRWYWx1ZSkpIHsKICAgIGNvbnN0IHBhdGgyID0gcm9vdFBhdGggJiYgcGFyZW50U3RhdGUgJiYgcGFyZW50U3RhdGUudHlwZV8gIT09IDMgJiYgLy8gU2V0IG9iamVjdHMgYXJlIGF0b21pYyBzaW5jZSB0aGV5IGhhdmUgbm8ga2V5cy4KICAgICFoYXMyKHBhcmVudFN0YXRlLmFzc2lnbmVkXywgcHJvcCkgPyByb290UGF0aC5jb25jYXQocHJvcCkgOiB2b2lkIDA7CiAgICBjb25zdCByZXMgPSBmaW5hbGl6ZTIocm9vdFNjb3BlLCBjaGlsZFZhbHVlLCBwYXRoMik7CiAgICBzZXQyKHRhcmdldE9iamVjdCwgcHJvcCwgcmVzKTsKICAgIGlmIChpc0RyYWZ0MihyZXMpKSB7CiAgICAgIHJvb3RTY29wZS5jYW5BdXRvRnJlZXplXyA9IGZhbHNlOwogICAgfSBlbHNlCiAgICAgIHJldHVybjsKICB9IGVsc2UgaWYgKHRhcmdldElzU2V0KSB7CiAgICB0YXJnZXRPYmplY3QuYWRkKGNoaWxkVmFsdWUpOwogIH0KICBpZiAoaXNEcmFmdGFibGUyKGNoaWxkVmFsdWUpICYmICFjaGlsZElzRnJvemVuKSB7CiAgICBpZiAoIXJvb3RTY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgcm9vdFNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA8IDEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHBhcmVudFN0YXRlICYmIHBhcmVudFN0YXRlLmJhc2VfICYmIHBhcmVudFN0YXRlLmJhc2VfW3Byb3BdID09PSBjaGlsZFZhbHVlICYmIGNoaWxkSXNGcm96ZW4pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZmluYWxpemUyKHJvb3RTY29wZSwgY2hpbGRWYWx1ZSk7CiAgICBpZiAoKCFwYXJlbnRTdGF0ZSB8fCAhcGFyZW50U3RhdGUuc2NvcGVfLnBhcmVudF8pICYmIHR5cGVvZiBwcm9wICE9PSAic3ltYm9sIiAmJiAoaXNNYXAyKHRhcmdldE9iamVjdCkgPyB0YXJnZXRPYmplY3QuaGFzKHByb3ApIDogT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKHRhcmdldE9iamVjdCwgcHJvcCkpKQogICAgICBtYXliZUZyZWV6ZTIocm9vdFNjb3BlLCBjaGlsZFZhbHVlKTsKICB9Cn0KZnVuY3Rpb24gbWF5YmVGcmVlemUyKHNjb3BlLCB2YWx1ZSwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKCFzY29wZS5wYXJlbnRfICYmIHNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiBzY29wZS5jYW5BdXRvRnJlZXplXykgewogICAgZnJlZXplMih2YWx1ZSwgZGVlcCk7CiAgfQp9CmZ1bmN0aW9uIGNyZWF0ZVByb3h5UHJveHkyKGJhc2UsIHBhcmVudCkgewogIGNvbnN0IGlzQXJyYXkyID0gQXJyYXkuaXNBcnJheShiYXNlKTsKICBjb25zdCBzdGF0ZSA9IHsKICAgIHR5cGVfOiBpc0FycmF5MiA/IDEgOiAwLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvZHVjZSBjYWxsIHRoaXMgaXMgYXNzb2NpYXRlZCB3aXRoLgogICAgc2NvcGVfOiBwYXJlbnQgPyBwYXJlbnQuc2NvcGVfIDogZ2V0Q3VycmVudFNjb3BlMigpLAogICAgLy8gVHJ1ZSBmb3IgYm90aCBzaGFsbG93IGFuZCBkZWVwIGNoYW5nZXMuCiAgICBtb2RpZmllZF86IGZhbHNlLAogICAgLy8gVXNlZCBkdXJpbmcgZmluYWxpemF0aW9uLgogICAgZmluYWxpemVkXzogZmFsc2UsCiAgICAvLyBUcmFjayB3aGljaCBwcm9wZXJ0aWVzIGhhdmUgYmVlbiBhc3NpZ25lZCAodHJ1ZSkgb3IgZGVsZXRlZCAoZmFsc2UpLgogICAgYXNzaWduZWRfOiB7fSwKICAgIC8vIFRoZSBwYXJlbnQgZHJhZnQgc3RhdGUuCiAgICBwYXJlbnRfOiBwYXJlbnQsCiAgICAvLyBUaGUgYmFzZSBzdGF0ZS4KICAgIGJhc2VfOiBiYXNlLAogICAgLy8gVGhlIGJhc2UgcHJveHkuCiAgICBkcmFmdF86IG51bGwsCiAgICAvLyBzZXQgYmVsb3cKICAgIC8vIFRoZSBiYXNlIGNvcHkgd2l0aCBhbnkgdXBkYXRlZCB2YWx1ZXMuCiAgICBjb3B5XzogbnVsbCwKICAgIC8vIENhbGxlZCBieSB0aGUgYHByb2R1Y2VgIGZ1bmN0aW9uLgogICAgcmV2b2tlXzogbnVsbCwKICAgIGlzTWFudWFsXzogZmFsc2UKICB9OwogIGxldCB0YXJnZXQgPSBzdGF0ZTsKICBsZXQgdHJhcHMgPSBvYmplY3RUcmFwczI7CiAgaWYgKGlzQXJyYXkyKSB7CiAgICB0YXJnZXQgPSBbc3RhdGVdOwogICAgdHJhcHMgPSBhcnJheVRyYXBzMjsKICB9CiAgY29uc3QgeyByZXZva2UsIHByb3h5IH0gPSBQcm94eS5yZXZvY2FibGUodGFyZ2V0LCB0cmFwcyk7CiAgc3RhdGUuZHJhZnRfID0gcHJveHk7CiAgc3RhdGUucmV2b2tlXyA9IHJldm9rZTsKICByZXR1cm4gcHJveHk7Cn0KdmFyIG9iamVjdFRyYXBzMiA9IHsKICBnZXQoc3RhdGUsIHByb3ApIHsKICAgIGlmIChwcm9wID09PSBEUkFGVF9TVEFURTIpCiAgICAgIHJldHVybiBzdGF0ZTsKICAgIGNvbnN0IHNvdXJjZSA9IGxhdGVzdDIoc3RhdGUpOwogICAgaWYgKCFoYXMyKHNvdXJjZSwgcHJvcCkpIHsKICAgICAgcmV0dXJuIHJlYWRQcm9wRnJvbVByb3RvMihzdGF0ZSwgc291cmNlLCBwcm9wKTsKICAgIH0KICAgIGNvbnN0IHZhbHVlID0gc291cmNlW3Byb3BdOwogICAgaWYgKHN0YXRlLmZpbmFsaXplZF8gfHwgIWlzRHJhZnRhYmxlMih2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKHZhbHVlID09PSBwZWVrMihzdGF0ZS5iYXNlXywgcHJvcCkpIHsKICAgICAgcHJlcGFyZUNvcHkyKHN0YXRlKTsKICAgICAgcmV0dXJuIHN0YXRlLmNvcHlfW3Byb3BdID0gY3JlYXRlUHJveHkyKHZhbHVlLCBzdGF0ZSk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfSwKICBoYXMoc3RhdGUsIHByb3ApIHsKICAgIHJldHVybiBwcm9wIGluIGxhdGVzdDIoc3RhdGUpOwogIH0sCiAgb3duS2V5cyhzdGF0ZSkgewogICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyhsYXRlc3QyKHN0YXRlKSk7CiAgfSwKICBzZXQoc3RhdGUsIHByb3AsIHZhbHVlKSB7CiAgICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90bzIobGF0ZXN0MihzdGF0ZSksIHByb3ApOwogICAgaWYgKGRlc2M/LnNldCkgewogICAgICBkZXNjLnNldC5jYWxsKHN0YXRlLmRyYWZ0XywgdmFsdWUpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICAgIGNvbnN0IGN1cnJlbnQyMiA9IHBlZWsyKGxhdGVzdDIoc3RhdGUpLCBwcm9wKTsKICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gY3VycmVudDIyPy5bRFJBRlRfU1RBVEUyXTsKICAgICAgaWYgKGN1cnJlbnRTdGF0ZSAmJiBjdXJyZW50U3RhdGUuYmFzZV8gPT09IHZhbHVlKSB7CiAgICAgICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgICAgICBzdGF0ZS5hc3NpZ25lZF9bcHJvcF0gPSBmYWxzZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoaXMyKHZhbHVlLCBjdXJyZW50MjIpICYmICh2YWx1ZSAhPT0gdm9pZCAwIHx8IGhhczIoc3RhdGUuYmFzZV8sIHByb3ApKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgcHJlcGFyZUNvcHkyKHN0YXRlKTsKICAgICAgbWFya0NoYW5nZWQyKHN0YXRlKTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5X1twcm9wXSA9PT0gdmFsdWUgJiYgLy8gc3BlY2lhbCBjYXNlOiBoYW5kbGUgbmV3IHByb3BzIHdpdGggdmFsdWUgJ3VuZGVmaW5lZCcKICAgICh2YWx1ZSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuY29weV8pIHx8IC8vIHNwZWNpYWwgY2FzZTogTmFOCiAgICBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihzdGF0ZS5jb3B5X1twcm9wXSkpCiAgICAgIHJldHVybiB0cnVlOwogICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgIHN0YXRlLmFzc2lnbmVkX1twcm9wXSA9IHRydWU7CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIGRlbGV0ZVByb3BlcnR5KHN0YXRlLCBwcm9wKSB7CiAgICBpZiAocGVlazIoc3RhdGUuYmFzZV8sIHByb3ApICE9PSB2b2lkIDAgfHwgcHJvcCBpbiBzdGF0ZS5iYXNlXykgewogICAgICBzdGF0ZS5hc3NpZ25lZF9bcHJvcF0gPSBmYWxzZTsKICAgICAgcHJlcGFyZUNvcHkyKHN0YXRlKTsKICAgICAgbWFya0NoYW5nZWQyKHN0YXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5hc3NpZ25lZF9bcHJvcF07CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV8pIHsKICAgICAgZGVsZXRlIHN0YXRlLmNvcHlfW3Byb3BdOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfSwKICAvLyBOb3RlOiBXZSBuZXZlciBjb2VyY2UgYGRlc2MudmFsdWVgIGludG8gYW4gSW1tZXIgZHJhZnQsIGJlY2F1c2Ugd2UgY2FuJ3QgbWFrZQogIC8vIHRoZSBzYW1lIGd1YXJhbnRlZSBpbiBFUzUgbW9kZS4KICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc3RhdGUsIHByb3ApIHsKICAgIGNvbnN0IG93bmVyID0gbGF0ZXN0MihzdGF0ZSk7CiAgICBjb25zdCBkZXNjID0gUmVmbGVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob3duZXIsIHByb3ApOwogICAgaWYgKCFkZXNjKQogICAgICByZXR1cm4gZGVzYzsKICAgIHJldHVybiB7CiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHN0YXRlLnR5cGVfICE9PSAxIHx8IHByb3AgIT09ICJsZW5ndGgiLAogICAgICBlbnVtZXJhYmxlOiBkZXNjLmVudW1lcmFibGUsCiAgICAgIHZhbHVlOiBvd25lcltwcm9wXQogICAgfTsKICB9LAogIGRlZmluZVByb3BlcnR5KCkgewogICAgZGllMigxMSk7CiAgfSwKICBnZXRQcm90b3R5cGVPZihzdGF0ZSkgewogICAgcmV0dXJuIGdldFByb3RvdHlwZU9mMihzdGF0ZS5iYXNlXyk7CiAgfSwKICBzZXRQcm90b3R5cGVPZigpIHsKICAgIGRpZTIoMTIpOwogIH0KfTsKdmFyIGFycmF5VHJhcHMyID0ge307CmVhY2gyKG9iamVjdFRyYXBzMiwgKGtleSwgZm4pID0+IHsKICBhcnJheVRyYXBzMltrZXldID0gZnVuY3Rpb24oKSB7CiAgICBhcmd1bWVudHNbMF0gPSBhcmd1bWVudHNbMF1bMF07CiAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KTsKYXJyYXlUcmFwczIuZGVsZXRlUHJvcGVydHkgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCkgewogIGlmIChpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUyKDEzKTsKICByZXR1cm4gYXJyYXlUcmFwczIuc2V0LmNhbGwodGhpcywgc3RhdGUsIHByb3AsIHZvaWQgMCk7Cn07CmFycmF5VHJhcHMyLnNldCA9IGZ1bmN0aW9uKHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogIGlmIChwcm9wICE9PSAibGVuZ3RoIiAmJiBpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUyKDE0KTsKICByZXR1cm4gb2JqZWN0VHJhcHMyLnNldC5jYWxsKHRoaXMsIHN0YXRlWzBdLCBwcm9wLCB2YWx1ZSwgc3RhdGVbMF0pOwp9OwpmdW5jdGlvbiBwZWVrMihkcmFmdCwgcHJvcCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEUyXTsKICBjb25zdCBzb3VyY2UgPSBzdGF0ZSA/IGxhdGVzdDIoc3RhdGUpIDogZHJhZnQ7CiAgcmV0dXJuIHNvdXJjZVtwcm9wXTsKfQpmdW5jdGlvbiByZWFkUHJvcEZyb21Qcm90bzIoc3RhdGUsIHNvdXJjZSwgcHJvcCkgewogIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvMihzb3VyY2UsIHByb3ApOwogIHJldHVybiBkZXNjID8gYHZhbHVlYCBpbiBkZXNjID8gZGVzYy52YWx1ZSA6ICgKICAgIC8vIFRoaXMgaXMgYSB2ZXJ5IHNwZWNpYWwgY2FzZSwgaWYgdGhlIHByb3AgaXMgYSBnZXR0ZXIgZGVmaW5lZCBieSB0aGUKICAgIC8vIHByb3RvdHlwZSwgd2Ugc2hvdWxkIGludm9rZSBpdCB3aXRoIHRoZSBkcmFmdCBhcyBjb250ZXh0IQogICAgZGVzYy5nZXQ/LmNhbGwoc3RhdGUuZHJhZnRfKQogICkgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gZ2V0RGVzY3JpcHRvckZyb21Qcm90bzIoc291cmNlLCBwcm9wKSB7CiAgaWYgKCEocHJvcCBpbiBzb3VyY2UpKQogICAgcmV0dXJuIHZvaWQgMDsKICBsZXQgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YyKHNvdXJjZSk7CiAgd2hpbGUgKHByb3RvMikgewogICAgY29uc3QgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdG8yLCBwcm9wKTsKICAgIGlmIChkZXNjKQogICAgICByZXR1cm4gZGVzYzsKICAgIHByb3RvMiA9IGdldFByb3RvdHlwZU9mMihwcm90bzIpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIG1hcmtDaGFuZ2VkMihzdGF0ZSkgewogIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICBzdGF0ZS5tb2RpZmllZF8gPSB0cnVlOwogICAgaWYgKHN0YXRlLnBhcmVudF8pIHsKICAgICAgbWFya0NoYW5nZWQyKHN0YXRlLnBhcmVudF8pOwogICAgfQogIH0KfQpmdW5jdGlvbiBwcmVwYXJlQ29weTIoc3RhdGUpIHsKICBpZiAoIXN0YXRlLmNvcHlfKSB7CiAgICBzdGF0ZS5jb3B5XyA9IHNoYWxsb3dDb3B5MigKICAgICAgc3RhdGUuYmFzZV8sCiAgICAgIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfCiAgICApOwogIH0KfQp2YXIgSW1tZXIyMiA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb25maWcpIHsKICAgIHRoaXMuYXV0b0ZyZWV6ZV8gPSB0cnVlOwogICAgdGhpcy51c2VTdHJpY3RTaGFsbG93Q29weV8gPSBmYWxzZTsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IHRydWU7CiAgICB0aGlzLnByb2R1Y2UgPSAoYmFzZSwgcmVjaXBlLCBwYXRjaExpc3RlbmVyKSA9PiB7CiAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgcmVjaXBlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgY29uc3QgZGVmYXVsdEJhc2UgPSByZWNpcGU7CiAgICAgICAgcmVjaXBlID0gYmFzZTsKICAgICAgICBjb25zdCBzZWxmMiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGN1cnJpZWRQcm9kdWNlKGJhc2UyID0gZGVmYXVsdEJhc2UsIC4uLmFyZ3MpIHsKICAgICAgICAgIHJldHVybiBzZWxmMi5wcm9kdWNlKGJhc2UyLCAoZHJhZnQpID0+IHJlY2lwZS5jYWxsKHRoaXMsIGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHJlY2lwZSAhPT0gImZ1bmN0aW9uIikKICAgICAgICBkaWUyKDYpOwogICAgICBpZiAocGF0Y2hMaXN0ZW5lciAhPT0gdm9pZCAwICYmIHR5cGVvZiBwYXRjaExpc3RlbmVyICE9PSAiZnVuY3Rpb24iKQogICAgICAgIGRpZTIoNyk7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIGlmIChpc0RyYWZ0YWJsZTIoYmFzZSkpIHsKICAgICAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUyKHRoaXMpOwogICAgICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkyKGJhc2UsIHZvaWQgMCk7CiAgICAgICAgbGV0IGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzdWx0ID0gcmVjaXBlKHByb3h5KTsKICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChoYXNFcnJvcikKICAgICAgICAgICAgcmV2b2tlU2NvcGUyKHNjb3BlKTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgbGVhdmVTY29wZTIoc2NvcGUpOwogICAgICAgIH0KICAgICAgICB1c2VQYXRjaGVzSW5TY29wZTIoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgICAgIHJldHVybiBwcm9jZXNzUmVzdWx0MihyZXN1bHQsIHNjb3BlKTsKICAgICAgfSBlbHNlIGlmICghYmFzZSB8fCB0eXBlb2YgYmFzZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICByZXN1bHQgPSByZWNpcGUoYmFzZSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKQogICAgICAgICAgcmVzdWx0ID0gYmFzZTsKICAgICAgICBpZiAocmVzdWx0ID09PSBOT1RISU5HMikKICAgICAgICAgIHJlc3VsdCA9IHZvaWQgMDsKICAgICAgICBpZiAodGhpcy5hdXRvRnJlZXplXykKICAgICAgICAgIGZyZWV6ZTIocmVzdWx0LCB0cnVlKTsKICAgICAgICBpZiAocGF0Y2hMaXN0ZW5lcikgewogICAgICAgICAgY29uc3QgcCA9IFtdOwogICAgICAgICAgY29uc3QgaXAgPSBbXTsKICAgICAgICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKS5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oYmFzZSwgcmVzdWx0LCBwLCBpcCk7CiAgICAgICAgICBwYXRjaExpc3RlbmVyKHAsIGlwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSBlbHNlCiAgICAgICAgZGllMigxLCBiYXNlKTsKICAgIH07CiAgICB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyA9IChiYXNlLCByZWNpcGUpID0+IHsKICAgICAgaWYgKHR5cGVvZiBiYXNlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIChzdGF0ZSwgLi4uYXJncykgPT4gdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMoc3RhdGUsIChkcmFmdCkgPT4gYmFzZShkcmFmdCwgLi4uYXJncykpOwogICAgICB9CiAgICAgIGxldCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlczsKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wcm9kdWNlKGJhc2UsIHJlY2lwZSwgKHAsIGlwKSA9PiB7CiAgICAgICAgcGF0Y2hlcyA9IHA7CiAgICAgICAgaW52ZXJzZVBhdGNoZXMgPSBpcDsKICAgICAgfSk7CiAgICAgIHJldHVybiBbcmVzdWx0LCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlc107CiAgICB9OwogICAgaWYgKHR5cGVvZiBjb25maWc/LmF1dG9GcmVlemUgPT09ICJib29sZWFuIikKICAgICAgdGhpcy5zZXRBdXRvRnJlZXplKGNvbmZpZy5hdXRvRnJlZXplKTsKICAgIGlmICh0eXBlb2YgY29uZmlnPy51c2VTdHJpY3RTaGFsbG93Q29weSA9PT0gImJvb2xlYW4iKQogICAgICB0aGlzLnNldFVzZVN0cmljdFNoYWxsb3dDb3B5KGNvbmZpZy51c2VTdHJpY3RTaGFsbG93Q29weSk7CiAgICBpZiAodHlwZW9mIGNvbmZpZz8udXNlU3RyaWN0SXRlcmF0aW9uID09PSAiYm9vbGVhbiIpCiAgICAgIHRoaXMuc2V0VXNlU3RyaWN0SXRlcmF0aW9uKGNvbmZpZy51c2VTdHJpY3RJdGVyYXRpb24pOwogIH0KICBjcmVhdGVEcmFmdChiYXNlKSB7CiAgICBpZiAoIWlzRHJhZnRhYmxlMihiYXNlKSkKICAgICAgZGllMig4KTsKICAgIGlmIChpc0RyYWZ0MihiYXNlKSkKICAgICAgYmFzZSA9IGN1cnJlbnQyKGJhc2UpOwogICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlMih0aGlzKTsKICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkyKGJhc2UsIHZvaWQgMCk7CiAgICBwcm94eVtEUkFGVF9TVEFURTJdLmlzTWFudWFsXyA9IHRydWU7CiAgICBsZWF2ZVNjb3BlMihzY29wZSk7CiAgICByZXR1cm4gcHJveHk7CiAgfQogIGZpbmlzaERyYWZ0KGRyYWZ0LCBwYXRjaExpc3RlbmVyKSB7CiAgICBjb25zdCBzdGF0ZSA9IGRyYWZ0ICYmIGRyYWZ0W0RSQUZUX1NUQVRFMl07CiAgICBpZiAoIXN0YXRlIHx8ICFzdGF0ZS5pc01hbnVhbF8pCiAgICAgIGRpZTIoOSk7CiAgICBjb25zdCB7IHNjb3BlXzogc2NvcGUgfSA9IHN0YXRlOwogICAgdXNlUGF0Y2hlc0luU2NvcGUyKHNjb3BlLCBwYXRjaExpc3RlbmVyKTsKICAgIHJldHVybiBwcm9jZXNzUmVzdWx0Mih2b2lkIDAsIHNjb3BlKTsKICB9CiAgLyoqCiAgICogUGFzcyB0cnVlIHRvIGF1dG9tYXRpY2FsbHkgZnJlZXplIGFsbCBjb3BpZXMgY3JlYXRlZCBieSBJbW1lci4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGF1dG8tZnJlZXppbmcgaXMgZW5hYmxlZC4KICAgKi8KICBzZXRBdXRvRnJlZXplKHZhbHVlKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBlbmFibGUgc3RyaWN0IHNoYWxsb3cgY29weS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGltbWVyIGRvZXMgbm90IGNvcHkgdGhlIG9iamVjdCBkZXNjcmlwdG9ycyBzdWNoIGFzIGdldHRlciwgc2V0dGVyIGFuZCBub24tZW51bXJhYmxlIHByb3BlcnRpZXMuCiAgICovCiAgc2V0VXNlU3RyaWN0U2hhbGxvd0NvcHkodmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgZmFsc2UgdG8gdXNlIGZhc3RlciBpdGVyYXRpb24gdGhhdCBza2lwcyBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzCiAgICogYnV0IHN0aWxsIGhhbmRsZXMgc3ltYm9scyBmb3IgY29tcGF0aWJpbGl0eS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHN0cmljdCBpdGVyYXRpb24gaXMgZW5hYmxlZCAoaW5jbHVkZXMgYWxsIG93biBwcm9wZXJ0aWVzKS4KICAgKi8KICBzZXRVc2VTdHJpY3RJdGVyYXRpb24odmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IHZhbHVlOwogIH0KICBzaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fOwogIH0KICBhcHBseVBhdGNoZXMoYmFzZSwgcGF0Y2hlcykgewogICAgbGV0IGk7CiAgICBmb3IgKGkgPSBwYXRjaGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHBhdGNoID0gcGF0Y2hlc1tpXTsKICAgICAgaWYgKHBhdGNoLnBhdGgubGVuZ3RoID09PSAwICYmIHBhdGNoLm9wID09PSAicmVwbGFjZSIpIHsKICAgICAgICBiYXNlID0gcGF0Y2gudmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmIChpID4gLTEpIHsKICAgICAgcGF0Y2hlcyA9IHBhdGNoZXMuc2xpY2UoaSArIDEpOwogICAgfQogICAgY29uc3QgYXBwbHlQYXRjaGVzSW1wbCA9IGdldFBsdWdpbjIoIlBhdGNoZXMiKS5hcHBseVBhdGNoZXNfOwogICAgaWYgKGlzRHJhZnQyKGJhc2UpKSB7CiAgICAgIHJldHVybiBhcHBseVBhdGNoZXNJbXBsKGJhc2UsIHBhdGNoZXMpOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvZHVjZSgKICAgICAgYmFzZSwKICAgICAgKGRyYWZ0KSA9PiBhcHBseVBhdGNoZXNJbXBsKGRyYWZ0LCBwYXRjaGVzKQogICAgKTsKICB9Cn07CmZ1bmN0aW9uIGNyZWF0ZVByb3h5Mih2YWx1ZSwgcGFyZW50KSB7CiAgY29uc3QgZHJhZnQgPSBpc01hcDIodmFsdWUpID8gZ2V0UGx1Z2luMigiTWFwU2V0IikucHJveHlNYXBfKHZhbHVlLCBwYXJlbnQpIDogaXNTZXQyKHZhbHVlKSA/IGdldFBsdWdpbjIoIk1hcFNldCIpLnByb3h5U2V0Xyh2YWx1ZSwgcGFyZW50KSA6IGNyZWF0ZVByb3h5UHJveHkyKHZhbHVlLCBwYXJlbnQpOwogIGNvbnN0IHNjb3BlID0gcGFyZW50ID8gcGFyZW50LnNjb3BlXyA6IGdldEN1cnJlbnRTY29wZTIoKTsKICBzY29wZS5kcmFmdHNfLnB1c2goZHJhZnQpOwogIHJldHVybiBkcmFmdDsKfQpmdW5jdGlvbiBjdXJyZW50Mih2YWx1ZSkgewogIGlmICghaXNEcmFmdDIodmFsdWUpKQogICAgZGllMigxMCwgdmFsdWUpOwogIHJldHVybiBjdXJyZW50SW1wbDIodmFsdWUpOwp9CmZ1bmN0aW9uIGN1cnJlbnRJbXBsMih2YWx1ZSkgewogIGlmICghaXNEcmFmdGFibGUyKHZhbHVlKSB8fCBpc0Zyb3plbjIodmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEUyXTsKICBsZXQgY29weTM7CiAgbGV0IHN0cmljdCA9IHRydWU7CiAgaWYgKHN0YXRlKSB7CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykKICAgICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogICAgc3RhdGUuZmluYWxpemVkXyA9IHRydWU7CiAgICBjb3B5MyA9IHNoYWxsb3dDb3B5Mih2YWx1ZSwgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8pOwogICAgc3RyaWN0ID0gc3RhdGUuc2NvcGVfLmltbWVyXy5zaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKTsKICB9IGVsc2UgewogICAgY29weTMgPSBzaGFsbG93Q29weTIodmFsdWUsIHRydWUpOwogIH0KICBlYWNoMigKICAgIGNvcHkzLAogICAgKGtleSwgY2hpbGRWYWx1ZSkgPT4gewogICAgICBzZXQyKGNvcHkzLCBrZXksIGN1cnJlbnRJbXBsMihjaGlsZFZhbHVlKSk7CiAgICB9LAogICAgc3RyaWN0CiAgKTsKICBpZiAoc3RhdGUpIHsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSBmYWxzZTsKICB9CiAgcmV0dXJuIGNvcHkzOwp9CnZhciBpbW1lcjIgPSBuZXcgSW1tZXIyMigpOwp2YXIgcHJvZHVjZTIgPSBpbW1lcjIucHJvZHVjZTsKZnVuY3Rpb24gY2FzdERyYWZ0KHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2xlZ2VuZFNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUyID0gewogIHNldHRpbmdzOiB7CiAgICBsYXlvdXQ6ICJob3Jpem9udGFsIiwKICAgIGFsaWduOiAiY2VudGVyIiwKICAgIHZlcnRpY2FsQWxpZ246ICJtaWRkbGUiLAogICAgaXRlbVNvcnRlcjogInZhbHVlIgogIH0sCiAgc2l6ZTogewogICAgd2lkdGg6IDAsCiAgICBoZWlnaHQ6IDAKICB9LAogIHBheWxvYWQ6IFtdCn07CnZhciBsZWdlbmRTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAibGVnZW5kIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTIsCiAgcmVkdWNlcnM6IHsKICAgIHNldExlZ2VuZFNpemUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zaXplLndpZHRoID0gYWN0aW9uLnBheWxvYWQud2lkdGg7CiAgICAgIHN0YXRlLnNpemUuaGVpZ2h0ID0gYWN0aW9uLnBheWxvYWQuaGVpZ2h0OwogICAgfSwKICAgIHNldExlZ2VuZFNldHRpbmdzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc2V0dGluZ3MuYWxpZ24gPSBhY3Rpb24ucGF5bG9hZC5hbGlnbjsKICAgICAgc3RhdGUuc2V0dGluZ3MubGF5b3V0ID0gYWN0aW9uLnBheWxvYWQubGF5b3V0OwogICAgICBzdGF0ZS5zZXR0aW5ncy52ZXJ0aWNhbEFsaWduID0gYWN0aW9uLnBheWxvYWQudmVydGljYWxBbGlnbjsKICAgICAgc3RhdGUuc2V0dGluZ3MuaXRlbVNvcnRlciA9IGFjdGlvbi5wYXlsb2FkLml0ZW1Tb3J0ZXI7CiAgICB9LAogICAgYWRkTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS5wYXlsb2FkLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZUxlZ2VuZFBheWxvYWQ6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnBheWxvYWQuaW5kZXhPZihjYXN0RHJhZnQocHJldikpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5wYXlsb2FkW2luZGV4XSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5wYXlsb2FkLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBheWxvYWQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRMZWdlbmRTaXplLAogIHNldExlZ2VuZFNldHRpbmdzLAogIGFkZExlZ2VuZFBheWxvYWQsCiAgcmVwbGFjZUxlZ2VuZFBheWxvYWQsCiAgcmVtb3ZlTGVnZW5kUGF5bG9hZAp9ID0gbGVnZW5kU2xpY2UuYWN0aW9uczsKdmFyIGxlZ2VuZFJlZHVjZXIgPSBsZWdlbmRTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcC5qcwp2YXIgUmVhY3QxMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0X2RvbTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3RfZG9tKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvRGVmYXVsdFRvb2x0aXBDb250ZW50LmpzCnZhciBSZWFjdDUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfc29ydEJ5MyA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwpmdW5jdGlvbiBfZXh0ZW5kczQoKSB7CiAgcmV0dXJuIF9leHRlbmRzNCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM1KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czUoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTUoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTUocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5NSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU1KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTUodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGRlZmF1bHRGb3JtYXR0ZXIodmFsdWUpIHsKICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgaXNOdW1PclN0cih2YWx1ZVswXSkgJiYgaXNOdW1PclN0cih2YWx1ZVsxXSkgPyB2YWx1ZS5qb2luKCIgfiAiKSA6IHZhbHVlOwp9CnZhciBEZWZhdWx0VG9vbHRpcENvbnRlbnQgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgc2VwYXJhdG9yID0gIiA6ICIsCiAgICBjb250ZW50U3R5bGUgPSB7fSwKICAgIGl0ZW1TdHlsZSA9IHt9LAogICAgbGFiZWxTdHlsZSA9IHt9LAogICAgcGF5bG9hZCwKICAgIGZvcm1hdHRlciwKICAgIGl0ZW1Tb3J0ZXIsCiAgICB3cmFwcGVyQ2xhc3NOYW1lLAogICAgbGFiZWxDbGFzc05hbWUsCiAgICBsYWJlbCwKICAgIGxhYmVsRm9ybWF0dGVyLAogICAgYWNjZXNzaWJpbGl0eUxheWVyID0gZmFsc2UKICB9ID0gcHJvcHM7CiAgdmFyIHJlbmRlckNvbnRlbnQyID0gKCkgPT4gewogICAgaWYgKHBheWxvYWQgJiYgcGF5bG9hZC5sZW5ndGgpIHsKICAgICAgdmFyIGxpc3RTdHlsZSA9IHsKICAgICAgICBwYWRkaW5nOiAwLAogICAgICAgIG1hcmdpbjogMAogICAgICB9OwogICAgICB2YXIgaXRlbXMgPSAoaXRlbVNvcnRlciA/ICgwLCBpbXBvcnRfc29ydEJ5My5kZWZhdWx0KShwYXlsb2FkLCBpdGVtU29ydGVyKSA6IHBheWxvYWQpLm1hcCgoZW50cnksIGkpID0+IHsKICAgICAgICBpZiAoZW50cnkudHlwZSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGZpbmFsRm9ybWF0dGVyID0gZW50cnkuZm9ybWF0dGVyIHx8IGZvcm1hdHRlciB8fCBkZWZhdWx0Rm9ybWF0dGVyOwogICAgICAgIHZhciB7CiAgICAgICAgICB2YWx1ZSwKICAgICAgICAgIG5hbWUKICAgICAgICB9ID0gZW50cnk7CiAgICAgICAgdmFyIGZpbmFsVmFsdWUgPSB2YWx1ZTsKICAgICAgICB2YXIgZmluYWxOYW1lID0gbmFtZTsKICAgICAgICBpZiAoZmluYWxGb3JtYXR0ZXIpIHsKICAgICAgICAgIHZhciBmb3JtYXR0ZWQgPSBmaW5hbEZvcm1hdHRlcih2YWx1ZSwgbmFtZSwgZW50cnksIGksIHBheWxvYWQpOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm9ybWF0dGVkKSkgewogICAgICAgICAgICBbZmluYWxWYWx1ZSwgZmluYWxOYW1lXSA9IGZvcm1hdHRlZDsKICAgICAgICAgIH0gZWxzZSBpZiAoZm9ybWF0dGVkICE9IG51bGwpIHsKICAgICAgICAgICAgZmluYWxWYWx1ZSA9IGZvcm1hdHRlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmluYWxJdGVtU3R5bGUgPSBfb2JqZWN0U3ByZWFkNSh7CiAgICAgICAgICBkaXNwbGF5OiAiYmxvY2siLAogICAgICAgICAgcGFkZGluZ1RvcDogNCwKICAgICAgICAgIHBhZGRpbmdCb3R0b206IDQsCiAgICAgICAgICBjb2xvcjogZW50cnkuY29sb3IgfHwgIiMwMDAiCiAgICAgICAgfSwgaXRlbVN0eWxlKTsKICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJsaSIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbSIsCiAgICAgICAgICBrZXk6ICJ0b29sdGlwLWl0ZW0tIi5jb25jYXQoaSksCiAgICAgICAgICBzdHlsZTogZmluYWxJdGVtU3R5bGUKICAgICAgICB9LCBpc051bU9yU3RyKGZpbmFsTmFtZSkgPyAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tbmFtZSIKICAgICAgICB9LCBmaW5hbE5hbWUpIDogbnVsbCwgaXNOdW1PclN0cihmaW5hbE5hbWUpID8gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLXNlcGFyYXRvciIKICAgICAgICB9LCBzZXBhcmF0b3IpIDogbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLXZhbHVlIgogICAgICAgIH0sIGZpbmFsVmFsdWUpLCAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tdW5pdCIKICAgICAgICB9LCBlbnRyeS51bml0IHx8ICIiKSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJ1bCIsIHsKICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tbGlzdCIsCiAgICAgICAgc3R5bGU6IGxpc3RTdHlsZQogICAgICB9LCBpdGVtcyk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9OwogIHZhciBmaW5hbFN0eWxlID0gX29iamVjdFNwcmVhZDUoewogICAgbWFyZ2luOiAwLAogICAgcGFkZGluZzogMTAsCiAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjZmZmIiwKICAgIGJvcmRlcjogIjFweCBzb2xpZCAjY2NjIiwKICAgIHdoaXRlU3BhY2U6ICJub3dyYXAiCiAgfSwgY29udGVudFN0eWxlKTsKICB2YXIgZmluYWxMYWJlbFN0eWxlID0gX29iamVjdFNwcmVhZDUoewogICAgbWFyZ2luOiAwCiAgfSwgbGFiZWxTdHlsZSk7CiAgdmFyIGhhc0xhYmVsID0gIWlzTnVsbGlzaChsYWJlbCk7CiAgdmFyIGZpbmFsTGFiZWwgPSBoYXNMYWJlbCA/IGxhYmVsIDogIiI7CiAgdmFyIHdyYXBwZXJDTiA9IGNsc3goInJlY2hhcnRzLWRlZmF1bHQtdG9vbHRpcCIsIHdyYXBwZXJDbGFzc05hbWUpOwogIHZhciBsYWJlbENOID0gY2xzeCgicmVjaGFydHMtdG9vbHRpcC1sYWJlbCIsIGxhYmVsQ2xhc3NOYW1lKTsKICBpZiAoaGFzTGFiZWwgJiYgbGFiZWxGb3JtYXR0ZXIgJiYgcGF5bG9hZCAhPT0gdm9pZCAwICYmIHBheWxvYWQgIT09IG51bGwpIHsKICAgIGZpbmFsTGFiZWwgPSBsYWJlbEZvcm1hdHRlcihsYWJlbCwgcGF5bG9hZCk7CiAgfQogIHZhciBhY2Nlc3NpYmlsaXR5QXR0cmlidXRlcyA9IGFjY2Vzc2liaWxpdHlMYXllciA/IHsKICAgIHJvbGU6ICJzdGF0dXMiLAogICAgImFyaWEtbGl2ZSI6ICJhc3NlcnRpdmUiCiAgfSA6IHt9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoImRpdiIsIF9leHRlbmRzNCh7CiAgICBjbGFzc05hbWU6IHdyYXBwZXJDTiwKICAgIHN0eWxlOiBmaW5hbFN0eWxlCiAgfSwgYWNjZXNzaWJpbGl0eUF0dHJpYnV0ZXMpLCAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInAiLCB7CiAgICBjbGFzc05hbWU6IGxhYmVsQ04sCiAgICBzdHlsZTogZmluYWxMYWJlbFN0eWxlCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5pc1ZhbGlkRWxlbWVudChmaW5hbExhYmVsKSA/IGZpbmFsTGFiZWwgOiAiIi5jb25jYXQoZmluYWxMYWJlbCkpLCByZW5kZXJDb250ZW50MigpKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXBCb3VuZGluZ0JveC5qcwp2YXIgUmVhY3Q2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdG9vbHRpcC90cmFuc2xhdGUuanMKdmFyIENTU19DTEFTU19QUkVGSVggPSAicmVjaGFydHMtdG9vbHRpcC13cmFwcGVyIjsKdmFyIFRPT0xUSVBfSElEREVOID0gewogIHZpc2liaWxpdHk6ICJoaWRkZW4iCn07CmZ1bmN0aW9uIGdldFRvb2x0aXBDU1NDbGFzc05hbWUoX3JlZjIpIHsKICB2YXIgewogICAgY29vcmRpbmF0ZSwKICAgIHRyYW5zbGF0ZVgsCiAgICB0cmFuc2xhdGVZCiAgfSA9IF9yZWYyOwogIHJldHVybiBjbHN4KENTU19DTEFTU19QUkVGSVgsIHsKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi1yaWdodCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWCkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLngpICYmIHRyYW5zbGF0ZVggPj0gY29vcmRpbmF0ZS54LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLWxlZnQiKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVgpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS54KSAmJiB0cmFuc2xhdGVYIDwgY29vcmRpbmF0ZS54LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLWJvdHRvbSIpXTogaXNOdW1iZXIodHJhbnNsYXRlWSkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLnkpICYmIHRyYW5zbGF0ZVkgPj0gY29vcmRpbmF0ZS55LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLXRvcCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWSkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLnkpICYmIHRyYW5zbGF0ZVkgPCBjb29yZGluYXRlLnkKICB9KTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwVHJhbnNsYXRlWFkoX3JlZjIpIHsKICB2YXIgewogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgY29vcmRpbmF0ZSwKICAgIGtleSwKICAgIG9mZnNldFRvcExlZnQsCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB0b29sdGlwRGltZW5zaW9uLAogICAgdmlld0JveCwKICAgIHZpZXdCb3hEaW1lbnNpb24KICB9ID0gX3JlZjI7CiAgaWYgKHBvc2l0aW9uICYmIGlzTnVtYmVyKHBvc2l0aW9uW2tleV0pKSB7CiAgICByZXR1cm4gcG9zaXRpb25ba2V5XTsKICB9CiAgdmFyIG5lZ2F0aXZlID0gY29vcmRpbmF0ZVtrZXldIC0gdG9vbHRpcERpbWVuc2lvbiAtIChvZmZzZXRUb3BMZWZ0ID4gMCA/IG9mZnNldFRvcExlZnQgOiAwKTsKICB2YXIgcG9zaXRpdmUgPSBjb29yZGluYXRlW2tleV0gKyBvZmZzZXRUb3BMZWZ0OwogIGlmIChhbGxvd0VzY2FwZVZpZXdCb3hba2V5XSkgewogICAgcmV0dXJuIHJldmVyc2VEaXJlY3Rpb25ba2V5XSA/IG5lZ2F0aXZlIDogcG9zaXRpdmU7CiAgfQogIHZhciB2aWV3Qm94S2V5ID0gdmlld0JveFtrZXldOwogIGlmICh2aWV3Qm94S2V5ID09IG51bGwpIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAocmV2ZXJzZURpcmVjdGlvbltrZXldKSB7CiAgICB2YXIgX3Rvb2x0aXBCb3VuZGFyeSA9IG5lZ2F0aXZlOwogICAgdmFyIF92aWV3Qm94Qm91bmRhcnkgPSB2aWV3Qm94S2V5OwogICAgaWYgKF90b29sdGlwQm91bmRhcnkgPCBfdmlld0JveEJvdW5kYXJ5KSB7CiAgICAgIHJldHVybiBNYXRoLm1heChwb3NpdGl2ZSwgdmlld0JveEtleSk7CiAgICB9CiAgICByZXR1cm4gTWF0aC5tYXgobmVnYXRpdmUsIHZpZXdCb3hLZXkpOwogIH0KICBpZiAodmlld0JveERpbWVuc2lvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgdmFyIHRvb2x0aXBCb3VuZGFyeSA9IHBvc2l0aXZlICsgdG9vbHRpcERpbWVuc2lvbjsKICB2YXIgdmlld0JveEJvdW5kYXJ5ID0gdmlld0JveEtleSArIHZpZXdCb3hEaW1lbnNpb247CiAgaWYgKHRvb2x0aXBCb3VuZGFyeSA+IHZpZXdCb3hCb3VuZGFyeSkgewogICAgcmV0dXJuIE1hdGgubWF4KG5lZ2F0aXZlLCB2aWV3Qm94S2V5KTsKICB9CiAgcmV0dXJuIE1hdGgubWF4KHBvc2l0aXZlLCB2aWV3Qm94S2V5KTsKfQpmdW5jdGlvbiBnZXRUcmFuc2Zvcm1TdHlsZShfcmVmMykgewogIHZhciB7CiAgICB0cmFuc2xhdGVYLAogICAgdHJhbnNsYXRlWSwKICAgIHVzZVRyYW5zbGF0ZTNkCiAgfSA9IF9yZWYzOwogIHJldHVybiB7CiAgICB0cmFuc2Zvcm06IHVzZVRyYW5zbGF0ZTNkID8gInRyYW5zbGF0ZTNkKCIuY29uY2F0KHRyYW5zbGF0ZVgsICJweCwgIikuY29uY2F0KHRyYW5zbGF0ZVksICJweCwgMCkiKSA6ICJ0cmFuc2xhdGUoIi5jb25jYXQodHJhbnNsYXRlWCwgInB4LCAiKS5jb25jYXQodHJhbnNsYXRlWSwgInB4KSIpCiAgfTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwVHJhbnNsYXRlKF9yZWY0KSB7CiAgdmFyIHsKICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgIGNvb3JkaW5hdGUsCiAgICBvZmZzZXRUb3BMZWZ0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdG9vbHRpcEJveCwKICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgdmlld0JveAogIH0gPSBfcmVmNDsKICB2YXIgY3NzUHJvcGVydGllcywgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWTsKICBpZiAodG9vbHRpcEJveC5oZWlnaHQgPiAwICYmIHRvb2x0aXBCb3gud2lkdGggPiAwICYmIGNvb3JkaW5hdGUpIHsKICAgIHRyYW5zbGF0ZVggPSBnZXRUb29sdGlwVHJhbnNsYXRlWFkoewogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIGtleTogIngiLAogICAgICBvZmZzZXRUb3BMZWZ0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdG9vbHRpcERpbWVuc2lvbjogdG9vbHRpcEJveC53aWR0aCwKICAgICAgdmlld0JveCwKICAgICAgdmlld0JveERpbWVuc2lvbjogdmlld0JveC53aWR0aAogICAgfSk7CiAgICB0cmFuc2xhdGVZID0gZ2V0VG9vbHRpcFRyYW5zbGF0ZVhZKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBrZXk6ICJ5IiwKICAgICAgb2Zmc2V0VG9wTGVmdCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHRvb2x0aXBEaW1lbnNpb246IHRvb2x0aXBCb3guaGVpZ2h0LAogICAgICB2aWV3Qm94LAogICAgICB2aWV3Qm94RGltZW5zaW9uOiB2aWV3Qm94LmhlaWdodAogICAgfSk7CiAgICBjc3NQcm9wZXJ0aWVzID0gZ2V0VHJhbnNmb3JtU3R5bGUoewogICAgICB0cmFuc2xhdGVYLAogICAgICB0cmFuc2xhdGVZLAogICAgICB1c2VUcmFuc2xhdGUzZAogICAgfSk7CiAgfSBlbHNlIHsKICAgIGNzc1Byb3BlcnRpZXMgPSBUT09MVElQX0hJRERFTjsKICB9CiAgcmV0dXJuIHsKICAgIGNzc1Byb3BlcnRpZXMsCiAgICBjc3NDbGFzc2VzOiBnZXRUb29sdGlwQ1NTQ2xhc3NOYW1lKHsKICAgICAgdHJhbnNsYXRlWCwKICAgICAgdHJhbnNsYXRlWSwKICAgICAgY29vcmRpbmF0ZQogICAgfSkKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9Ub29sdGlwQm91bmRpbmdCb3guanMKZnVuY3Rpb24gb3duS2V5czYoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ2KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzNihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5NihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk2KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5NihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk2KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTYodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlNih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFRvb2x0aXBCb3VuZGluZ0JveCA9IGNsYXNzIGV4dGVuZHMgaW1wb3J0X3JlYWN0MTQuUHVyZUNvbXBvbmVudCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlciguLi5hcmd1bWVudHMpOwogICAgX2RlZmluZVByb3BlcnR5Nih0aGlzLCAic3RhdGUiLCB7CiAgICAgIGRpc21pc3NlZDogZmFsc2UsCiAgICAgIGRpc21pc3NlZEF0Q29vcmRpbmF0ZTogewogICAgICAgIHg6IDAsCiAgICAgICAgeTogMAogICAgICB9CiAgICB9KTsKICAgIF9kZWZpbmVQcm9wZXJ0eTYodGhpcywgImhhbmRsZUtleURvd24iLCAoZXZlbnQpID0+IHsKICAgICAgaWYgKGV2ZW50LmtleSA9PT0gIkVzY2FwZSIpIHsKICAgICAgICB2YXIgX3RoaXMkcHJvcHMkY29vcmRpbmF0LCBfdGhpcyRwcm9wcyRjb29yZGluYXQyLCBfdGhpcyRwcm9wcyRjb29yZGluYXQzLCBfdGhpcyRwcm9wcyRjb29yZGluYXQ0OwogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgZGlzbWlzc2VkOiB0cnVlLAogICAgICAgICAgZGlzbWlzc2VkQXRDb29yZGluYXRlOiB7CiAgICAgICAgICAgIHg6IChfdGhpcyRwcm9wcyRjb29yZGluYXQgPSAoX3RoaXMkcHJvcHMkY29vcmRpbmF0MiA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0MiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0Mi54KSAhPT0gbnVsbCAmJiBfdGhpcyRwcm9wcyRjb29yZGluYXQgIT09IHZvaWQgMCA/IF90aGlzJHByb3BzJGNvb3JkaW5hdCA6IDAsCiAgICAgICAgICAgIHk6IChfdGhpcyRwcm9wcyRjb29yZGluYXQzID0gKF90aGlzJHByb3BzJGNvb3JkaW5hdDQgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDQueSkgIT09IG51bGwgJiYgX3RoaXMkcHJvcHMkY29vcmRpbmF0MyAhPT0gdm9pZCAwID8gX3RoaXMkcHJvcHMkY29vcmRpbmF0MyA6IDAKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQogIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuaGFuZGxlS2V5RG93bik7CiAgfQogIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuaGFuZGxlS2V5RG93bik7CiAgfQogIGNvbXBvbmVudERpZFVwZGF0ZSgpIHsKICAgIHZhciBfdGhpcyRwcm9wcyRjb29yZGluYXQ1LCBfdGhpcyRwcm9wcyRjb29yZGluYXQ2OwogICAgaWYgKCF0aGlzLnN0YXRlLmRpc21pc3NlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoKChfdGhpcyRwcm9wcyRjb29yZGluYXQ1ID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQ1ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQ1LngpICE9PSB0aGlzLnN0YXRlLmRpc21pc3NlZEF0Q29vcmRpbmF0ZS54IHx8ICgoX3RoaXMkcHJvcHMkY29vcmRpbmF0NiA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0Ni55KSAhPT0gdGhpcy5zdGF0ZS5kaXNtaXNzZWRBdENvb3JkaW5hdGUueSkgewogICAgICB0aGlzLnN0YXRlLmRpc21pc3NlZCA9IGZhbHNlOwogICAgfQogIH0KICByZW5kZXIoKSB7CiAgICB2YXIgewogICAgICBhY3RpdmUsCiAgICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICAgIGFuaW1hdGlvbkVhc2luZywKICAgICAgY2hpbGRyZW4sCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIGhhc1BheWxvYWQsCiAgICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgICBvZmZzZXQsCiAgICAgIHBvc2l0aW9uLAogICAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgICB1c2VUcmFuc2xhdGUzZCwKICAgICAgdmlld0JveCwKICAgICAgd3JhcHBlclN0eWxlLAogICAgICBsYXN0Qm91bmRpbmdCb3gsCiAgICAgIGlubmVyUmVmLAogICAgICBoYXNQb3J0YWxGcm9tUHJvcHMKICAgIH0gPSB0aGlzLnByb3BzOwogICAgdmFyIHsKICAgICAgY3NzQ2xhc3NlcywKICAgICAgY3NzUHJvcGVydGllcwogICAgfSA9IGdldFRvb2x0aXBUcmFuc2xhdGUoewogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIG9mZnNldFRvcExlZnQ6IG9mZnNldCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHRvb2x0aXBCb3g6IHsKICAgICAgICBoZWlnaHQ6IGxhc3RCb3VuZGluZ0JveC5oZWlnaHQsCiAgICAgICAgd2lkdGg6IGxhc3RCb3VuZGluZ0JveC53aWR0aAogICAgICB9LAogICAgICB1c2VUcmFuc2xhdGUzZCwKICAgICAgdmlld0JveAogICAgfSk7CiAgICB2YXIgcG9zaXRpb25TdHlsZXMgPSBoYXNQb3J0YWxGcm9tUHJvcHMgPyB7fSA6IF9vYmplY3RTcHJlYWQ2KF9vYmplY3RTcHJlYWQ2KHsKICAgICAgdHJhbnNpdGlvbjogaXNBbmltYXRpb25BY3RpdmUgJiYgYWN0aXZlID8gInRyYW5zZm9ybSAiLmNvbmNhdChhbmltYXRpb25EdXJhdGlvbiwgIm1zICIpLmNvbmNhdChhbmltYXRpb25FYXNpbmcpIDogdm9pZCAwCiAgICB9LCBjc3NQcm9wZXJ0aWVzKSwge30sIHsKICAgICAgcG9pbnRlckV2ZW50czogIm5vbmUiLAogICAgICB2aXNpYmlsaXR5OiAhdGhpcy5zdGF0ZS5kaXNtaXNzZWQgJiYgYWN0aXZlICYmIGhhc1BheWxvYWQgPyAidmlzaWJsZSIgOiAiaGlkZGVuIiwKICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgIHRvcDogMCwKICAgICAgbGVmdDogMAogICAgfSk7CiAgICB2YXIgb3V0ZXJTdHlsZSA9IF9vYmplY3RTcHJlYWQ2KF9vYmplY3RTcHJlYWQ2KHt9LCBwb3NpdGlvblN0eWxlcyksIHt9LCB7CiAgICAgIHZpc2liaWxpdHk6ICF0aGlzLnN0YXRlLmRpc21pc3NlZCAmJiBhY3RpdmUgJiYgaGFzUGF5bG9hZCA/ICJ2aXNpYmxlIiA6ICJoaWRkZW4iCiAgICB9LCB3cmFwcGVyU3R5bGUpOwogICAgcmV0dXJuICgKICAgICAgLy8gVGhpcyBlbGVtZW50IGFsbG93IGxpc3RlbmluZyB0byB0aGUgYEVzY2FwZWAga2V5LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3JlY2hhcnRzL3JlY2hhcnRzL3B1bGwvMjkyNQogICAgICAvKiBAX19QVVJFX18gKi8gUmVhY3Q2LmNyZWF0ZUVsZW1lbnQoImRpdiIsIHsKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHR5cGVzY3JpcHQgbGlicmFyeSBkb2VzIG5vdCByZWNvZ25pemUgeG1sbnMgYXR0cmlidXRlLCBidXQgaXQncyByZXF1aXJlZCBmb3IgYW4gSFRNTCBjaHVuayBpbnNpZGUgU1ZHLgogICAgICAgIHhtbG5zOiAiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIsCiAgICAgICAgdGFiSW5kZXg6IC0xLAogICAgICAgIGNsYXNzTmFtZTogY3NzQ2xhc3NlcywKICAgICAgICBzdHlsZTogb3V0ZXJTdHlsZSwKICAgICAgICByZWY6IGlubmVyUmVmCiAgICAgIH0sIGNoaWxkcmVuKQogICAgKTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvYWNjZXNzaWJpbGl0eUNvbnRleHQuanMKdmFyIHVzZUFjY2Vzc2liaWxpdHlMYXllciA9ICgpID0+IHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yOwogIHJldHVybiAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuYWNjZXNzaWJpbGl0eUxheWVyKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IgOiB0cnVlOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQ3Vyc29yLmpzCnZhciBSZWFjdDExID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL0N1cnZlLmpzCnZhciBSZWFjdDcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIF9leHRlbmRzNSgpIHsKICByZXR1cm4gX2V4dGVuZHM1ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM1LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czcoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzNyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5NyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk3KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5NyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk3KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTcodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlNyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIENVUlZFX0ZBQ1RPUklFUyA9IHsKICBjdXJ2ZUJhc2lzQ2xvc2VkOiBiYXNpc0Nsb3NlZF9kZWZhdWx0LAogIGN1cnZlQmFzaXNPcGVuOiBiYXNpc09wZW5fZGVmYXVsdCwKICBjdXJ2ZUJhc2lzOiBiYXNpc19kZWZhdWx0LAogIGN1cnZlQnVtcFg6IGJ1bXBYLAogIGN1cnZlQnVtcFk6IGJ1bXBZLAogIGN1cnZlTGluZWFyQ2xvc2VkOiBsaW5lYXJDbG9zZWRfZGVmYXVsdCwKICBjdXJ2ZUxpbmVhcjogbGluZWFyX2RlZmF1bHQsCiAgY3VydmVNb25vdG9uZVg6IG1vbm90b25lWCwKICBjdXJ2ZU1vbm90b25lWTogbW9ub3RvbmVZLAogIGN1cnZlTmF0dXJhbDogbmF0dXJhbF9kZWZhdWx0LAogIGN1cnZlU3RlcDogc3RlcF9kZWZhdWx0LAogIGN1cnZlU3RlcEFmdGVyOiBzdGVwQWZ0ZXIsCiAgY3VydmVTdGVwQmVmb3JlOiBzdGVwQmVmb3JlCn07CnZhciBkZWZpbmVkID0gKHApID0+IGlzV2VsbEJlaGF2ZWROdW1iZXIocC54KSAmJiBpc1dlbGxCZWhhdmVkTnVtYmVyKHAueSk7CnZhciBhcmVhRGVmaW5lZCA9IChkKSA9PiBkLmJhc2UgIT0gbnVsbCAmJiBkZWZpbmVkKGQuYmFzZSkgJiYgZGVmaW5lZChkKTsKdmFyIGdldFggPSAocCkgPT4gcC54Owp2YXIgZ2V0WSA9IChwKSA9PiBwLnk7CnZhciBnZXRDdXJ2ZUZhY3RvcnkgPSAodHlwZSwgbGF5b3V0KSA9PiB7CiAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gdHlwZTsKICB9CiAgdmFyIG5hbWUgPSAiY3VydmUiLmNvbmNhdCh1cHBlckZpcnN0KHR5cGUpKTsKICBpZiAoKG5hbWUgPT09ICJjdXJ2ZU1vbm90b25lIiB8fCBuYW1lID09PSAiY3VydmVCdW1wIikgJiYgbGF5b3V0KSB7CiAgICByZXR1cm4gQ1VSVkVfRkFDVE9SSUVTWyIiLmNvbmNhdChuYW1lKS5jb25jYXQobGF5b3V0ID09PSAidmVydGljYWwiID8gIlkiIDogIlgiKV07CiAgfQogIHJldHVybiBDVVJWRV9GQUNUT1JJRVNbbmFtZV0gfHwgbGluZWFyX2RlZmF1bHQ7Cn07CnZhciBnZXRQYXRoID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHR5cGUgPSAibGluZWFyIiwKICAgIHBvaW50cyA9IFtdLAogICAgYmFzZUxpbmUsCiAgICBsYXlvdXQsCiAgICBjb25uZWN0TnVsbHMgPSBmYWxzZQogIH0gPSBfcmVmMjsKICB2YXIgY3VydmVGYWN0b3J5ID0gZ2V0Q3VydmVGYWN0b3J5KHR5cGUsIGxheW91dCk7CiAgdmFyIGZvcm1hdFBvaW50cyA9IGNvbm5lY3ROdWxscyA/IHBvaW50cy5maWx0ZXIoZGVmaW5lZCkgOiBwb2ludHM7CiAgdmFyIGxpbmVGdW5jdGlvbjsKICBpZiAoQXJyYXkuaXNBcnJheShiYXNlTGluZSkpIHsKICAgIHZhciBhcmVhUG9pbnRzID0gcG9pbnRzLm1hcCgoZW50cnksIGluZGV4KSA9PiBfb2JqZWN0U3ByZWFkNyhfb2JqZWN0U3ByZWFkNyh7fSwgZW50cnkpLCB7fSwgewogICAgICBiYXNlOiBiYXNlTGluZVtpbmRleF0KICAgIH0pKTsKICAgIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgICAgbGluZUZ1bmN0aW9uID0gYXJlYV9kZWZhdWx0KCkueShnZXRZKS54MShnZXRYKS54MCgoZCkgPT4gZC5iYXNlLngpOwogICAgfSBlbHNlIHsKICAgICAgbGluZUZ1bmN0aW9uID0gYXJlYV9kZWZhdWx0KCkueChnZXRYKS55MShnZXRZKS55MCgoZCkgPT4gZC5iYXNlLnkpOwogICAgfQogICAgdmFyIF9udWxsYWJsZUxpbmVGdW5jdGlvbiA9IGxpbmVGdW5jdGlvbi5kZWZpbmVkKGFyZWFEZWZpbmVkKS5jdXJ2ZShjdXJ2ZUZhY3RvcnkpOwogICAgdmFyIGZpbmFsUG9pbnRzID0gY29ubmVjdE51bGxzID8gYXJlYVBvaW50cy5maWx0ZXIoYXJlYURlZmluZWQpIDogYXJlYVBvaW50czsKICAgIHJldHVybiBfbnVsbGFibGVMaW5lRnVuY3Rpb24oZmluYWxQb2ludHMpOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiICYmIGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgbGluZUZ1bmN0aW9uID0gYXJlYV9kZWZhdWx0KCkueShnZXRZKS54MShnZXRYKS54MChiYXNlTGluZSk7CiAgfSBlbHNlIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLngoZ2V0WCkueTEoZ2V0WSkueTAoYmFzZUxpbmUpOwogIH0gZWxzZSB7CiAgICBsaW5lRnVuY3Rpb24gPSBsaW5lX2RlZmF1bHQoKS54KGdldFgpLnkoZ2V0WSk7CiAgfQogIHZhciBudWxsYWJsZUxpbmVGdW5jdGlvbiA9IGxpbmVGdW5jdGlvbi5kZWZpbmVkKGRlZmluZWQpLmN1cnZlKGN1cnZlRmFjdG9yeSk7CiAgcmV0dXJuIG51bGxhYmxlTGluZUZ1bmN0aW9uKGZvcm1hdFBvaW50cyk7Cn07CnZhciBDdXJ2ZSA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBjbGFzc05hbWUsCiAgICBwb2ludHMsCiAgICBwYXRoOiBwYXRoMiwKICAgIHBhdGhSZWYKICB9ID0gcHJvcHM7CiAgaWYgKCghcG9pbnRzIHx8ICFwb2ludHMubGVuZ3RoKSAmJiAhcGF0aDIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcmVhbFBhdGggPSBwb2ludHMgJiYgcG9pbnRzLmxlbmd0aCA/IGdldFBhdGgocHJvcHMpIDogcGF0aDI7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDcuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzNSh7fSwgc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKSwgYWRhcHRFdmVudEhhbmRsZXJzKHByb3BzKSwgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jdXJ2ZSIsIGNsYXNzTmFtZSksCiAgICBkOiByZWFsUGF0aCA9PT0gbnVsbCA/IHZvaWQgMCA6IHJlYWxQYXRoLAogICAgcmVmOiBwYXRoUmVmCiAgfSkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9Dcm9zcy5qcwp2YXIgUmVhY3Q4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMyA9IFsieCIsICJ5IiwgInRvcCIsICJsZWZ0IiwgIndpZHRoIiwgImhlaWdodCIsICJjbGFzc05hbWUiXTsKZnVuY3Rpb24gX2V4dGVuZHM2KCkgewogIHJldHVybiBfZXh0ZW5kczYgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczYuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzOChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDgoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM4KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk4KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czgoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk4KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTgodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU4KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMzKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UzKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UzKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgZ2V0UGF0aDIgPSAoeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCB0b3AsIGxlZnQpID0+IHsKICByZXR1cm4gIk0iLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQodG9wLCAidiIpLmNvbmNhdChoZWlnaHQsICJNIikuY29uY2F0KGxlZnQsICIsIikuY29uY2F0KHkyLCAiaCIpLmNvbmNhdCh3aWR0aCk7Cn07CnZhciBDcm9zcyA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB4OiB4MiA9IDAsCiAgICB5OiB5MiA9IDAsCiAgICB0b3AgPSAwLAogICAgbGVmdCA9IDAsCiAgICB3aWR0aCA9IDAsCiAgICBoZWlnaHQgPSAwLAogICAgY2xhc3NOYW1lCiAgfSA9IF9yZWYyLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMyhfcmVmMiwgX2V4Y2x1ZGVkMyk7CiAgdmFyIHByb3BzID0gX29iamVjdFNwcmVhZDgoewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHRvcCwKICAgIGxlZnQsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0sIHJlc3QpOwogIGlmICghaXNOdW1iZXIoeDIpIHx8ICFpc051bWJlcih5MikgfHwgIWlzTnVtYmVyKHdpZHRoKSB8fCAhaXNOdW1iZXIoaGVpZ2h0KSB8fCAhaXNOdW1iZXIodG9wKSB8fCAhaXNOdW1iZXIobGVmdCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0OC5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM2KHt9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jcm9zcyIsIGNsYXNzTmFtZSksCiAgICBkOiBnZXRQYXRoMih4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHRvcCwgbGVmdCkKICB9KSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvY3Vyc29yL2dldEN1cnNvclJlY3RhbmdsZS5qcwpmdW5jdGlvbiBnZXRDdXJzb3JSZWN0YW5nbGUobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQsIHRvb2x0aXBBeGlzQmFuZFNpemUpIHsKICB2YXIgaGFsZlNpemUgPSB0b29sdGlwQXhpc0JhbmRTaXplIC8gMjsKICByZXR1cm4gewogICAgc3Ryb2tlOiAibm9uZSIsCiAgICBmaWxsOiAiI2NjYyIsCiAgICB4OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IGFjdGl2ZUNvb3JkaW5hdGUueCAtIGhhbGZTaXplIDogb2Zmc2V0LmxlZnQgKyAwLjUsCiAgICB5OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IG9mZnNldC50b3AgKyAwLjUgOiBhY3RpdmVDb29yZGluYXRlLnkgLSBoYWxmU2l6ZSwKICAgIHdpZHRoOiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHRvb2x0aXBBeGlzQmFuZFNpemUgOiBvZmZzZXQud2lkdGggLSAxLAogICAgaGVpZ2h0OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IG9mZnNldC5oZWlnaHQgLSAxIDogdG9vbHRpcEF4aXNCYW5kU2l6ZQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvUmVjdGFuZ2xlLmpzCnZhciBSZWFjdDkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QxOCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL0phdmFzY3JpcHRBbmltYXRlLmpzCnZhciBpbXBvcnRfcmVhY3QxNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL3V0aWwuanMKZnVuY3Rpb24gb3duS2V5czkoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ5KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzOShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5OShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM5KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5OShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlOSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGdldERhc2hDYXNlID0gKG5hbWUpID0+IG5hbWUucmVwbGFjZSgvKFtBLVpdKS9nLCAodikgPT4gIi0iLmNvbmNhdCh2LnRvTG93ZXJDYXNlKCkpKTsKdmFyIGdldFRyYW5zaXRpb25WYWwgPSAocHJvcHMsIGR1cmF0aW9uLCBlYXNpbmcpID0+IHByb3BzLm1hcCgocHJvcCkgPT4gIiIuY29uY2F0KGdldERhc2hDYXNlKHByb3ApLCAiICIpLmNvbmNhdChkdXJhdGlvbiwgIm1zICIpLmNvbmNhdChlYXNpbmcpKS5qb2luKCIsIik7CnZhciBnZXRJbnRlcnNlY3Rpb25LZXlzID0gKHByZU9iaiwgbmV4dE9iaikgPT4gW09iamVjdC5rZXlzKHByZU9iaiksIE9iamVjdC5rZXlzKG5leHRPYmopXS5yZWR1Y2UoKGEsIGIpID0+IGEuZmlsdGVyKChjKSA9PiBiLmluY2x1ZGVzKGMpKSk7CnZhciBtYXBPYmplY3QgPSAoZm4sIG9iaikgPT4gT2JqZWN0LmtleXMob2JqKS5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkOShfb2JqZWN0U3ByZWFkOSh7fSwgcmVzKSwge30sIHsKICBba2V5XTogZm4oa2V5LCBvYmpba2V5XSkKfSksIHt9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL2NvbmZpZ1VwZGF0ZS5qcwpmdW5jdGlvbiBvd25LZXlzMTAoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxMChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czEwKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxMChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxMChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTAoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxMChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxMCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxMCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxMCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGFscGhhID0gKGJlZ2luLCBlbmQsIGspID0+IGJlZ2luICsgKGVuZCAtIGJlZ2luKSAqIGs7CnZhciBuZWVkQ29udGludWUgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgZnJvbTogZnJvbTIsCiAgICB0bzogdG8yCiAgfSA9IF9yZWYyOwogIHJldHVybiBmcm9tMiAhPT0gdG8yOwp9Owp2YXIgY2FsU3RlcHBlclZhbHMgPSAoZWFzaW5nLCBwcmVWYWxzLCBzdGVwcykgPT4gewogIHZhciBuZXh0U3RlcFZhbHMgPSBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiB7CiAgICBpZiAobmVlZENvbnRpbnVlKHZhbCkpIHsKICAgICAgdmFyIFtuZXdYLCBuZXdWXSA9IGVhc2luZyh2YWwuZnJvbSwgdmFsLnRvLCB2YWwudmVsb2NpdHkpOwogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgdmFsKSwge30sIHsKICAgICAgICBmcm9tOiBuZXdYLAogICAgICAgIHZlbG9jaXR5OiBuZXdWCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHZhbDsKICB9LCBwcmVWYWxzKTsKICBpZiAoc3RlcHMgPCAxKSB7CiAgICByZXR1cm4gbWFwT2JqZWN0KChrZXksIHZhbCkgPT4gewogICAgICBpZiAobmVlZENvbnRpbnVlKHZhbCkpIHsKICAgICAgICByZXR1cm4gX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgdmFsKSwge30sIHsKICAgICAgICAgIHZlbG9jaXR5OiBhbHBoYSh2YWwudmVsb2NpdHksIG5leHRTdGVwVmFsc1trZXldLnZlbG9jaXR5LCBzdGVwcyksCiAgICAgICAgICBmcm9tOiBhbHBoYSh2YWwuZnJvbSwgbmV4dFN0ZXBWYWxzW2tleV0uZnJvbSwgc3RlcHMpCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbDsKICAgIH0sIHByZVZhbHMpOwogIH0KICByZXR1cm4gY2FsU3RlcHBlclZhbHMoZWFzaW5nLCBuZXh0U3RlcFZhbHMsIHN0ZXBzIC0gMSk7Cn07CmZ1bmN0aW9uIGNyZWF0ZVN0ZXBwZXJVcGRhdGUoZnJvbTIsIHRvMiwgZWFzaW5nLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpIHsKICB2YXIgcHJlVGltZTsKICB2YXIgc3RlcHBlclN0eWxlID0gaW50ZXJLZXlzLnJlZHVjZSgocmVzLCBrZXkpID0+IF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHJlcyksIHt9LCB7CiAgICBba2V5XTogewogICAgICBmcm9tOiBmcm9tMltrZXldLAogICAgICB2ZWxvY2l0eTogMCwKICAgICAgdG86IHRvMltrZXldCiAgICB9CiAgfSksIHt9KTsKICB2YXIgZ2V0Q3VyclN0eWxlID0gKCkgPT4gbWFwT2JqZWN0KChrZXksIHZhbCkgPT4gdmFsLmZyb20sIHN0ZXBwZXJTdHlsZSk7CiAgdmFyIHNob3VsZFN0b3BBbmltYXRpb24gPSAoKSA9PiAhT2JqZWN0LnZhbHVlcyhzdGVwcGVyU3R5bGUpLmZpbHRlcihuZWVkQ29udGludWUpLmxlbmd0aDsKICB2YXIgc3RvcEFuaW1hdGlvbiA9IG51bGw7CiAgdmFyIHN0ZXBwZXJVcGRhdGUgPSAobm93KSA9PiB7CiAgICBpZiAoIXByZVRpbWUpIHsKICAgICAgcHJlVGltZSA9IG5vdzsKICAgIH0KICAgIHZhciBkZWx0YVRpbWUgPSBub3cgLSBwcmVUaW1lOwogICAgdmFyIHN0ZXBzID0gZGVsdGFUaW1lIC8gZWFzaW5nLmR0OwogICAgc3RlcHBlclN0eWxlID0gY2FsU3RlcHBlclZhbHMoZWFzaW5nLCBzdGVwcGVyU3R5bGUsIHN0ZXBzKTsKICAgIHJlbmRlcihfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgZnJvbTIpLCB0bzIpLCBnZXRDdXJyU3R5bGUoKSkpOwogICAgcHJlVGltZSA9IG5vdzsKICAgIGlmICghc2hvdWxkU3RvcEFuaW1hdGlvbigpKSB7CiAgICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHN0ZXBwZXJVcGRhdGUpOwogICAgfQogIH07CiAgcmV0dXJuICgpID0+IHsKICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHN0ZXBwZXJVcGRhdGUpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgdmFyIF9zdG9wQW5pbWF0aW9uOwogICAgICAoX3N0b3BBbmltYXRpb24gPSBzdG9wQW5pbWF0aW9uKSA9PT0gbnVsbCB8fCBfc3RvcEFuaW1hdGlvbiA9PT0gdm9pZCAwIHx8IF9zdG9wQW5pbWF0aW9uKCk7CiAgICB9OwogIH07Cn0KZnVuY3Rpb24gY3JlYXRlVGltaW5nVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgZHVyYXRpb24sIGludGVyS2V5cywgcmVuZGVyLCB0aW1lb3V0Q29udHJvbGxlcikgewogIHZhciBzdG9wQW5pbWF0aW9uID0gbnVsbDsKICB2YXIgdGltaW5nU3R5bGUgPSBpbnRlcktleXMucmVkdWNlKChyZXMsIGtleSkgPT4gX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgcmVzKSwge30sIHsKICAgIFtrZXldOiBbZnJvbTJba2V5XSwgdG8yW2tleV1dCiAgfSksIHt9KTsKICB2YXIgYmVnaW5UaW1lOwogIHZhciB0aW1pbmdVcGRhdGUgPSAobm93KSA9PiB7CiAgICBpZiAoIWJlZ2luVGltZSkgewogICAgICBiZWdpblRpbWUgPSBub3c7CiAgICB9CiAgICB2YXIgdCA9IChub3cgLSBiZWdpblRpbWUpIC8gZHVyYXRpb247CiAgICB2YXIgY3VyclN0eWxlID0gbWFwT2JqZWN0KChrZXksIHZhbCkgPT4gYWxwaGEoLi4udmFsLCBlYXNpbmcodCkpLCB0aW1pbmdTdHlsZSk7CiAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIGZyb20yKSwgdG8yKSwgY3VyclN0eWxlKSk7CiAgICBpZiAodCA8IDEpIHsKICAgICAgc3RvcEFuaW1hdGlvbiA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQodGltaW5nVXBkYXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBmaW5hbFN0eWxlID0gbWFwT2JqZWN0KChrZXksIHZhbCkgPT4gYWxwaGEoLi4udmFsLCBlYXNpbmcoMSkpLCB0aW1pbmdTdHlsZSk7CiAgICAgIHJlbmRlcihfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgZnJvbTIpLCB0bzIpLCBmaW5hbFN0eWxlKSk7CiAgICB9CiAgfTsKICByZXR1cm4gKCkgPT4gewogICAgc3RvcEFuaW1hdGlvbiA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQodGltaW5nVXBkYXRlKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBfc3RvcEFuaW1hdGlvbjI7CiAgICAgIChfc3RvcEFuaW1hdGlvbjIgPSBzdG9wQW5pbWF0aW9uKSA9PT0gbnVsbCB8fCBfc3RvcEFuaW1hdGlvbjIgPT09IHZvaWQgMCB8fCBfc3RvcEFuaW1hdGlvbjIoKTsKICAgIH07CiAgfTsKfQp2YXIgY29uZmlnVXBkYXRlX2RlZmF1bHQgPSAoZnJvbTIsIHRvMiwgZWFzaW5nLCBkdXJhdGlvbiwgcmVuZGVyLCB0aW1lb3V0Q29udHJvbGxlcikgPT4gewogIHZhciBpbnRlcktleXMgPSBnZXRJbnRlcnNlY3Rpb25LZXlzKGZyb20yLCB0bzIpOwogIGlmIChlYXNpbmcgPT0gbnVsbCkgewogICAgcmV0dXJuICgpID0+IHsKICAgICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIGZyb20yKSwgdG8yKSk7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgIH07CiAgICB9OwogIH0KICByZXR1cm4gZWFzaW5nLmlzU3RlcHBlciA9PT0gdHJ1ZSA/IGNyZWF0ZVN0ZXBwZXJVcGRhdGUoZnJvbTIsIHRvMiwgZWFzaW5nLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpIDogY3JlYXRlVGltaW5nVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgZHVyYXRpb24sIGludGVyS2V5cywgcmVuZGVyLCB0aW1lb3V0Q29udHJvbGxlcik7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9lYXNpbmcuanMKdmFyIEFDQ1VSQUNZID0gMWUtNDsKdmFyIGN1YmljQmV6aWVyRmFjdG9yID0gKGMxLCBjMikgPT4gWzAsIDMgKiBjMSwgMyAqIGMyIC0gNiAqIGMxLCAzICogYzEgLSAzICogYzIgKyAxXTsKdmFyIGV2YWx1YXRlUG9seW5vbWlhbCA9IChwYXJhbXMsIHQpID0+IHBhcmFtcy5tYXAoKHBhcmFtLCBpKSA9PiBwYXJhbSAqIHQgKiogaSkucmVkdWNlKChwcmUsIGN1cnIpID0+IHByZSArIGN1cnIpOwp2YXIgY3ViaWNCZXppZXIgPSAoYzEsIGMyKSA9PiAodCkgPT4gewogIHZhciBwYXJhbXMgPSBjdWJpY0JlemllckZhY3RvcihjMSwgYzIpOwogIHJldHVybiBldmFsdWF0ZVBvbHlub21pYWwocGFyYW1zLCB0KTsKfTsKdmFyIGRlcml2YXRpdmVDdWJpY0JlemllciA9IChjMSwgYzIpID0+ICh0KSA9PiB7CiAgdmFyIHBhcmFtcyA9IGN1YmljQmV6aWVyRmFjdG9yKGMxLCBjMik7CiAgdmFyIG5ld1BhcmFtcyA9IFsuLi5wYXJhbXMubWFwKChwYXJhbSwgaSkgPT4gcGFyYW0gKiBpKS5zbGljZSgxKSwgMF07CiAgcmV0dXJuIGV2YWx1YXRlUG9seW5vbWlhbChuZXdQYXJhbXMsIHQpOwp9Owp2YXIgZ2V0QmV6aWVyQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbiBnZXRCZXppZXJDb29yZGluYXRlczIoKSB7CiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogIH0KICBpZiAoYXJncy5sZW5ndGggPT09IDEpIHsKICAgIHN3aXRjaCAoYXJnc1swXSkgewogICAgICBjYXNlICJsaW5lYXIiOgogICAgICAgIHJldHVybiBbMCwgMCwgMSwgMV07CiAgICAgIGNhc2UgImVhc2UiOgogICAgICAgIHJldHVybiBbMC4yNSwgMC4xLCAwLjI1LCAxXTsKICAgICAgY2FzZSAiZWFzZS1pbiI6CiAgICAgICAgcmV0dXJuIFswLjQyLCAwLCAxLCAxXTsKICAgICAgY2FzZSAiZWFzZS1vdXQiOgogICAgICAgIHJldHVybiBbMC40MiwgMCwgMC41OCwgMV07CiAgICAgIGNhc2UgImVhc2UtaW4tb3V0IjoKICAgICAgICByZXR1cm4gWzAsIDAsIDAuNTgsIDFdOwogICAgICBkZWZhdWx0OiB7CiAgICAgICAgdmFyIF9lYXNpbmckOwogICAgICAgIHZhciBlYXNpbmcgPSBhcmdzWzBdLnNwbGl0KCIoIik7CiAgICAgICAgaWYgKGVhc2luZ1swXSA9PT0gImN1YmljLWJlemllciIgJiYgKChfZWFzaW5nJCA9IGVhc2luZ1sxXSkgPT09IG51bGwgfHwgX2Vhc2luZyQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lYXNpbmckLnNwbGl0KCIpIilbMF0uc3BsaXQoIiwiKS5sZW5ndGgpID09PSA0KSB7CiAgICAgICAgICB2YXIgY29vcmRzID0gZWFzaW5nWzFdLnNwbGl0KCIpIilbMF0uc3BsaXQoIiwiKS5tYXAoKHgyKSA9PiBwYXJzZUZsb2F0KHgyKSk7CiAgICAgICAgICByZXR1cm4gW2Nvb3Jkc1swXSwgY29vcmRzWzFdLCBjb29yZHNbMl0sIGNvb3Jkc1szXV07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGlmIChhcmdzLmxlbmd0aCA9PT0gNCkgewogICAgcmV0dXJuIGFyZ3M7CiAgfQogIHJldHVybiBbMCwgMCwgMSwgMV07Cn07CnZhciBjcmVhdGVCZXppZXJFYXNpbmcgPSAoeDEsIHkxLCB4MiwgeTIpID0+IHsKICB2YXIgY3VydmVYID0gY3ViaWNCZXppZXIoeDEsIHgyKTsKICB2YXIgY3VydmVZID0gY3ViaWNCZXppZXIoeTEsIHkyKTsKICB2YXIgZGVyQ3VydmVYID0gZGVyaXZhdGl2ZUN1YmljQmV6aWVyKHgxLCB4Mik7CiAgdmFyIHJhbmdlVmFsdWUgPSAodmFsdWUpID0+IHsKICAgIGlmICh2YWx1ZSA+IDEpIHsKICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICBpZiAodmFsdWUgPCAwKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH07CiAgdmFyIGJlemllciA9IChfdCkgPT4gewogICAgdmFyIHQgPSBfdCA+IDEgPyAxIDogX3Q7CiAgICB2YXIgeDMgPSB0OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyArK2kpIHsKICAgICAgdmFyIGV2YWxUID0gY3VydmVYKHgzKSAtIHQ7CiAgICAgIHZhciBkZXJWYWwgPSBkZXJDdXJ2ZVgoeDMpOwogICAgICBpZiAoTWF0aC5hYnMoZXZhbFQgLSB0KSA8IEFDQ1VSQUNZIHx8IGRlclZhbCA8IEFDQ1VSQUNZKSB7CiAgICAgICAgcmV0dXJuIGN1cnZlWSh4Myk7CiAgICAgIH0KICAgICAgeDMgPSByYW5nZVZhbHVlKHgzIC0gZXZhbFQgLyBkZXJWYWwpOwogICAgfQogICAgcmV0dXJuIGN1cnZlWSh4Myk7CiAgfTsKICBiZXppZXIuaXNTdGVwcGVyID0gZmFsc2U7CiAgcmV0dXJuIGJlemllcjsKfTsKdmFyIGNvbmZpZ0JlemllciA9IGZ1bmN0aW9uIGNvbmZpZ0JlemllcjIoKSB7CiAgcmV0dXJuIGNyZWF0ZUJlemllckVhc2luZyguLi5nZXRCZXppZXJDb29yZGluYXRlcyguLi5hcmd1bWVudHMpKTsKfTsKdmFyIGNvbmZpZ1NwcmluZyA9IGZ1bmN0aW9uIGNvbmZpZ1NwcmluZzIoKSB7CiAgdmFyIGNvbmZpZyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzBdIDoge307CiAgdmFyIHsKICAgIHN0aWZmID0gMTAwLAogICAgZGFtcGluZyA9IDgsCiAgICBkdCA9IDE3CiAgfSA9IGNvbmZpZzsKICB2YXIgc3RlcHBlciA9IChjdXJyWCwgZGVzdFgsIGN1cnJWKSA9PiB7CiAgICB2YXIgRlNwcmluZyA9IC0oY3VyclggLSBkZXN0WCkgKiBzdGlmZjsKICAgIHZhciBGRGFtcGluZyA9IGN1cnJWICogZGFtcGluZzsKICAgIHZhciBuZXdWID0gY3VyclYgKyAoRlNwcmluZyAtIEZEYW1waW5nKSAqIGR0IC8gMWUzOwogICAgdmFyIG5ld1ggPSBjdXJyViAqIGR0IC8gMWUzICsgY3Vyclg7CiAgICBpZiAoTWF0aC5hYnMobmV3WCAtIGRlc3RYKSA8IEFDQ1VSQUNZICYmIE1hdGguYWJzKG5ld1YpIDwgQUNDVVJBQ1kpIHsKICAgICAgcmV0dXJuIFtkZXN0WCwgMF07CiAgICB9CiAgICByZXR1cm4gW25ld1gsIG5ld1ZdOwogIH07CiAgc3RlcHBlci5pc1N0ZXBwZXIgPSB0cnVlOwogIHN0ZXBwZXIuZHQgPSBkdDsKICByZXR1cm4gc3RlcHBlcjsKfTsKdmFyIGNvbmZpZ0Vhc2luZyA9IChlYXNpbmcpID0+IHsKICBpZiAodHlwZW9mIGVhc2luZyA9PT0gInN0cmluZyIpIHsKICAgIHN3aXRjaCAoZWFzaW5nKSB7CiAgICAgIGNhc2UgImVhc2UiOgogICAgICBjYXNlICJlYXNlLWluLW91dCI6CiAgICAgIGNhc2UgImVhc2Utb3V0IjoKICAgICAgY2FzZSAiZWFzZS1pbiI6CiAgICAgIGNhc2UgImxpbmVhciI6CiAgICAgICAgcmV0dXJuIGNvbmZpZ0JlemllcihlYXNpbmcpOwogICAgICBjYXNlICJzcHJpbmciOgogICAgICAgIHJldHVybiBjb25maWdTcHJpbmcoKTsKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAoZWFzaW5nLnNwbGl0KCIoIilbMF0gPT09ICJjdWJpYy1iZXppZXIiKSB7CiAgICAgICAgICByZXR1cm4gY29uZmlnQmV6aWVyKGVhc2luZyk7CiAgICAgICAgfQogICAgfQogIH0KICBpZiAodHlwZW9mIGVhc2luZyA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGVhc2luZzsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi91c2VBbmltYXRpb25NYW5hZ2VyLmpzCnZhciBpbXBvcnRfcmVhY3QxNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL0FuaW1hdGlvbk1hbmFnZXIuanMKZnVuY3Rpb24gY3JlYXRlQW5pbWF0ZU1hbmFnZXIodGltZW91dENvbnRyb2xsZXIpIHsKICB2YXIgY3VyclN0eWxlOwogIHZhciBoYW5kbGVDaGFuZ2UgPSAoKSA9PiBudWxsOwogIHZhciBzaG91bGRTdG9wID0gZmFsc2U7CiAgdmFyIGNhbmNlbFRpbWVvdXQgPSBudWxsOwogIHZhciBzZXRTdHlsZSA9IChfc3R5bGUpID0+IHsKICAgIGlmIChzaG91bGRTdG9wKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChBcnJheS5pc0FycmF5KF9zdHlsZSkpIHsKICAgICAgaWYgKCFfc3R5bGUubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBzdHlsZXMgPSBfc3R5bGU7CiAgICAgIHZhciBbY3VyciwgLi4ucmVzdFN0eWxlc10gPSBzdHlsZXM7CiAgICAgIGlmICh0eXBlb2YgY3VyciA9PT0gIm51bWJlciIpIHsKICAgICAgICBjYW5jZWxUaW1lb3V0ID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzZXRTdHlsZS5iaW5kKG51bGwsIHJlc3RTdHlsZXMpLCBjdXJyKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgc2V0U3R5bGUoY3Vycik7CiAgICAgIGNhbmNlbFRpbWVvdXQgPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHNldFN0eWxlLmJpbmQobnVsbCwgcmVzdFN0eWxlcykpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodHlwZW9mIF9zdHlsZSA9PT0gInN0cmluZyIpIHsKICAgICAgY3VyclN0eWxlID0gX3N0eWxlOwogICAgICBoYW5kbGVDaGFuZ2UoY3VyclN0eWxlKTsKICAgIH0KICAgIGlmICh0eXBlb2YgX3N0eWxlID09PSAib2JqZWN0IikgewogICAgICBjdXJyU3R5bGUgPSBfc3R5bGU7CiAgICAgIGhhbmRsZUNoYW5nZShjdXJyU3R5bGUpOwogICAgfQogICAgaWYgKHR5cGVvZiBfc3R5bGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgX3N0eWxlKCk7CiAgICB9CiAgfTsKICByZXR1cm4gewogICAgc3RvcDogKCkgPT4gewogICAgICBzaG91bGRTdG9wID0gdHJ1ZTsKICAgIH0sCiAgICBzdGFydDogKHN0eWxlKSA9PiB7CiAgICAgIHNob3VsZFN0b3AgPSBmYWxzZTsKICAgICAgaWYgKGNhbmNlbFRpbWVvdXQpIHsKICAgICAgICBjYW5jZWxUaW1lb3V0KCk7CiAgICAgICAgY2FuY2VsVGltZW91dCA9IG51bGw7CiAgICAgIH0KICAgICAgc2V0U3R5bGUoc3R5bGUpOwogICAgfSwKICAgIHN1YnNjcmliZTogKF9oYW5kbGVDaGFuZ2UpID0+IHsKICAgICAgaGFuZGxlQ2hhbmdlID0gX2hhbmRsZUNoYW5nZTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICBoYW5kbGVDaGFuZ2UgPSAoKSA9PiBudWxsOwogICAgICB9OwogICAgfSwKICAgIGdldFRpbWVvdXRDb250cm9sbGVyOiAoKSA9PiB0aW1lb3V0Q29udHJvbGxlcgogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL3RpbWVvdXRDb250cm9sbGVyLmpzCnZhciBSZXF1ZXN0QW5pbWF0aW9uRnJhbWVUaW1lb3V0Q29udHJvbGxlciA9IGNsYXNzIHsKICBzZXRUaW1lb3V0KGNhbGxiYWNrKSB7CiAgICB2YXIgZGVsYXkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IDA7CiAgICB2YXIgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICB2YXIgcmVxdWVzdElkID0gbnVsbDsKICAgIHZhciBleGVjdXRlQ2FsbGJhY2sgPSAobm93KSA9PiB7CiAgICAgIGlmIChub3cgLSBzdGFydFRpbWUgPj0gZGVsYXkpIHsKICAgICAgICBjYWxsYmFjayhub3cpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXF1ZXN0SWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZXhlY3V0ZUNhbGxiYWNrKTsKICAgICAgfQogICAgfTsKICAgIHJlcXVlc3RJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShleGVjdXRlQ2FsbGJhY2spOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHJlcXVlc3RJZCAhPSBudWxsKSB7CiAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmVxdWVzdElkKTsKICAgICAgfQogICAgfTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9jcmVhdGVEZWZhdWx0QW5pbWF0aW9uTWFuYWdlci5qcwpmdW5jdGlvbiBjcmVhdGVEZWZhdWx0QW5pbWF0aW9uTWFuYWdlcigpIHsKICByZXR1cm4gY3JlYXRlQW5pbWF0ZU1hbmFnZXIobmV3IFJlcXVlc3RBbmltYXRpb25GcmFtZVRpbWVvdXRDb250cm9sbGVyKCkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi91c2VBbmltYXRpb25NYW5hZ2VyLmpzCnZhciBBbmltYXRpb25NYW5hZ2VyQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTUuY3JlYXRlQ29udGV4dCkoY3JlYXRlRGVmYXVsdEFuaW1hdGlvbk1hbmFnZXIpOwpmdW5jdGlvbiB1c2VBbmltYXRpb25NYW5hZ2VyKGFuaW1hdGlvbklkLCBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzKSB7CiAgdmFyIGNvbnRleHRBbmltYXRpb25NYW5hZ2VyID0gKDAsIGltcG9ydF9yZWFjdDE1LnVzZUNvbnRleHQpKEFuaW1hdGlvbk1hbmFnZXJDb250ZXh0KTsKICByZXR1cm4gKDAsIGltcG9ydF9yZWFjdDE1LnVzZU1lbW8pKCgpID0+IGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgIT09IG51bGwgJiYgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcyAhPT0gdm9pZCAwID8gYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcyA6IGNvbnRleHRBbmltYXRpb25NYW5hZ2VyKGFuaW1hdGlvbklkKSwgW2FuaW1hdGlvbklkLCBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzLCBjb250ZXh0QW5pbWF0aW9uTWFuYWdlcl0pOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvR2xvYmFsLmpzCnZhciBwYXJzZUlzU3NyQnlEZWZhdWx0ID0gKCkgPT4gISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuZG9jdW1lbnQgJiYgQm9vbGVhbih3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCkgJiYgd2luZG93LnNldFRpbWVvdXQpOwp2YXIgR2xvYmFsID0gewogIGRldlRvb2xzRW5hYmxlZDogZmFsc2UsCiAgaXNTc3I6IHBhcnNlSXNTc3JCeURlZmF1bHQoKQp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vSmF2YXNjcmlwdEFuaW1hdGUuanMKdmFyIGRlZmF1bHRKYXZhc2NyaXB0QW5pbWF0ZVByb3BzID0gewogIGJlZ2luOiAwLAogIGR1cmF0aW9uOiAxZTMsCiAgZWFzaW5nOiAiZWFzZSIsCiAgaXNBY3RpdmU6IHRydWUsCiAgY2FuQmVnaW46IHRydWUsCiAgb25BbmltYXRpb25FbmQ6ICgpID0+IHsKICB9LAogIG9uQW5pbWF0aW9uU3RhcnQ6ICgpID0+IHsKICB9Cn07CnZhciBmcm9tID0gewogIHQ6IDAKfTsKdmFyIHRvID0gewogIHQ6IDEKfTsKZnVuY3Rpb24gSmF2YXNjcmlwdEFuaW1hdGUob3V0c2lkZVByb3BzKSB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRKYXZhc2NyaXB0QW5pbWF0ZVByb3BzKTsKICB2YXIgewogICAgaXNBY3RpdmU6IGlzQWN0aXZlUHJvcCwKICAgIGNhbkJlZ2luLAogICAgZHVyYXRpb24sCiAgICBlYXNpbmcsCiAgICBiZWdpbiwKICAgIG9uQW5pbWF0aW9uRW5kLAogICAgb25BbmltYXRpb25TdGFydCwKICAgIGNoaWxkcmVuCiAgfSA9IHByb3BzOwogIHZhciBpc0FjdGl2ZSA9IGlzQWN0aXZlUHJvcCA9PT0gImF1dG8iID8gIUdsb2JhbC5pc1NzciA6IGlzQWN0aXZlUHJvcDsKICB2YXIgYW5pbWF0aW9uTWFuYWdlciA9IHVzZUFuaW1hdGlvbk1hbmFnZXIocHJvcHMuYW5pbWF0aW9uSWQsIHByb3BzLmFuaW1hdGlvbk1hbmFnZXIpOwogIHZhciBbc3R5bGUsIHNldFN0eWxlXSA9ICgwLCBpbXBvcnRfcmVhY3QxNi51c2VTdGF0ZSkoaXNBY3RpdmUgPyBmcm9tIDogdG8pOwogIHZhciBzdG9wSlNBbmltYXRpb24gPSAoMCwgaW1wb3J0X3JlYWN0MTYudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MTYudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzQWN0aXZlKSB7CiAgICAgIHNldFN0eWxlKHRvKTsKICAgIH0KICB9LCBbaXNBY3RpdmVdKTsKICAoMCwgaW1wb3J0X3JlYWN0MTYudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzQWN0aXZlIHx8ICFjYW5CZWdpbikgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBzdGFydEFuaW1hdGlvbiA9IGNvbmZpZ1VwZGF0ZV9kZWZhdWx0KGZyb20sIHRvLCBjb25maWdFYXNpbmcoZWFzaW5nKSwgZHVyYXRpb24sIHNldFN0eWxlLCBhbmltYXRpb25NYW5hZ2VyLmdldFRpbWVvdXRDb250cm9sbGVyKCkpOwogICAgdmFyIG9uQW5pbWF0aW9uQWN0aXZlID0gKCkgPT4gewogICAgICBzdG9wSlNBbmltYXRpb24uY3VycmVudCA9IHN0YXJ0QW5pbWF0aW9uKCk7CiAgICB9OwogICAgYW5pbWF0aW9uTWFuYWdlci5zdGFydChbb25BbmltYXRpb25TdGFydCwgYmVnaW4sIG9uQW5pbWF0aW9uQWN0aXZlLCBkdXJhdGlvbiwgb25BbmltYXRpb25FbmRdKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGFuaW1hdGlvbk1hbmFnZXIuc3RvcCgpOwogICAgICBpZiAoc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQpIHsKICAgICAgICBzdG9wSlNBbmltYXRpb24uY3VycmVudCgpOwogICAgICB9CiAgICAgIG9uQW5pbWF0aW9uRW5kKCk7CiAgICB9OwogIH0sIFtpc0FjdGl2ZSwgY2FuQmVnaW4sIGR1cmF0aW9uLCBlYXNpbmcsIGJlZ2luLCBvbkFuaW1hdGlvblN0YXJ0LCBvbkFuaW1hdGlvbkVuZCwgYW5pbWF0aW9uTWFuYWdlcl0pOwogIHJldHVybiBjaGlsZHJlbihzdHlsZS50KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3VzZUFuaW1hdGlvbklkLmpzCnZhciBpbXBvcnRfcmVhY3QxNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gdXNlQW5pbWF0aW9uSWQoaW5wdXQpIHsKICB2YXIgcHJlZml4ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiAiYW5pbWF0aW9uLSI7CiAgdmFyIGFuaW1hdGlvbklkID0gKDAsIGltcG9ydF9yZWFjdDE3LnVzZVJlZikodW5pcXVlSWQocHJlZml4KSk7CiAgdmFyIHByZXZQcm9wcyA9ICgwLCBpbXBvcnRfcmVhY3QxNy51c2VSZWYpKGlucHV0KTsKICBpZiAocHJldlByb3BzLmN1cnJlbnQgIT09IGlucHV0KSB7CiAgICBhbmltYXRpb25JZC5jdXJyZW50ID0gdW5pcXVlSWQocHJlZml4KTsKICAgIHByZXZQcm9wcy5jdXJyZW50ID0gaW5wdXQ7CiAgfQogIHJldHVybiBhbmltYXRpb25JZC5jdXJyZW50Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL1JlY3RhbmdsZS5qcwp2YXIgX2V4Y2x1ZGVkNCA9IFsicmFkaXVzIl07CnZhciBfZXhjbHVkZWQyMiA9IFsicmFkaXVzIl07CmZ1bmN0aW9uIG93bktleXMxMShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDExKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTEoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTExKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czExKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTExKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTExKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTExKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTExKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczcoKSB7CiAgcmV0dXJuIF9leHRlbmRzNyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczQoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTQoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTQocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBnZXRSZWN0YW5nbGVQYXRoID0gKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgcmFkaXVzKSA9PiB7CiAgdmFyIG1heFJhZGl1cyA9IE1hdGgubWluKE1hdGguYWJzKHdpZHRoKSAvIDIsIE1hdGguYWJzKGhlaWdodCkgLyAyKTsKICB2YXIgeVNpZ24gPSBoZWlnaHQgPj0gMCA/IDEgOiAtMTsKICB2YXIgeFNpZ24gPSB3aWR0aCA+PSAwID8gMSA6IC0xOwogIHZhciBjbG9ja1dpc2UgPSBoZWlnaHQgPj0gMCAmJiB3aWR0aCA+PSAwIHx8IGhlaWdodCA8IDAgJiYgd2lkdGggPCAwID8gMSA6IDA7CiAgdmFyIHBhdGgyOwogIGlmIChtYXhSYWRpdXMgPiAwICYmIHJhZGl1cyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICB2YXIgbmV3UmFkaXVzID0gWzAsIDAsIDAsIDBdOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IDQ7IGkgPCBsZW47IGkrKykgewogICAgICBuZXdSYWRpdXNbaV0gPSByYWRpdXNbaV0gPiBtYXhSYWRpdXMgPyBtYXhSYWRpdXMgOiByYWRpdXNbaV07CiAgICB9CiAgICBwYXRoMiA9ICJNIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBuZXdSYWRpdXNbMF0pOwogICAgaWYgKG5ld1JhZGl1c1swXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzBdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbMF0sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgeFNpZ24gKiBuZXdSYWRpdXNbMF0sICIsIikuY29uY2F0KHkyKTsKICAgIH0KICAgIHBhdGgyICs9ICJMICIuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIG5ld1JhZGl1c1sxXSwgIiwiKS5jb25jYXQoeTIpOwogICAgaWYgKG5ld1JhZGl1c1sxXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzFdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbMV0sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsXG4gICAgICAgICIpLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogbmV3UmFkaXVzWzFdKTsKICAgIH0KICAgIHBhdGgyICs9ICJMICIuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0IC0geVNpZ24gKiBuZXdSYWRpdXNbMl0pOwogICAgaWYgKG5ld1JhZGl1c1syXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzJdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbMl0sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsXG4gICAgICAgICIpLmNvbmNhdCh4MiArIHdpZHRoIC0geFNpZ24gKiBuZXdSYWRpdXNbMl0sICIsIikuY29uY2F0KHkyICsgaGVpZ2h0KTsKICAgIH0KICAgIHBhdGgyICs9ICJMICIuY29uY2F0KHgyICsgeFNpZ24gKiBuZXdSYWRpdXNbM10sICIsIikuY29uY2F0KHkyICsgaGVpZ2h0KTsKICAgIGlmIChuZXdSYWRpdXNbM10gPiAwKSB7CiAgICAgIHBhdGgyICs9ICJBICIuY29uY2F0KG5ld1JhZGl1c1szXSwgIiwiKS5jb25jYXQobmV3UmFkaXVzWzNdLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLFxuICAgICAgICAiKS5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0IC0geVNpZ24gKiBuZXdSYWRpdXNbM10pOwogICAgfQogICAgcGF0aDIgKz0gIloiOwogIH0gZWxzZSBpZiAobWF4UmFkaXVzID4gMCAmJiByYWRpdXMgPT09ICtyYWRpdXMgJiYgcmFkaXVzID4gMCkgewogICAgdmFyIF9uZXdSYWRpdXMgPSBNYXRoLm1pbihtYXhSYWRpdXMsIHJhZGl1cyk7CiAgICBwYXRoMiA9ICJNICIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogX25ld1JhZGl1cywgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoX25ld1JhZGl1cywgIiwiKS5jb25jYXQoX25ld1JhZGl1cywgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyLCAiXG4gICAgICAgICAgICBMICIpLmNvbmNhdCh4MiArIHdpZHRoIC0geFNpZ24gKiBfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdCh5MiwgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoX25ld1JhZGl1cywgIiwiKS5jb25jYXQoX25ld1JhZGl1cywgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIF9uZXdSYWRpdXMsICJcbiAgICAgICAgICAgIEwgIikuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0IC0geVNpZ24gKiBfbmV3UmFkaXVzLCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHdpZHRoIC0geFNpZ24gKiBfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCwgIlxuICAgICAgICAgICAgTCAiKS5jb25jYXQoeDIgKyB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0LCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIF9uZXdSYWRpdXMsICIgWiIpOwogIH0gZWxzZSB7CiAgICBwYXRoMiA9ICJNICIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiwgIiBoICIpLmNvbmNhdCh3aWR0aCwgIiB2ICIpLmNvbmNhdChoZWlnaHQsICIgaCAiKS5jb25jYXQoLXdpZHRoLCAiIFoiKTsKICB9CiAgcmV0dXJuIHBhdGgyOwp9Owp2YXIgZGVmYXVsdFJlY3RhbmdsZVByb3BzID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgLy8gVGhlIHJhZGl1cyBvZiBib3JkZXIKICAvLyBUaGUgcmFkaXVzIG9mIGZvdXIgY29ybmVycyB3aGVuIHJhZGl1cyBpcyBhIG51bWJlcgogIC8vIFRoZSByYWRpdXMgb2YgbGVmdC10b3AsIHJpZ2h0LXRvcCwgcmlnaHQtYm90dG9tLCBsZWZ0LWJvdHRvbSB3aGVuIHJhZGl1cyBpcyBhbiBhcnJheQogIHJhZGl1czogMCwKICBpc0FuaW1hdGlvbkFjdGl2ZTogZmFsc2UsCiAgaXNVcGRhdGVBbmltYXRpb25BY3RpdmU6IGZhbHNlLAogIGFuaW1hdGlvbkJlZ2luOiAwLAogIGFuaW1hdGlvbkR1cmF0aW9uOiAxNTAwLAogIGFuaW1hdGlvbkVhc2luZzogImVhc2UiCn07CnZhciBSZWN0YW5nbGUgPSAocmVjdGFuZ2xlUHJvcHMpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHJlY3RhbmdsZVByb3BzLCBkZWZhdWx0UmVjdGFuZ2xlUHJvcHMpOwogIHZhciBwYXRoUmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikobnVsbCk7CiAgdmFyIFt0b3RhbExlbmd0aCwgc2V0VG90YWxMZW5ndGhdID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVN0YXRlKSgtMSk7CiAgKDAsIGltcG9ydF9yZWFjdDE4LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKHBhdGhSZWYuY3VycmVudCAmJiBwYXRoUmVmLmN1cnJlbnQuZ2V0VG90YWxMZW5ndGgpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcGF0aFRvdGFsTGVuZ3RoID0gcGF0aFJlZi5jdXJyZW50LmdldFRvdGFsTGVuZ3RoKCk7CiAgICAgICAgaWYgKHBhdGhUb3RhbExlbmd0aCkgewogICAgICAgICAgc2V0VG90YWxMZW5ndGgocGF0aFRvdGFsTGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgICAgfQogICAgfQogIH0sIFtdKTsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmFkaXVzLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIHZhciB7CiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZQogIH0gPSBwcm9wczsKICB2YXIgcHJldldpZHRoUmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikod2lkdGgpOwogIHZhciBwcmV2SGVpZ2h0UmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikoaGVpZ2h0KTsKICB2YXIgcHJldlhSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKSh4Mik7CiAgdmFyIHByZXZZUmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikoeTIpOwogIHZhciBhbmltYXRpb25JZElucHV0ID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZU1lbW8pKCgpID0+ICh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByYWRpdXMKICB9KSwgW3gyLCB5Miwgd2lkdGgsIGhlaWdodCwgcmFkaXVzXSk7CiAgdmFyIGFuaW1hdGlvbklkID0gdXNlQW5pbWF0aW9uSWQoYW5pbWF0aW9uSWRJbnB1dCwgInJlY3RhbmdsZS0iKTsKICBpZiAoeDIgIT09ICt4MiB8fCB5MiAhPT0gK3kyIHx8IHdpZHRoICE9PSArd2lkdGggfHwgaGVpZ2h0ICE9PSAraGVpZ2h0IHx8IHdpZHRoID09PSAwIHx8IGhlaWdodCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtcmVjdGFuZ2xlIiwgY2xhc3NOYW1lKTsKICBpZiAoIWlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlKSB7CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNBbmRFdmVuID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyksIHsKICAgICAgcmFkaXVzOiBfCiAgICB9ID0gX3N2Z1Byb3BlcnRpZXNBbmRFdmVuLCBvdGhlclBhdGhQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczQoX3N2Z1Byb3BlcnRpZXNBbmRFdmVuLCBfZXhjbHVkZWQ0KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q5LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczcoe30sIG90aGVyUGF0aFByb3BzLCB7CiAgICAgIHJhZGl1czogdHlwZW9mIHJhZGl1cyA9PT0gIm51bWJlciIgPyByYWRpdXMgOiB2b2lkIDAsCiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgICAgZDogZ2V0UmVjdGFuZ2xlUGF0aCh4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHJhZGl1cykKICAgIH0pKTsKICB9CiAgdmFyIHByZXZXaWR0aCA9IHByZXZXaWR0aFJlZi5jdXJyZW50OwogIHZhciBwcmV2SGVpZ2h0ID0gcHJldkhlaWdodFJlZi5jdXJyZW50OwogIHZhciBwcmV2WCA9IHByZXZYUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZZID0gcHJldllSZWYuY3VycmVudDsKICB2YXIgZnJvbTIgPSAiMHB4ICIuY29uY2F0KHRvdGFsTGVuZ3RoID09PSAtMSA/IDEgOiB0b3RhbExlbmd0aCwgInB4Iik7CiAgdmFyIHRvMiA9ICIiLmNvbmNhdCh0b3RhbExlbmd0aCwgInB4IDBweCIpOwogIHZhciB0cmFuc2l0aW9uID0gZ2V0VHJhbnNpdGlvblZhbChbInN0cm9rZURhc2hhcnJheSJdLCBhbmltYXRpb25EdXJhdGlvbiwgdHlwZW9mIGFuaW1hdGlvbkVhc2luZyA9PT0gInN0cmluZyIgPyBhbmltYXRpb25FYXNpbmcgOiBkZWZhdWx0UmVjdGFuZ2xlUHJvcHMuYW5pbWF0aW9uRWFzaW5nKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0OS5jcmVhdGVFbGVtZW50KEphdmFzY3JpcHRBbmltYXRlLCB7CiAgICBhbmltYXRpb25JZCwKICAgIGtleTogYW5pbWF0aW9uSWQsCiAgICBjYW5CZWdpbjogdG90YWxMZW5ndGggPiAwLAogICAgZHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uLAogICAgZWFzaW5nOiBhbmltYXRpb25FYXNpbmcsCiAgICBpc0FjdGl2ZTogaXNVcGRhdGVBbmltYXRpb25BY3RpdmUsCiAgICBiZWdpbjogYW5pbWF0aW9uQmVnaW4KICB9LCAodCkgPT4gewogICAgdmFyIGN1cnJXaWR0aCA9IGludGVycG9sYXRlKHByZXZXaWR0aCwgd2lkdGgsIHQpOwogICAgdmFyIGN1cnJIZWlnaHQgPSBpbnRlcnBvbGF0ZShwcmV2SGVpZ2h0LCBoZWlnaHQsIHQpOwogICAgdmFyIGN1cnJYID0gaW50ZXJwb2xhdGUocHJldlgsIHgyLCB0KTsKICAgIHZhciBjdXJyWSA9IGludGVycG9sYXRlKHByZXZZLCB5MiwgdCk7CiAgICBpZiAocGF0aFJlZi5jdXJyZW50KSB7CiAgICAgIHByZXZXaWR0aFJlZi5jdXJyZW50ID0gY3VycldpZHRoOwogICAgICBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQgPSBjdXJySGVpZ2h0OwogICAgICBwcmV2WFJlZi5jdXJyZW50ID0gY3Vyclg7CiAgICAgIHByZXZZUmVmLmN1cnJlbnQgPSBjdXJyWTsKICAgIH0KICAgIHZhciBhbmltYXRpb25TdHlsZTsKICAgIGlmICghaXNBbmltYXRpb25BY3RpdmUpIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0bzIKICAgICAgfTsKICAgIH0gZWxzZSBpZiAodCA+IDApIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgdHJhbnNpdGlvbiwKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRvMgogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiBmcm9tMgogICAgICB9OwogICAgfQogICAgdmFyIF9zdmdQcm9wZXJ0aWVzQW5kRXZlbjIgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgICByYWRpdXM6IF8yCiAgICB9ID0gX3N2Z1Byb3BlcnRpZXNBbmRFdmVuMiwgb3RoZXJQYXRoUHJvcHMyID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChfc3ZnUHJvcGVydGllc0FuZEV2ZW4yLCBfZXhjbHVkZWQyMik7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0OS5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM3KHt9LCBvdGhlclBhdGhQcm9wczIsIHsKICAgICAgcmFkaXVzOiB0eXBlb2YgcmFkaXVzID09PSAibnVtYmVyIiA/IHJhZGl1cyA6IHZvaWQgMCwKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgICBkOiBnZXRSZWN0YW5nbGVQYXRoKGN1cnJYLCBjdXJyWSwgY3VycldpZHRoLCBjdXJySGVpZ2h0LCByYWRpdXMpLAogICAgICByZWY6IHBhdGhSZWYsCiAgICAgIHN0eWxlOiBfb2JqZWN0U3ByZWFkMTEoX29iamVjdFNwcmVhZDExKHt9LCBhbmltYXRpb25TdHlsZSksIHByb3BzLnN0eWxlKQogICAgfSkpOwogIH0pOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1BvbGFyVXRpbHMuanMKdmFyIGltcG9ydF9yZWFjdDE5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBvd25LZXlzMTIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czEyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxMihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxMihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxMih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFJBRElBTiA9IE1hdGguUEkgLyAxODA7CnZhciByYWRpYW5Ub0RlZ3JlZSA9IChhbmdsZUluUmFkaWFuKSA9PiBhbmdsZUluUmFkaWFuICogMTgwIC8gTWF0aC5QSTsKdmFyIHBvbGFyVG9DYXJ0ZXNpYW4gPSAoY3gsIGN5LCByYWRpdXMsIGFuZ2xlKSA9PiAoewogIHg6IGN4ICsgTWF0aC5jb3MoLVJBRElBTiAqIGFuZ2xlKSAqIHJhZGl1cywKICB5OiBjeSArIE1hdGguc2luKC1SQURJQU4gKiBhbmdsZSkgKiByYWRpdXMKfSk7CnZhciBnZXRNYXhSYWRpdXMgPSBmdW5jdGlvbiBnZXRNYXhSYWRpdXMyKHdpZHRoLCBoZWlnaHQpIHsKICB2YXIgb2Zmc2V0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB7CiAgICB0b3A6IDAsCiAgICByaWdodDogMCwKICAgIGJvdHRvbTogMCwKICAgIGxlZnQ6IDAsCiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMCwKICAgIGJydXNoQm90dG9tOiAwCiAgfTsKICByZXR1cm4gTWF0aC5taW4oTWF0aC5hYnMod2lkdGggLSAob2Zmc2V0LmxlZnQgfHwgMCkgLSAob2Zmc2V0LnJpZ2h0IHx8IDApKSwgTWF0aC5hYnMoaGVpZ2h0IC0gKG9mZnNldC50b3AgfHwgMCkgLSAob2Zmc2V0LmJvdHRvbSB8fCAwKSkpIC8gMjsKfTsKdmFyIGRpc3RhbmNlQmV0d2VlblBvaW50cyA9IChwb2ludDQsIGFub3RoZXJQb2ludCkgPT4gewogIHZhciB7CiAgICB4OiB4MSwKICAgIHk6IHkxCiAgfSA9IHBvaW50NDsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MgogIH0gPSBhbm90aGVyUG9pbnQ7CiAgcmV0dXJuIE1hdGguc3FydCgoeDEgLSB4MikgKiogMiArICh5MSAtIHkyKSAqKiAyKTsKfTsKdmFyIGdldEFuZ2xlT2ZQb2ludCA9IChfcmVmMiwgX3JlZjIyKSA9PiB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9ID0gX3JlZjI7CiAgdmFyIHsKICAgIGN4LAogICAgY3kKICB9ID0gX3JlZjIyOwogIHZhciByYWRpdXMgPSBkaXN0YW5jZUJldHdlZW5Qb2ludHMoewogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIHsKICAgIHg6IGN4LAogICAgeTogY3kKICB9KTsKICBpZiAocmFkaXVzIDw9IDApIHsKICAgIHJldHVybiB7CiAgICAgIHJhZGl1cywKICAgICAgYW5nbGU6IDAKICAgIH07CiAgfQogIHZhciBjb3MgPSAoeDIgLSBjeCkgLyByYWRpdXM7CiAgdmFyIGFuZ2xlSW5SYWRpYW4gPSBNYXRoLmFjb3MoY29zKTsKICBpZiAoeTIgPiBjeSkgewogICAgYW5nbGVJblJhZGlhbiA9IDIgKiBNYXRoLlBJIC0gYW5nbGVJblJhZGlhbjsKICB9CiAgcmV0dXJuIHsKICAgIHJhZGl1cywKICAgIGFuZ2xlOiByYWRpYW5Ub0RlZ3JlZShhbmdsZUluUmFkaWFuKSwKICAgIGFuZ2xlSW5SYWRpYW4KICB9Owp9Owp2YXIgZm9ybWF0QW5nbGVPZlNlY3RvciA9IChfcmVmMykgPT4gewogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjM7CiAgdmFyIHN0YXJ0Q250ID0gTWF0aC5mbG9vcihzdGFydEFuZ2xlIC8gMzYwKTsKICB2YXIgZW5kQ250ID0gTWF0aC5mbG9vcihlbmRBbmdsZSAvIDM2MCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihzdGFydENudCwgZW5kQ250KTsKICByZXR1cm4gewogICAgc3RhcnRBbmdsZTogc3RhcnRBbmdsZSAtIG1pbjIgKiAzNjAsCiAgICBlbmRBbmdsZTogZW5kQW5nbGUgLSBtaW4yICogMzYwCiAgfTsKfTsKdmFyIHJldmVyc2VGb3JtYXRBbmdsZU9mU2VjdG9yID0gKGFuZ2xlLCBfcmVmNCkgPT4gewogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjQ7CiAgdmFyIHN0YXJ0Q250ID0gTWF0aC5mbG9vcihzdGFydEFuZ2xlIC8gMzYwKTsKICB2YXIgZW5kQ250ID0gTWF0aC5mbG9vcihlbmRBbmdsZSAvIDM2MCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihzdGFydENudCwgZW5kQ250KTsKICByZXR1cm4gYW5nbGUgKyBtaW4yICogMzYwOwp9Owp2YXIgaW5SYW5nZU9mU2VjdG9yID0gKF9yZWY1LCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0WDogeDIsCiAgICBjaGFydFk6IHkyCiAgfSA9IF9yZWY1OwogIHZhciB7CiAgICByYWRpdXMsCiAgICBhbmdsZQogIH0gPSBnZXRBbmdsZU9mUG9pbnQoewogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIHZpZXdCb3gpOwogIHZhciB7CiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzCiAgfSA9IHZpZXdCb3g7CiAgaWYgKHJhZGl1cyA8IGlubmVyUmFkaXVzIHx8IHJhZGl1cyA+IG91dGVyUmFkaXVzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKHJhZGl1cyA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gZm9ybWF0QW5nbGVPZlNlY3Rvcih2aWV3Qm94KTsKICB2YXIgZm9ybWF0QW5nbGUgPSBhbmdsZTsKICB2YXIgaW5SYW5nZTsKICBpZiAoc3RhcnRBbmdsZSA8PSBlbmRBbmdsZSkgewogICAgd2hpbGUgKGZvcm1hdEFuZ2xlID4gZW5kQW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgLT0gMzYwOwogICAgfQogICAgd2hpbGUgKGZvcm1hdEFuZ2xlIDwgc3RhcnRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSArPSAzNjA7CiAgICB9CiAgICBpblJhbmdlID0gZm9ybWF0QW5nbGUgPj0gc3RhcnRBbmdsZSAmJiBmb3JtYXRBbmdsZSA8PSBlbmRBbmdsZTsKICB9IGVsc2UgewogICAgd2hpbGUgKGZvcm1hdEFuZ2xlID4gc3RhcnRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSAtPSAzNjA7CiAgICB9CiAgICB3aGlsZSAoZm9ybWF0QW5nbGUgPCBlbmRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSArPSAzNjA7CiAgICB9CiAgICBpblJhbmdlID0gZm9ybWF0QW5nbGUgPj0gZW5kQW5nbGUgJiYgZm9ybWF0QW5nbGUgPD0gc3RhcnRBbmdsZTsKICB9CiAgaWYgKGluUmFuZ2UpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTIoX29iamVjdFNwcmVhZDEyKHt9LCB2aWV3Qm94KSwge30sIHsKICAgICAgcmFkaXVzLAogICAgICBhbmdsZTogcmV2ZXJzZUZvcm1hdEFuZ2xlT2ZTZWN0b3IoZm9ybWF0QW5nbGUsIHZpZXdCb3gpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvY3Vyc29yL2dldFJhZGlhbEN1cnNvclBvaW50cy5qcwpmdW5jdGlvbiBnZXRSYWRpYWxDdXJzb3JQb2ludHMoYWN0aXZlQ29vcmRpbmF0ZSkgewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IGFjdGl2ZUNvb3JkaW5hdGU7CiAgdmFyIHN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBzdGFydEFuZ2xlKTsKICB2YXIgZW5kUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBlbmRBbmdsZSk7CiAgcmV0dXJuIHsKICAgIHBvaW50czogW3N0YXJ0UG9pbnQsIGVuZFBvaW50XSwKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL1NlY3Rvci5qcwp2YXIgUmVhY3QxMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gX2V4dGVuZHM4KCkgewogIHJldHVybiBfZXh0ZW5kczggPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczguYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgZ2V0RGVsdGFBbmdsZSA9IChzdGFydEFuZ2xlLCBlbmRBbmdsZSkgPT4gewogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBNYXRoLm1pbihNYXRoLmFicyhlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpLCAzNTkuOTk5KTsKICByZXR1cm4gc2lnbjIgKiBkZWx0YUFuZ2xlOwp9Owp2YXIgZ2V0VGFuZ2VudENpcmNsZSA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzLAogICAgYW5nbGUsCiAgICBzaWduOiBzaWduMiwKICAgIGlzRXh0ZXJuYWwsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSA9IF9yZWYyOwogIHZhciBjZW50ZXJSYWRpdXMgPSBjb3JuZXJSYWRpdXMgKiAoaXNFeHRlcm5hbCA/IDEgOiAtMSkgKyByYWRpdXM7CiAgdmFyIHRoZXRhID0gTWF0aC5hc2luKGNvcm5lclJhZGl1cyAvIGNlbnRlclJhZGl1cykgLyBSQURJQU47CiAgdmFyIGNlbnRlckFuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IGFuZ2xlIDogYW5nbGUgKyBzaWduMiAqIHRoZXRhOwogIHZhciBjZW50ZXIgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgY2VudGVyUmFkaXVzLCBjZW50ZXJBbmdsZSk7CiAgdmFyIGNpcmNsZVRhbmdlbmN5ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgY2VudGVyQW5nbGUpOwogIHZhciBsaW5lVGFuZ2VuY3lBbmdsZSA9IGNvcm5lcklzRXh0ZXJuYWwgPyBhbmdsZSAtIHNpZ24yICogdGhldGEgOiBhbmdsZTsKICB2YXIgbGluZVRhbmdlbmN5ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGNlbnRlclJhZGl1cyAqIE1hdGguY29zKHRoZXRhICogUkFESUFOKSwgbGluZVRhbmdlbmN5QW5nbGUpOwogIHJldHVybiB7CiAgICBjZW50ZXIsCiAgICBjaXJjbGVUYW5nZW5jeSwKICAgIGxpbmVUYW5nZW5jeSwKICAgIHRoZXRhCiAgfTsKfTsKdmFyIGdldFNlY3RvclBhdGggPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjI7CiAgdmFyIGFuZ2xlID0gZ2V0RGVsdGFBbmdsZShzdGFydEFuZ2xlLCBlbmRBbmdsZSk7CiAgdmFyIHRlbXBFbmRBbmdsZSA9IHN0YXJ0QW5nbGUgKyBhbmdsZTsKICB2YXIgb3V0ZXJTdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCBzdGFydEFuZ2xlKTsKICB2YXIgb3V0ZXJFbmRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBvdXRlclJhZGl1cywgdGVtcEVuZEFuZ2xlKTsKICB2YXIgcGF0aDIgPSAiTSAiLmNvbmNhdChvdXRlclN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQob3V0ZXJTdGFydFBvaW50LnksICJcbiAgICBBICIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwiKS5jb25jYXQob3V0ZXJSYWRpdXMsICIsMCxcbiAgICAiKS5jb25jYXQoKyhNYXRoLmFicyhhbmdsZSkgPiAxODApLCAiLCIpLmNvbmNhdCgrKHN0YXJ0QW5nbGUgPiB0ZW1wRW5kQW5nbGUpLCAiLFxuICAgICIpLmNvbmNhdChvdXRlckVuZFBvaW50LngsICIsIikuY29uY2F0KG91dGVyRW5kUG9pbnQueSwgIlxuICAiKTsKICBpZiAoaW5uZXJSYWRpdXMgPiAwKSB7CiAgICB2YXIgaW5uZXJTdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGlubmVyUmFkaXVzLCBzdGFydEFuZ2xlKTsKICAgIHZhciBpbm5lckVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGlubmVyUmFkaXVzLCB0ZW1wRW5kQW5nbGUpOwogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoaW5uZXJFbmRQb2ludC54LCAiLCIpLmNvbmNhdChpbm5lckVuZFBvaW50LnksICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLCIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwwLFxuICAgICAgICAgICAgIikuY29uY2F0KCsoTWF0aC5hYnMoYW5nbGUpID4gMTgwKSwgIiwiKS5jb25jYXQoKyhzdGFydEFuZ2xlIDw9IHRlbXBFbmRBbmdsZSksICIsXG4gICAgICAgICAgICAiKS5jb25jYXQoaW5uZXJTdGFydFBvaW50LngsICIsIikuY29uY2F0KGlubmVyU3RhcnRQb2ludC55LCAiIFoiKTsKICB9IGVsc2UgewogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoY3gsICIsIikuY29uY2F0KGN5LCAiIFoiKTsKICB9CiAgcmV0dXJuIHBhdGgyOwp9Owp2YXIgZ2V0U2VjdG9yV2l0aENvcm5lciA9IChfcmVmMykgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIGNvcm5lclJhZGl1cywKICAgIGZvcmNlQ29ybmVyUmFkaXVzLAogICAgY29ybmVySXNFeHRlcm5hbCwKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBfcmVmMzsKICB2YXIgc2lnbjIgPSBtYXRoU2lnbihlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpOwogIHZhciB7CiAgICBjaXJjbGVUYW5nZW5jeTogc29jdCwKICAgIGxpbmVUYW5nZW5jeTogc29sdCwKICAgIHRoZXRhOiBzb3QKICB9ID0gZ2V0VGFuZ2VudENpcmNsZSh7CiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzOiBvdXRlclJhZGl1cywKICAgIGFuZ2xlOiBzdGFydEFuZ2xlLAogICAgc2lnbjogc2lnbjIsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSk7CiAgdmFyIHsKICAgIGNpcmNsZVRhbmdlbmN5OiBlb2N0LAogICAgbGluZVRhbmdlbmN5OiBlb2x0LAogICAgdGhldGE6IGVvdAogIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXM6IG91dGVyUmFkaXVzLAogICAgYW5nbGU6IGVuZEFuZ2xlLAogICAgc2lnbjogLXNpZ24yLAogICAgY29ybmVyUmFkaXVzLAogICAgY29ybmVySXNFeHRlcm5hbAogIH0pOwogIHZhciBvdXRlckFyY0FuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgOiBNYXRoLmFicyhzdGFydEFuZ2xlIC0gZW5kQW5nbGUpIC0gc290IC0gZW90OwogIGlmIChvdXRlckFyY0FuZ2xlIDwgMCkgewogICAgaWYgKGZvcmNlQ29ybmVyUmFkaXVzKSB7CiAgICAgIHJldHVybiAiTSAiLmNvbmNhdChzb2x0LngsICIsIikuY29uY2F0KHNvbHQueSwgIlxuICAgICAgICBhIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwxLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMgKiAyLCAiLDBcbiAgICAgICAgYSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsMSwiKS5jb25jYXQoLWNvcm5lclJhZGl1cyAqIDIsICIsMFxuICAgICAgIik7CiAgICB9CiAgICByZXR1cm4gZ2V0U2VjdG9yUGF0aCh7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgaW5uZXJSYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzLAogICAgICBzdGFydEFuZ2xlLAogICAgICBlbmRBbmdsZQogICAgfSk7CiAgfQogIHZhciBwYXRoMiA9ICJNICIuY29uY2F0KHNvbHQueCwgIiwiKS5jb25jYXQoc29sdC55LCAiXG4gICAgQSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoc29jdC54LCAiLCIpLmNvbmNhdChzb2N0LnksICJcbiAgICBBIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLCIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwwLCIpLmNvbmNhdCgrKG91dGVyQXJjQW5nbGUgPiAxODApLCAiLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KGVvY3QueCwgIiwiKS5jb25jYXQoZW9jdC55LCAiXG4gICAgQSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoZW9sdC54LCAiLCIpLmNvbmNhdChlb2x0LnksICJcbiAgIik7CiAgaWYgKGlubmVyUmFkaXVzID4gMCkgewogICAgdmFyIHsKICAgICAgY2lyY2xlVGFuZ2VuY3k6IHNpY3QsCiAgICAgIGxpbmVUYW5nZW5jeTogc2lsdCwKICAgICAgdGhldGE6IHNpdAogICAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1czogaW5uZXJSYWRpdXMsCiAgICAgIGFuZ2xlOiBzdGFydEFuZ2xlLAogICAgICBzaWduOiBzaWduMiwKICAgICAgaXNFeHRlcm5hbDogdHJ1ZSwKICAgICAgY29ybmVyUmFkaXVzLAogICAgICBjb3JuZXJJc0V4dGVybmFsCiAgICB9KTsKICAgIHZhciB7CiAgICAgIGNpcmNsZVRhbmdlbmN5OiBlaWN0LAogICAgICBsaW5lVGFuZ2VuY3k6IGVpbHQsCiAgICAgIHRoZXRhOiBlaXQKICAgIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICByYWRpdXM6IGlubmVyUmFkaXVzLAogICAgICBhbmdsZTogZW5kQW5nbGUsCiAgICAgIHNpZ246IC1zaWduMiwKICAgICAgaXNFeHRlcm5hbDogdHJ1ZSwKICAgICAgY29ybmVyUmFkaXVzLAogICAgICBjb3JuZXJJc0V4dGVybmFsCiAgICB9KTsKICAgIHZhciBpbm5lckFyY0FuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgOiBNYXRoLmFicyhzdGFydEFuZ2xlIC0gZW5kQW5nbGUpIC0gc2l0IC0gZWl0OwogICAgaWYgKGlubmVyQXJjQW5nbGUgPCAwICYmIGNvcm5lclJhZGl1cyA9PT0gMCkgewogICAgICByZXR1cm4gIiIuY29uY2F0KHBhdGgyLCAiTCIpLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICJaIik7CiAgICB9CiAgICBwYXRoMiArPSAiTCIuY29uY2F0KGVpbHQueCwgIiwiKS5jb25jYXQoZWlsdC55LCAiXG4gICAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChlaWN0LngsICIsIikuY29uY2F0KGVpY3QueSwgIlxuICAgICAgQSIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwiKS5jb25jYXQoaW5uZXJSYWRpdXMsICIsMCwiKS5jb25jYXQoKyhpbm5lckFyY0FuZ2xlID4gMTgwKSwgIiwiKS5jb25jYXQoKyhzaWduMiA+IDApLCAiLCIpLmNvbmNhdChzaWN0LngsICIsIikuY29uY2F0KHNpY3QueSwgIlxuICAgICAgQSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoc2lsdC54LCAiLCIpLmNvbmNhdChzaWx0LnksICJaIik7CiAgfSBlbHNlIHsKICAgIHBhdGgyICs9ICJMIi5jb25jYXQoY3gsICIsIikuY29uY2F0KGN5LCAiWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBkZWZhdWx0U2VjdG9yUHJvcHMgPSB7CiAgY3g6IDAsCiAgY3k6IDAsCiAgaW5uZXJSYWRpdXM6IDAsCiAgb3V0ZXJSYWRpdXM6IDAsCiAgc3RhcnRBbmdsZTogMCwKICBlbmRBbmdsZTogMCwKICBjb3JuZXJSYWRpdXM6IDAsCiAgZm9yY2VDb3JuZXJSYWRpdXM6IGZhbHNlLAogIGNvcm5lcklzRXh0ZXJuYWw6IGZhbHNlCn07CnZhciBTZWN0b3IgPSAoc2VjdG9yUHJvcHMpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHNlY3RvclByb3BzLCBkZWZhdWx0U2VjdG9yUHJvcHMpOwogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIGNvcm5lclJhZGl1cywKICAgIGZvcmNlQ29ybmVyUmFkaXVzLAogICAgY29ybmVySXNFeHRlcm5hbCwKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZSwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICBpZiAob3V0ZXJSYWRpdXMgPCBpbm5lclJhZGl1cyB8fCBzdGFydEFuZ2xlID09PSBlbmRBbmdsZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtc2VjdG9yIiwgY2xhc3NOYW1lKTsKICB2YXIgZGVsdGFSYWRpdXMgPSBvdXRlclJhZGl1cyAtIGlubmVyUmFkaXVzOwogIHZhciBjciA9IGdldFBlcmNlbnRWYWx1ZShjb3JuZXJSYWRpdXMsIGRlbHRhUmFkaXVzLCAwLCB0cnVlKTsKICB2YXIgcGF0aDI7CiAgaWYgKGNyID4gMCAmJiBNYXRoLmFicyhzdGFydEFuZ2xlIC0gZW5kQW5nbGUpIDwgMzYwKSB7CiAgICBwYXRoMiA9IGdldFNlY3RvcldpdGhDb3JuZXIoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIGlubmVyUmFkaXVzLAogICAgICBvdXRlclJhZGl1cywKICAgICAgY29ybmVyUmFkaXVzOiBNYXRoLm1pbihjciwgZGVsdGFSYWRpdXMgLyAyKSwKICAgICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9KTsKICB9IGVsc2UgewogICAgcGF0aDIgPSBnZXRTZWN0b3JQYXRoKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBpbm5lclJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEwLmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczgoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICBkOiBwYXRoMgogIH0pKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9jdXJzb3IvZ2V0Q3Vyc29yUG9pbnRzLmpzCmZ1bmN0aW9uIGdldEN1cnNvclBvaW50cyhsYXlvdXQsIGFjdGl2ZUNvb3JkaW5hdGUsIG9mZnNldCkgewogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIFt7CiAgICAgIHg6IGFjdGl2ZUNvb3JkaW5hdGUueCwKICAgICAgeTogb2Zmc2V0LnRvcAogICAgfSwgewogICAgICB4OiBhY3RpdmVDb29yZGluYXRlLngsCiAgICAgIHk6IG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0CiAgICB9XTsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIFt7CiAgICAgIHg6IG9mZnNldC5sZWZ0LAogICAgICB5OiBhY3RpdmVDb29yZGluYXRlLnkKICAgIH0sIHsKICAgICAgeDogb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGgsCiAgICAgIHk6IGFjdGl2ZUNvb3JkaW5hdGUueQogICAgfV07CiAgfQogIGlmIChpc1BvbGFyQ29vcmRpbmF0ZShhY3RpdmVDb29yZGluYXRlKSkgewogICAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICAgIHZhciB7CiAgICAgICAgY3gsCiAgICAgICAgY3ksCiAgICAgICAgaW5uZXJSYWRpdXMsCiAgICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgICAgYW5nbGUKICAgICAgfSA9IGFjdGl2ZUNvb3JkaW5hdGU7CiAgICAgIHZhciBpbm5lclBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGlubmVyUmFkaXVzLCBhbmdsZSk7CiAgICAgIHZhciBvdXRlclBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCBhbmdsZSk7CiAgICAgIHJldHVybiBbewogICAgICAgIHg6IGlubmVyUG9pbnQueCwKICAgICAgICB5OiBpbm5lclBvaW50LnkKICAgICAgfSwgewogICAgICAgIHg6IG91dGVyUG9pbnQueCwKICAgICAgICB5OiBvdXRlclBvaW50LnkKICAgICAgfV07CiAgICB9CiAgICByZXR1cm4gZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzKGFjdGl2ZUNvb3JkaW5hdGUpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9heGlzU2VsZWN0b3JzLmpzCnZhciBpbXBvcnRfcmFuZ2UyID0gX190b0VTTShyZXF1aXJlX3JhbmdlMigpKTsKCi8vIG5vZGVfbW9kdWxlcy92aWN0b3J5LXZlbmRvci9lcy9kMy1zY2FsZS5qcwp2YXIgZDNfc2NhbGVfZXhwb3J0cyA9IHt9OwpfX2V4cG9ydChkM19zY2FsZV9leHBvcnRzLCB7CiAgc2NhbGVCYW5kOiAoKSA9PiBiYW5kLAogIHNjYWxlRGl2ZXJnaW5nOiAoKSA9PiBkaXZlcmdpbmcsCiAgc2NhbGVEaXZlcmdpbmdMb2c6ICgpID0+IGRpdmVyZ2luZ0xvZywKICBzY2FsZURpdmVyZ2luZ1BvdzogKCkgPT4gZGl2ZXJnaW5nUG93LAogIHNjYWxlRGl2ZXJnaW5nU3FydDogKCkgPT4gZGl2ZXJnaW5nU3FydCwKICBzY2FsZURpdmVyZ2luZ1N5bWxvZzogKCkgPT4gZGl2ZXJnaW5nU3ltbG9nLAogIHNjYWxlSWRlbnRpdHk6ICgpID0+IGlkZW50aXR5MiwKICBzY2FsZUltcGxpY2l0OiAoKSA9PiBpbXBsaWNpdCwKICBzY2FsZUxpbmVhcjogKCkgPT4gbGluZWFyMiwKICBzY2FsZUxvZzogKCkgPT4gbG9nLAogIHNjYWxlT3JkaW5hbDogKCkgPT4gb3JkaW5hbCwKICBzY2FsZVBvaW50OiAoKSA9PiBwb2ludDMsCiAgc2NhbGVQb3c6ICgpID0+IHBvdywKICBzY2FsZVF1YW50aWxlOiAoKSA9PiBxdWFudGlsZTIsCiAgc2NhbGVRdWFudGl6ZTogKCkgPT4gcXVhbnRpemUsCiAgc2NhbGVSYWRpYWw6ICgpID0+IHJhZGlhbCwKICBzY2FsZVNlcXVlbnRpYWw6ICgpID0+IHNlcXVlbnRpYWwsCiAgc2NhbGVTZXF1ZW50aWFsTG9nOiAoKSA9PiBzZXF1ZW50aWFsTG9nLAogIHNjYWxlU2VxdWVudGlhbFBvdzogKCkgPT4gc2VxdWVudGlhbFBvdywKICBzY2FsZVNlcXVlbnRpYWxRdWFudGlsZTogKCkgPT4gc2VxdWVudGlhbFF1YW50aWxlLAogIHNjYWxlU2VxdWVudGlhbFNxcnQ6ICgpID0+IHNlcXVlbnRpYWxTcXJ0LAogIHNjYWxlU2VxdWVudGlhbFN5bWxvZzogKCkgPT4gc2VxdWVudGlhbFN5bWxvZywKICBzY2FsZVNxcnQ6ICgpID0+IHNxcnQsCiAgc2NhbGVTeW1sb2c6ICgpID0+IHN5bWxvZywKICBzY2FsZVRocmVzaG9sZDogKCkgPT4gdGhyZXNob2xkLAogIHNjYWxlVGltZTogKCkgPT4gdGltZSwKICBzY2FsZVV0YzogKCkgPT4gdXRjVGltZSwKICB0aWNrRm9ybWF0OiAoKSA9PiB0aWNrRm9ybWF0Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9hc2NlbmRpbmcuanMKZnVuY3Rpb24gYXNjZW5kaW5nKGEsIGIpIHsKICByZXR1cm4gYSA9PSBudWxsIHx8IGIgPT0gbnVsbCA/IE5hTiA6IGEgPCBiID8gLTEgOiBhID4gYiA/IDEgOiBhID49IGIgPyAwIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL2Rlc2NlbmRpbmcuanMKZnVuY3Rpb24gZGVzY2VuZGluZyhhLCBiKSB7CiAgcmV0dXJuIGEgPT0gbnVsbCB8fCBiID09IG51bGwgPyBOYU4gOiBiIDwgYSA/IC0xIDogYiA+IGEgPyAxIDogYiA+PSBhID8gMCA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9iaXNlY3Rvci5qcwpmdW5jdGlvbiBiaXNlY3RvcihmKSB7CiAgbGV0IGNvbXBhcmUxLCBjb21wYXJlMiwgZGVsdGE7CiAgaWYgKGYubGVuZ3RoICE9PSAyKSB7CiAgICBjb21wYXJlMSA9IGFzY2VuZGluZzsKICAgIGNvbXBhcmUyID0gKGQsIHgyKSA9PiBhc2NlbmRpbmcoZihkKSwgeDIpOwogICAgZGVsdGEgPSAoZCwgeDIpID0+IGYoZCkgLSB4MjsKICB9IGVsc2UgewogICAgY29tcGFyZTEgPSBmID09PSBhc2NlbmRpbmcgfHwgZiA9PT0gZGVzY2VuZGluZyA/IGYgOiB6ZXJvOwogICAgY29tcGFyZTIgPSBmOwogICAgZGVsdGEgPSBmOwogIH0KICBmdW5jdGlvbiBsZWZ0KGEsIHgyLCBsbyA9IDAsIGhpID0gYS5sZW5ndGgpIHsKICAgIGlmIChsbyA8IGhpKSB7CiAgICAgIGlmIChjb21wYXJlMSh4MiwgeDIpICE9PSAwKSByZXR1cm4gaGk7CiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtaWQgPSBsbyArIGhpID4+PiAxOwogICAgICAgIGlmIChjb21wYXJlMihhW21pZF0sIHgyKSA8IDApIGxvID0gbWlkICsgMTsKICAgICAgICBlbHNlIGhpID0gbWlkOwogICAgICB9IHdoaWxlIChsbyA8IGhpKTsKICAgIH0KICAgIHJldHVybiBsbzsKICB9CiAgZnVuY3Rpb24gcmlnaHQoYSwgeDIsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgaWYgKGxvIDwgaGkpIHsKICAgICAgaWYgKGNvbXBhcmUxKHgyLCB4MikgIT09IDApIHJldHVybiBoaTsKICAgICAgZG8gewogICAgICAgIGNvbnN0IG1pZCA9IGxvICsgaGkgPj4+IDE7CiAgICAgICAgaWYgKGNvbXBhcmUyKGFbbWlkXSwgeDIpIDw9IDApIGxvID0gbWlkICsgMTsKICAgICAgICBlbHNlIGhpID0gbWlkOwogICAgICB9IHdoaWxlIChsbyA8IGhpKTsKICAgIH0KICAgIHJldHVybiBsbzsKICB9CiAgZnVuY3Rpb24gY2VudGVyKGEsIHgyLCBsbyA9IDAsIGhpID0gYS5sZW5ndGgpIHsKICAgIGNvbnN0IGkgPSBsZWZ0KGEsIHgyLCBsbywgaGkgLSAxKTsKICAgIHJldHVybiBpID4gbG8gJiYgZGVsdGEoYVtpIC0gMV0sIHgyKSA+IC1kZWx0YShhW2ldLCB4MikgPyBpIC0gMSA6IGk7CiAgfQogIHJldHVybiB7IGxlZnQsIGNlbnRlciwgcmlnaHQgfTsKfQpmdW5jdGlvbiB6ZXJvKCkgewogIHJldHVybiAwOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL251bWJlci5qcwpmdW5jdGlvbiBudW1iZXIoeDIpIHsKICByZXR1cm4geDIgPT09IG51bGwgPyBOYU4gOiAreDI7Cn0KZnVuY3Rpb24qIG51bWJlcnModmFsdWVzLCB2YWx1ZW9mKSB7CiAgaWYgKHZhbHVlb2YgPT09IHZvaWQgMCkgewogICAgZm9yIChsZXQgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmICh2YWx1ZSA9ICt2YWx1ZSkgPj0gdmFsdWUpIHsKICAgICAgICB5aWVsZCB2YWx1ZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBsZXQgaW5kZXggPSAtMTsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAoKHZhbHVlID0gdmFsdWVvZih2YWx1ZSwgKytpbmRleCwgdmFsdWVzKSkgIT0gbnVsbCAmJiAodmFsdWUgPSArdmFsdWUpID49IHZhbHVlKSB7CiAgICAgICAgeWllbGQgdmFsdWU7CiAgICAgIH0KICAgIH0KICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYmlzZWN0LmpzCnZhciBhc2NlbmRpbmdCaXNlY3QgPSBiaXNlY3Rvcihhc2NlbmRpbmcpOwp2YXIgYmlzZWN0UmlnaHQgPSBhc2NlbmRpbmdCaXNlY3QucmlnaHQ7CnZhciBiaXNlY3RMZWZ0ID0gYXNjZW5kaW5nQmlzZWN0LmxlZnQ7CnZhciBiaXNlY3RDZW50ZXIgPSBiaXNlY3RvcihudW1iZXIpLmNlbnRlcjsKdmFyIGJpc2VjdF9kZWZhdWx0ID0gYmlzZWN0UmlnaHQ7CgovLyBub2RlX21vZHVsZXMvaW50ZXJubWFwL3NyYy9pbmRleC5qcwp2YXIgSW50ZXJuTWFwID0gY2xhc3MgZXh0ZW5kcyBNYXAgewogIGNvbnN0cnVjdG9yKGVudHJpZXMsIGtleSA9IGtleW9mKSB7CiAgICBzdXBlcigpOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgeyBfaW50ZXJuOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpIH0sIF9rZXk6IHsgdmFsdWU6IGtleSB9IH0pOwogICAgaWYgKGVudHJpZXMgIT0gbnVsbCkgZm9yIChjb25zdCBba2V5MiwgdmFsdWVdIG9mIGVudHJpZXMpIHRoaXMuc2V0KGtleTIsIHZhbHVlKTsKICB9CiAgZ2V0KGtleSkgewogICAgcmV0dXJuIHN1cGVyLmdldChpbnRlcm5fZ2V0KHRoaXMsIGtleSkpOwogIH0KICBoYXMoa2V5KSB7CiAgICByZXR1cm4gc3VwZXIuaGFzKGludGVybl9nZXQodGhpcywga2V5KSk7CiAgfQogIHNldChrZXksIHZhbHVlKSB7CiAgICByZXR1cm4gc3VwZXIuc2V0KGludGVybl9zZXQodGhpcywga2V5KSwgdmFsdWUpOwogIH0KICBkZWxldGUoa2V5KSB7CiAgICByZXR1cm4gc3VwZXIuZGVsZXRlKGludGVybl9kZWxldGUodGhpcywga2V5KSk7CiAgfQp9OwpmdW5jdGlvbiBpbnRlcm5fZ2V0KHsgX2ludGVybiwgX2tleSB9LCB2YWx1ZSkgewogIGNvbnN0IGtleSA9IF9rZXkodmFsdWUpOwogIHJldHVybiBfaW50ZXJuLmhhcyhrZXkpID8gX2ludGVybi5nZXQoa2V5KSA6IHZhbHVlOwp9CmZ1bmN0aW9uIGludGVybl9zZXQoeyBfaW50ZXJuLCBfa2V5IH0sIHZhbHVlKSB7CiAgY29uc3Qga2V5ID0gX2tleSh2YWx1ZSk7CiAgaWYgKF9pbnRlcm4uaGFzKGtleSkpIHJldHVybiBfaW50ZXJuLmdldChrZXkpOwogIF9pbnRlcm4uc2V0KGtleSwgdmFsdWUpOwogIHJldHVybiB2YWx1ZTsKfQpmdW5jdGlvbiBpbnRlcm5fZGVsZXRlKHsgX2ludGVybiwgX2tleSB9LCB2YWx1ZSkgewogIGNvbnN0IGtleSA9IF9rZXkodmFsdWUpOwogIGlmIChfaW50ZXJuLmhhcyhrZXkpKSB7CiAgICB2YWx1ZSA9IF9pbnRlcm4uZ2V0KGtleSk7CiAgICBfaW50ZXJuLmRlbGV0ZShrZXkpOwogIH0KICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24ga2V5b2YodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiA/IHZhbHVlLnZhbHVlT2YoKSA6IHZhbHVlOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3NvcnQuanMKZnVuY3Rpb24gY29tcGFyZURlZmluZWQoY29tcGFyZSA9IGFzY2VuZGluZykgewogIGlmIChjb21wYXJlID09PSBhc2NlbmRpbmcpIHJldHVybiBhc2NlbmRpbmdEZWZpbmVkOwogIGlmICh0eXBlb2YgY29tcGFyZSAhPT0gImZ1bmN0aW9uIikgdGhyb3cgbmV3IFR5cGVFcnJvcigiY29tcGFyZSBpcyBub3QgYSBmdW5jdGlvbiIpOwogIHJldHVybiAoYSwgYikgPT4gewogICAgY29uc3QgeDIgPSBjb21wYXJlKGEsIGIpOwogICAgaWYgKHgyIHx8IHgyID09PSAwKSByZXR1cm4geDI7CiAgICByZXR1cm4gKGNvbXBhcmUoYiwgYikgPT09IDApIC0gKGNvbXBhcmUoYSwgYSkgPT09IDApOwogIH07Cn0KZnVuY3Rpb24gYXNjZW5kaW5nRGVmaW5lZChhLCBiKSB7CiAgcmV0dXJuIChhID09IG51bGwgfHwgIShhID49IGEpKSAtIChiID09IG51bGwgfHwgIShiID49IGIpKSB8fCAoYSA8IGIgPyAtMSA6IGEgPiBiID8gMSA6IDApOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3RpY2tzLmpzCnZhciBlMTAgPSBNYXRoLnNxcnQoNTApOwp2YXIgZTUgPSBNYXRoLnNxcnQoMTApOwp2YXIgZTIgPSBNYXRoLnNxcnQoMik7CmZ1bmN0aW9uIHRpY2tTcGVjKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIGNvbnN0IHN0ZXAgPSAoc3RvcCAtIHN0YXJ0KSAvIE1hdGgubWF4KDAsIGNvdW50KSwgcG93ZXIgPSBNYXRoLmZsb29yKE1hdGgubG9nMTAoc3RlcCkpLCBlcnJvciA9IHN0ZXAgLyBNYXRoLnBvdygxMCwgcG93ZXIpLCBmYWN0b3IgPSBlcnJvciA+PSBlMTAgPyAxMCA6IGVycm9yID49IGU1ID8gNSA6IGVycm9yID49IGUyID8gMiA6IDE7CiAgbGV0IGkxLCBpMiwgaW5jOwogIGlmIChwb3dlciA8IDApIHsKICAgIGluYyA9IE1hdGgucG93KDEwLCAtcG93ZXIpIC8gZmFjdG9yOwogICAgaTEgPSBNYXRoLnJvdW5kKHN0YXJ0ICogaW5jKTsKICAgIGkyID0gTWF0aC5yb3VuZChzdG9wICogaW5jKTsKICAgIGlmIChpMSAvIGluYyA8IHN0YXJ0KSArK2kxOwogICAgaWYgKGkyIC8gaW5jID4gc3RvcCkgLS1pMjsKICAgIGluYyA9IC1pbmM7CiAgfSBlbHNlIHsKICAgIGluYyA9IE1hdGgucG93KDEwLCBwb3dlcikgKiBmYWN0b3I7CiAgICBpMSA9IE1hdGgucm91bmQoc3RhcnQgLyBpbmMpOwogICAgaTIgPSBNYXRoLnJvdW5kKHN0b3AgLyBpbmMpOwogICAgaWYgKGkxICogaW5jIDwgc3RhcnQpICsraTE7CiAgICBpZiAoaTIgKiBpbmMgPiBzdG9wKSAtLWkyOwogIH0KICBpZiAoaTIgPCBpMSAmJiAwLjUgPD0gY291bnQgJiYgY291bnQgPCAyKSByZXR1cm4gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50ICogMik7CiAgcmV0dXJuIFtpMSwgaTIsIGluY107Cn0KZnVuY3Rpb24gdGlja3Moc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgc3RvcCA9ICtzdG9wLCBzdGFydCA9ICtzdGFydCwgY291bnQgPSArY291bnQ7CiAgaWYgKCEoY291bnQgPiAwKSkgcmV0dXJuIFtdOwogIGlmIChzdGFydCA9PT0gc3RvcCkgcmV0dXJuIFtzdGFydF07CiAgY29uc3QgcmV2ZXJzZTIgPSBzdG9wIDwgc3RhcnQsIFtpMSwgaTIsIGluY10gPSByZXZlcnNlMiA/IHRpY2tTcGVjKHN0b3AsIHN0YXJ0LCBjb3VudCkgOiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpOwogIGlmICghKGkyID49IGkxKSkgcmV0dXJuIFtdOwogIGNvbnN0IG4gPSBpMiAtIGkxICsgMSwgdGlja3MyID0gbmV3IEFycmF5KG4pOwogIGlmIChyZXZlcnNlMikgewogICAgaWYgKGluYyA8IDApIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTIgLSBpKSAvIC1pbmM7CiAgICBlbHNlIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTIgLSBpKSAqIGluYzsKICB9IGVsc2UgewogICAgaWYgKGluYyA8IDApIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTEgKyBpKSAvIC1pbmM7CiAgICBlbHNlIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTEgKyBpKSAqIGluYzsKICB9CiAgcmV0dXJuIHRpY2tzMjsKfQpmdW5jdGlvbiB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIHJldHVybiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpWzJdOwp9CmZ1bmN0aW9uIHRpY2tTdGVwKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIGNvbnN0IHJldmVyc2UyID0gc3RvcCA8IHN0YXJ0LCBpbmMgPSByZXZlcnNlMiA/IHRpY2tJbmNyZW1lbnQoc3RvcCwgc3RhcnQsIGNvdW50KSA6IHRpY2tJbmNyZW1lbnQoc3RhcnQsIHN0b3AsIGNvdW50KTsKICByZXR1cm4gKHJldmVyc2UyID8gLTEgOiAxKSAqIChpbmMgPCAwID8gMSAvIC1pbmMgOiBpbmMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL21heC5qcwpmdW5jdGlvbiBtYXgodmFsdWVzLCB2YWx1ZW9mKSB7CiAgbGV0IG1heDI7CiAgaWYgKHZhbHVlb2YgPT09IHZvaWQgMCkgewogICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgKG1heDIgPCB2YWx1ZSB8fCBtYXgyID09PSB2b2lkIDAgJiYgdmFsdWUgPj0gdmFsdWUpKSB7CiAgICAgICAgbWF4MiA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGxldCBpbmRleCA9IC0xOwogICAgZm9yIChsZXQgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICgodmFsdWUgPSB2YWx1ZW9mKHZhbHVlLCArK2luZGV4LCB2YWx1ZXMpKSAhPSBudWxsICYmIChtYXgyIDwgdmFsdWUgfHwgbWF4MiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1heDIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbWF4MjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9taW4uanMKZnVuY3Rpb24gbWluKHZhbHVlcywgdmFsdWVvZikgewogIGxldCBtaW4yOwogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIChtaW4yID4gdmFsdWUgfHwgbWluMiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1pbjIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBsZXQgaW5kZXggPSAtMTsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAoKHZhbHVlID0gdmFsdWVvZih2YWx1ZSwgKytpbmRleCwgdmFsdWVzKSkgIT0gbnVsbCAmJiAobWluMiA+IHZhbHVlIHx8IG1pbjIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtaW4yID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1pbjI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcXVpY2tzZWxlY3QuanMKZnVuY3Rpb24gcXVpY2tzZWxlY3QoYXJyYXksIGssIGxlZnQgPSAwLCByaWdodCA9IEluZmluaXR5LCBjb21wYXJlKSB7CiAgayA9IE1hdGguZmxvb3Ioayk7CiAgbGVmdCA9IE1hdGguZmxvb3IoTWF0aC5tYXgoMCwgbGVmdCkpOwogIHJpZ2h0ID0gTWF0aC5mbG9vcihNYXRoLm1pbihhcnJheS5sZW5ndGggLSAxLCByaWdodCkpOwogIGlmICghKGxlZnQgPD0gayAmJiBrIDw9IHJpZ2h0KSkgcmV0dXJuIGFycmF5OwogIGNvbXBhcmUgPSBjb21wYXJlID09PSB2b2lkIDAgPyBhc2NlbmRpbmdEZWZpbmVkIDogY29tcGFyZURlZmluZWQoY29tcGFyZSk7CiAgd2hpbGUgKHJpZ2h0ID4gbGVmdCkgewogICAgaWYgKHJpZ2h0IC0gbGVmdCA+IDYwMCkgewogICAgICBjb25zdCBuID0gcmlnaHQgLSBsZWZ0ICsgMTsKICAgICAgY29uc3QgbSA9IGsgLSBsZWZ0ICsgMTsKICAgICAgY29uc3QgeiA9IE1hdGgubG9nKG4pOwogICAgICBjb25zdCBzID0gMC41ICogTWF0aC5leHAoMiAqIHogLyAzKTsKICAgICAgY29uc3Qgc2QgPSAwLjUgKiBNYXRoLnNxcnQoeiAqIHMgKiAobiAtIHMpIC8gbikgKiAobSAtIG4gLyAyIDwgMCA/IC0xIDogMSk7CiAgICAgIGNvbnN0IG5ld0xlZnQgPSBNYXRoLm1heChsZWZ0LCBNYXRoLmZsb29yKGsgLSBtICogcyAvIG4gKyBzZCkpOwogICAgICBjb25zdCBuZXdSaWdodCA9IE1hdGgubWluKHJpZ2h0LCBNYXRoLmZsb29yKGsgKyAobiAtIG0pICogcyAvIG4gKyBzZCkpOwogICAgICBxdWlja3NlbGVjdChhcnJheSwgaywgbmV3TGVmdCwgbmV3UmlnaHQsIGNvbXBhcmUpOwogICAgfQogICAgY29uc3QgdCA9IGFycmF5W2tdOwogICAgbGV0IGkgPSBsZWZ0OwogICAgbGV0IGogPSByaWdodDsKICAgIHN3YXAoYXJyYXksIGxlZnQsIGspOwogICAgaWYgKGNvbXBhcmUoYXJyYXlbcmlnaHRdLCB0KSA+IDApIHN3YXAoYXJyYXksIGxlZnQsIHJpZ2h0KTsKICAgIHdoaWxlIChpIDwgaikgewogICAgICBzd2FwKGFycmF5LCBpLCBqKSwgKytpLCAtLWo7CiAgICAgIHdoaWxlIChjb21wYXJlKGFycmF5W2ldLCB0KSA8IDApICsraTsKICAgICAgd2hpbGUgKGNvbXBhcmUoYXJyYXlbal0sIHQpID4gMCkgLS1qOwogICAgfQogICAgaWYgKGNvbXBhcmUoYXJyYXlbbGVmdF0sIHQpID09PSAwKSBzd2FwKGFycmF5LCBsZWZ0LCBqKTsKICAgIGVsc2UgKytqLCBzd2FwKGFycmF5LCBqLCByaWdodCk7CiAgICBpZiAoaiA8PSBrKSBsZWZ0ID0gaiArIDE7CiAgICBpZiAoayA8PSBqKSByaWdodCA9IGogLSAxOwogIH0KICByZXR1cm4gYXJyYXk7Cn0KZnVuY3Rpb24gc3dhcChhcnJheSwgaSwgaikgewogIGNvbnN0IHQgPSBhcnJheVtpXTsKICBhcnJheVtpXSA9IGFycmF5W2pdOwogIGFycmF5W2pdID0gdDsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9xdWFudGlsZS5qcwpmdW5jdGlvbiBxdWFudGlsZSh2YWx1ZXMsIHAsIHZhbHVlb2YpIHsKICB2YWx1ZXMgPSBGbG9hdDY0QXJyYXkuZnJvbShudW1iZXJzKHZhbHVlcywgdmFsdWVvZikpOwogIGlmICghKG4gPSB2YWx1ZXMubGVuZ3RoKSB8fCBpc05hTihwID0gK3ApKSByZXR1cm47CiAgaWYgKHAgPD0gMCB8fCBuIDwgMikgcmV0dXJuIG1pbih2YWx1ZXMpOwogIGlmIChwID49IDEpIHJldHVybiBtYXgodmFsdWVzKTsKICB2YXIgbiwgaSA9IChuIC0gMSkgKiBwLCBpMCA9IE1hdGguZmxvb3IoaSksIHZhbHVlMCA9IG1heChxdWlja3NlbGVjdCh2YWx1ZXMsIGkwKS5zdWJhcnJheSgwLCBpMCArIDEpKSwgdmFsdWUxID0gbWluKHZhbHVlcy5zdWJhcnJheShpMCArIDEpKTsKICByZXR1cm4gdmFsdWUwICsgKHZhbHVlMSAtIHZhbHVlMCkgKiAoaSAtIGkwKTsKfQpmdW5jdGlvbiBxdWFudGlsZVNvcnRlZCh2YWx1ZXMsIHAsIHZhbHVlb2YgPSBudW1iZXIpIHsKICBpZiAoIShuID0gdmFsdWVzLmxlbmd0aCkgfHwgaXNOYU4ocCA9ICtwKSkgcmV0dXJuOwogIGlmIChwIDw9IDAgfHwgbiA8IDIpIHJldHVybiArdmFsdWVvZih2YWx1ZXNbMF0sIDAsIHZhbHVlcyk7CiAgaWYgKHAgPj0gMSkgcmV0dXJuICt2YWx1ZW9mKHZhbHVlc1tuIC0gMV0sIG4gLSAxLCB2YWx1ZXMpOwogIHZhciBuLCBpID0gKG4gLSAxKSAqIHAsIGkwID0gTWF0aC5mbG9vcihpKSwgdmFsdWUwID0gK3ZhbHVlb2YodmFsdWVzW2kwXSwgaTAsIHZhbHVlcyksIHZhbHVlMSA9ICt2YWx1ZW9mKHZhbHVlc1tpMCArIDFdLCBpMCArIDEsIHZhbHVlcyk7CiAgcmV0dXJuIHZhbHVlMCArICh2YWx1ZTEgLSB2YWx1ZTApICogKGkgLSBpMCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcmFuZ2UuanMKZnVuY3Rpb24gcmFuZ2Uoc3RhcnQsIHN0b3AsIHN0ZXApIHsKICBzdGFydCA9ICtzdGFydCwgc3RvcCA9ICtzdG9wLCBzdGVwID0gKG4gPSBhcmd1bWVudHMubGVuZ3RoKSA8IDIgPyAoc3RvcCA9IHN0YXJ0LCBzdGFydCA9IDAsIDEpIDogbiA8IDMgPyAxIDogK3N0ZXA7CiAgdmFyIGkgPSAtMSwgbiA9IE1hdGgubWF4KDAsIE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApKSB8IDAsIHJhbmdlNCA9IG5ldyBBcnJheShuKTsKICB3aGlsZSAoKytpIDwgbikgewogICAgcmFuZ2U0W2ldID0gc3RhcnQgKyBpICogc3RlcDsKICB9CiAgcmV0dXJuIHJhbmdlNDsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9pbml0LmpzCmZ1bmN0aW9uIGluaXRSYW5nZShkb21haW4sIHJhbmdlNCkgewogIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgY2FzZSAwOgogICAgICBicmVhazsKICAgIGNhc2UgMToKICAgICAgdGhpcy5yYW5nZShkb21haW4pOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHRoaXMucmFuZ2UocmFuZ2U0KS5kb21haW4oZG9tYWluKTsKICAgICAgYnJlYWs7CiAgfQogIHJldHVybiB0aGlzOwp9CmZ1bmN0aW9uIGluaXRJbnRlcnBvbGF0b3IoZG9tYWluLCBpbnRlcnBvbGF0b3IpIHsKICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIGNhc2UgMDoKICAgICAgYnJlYWs7CiAgICBjYXNlIDE6IHsKICAgICAgaWYgKHR5cGVvZiBkb21haW4gPT09ICJmdW5jdGlvbiIpIHRoaXMuaW50ZXJwb2xhdG9yKGRvbWFpbik7CiAgICAgIGVsc2UgdGhpcy5yYW5nZShkb21haW4pOwogICAgICBicmVhazsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgdGhpcy5kb21haW4oZG9tYWluKTsKICAgICAgaWYgKHR5cGVvZiBpbnRlcnBvbGF0b3IgPT09ICJmdW5jdGlvbiIpIHRoaXMuaW50ZXJwb2xhdG9yKGludGVycG9sYXRvcik7CiAgICAgIGVsc2UgdGhpcy5yYW5nZShpbnRlcnBvbGF0b3IpOwogICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIHRoaXM7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvb3JkaW5hbC5qcwp2YXIgaW1wbGljaXQgPSBTeW1ib2woImltcGxpY2l0Iik7CmZ1bmN0aW9uIG9yZGluYWwoKSB7CiAgdmFyIGluZGV4ID0gbmV3IEludGVybk1hcCgpLCBkb21haW4gPSBbXSwgcmFuZ2U0ID0gW10sIHVua25vd24gPSBpbXBsaWNpdDsKICBmdW5jdGlvbiBzY2FsZShkKSB7CiAgICBsZXQgaSA9IGluZGV4LmdldChkKTsKICAgIGlmIChpID09PSB2b2lkIDApIHsKICAgICAgaWYgKHVua25vd24gIT09IGltcGxpY2l0KSByZXR1cm4gdW5rbm93bjsKICAgICAgaW5kZXguc2V0KGQsIGkgPSBkb21haW4ucHVzaChkKSAtIDEpOwogICAgfQogICAgcmV0dXJuIHJhbmdlNFtpICUgcmFuZ2U0Lmxlbmd0aF07CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGRvbWFpbi5zbGljZSgpOwogICAgZG9tYWluID0gW10sIGluZGV4ID0gbmV3IEludGVybk1hcCgpOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiBfKSB7CiAgICAgIGlmIChpbmRleC5oYXModmFsdWUpKSBjb250aW51ZTsKICAgICAgaW5kZXguc2V0KHZhbHVlLCBkb21haW4ucHVzaCh2YWx1ZSkgLSAxKTsKICAgIH0KICAgIHJldHVybiBzY2FsZTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgc2NhbGUpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gb3JkaW5hbChkb21haW4sIHJhbmdlNCkudW5rbm93bih1bmtub3duKTsKICB9OwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gc2NhbGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvYmFuZC5qcwpmdW5jdGlvbiBiYW5kKCkgewogIHZhciBzY2FsZSA9IG9yZGluYWwoKS51bmtub3duKHZvaWQgMCksIGRvbWFpbiA9IHNjYWxlLmRvbWFpbiwgb3JkaW5hbFJhbmdlID0gc2NhbGUucmFuZ2UsIHIwID0gMCwgcjEgPSAxLCBzdGVwLCBiYW5kd2lkdGgsIHJvdW5kID0gZmFsc2UsIHBhZGRpbmdJbm5lciA9IDAsIHBhZGRpbmdPdXRlciA9IDAsIGFsaWduID0gMC41OwogIGRlbGV0ZSBzY2FsZS51bmtub3duOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICB2YXIgbiA9IGRvbWFpbigpLmxlbmd0aCwgcmV2ZXJzZTIgPSByMSA8IHIwLCBzdGFydCA9IHJldmVyc2UyID8gcjEgOiByMCwgc3RvcCA9IHJldmVyc2UyID8gcjAgOiByMTsKICAgIHN0ZXAgPSAoc3RvcCAtIHN0YXJ0KSAvIE1hdGgubWF4KDEsIG4gLSBwYWRkaW5nSW5uZXIgKyBwYWRkaW5nT3V0ZXIgKiAyKTsKICAgIGlmIChyb3VuZCkgc3RlcCA9IE1hdGguZmxvb3Ioc3RlcCk7CiAgICBzdGFydCArPSAoc3RvcCAtIHN0YXJ0IC0gc3RlcCAqIChuIC0gcGFkZGluZ0lubmVyKSkgKiBhbGlnbjsKICAgIGJhbmR3aWR0aCA9IHN0ZXAgKiAoMSAtIHBhZGRpbmdJbm5lcik7CiAgICBpZiAocm91bmQpIHN0YXJ0ID0gTWF0aC5yb3VuZChzdGFydCksIGJhbmR3aWR0aCA9IE1hdGgucm91bmQoYmFuZHdpZHRoKTsKICAgIHZhciB2YWx1ZXMgPSByYW5nZShuKS5tYXAoZnVuY3Rpb24oaSkgewogICAgICByZXR1cm4gc3RhcnQgKyBzdGVwICogaTsKICAgIH0pOwogICAgcmV0dXJuIG9yZGluYWxSYW5nZShyZXZlcnNlMiA/IHZhbHVlcy5yZXZlcnNlKCkgOiB2YWx1ZXMpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4oXyksIHJlc2NhbGUoKSkgOiBkb21haW4oKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3IwLCByMV0gPSBfLCByMCA9ICtyMCwgcjEgPSArcjEsIHJlc2NhbGUoKSkgOiBbcjAsIHIxXTsKICB9OwogIHNjYWxlLnJhbmdlUm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gW3IwLCByMV0gPSBfLCByMCA9ICtyMCwgcjEgPSArcjEsIHJvdW5kID0gdHJ1ZSwgcmVzY2FsZSgpOwogIH07CiAgc2NhbGUuYmFuZHdpZHRoID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYmFuZHdpZHRoOwogIH07CiAgc2NhbGUuc3RlcCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHN0ZXA7CiAgfTsKICBzY2FsZS5yb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJvdW5kID0gISFfLCByZXNjYWxlKCkpIDogcm91bmQ7CiAgfTsKICBzY2FsZS5wYWRkaW5nID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocGFkZGluZ0lubmVyID0gTWF0aC5taW4oMSwgcGFkZGluZ091dGVyID0gK18pLCByZXNjYWxlKCkpIDogcGFkZGluZ0lubmVyOwogIH07CiAgc2NhbGUucGFkZGluZ0lubmVyID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocGFkZGluZ0lubmVyID0gTWF0aC5taW4oMSwgXyksIHJlc2NhbGUoKSkgOiBwYWRkaW5nSW5uZXI7CiAgfTsKICBzY2FsZS5wYWRkaW5nT3V0ZXIgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nT3V0ZXIgPSArXywgcmVzY2FsZSgpKSA6IHBhZGRpbmdPdXRlcjsKICB9OwogIHNjYWxlLmFsaWduID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoYWxpZ24gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBfKSksIHJlc2NhbGUoKSkgOiBhbGlnbjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBiYW5kKGRvbWFpbigpLCBbcjAsIHIxXSkucm91bmQocm91bmQpLnBhZGRpbmdJbm5lcihwYWRkaW5nSW5uZXIpLnBhZGRpbmdPdXRlcihwYWRkaW5nT3V0ZXIpLmFsaWduKGFsaWduKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkocmVzY2FsZSgpLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHBvaW50aXNoKHNjYWxlKSB7CiAgdmFyIGNvcHkzID0gc2NhbGUuY29weTsKICBzY2FsZS5wYWRkaW5nID0gc2NhbGUucGFkZGluZ091dGVyOwogIGRlbGV0ZSBzY2FsZS5wYWRkaW5nSW5uZXI7CiAgZGVsZXRlIHNjYWxlLnBhZGRpbmdPdXRlcjsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcG9pbnRpc2goY29weTMoKSk7CiAgfTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gcG9pbnQzKCkgewogIHJldHVybiBwb2ludGlzaChiYW5kLmFwcGx5KG51bGwsIGFyZ3VtZW50cykucGFkZGluZ0lubmVyKDEpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWNvbG9yL3NyYy9kZWZpbmUuanMKZnVuY3Rpb24gZGVmaW5lX2RlZmF1bHQoY29uc3RydWN0b3IsIGZhY3RvcnksIHByb3RvdHlwZSkgewogIGNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IGZhY3RvcnkucHJvdG90eXBlID0gcHJvdG90eXBlOwogIHByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yOwp9CmZ1bmN0aW9uIGV4dGVuZChwYXJlbnQsIGRlZmluaXRpb24pIHsKICB2YXIgcHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQucHJvdG90eXBlKTsKICBmb3IgKHZhciBrZXkgaW4gZGVmaW5pdGlvbikgcHJvdG90eXBlW2tleV0gPSBkZWZpbml0aW9uW2tleV07CiAgcmV0dXJuIHByb3RvdHlwZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWNvbG9yL3NyYy9jb2xvci5qcwpmdW5jdGlvbiBDb2xvcigpIHsKfQp2YXIgZGFya2VyID0gMC43Owp2YXIgYnJpZ2h0ZXIgPSAxIC8gZGFya2VyOwp2YXIgcmVJID0gIlxccyooWystXT9cXGQrKVxccyoiOwp2YXIgcmVOID0gIlxccyooWystXT8oPzpcXGQqXFwuKT9cXGQrKD86W2VFXVsrLV0/XFxkKyk/KVxccyoiOwp2YXIgcmVQID0gIlxccyooWystXT8oPzpcXGQqXFwuKT9cXGQrKD86W2VFXVsrLV0/XFxkKyk/KSVcXHMqIjsKdmFyIHJlSGV4ID0gL14jKFswLTlhLWZdezMsOH0pJC87CnZhciByZVJnYkludGVnZXIgPSBuZXcgUmVnRXhwKGBecmdiXFwoJHtyZUl9LCR7cmVJfSwke3JlSX1cXCkkYCk7CnZhciByZVJnYlBlcmNlbnQgPSBuZXcgUmVnRXhwKGBecmdiXFwoJHtyZVB9LCR7cmVQfSwke3JlUH1cXCkkYCk7CnZhciByZVJnYmFJbnRlZ2VyID0gbmV3IFJlZ0V4cChgXnJnYmFcXCgke3JlSX0sJHtyZUl9LCR7cmVJfSwke3JlTn1cXCkkYCk7CnZhciByZVJnYmFQZXJjZW50ID0gbmV3IFJlZ0V4cChgXnJnYmFcXCgke3JlUH0sJHtyZVB9LCR7cmVQfSwke3JlTn1cXCkkYCk7CnZhciByZUhzbFBlcmNlbnQgPSBuZXcgUmVnRXhwKGBeaHNsXFwoJHtyZU59LCR7cmVQfSwke3JlUH1cXCkkYCk7CnZhciByZUhzbGFQZXJjZW50ID0gbmV3IFJlZ0V4cChgXmhzbGFcXCgke3JlTn0sJHtyZVB9LCR7cmVQfSwke3JlTn1cXCkkYCk7CnZhciBuYW1lZCA9IHsKICBhbGljZWJsdWU6IDE1NzkyMzgzLAogIGFudGlxdWV3aGl0ZTogMTY0NDQzNzUsCiAgYXF1YTogNjU1MzUsCiAgYXF1YW1hcmluZTogODM4ODU2NCwKICBhenVyZTogMTU3OTQxNzUsCiAgYmVpZ2U6IDE2MTE5MjYwLAogIGJpc3F1ZTogMTY3NzAyNDQsCiAgYmxhY2s6IDAsCiAgYmxhbmNoZWRhbG1vbmQ6IDE2NzcyMDQ1LAogIGJsdWU6IDI1NSwKICBibHVldmlvbGV0OiA5MDU1MjAyLAogIGJyb3duOiAxMDgyNDIzNCwKICBidXJseXdvb2Q6IDE0NTk2MjMxLAogIGNhZGV0Ymx1ZTogNjI2NjUyOCwKICBjaGFydHJldXNlOiA4Mzg4MzUyLAogIGNob2NvbGF0ZTogMTM3ODk0NzAsCiAgY29yYWw6IDE2NzQ0MjcyLAogIGNvcm5mbG93ZXJibHVlOiA2NTkxOTgxLAogIGNvcm5zaWxrOiAxNjc3NTM4OCwKICBjcmltc29uOiAxNDQyMzEwMCwKICBjeWFuOiA2NTUzNSwKICBkYXJrYmx1ZTogMTM5LAogIGRhcmtjeWFuOiAzNTcyMywKICBkYXJrZ29sZGVucm9kOiAxMjA5MjkzOSwKICBkYXJrZ3JheTogMTExMTkwMTcsCiAgZGFya2dyZWVuOiAyNTYwMCwKICBkYXJrZ3JleTogMTExMTkwMTcsCiAgZGFya2toYWtpOiAxMjQzMzI1OSwKICBkYXJrbWFnZW50YTogOTEwOTY0MywKICBkYXJrb2xpdmVncmVlbjogNTU5Nzk5OSwKICBkYXJrb3JhbmdlOiAxNjc0NzUyMCwKICBkYXJrb3JjaGlkOiAxMDA0MDAxMiwKICBkYXJrcmVkOiA5MTA5NTA0LAogIGRhcmtzYWxtb246IDE1MzA4NDEwLAogIGRhcmtzZWFncmVlbjogOTQxOTkxOSwKICBkYXJrc2xhdGVibHVlOiA0NzM0MzQ3LAogIGRhcmtzbGF0ZWdyYXk6IDMxMDA0OTUsCiAgZGFya3NsYXRlZ3JleTogMzEwMDQ5NSwKICBkYXJrdHVycXVvaXNlOiA1Mjk0NSwKICBkYXJrdmlvbGV0OiA5Njk5NTM5LAogIGRlZXBwaW5rOiAxNjcxNjk0NywKICBkZWVwc2t5Ymx1ZTogNDkxNTEsCiAgZGltZ3JheTogNjkwODI2NSwKICBkaW1ncmV5OiA2OTA4MjY1LAogIGRvZGdlcmJsdWU6IDIwMDMxOTksCiAgZmlyZWJyaWNrOiAxMTY3NDE0NiwKICBmbG9yYWx3aGl0ZTogMTY3NzU5MjAsCiAgZm9yZXN0Z3JlZW46IDIyNjM4NDIsCiAgZnVjaHNpYTogMTY3MTE5MzUsCiAgZ2FpbnNib3JvOiAxNDQ3NDQ2MCwKICBnaG9zdHdoaXRlOiAxNjMxNjY3MSwKICBnb2xkOiAxNjc2NjcyMCwKICBnb2xkZW5yb2Q6IDE0MzI5MTIwLAogIGdyYXk6IDg0MjE1MDQsCiAgZ3JlZW46IDMyNzY4LAogIGdyZWVueWVsbG93OiAxMTQwMzA1NSwKICBncmV5OiA4NDIxNTA0LAogIGhvbmV5ZGV3OiAxNTc5NDE2MCwKICBob3RwaW5rOiAxNjczODc0MCwKICBpbmRpYW5yZWQ6IDEzNDU4NTI0LAogIGluZGlnbzogNDkxNTMzMCwKICBpdm9yeTogMTY3NzcyMDAsCiAga2hha2k6IDE1Nzg3NjYwLAogIGxhdmVuZGVyOiAxNTEzMjQxMCwKICBsYXZlbmRlcmJsdXNoOiAxNjc3MzM2NSwKICBsYXduZ3JlZW46IDgxOTA5NzYsCiAgbGVtb25jaGlmZm9uOiAxNjc3NTg4NSwKICBsaWdodGJsdWU6IDExMzkzMjU0LAogIGxpZ2h0Y29yYWw6IDE1NzYxNTM2LAogIGxpZ2h0Y3lhbjogMTQ3NDU1OTksCiAgbGlnaHRnb2xkZW5yb2R5ZWxsb3c6IDE2NDQ4MjEwLAogIGxpZ2h0Z3JheTogMTM4ODIzMjMsCiAgbGlnaHRncmVlbjogOTQ5ODI1NiwKICBsaWdodGdyZXk6IDEzODgyMzIzLAogIGxpZ2h0cGluazogMTY3NTg0NjUsCiAgbGlnaHRzYWxtb246IDE2NzUyNzYyLAogIGxpZ2h0c2VhZ3JlZW46IDIxNDI4OTAsCiAgbGlnaHRza3libHVlOiA4OTAwMzQ2LAogIGxpZ2h0c2xhdGVncmF5OiA3ODMzNzUzLAogIGxpZ2h0c2xhdGVncmV5OiA3ODMzNzUzLAogIGxpZ2h0c3RlZWxibHVlOiAxMTU4NDczNCwKICBsaWdodHllbGxvdzogMTY3NzcxODQsCiAgbGltZTogNjUyODAsCiAgbGltZWdyZWVuOiAzMzI5MzMwLAogIGxpbmVuOiAxNjQ0NTY3MCwKICBtYWdlbnRhOiAxNjcxMTkzNSwKICBtYXJvb246IDgzODg2MDgsCiAgbWVkaXVtYXF1YW1hcmluZTogNjczNzMyMiwKICBtZWRpdW1ibHVlOiAyMDUsCiAgbWVkaXVtb3JjaGlkOiAxMjIxMTY2NywKICBtZWRpdW1wdXJwbGU6IDk2NjI2ODMsCiAgbWVkaXVtc2VhZ3JlZW46IDM5NzgwOTcsCiAgbWVkaXVtc2xhdGVibHVlOiA4MDg3NzkwLAogIG1lZGl1bXNwcmluZ2dyZWVuOiA2NDE1NCwKICBtZWRpdW10dXJxdW9pc2U6IDQ3NzIzMDAsCiAgbWVkaXVtdmlvbGV0cmVkOiAxMzA0NzE3MywKICBtaWRuaWdodGJsdWU6IDE2NDQ5MTIsCiAgbWludGNyZWFtOiAxNjEyMTg1MCwKICBtaXN0eXJvc2U6IDE2NzcwMjczLAogIG1vY2Nhc2luOiAxNjc3MDIyOSwKICBuYXZham93aGl0ZTogMTY3Njg2ODUsCiAgbmF2eTogMTI4LAogIG9sZGxhY2U6IDE2NjQzNTU4LAogIG9saXZlOiA4NDIxMzc2LAogIG9saXZlZHJhYjogNzA0ODczOSwKICBvcmFuZ2U6IDE2NzUzOTIwLAogIG9yYW5nZXJlZDogMTY3MjkzNDQsCiAgb3JjaGlkOiAxNDMxNTczNCwKICBwYWxlZ29sZGVucm9kOiAxNTY1NzEzMCwKICBwYWxlZ3JlZW46IDEwMDI1ODgwLAogIHBhbGV0dXJxdW9pc2U6IDExNTI5OTY2LAogIHBhbGV2aW9sZXRyZWQ6IDE0MzgxMjAzLAogIHBhcGF5YXdoaXA6IDE2NzczMDc3LAogIHBlYWNocHVmZjogMTY3Njc2NzMsCiAgcGVydTogMTM0Njg5OTEsCiAgcGluazogMTY3NjEwMzUsCiAgcGx1bTogMTQ1MjQ2MzcsCiAgcG93ZGVyYmx1ZTogMTE1OTE5MTAsCiAgcHVycGxlOiA4Mzg4NzM2LAogIHJlYmVjY2FwdXJwbGU6IDY2OTc4ODEsCiAgcmVkOiAxNjcxMTY4MCwKICByb3N5YnJvd246IDEyMzU3NTE5LAogIHJveWFsYmx1ZTogNDI4Njk0NSwKICBzYWRkbGVicm93bjogOTEyNzE4NywKICBzYWxtb246IDE2NDE2ODgyLAogIHNhbmR5YnJvd246IDE2MDMyODY0LAogIHNlYWdyZWVuOiAzMDUwMzI3LAogIHNlYXNoZWxsOiAxNjc3NDYzOCwKICBzaWVubmE6IDEwNTA2Nzk3LAogIHNpbHZlcjogMTI2MzIyNTYsCiAgc2t5Ymx1ZTogODkwMDMzMSwKICBzbGF0ZWJsdWU6IDY5NzAwNjEsCiAgc2xhdGVncmF5OiA3MzcyOTQ0LAogIHNsYXRlZ3JleTogNzM3Mjk0NCwKICBzbm93OiAxNjc3NTkzMCwKICBzcHJpbmdncmVlbjogNjU0MDcsCiAgc3RlZWxibHVlOiA0NjIwOTgwLAogIHRhbjogMTM4MDg3ODAsCiAgdGVhbDogMzI4OTYsCiAgdGhpc3RsZTogMTQyMDQ4ODgsCiAgdG9tYXRvOiAxNjczNzA5NSwKICB0dXJxdW9pc2U6IDQyNTE4NTYsCiAgdmlvbGV0OiAxNTYzMTA4NiwKICB3aGVhdDogMTYxMTMzMzEsCiAgd2hpdGU6IDE2Nzc3MjE1LAogIHdoaXRlc21va2U6IDE2MTE5Mjg1LAogIHllbGxvdzogMTY3NzY5NjAsCiAgeWVsbG93Z3JlZW46IDEwMTQ1MDc0Cn07CmRlZmluZV9kZWZhdWx0KENvbG9yLCBjb2xvciwgewogIGNvcHkoY2hhbm5lbHMpIHsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyB0aGlzLmNvbnN0cnVjdG9yKCksIHRoaXMsIGNoYW5uZWxzKTsKICB9LAogIGRpc3BsYXlhYmxlKCkgewogICAgcmV0dXJuIHRoaXMucmdiKCkuZGlzcGxheWFibGUoKTsKICB9LAogIGhleDogY29sb3JfZm9ybWF0SGV4LAogIC8vIERlcHJlY2F0ZWQhIFVzZSBjb2xvci5mb3JtYXRIZXguCiAgZm9ybWF0SGV4OiBjb2xvcl9mb3JtYXRIZXgsCiAgZm9ybWF0SGV4ODogY29sb3JfZm9ybWF0SGV4OCwKICBmb3JtYXRIc2w6IGNvbG9yX2Zvcm1hdEhzbCwKICBmb3JtYXRSZ2I6IGNvbG9yX2Zvcm1hdFJnYiwKICB0b1N0cmluZzogY29sb3JfZm9ybWF0UmdiCn0pOwpmdW5jdGlvbiBjb2xvcl9mb3JtYXRIZXgoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0SGV4KCk7Cn0KZnVuY3Rpb24gY29sb3JfZm9ybWF0SGV4OCgpIHsKICByZXR1cm4gdGhpcy5yZ2IoKS5mb3JtYXRIZXg4KCk7Cn0KZnVuY3Rpb24gY29sb3JfZm9ybWF0SHNsKCkgewogIHJldHVybiBoc2xDb252ZXJ0KHRoaXMpLmZvcm1hdEhzbCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdFJnYigpIHsKICByZXR1cm4gdGhpcy5yZ2IoKS5mb3JtYXRSZ2IoKTsKfQpmdW5jdGlvbiBjb2xvcihmb3JtYXQyKSB7CiAgdmFyIG0sIGw7CiAgZm9ybWF0MiA9IChmb3JtYXQyICsgIiIpLnRyaW0oKS50b0xvd2VyQ2FzZSgpOwogIHJldHVybiAobSA9IHJlSGV4LmV4ZWMoZm9ybWF0MikpID8gKGwgPSBtWzFdLmxlbmd0aCwgbSA9IHBhcnNlSW50KG1bMV0sIDE2KSwgbCA9PT0gNiA/IHJnYm4obSkgOiBsID09PSAzID8gbmV3IFJnYihtID4+IDggJiAxNSB8IG0gPj4gNCAmIDI0MCwgbSA+PiA0ICYgMTUgfCBtICYgMjQwLCAobSAmIDE1KSA8PCA0IHwgbSAmIDE1LCAxKSA6IGwgPT09IDggPyByZ2JhKG0gPj4gMjQgJiAyNTUsIG0gPj4gMTYgJiAyNTUsIG0gPj4gOCAmIDI1NSwgKG0gJiAyNTUpIC8gMjU1KSA6IGwgPT09IDQgPyByZ2JhKG0gPj4gMTIgJiAxNSB8IG0gPj4gOCAmIDI0MCwgbSA+PiA4ICYgMTUgfCBtID4+IDQgJiAyNDAsIG0gPj4gNCAmIDE1IHwgbSAmIDI0MCwgKChtICYgMTUpIDw8IDQgfCBtICYgMTUpIC8gMjU1KSA6IG51bGwpIDogKG0gPSByZVJnYkludGVnZXIuZXhlYyhmb3JtYXQyKSkgPyBuZXcgUmdiKG1bMV0sIG1bMl0sIG1bM10sIDEpIDogKG0gPSByZVJnYlBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyBuZXcgUmdiKG1bMV0gKiAyNTUgLyAxMDAsIG1bMl0gKiAyNTUgLyAxMDAsIG1bM10gKiAyNTUgLyAxMDAsIDEpIDogKG0gPSByZVJnYmFJbnRlZ2VyLmV4ZWMoZm9ybWF0MikpID8gcmdiYShtWzFdLCBtWzJdLCBtWzNdLCBtWzRdKSA6IChtID0gcmVSZ2JhUGVyY2VudC5leGVjKGZvcm1hdDIpKSA/IHJnYmEobVsxXSAqIDI1NSAvIDEwMCwgbVsyXSAqIDI1NSAvIDEwMCwgbVszXSAqIDI1NSAvIDEwMCwgbVs0XSkgOiAobSA9IHJlSHNsUGVyY2VudC5leGVjKGZvcm1hdDIpKSA/IGhzbGEobVsxXSwgbVsyXSAvIDEwMCwgbVszXSAvIDEwMCwgMSkgOiAobSA9IHJlSHNsYVBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyBoc2xhKG1bMV0sIG1bMl0gLyAxMDAsIG1bM10gLyAxMDAsIG1bNF0pIDogbmFtZWQuaGFzT3duUHJvcGVydHkoZm9ybWF0MikgPyByZ2JuKG5hbWVkW2Zvcm1hdDJdKSA6IGZvcm1hdDIgPT09ICJ0cmFuc3BhcmVudCIgPyBuZXcgUmdiKE5hTiwgTmFOLCBOYU4sIDApIDogbnVsbDsKfQpmdW5jdGlvbiByZ2JuKG4pIHsKICByZXR1cm4gbmV3IFJnYihuID4+IDE2ICYgMjU1LCBuID4+IDggJiAyNTUsIG4gJiAyNTUsIDEpOwp9CmZ1bmN0aW9uIHJnYmEocjIsIGcsIGIsIGEpIHsKICBpZiAoYSA8PSAwKSByMiA9IGcgPSBiID0gTmFOOwogIHJldHVybiBuZXcgUmdiKHIyLCBnLCBiLCBhKTsKfQpmdW5jdGlvbiByZ2JDb252ZXJ0KG8pIHsKICBpZiAoIShvIGluc3RhbmNlb2YgQ29sb3IpKSBvID0gY29sb3Iobyk7CiAgaWYgKCFvKSByZXR1cm4gbmV3IFJnYigpOwogIG8gPSBvLnJnYigpOwogIHJldHVybiBuZXcgUmdiKG8uciwgby5nLCBvLmIsIG8ub3BhY2l0eSk7Cn0KZnVuY3Rpb24gcmdiKHIyLCBnLCBiLCBvcGFjaXR5KSB7CiAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyByZ2JDb252ZXJ0KHIyKSA6IG5ldyBSZ2IocjIsIGcsIGIsIG9wYWNpdHkgPT0gbnVsbCA/IDEgOiBvcGFjaXR5KTsKfQpmdW5jdGlvbiBSZ2IocjIsIGcsIGIsIG9wYWNpdHkpIHsKICB0aGlzLnIgPSArcjI7CiAgdGhpcy5nID0gK2c7CiAgdGhpcy5iID0gK2I7CiAgdGhpcy5vcGFjaXR5ID0gK29wYWNpdHk7Cn0KZGVmaW5lX2RlZmF1bHQoUmdiLCByZ2IsIGV4dGVuZChDb2xvciwgewogIGJyaWdodGVyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBicmlnaHRlciA6IE1hdGgucG93KGJyaWdodGVyLCBrKTsKICAgIHJldHVybiBuZXcgUmdiKHRoaXMuciAqIGssIHRoaXMuZyAqIGssIHRoaXMuYiAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICBkYXJrZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGRhcmtlciA6IE1hdGgucG93KGRhcmtlciwgayk7CiAgICByZXR1cm4gbmV3IFJnYih0aGlzLnIgKiBrLCB0aGlzLmcgKiBrLCB0aGlzLmIgKiBrLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgcmdiKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBjbGFtcCgpIHsKICAgIHJldHVybiBuZXcgUmdiKGNsYW1waSh0aGlzLnIpLCBjbGFtcGkodGhpcy5nKSwgY2xhbXBpKHRoaXMuYiksIGNsYW1wYSh0aGlzLm9wYWNpdHkpKTsKICB9LAogIGRpc3BsYXlhYmxlKCkgewogICAgcmV0dXJuIC0wLjUgPD0gdGhpcy5yICYmIHRoaXMuciA8IDI1NS41ICYmICgtMC41IDw9IHRoaXMuZyAmJiB0aGlzLmcgPCAyNTUuNSkgJiYgKC0wLjUgPD0gdGhpcy5iICYmIHRoaXMuYiA8IDI1NS41KSAmJiAoMCA8PSB0aGlzLm9wYWNpdHkgJiYgdGhpcy5vcGFjaXR5IDw9IDEpOwogIH0sCiAgaGV4OiByZ2JfZm9ybWF0SGV4LAogIC8vIERlcHJlY2F0ZWQhIFVzZSBjb2xvci5mb3JtYXRIZXguCiAgZm9ybWF0SGV4OiByZ2JfZm9ybWF0SGV4LAogIGZvcm1hdEhleDg6IHJnYl9mb3JtYXRIZXg4LAogIGZvcm1hdFJnYjogcmdiX2Zvcm1hdFJnYiwKICB0b1N0cmluZzogcmdiX2Zvcm1hdFJnYgp9KSk7CmZ1bmN0aW9uIHJnYl9mb3JtYXRIZXgoKSB7CiAgcmV0dXJuIGAjJHtoZXgodGhpcy5yKX0ke2hleCh0aGlzLmcpfSR7aGV4KHRoaXMuYil9YDsKfQpmdW5jdGlvbiByZ2JfZm9ybWF0SGV4OCgpIHsKICByZXR1cm4gYCMke2hleCh0aGlzLnIpfSR7aGV4KHRoaXMuZyl9JHtoZXgodGhpcy5iKX0ke2hleCgoaXNOYU4odGhpcy5vcGFjaXR5KSA/IDEgOiB0aGlzLm9wYWNpdHkpICogMjU1KX1gOwp9CmZ1bmN0aW9uIHJnYl9mb3JtYXRSZ2IoKSB7CiAgY29uc3QgYSA9IGNsYW1wYSh0aGlzLm9wYWNpdHkpOwogIHJldHVybiBgJHthID09PSAxID8gInJnYigiIDogInJnYmEoIn0ke2NsYW1waSh0aGlzLnIpfSwgJHtjbGFtcGkodGhpcy5nKX0sICR7Y2xhbXBpKHRoaXMuYil9JHthID09PSAxID8gIikiIDogYCwgJHthfSlgfWA7Cn0KZnVuY3Rpb24gY2xhbXBhKG9wYWNpdHkpIHsKICByZXR1cm4gaXNOYU4ob3BhY2l0eSkgPyAxIDogTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgb3BhY2l0eSkpOwp9CmZ1bmN0aW9uIGNsYW1waSh2YWx1ZSkgewogIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigyNTUsIE1hdGgucm91bmQodmFsdWUpIHx8IDApKTsKfQpmdW5jdGlvbiBoZXgodmFsdWUpIHsKICB2YWx1ZSA9IGNsYW1waSh2YWx1ZSk7CiAgcmV0dXJuICh2YWx1ZSA8IDE2ID8gIjAiIDogIiIpICsgdmFsdWUudG9TdHJpbmcoMTYpOwp9CmZ1bmN0aW9uIGhzbGEoaCwgcywgbCwgYSkgewogIGlmIChhIDw9IDApIGggPSBzID0gbCA9IE5hTjsKICBlbHNlIGlmIChsIDw9IDAgfHwgbCA+PSAxKSBoID0gcyA9IE5hTjsKICBlbHNlIGlmIChzIDw9IDApIGggPSBOYU47CiAgcmV0dXJuIG5ldyBIc2woaCwgcywgbCwgYSk7Cn0KZnVuY3Rpb24gaHNsQ29udmVydChvKSB7CiAgaWYgKG8gaW5zdGFuY2VvZiBIc2wpIHJldHVybiBuZXcgSHNsKG8uaCwgby5zLCBvLmwsIG8ub3BhY2l0eSk7CiAgaWYgKCEobyBpbnN0YW5jZW9mIENvbG9yKSkgbyA9IGNvbG9yKG8pOwogIGlmICghbykgcmV0dXJuIG5ldyBIc2woKTsKICBpZiAobyBpbnN0YW5jZW9mIEhzbCkgcmV0dXJuIG87CiAgbyA9IG8ucmdiKCk7CiAgdmFyIHIyID0gby5yIC8gMjU1LCBnID0gby5nIC8gMjU1LCBiID0gby5iIC8gMjU1LCBtaW4yID0gTWF0aC5taW4ocjIsIGcsIGIpLCBtYXgyID0gTWF0aC5tYXgocjIsIGcsIGIpLCBoID0gTmFOLCBzID0gbWF4MiAtIG1pbjIsIGwgPSAobWF4MiArIG1pbjIpIC8gMjsKICBpZiAocykgewogICAgaWYgKHIyID09PSBtYXgyKSBoID0gKGcgLSBiKSAvIHMgKyAoZyA8IGIpICogNjsKICAgIGVsc2UgaWYgKGcgPT09IG1heDIpIGggPSAoYiAtIHIyKSAvIHMgKyAyOwogICAgZWxzZSBoID0gKHIyIC0gZykgLyBzICsgNDsKICAgIHMgLz0gbCA8IDAuNSA/IG1heDIgKyBtaW4yIDogMiAtIG1heDIgLSBtaW4yOwogICAgaCAqPSA2MDsKICB9IGVsc2UgewogICAgcyA9IGwgPiAwICYmIGwgPCAxID8gMCA6IGg7CiAgfQogIHJldHVybiBuZXcgSHNsKGgsIHMsIGwsIG8ub3BhY2l0eSk7Cn0KZnVuY3Rpb24gaHNsKGgsIHMsIGwsIG9wYWNpdHkpIHsKICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IGhzbENvbnZlcnQoaCkgOiBuZXcgSHNsKGgsIHMsIGwsIG9wYWNpdHkgPT0gbnVsbCA/IDEgOiBvcGFjaXR5KTsKfQpmdW5jdGlvbiBIc2woaCwgcywgbCwgb3BhY2l0eSkgewogIHRoaXMuaCA9ICtoOwogIHRoaXMucyA9ICtzOwogIHRoaXMubCA9ICtsOwogIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5Owp9CmRlZmluZV9kZWZhdWx0KEhzbCwgaHNsLCBleHRlbmQoQ29sb3IsIHsKICBicmlnaHRlcihrKSB7CiAgICBrID0gayA9PSBudWxsID8gYnJpZ2h0ZXIgOiBNYXRoLnBvdyhicmlnaHRlciwgayk7CiAgICByZXR1cm4gbmV3IEhzbCh0aGlzLmgsIHRoaXMucywgdGhpcy5sICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIGRhcmtlcihrKSB7CiAgICBrID0gayA9PSBudWxsID8gZGFya2VyIDogTWF0aC5wb3coZGFya2VyLCBrKTsKICAgIHJldHVybiBuZXcgSHNsKHRoaXMuaCwgdGhpcy5zLCB0aGlzLmwgKiBrLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgcmdiKCkgewogICAgdmFyIGggPSB0aGlzLmggJSAzNjAgKyAodGhpcy5oIDwgMCkgKiAzNjAsIHMgPSBpc05hTihoKSB8fCBpc05hTih0aGlzLnMpID8gMCA6IHRoaXMucywgbCA9IHRoaXMubCwgbTIgPSBsICsgKGwgPCAwLjUgPyBsIDogMSAtIGwpICogcywgbTEgPSAyICogbCAtIG0yOwogICAgcmV0dXJuIG5ldyBSZ2IoCiAgICAgIGhzbDJyZ2IoaCA+PSAyNDAgPyBoIC0gMjQwIDogaCArIDEyMCwgbTEsIG0yKSwKICAgICAgaHNsMnJnYihoLCBtMSwgbTIpLAogICAgICBoc2wycmdiKGggPCAxMjAgPyBoICsgMjQwIDogaCAtIDEyMCwgbTEsIG0yKSwKICAgICAgdGhpcy5vcGFjaXR5CiAgICApOwogIH0sCiAgY2xhbXAoKSB7CiAgICByZXR1cm4gbmV3IEhzbChjbGFtcGgodGhpcy5oKSwgY2xhbXB0KHRoaXMucyksIGNsYW1wdCh0aGlzLmwpLCBjbGFtcGEodGhpcy5vcGFjaXR5KSk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiAoMCA8PSB0aGlzLnMgJiYgdGhpcy5zIDw9IDEgfHwgaXNOYU4odGhpcy5zKSkgJiYgKDAgPD0gdGhpcy5sICYmIHRoaXMubCA8PSAxKSAmJiAoMCA8PSB0aGlzLm9wYWNpdHkgJiYgdGhpcy5vcGFjaXR5IDw9IDEpOwogIH0sCiAgZm9ybWF0SHNsKCkgewogICAgY29uc3QgYSA9IGNsYW1wYSh0aGlzLm9wYWNpdHkpOwogICAgcmV0dXJuIGAke2EgPT09IDEgPyAiaHNsKCIgOiAiaHNsYSgifSR7Y2xhbXBoKHRoaXMuaCl9LCAke2NsYW1wdCh0aGlzLnMpICogMTAwfSUsICR7Y2xhbXB0KHRoaXMubCkgKiAxMDB9JSR7YSA9PT0gMSA/ICIpIiA6IGAsICR7YX0pYH1gOwogIH0KfSkpOwpmdW5jdGlvbiBjbGFtcGgodmFsdWUpIHsKICB2YWx1ZSA9ICh2YWx1ZSB8fCAwKSAlIDM2MDsKICByZXR1cm4gdmFsdWUgPCAwID8gdmFsdWUgKyAzNjAgOiB2YWx1ZTsKfQpmdW5jdGlvbiBjbGFtcHQodmFsdWUpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdmFsdWUgfHwgMCkpOwp9CmZ1bmN0aW9uIGhzbDJyZ2IoaCwgbTEsIG0yKSB7CiAgcmV0dXJuIChoIDwgNjAgPyBtMSArIChtMiAtIG0xKSAqIGggLyA2MCA6IGggPCAxODAgPyBtMiA6IGggPCAyNDAgPyBtMSArIChtMiAtIG0xKSAqICgyNDAgLSBoKSAvIDYwIDogbTEpICogMjU1Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2Jhc2lzLmpzCmZ1bmN0aW9uIGJhc2lzKHQxMiwgdjAsIHYxLCB2MiwgdjMpIHsKICB2YXIgdDIgPSB0MTIgKiB0MTIsIHQzID0gdDIgKiB0MTI7CiAgcmV0dXJuICgoMSAtIDMgKiB0MTIgKyAzICogdDIgLSB0MykgKiB2MCArICg0IC0gNiAqIHQyICsgMyAqIHQzKSAqIHYxICsgKDEgKyAzICogdDEyICsgMyAqIHQyIC0gMyAqIHQzKSAqIHYyICsgdDMgKiB2MykgLyA2Owp9CmZ1bmN0aW9uIGJhc2lzX2RlZmF1bHQyKHZhbHVlcykgewogIHZhciBuID0gdmFsdWVzLmxlbmd0aCAtIDE7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHZhciBpID0gdCA8PSAwID8gdCA9IDAgOiB0ID49IDEgPyAodCA9IDEsIG4gLSAxKSA6IE1hdGguZmxvb3IodCAqIG4pLCB2MSA9IHZhbHVlc1tpXSwgdjIgPSB2YWx1ZXNbaSArIDFdLCB2MCA9IGkgPiAwID8gdmFsdWVzW2kgLSAxXSA6IDIgKiB2MSAtIHYyLCB2MyA9IGkgPCBuIC0gMSA/IHZhbHVlc1tpICsgMl0gOiAyICogdjIgLSB2MTsKICAgIHJldHVybiBiYXNpcygodCAtIGkgLyBuKSAqIG4sIHYwLCB2MSwgdjIsIHYzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2Jhc2lzQ2xvc2VkLmpzCmZ1bmN0aW9uIGJhc2lzQ2xvc2VkX2RlZmF1bHQyKHZhbHVlcykgewogIHZhciBuID0gdmFsdWVzLmxlbmd0aDsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkgPSBNYXRoLmZsb29yKCgodCAlPSAxKSA8IDAgPyArK3QgOiB0KSAqIG4pLCB2MCA9IHZhbHVlc1soaSArIG4gLSAxKSAlIG5dLCB2MSA9IHZhbHVlc1tpICUgbl0sIHYyID0gdmFsdWVzWyhpICsgMSkgJSBuXSwgdjMgPSB2YWx1ZXNbKGkgKyAyKSAlIG5dOwogICAgcmV0dXJuIGJhc2lzKCh0IC0gaSAvIG4pICogbiwgdjAsIHYxLCB2MiwgdjMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvY29uc3RhbnQuanMKdmFyIGNvbnN0YW50X2RlZmF1bHQyID0gKHgyKSA9PiAoKSA9PiB4MjsKCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvY29sb3IuanMKZnVuY3Rpb24gbGluZWFyKGEsIGQpIHsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGEgKyB0ICogZDsKICB9Owp9CmZ1bmN0aW9uIGV4cG9uZW50aWFsKGEsIGIsIHkyKSB7CiAgcmV0dXJuIGEgPSBNYXRoLnBvdyhhLCB5MiksIGIgPSBNYXRoLnBvdyhiLCB5MikgLSBhLCB5MiA9IDEgLyB5MiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIE1hdGgucG93KGEgKyB0ICogYiwgeTIpOwogIH07Cn0KZnVuY3Rpb24gZ2FtbWEoeTIpIHsKICByZXR1cm4gKHkyID0gK3kyKSA9PT0gMSA/IG5vZ2FtbWEgOiBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gYiAtIGEgPyBleHBvbmVudGlhbChhLCBiLCB5MikgOiBjb25zdGFudF9kZWZhdWx0Mihpc05hTihhKSA/IGIgOiBhKTsKICB9Owp9CmZ1bmN0aW9uIG5vZ2FtbWEoYSwgYikgewogIHZhciBkID0gYiAtIGE7CiAgcmV0dXJuIGQgPyBsaW5lYXIoYSwgZCkgOiBjb25zdGFudF9kZWZhdWx0Mihpc05hTihhKSA/IGIgOiBhKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9yZ2IuanMKdmFyIHJnYl9kZWZhdWx0ID0gZnVuY3Rpb24gcmdiR2FtbWEoeTIpIHsKICB2YXIgY29sb3IyID0gZ2FtbWEoeTIpOwogIGZ1bmN0aW9uIHJnYjIoc3RhcnQsIGVuZCkgewogICAgdmFyIHIyID0gY29sb3IyKChzdGFydCA9IHJnYihzdGFydCkpLnIsIChlbmQgPSByZ2IoZW5kKSkuciksIGcgPSBjb2xvcjIoc3RhcnQuZywgZW5kLmcpLCBiID0gY29sb3IyKHN0YXJ0LmIsIGVuZC5iKSwgb3BhY2l0eSA9IG5vZ2FtbWEoc3RhcnQub3BhY2l0eSwgZW5kLm9wYWNpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgc3RhcnQuciA9IHIyKHQpOwogICAgICBzdGFydC5nID0gZyh0KTsKICAgICAgc3RhcnQuYiA9IGIodCk7CiAgICAgIHN0YXJ0Lm9wYWNpdHkgPSBvcGFjaXR5KHQpOwogICAgICByZXR1cm4gc3RhcnQgKyAiIjsKICAgIH07CiAgfQogIHJnYjIuZ2FtbWEgPSByZ2JHYW1tYTsKICByZXR1cm4gcmdiMjsKfSgxKTsKZnVuY3Rpb24gcmdiU3BsaW5lKHNwbGluZSkgewogIHJldHVybiBmdW5jdGlvbihjb2xvcnMpIHsKICAgIHZhciBuID0gY29sb3JzLmxlbmd0aCwgcjIgPSBuZXcgQXJyYXkobiksIGcgPSBuZXcgQXJyYXkobiksIGIgPSBuZXcgQXJyYXkobiksIGksIGNvbG9yMjsKICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgY29sb3IyID0gcmdiKGNvbG9yc1tpXSk7CiAgICAgIHIyW2ldID0gY29sb3IyLnIgfHwgMDsKICAgICAgZ1tpXSA9IGNvbG9yMi5nIHx8IDA7CiAgICAgIGJbaV0gPSBjb2xvcjIuYiB8fCAwOwogICAgfQogICAgcjIgPSBzcGxpbmUocjIpOwogICAgZyA9IHNwbGluZShnKTsKICAgIGIgPSBzcGxpbmUoYik7CiAgICBjb2xvcjIub3BhY2l0eSA9IDE7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICBjb2xvcjIuciA9IHIyKHQpOwogICAgICBjb2xvcjIuZyA9IGcodCk7CiAgICAgIGNvbG9yMi5iID0gYih0KTsKICAgICAgcmV0dXJuIGNvbG9yMiArICIiOwogICAgfTsKICB9Owp9CnZhciByZ2JCYXNpcyA9IHJnYlNwbGluZShiYXNpc19kZWZhdWx0Mik7CnZhciByZ2JCYXNpc0Nsb3NlZCA9IHJnYlNwbGluZShiYXNpc0Nsb3NlZF9kZWZhdWx0Mik7CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL251bWJlckFycmF5LmpzCmZ1bmN0aW9uIG51bWJlckFycmF5X2RlZmF1bHQoYSwgYikgewogIGlmICghYikgYiA9IFtdOwogIHZhciBuID0gYSA/IE1hdGgubWluKGIubGVuZ3RoLCBhLmxlbmd0aCkgOiAwLCBjID0gYi5zbGljZSgpLCBpOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSBjW2ldID0gYVtpXSAqICgxIC0gdCkgKyBiW2ldICogdDsKICAgIHJldHVybiBjOwogIH07Cn0KZnVuY3Rpb24gaXNOdW1iZXJBcnJheSh4MikgewogIHJldHVybiBBcnJheUJ1ZmZlci5pc1ZpZXcoeDIpICYmICEoeDIgaW5zdGFuY2VvZiBEYXRhVmlldyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvYXJyYXkuanMKZnVuY3Rpb24gZ2VuZXJpY0FycmF5KGEsIGIpIHsKICB2YXIgbmIgPSBiID8gYi5sZW5ndGggOiAwLCBuYSA9IGEgPyBNYXRoLm1pbihuYiwgYS5sZW5ndGgpIDogMCwgeDIgPSBuZXcgQXJyYXkobmEpLCBjID0gbmV3IEFycmF5KG5iKSwgaTsKICBmb3IgKGkgPSAwOyBpIDwgbmE7ICsraSkgeDJbaV0gPSB2YWx1ZV9kZWZhdWx0KGFbaV0sIGJbaV0pOwogIGZvciAoOyBpIDwgbmI7ICsraSkgY1tpXSA9IGJbaV07CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoaSA9IDA7IGkgPCBuYTsgKytpKSBjW2ldID0geDJbaV0odCk7CiAgICByZXR1cm4gYzsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2RhdGUuanMKZnVuY3Rpb24gZGF0ZV9kZWZhdWx0KGEsIGIpIHsKICB2YXIgZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogIHJldHVybiBhID0gK2EsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGQuc2V0VGltZShhICogKDEgLSB0KSArIGIgKiB0KSwgZDsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL251bWJlci5qcwpmdW5jdGlvbiBudW1iZXJfZGVmYXVsdChhLCBiKSB7CiAgcmV0dXJuIGEgPSArYSwgYiA9ICtiLCBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gYSAqICgxIC0gdCkgKyBiICogdDsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL29iamVjdC5qcwpmdW5jdGlvbiBvYmplY3RfZGVmYXVsdChhLCBiKSB7CiAgdmFyIGkgPSB7fSwgYyA9IHt9LCBrOwogIGlmIChhID09PSBudWxsIHx8IHR5cGVvZiBhICE9PSAib2JqZWN0IikgYSA9IHt9OwogIGlmIChiID09PSBudWxsIHx8IHR5cGVvZiBiICE9PSAib2JqZWN0IikgYiA9IHt9OwogIGZvciAoayBpbiBiKSB7CiAgICBpZiAoayBpbiBhKSB7CiAgICAgIGlba10gPSB2YWx1ZV9kZWZhdWx0KGFba10sIGJba10pOwogICAgfSBlbHNlIHsKICAgICAgY1trXSA9IGJba107CiAgICB9CiAgfQogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICBmb3IgKGsgaW4gaSkgY1trXSA9IGlba10odCk7CiAgICByZXR1cm4gYzsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3N0cmluZy5qcwp2YXIgcmVBID0gL1stK10/KD86XGQrXC4/XGQqfFwuP1xkKykoPzpbZUVdWy0rXT9cZCspPy9nOwp2YXIgcmVCID0gbmV3IFJlZ0V4cChyZUEuc291cmNlLCAiZyIpOwpmdW5jdGlvbiB6ZXJvMihiKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGI7CiAgfTsKfQpmdW5jdGlvbiBvbmUoYikgewogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gYih0KSArICIiOwogIH07Cn0KZnVuY3Rpb24gc3RyaW5nX2RlZmF1bHQoYSwgYikgewogIHZhciBiaSA9IHJlQS5sYXN0SW5kZXggPSByZUIubGFzdEluZGV4ID0gMCwgYW0sIGJtLCBicywgaSA9IC0xLCBzID0gW10sIHEgPSBbXTsKICBhID0gYSArICIiLCBiID0gYiArICIiOwogIHdoaWxlICgoYW0gPSByZUEuZXhlYyhhKSkgJiYgKGJtID0gcmVCLmV4ZWMoYikpKSB7CiAgICBpZiAoKGJzID0gYm0uaW5kZXgpID4gYmkpIHsKICAgICAgYnMgPSBiLnNsaWNlKGJpLCBicyk7CiAgICAgIGlmIChzW2ldKSBzW2ldICs9IGJzOwogICAgICBlbHNlIHNbKytpXSA9IGJzOwogICAgfQogICAgaWYgKChhbSA9IGFtWzBdKSA9PT0gKGJtID0gYm1bMF0pKSB7CiAgICAgIGlmIChzW2ldKSBzW2ldICs9IGJtOwogICAgICBlbHNlIHNbKytpXSA9IGJtOwogICAgfSBlbHNlIHsKICAgICAgc1srK2ldID0gbnVsbDsKICAgICAgcS5wdXNoKHsgaSwgeDogbnVtYmVyX2RlZmF1bHQoYW0sIGJtKSB9KTsKICAgIH0KICAgIGJpID0gcmVCLmxhc3RJbmRleDsKICB9CiAgaWYgKGJpIDwgYi5sZW5ndGgpIHsKICAgIGJzID0gYi5zbGljZShiaSk7CiAgICBpZiAoc1tpXSkgc1tpXSArPSBiczsKICAgIGVsc2Ugc1srK2ldID0gYnM7CiAgfQogIHJldHVybiBzLmxlbmd0aCA8IDIgPyBxWzBdID8gb25lKHFbMF0ueCkgOiB6ZXJvMihiKSA6IChiID0gcS5sZW5ndGgsIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAodmFyIGkyID0gMCwgbzsgaTIgPCBiOyArK2kyKSBzWyhvID0gcVtpMl0pLmldID0gby54KHQpOwogICAgcmV0dXJuIHMuam9pbigiIik7CiAgfSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvdmFsdWUuanMKZnVuY3Rpb24gdmFsdWVfZGVmYXVsdChhLCBiKSB7CiAgdmFyIHQgPSB0eXBlb2YgYiwgYzsKICByZXR1cm4gYiA9PSBudWxsIHx8IHQgPT09ICJib29sZWFuIiA/IGNvbnN0YW50X2RlZmF1bHQyKGIpIDogKHQgPT09ICJudW1iZXIiID8gbnVtYmVyX2RlZmF1bHQgOiB0ID09PSAic3RyaW5nIiA/IChjID0gY29sb3IoYikpID8gKGIgPSBjLCByZ2JfZGVmYXVsdCkgOiBzdHJpbmdfZGVmYXVsdCA6IGIgaW5zdGFuY2VvZiBjb2xvciA/IHJnYl9kZWZhdWx0IDogYiBpbnN0YW5jZW9mIERhdGUgPyBkYXRlX2RlZmF1bHQgOiBpc051bWJlckFycmF5KGIpID8gbnVtYmVyQXJyYXlfZGVmYXVsdCA6IEFycmF5LmlzQXJyYXkoYikgPyBnZW5lcmljQXJyYXkgOiB0eXBlb2YgYi52YWx1ZU9mICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBiLnRvU3RyaW5nICE9PSAiZnVuY3Rpb24iIHx8IGlzTmFOKGIpID8gb2JqZWN0X2RlZmF1bHQgOiBudW1iZXJfZGVmYXVsdCkoYSwgYik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvcm91bmQuanMKZnVuY3Rpb24gcm91bmRfZGVmYXVsdChhLCBiKSB7CiAgcmV0dXJuIGEgPSArYSwgYiA9ICtiLCBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gTWF0aC5yb3VuZChhICogKDEgLSB0KSArIGIgKiB0KTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3BpZWNld2lzZS5qcwpmdW5jdGlvbiBwaWVjZXdpc2UoaW50ZXJwb2xhdGUyLCB2YWx1ZXMpIHsKICBpZiAodmFsdWVzID09PSB2b2lkIDApIHZhbHVlcyA9IGludGVycG9sYXRlMiwgaW50ZXJwb2xhdGUyID0gdmFsdWVfZGVmYXVsdDsKICB2YXIgaSA9IDAsIG4gPSB2YWx1ZXMubGVuZ3RoIC0gMSwgdiA9IHZhbHVlc1swXSwgSSA9IG5ldyBBcnJheShuIDwgMCA/IDAgOiBuKTsKICB3aGlsZSAoaSA8IG4pIElbaV0gPSBpbnRlcnBvbGF0ZTIodiwgdiA9IHZhbHVlc1srK2ldKTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkyID0gTWF0aC5tYXgoMCwgTWF0aC5taW4obiAtIDEsIE1hdGguZmxvb3IodCAqPSBuKSkpOwogICAgcmV0dXJuIElbaTJdKHQgLSBpMik7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9jb25zdGFudC5qcwpmdW5jdGlvbiBjb25zdGFudHMoeDIpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4geDI7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyMih4MikgewogIHJldHVybiAreDI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvY29udGludW91cy5qcwp2YXIgdW5pdCA9IFswLCAxXTsKZnVuY3Rpb24gaWRlbnRpdHkoeDIpIHsKICByZXR1cm4geDI7Cn0KZnVuY3Rpb24gbm9ybWFsaXplKGEsIGIpIHsKICByZXR1cm4gKGIgLT0gYSA9ICthKSA/IGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gKHgyIC0gYSkgLyBiOwogIH0gOiBjb25zdGFudHMoaXNOYU4oYikgPyBOYU4gOiAwLjUpOwp9CmZ1bmN0aW9uIGNsYW1wZXIoYSwgYikgewogIHZhciB0OwogIGlmIChhID4gYikgdCA9IGEsIGEgPSBiLCBiID0gdDsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiBNYXRoLm1heChhLCBNYXRoLm1pbihiLCB4MikpOwogIH07Cn0KZnVuY3Rpb24gYmltYXAoZG9tYWluLCByYW5nZTQsIGludGVycG9sYXRlMikgewogIHZhciBkMCA9IGRvbWFpblswXSwgZDEgPSBkb21haW5bMV0sIHIwID0gcmFuZ2U0WzBdLCByMSA9IHJhbmdlNFsxXTsKICBpZiAoZDEgPCBkMCkgZDAgPSBub3JtYWxpemUoZDEsIGQwKSwgcjAgPSBpbnRlcnBvbGF0ZTIocjEsIHIwKTsKICBlbHNlIGQwID0gbm9ybWFsaXplKGQwLCBkMSksIHIwID0gaW50ZXJwb2xhdGUyKHIwLCByMSk7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gcjAoZDAoeDIpKTsKICB9Owp9CmZ1bmN0aW9uIHBvbHltYXAoZG9tYWluLCByYW5nZTQsIGludGVycG9sYXRlMikgewogIHZhciBqID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCkgLSAxLCBkID0gbmV3IEFycmF5KGopLCByMiA9IG5ldyBBcnJheShqKSwgaSA9IC0xOwogIGlmIChkb21haW5bal0gPCBkb21haW5bMF0pIHsKICAgIGRvbWFpbiA9IGRvbWFpbi5zbGljZSgpLnJldmVyc2UoKTsKICAgIHJhbmdlNCA9IHJhbmdlNC5zbGljZSgpLnJldmVyc2UoKTsKICB9CiAgd2hpbGUgKCsraSA8IGopIHsKICAgIGRbaV0gPSBub3JtYWxpemUoZG9tYWluW2ldLCBkb21haW5baSArIDFdKTsKICAgIHIyW2ldID0gaW50ZXJwb2xhdGUyKHJhbmdlNFtpXSwgcmFuZ2U0W2kgKyAxXSk7CiAgfQogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgdmFyIGkyID0gYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMSwgaikgLSAxOwogICAgcmV0dXJuIHIyW2kyXShkW2kyXSh4MikpOwogIH07Cn0KZnVuY3Rpb24gY29weShzb3VyY2UsIHRhcmdldCkgewogIHJldHVybiB0YXJnZXQuZG9tYWluKHNvdXJjZS5kb21haW4oKSkucmFuZ2Uoc291cmNlLnJhbmdlKCkpLmludGVycG9sYXRlKHNvdXJjZS5pbnRlcnBvbGF0ZSgpKS5jbGFtcChzb3VyY2UuY2xhbXAoKSkudW5rbm93bihzb3VyY2UudW5rbm93bigpKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1lcigpIHsKICB2YXIgZG9tYWluID0gdW5pdCwgcmFuZ2U0ID0gdW5pdCwgaW50ZXJwb2xhdGUyID0gdmFsdWVfZGVmYXVsdCwgdHJhbnNmb3JtLCB1bnRyYW5zZm9ybSwgdW5rbm93biwgY2xhbXAgPSBpZGVudGl0eSwgcGllY2V3aXNlMiwgb3V0cHV0LCBpbnB1dDsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIG4gPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoKTsKICAgIGlmIChjbGFtcCAhPT0gaWRlbnRpdHkpIGNsYW1wID0gY2xhbXBlcihkb21haW5bMF0sIGRvbWFpbltuIC0gMV0pOwogICAgcGllY2V3aXNlMiA9IG4gPiAyID8gcG9seW1hcCA6IGJpbWFwOwogICAgb3V0cHV0ID0gaW5wdXQgPSBudWxsOwogICAgcmV0dXJuIHNjYWxlOwogIH0KICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgfHwgaXNOYU4oeDIgPSAreDIpID8gdW5rbm93biA6IChvdXRwdXQgfHwgKG91dHB1dCA9IHBpZWNld2lzZTIoZG9tYWluLm1hcCh0cmFuc2Zvcm0pLCByYW5nZTQsIGludGVycG9sYXRlMikpKSh0cmFuc2Zvcm0oY2xhbXAoeDIpKSk7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkyKSB7CiAgICByZXR1cm4gY2xhbXAodW50cmFuc2Zvcm0oKGlucHV0IHx8IChpbnB1dCA9IHBpZWNld2lzZTIocmFuZ2U0LCBkb21haW4ubWFwKHRyYW5zZm9ybSksIG51bWJlcl9kZWZhdWx0KSkpKHkyKSkpOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSwgcmVzY2FsZSgpKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIHJhbmdlNCA9IEFycmF5LmZyb20oXyksIGludGVycG9sYXRlMiA9IHJvdW5kX2RlZmF1bHQsIHJlc2NhbGUoKTsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY2xhbXAgPSBfID8gdHJ1ZSA6IGlkZW50aXR5LCByZXNjYWxlKCkpIDogY2xhbXAgIT09IGlkZW50aXR5OwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdGUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0ZTIgPSBfLCByZXNjYWxlKCkpIDogaW50ZXJwb2xhdGUyOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgcmV0dXJuIGZ1bmN0aW9uKHQsIHUpIHsKICAgIHRyYW5zZm9ybSA9IHQsIHVudHJhbnNmb3JtID0gdTsKICAgIHJldHVybiByZXNjYWxlKCk7CiAgfTsKfQpmdW5jdGlvbiBjb250aW51b3VzKCkgewogIHJldHVybiB0cmFuc2Zvcm1lcigpKGlkZW50aXR5LCBpZGVudGl0eSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdERlY2ltYWwuanMKZnVuY3Rpb24gZm9ybWF0RGVjaW1hbF9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIE1hdGguYWJzKHgyID0gTWF0aC5yb3VuZCh4MikpID49IDFlMjEgPyB4Mi50b0xvY2FsZVN0cmluZygiZW4iKS5yZXBsYWNlKC8sL2csICIiKSA6IHgyLnRvU3RyaW5nKDEwKTsKfQpmdW5jdGlvbiBmb3JtYXREZWNpbWFsUGFydHMoeDIsIHApIHsKICBpZiAoKGkgPSAoeDIgPSBwID8geDIudG9FeHBvbmVudGlhbChwIC0gMSkgOiB4Mi50b0V4cG9uZW50aWFsKCkpLmluZGV4T2YoImUiKSkgPCAwKSByZXR1cm4gbnVsbDsKICB2YXIgaSwgY29lZmZpY2llbnQgPSB4Mi5zbGljZSgwLCBpKTsKICByZXR1cm4gWwogICAgY29lZmZpY2llbnQubGVuZ3RoID4gMSA/IGNvZWZmaWNpZW50WzBdICsgY29lZmZpY2llbnQuc2xpY2UoMikgOiBjb2VmZmljaWVudCwKICAgICt4Mi5zbGljZShpICsgMSkKICBdOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9leHBvbmVudC5qcwpmdW5jdGlvbiBleHBvbmVudF9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIHgyID0gZm9ybWF0RGVjaW1hbFBhcnRzKE1hdGguYWJzKHgyKSksIHgyID8geDJbMV0gOiBOYU47Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdEdyb3VwLmpzCmZ1bmN0aW9uIGZvcm1hdEdyb3VwX2RlZmF1bHQoZ3JvdXBpbmcsIHRob3VzYW5kcykgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgd2lkdGgpIHsKICAgIHZhciBpID0gdmFsdWUubGVuZ3RoLCB0ID0gW10sIGogPSAwLCBnID0gZ3JvdXBpbmdbMF0sIGxlbmd0aCA9IDA7CiAgICB3aGlsZSAoaSA+IDAgJiYgZyA+IDApIHsKICAgICAgaWYgKGxlbmd0aCArIGcgKyAxID4gd2lkdGgpIGcgPSBNYXRoLm1heCgxLCB3aWR0aCAtIGxlbmd0aCk7CiAgICAgIHQucHVzaCh2YWx1ZS5zdWJzdHJpbmcoaSAtPSBnLCBpICsgZykpOwogICAgICBpZiAoKGxlbmd0aCArPSBnICsgMSkgPiB3aWR0aCkgYnJlYWs7CiAgICAgIGcgPSBncm91cGluZ1tqID0gKGogKyAxKSAlIGdyb3VwaW5nLmxlbmd0aF07CiAgICB9CiAgICByZXR1cm4gdC5yZXZlcnNlKCkuam9pbih0aG91c2FuZHMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdE51bWVyYWxzLmpzCmZ1bmN0aW9uIGZvcm1hdE51bWVyYWxzX2RlZmF1bHQobnVtZXJhbHMpIHsKICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC9bMC05XS9nLCBmdW5jdGlvbihpKSB7CiAgICAgIHJldHVybiBudW1lcmFsc1sraV07CiAgICB9KTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRTcGVjaWZpZXIuanMKdmFyIHJlID0gL14oPzooLik/KFs8Pj1eXSkpPyhbK1wtKCBdKT8oWyQjXSk/KDApPyhcZCspPygsKT8oXC5cZCspPyh+KT8oW2EteiVdKT8kL2k7CmZ1bmN0aW9uIGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpIHsKICBpZiAoIShtYXRjaCA9IHJlLmV4ZWMoc3BlY2lmaWVyKSkpIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCBmb3JtYXQ6ICIgKyBzcGVjaWZpZXIpOwogIHZhciBtYXRjaDsKICByZXR1cm4gbmV3IEZvcm1hdFNwZWNpZmllcih7CiAgICBmaWxsOiBtYXRjaFsxXSwKICAgIGFsaWduOiBtYXRjaFsyXSwKICAgIHNpZ246IG1hdGNoWzNdLAogICAgc3ltYm9sOiBtYXRjaFs0XSwKICAgIHplcm86IG1hdGNoWzVdLAogICAgd2lkdGg6IG1hdGNoWzZdLAogICAgY29tbWE6IG1hdGNoWzddLAogICAgcHJlY2lzaW9uOiBtYXRjaFs4XSAmJiBtYXRjaFs4XS5zbGljZSgxKSwKICAgIHRyaW06IG1hdGNoWzldLAogICAgdHlwZTogbWF0Y2hbMTBdCiAgfSk7Cn0KZm9ybWF0U3BlY2lmaWVyLnByb3RvdHlwZSA9IEZvcm1hdFNwZWNpZmllci5wcm90b3R5cGU7CmZ1bmN0aW9uIEZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpIHsKICB0aGlzLmZpbGwgPSBzcGVjaWZpZXIuZmlsbCA9PT0gdm9pZCAwID8gIiAiIDogc3BlY2lmaWVyLmZpbGwgKyAiIjsKICB0aGlzLmFsaWduID0gc3BlY2lmaWVyLmFsaWduID09PSB2b2lkIDAgPyAiPiIgOiBzcGVjaWZpZXIuYWxpZ24gKyAiIjsKICB0aGlzLnNpZ24gPSBzcGVjaWZpZXIuc2lnbiA9PT0gdm9pZCAwID8gIi0iIDogc3BlY2lmaWVyLnNpZ24gKyAiIjsKICB0aGlzLnN5bWJvbCA9IHNwZWNpZmllci5zeW1ib2wgPT09IHZvaWQgMCA/ICIiIDogc3BlY2lmaWVyLnN5bWJvbCArICIiOwogIHRoaXMuemVybyA9ICEhc3BlY2lmaWVyLnplcm87CiAgdGhpcy53aWR0aCA9IHNwZWNpZmllci53aWR0aCA9PT0gdm9pZCAwID8gdm9pZCAwIDogK3NwZWNpZmllci53aWR0aDsKICB0aGlzLmNvbW1hID0gISFzcGVjaWZpZXIuY29tbWE7CiAgdGhpcy5wcmVjaXNpb24gPSBzcGVjaWZpZXIucHJlY2lzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiArc3BlY2lmaWVyLnByZWNpc2lvbjsKICB0aGlzLnRyaW0gPSAhIXNwZWNpZmllci50cmltOwogIHRoaXMudHlwZSA9IHNwZWNpZmllci50eXBlID09PSB2b2lkIDAgPyAiIiA6IHNwZWNpZmllci50eXBlICsgIiI7Cn0KRm9ybWF0U3BlY2lmaWVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLmZpbGwgKyB0aGlzLmFsaWduICsgdGhpcy5zaWduICsgdGhpcy5zeW1ib2wgKyAodGhpcy56ZXJvID8gIjAiIDogIiIpICsgKHRoaXMud2lkdGggPT09IHZvaWQgMCA/ICIiIDogTWF0aC5tYXgoMSwgdGhpcy53aWR0aCB8IDApKSArICh0aGlzLmNvbW1hID8gIiwiIDogIiIpICsgKHRoaXMucHJlY2lzaW9uID09PSB2b2lkIDAgPyAiIiA6ICIuIiArIE1hdGgubWF4KDAsIHRoaXMucHJlY2lzaW9uIHwgMCkpICsgKHRoaXMudHJpbSA/ICJ+IiA6ICIiKSArIHRoaXMudHlwZTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFRyaW0uanMKZnVuY3Rpb24gZm9ybWF0VHJpbV9kZWZhdWx0KHMpIHsKICBvdXQ6IGZvciAodmFyIG4gPSBzLmxlbmd0aCwgaSA9IDEsIGkwID0gLTEsIGkxOyBpIDwgbjsgKytpKSB7CiAgICBzd2l0Y2ggKHNbaV0pIHsKICAgICAgY2FzZSAiLiI6CiAgICAgICAgaTAgPSBpMSA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIjAiOgogICAgICAgIGlmIChpMCA9PT0gMCkgaTAgPSBpOwogICAgICAgIGkxID0gaTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAoIStzW2ldKSBicmVhayBvdXQ7CiAgICAgICAgaWYgKGkwID4gMCkgaTAgPSAwOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICByZXR1cm4gaTAgPiAwID8gcy5zbGljZSgwLCBpMCkgKyBzLnNsaWNlKGkxICsgMSkgOiBzOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRQcmVmaXhBdXRvLmpzCnZhciBwcmVmaXhFeHBvbmVudDsKZnVuY3Rpb24gZm9ybWF0UHJlZml4QXV0b19kZWZhdWx0KHgyLCBwKSB7CiAgdmFyIGQgPSBmb3JtYXREZWNpbWFsUGFydHMoeDIsIHApOwogIGlmICghZCkgcmV0dXJuIHgyICsgIiI7CiAgdmFyIGNvZWZmaWNpZW50ID0gZFswXSwgZXhwb25lbnQgPSBkWzFdLCBpID0gZXhwb25lbnQgLSAocHJlZml4RXhwb25lbnQgPSBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudCAvIDMpKSkgKiAzKSArIDEsIG4gPSBjb2VmZmljaWVudC5sZW5ndGg7CiAgcmV0dXJuIGkgPT09IG4gPyBjb2VmZmljaWVudCA6IGkgPiBuID8gY29lZmZpY2llbnQgKyBuZXcgQXJyYXkoaSAtIG4gKyAxKS5qb2luKCIwIikgOiBpID4gMCA/IGNvZWZmaWNpZW50LnNsaWNlKDAsIGkpICsgIi4iICsgY29lZmZpY2llbnQuc2xpY2UoaSkgOiAiMC4iICsgbmV3IEFycmF5KDEgLSBpKS5qb2luKCIwIikgKyBmb3JtYXREZWNpbWFsUGFydHMoeDIsIE1hdGgubWF4KDAsIHAgKyBpIC0gMSkpWzBdOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRSb3VuZGVkLmpzCmZ1bmN0aW9uIGZvcm1hdFJvdW5kZWRfZGVmYXVsdCh4MiwgcCkgewogIHZhciBkID0gZm9ybWF0RGVjaW1hbFBhcnRzKHgyLCBwKTsKICBpZiAoIWQpIHJldHVybiB4MiArICIiOwogIHZhciBjb2VmZmljaWVudCA9IGRbMF0sIGV4cG9uZW50ID0gZFsxXTsKICByZXR1cm4gZXhwb25lbnQgPCAwID8gIjAuIiArIG5ldyBBcnJheSgtZXhwb25lbnQpLmpvaW4oIjAiKSArIGNvZWZmaWNpZW50IDogY29lZmZpY2llbnQubGVuZ3RoID4gZXhwb25lbnQgKyAxID8gY29lZmZpY2llbnQuc2xpY2UoMCwgZXhwb25lbnQgKyAxKSArICIuIiArIGNvZWZmaWNpZW50LnNsaWNlKGV4cG9uZW50ICsgMSkgOiBjb2VmZmljaWVudCArIG5ldyBBcnJheShleHBvbmVudCAtIGNvZWZmaWNpZW50Lmxlbmd0aCArIDIpLmpvaW4oIjAiKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0VHlwZXMuanMKdmFyIGZvcm1hdFR5cGVzX2RlZmF1bHQgPSB7CiAgIiUiOiAoeDIsIHApID0+ICh4MiAqIDEwMCkudG9GaXhlZChwKSwKICAiYiI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMiksCiAgImMiOiAoeDIpID0+IHgyICsgIiIsCiAgImQiOiBmb3JtYXREZWNpbWFsX2RlZmF1bHQsCiAgImUiOiAoeDIsIHApID0+IHgyLnRvRXhwb25lbnRpYWwocCksCiAgImYiOiAoeDIsIHApID0+IHgyLnRvRml4ZWQocCksCiAgImciOiAoeDIsIHApID0+IHgyLnRvUHJlY2lzaW9uKHApLAogICJvIjogKHgyKSA9PiBNYXRoLnJvdW5kKHgyKS50b1N0cmluZyg4KSwKICAicCI6ICh4MiwgcCkgPT4gZm9ybWF0Um91bmRlZF9kZWZhdWx0KHgyICogMTAwLCBwKSwKICAiciI6IGZvcm1hdFJvdW5kZWRfZGVmYXVsdCwKICAicyI6IGZvcm1hdFByZWZpeEF1dG9fZGVmYXVsdCwKICAiWCI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCksCiAgIngiOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDE2KQp9OwoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvaWRlbnRpdHkuanMKZnVuY3Rpb24gaWRlbnRpdHlfZGVmYXVsdCh4MikgewogIHJldHVybiB4MjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvbG9jYWxlLmpzCnZhciBtYXAgPSBBcnJheS5wcm90b3R5cGUubWFwOwp2YXIgcHJlZml4ZXMgPSBbInkiLCAieiIsICJhIiwgImYiLCAicCIsICJuIiwgIlx4QjUiLCAibSIsICIiLCAiayIsICJNIiwgIkciLCAiVCIsICJQIiwgIkUiLCAiWiIsICJZIl07CmZ1bmN0aW9uIGxvY2FsZV9kZWZhdWx0KGxvY2FsZTMpIHsKICB2YXIgZ3JvdXAgPSBsb2NhbGUzLmdyb3VwaW5nID09PSB2b2lkIDAgfHwgbG9jYWxlMy50aG91c2FuZHMgPT09IHZvaWQgMCA/IGlkZW50aXR5X2RlZmF1bHQgOiBmb3JtYXRHcm91cF9kZWZhdWx0KG1hcC5jYWxsKGxvY2FsZTMuZ3JvdXBpbmcsIE51bWJlciksIGxvY2FsZTMudGhvdXNhbmRzICsgIiIpLCBjdXJyZW5jeVByZWZpeCA9IGxvY2FsZTMuY3VycmVuY3kgPT09IHZvaWQgMCA/ICIiIDogbG9jYWxlMy5jdXJyZW5jeVswXSArICIiLCBjdXJyZW5jeVN1ZmZpeCA9IGxvY2FsZTMuY3VycmVuY3kgPT09IHZvaWQgMCA/ICIiIDogbG9jYWxlMy5jdXJyZW5jeVsxXSArICIiLCBkZWNpbWFsID0gbG9jYWxlMy5kZWNpbWFsID09PSB2b2lkIDAgPyAiLiIgOiBsb2NhbGUzLmRlY2ltYWwgKyAiIiwgbnVtZXJhbHMgPSBsb2NhbGUzLm51bWVyYWxzID09PSB2b2lkIDAgPyBpZGVudGl0eV9kZWZhdWx0IDogZm9ybWF0TnVtZXJhbHNfZGVmYXVsdChtYXAuY2FsbChsb2NhbGUzLm51bWVyYWxzLCBTdHJpbmcpKSwgcGVyY2VudCA9IGxvY2FsZTMucGVyY2VudCA9PT0gdm9pZCAwID8gIiUiIDogbG9jYWxlMy5wZXJjZW50ICsgIiIsIG1pbnVzID0gbG9jYWxlMy5taW51cyA9PT0gdm9pZCAwID8gIlx1MjIxMiIgOiBsb2NhbGUzLm1pbnVzICsgIiIsIG5hbiA9IGxvY2FsZTMubmFuID09PSB2b2lkIDAgPyAiTmFOIiA6IGxvY2FsZTMubmFuICsgIiI7CiAgZnVuY3Rpb24gbmV3Rm9ybWF0KHNwZWNpZmllcikgewogICAgc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcik7CiAgICB2YXIgZmlsbCA9IHNwZWNpZmllci5maWxsLCBhbGlnbiA9IHNwZWNpZmllci5hbGlnbiwgc2lnbjIgPSBzcGVjaWZpZXIuc2lnbiwgc3ltYm9sID0gc3BlY2lmaWVyLnN5bWJvbCwgemVybzMgPSBzcGVjaWZpZXIuemVybywgd2lkdGggPSBzcGVjaWZpZXIud2lkdGgsIGNvbW1hID0gc3BlY2lmaWVyLmNvbW1hLCBwcmVjaXNpb24gPSBzcGVjaWZpZXIucHJlY2lzaW9uLCB0cmltID0gc3BlY2lmaWVyLnRyaW0sIHR5cGUgPSBzcGVjaWZpZXIudHlwZTsKICAgIGlmICh0eXBlID09PSAibiIpIGNvbW1hID0gdHJ1ZSwgdHlwZSA9ICJnIjsKICAgIGVsc2UgaWYgKCFmb3JtYXRUeXBlc19kZWZhdWx0W3R5cGVdKSBwcmVjaXNpb24gPT09IHZvaWQgMCAmJiAocHJlY2lzaW9uID0gMTIpLCB0cmltID0gdHJ1ZSwgdHlwZSA9ICJnIjsKICAgIGlmICh6ZXJvMyB8fCBmaWxsID09PSAiMCIgJiYgYWxpZ24gPT09ICI9IikgemVybzMgPSB0cnVlLCBmaWxsID0gIjAiLCBhbGlnbiA9ICI9IjsKICAgIHZhciBwcmVmaXggPSBzeW1ib2wgPT09ICIkIiA/IGN1cnJlbmN5UHJlZml4IDogc3ltYm9sID09PSAiIyIgJiYgL1tib3hYXS8udGVzdCh0eXBlKSA/ICIwIiArIHR5cGUudG9Mb3dlckNhc2UoKSA6ICIiLCBzdWZmaXgyID0gc3ltYm9sID09PSAiJCIgPyBjdXJyZW5jeVN1ZmZpeCA6IC9bJXBdLy50ZXN0KHR5cGUpID8gcGVyY2VudCA6ICIiOwogICAgdmFyIGZvcm1hdFR5cGUgPSBmb3JtYXRUeXBlc19kZWZhdWx0W3R5cGVdLCBtYXliZVN1ZmZpeCA9IC9bZGVmZ3BycyVdLy50ZXN0KHR5cGUpOwogICAgcHJlY2lzaW9uID0gcHJlY2lzaW9uID09PSB2b2lkIDAgPyA2IDogL1tncHJzXS8udGVzdCh0eXBlKSA/IE1hdGgubWF4KDEsIE1hdGgubWluKDIxLCBwcmVjaXNpb24pKSA6IE1hdGgubWF4KDAsIE1hdGgubWluKDIwLCBwcmVjaXNpb24pKTsKICAgIGZ1bmN0aW9uIGZvcm1hdDIodmFsdWUpIHsKICAgICAgdmFyIHZhbHVlUHJlZml4ID0gcHJlZml4LCB2YWx1ZVN1ZmZpeCA9IHN1ZmZpeDIsIGksIG4sIGM7CiAgICAgIGlmICh0eXBlID09PSAiYyIpIHsKICAgICAgICB2YWx1ZVN1ZmZpeCA9IGZvcm1hdFR5cGUodmFsdWUpICsgdmFsdWVTdWZmaXg7CiAgICAgICAgdmFsdWUgPSAiIjsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgICAgICB2YXIgdmFsdWVOZWdhdGl2ZSA9IHZhbHVlIDwgMCB8fCAxIC8gdmFsdWUgPCAwOwogICAgICAgIHZhbHVlID0gaXNOYU4odmFsdWUpID8gbmFuIDogZm9ybWF0VHlwZShNYXRoLmFicyh2YWx1ZSksIHByZWNpc2lvbik7CiAgICAgICAgaWYgKHRyaW0pIHZhbHVlID0gZm9ybWF0VHJpbV9kZWZhdWx0KHZhbHVlKTsKICAgICAgICBpZiAodmFsdWVOZWdhdGl2ZSAmJiArdmFsdWUgPT09IDAgJiYgc2lnbjIgIT09ICIrIikgdmFsdWVOZWdhdGl2ZSA9IGZhbHNlOwogICAgICAgIHZhbHVlUHJlZml4ID0gKHZhbHVlTmVnYXRpdmUgPyBzaWduMiA9PT0gIigiID8gc2lnbjIgOiBtaW51cyA6IHNpZ24yID09PSAiLSIgfHwgc2lnbjIgPT09ICIoIiA/ICIiIDogc2lnbjIpICsgdmFsdWVQcmVmaXg7CiAgICAgICAgdmFsdWVTdWZmaXggPSAodHlwZSA9PT0gInMiID8gcHJlZml4ZXNbOCArIHByZWZpeEV4cG9uZW50IC8gM10gOiAiIikgKyB2YWx1ZVN1ZmZpeCArICh2YWx1ZU5lZ2F0aXZlICYmIHNpZ24yID09PSAiKCIgPyAiKSIgOiAiIik7CiAgICAgICAgaWYgKG1heWJlU3VmZml4KSB7CiAgICAgICAgICBpID0gLTEsIG4gPSB2YWx1ZS5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoKytpIDwgbikgewogICAgICAgICAgICBpZiAoYyA9IHZhbHVlLmNoYXJDb2RlQXQoaSksIDQ4ID4gYyB8fCBjID4gNTcpIHsKICAgICAgICAgICAgICB2YWx1ZVN1ZmZpeCA9IChjID09PSA0NiA/IGRlY2ltYWwgKyB2YWx1ZS5zbGljZShpICsgMSkgOiB2YWx1ZS5zbGljZShpKSkgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnNsaWNlKDAsIGkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChjb21tYSAmJiAhemVybzMpIHZhbHVlID0gZ3JvdXAodmFsdWUsIEluZmluaXR5KTsKICAgICAgdmFyIGxlbmd0aCA9IHZhbHVlUHJlZml4Lmxlbmd0aCArIHZhbHVlLmxlbmd0aCArIHZhbHVlU3VmZml4Lmxlbmd0aCwgcGFkZGluZyA9IGxlbmd0aCA8IHdpZHRoID8gbmV3IEFycmF5KHdpZHRoIC0gbGVuZ3RoICsgMSkuam9pbihmaWxsKSA6ICIiOwogICAgICBpZiAoY29tbWEgJiYgemVybzMpIHZhbHVlID0gZ3JvdXAocGFkZGluZyArIHZhbHVlLCBwYWRkaW5nLmxlbmd0aCA/IHdpZHRoIC0gdmFsdWVTdWZmaXgubGVuZ3RoIDogSW5maW5pdHkpLCBwYWRkaW5nID0gIiI7CiAgICAgIHN3aXRjaCAoYWxpZ24pIHsKICAgICAgICBjYXNlICI8IjoKICAgICAgICAgIHZhbHVlID0gdmFsdWVQcmVmaXggKyB2YWx1ZSArIHZhbHVlU3VmZml4ICsgcGFkZGluZzsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIj0iOgogICAgICAgICAgdmFsdWUgPSB2YWx1ZVByZWZpeCArIHBhZGRpbmcgKyB2YWx1ZSArIHZhbHVlU3VmZml4OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiXiI6CiAgICAgICAgICB2YWx1ZSA9IHBhZGRpbmcuc2xpY2UoMCwgbGVuZ3RoID0gcGFkZGluZy5sZW5ndGggPj4gMSkgKyB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXggKyBwYWRkaW5nLnNsaWNlKGxlbmd0aCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdmFsdWUgPSBwYWRkaW5nICsgdmFsdWVQcmVmaXggKyB2YWx1ZSArIHZhbHVlU3VmZml4OwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bWVyYWxzKHZhbHVlKTsKICAgIH0KICAgIGZvcm1hdDIudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHNwZWNpZmllciArICIiOwogICAgfTsKICAgIHJldHVybiBmb3JtYXQyOwogIH0KICBmdW5jdGlvbiBmb3JtYXRQcmVmaXgyKHNwZWNpZmllciwgdmFsdWUpIHsKICAgIHZhciBmID0gbmV3Rm9ybWF0KChzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSwgc3BlY2lmaWVyLnR5cGUgPSAiZiIsIHNwZWNpZmllcikpLCBlID0gTWF0aC5tYXgoLTgsIE1hdGgubWluKDgsIE1hdGguZmxvb3IoZXhwb25lbnRfZGVmYXVsdCh2YWx1ZSkgLyAzKSkpICogMywgayA9IE1hdGgucG93KDEwLCAtZSksIHByZWZpeCA9IHByZWZpeGVzWzggKyBlIC8gM107CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUyKSB7CiAgICAgIHJldHVybiBmKGsgKiB2YWx1ZTIpICsgcHJlZml4OwogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIGZvcm1hdDogbmV3Rm9ybWF0LAogICAgZm9ybWF0UHJlZml4OiBmb3JtYXRQcmVmaXgyCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZGVmYXVsdExvY2FsZS5qcwp2YXIgbG9jYWxlOwp2YXIgZm9ybWF0Owp2YXIgZm9ybWF0UHJlZml4OwpkZWZhdWx0TG9jYWxlKHsKICB0aG91c2FuZHM6ICIsIiwKICBncm91cGluZzogWzNdLAogIGN1cnJlbmN5OiBbIiQiLCAiIl0KfSk7CmZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUoZGVmaW5pdGlvbikgewogIGxvY2FsZSA9IGxvY2FsZV9kZWZhdWx0KGRlZmluaXRpb24pOwogIGZvcm1hdCA9IGxvY2FsZS5mb3JtYXQ7CiAgZm9ybWF0UHJlZml4ID0gbG9jYWxlLmZvcm1hdFByZWZpeDsKICByZXR1cm4gbG9jYWxlOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9wcmVjaXNpb25GaXhlZC5qcwpmdW5jdGlvbiBwcmVjaXNpb25GaXhlZF9kZWZhdWx0KHN0ZXApIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgLWV4cG9uZW50X2RlZmF1bHQoTWF0aC5hYnMoc3RlcCkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvcHJlY2lzaW9uUHJlZml4LmpzCmZ1bmN0aW9uIHByZWNpc2lvblByZWZpeF9kZWZhdWx0KHN0ZXAsIHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWF4KC04LCBNYXRoLm1pbig4LCBNYXRoLmZsb29yKGV4cG9uZW50X2RlZmF1bHQodmFsdWUpIC8gMykpKSAqIDMgLSBleHBvbmVudF9kZWZhdWx0KE1hdGguYWJzKHN0ZXApKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvblJvdW5kLmpzCmZ1bmN0aW9uIHByZWNpc2lvblJvdW5kX2RlZmF1bHQoc3RlcCwgbWF4MikgewogIHN0ZXAgPSBNYXRoLmFicyhzdGVwKSwgbWF4MiA9IE1hdGguYWJzKG1heDIpIC0gc3RlcDsKICByZXR1cm4gTWF0aC5tYXgoMCwgZXhwb25lbnRfZGVmYXVsdChtYXgyKSAtIGV4cG9uZW50X2RlZmF1bHQoc3RlcCkpICsgMTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy90aWNrRm9ybWF0LmpzCmZ1bmN0aW9uIHRpY2tGb3JtYXQoc3RhcnQsIHN0b3AsIGNvdW50LCBzcGVjaWZpZXIpIHsKICB2YXIgc3RlcCA9IHRpY2tTdGVwKHN0YXJ0LCBzdG9wLCBjb3VudCksIHByZWNpc2lvbjsKICBzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyID09IG51bGwgPyAiLGYiIDogc3BlY2lmaWVyKTsKICBzd2l0Y2ggKHNwZWNpZmllci50eXBlKSB7CiAgICBjYXNlICJzIjogewogICAgICB2YXIgdmFsdWUgPSBNYXRoLm1heChNYXRoLmFicyhzdGFydCksIE1hdGguYWJzKHN0b3ApKTsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uUHJlZml4X2RlZmF1bHQoc3RlcCwgdmFsdWUpKSkgc3BlY2lmaWVyLnByZWNpc2lvbiA9IHByZWNpc2lvbjsKICAgICAgcmV0dXJuIGZvcm1hdFByZWZpeChzcGVjaWZpZXIsIHZhbHVlKTsKICAgIH0KICAgIGNhc2UgIiI6CiAgICBjYXNlICJlIjoKICAgIGNhc2UgImciOgogICAgY2FzZSAicCI6CiAgICBjYXNlICJyIjogewogICAgICBpZiAoc3BlY2lmaWVyLnByZWNpc2lvbiA9PSBudWxsICYmICFpc05hTihwcmVjaXNpb24gPSBwcmVjaXNpb25Sb3VuZF9kZWZhdWx0KHN0ZXAsIE1hdGgubWF4KE1hdGguYWJzKHN0YXJ0KSwgTWF0aC5hYnMoc3RvcCkpKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb24gLSAoc3BlY2lmaWVyLnR5cGUgPT09ICJlIik7CiAgICAgIGJyZWFrOwogICAgfQogICAgY2FzZSAiZiI6CiAgICBjYXNlICIlIjogewogICAgICBpZiAoc3BlY2lmaWVyLnByZWNpc2lvbiA9PSBudWxsICYmICFpc05hTihwcmVjaXNpb24gPSBwcmVjaXNpb25GaXhlZF9kZWZhdWx0KHN0ZXApKSkgc3BlY2lmaWVyLnByZWNpc2lvbiA9IHByZWNpc2lvbiAtIChzcGVjaWZpZXIudHlwZSA9PT0gIiUiKSAqIDI7CiAgICAgIGJyZWFrOwogICAgfQogIH0KICByZXR1cm4gZm9ybWF0KHNwZWNpZmllcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbGluZWFyLmpzCmZ1bmN0aW9uIGxpbmVhcmlzaChzY2FsZSkgewogIHZhciBkb21haW4gPSBzY2FsZS5kb21haW47CiAgc2NhbGUudGlja3MgPSBmdW5jdGlvbihjb3VudCkgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHJldHVybiB0aWNrcyhkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGNvdW50ID09IG51bGwgPyAxMCA6IGNvdW50KTsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSBmdW5jdGlvbihjb3VudCwgc3BlY2lmaWVyKSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgcmV0dXJuIHRpY2tGb3JtYXQoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBjb3VudCA9PSBudWxsID8gMTAgOiBjb3VudCwgc3BlY2lmaWVyKTsKICB9OwogIHNjYWxlLm5pY2UgPSBmdW5jdGlvbihjb3VudCkgewogICAgaWYgKGNvdW50ID09IG51bGwpIGNvdW50ID0gMTA7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgdmFyIGkwID0gMDsKICAgIHZhciBpMSA9IGQubGVuZ3RoIC0gMTsKICAgIHZhciBzdGFydCA9IGRbaTBdOwogICAgdmFyIHN0b3AgPSBkW2kxXTsKICAgIHZhciBwcmVzdGVwOwogICAgdmFyIHN0ZXA7CiAgICB2YXIgbWF4SXRlciA9IDEwOwogICAgaWYgKHN0b3AgPCBzdGFydCkgewogICAgICBzdGVwID0gc3RhcnQsIHN0YXJ0ID0gc3RvcCwgc3RvcCA9IHN0ZXA7CiAgICAgIHN0ZXAgPSBpMCwgaTAgPSBpMSwgaTEgPSBzdGVwOwogICAgfQogICAgd2hpbGUgKG1heEl0ZXItLSA+IDApIHsKICAgICAgc3RlcCA9IHRpY2tJbmNyZW1lbnQoc3RhcnQsIHN0b3AsIGNvdW50KTsKICAgICAgaWYgKHN0ZXAgPT09IHByZXN0ZXApIHsKICAgICAgICBkW2kwXSA9IHN0YXJ0OwogICAgICAgIGRbaTFdID0gc3RvcDsKICAgICAgICByZXR1cm4gZG9tYWluKGQpOwogICAgICB9IGVsc2UgaWYgKHN0ZXAgPiAwKSB7CiAgICAgICAgc3RhcnQgPSBNYXRoLmZsb29yKHN0YXJ0IC8gc3RlcCkgKiBzdGVwOwogICAgICAgIHN0b3AgPSBNYXRoLmNlaWwoc3RvcCAvIHN0ZXApICogc3RlcDsKICAgICAgfSBlbHNlIGlmIChzdGVwIDwgMCkgewogICAgICAgIHN0YXJ0ID0gTWF0aC5jZWlsKHN0YXJ0ICogc3RlcCkgLyBzdGVwOwogICAgICAgIHN0b3AgPSBNYXRoLmZsb29yKHN0b3AgKiBzdGVwKSAvIHN0ZXA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcHJlc3RlcCA9IHN0ZXA7CiAgICB9CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gbGluZWFyMigpIHsKICB2YXIgc2NhbGUgPSBjb250aW51b3VzKCk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIGxpbmVhcjIoKSk7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvaWRlbnRpdHkuanMKZnVuY3Rpb24gaWRlbnRpdHkyKGRvbWFpbikgewogIHZhciB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogeDI7CiAgfQogIHNjYWxlLmludmVydCA9IHNjYWxlOwogIHNjYWxlLmRvbWFpbiA9IHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSwgc2NhbGUpIDogZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gaWRlbnRpdHkyKGRvbWFpbikudW5rbm93bih1bmtub3duKTsKICB9OwogIGRvbWFpbiA9IGFyZ3VtZW50cy5sZW5ndGggPyBBcnJheS5mcm9tKGRvbWFpbiwgbnVtYmVyMikgOiBbMCwgMV07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbmljZS5qcwpmdW5jdGlvbiBuaWNlKGRvbWFpbiwgaW50ZXJ2YWwpIHsKICBkb21haW4gPSBkb21haW4uc2xpY2UoKTsKICB2YXIgaTAgPSAwLCBpMSA9IGRvbWFpbi5sZW5ndGggLSAxLCB4MCA9IGRvbWFpbltpMF0sIHgxID0gZG9tYWluW2kxXSwgdDsKICBpZiAoeDEgPCB4MCkgewogICAgdCA9IGkwLCBpMCA9IGkxLCBpMSA9IHQ7CiAgICB0ID0geDAsIHgwID0geDEsIHgxID0gdDsKICB9CiAgZG9tYWluW2kwXSA9IGludGVydmFsLmZsb29yKHgwKTsKICBkb21haW5baTFdID0gaW50ZXJ2YWwuY2VpbCh4MSk7CiAgcmV0dXJuIGRvbWFpbjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9sb2cuanMKZnVuY3Rpb24gdHJhbnNmb3JtTG9nKHgyKSB7CiAgcmV0dXJuIE1hdGgubG9nKHgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1FeHAoeDIpIHsKICByZXR1cm4gTWF0aC5leHAoeDIpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUxvZ24oeDIpIHsKICByZXR1cm4gLU1hdGgubG9nKC14Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtRXhwbih4MikgewogIHJldHVybiAtTWF0aC5leHAoLXgyKTsKfQpmdW5jdGlvbiBwb3cxMCh4MikgewogIHJldHVybiBpc0Zpbml0ZSh4MikgPyArKCIxZSIgKyB4MikgOiB4MiA8IDAgPyAwIDogeDI7Cn0KZnVuY3Rpb24gcG93cChiYXNlKSB7CiAgcmV0dXJuIGJhc2UgPT09IDEwID8gcG93MTAgOiBiYXNlID09PSBNYXRoLkUgPyBNYXRoLmV4cCA6ICh4MikgPT4gTWF0aC5wb3coYmFzZSwgeDIpOwp9CmZ1bmN0aW9uIGxvZ3AoYmFzZSkgewogIHJldHVybiBiYXNlID09PSBNYXRoLkUgPyBNYXRoLmxvZyA6IGJhc2UgPT09IDEwICYmIE1hdGgubG9nMTAgfHwgYmFzZSA9PT0gMiAmJiBNYXRoLmxvZzIgfHwgKGJhc2UgPSBNYXRoLmxvZyhiYXNlKSwgKHgyKSA9PiBNYXRoLmxvZyh4MikgLyBiYXNlKTsKfQpmdW5jdGlvbiByZWZsZWN0KGYpIHsKICByZXR1cm4gKHgyLCBrKSA9PiAtZigteDIsIGspOwp9CmZ1bmN0aW9uIGxvZ2dpc2godHJhbnNmb3JtKSB7CiAgY29uc3Qgc2NhbGUgPSB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nLCB0cmFuc2Zvcm1FeHApOwogIGNvbnN0IGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICBsZXQgYmFzZSA9IDEwOwogIGxldCBsb2dzOwogIGxldCBwb3dzOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICBsb2dzID0gbG9ncChiYXNlKSwgcG93cyA9IHBvd3AoYmFzZSk7CiAgICBpZiAoZG9tYWluKClbMF0gPCAwKSB7CiAgICAgIGxvZ3MgPSByZWZsZWN0KGxvZ3MpLCBwb3dzID0gcmVmbGVjdChwb3dzKTsKICAgICAgdHJhbnNmb3JtKHRyYW5zZm9ybUxvZ24sIHRyYW5zZm9ybUV4cG4pOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNmb3JtKHRyYW5zZm9ybUxvZywgdHJhbnNmb3JtRXhwKTsKICAgIH0KICAgIHJldHVybiBzY2FsZTsKICB9CiAgc2NhbGUuYmFzZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGJhc2UgPSArXywgcmVzY2FsZSgpKSA6IGJhc2U7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4oXyksIHJlc2NhbGUoKSkgOiBkb21haW4oKTsKICB9OwogIHNjYWxlLnRpY2tzID0gKGNvdW50KSA9PiB7CiAgICBjb25zdCBkID0gZG9tYWluKCk7CiAgICBsZXQgdSA9IGRbMF07CiAgICBsZXQgdiA9IGRbZC5sZW5ndGggLSAxXTsKICAgIGNvbnN0IHIyID0gdiA8IHU7CiAgICBpZiAocjIpIFt1LCB2XSA9IFt2LCB1XTsKICAgIGxldCBpID0gbG9ncyh1KTsKICAgIGxldCBqID0gbG9ncyh2KTsKICAgIGxldCBrOwogICAgbGV0IHQ7CiAgICBjb25zdCBuID0gY291bnQgPT0gbnVsbCA/IDEwIDogK2NvdW50OwogICAgbGV0IHogPSBbXTsKICAgIGlmICghKGJhc2UgJSAxKSAmJiBqIC0gaSA8IG4pIHsKICAgICAgaSA9IE1hdGguZmxvb3IoaSksIGogPSBNYXRoLmNlaWwoaik7CiAgICAgIGlmICh1ID4gMCkgZm9yICg7IGkgPD0gajsgKytpKSB7CiAgICAgICAgZm9yIChrID0gMTsgayA8IGJhc2U7ICsraykgewogICAgICAgICAgdCA9IGkgPCAwID8gayAvIHBvd3MoLWkpIDogayAqIHBvd3MoaSk7CiAgICAgICAgICBpZiAodCA8IHUpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHQgPiB2KSBicmVhazsKICAgICAgICAgIHoucHVzaCh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSBmb3IgKDsgaSA8PSBqOyArK2kpIHsKICAgICAgICBmb3IgKGsgPSBiYXNlIC0gMTsgayA+PSAxOyAtLWspIHsKICAgICAgICAgIHQgPSBpID4gMCA/IGsgLyBwb3dzKC1pKSA6IGsgKiBwb3dzKGkpOwogICAgICAgICAgaWYgKHQgPCB1KSBjb250aW51ZTsKICAgICAgICAgIGlmICh0ID4gdikgYnJlYWs7CiAgICAgICAgICB6LnB1c2godCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh6Lmxlbmd0aCAqIDIgPCBuKSB6ID0gdGlja3ModSwgdiwgbik7CiAgICB9IGVsc2UgewogICAgICB6ID0gdGlja3MoaSwgaiwgTWF0aC5taW4oaiAtIGksIG4pKS5tYXAocG93cyk7CiAgICB9CiAgICByZXR1cm4gcjIgPyB6LnJldmVyc2UoKSA6IHo7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gKGNvdW50LCBzcGVjaWZpZXIpID0+IHsKICAgIGlmIChjb3VudCA9PSBudWxsKSBjb3VudCA9IDEwOwogICAgaWYgKHNwZWNpZmllciA9PSBudWxsKSBzcGVjaWZpZXIgPSBiYXNlID09PSAxMCA/ICJzIiA6ICIsIjsKICAgIGlmICh0eXBlb2Ygc3BlY2lmaWVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGlmICghKGJhc2UgJSAxKSAmJiAoc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikpLnByZWNpc2lvbiA9PSBudWxsKSBzcGVjaWZpZXIudHJpbSA9IHRydWU7CiAgICAgIHNwZWNpZmllciA9IGZvcm1hdChzcGVjaWZpZXIpOwogICAgfQogICAgaWYgKGNvdW50ID09PSBJbmZpbml0eSkgcmV0dXJuIHNwZWNpZmllcjsKICAgIGNvbnN0IGsgPSBNYXRoLm1heCgxLCBiYXNlICogY291bnQgLyBzY2FsZS50aWNrcygpLmxlbmd0aCk7CiAgICByZXR1cm4gKGQpID0+IHsKICAgICAgbGV0IGkgPSBkIC8gcG93cyhNYXRoLnJvdW5kKGxvZ3MoZCkpKTsKICAgICAgaWYgKGkgKiBiYXNlIDwgYmFzZSAtIDAuNSkgaSAqPSBiYXNlOwogICAgICByZXR1cm4gaSA8PSBrID8gc3BlY2lmaWVyKGQpIDogIiI7CiAgICB9OwogIH07CiAgc2NhbGUubmljZSA9ICgpID0+IHsKICAgIHJldHVybiBkb21haW4obmljZShkb21haW4oKSwgewogICAgICBmbG9vcjogKHgyKSA9PiBwb3dzKE1hdGguZmxvb3IobG9ncyh4MikpKSwKICAgICAgY2VpbDogKHgyKSA9PiBwb3dzKE1hdGguY2VpbChsb2dzKHgyKSkpCiAgICB9KSk7CiAgfTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gbG9nKCkgewogIGNvbnN0IHNjYWxlID0gbG9nZ2lzaCh0cmFuc2Zvcm1lcigpKS5kb21haW4oWzEsIDEwXSk7CiAgc2NhbGUuY29weSA9ICgpID0+IGNvcHkoc2NhbGUsIGxvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zeW1sb2cuanMKZnVuY3Rpb24gdHJhbnNmb3JtU3ltbG9nKGMpIHsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiBNYXRoLnNpZ24oeDIpICogTWF0aC5sb2cxcChNYXRoLmFicyh4MiAvIGMpKTsKICB9Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybVN5bWV4cChjKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gTWF0aC5zaWduKHgyKSAqIE1hdGguZXhwbTEoTWF0aC5hYnMoeDIpKSAqIGM7CiAgfTsKfQpmdW5jdGlvbiBzeW1sb2dpc2godHJhbnNmb3JtKSB7CiAgdmFyIGMgPSAxLCBzY2FsZSA9IHRyYW5zZm9ybSh0cmFuc2Zvcm1TeW1sb2coYyksIHRyYW5zZm9ybVN5bWV4cChjKSk7CiAgc2NhbGUuY29uc3RhbnQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRyYW5zZm9ybSh0cmFuc2Zvcm1TeW1sb2coYyA9ICtfKSwgdHJhbnNmb3JtU3ltZXhwKGMpKSA6IGM7CiAgfTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQpmdW5jdGlvbiBzeW1sb2coKSB7CiAgdmFyIHNjYWxlID0gc3ltbG9naXNoKHRyYW5zZm9ybWVyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBzeW1sb2coKSkuY29uc3RhbnQoc2NhbGUuY29uc3RhbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3Bvdy5qcwpmdW5jdGlvbiB0cmFuc2Zvcm1Qb3coZXhwb25lbnQpIHsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiB4MiA8IDAgPyAtTWF0aC5wb3coLXgyLCBleHBvbmVudCkgOiBNYXRoLnBvdyh4MiwgZXhwb25lbnQpOwogIH07Cn0KZnVuY3Rpb24gdHJhbnNmb3JtU3FydCh4MikgewogIHJldHVybiB4MiA8IDAgPyAtTWF0aC5zcXJ0KC14MikgOiBNYXRoLnNxcnQoeDIpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybVNxdWFyZSh4MikgewogIHJldHVybiB4MiA8IDAgPyAteDIgKiB4MiA6IHgyICogeDI7Cn0KZnVuY3Rpb24gcG93aXNoKHRyYW5zZm9ybSkgewogIHZhciBzY2FsZSA9IHRyYW5zZm9ybShpZGVudGl0eSwgaWRlbnRpdHkpLCBleHBvbmVudCA9IDE7CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHJldHVybiBleHBvbmVudCA9PT0gMSA/IHRyYW5zZm9ybShpZGVudGl0eSwgaWRlbnRpdHkpIDogZXhwb25lbnQgPT09IDAuNSA/IHRyYW5zZm9ybSh0cmFuc2Zvcm1TcXJ0LCB0cmFuc2Zvcm1TcXVhcmUpIDogdHJhbnNmb3JtKHRyYW5zZm9ybVBvdyhleHBvbmVudCksIHRyYW5zZm9ybVBvdygxIC8gZXhwb25lbnQpKTsKICB9CiAgc2NhbGUuZXhwb25lbnQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChleHBvbmVudCA9ICtfLCByZXNjYWxlKCkpIDogZXhwb25lbnQ7CiAgfTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQpmdW5jdGlvbiBwb3coKSB7CiAgdmFyIHNjYWxlID0gcG93aXNoKHRyYW5zZm9ybWVyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBwb3coKSkuZXhwb25lbnQoc2NhbGUuZXhwb25lbnQoKSk7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIHNxcnQoKSB7CiAgcmV0dXJuIHBvdy5hcHBseShudWxsLCBhcmd1bWVudHMpLmV4cG9uZW50KDAuNSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcmFkaWFsLmpzCmZ1bmN0aW9uIHNxdWFyZSh4MikgewogIHJldHVybiBNYXRoLnNpZ24oeDIpICogeDIgKiB4MjsKfQpmdW5jdGlvbiB1bnNxdWFyZSh4MikgewogIHJldHVybiBNYXRoLnNpZ24oeDIpICogTWF0aC5zcXJ0KE1hdGguYWJzKHgyKSk7Cn0KZnVuY3Rpb24gcmFkaWFsKCkgewogIHZhciBzcXVhcmVkID0gY29udGludW91cygpLCByYW5nZTQgPSBbMCwgMV0sIHJvdW5kID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHZhciB5MiA9IHVuc3F1YXJlKHNxdWFyZWQoeDIpKTsKICAgIHJldHVybiBpc05hTih5MikgPyB1bmtub3duIDogcm91bmQgPyBNYXRoLnJvdW5kKHkyKSA6IHkyOwogIH0KICBzY2FsZS5pbnZlcnQgPSBmdW5jdGlvbih5MikgewogICAgcmV0dXJuIHNxdWFyZWQuaW52ZXJ0KHNxdWFyZSh5MikpOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5kb21haW4oXyksIHNjYWxlKSA6IHNxdWFyZWQuZG9tYWluKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHNxdWFyZWQucmFuZ2UoKHJhbmdlNCA9IEFycmF5LmZyb20oXywgbnVtYmVyMikpLm1hcChzcXVhcmUpKSwgc2NhbGUpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIHNjYWxlLnJhbmdlKF8pLnJvdW5kKHRydWUpOwogIH07CiAgc2NhbGUucm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyb3VuZCA9ICEhXywgc2NhbGUpIDogcm91bmQ7CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHNxdWFyZWQuY2xhbXAoXyksIHNjYWxlKSA6IHNxdWFyZWQuY2xhbXAoKTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiByYWRpYWwoc3F1YXJlZC5kb21haW4oKSwgcmFuZ2U0KS5yb3VuZChyb3VuZCkuY2xhbXAoc3F1YXJlZC5jbGFtcCgpKS51bmtub3duKHVua25vd24pOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3F1YW50aWxlLmpzCmZ1bmN0aW9uIHF1YW50aWxlMigpIHsKICB2YXIgZG9tYWluID0gW10sIHJhbmdlNCA9IFtdLCB0aHJlc2hvbGRzID0gW10sIHVua25vd247CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBpID0gMCwgbiA9IE1hdGgubWF4KDEsIHJhbmdlNC5sZW5ndGgpOwogICAgdGhyZXNob2xkcyA9IG5ldyBBcnJheShuIC0gMSk7CiAgICB3aGlsZSAoKytpIDwgbikgdGhyZXNob2xkc1tpIC0gMV0gPSBxdWFudGlsZVNvcnRlZChkb21haW4sIGkgLyBuKTsKICAgIHJldHVybiBzY2FsZTsKICB9CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiByYW5nZTRbYmlzZWN0X2RlZmF1bHQodGhyZXNob2xkcywgeDIpXTsKICB9CiAgc2NhbGUuaW52ZXJ0RXh0ZW50ID0gZnVuY3Rpb24oeTIpIHsKICAgIHZhciBpID0gcmFuZ2U0LmluZGV4T2YoeTIpOwogICAgcmV0dXJuIGkgPCAwID8gW05hTiwgTmFOXSA6IFsKICAgICAgaSA+IDAgPyB0aHJlc2hvbGRzW2kgLSAxXSA6IGRvbWFpblswXSwKICAgICAgaSA8IHRocmVzaG9sZHMubGVuZ3RoID8gdGhyZXNob2xkc1tpXSA6IGRvbWFpbltkb21haW4ubGVuZ3RoIC0gMV0KICAgIF07CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdOwogICAgZm9yIChsZXQgZCBvZiBfKSBpZiAoZCAhPSBudWxsICYmICFpc05hTihkID0gK2QpKSBkb21haW4ucHVzaChkKTsKICAgIGRvbWFpbi5zb3J0KGFzY2VuZGluZyk7CiAgICByZXR1cm4gcmVzY2FsZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5xdWFudGlsZXMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aHJlc2hvbGRzLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcXVhbnRpbGUyKCkuZG9tYWluKGRvbWFpbikucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9xdWFudGl6ZS5qcwpmdW5jdGlvbiBxdWFudGl6ZSgpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDEsIG4gPSAxLCBkb21haW4gPSBbMC41XSwgcmFuZ2U0ID0gWzAsIDFdLCB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgIT0gbnVsbCAmJiB4MiA8PSB4MiA/IHJhbmdlNFtiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAwLCBuKV0gOiB1bmtub3duOwogIH0KICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIGkgPSAtMTsKICAgIGRvbWFpbiA9IG5ldyBBcnJheShuKTsKICAgIHdoaWxlICgrK2kgPCBuKSBkb21haW5baV0gPSAoKGkgKyAxKSAqIHgxIC0gKGkgLSBuKSAqIHgwKSAvIChuICsgMSk7CiAgICByZXR1cm4gc2NhbGU7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFt4MCwgeDFdID0gXywgeDAgPSAreDAsIHgxID0gK3gxLCByZXNjYWxlKCkpIDogW3gwLCB4MV07CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKG4gPSAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSkubGVuZ3RoIC0gMSwgcmVzY2FsZSgpKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUuaW52ZXJ0RXh0ZW50ID0gZnVuY3Rpb24oeTIpIHsKICAgIHZhciBpID0gcmFuZ2U0LmluZGV4T2YoeTIpOwogICAgcmV0dXJuIGkgPCAwID8gW05hTiwgTmFOXSA6IGkgPCAxID8gW3gwLCBkb21haW5bMF1dIDogaSA+PSBuID8gW2RvbWFpbltuIC0gMV0sIHgxXSA6IFtkb21haW5baSAtIDFdLCBkb21haW5baV1dOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiBzY2FsZTsKICB9OwogIHNjYWxlLnRocmVzaG9sZHMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBkb21haW4uc2xpY2UoKTsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBxdWFudGl6ZSgpLmRvbWFpbihbeDAsIHgxXSkucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShsaW5lYXJpc2goc2NhbGUpLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3RocmVzaG9sZC5qcwpmdW5jdGlvbiB0aHJlc2hvbGQoKSB7CiAgdmFyIGRvbWFpbiA9IFswLjVdLCByYW5nZTQgPSBbMCwgMV0sIHVua25vd24sIG4gPSAxOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgIT0gbnVsbCAmJiB4MiA8PSB4MiA/IHJhbmdlNFtiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAwLCBuKV0gOiB1bmtub3duOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4gPSBBcnJheS5mcm9tKF8pLCBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCAtIDEpLCBzY2FsZSkgOiBkb21haW4uc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgbiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlNC5sZW5ndGggLSAxKSwgc2NhbGUpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5pbnZlcnRFeHRlbnQgPSBmdW5jdGlvbih5MikgewogICAgdmFyIGkgPSByYW5nZTQuaW5kZXhPZih5Mik7CiAgICByZXR1cm4gW2RvbWFpbltpIC0gMV0sIGRvbWFpbltpXV07CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhyZXNob2xkKCkuZG9tYWluKGRvbWFpbikucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2ludGVydmFsLmpzCnZhciB0MCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwp2YXIgdDEgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKZnVuY3Rpb24gdGltZUludGVydmFsKGZsb29yaSwgb2Zmc2V0aSwgY291bnQsIGZpZWxkKSB7CiAgZnVuY3Rpb24gaW50ZXJ2YWwoZGF0ZTIpIHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTIgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwID8gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkgOiAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKSksIGRhdGUyOwogIH0KICBpbnRlcnZhbC5mbG9vciA9IChkYXRlMikgPT4gewogICAgcmV0dXJuIGZsb29yaShkYXRlMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTIpKSwgZGF0ZTI7CiAgfTsKICBpbnRlcnZhbC5jZWlsID0gKGRhdGUyKSA9PiB7CiAgICByZXR1cm4gZmxvb3JpKGRhdGUyID0gbmV3IERhdGUoZGF0ZTIgLSAxKSksIG9mZnNldGkoZGF0ZTIsIDEpLCBmbG9vcmkoZGF0ZTIpLCBkYXRlMjsKICB9OwogIGludGVydmFsLnJvdW5kID0gKGRhdGUyKSA9PiB7CiAgICBjb25zdCBkMCA9IGludGVydmFsKGRhdGUyKSwgZDEgPSBpbnRlcnZhbC5jZWlsKGRhdGUyKTsKICAgIHJldHVybiBkYXRlMiAtIGQwIDwgZDEgLSBkYXRlMiA/IGQwIDogZDE7CiAgfTsKICBpbnRlcnZhbC5vZmZzZXQgPSAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIHJldHVybiBvZmZzZXRpKGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMiksIHN0ZXAgPT0gbnVsbCA/IDEgOiBNYXRoLmZsb29yKHN0ZXApKSwgZGF0ZTI7CiAgfTsKICBpbnRlcnZhbC5yYW5nZSA9IChzdGFydCwgc3RvcCwgc3RlcCkgPT4gewogICAgY29uc3QgcmFuZ2U0ID0gW107CiAgICBzdGFydCA9IGludGVydmFsLmNlaWwoc3RhcnQpOwogICAgc3RlcCA9IHN0ZXAgPT0gbnVsbCA/IDEgOiBNYXRoLmZsb29yKHN0ZXApOwogICAgaWYgKCEoc3RhcnQgPCBzdG9wKSB8fCAhKHN0ZXAgPiAwKSkgcmV0dXJuIHJhbmdlNDsKICAgIGxldCBwcmV2aW91czsKICAgIGRvCiAgICAgIHJhbmdlNC5wdXNoKHByZXZpb3VzID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtzdGFydCkpLCBvZmZzZXRpKHN0YXJ0LCBzdGVwKSwgZmxvb3JpKHN0YXJ0KTsKICAgIHdoaWxlIChwcmV2aW91cyA8IHN0YXJ0ICYmIHN0YXJ0IDwgc3RvcCk7CiAgICByZXR1cm4gcmFuZ2U0OwogIH07CiAgaW50ZXJ2YWwuZmlsdGVyID0gKHRlc3QpID0+IHsKICAgIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICAgIGlmIChkYXRlMiA+PSBkYXRlMikgd2hpbGUgKGZsb29yaShkYXRlMiksICF0ZXN0KGRhdGUyKSkgZGF0ZTIuc2V0VGltZShkYXRlMiAtIDEpOwogICAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICAgIGlmIChkYXRlMiA+PSBkYXRlMikgewogICAgICAgIGlmIChzdGVwIDwgMCkgd2hpbGUgKCsrc3RlcCA8PSAwKSB7CiAgICAgICAgICB3aGlsZSAob2Zmc2V0aShkYXRlMiwgLTEpLCAhdGVzdChkYXRlMikpIHsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB3aGlsZSAoLS1zdGVwID49IDApIHsKICAgICAgICAgIHdoaWxlIChvZmZzZXRpKGRhdGUyLCAxKSwgIXRlc3QoZGF0ZTIpKSB7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9OwogIGlmIChjb3VudCkgewogICAgaW50ZXJ2YWwuY291bnQgPSAoc3RhcnQsIGVuZCkgPT4gewogICAgICB0MC5zZXRUaW1lKCtzdGFydCksIHQxLnNldFRpbWUoK2VuZCk7CiAgICAgIGZsb29yaSh0MCksIGZsb29yaSh0MSk7CiAgICAgIHJldHVybiBNYXRoLmZsb29yKGNvdW50KHQwLCB0MSkpOwogICAgfTsKICAgIGludGVydmFsLmV2ZXJ5ID0gKHN0ZXApID0+IHsKICAgICAgc3RlcCA9IE1hdGguZmxvb3Ioc3RlcCk7CiAgICAgIHJldHVybiAhaXNGaW5pdGUoc3RlcCkgfHwgIShzdGVwID4gMCkgPyBudWxsIDogIShzdGVwID4gMSkgPyBpbnRlcnZhbCA6IGludGVydmFsLmZpbHRlcihmaWVsZCA/IChkKSA9PiBmaWVsZChkKSAlIHN0ZXAgPT09IDAgOiAoZCkgPT4gaW50ZXJ2YWwuY291bnQoMCwgZCkgJSBzdGVwID09PSAwKTsKICAgIH07CiAgfQogIHJldHVybiBpbnRlcnZhbDsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21pbGxpc2Vjb25kLmpzCnZhciBtaWxsaXNlY29uZCA9IHRpbWVJbnRlcnZhbCgoKSA9PiB7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZCAtIHN0YXJ0Owp9KTsKbWlsbGlzZWNvbmQuZXZlcnkgPSAoaykgPT4gewogIGsgPSBNYXRoLmZsb29yKGspOwogIGlmICghaXNGaW5pdGUoaykgfHwgIShrID4gMCkpIHJldHVybiBudWxsOwogIGlmICghKGsgPiAxKSkgcmV0dXJuIG1pbGxpc2Vjb25kOwogIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRUaW1lKE1hdGguZmxvb3IoZGF0ZTIgLyBrKSAqIGspOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogayk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gazsKICB9KTsKfTsKdmFyIG1pbGxpc2Vjb25kcyA9IG1pbGxpc2Vjb25kLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2R1cmF0aW9uLmpzCnZhciBkdXJhdGlvblNlY29uZCA9IDFlMzsKdmFyIGR1cmF0aW9uTWludXRlID0gZHVyYXRpb25TZWNvbmQgKiA2MDsKdmFyIGR1cmF0aW9uSG91ciA9IGR1cmF0aW9uTWludXRlICogNjA7CnZhciBkdXJhdGlvbkRheSA9IGR1cmF0aW9uSG91ciAqIDI0Owp2YXIgZHVyYXRpb25XZWVrID0gZHVyYXRpb25EYXkgKiA3Owp2YXIgZHVyYXRpb25Nb250aCA9IGR1cmF0aW9uRGF5ICogMzA7CnZhciBkdXJhdGlvblllYXIgPSBkdXJhdGlvbkRheSAqIDM2NTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9zZWNvbmQuanMKdmFyIHNlY29uZCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gZGF0ZTIuZ2V0TWlsbGlzZWNvbmRzKCkpOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvblNlY29uZCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvblNlY29uZDsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ1NlY29uZHMoKTsKfSk7CnZhciBzZWNvbmRzID0gc2Vjb25kLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21pbnV0ZS5qcwp2YXIgdGltZU1pbnV0ZSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gZGF0ZTIuZ2V0TWlsbGlzZWNvbmRzKCkgLSBkYXRlMi5nZXRTZWNvbmRzKCkgKiBkdXJhdGlvblNlY29uZCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uTWludXRlKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uTWludXRlOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0TWludXRlcygpOwp9KTsKdmFyIHRpbWVNaW51dGVzID0gdGltZU1pbnV0ZS5yYW5nZTsKdmFyIHV0Y01pbnV0ZSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENTZWNvbmRzKDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbk1pbnV0ZSk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbk1pbnV0ZTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ01pbnV0ZXMoKTsKfSk7CnZhciB1dGNNaW51dGVzID0gdXRjTWludXRlLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2hvdXIuanMKdmFyIHRpbWVIb3VyID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSBkYXRlMi5nZXRNaWxsaXNlY29uZHMoKSAtIGRhdGUyLmdldFNlY29uZHMoKSAqIGR1cmF0aW9uU2Vjb25kIC0gZGF0ZTIuZ2V0TWludXRlcygpICogZHVyYXRpb25NaW51dGUpOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbkhvdXIpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25Ib3VyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0SG91cnMoKTsKfSk7CnZhciB0aW1lSG91cnMgPSB0aW1lSG91ci5yYW5nZTsKdmFyIHV0Y0hvdXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDTWludXRlcygwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25Ib3VyKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uSG91cjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ0hvdXJzKCk7Cn0pOwp2YXIgdXRjSG91cnMgPSB1dGNIb3VyLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2RheS5qcwp2YXIgdGltZURheSA9IHRpbWVJbnRlcnZhbCgKICAoZGF0ZTIpID0+IGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApLAogIChkYXRlMiwgc3RlcCkgPT4gZGF0ZTIuc2V0RGF0ZShkYXRlMi5nZXREYXRlKCkgKyBzdGVwKSwKICAoc3RhcnQsIGVuZCkgPT4gKGVuZCAtIHN0YXJ0IC0gKGVuZC5nZXRUaW1lem9uZU9mZnNldCgpIC0gc3RhcnQuZ2V0VGltZXpvbmVPZmZzZXQoKSkgKiBkdXJhdGlvbk1pbnV0ZSkgLyBkdXJhdGlvbkRheSwKICAoZGF0ZTIpID0+IGRhdGUyLmdldERhdGUoKSAtIDEKKTsKdmFyIHRpbWVEYXlzID0gdGltZURheS5yYW5nZTsKdmFyIHV0Y0RheSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uRGF5Owp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDRGF0ZSgpIC0gMTsKfSk7CnZhciB1dGNEYXlzID0gdXRjRGF5LnJhbmdlOwp2YXIgdW5peERheSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uRGF5Owp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gTWF0aC5mbG9vcihkYXRlMiAvIGR1cmF0aW9uRGF5KTsKfSk7CnZhciB1bml4RGF5cyA9IHVuaXhEYXkucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvd2Vlay5qcwpmdW5jdGlvbiB0aW1lV2Vla2RheShpKSB7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldERhdGUoZGF0ZTIuZ2V0RGF0ZSgpIC0gKGRhdGUyLmdldERheSgpICsgNyAtIGkpICUgNyk7CiAgICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldERhdGUoZGF0ZTIuZ2V0RGF0ZSgpICsgc3RlcCAqIDcpOwogIH0sIChzdGFydCwgZW5kKSA9PiB7CiAgICByZXR1cm4gKGVuZCAtIHN0YXJ0IC0gKGVuZC5nZXRUaW1lem9uZU9mZnNldCgpIC0gc3RhcnQuZ2V0VGltZXpvbmVPZmZzZXQoKSkgKiBkdXJhdGlvbk1pbnV0ZSkgLyBkdXJhdGlvbldlZWs7CiAgfSk7Cn0KdmFyIHRpbWVTdW5kYXkgPSB0aW1lV2Vla2RheSgwKTsKdmFyIHRpbWVNb25kYXkgPSB0aW1lV2Vla2RheSgxKTsKdmFyIHRpbWVUdWVzZGF5ID0gdGltZVdlZWtkYXkoMik7CnZhciB0aW1lV2VkbmVzZGF5ID0gdGltZVdlZWtkYXkoMyk7CnZhciB0aW1lVGh1cnNkYXkgPSB0aW1lV2Vla2RheSg0KTsKdmFyIHRpbWVGcmlkYXkgPSB0aW1lV2Vla2RheSg1KTsKdmFyIHRpbWVTYXR1cmRheSA9IHRpbWVXZWVrZGF5KDYpOwp2YXIgdGltZVN1bmRheXMgPSB0aW1lU3VuZGF5LnJhbmdlOwp2YXIgdGltZU1vbmRheXMgPSB0aW1lTW9uZGF5LnJhbmdlOwp2YXIgdGltZVR1ZXNkYXlzID0gdGltZVR1ZXNkYXkucmFuZ2U7CnZhciB0aW1lV2VkbmVzZGF5cyA9IHRpbWVXZWRuZXNkYXkucmFuZ2U7CnZhciB0aW1lVGh1cnNkYXlzID0gdGltZVRodXJzZGF5LnJhbmdlOwp2YXIgdGltZUZyaWRheXMgPSB0aW1lRnJpZGF5LnJhbmdlOwp2YXIgdGltZVNhdHVyZGF5cyA9IHRpbWVTYXR1cmRheS5yYW5nZTsKZnVuY3Rpb24gdXRjV2Vla2RheShpKSB7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldFVUQ0RhdGUoZGF0ZTIuZ2V0VVRDRGF0ZSgpIC0gKGRhdGUyLmdldFVUQ0RheSgpICsgNyAtIGkpICUgNyk7CiAgICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldFVUQ0RhdGUoZGF0ZTIuZ2V0VVRDRGF0ZSgpICsgc3RlcCAqIDcpOwogIH0sIChzdGFydCwgZW5kKSA9PiB7CiAgICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uV2VlazsKICB9KTsKfQp2YXIgdXRjU3VuZGF5ID0gdXRjV2Vla2RheSgwKTsKdmFyIHV0Y01vbmRheSA9IHV0Y1dlZWtkYXkoMSk7CnZhciB1dGNUdWVzZGF5ID0gdXRjV2Vla2RheSgyKTsKdmFyIHV0Y1dlZG5lc2RheSA9IHV0Y1dlZWtkYXkoMyk7CnZhciB1dGNUaHVyc2RheSA9IHV0Y1dlZWtkYXkoNCk7CnZhciB1dGNGcmlkYXkgPSB1dGNXZWVrZGF5KDUpOwp2YXIgdXRjU2F0dXJkYXkgPSB1dGNXZWVrZGF5KDYpOwp2YXIgdXRjU3VuZGF5cyA9IHV0Y1N1bmRheS5yYW5nZTsKdmFyIHV0Y01vbmRheXMgPSB1dGNNb25kYXkucmFuZ2U7CnZhciB1dGNUdWVzZGF5cyA9IHV0Y1R1ZXNkYXkucmFuZ2U7CnZhciB1dGNXZWRuZXNkYXlzID0gdXRjV2VkbmVzZGF5LnJhbmdlOwp2YXIgdXRjVGh1cnNkYXlzID0gdXRjVGh1cnNkYXkucmFuZ2U7CnZhciB1dGNGcmlkYXlzID0gdXRjRnJpZGF5LnJhbmdlOwp2YXIgdXRjU2F0dXJkYXlzID0gdXRjU2F0dXJkYXkucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbW9udGguanMKdmFyIHRpbWVNb250aCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXREYXRlKDEpOwogIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRNb250aChkYXRlMi5nZXRNb250aCgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRNb250aCgpIC0gc3RhcnQuZ2V0TW9udGgoKSArIChlbmQuZ2V0RnVsbFllYXIoKSAtIHN0YXJ0LmdldEZ1bGxZZWFyKCkpICogMTI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRNb250aCgpOwp9KTsKdmFyIHRpbWVNb250aHMgPSB0aW1lTW9udGgucmFuZ2U7CnZhciB1dGNNb250aCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENEYXRlKDEpOwogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENNb250aChkYXRlMi5nZXRVVENNb250aCgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRVVENNb250aCgpIC0gc3RhcnQuZ2V0VVRDTW9udGgoKSArIChlbmQuZ2V0VVRDRnVsbFllYXIoKSAtIHN0YXJ0LmdldFVUQ0Z1bGxZZWFyKCkpICogMTI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENNb250aCgpOwp9KTsKdmFyIHV0Y01vbnRocyA9IHV0Y01vbnRoLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3llYXIuanMKdmFyIHRpbWVZZWFyID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldE1vbnRoKDAsIDEpOwogIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRGdWxsWWVhcihkYXRlMi5nZXRGdWxsWWVhcigpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRGdWxsWWVhcigpIC0gc3RhcnQuZ2V0RnVsbFllYXIoKTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldEZ1bGxZZWFyKCk7Cn0pOwp0aW1lWWVhci5ldmVyeSA9IChrKSA9PiB7CiAgcmV0dXJuICFpc0Zpbml0ZShrID0gTWF0aC5mbG9vcihrKSkgfHwgIShrID4gMCkgPyBudWxsIDogdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0RnVsbFllYXIoTWF0aC5mbG9vcihkYXRlMi5nZXRGdWxsWWVhcigpIC8gaykgKiBrKTsKICAgIGRhdGUyLnNldE1vbnRoKDAsIDEpOwogICAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihkYXRlMi5nZXRGdWxsWWVhcigpICsgc3RlcCAqIGspOwogIH0pOwp9Owp2YXIgdGltZVllYXJzID0gdGltZVllYXIucmFuZ2U7CnZhciB1dGNZZWFyID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ01vbnRoKDAsIDEpOwogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENGdWxsWWVhcihkYXRlMi5nZXRVVENGdWxsWWVhcigpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRVVENGdWxsWWVhcigpIC0gc3RhcnQuZ2V0VVRDRnVsbFllYXIoKTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCk7Cn0pOwp1dGNZZWFyLmV2ZXJ5ID0gKGspID0+IHsKICByZXR1cm4gIWlzRmluaXRlKGsgPSBNYXRoLmZsb29yKGspKSB8fCAhKGsgPiAwKSA/IG51bGwgOiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRVVENGdWxsWWVhcihNYXRoLmZsb29yKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgLyBrKSAqIGspOwogICAgZGF0ZTIuc2V0VVRDTW9udGgoMCwgMSk7CiAgICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgKyBzdGVwICogayk7CiAgfSk7Cn07CnZhciB1dGNZZWFycyA9IHV0Y1llYXIucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvdGlja3MuanMKZnVuY3Rpb24gdGlja2VyKHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSkgewogIGNvbnN0IHRpY2tJbnRlcnZhbHMgPSBbCiAgICBbc2Vjb25kLCAxLCBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCA1LCA1ICogZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgMTUsIDE1ICogZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgMzAsIDMwICogZHVyYXRpb25TZWNvbmRdLAogICAgW21pbnV0ZSwgMSwgZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgNSwgNSAqIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDE1LCAxNSAqIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDMwLCAzMCAqIGR1cmF0aW9uTWludXRlXSwKICAgIFtob3VyLCAxLCBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDMsIDMgKiBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDYsIDYgKiBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDEyLCAxMiAqIGR1cmF0aW9uSG91cl0sCiAgICBbZGF5LCAxLCBkdXJhdGlvbkRheV0sCiAgICBbZGF5LCAyLCAyICogZHVyYXRpb25EYXldLAogICAgW3dlZWssIDEsIGR1cmF0aW9uV2Vla10sCiAgICBbbW9udGgsIDEsIGR1cmF0aW9uTW9udGhdLAogICAgW21vbnRoLCAzLCAzICogZHVyYXRpb25Nb250aF0sCiAgICBbeWVhciwgMSwgZHVyYXRpb25ZZWFyXQogIF07CiAgZnVuY3Rpb24gdGlja3MyKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogICAgY29uc3QgcmV2ZXJzZTIgPSBzdG9wIDwgc3RhcnQ7CiAgICBpZiAocmV2ZXJzZTIpIFtzdGFydCwgc3RvcF0gPSBbc3RvcCwgc3RhcnRdOwogICAgY29uc3QgaW50ZXJ2YWwgPSBjb3VudCAmJiB0eXBlb2YgY291bnQucmFuZ2UgPT09ICJmdW5jdGlvbiIgPyBjb3VudCA6IHRpY2tJbnRlcnZhbChzdGFydCwgc3RvcCwgY291bnQpOwogICAgY29uc3QgdGlja3MzID0gaW50ZXJ2YWwgPyBpbnRlcnZhbC5yYW5nZShzdGFydCwgK3N0b3AgKyAxKSA6IFtdOwogICAgcmV0dXJuIHJldmVyc2UyID8gdGlja3MzLnJldmVyc2UoKSA6IHRpY2tzMzsKICB9CiAgZnVuY3Rpb24gdGlja0ludGVydmFsKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogICAgY29uc3QgdGFyZ2V0ID0gTWF0aC5hYnMoc3RvcCAtIHN0YXJ0KSAvIGNvdW50OwogICAgY29uc3QgaSA9IGJpc2VjdG9yKChbLCAsIHN0ZXAyXSkgPT4gc3RlcDIpLnJpZ2h0KHRpY2tJbnRlcnZhbHMsIHRhcmdldCk7CiAgICBpZiAoaSA9PT0gdGlja0ludGVydmFscy5sZW5ndGgpIHJldHVybiB5ZWFyLmV2ZXJ5KHRpY2tTdGVwKHN0YXJ0IC8gZHVyYXRpb25ZZWFyLCBzdG9wIC8gZHVyYXRpb25ZZWFyLCBjb3VudCkpOwogICAgaWYgKGkgPT09IDApIHJldHVybiBtaWxsaXNlY29uZC5ldmVyeShNYXRoLm1heCh0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpLCAxKSk7CiAgICBjb25zdCBbdCwgc3RlcF0gPSB0aWNrSW50ZXJ2YWxzW3RhcmdldCAvIHRpY2tJbnRlcnZhbHNbaSAtIDFdWzJdIDwgdGlja0ludGVydmFsc1tpXVsyXSAvIHRhcmdldCA/IGkgLSAxIDogaV07CiAgICByZXR1cm4gdC5ldmVyeShzdGVwKTsKICB9CiAgcmV0dXJuIFt0aWNrczIsIHRpY2tJbnRlcnZhbF07Cn0KdmFyIFt1dGNUaWNrcywgdXRjVGlja0ludGVydmFsXSA9IHRpY2tlcih1dGNZZWFyLCB1dGNNb250aCwgdXRjU3VuZGF5LCB1bml4RGF5LCB1dGNIb3VyLCB1dGNNaW51dGUpOwp2YXIgW3RpbWVUaWNrcywgdGltZVRpY2tJbnRlcnZhbF0gPSB0aWNrZXIodGltZVllYXIsIHRpbWVNb250aCwgdGltZVN1bmRheSwgdGltZURheSwgdGltZUhvdXIsIHRpbWVNaW51dGUpOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9sb2NhbGUuanMKZnVuY3Rpb24gbG9jYWxEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTIgPSBuZXcgRGF0ZSgtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCk7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihkLnkpOwogICAgcmV0dXJuIGRhdGUyOwogIH0KICByZXR1cm4gbmV3IERhdGUoZC55LCBkLm0sIGQuZCwgZC5ILCBkLk0sIGQuUywgZC5MKTsKfQpmdW5jdGlvbiB1dGNEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTIgPSBuZXcgRGF0ZShEYXRlLlVUQygtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZC55KTsKICAgIHJldHVybiBkYXRlMjsKICB9CiAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKGQueSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwp9CmZ1bmN0aW9uIG5ld0RhdGUoeTIsIG0sIGQpIHsKICByZXR1cm4geyB5OiB5MiwgbSwgZCwgSDogMCwgTTogMCwgUzogMCwgTDogMCB9Owp9CmZ1bmN0aW9uIGZvcm1hdExvY2FsZShsb2NhbGUzKSB7CiAgdmFyIGxvY2FsZV9kYXRlVGltZSA9IGxvY2FsZTMuZGF0ZVRpbWUsIGxvY2FsZV9kYXRlID0gbG9jYWxlMy5kYXRlLCBsb2NhbGVfdGltZSA9IGxvY2FsZTMudGltZSwgbG9jYWxlX3BlcmlvZHMgPSBsb2NhbGUzLnBlcmlvZHMsIGxvY2FsZV93ZWVrZGF5cyA9IGxvY2FsZTMuZGF5cywgbG9jYWxlX3Nob3J0V2Vla2RheXMgPSBsb2NhbGUzLnNob3J0RGF5cywgbG9jYWxlX21vbnRocyA9IGxvY2FsZTMubW9udGhzLCBsb2NhbGVfc2hvcnRNb250aHMgPSBsb2NhbGUzLnNob3J0TW9udGhzOwogIHZhciBwZXJpb2RSZSA9IGZvcm1hdFJlKGxvY2FsZV9wZXJpb2RzKSwgcGVyaW9kTG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9wZXJpb2RzKSwgd2Vla2RheVJlID0gZm9ybWF0UmUobG9jYWxlX3dlZWtkYXlzKSwgd2Vla2RheUxvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfd2Vla2RheXMpLCBzaG9ydFdlZWtkYXlSZSA9IGZvcm1hdFJlKGxvY2FsZV9zaG9ydFdlZWtkYXlzKSwgc2hvcnRXZWVrZGF5TG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9zaG9ydFdlZWtkYXlzKSwgbW9udGhSZSA9IGZvcm1hdFJlKGxvY2FsZV9tb250aHMpLCBtb250aExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfbW9udGhzKSwgc2hvcnRNb250aFJlID0gZm9ybWF0UmUobG9jYWxlX3Nob3J0TW9udGhzKSwgc2hvcnRNb250aExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfc2hvcnRNb250aHMpOwogIHZhciBmb3JtYXRzID0gewogICAgImEiOiBmb3JtYXRTaG9ydFdlZWtkYXksCiAgICAiQSI6IGZvcm1hdFdlZWtkYXksCiAgICAiYiI6IGZvcm1hdFNob3J0TW9udGgsCiAgICAiQiI6IGZvcm1hdE1vbnRoLAogICAgImMiOiBudWxsLAogICAgImQiOiBmb3JtYXREYXlPZk1vbnRoLAogICAgImUiOiBmb3JtYXREYXlPZk1vbnRoLAogICAgImYiOiBmb3JtYXRNaWNyb3NlY29uZHMsCiAgICAiZyI6IGZvcm1hdFllYXJJU08sCiAgICAiRyI6IGZvcm1hdEZ1bGxZZWFySVNPLAogICAgIkgiOiBmb3JtYXRIb3VyMjQsCiAgICAiSSI6IGZvcm1hdEhvdXIxMiwKICAgICJqIjogZm9ybWF0RGF5T2ZZZWFyLAogICAgIkwiOiBmb3JtYXRNaWxsaXNlY29uZHMsCiAgICAibSI6IGZvcm1hdE1vbnRoTnVtYmVyLAogICAgIk0iOiBmb3JtYXRNaW51dGVzLAogICAgInAiOiBmb3JtYXRQZXJpb2QsCiAgICAicSI6IGZvcm1hdFF1YXJ0ZXIsCiAgICAiUSI6IGZvcm1hdFVuaXhUaW1lc3RhbXAsCiAgICAicyI6IGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBmb3JtYXRTZWNvbmRzLAogICAgInUiOiBmb3JtYXRXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBmb3JtYXRXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBmb3JtYXRXZWVrTnVtYmVySVNPLAogICAgInciOiBmb3JtYXRXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBmb3JtYXRXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBudWxsLAogICAgIlgiOiBudWxsLAogICAgInkiOiBmb3JtYXRZZWFyLAogICAgIlkiOiBmb3JtYXRGdWxsWWVhciwKICAgICJaIjogZm9ybWF0Wm9uZSwKICAgICIlIjogZm9ybWF0TGl0ZXJhbFBlcmNlbnQKICB9OwogIHZhciB1dGNGb3JtYXRzID0gewogICAgImEiOiBmb3JtYXRVVENTaG9ydFdlZWtkYXksCiAgICAiQSI6IGZvcm1hdFVUQ1dlZWtkYXksCiAgICAiYiI6IGZvcm1hdFVUQ1Nob3J0TW9udGgsCiAgICAiQiI6IGZvcm1hdFVUQ01vbnRoLAogICAgImMiOiBudWxsLAogICAgImQiOiBmb3JtYXRVVENEYXlPZk1vbnRoLAogICAgImUiOiBmb3JtYXRVVENEYXlPZk1vbnRoLAogICAgImYiOiBmb3JtYXRVVENNaWNyb3NlY29uZHMsCiAgICAiZyI6IGZvcm1hdFVUQ1llYXJJU08sCiAgICAiRyI6IGZvcm1hdFVUQ0Z1bGxZZWFySVNPLAogICAgIkgiOiBmb3JtYXRVVENIb3VyMjQsCiAgICAiSSI6IGZvcm1hdFVUQ0hvdXIxMiwKICAgICJqIjogZm9ybWF0VVRDRGF5T2ZZZWFyLAogICAgIkwiOiBmb3JtYXRVVENNaWxsaXNlY29uZHMsCiAgICAibSI6IGZvcm1hdFVUQ01vbnRoTnVtYmVyLAogICAgIk0iOiBmb3JtYXRVVENNaW51dGVzLAogICAgInAiOiBmb3JtYXRVVENQZXJpb2QsCiAgICAicSI6IGZvcm1hdFVUQ1F1YXJ0ZXIsCiAgICAiUSI6IGZvcm1hdFVuaXhUaW1lc3RhbXAsCiAgICAicyI6IGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBmb3JtYXRVVENTZWNvbmRzLAogICAgInUiOiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBmb3JtYXRVVENXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBmb3JtYXRVVENXZWVrTnVtYmVySVNPLAogICAgInciOiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBmb3JtYXRVVENXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBudWxsLAogICAgIlgiOiBudWxsLAogICAgInkiOiBmb3JtYXRVVENZZWFyLAogICAgIlkiOiBmb3JtYXRVVENGdWxsWWVhciwKICAgICJaIjogZm9ybWF0VVRDWm9uZSwKICAgICIlIjogZm9ybWF0TGl0ZXJhbFBlcmNlbnQKICB9OwogIHZhciBwYXJzZXMgPSB7CiAgICAiYSI6IHBhcnNlU2hvcnRXZWVrZGF5LAogICAgIkEiOiBwYXJzZVdlZWtkYXksCiAgICAiYiI6IHBhcnNlU2hvcnRNb250aCwKICAgICJCIjogcGFyc2VNb250aCwKICAgICJjIjogcGFyc2VMb2NhbGVEYXRlVGltZSwKICAgICJkIjogcGFyc2VEYXlPZk1vbnRoLAogICAgImUiOiBwYXJzZURheU9mTW9udGgsCiAgICAiZiI6IHBhcnNlTWljcm9zZWNvbmRzLAogICAgImciOiBwYXJzZVllYXIsCiAgICAiRyI6IHBhcnNlRnVsbFllYXIsCiAgICAiSCI6IHBhcnNlSG91cjI0LAogICAgIkkiOiBwYXJzZUhvdXIyNCwKICAgICJqIjogcGFyc2VEYXlPZlllYXIsCiAgICAiTCI6IHBhcnNlTWlsbGlzZWNvbmRzLAogICAgIm0iOiBwYXJzZU1vbnRoTnVtYmVyLAogICAgIk0iOiBwYXJzZU1pbnV0ZXMsCiAgICAicCI6IHBhcnNlUGVyaW9kLAogICAgInEiOiBwYXJzZVF1YXJ0ZXIsCiAgICAiUSI6IHBhcnNlVW5peFRpbWVzdGFtcCwKICAgICJzIjogcGFyc2VVbml4VGltZXN0YW1wU2Vjb25kcywKICAgICJTIjogcGFyc2VTZWNvbmRzLAogICAgInUiOiBwYXJzZVdlZWtkYXlOdW1iZXJNb25kYXksCiAgICAiVSI6IHBhcnNlV2Vla051bWJlclN1bmRheSwKICAgICJWIjogcGFyc2VXZWVrTnVtYmVySVNPLAogICAgInciOiBwYXJzZVdlZWtkYXlOdW1iZXJTdW5kYXksCiAgICAiVyI6IHBhcnNlV2Vla051bWJlck1vbmRheSwKICAgICJ4IjogcGFyc2VMb2NhbGVEYXRlLAogICAgIlgiOiBwYXJzZUxvY2FsZVRpbWUsCiAgICAieSI6IHBhcnNlWWVhciwKICAgICJZIjogcGFyc2VGdWxsWWVhciwKICAgICJaIjogcGFyc2Vab25lLAogICAgIiUiOiBwYXJzZUxpdGVyYWxQZXJjZW50CiAgfTsKICBmb3JtYXRzLnggPSBuZXdGb3JtYXQobG9jYWxlX2RhdGUsIGZvcm1hdHMpOwogIGZvcm1hdHMuWCA9IG5ld0Zvcm1hdChsb2NhbGVfdGltZSwgZm9ybWF0cyk7CiAgZm9ybWF0cy5jID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlVGltZSwgZm9ybWF0cyk7CiAgdXRjRm9ybWF0cy54ID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlLCB1dGNGb3JtYXRzKTsKICB1dGNGb3JtYXRzLlggPSBuZXdGb3JtYXQobG9jYWxlX3RpbWUsIHV0Y0Zvcm1hdHMpOwogIHV0Y0Zvcm1hdHMuYyA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZVRpbWUsIHV0Y0Zvcm1hdHMpOwogIGZ1bmN0aW9uIG5ld0Zvcm1hdChzcGVjaWZpZXIsIGZvcm1hdHMyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZTIpIHsKICAgICAgdmFyIHN0cmluZyA9IFtdLCBpID0gLTEsIGogPSAwLCBuID0gc3BlY2lmaWVyLmxlbmd0aCwgYywgcGFkMiwgZm9ybWF0MjsKICAgICAgaWYgKCEoZGF0ZTIgaW5zdGFuY2VvZiBEYXRlKSkgZGF0ZTIgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKTsKICAgICAgd2hpbGUgKCsraSA8IG4pIHsKICAgICAgICBpZiAoc3BlY2lmaWVyLmNoYXJDb2RlQXQoaSkgPT09IDM3KSB7CiAgICAgICAgICBzdHJpbmcucHVzaChzcGVjaWZpZXIuc2xpY2UoaiwgaSkpOwogICAgICAgICAgaWYgKChwYWQyID0gcGFkc1tjID0gc3BlY2lmaWVyLmNoYXJBdCgrK2kpXSkgIT0gbnVsbCkgYyA9IHNwZWNpZmllci5jaGFyQXQoKytpKTsKICAgICAgICAgIGVsc2UgcGFkMiA9IGMgPT09ICJlIiA/ICIgIiA6ICIwIjsKICAgICAgICAgIGlmIChmb3JtYXQyID0gZm9ybWF0czJbY10pIGMgPSBmb3JtYXQyKGRhdGUyLCBwYWQyKTsKICAgICAgICAgIHN0cmluZy5wdXNoKGMpOwogICAgICAgICAgaiA9IGkgKyAxOwogICAgICAgIH0KICAgICAgfQogICAgICBzdHJpbmcucHVzaChzcGVjaWZpZXIuc2xpY2UoaiwgaSkpOwogICAgICByZXR1cm4gc3RyaW5nLmpvaW4oIiIpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gbmV3UGFyc2Uoc3BlY2lmaWVyLCBaKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIHZhciBkID0gbmV3RGF0ZSgxOTAwLCB2b2lkIDAsIDEpLCBpID0gcGFyc2VTcGVjaWZpZXIoZCwgc3BlY2lmaWVyLCBzdHJpbmcgKz0gIiIsIDApLCB3ZWVrLCBkYXk7CiAgICAgIGlmIChpICE9IHN0cmluZy5sZW5ndGgpIHJldHVybiBudWxsOwogICAgICBpZiAoIlEiIGluIGQpIHJldHVybiBuZXcgRGF0ZShkLlEpOwogICAgICBpZiAoInMiIGluIGQpIHJldHVybiBuZXcgRGF0ZShkLnMgKiAxZTMgKyAoIkwiIGluIGQgPyBkLkwgOiAwKSk7CiAgICAgIGlmIChaICYmICEoIloiIGluIGQpKSBkLlogPSAwOwogICAgICBpZiAoInAiIGluIGQpIGQuSCA9IGQuSCAlIDEyICsgZC5wICogMTI7CiAgICAgIGlmIChkLm0gPT09IHZvaWQgMCkgZC5tID0gInEiIGluIGQgPyBkLnEgOiAwOwogICAgICBpZiAoIlYiIGluIGQpIHsKICAgICAgICBpZiAoZC5WIDwgMSB8fCBkLlYgPiA1MykgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCEoInciIGluIGQpKSBkLncgPSAxOwogICAgICAgIGlmICgiWiIgaW4gZCkgewogICAgICAgICAgd2VlayA9IHV0Y0RhdGUobmV3RGF0ZShkLnksIDAsIDEpKSwgZGF5ID0gd2Vlay5nZXRVVENEYXkoKTsKICAgICAgICAgIHdlZWsgPSBkYXkgPiA0IHx8IGRheSA9PT0gMCA/IHV0Y01vbmRheS5jZWlsKHdlZWspIDogdXRjTW9uZGF5KHdlZWspOwogICAgICAgICAgd2VlayA9IHV0Y0RheS5vZmZzZXQod2VlaywgKGQuViAtIDEpICogNyk7CiAgICAgICAgICBkLnkgPSB3ZWVrLmdldFVUQ0Z1bGxZZWFyKCk7CiAgICAgICAgICBkLm0gPSB3ZWVrLmdldFVUQ01vbnRoKCk7CiAgICAgICAgICBkLmQgPSB3ZWVrLmdldFVUQ0RhdGUoKSArIChkLncgKyA2KSAlIDc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdlZWsgPSBsb2NhbERhdGUobmV3RGF0ZShkLnksIDAsIDEpKSwgZGF5ID0gd2Vlay5nZXREYXkoKTsKICAgICAgICAgIHdlZWsgPSBkYXkgPiA0IHx8IGRheSA9PT0gMCA/IHRpbWVNb25kYXkuY2VpbCh3ZWVrKSA6IHRpbWVNb25kYXkod2Vlayk7CiAgICAgICAgICB3ZWVrID0gdGltZURheS5vZmZzZXQod2VlaywgKGQuViAtIDEpICogNyk7CiAgICAgICAgICBkLnkgPSB3ZWVrLmdldEZ1bGxZZWFyKCk7CiAgICAgICAgICBkLm0gPSB3ZWVrLmdldE1vbnRoKCk7CiAgICAgICAgICBkLmQgPSB3ZWVrLmdldERhdGUoKSArIChkLncgKyA2KSAlIDc7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCJXIiBpbiBkIHx8ICJVIiBpbiBkKSB7CiAgICAgICAgaWYgKCEoInciIGluIGQpKSBkLncgPSAidSIgaW4gZCA/IGQudSAlIDcgOiAiVyIgaW4gZCA/IDEgOiAwOwogICAgICAgIGRheSA9ICJaIiBpbiBkID8gdXRjRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLmdldFVUQ0RheSgpIDogbG9jYWxEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSkuZ2V0RGF5KCk7CiAgICAgICAgZC5tID0gMDsKICAgICAgICBkLmQgPSAiVyIgaW4gZCA/IChkLncgKyA2KSAlIDcgKyBkLlcgKiA3IC0gKGRheSArIDUpICUgNyA6IGQudyArIGQuVSAqIDcgLSAoZGF5ICsgNikgJSA3OwogICAgICB9CiAgICAgIGlmICgiWiIgaW4gZCkgewogICAgICAgIGQuSCArPSBkLlogLyAxMDAgfCAwOwogICAgICAgIGQuTSArPSBkLlogJSAxMDA7CiAgICAgICAgcmV0dXJuIHV0Y0RhdGUoZCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxvY2FsRGF0ZShkKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlU3BlY2lmaWVyKGQsIHNwZWNpZmllciwgc3RyaW5nLCBqKSB7CiAgICB2YXIgaSA9IDAsIG4gPSBzcGVjaWZpZXIubGVuZ3RoLCBtID0gc3RyaW5nLmxlbmd0aCwgYywgcGFyc2U7CiAgICB3aGlsZSAoaSA8IG4pIHsKICAgICAgaWYgKGogPj0gbSkgcmV0dXJuIC0xOwogICAgICBjID0gc3BlY2lmaWVyLmNoYXJDb2RlQXQoaSsrKTsKICAgICAgaWYgKGMgPT09IDM3KSB7CiAgICAgICAgYyA9IHNwZWNpZmllci5jaGFyQXQoaSsrKTsKICAgICAgICBwYXJzZSA9IHBhcnNlc1tjIGluIHBhZHMgPyBzcGVjaWZpZXIuY2hhckF0KGkrKykgOiBjXTsKICAgICAgICBpZiAoIXBhcnNlIHx8IChqID0gcGFyc2UoZCwgc3RyaW5nLCBqKSkgPCAwKSByZXR1cm4gLTE7CiAgICAgIH0gZWxzZSBpZiAoYyAhPSBzdHJpbmcuY2hhckNvZGVBdChqKyspKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gajsKICB9CiAgZnVuY3Rpb24gcGFyc2VQZXJpb2QoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHBlcmlvZFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQucCA9IHBlcmlvZExvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZVNob3J0V2Vla2RheShkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gc2hvcnRXZWVrZGF5UmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC53ID0gc2hvcnRXZWVrZGF5TG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlV2Vla2RheShkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gd2Vla2RheVJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQudyA9IHdlZWtkYXlMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VTaG9ydE1vbnRoKGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBzaG9ydE1vbnRoUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5tID0gc2hvcnRNb250aExvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZU1vbnRoKGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBtb250aFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQubSA9IG1vbnRoTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlRGF0ZVRpbWUoZCwgc3RyaW5nLCBpKSB7CiAgICByZXR1cm4gcGFyc2VTcGVjaWZpZXIoZCwgbG9jYWxlX2RhdGVUaW1lLCBzdHJpbmcsIGkpOwogIH0KICBmdW5jdGlvbiBwYXJzZUxvY2FsZURhdGUoZCwgc3RyaW5nLCBpKSB7CiAgICByZXR1cm4gcGFyc2VTcGVjaWZpZXIoZCwgbG9jYWxlX2RhdGUsIHN0cmluZywgaSk7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlVGltZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfdGltZSwgc3RyaW5nLCBpKTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0U2hvcnRXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRXZWVrZGF5c1tkLmdldERheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3dlZWtkYXlzW2QuZ2V0RGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRTaG9ydE1vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRNb250aHNbZC5nZXRNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0TW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9tb250aHNbZC5nZXRNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UGVyaW9kKGQpIHsKICAgIHJldHVybiBsb2NhbGVfcGVyaW9kc1srKGQuZ2V0SG91cnMoKSA+PSAxMildOwogIH0KICBmdW5jdGlvbiBmb3JtYXRRdWFydGVyKGQpIHsKICAgIHJldHVybiAxICsgfn4oZC5nZXRNb250aCgpIC8gMyk7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1Nob3J0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0V2Vla2RheXNbZC5nZXRVVENEYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV93ZWVrZGF5c1tkLmdldFVUQ0RheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDU2hvcnRNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0TW9udGhzW2QuZ2V0VVRDTW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ01vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfbW9udGhzW2QuZ2V0VVRDTW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1BlcmlvZChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3BlcmlvZHNbKyhkLmdldFVUQ0hvdXJzKCkgPj0gMTIpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDUXVhcnRlcihkKSB7CiAgICByZXR1cm4gMSArIH5+KGQuZ2V0VVRDTW9udGgoKSAvIDMpOwogIH0KICByZXR1cm4gewogICAgZm9ybWF0OiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIGYgPSBuZXdGb3JtYXQoc3BlY2lmaWVyICs9ICIiLCBmb3JtYXRzKTsKICAgICAgZi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBmOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIHAgPSBuZXdQYXJzZShzcGVjaWZpZXIgKz0gIiIsIGZhbHNlKTsKICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBwOwogICAgfSwKICAgIHV0Y0Zvcm1hdDogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBmID0gbmV3Rm9ybWF0KHNwZWNpZmllciArPSAiIiwgdXRjRm9ybWF0cyk7CiAgICAgIGYudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gZjsKICAgIH0sCiAgICB1dGNQYXJzZTogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBwID0gbmV3UGFyc2Uoc3BlY2lmaWVyICs9ICIiLCB0cnVlKTsKICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBwOwogICAgfQogIH07Cn0KdmFyIHBhZHMgPSB7ICItIjogIiIsICJfIjogIiAiLCAiMCI6ICIwIiB9Owp2YXIgbnVtYmVyUmUgPSAvXlxzKlxkKy87CnZhciBwZXJjZW50UmUgPSAvXiUvOwp2YXIgcmVxdW90ZVJlID0gL1tcXF4kKis/fFtcXSgpLnt9XS9nOwpmdW5jdGlvbiBwYWQodmFsdWUsIGZpbGwsIHdpZHRoKSB7CiAgdmFyIHNpZ24yID0gdmFsdWUgPCAwID8gIi0iIDogIiIsIHN0cmluZyA9IChzaWduMiA/IC12YWx1ZSA6IHZhbHVlKSArICIiLCBsZW5ndGggPSBzdHJpbmcubGVuZ3RoOwogIHJldHVybiBzaWduMiArIChsZW5ndGggPCB3aWR0aCA/IG5ldyBBcnJheSh3aWR0aCAtIGxlbmd0aCArIDEpLmpvaW4oZmlsbCkgKyBzdHJpbmcgOiBzdHJpbmcpOwp9CmZ1bmN0aW9uIHJlcXVvdGUocykgewogIHJldHVybiBzLnJlcGxhY2UocmVxdW90ZVJlLCAiXFwkJiIpOwp9CmZ1bmN0aW9uIGZvcm1hdFJlKG5hbWVzKSB7CiAgcmV0dXJuIG5ldyBSZWdFeHAoIl4oPzoiICsgbmFtZXMubWFwKHJlcXVvdGUpLmpvaW4oInwiKSArICIpIiwgImkiKTsKfQpmdW5jdGlvbiBmb3JtYXRMb29rdXAobmFtZXMpIHsKICByZXR1cm4gbmV3IE1hcChuYW1lcy5tYXAoKG5hbWUsIGkpID0+IFtuYW1lLnRvTG93ZXJDYXNlKCksIGldKSk7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrZGF5TnVtYmVyU3VuZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IChkLncgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla2RheU51bWJlck1vbmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyAoZC51ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtOdW1iZXJTdW5kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuVSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrTnVtYmVySVNPKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlYgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla051bWJlck1vbmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5XID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUZ1bGxZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDQpKTsKICByZXR1cm4gbiA/IChkLnkgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC55ID0gK25bMF0gKyAoK25bMF0gPiA2OCA/IDE5MDAgOiAyZTMpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2Vab25lKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gL14oWil8KFsrLV1cZFxkKSg/Ojo/KFxkXGQpKT8vLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyA2KSk7CiAgcmV0dXJuIG4gPyAoZC5aID0gblsxXSA/IDAgOiAtKG5bMl0gKyAoblszXSB8fCAiMDAiKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVF1YXJ0ZXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gKGQucSA9IG5bMF0gKiAzIC0gMywgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTW9udGhOdW1iZXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQubSA9IG5bMF0gLSAxLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VEYXlPZk1vbnRoKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLmQgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlRGF5T2ZZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDMpKTsKICByZXR1cm4gbiA/IChkLm0gPSAwLCBkLmQgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlSG91cjI0KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLkggPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWludXRlcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5NID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuUyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaWxsaXNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMykpOwogIHJldHVybiBuID8gKGQuTCA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaWNyb3NlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgNikpOwogIHJldHVybiBuID8gKGQuTCA9IE1hdGguZmxvb3IoblswXSAvIDFlMyksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUxpdGVyYWxQZXJjZW50KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gcGVyY2VudFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyBpICsgblswXS5sZW5ndGggOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVVuaXhUaW1lc3RhbXAoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgcmV0dXJuIG4gPyAoZC5RID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVVuaXhUaW1lc3RhbXBTZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogIHJldHVybiBuID8gKGQucyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gZm9ybWF0RGF5T2ZNb250aChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldERhdGUoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0SG91cjI0KGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0SG91cjEyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSAlIDEyIHx8IDEyLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXREYXlPZlllYXIoZCwgcCkgewogIHJldHVybiBwYWQoMSArIHRpbWVEYXkuY291bnQodGltZVllYXIoZCksIGQpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRNaWxsaXNlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNaWxsaXNlY29uZHMoKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0TWljcm9zZWNvbmRzKGQsIHApIHsKICByZXR1cm4gZm9ybWF0TWlsbGlzZWNvbmRzKGQsIHApICsgIjAwMCI7Cn0KZnVuY3Rpb24gZm9ybWF0TW9udGhOdW1iZXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNb250aCgpICsgMSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0TWludXRlcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldE1pbnV0ZXMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0U2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFNlY29uZHMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla2RheU51bWJlck1vbmRheShkKSB7CiAgdmFyIGRheSA9IGQuZ2V0RGF5KCk7CiAgcmV0dXJuIGRheSA9PT0gMCA/IDcgOiBkYXk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlclN1bmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh0aW1lU3VuZGF5LmNvdW50KHRpbWVZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGRJU08oZCkgewogIHZhciBkYXkgPSBkLmdldERheSgpOwogIHJldHVybiBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB0aW1lVGh1cnNkYXkoZCkgOiB0aW1lVGh1cnNkYXkuY2VpbChkKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVySVNPKGQsIHApIHsKICBkID0gZElTTyhkKTsKICByZXR1cm4gcGFkKHRpbWVUaHVyc2RheS5jb3VudCh0aW1lWWVhcihkKSwgZCkgKyAodGltZVllYXIoZCkuZ2V0RGF5KCkgPT09IDQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrZGF5TnVtYmVyU3VuZGF5KGQpIHsKICByZXR1cm4gZC5nZXREYXkoKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVyTW9uZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHRpbWVNb25kYXkuY291bnQodGltZVllYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0WWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFllYXJJU08oZCwgcCkgewogIGQgPSBkSVNPKGQpOwogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRGdWxsWWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdEZ1bGxZZWFySVNPKGQsIHApIHsKICB2YXIgZGF5ID0gZC5nZXREYXkoKTsKICBkID0gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdGltZVRodXJzZGF5KGQpIDogdGltZVRodXJzZGF5LmNlaWwoZCk7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdFpvbmUoZCkgewogIHZhciB6ID0gZC5nZXRUaW1lem9uZU9mZnNldCgpOwogIHJldHVybiAoeiA+IDAgPyAiLSIgOiAoeiAqPSAtMSwgIisiKSkgKyBwYWQoeiAvIDYwIHwgMCwgIjAiLCAyKSArIHBhZCh6ICUgNjAsICIwIiwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRGF5T2ZNb250aChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0RhdGUoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDSG91cjI0KGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDSG91cnMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDSG91cjEyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDSG91cnMoKSAlIDEyIHx8IDEyLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENEYXlPZlllYXIoZCwgcCkgewogIHJldHVybiBwYWQoMSArIHV0Y0RheS5jb3VudCh1dGNZZWFyKGQpLCBkKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDTWlsbGlzZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTWlsbGlzZWNvbmRzKCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pY3Jvc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIGZvcm1hdFVUQ01pbGxpc2Vjb25kcyhkLCBwKSArICIwMDAiOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01vbnRoTnVtYmVyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTW9udGgoKSArIDEsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pbnV0ZXMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENNaW51dGVzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1NlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENTZWNvbmRzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJNb25kYXkoZCkgewogIHZhciBkb3cgPSBkLmdldFVUQ0RheSgpOwogIHJldHVybiBkb3cgPT09IDAgPyA3IDogZG93Owp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtOdW1iZXJTdW5kYXkoZCwgcCkgewogIHJldHVybiBwYWQodXRjU3VuZGF5LmNvdW50KHV0Y1llYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gVVRDZElTTyhkKSB7CiAgdmFyIGRheSA9IGQuZ2V0VVRDRGF5KCk7CiAgcmV0dXJuIGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHV0Y1RodXJzZGF5KGQpIDogdXRjVGh1cnNkYXkuY2VpbChkKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVySVNPKGQsIHApIHsKICBkID0gVVRDZElTTyhkKTsKICByZXR1cm4gcGFkKHV0Y1RodXJzZGF5LmNvdW50KHV0Y1llYXIoZCksIGQpICsgKHV0Y1llYXIoZCkuZ2V0VVRDRGF5KCkgPT09IDQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyU3VuZGF5KGQpIHsKICByZXR1cm4gZC5nZXRVVENEYXkoKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVyTW9uZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHV0Y01vbmRheS5jb3VudCh1dGNZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1llYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENZZWFySVNPKGQsIHApIHsKICBkID0gVVRDZElTTyhkKTsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRnVsbFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRVVENGdWxsWWVhcklTTyhkLCBwKSB7CiAgdmFyIGRheSA9IGQuZ2V0VVRDRGF5KCk7CiAgZCA9IGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHV0Y1RodXJzZGF5KGQpIDogdXRjVGh1cnNkYXkuY2VpbChkKTsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDWm9uZSgpIHsKICByZXR1cm4gIiswMDAwIjsKfQpmdW5jdGlvbiBmb3JtYXRMaXRlcmFsUGVyY2VudCgpIHsKICByZXR1cm4gIiUiOwp9CmZ1bmN0aW9uIGZvcm1hdFVuaXhUaW1lc3RhbXAoZCkgewogIHJldHVybiArZDsKfQpmdW5jdGlvbiBmb3JtYXRVbml4VGltZXN0YW1wU2Vjb25kcyhkKSB7CiAgcmV0dXJuIE1hdGguZmxvb3IoK2QgLyAxZTMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS1mb3JtYXQvc3JjL2RlZmF1bHRMb2NhbGUuanMKdmFyIGxvY2FsZTI7CnZhciB0aW1lRm9ybWF0Owp2YXIgdGltZVBhcnNlOwp2YXIgdXRjRm9ybWF0Owp2YXIgdXRjUGFyc2U7CmRlZmF1bHRMb2NhbGUyKHsKICBkYXRlVGltZTogIiV4LCAlWCIsCiAgZGF0ZTogIiUtbS8lLWQvJVkiLAogIHRpbWU6ICIlLUk6JU06JVMgJXAiLAogIHBlcmlvZHM6IFsiQU0iLCAiUE0iXSwKICBkYXlzOiBbIlN1bmRheSIsICJNb25kYXkiLCAiVHVlc2RheSIsICJXZWRuZXNkYXkiLCAiVGh1cnNkYXkiLCAiRnJpZGF5IiwgIlNhdHVyZGF5Il0sCiAgc2hvcnREYXlzOiBbIlN1biIsICJNb24iLCAiVHVlIiwgIldlZCIsICJUaHUiLCAiRnJpIiwgIlNhdCJdLAogIG1vbnRoczogWyJKYW51YXJ5IiwgIkZlYnJ1YXJ5IiwgIk1hcmNoIiwgIkFwcmlsIiwgIk1heSIsICJKdW5lIiwgIkp1bHkiLCAiQXVndXN0IiwgIlNlcHRlbWJlciIsICJPY3RvYmVyIiwgIk5vdmVtYmVyIiwgIkRlY2VtYmVyIl0sCiAgc2hvcnRNb250aHM6IFsiSmFuIiwgIkZlYiIsICJNYXIiLCAiQXByIiwgIk1heSIsICJKdW4iLCAiSnVsIiwgIkF1ZyIsICJTZXAiLCAiT2N0IiwgIk5vdiIsICJEZWMiXQp9KTsKZnVuY3Rpb24gZGVmYXVsdExvY2FsZTIoZGVmaW5pdGlvbikgewogIGxvY2FsZTIgPSBmb3JtYXRMb2NhbGUoZGVmaW5pdGlvbik7CiAgdGltZUZvcm1hdCA9IGxvY2FsZTIuZm9ybWF0OwogIHRpbWVQYXJzZSA9IGxvY2FsZTIucGFyc2U7CiAgdXRjRm9ybWF0ID0gbG9jYWxlMi51dGNGb3JtYXQ7CiAgdXRjUGFyc2UgPSBsb2NhbGUyLnV0Y1BhcnNlOwogIHJldHVybiBsb2NhbGUyOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3RpbWUuanMKZnVuY3Rpb24gZGF0ZSh0KSB7CiAgcmV0dXJuIG5ldyBEYXRlKHQpOwp9CmZ1bmN0aW9uIG51bWJlcjModCkgewogIHJldHVybiB0IGluc3RhbmNlb2YgRGF0ZSA/ICt0IDogKy8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrdCk7Cn0KZnVuY3Rpb24gY2FsZW5kYXIodGlja3MyLCB0aWNrSW50ZXJ2YWwsIHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kMiwgZm9ybWF0MikgewogIHZhciBzY2FsZSA9IGNvbnRpbnVvdXMoKSwgaW52ZXJ0ID0gc2NhbGUuaW52ZXJ0LCBkb21haW4gPSBzY2FsZS5kb21haW47CiAgdmFyIGZvcm1hdE1pbGxpc2Vjb25kID0gZm9ybWF0MigiLiVMIiksIGZvcm1hdFNlY29uZCA9IGZvcm1hdDIoIjolUyIpLCBmb3JtYXRNaW51dGUgPSBmb3JtYXQyKCIlSTolTSIpLCBmb3JtYXRIb3VyID0gZm9ybWF0MigiJUkgJXAiKSwgZm9ybWF0RGF5ID0gZm9ybWF0MigiJWEgJWQiKSwgZm9ybWF0V2VlayA9IGZvcm1hdDIoIiViICVkIiksIGZvcm1hdE1vbnRoID0gZm9ybWF0MigiJUIiKSwgZm9ybWF0WWVhcjIgPSBmb3JtYXQyKCIlWSIpOwogIGZ1bmN0aW9uIHRpY2tGb3JtYXQyKGRhdGUyKSB7CiAgICByZXR1cm4gKHNlY29uZDIoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRNaWxsaXNlY29uZCA6IG1pbnV0ZShkYXRlMikgPCBkYXRlMiA/IGZvcm1hdFNlY29uZCA6IGhvdXIoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRNaW51dGUgOiBkYXkoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRIb3VyIDogbW9udGgoZGF0ZTIpIDwgZGF0ZTIgPyB3ZWVrKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0RGF5IDogZm9ybWF0V2VlayA6IHllYXIoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRNb250aCA6IGZvcm1hdFllYXIyKShkYXRlMik7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkyKSB7CiAgICByZXR1cm4gbmV3IERhdGUoaW52ZXJ0KHkyKSk7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IGRvbWFpbihBcnJheS5mcm9tKF8sIG51bWJlcjMpKSA6IGRvbWFpbigpLm1hcChkYXRlKTsKICB9OwogIHNjYWxlLnRpY2tzID0gZnVuY3Rpb24oaW50ZXJ2YWwpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja3MyKGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgaW50ZXJ2YWwgPT0gbnVsbCA/IDEwIDogaW50ZXJ2YWwpOwogIH07CiAgc2NhbGUudGlja0Zvcm1hdCA9IGZ1bmN0aW9uKGNvdW50LCBzcGVjaWZpZXIpIHsKICAgIHJldHVybiBzcGVjaWZpZXIgPT0gbnVsbCA/IHRpY2tGb3JtYXQyIDogZm9ybWF0MihzcGVjaWZpZXIpOwogIH07CiAgc2NhbGUubmljZSA9IGZ1bmN0aW9uKGludGVydmFsKSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgaWYgKCFpbnRlcnZhbCB8fCB0eXBlb2YgaW50ZXJ2YWwucmFuZ2UgIT09ICJmdW5jdGlvbiIpIGludGVydmFsID0gdGlja0ludGVydmFsKGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgaW50ZXJ2YWwgPT0gbnVsbCA/IDEwIDogaW50ZXJ2YWwpOwogICAgcmV0dXJuIGludGVydmFsID8gZG9tYWluKG5pY2UoZCwgaW50ZXJ2YWwpKSA6IHNjYWxlOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIGNhbGVuZGFyKHRpY2tzMiwgdGlja0ludGVydmFsLCB5ZWFyLCBtb250aCwgd2VlaywgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZDIsIGZvcm1hdDIpKTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiB0aW1lKCkgewogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoY2FsZW5kYXIodGltZVRpY2tzLCB0aW1lVGlja0ludGVydmFsLCB0aW1lWWVhciwgdGltZU1vbnRoLCB0aW1lU3VuZGF5LCB0aW1lRGF5LCB0aW1lSG91ciwgdGltZU1pbnV0ZSwgc2Vjb25kLCB0aW1lRm9ybWF0KS5kb21haW4oW25ldyBEYXRlKDJlMywgMCwgMSksIG5ldyBEYXRlKDJlMywgMCwgMildKSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy91dGNUaW1lLmpzCmZ1bmN0aW9uIHV0Y1RpbWUoKSB7CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShjYWxlbmRhcih1dGNUaWNrcywgdXRjVGlja0ludGVydmFsLCB1dGNZZWFyLCB1dGNNb250aCwgdXRjU3VuZGF5LCB1dGNEYXksIHV0Y0hvdXIsIHV0Y01pbnV0ZSwgc2Vjb25kLCB1dGNGb3JtYXQpLmRvbWFpbihbRGF0ZS5VVEMoMmUzLCAwLCAxKSwgRGF0ZS5VVEMoMmUzLCAwLCAyKV0pLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3NlcXVlbnRpYWwuanMKZnVuY3Rpb24gdHJhbnNmb3JtZXIyKCkgewogIHZhciB4MCA9IDAsIHgxID0gMSwgdDAyLCB0MTIsIGsxMCwgdHJhbnNmb3JtLCBpbnRlcnBvbGF0b3IgPSBpZGVudGl0eSwgY2xhbXAgPSBmYWxzZSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgfHwgaXNOYU4oeDIgPSAreDIpID8gdW5rbm93biA6IGludGVycG9sYXRvcihrMTAgPT09IDAgPyAwLjUgOiAoeDIgPSAodHJhbnNmb3JtKHgyKSAtIHQwMikgKiBrMTAsIGNsYW1wID8gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgeDIpKSA6IHgyKSk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFt4MCwgeDFdID0gXywgdDAyID0gdHJhbnNmb3JtKHgwID0gK3gwKSwgdDEyID0gdHJhbnNmb3JtKHgxID0gK3gxKSwgazEwID0gdDAyID09PSB0MTIgPyAwIDogMSAvICh0MTIgLSB0MDIpLCBzY2FsZSkgOiBbeDAsIHgxXTsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY2xhbXAgPSAhIV8sIHNjYWxlKSA6IGNsYW1wOwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdG9yID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaW50ZXJwb2xhdG9yID0gXywgc2NhbGUpIDogaW50ZXJwb2xhdG9yOwogIH07CiAgZnVuY3Rpb24gcmFuZ2U0KGludGVycG9sYXRlMikgewogICAgcmV0dXJuIGZ1bmN0aW9uKF8pIHsKICAgICAgdmFyIHIwLCByMTsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3IwLCByMV0gPSBfLCBpbnRlcnBvbGF0b3IgPSBpbnRlcnBvbGF0ZTIocjAsIHIxKSwgc2NhbGUpIDogW2ludGVycG9sYXRvcigwKSwgaW50ZXJwb2xhdG9yKDEpXTsKICAgIH07CiAgfQogIHNjYWxlLnJhbmdlID0gcmFuZ2U0KHZhbHVlX2RlZmF1bHQpOwogIHNjYWxlLnJhbmdlUm91bmQgPSByYW5nZTQocm91bmRfZGVmYXVsdCk7CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHRyYW5zZm9ybSA9IHQsIHQwMiA9IHQoeDApLCB0MTIgPSB0KHgxKSwgazEwID0gdDAyID09PSB0MTIgPyAwIDogMSAvICh0MTIgLSB0MDIpOwogICAgcmV0dXJuIHNjYWxlOwogIH07Cn0KZnVuY3Rpb24gY29weTIoc291cmNlLCB0YXJnZXQpIHsKICByZXR1cm4gdGFyZ2V0LmRvbWFpbihzb3VyY2UuZG9tYWluKCkpLmludGVycG9sYXRvcihzb3VyY2UuaW50ZXJwb2xhdG9yKCkpLmNsYW1wKHNvdXJjZS5jbGFtcCgpKS51bmtub3duKHNvdXJjZS51bmtub3duKCkpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWwoKSB7CiAgdmFyIHNjYWxlID0gbGluZWFyaXNoKHRyYW5zZm9ybWVyMigpKGlkZW50aXR5KSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBzZXF1ZW50aWFsKCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbExvZygpIHsKICB2YXIgc2NhbGUgPSBsb2dnaXNoKHRyYW5zZm9ybWVyMigpKS5kb21haW4oWzEsIDEwXSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBzZXF1ZW50aWFsTG9nKCkpLmJhc2Uoc2NhbGUuYmFzZSgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxTeW1sb2coKSB7CiAgdmFyIHNjYWxlID0gc3ltbG9naXNoKHRyYW5zZm9ybWVyMigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIHNlcXVlbnRpYWxTeW1sb2coKSkuY29uc3RhbnQoc2NhbGUuY29uc3RhbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsUG93KCkgewogIHZhciBzY2FsZSA9IHBvd2lzaCh0cmFuc2Zvcm1lcjIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBzZXF1ZW50aWFsUG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbFNxcnQoKSB7CiAgcmV0dXJuIHNlcXVlbnRpYWxQb3cuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5leHBvbmVudCgwLjUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3NlcXVlbnRpYWxRdWFudGlsZS5qcwpmdW5jdGlvbiBzZXF1ZW50aWFsUXVhbnRpbGUoKSB7CiAgdmFyIGRvbWFpbiA9IFtdLCBpbnRlcnBvbGF0b3IgPSBpZGVudGl0eTsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgaWYgKHgyICE9IG51bGwgJiYgIWlzTmFOKHgyID0gK3gyKSkgcmV0dXJuIGludGVycG9sYXRvcigoYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMSkgLSAxKSAvIChkb21haW4ubGVuZ3RoIC0gMSkpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdOwogICAgZm9yIChsZXQgZCBvZiBfKSBpZiAoZCAhPSBudWxsICYmICFpc05hTihkID0gK2QpKSBkb21haW4ucHVzaChkKTsKICAgIGRvbWFpbi5zb3J0KGFzY2VuZGluZyk7CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKICBzY2FsZS5pbnRlcnBvbGF0b3IgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0b3IgPSBfLCBzY2FsZSkgOiBpbnRlcnBvbGF0b3I7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGRvbWFpbi5tYXAoKGQsIGkpID0+IGludGVycG9sYXRvcihpIC8gKGRvbWFpbi5sZW5ndGggLSAxKSkpOwogIH07CiAgc2NhbGUucXVhbnRpbGVzID0gZnVuY3Rpb24obikgewogICAgcmV0dXJuIEFycmF5LmZyb20oeyBsZW5ndGg6IG4gKyAxIH0sIChfLCBpKSA9PiBxdWFudGlsZShkb21haW4sIGkgLyBuKSk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc2VxdWVudGlhbFF1YW50aWxlKGludGVycG9sYXRvcikuZG9tYWluKGRvbWFpbik7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9kaXZlcmdpbmcuanMKZnVuY3Rpb24gdHJhbnNmb3JtZXIzKCkgewogIHZhciB4MCA9IDAsIHgxID0gMC41LCB4MiA9IDEsIHMgPSAxLCB0MDIsIHQxMiwgdDIsIGsxMCwgazIxLCBpbnRlcnBvbGF0b3IgPSBpZGVudGl0eSwgdHJhbnNmb3JtLCBjbGFtcCA9IGZhbHNlLCB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgzKSB7CiAgICByZXR1cm4gaXNOYU4oeDMgPSAreDMpID8gdW5rbm93biA6ICh4MyA9IDAuNSArICgoeDMgPSArdHJhbnNmb3JtKHgzKSkgLSB0MTIpICogKHMgKiB4MyA8IHMgKiB0MTIgPyBrMTAgOiBrMjEpLCBpbnRlcnBvbGF0b3IoY2xhbXAgPyBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB4MykpIDogeDMpKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3gwLCB4MSwgeDJdID0gXywgdDAyID0gdHJhbnNmb3JtKHgwID0gK3gwKSwgdDEyID0gdHJhbnNmb3JtKHgxID0gK3gxKSwgdDIgPSB0cmFuc2Zvcm0oeDIgPSAreDIpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAwLjUgLyAodDEyIC0gdDAyKSwgazIxID0gdDEyID09PSB0MiA/IDAgOiAwLjUgLyAodDIgLSB0MTIpLCBzID0gdDEyIDwgdDAyID8gLTEgOiAxLCBzY2FsZSkgOiBbeDAsIHgxLCB4Ml07CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gISFfLCBzY2FsZSkgOiBjbGFtcDsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIGZ1bmN0aW9uIHJhbmdlNChpbnRlcnBvbGF0ZTIpIHsKICAgIHJldHVybiBmdW5jdGlvbihfKSB7CiAgICAgIHZhciByMCwgcjEsIHIyOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbcjAsIHIxLCByMl0gPSBfLCBpbnRlcnBvbGF0b3IgPSBwaWVjZXdpc2UoaW50ZXJwb2xhdGUyLCBbcjAsIHIxLCByMl0pLCBzY2FsZSkgOiBbaW50ZXJwb2xhdG9yKDApLCBpbnRlcnBvbGF0b3IoMC41KSwgaW50ZXJwb2xhdG9yKDEpXTsKICAgIH07CiAgfQogIHNjYWxlLnJhbmdlID0gcmFuZ2U0KHZhbHVlX2RlZmF1bHQpOwogIHNjYWxlLnJhbmdlUm91bmQgPSByYW5nZTQocm91bmRfZGVmYXVsdCk7CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHRyYW5zZm9ybSA9IHQsIHQwMiA9IHQoeDApLCB0MTIgPSB0KHgxKSwgdDIgPSB0KHgyKSwgazEwID0gdDAyID09PSB0MTIgPyAwIDogMC41IC8gKHQxMiAtIHQwMiksIGsyMSA9IHQxMiA9PT0gdDIgPyAwIDogMC41IC8gKHQyIC0gdDEyKSwgcyA9IHQxMiA8IHQwMiA/IC0xIDogMTsKICAgIHJldHVybiBzY2FsZTsKICB9Owp9CmZ1bmN0aW9uIGRpdmVyZ2luZygpIHsKICB2YXIgc2NhbGUgPSBsaW5lYXJpc2godHJhbnNmb3JtZXIzKCkoaWRlbnRpdHkpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZygpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ0xvZygpIHsKICB2YXIgc2NhbGUgPSBsb2dnaXNoKHRyYW5zZm9ybWVyMygpKS5kb21haW4oWzAuMSwgMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ0xvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdTeW1sb2coKSB7CiAgdmFyIHNjYWxlID0gc3ltbG9naXNoKHRyYW5zZm9ybWVyMygpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ1N5bWxvZygpKS5jb25zdGFudChzY2FsZS5jb25zdGFudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ1BvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIzKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgZGl2ZXJnaW5nUG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nU3FydCgpIHsKICByZXR1cm4gZGl2ZXJnaW5nUG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvZGF0YVNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMgPSAoc3RhdGUpID0+IHN0YXRlLmNoYXJ0RGF0YTsKdmFyIHNlbGVjdENoYXJ0RGF0YUFuZEFsd2F5c0lnbm9yZUluZGV4ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNdLCAoZGF0YVN0YXRlKSA9PiB7CiAgdmFyIGRhdGFFbmRJbmRleCA9IGRhdGFTdGF0ZS5jaGFydERhdGEgIT0gbnVsbCA/IGRhdGFTdGF0ZS5jaGFydERhdGEubGVuZ3RoIC0gMSA6IDA7CiAgcmV0dXJuIHsKICAgIGNoYXJ0RGF0YTogZGF0YVN0YXRlLmNoYXJ0RGF0YSwKICAgIGNvbXB1dGVkRGF0YTogZGF0YVN0YXRlLmNvbXB1dGVkRGF0YSwKICAgIGRhdGFFbmRJbmRleCwKICAgIGRhdGFTdGFydEluZGV4OiAwCiAgfTsKfSk7CnZhciBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc0lmTm90SW5QYW5vcmFtYSA9IChzdGF0ZSwgX3VudXNlZDEsIF91bnVzZWQyLCBpc1Bhbm9yYW1hKSA9PiB7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBzZWxlY3RDaGFydERhdGFBbmRBbHdheXNJZ25vcmVJbmRleGVzKHN0YXRlKTsKICB9CiAgcmV0dXJuIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzKHN0YXRlKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9pc0RvbWFpblNwZWNpZmllZEJ5VXNlci5qcwpmdW5jdGlvbiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4odikgewogIGlmIChBcnJheS5pc0FycmF5KHYpICYmIHYubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW21pbjIsIG1heDJdID0gdjsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKG1pbjIpICYmIGlzV2VsbEJlaGF2ZWROdW1iZXIobWF4MikpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBleHRlbmREb21haW4ocHJvdmlkZWREb21haW4sIGJvdW5kYXJ5RG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdykgewogIGlmIChhbGxvd0RhdGFPdmVyZmxvdykgewogICAgcmV0dXJuIHByb3ZpZGVkRG9tYWluOwogIH0KICByZXR1cm4gW01hdGgubWluKHByb3ZpZGVkRG9tYWluWzBdLCBib3VuZGFyeURvbWFpblswXSksIE1hdGgubWF4KHByb3ZpZGVkRG9tYWluWzFdLCBib3VuZGFyeURvbWFpblsxXSldOwp9CmZ1bmN0aW9uIG51bWVyaWNhbERvbWFpblNwZWNpZmllZFdpdGhvdXRSZXF1aXJpbmdEYXRhKHVzZXJEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KSB7CiAgaWYgKCFhbGxvd0RhdGFPdmVyZmxvdykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiB1c2VyRG9tYWluID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyRG9tYWluKSAmJiB1c2VyRG9tYWluLmxlbmd0aCA9PT0gMikgewogICAgdmFyIFtwcm92aWRlZE1pbiwgcHJvdmlkZWRNYXhdID0gdXNlckRvbWFpbjsKICAgIHZhciBmaW5hbE1pbiwgZmluYWxNYXg7CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihwcm92aWRlZE1pbikpIHsKICAgICAgZmluYWxNaW4gPSBwcm92aWRlZE1pbjsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWluID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihwcm92aWRlZE1heCkpIHsKICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB2YXIgY2FuZGlkYXRlID0gW2ZpbmFsTWluLCBmaW5hbE1heF07CiAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGNhbmRpZGF0ZSkpIHsKICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgIH0KICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBwYXJzZU51bWVyaWNhbFVzZXJEb21haW4odXNlckRvbWFpbiwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICBpZiAoIWFsbG93RGF0YU92ZXJmbG93ICYmIGRhdGFEb21haW4gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiB1c2VyRG9tYWluID09PSAiZnVuY3Rpb24iICYmIGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgdHJ5IHsKICAgICAgdmFyIHJlc3VsdCA9IHVzZXJEb21haW4oZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKHJlc3VsdCkpIHsKICAgICAgICByZXR1cm4gZXh0ZW5kRG9tYWluKHJlc3VsdCwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgICB9CiAgICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICB9CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHVzZXJEb21haW4pICYmIHVzZXJEb21haW4ubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW3Byb3ZpZGVkTWluLCBwcm92aWRlZE1heF0gPSB1c2VyRG9tYWluOwogICAgdmFyIGZpbmFsTWluLCBmaW5hbE1heDsKICAgIGlmIChwcm92aWRlZE1pbiA9PT0gImF1dG8iKSB7CiAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICBmaW5hbE1pbiA9IE1hdGgubWluKC4uLmRhdGFEb21haW4pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKHByb3ZpZGVkTWluKSkgewogICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNaW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdHJ5IHsKICAgICAgICBpZiAoZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluKGRhdGFEb21haW4gPT09IG51bGwgfHwgZGF0YURvbWFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YURvbWFpblswXSk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChfdW51c2VkMikgewogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1pbiA9PT0gInN0cmluZyIgJiYgTUlOX1ZBTFVFX1JFRy50ZXN0KHByb3ZpZGVkTWluKSkgewogICAgICB2YXIgbWF0Y2ggPSBNSU5fVkFMVUVfUkVHLmV4ZWMocHJvdmlkZWRNaW4pOwogICAgICBpZiAobWF0Y2ggPT0gbnVsbCB8fCBkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICBmaW5hbE1pbiA9IHZvaWQgMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdmFsdWUgPSArbWF0Y2hbMV07CiAgICAgICAgZmluYWxNaW4gPSBkYXRhRG9tYWluWzBdIC0gdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZpbmFsTWluID0gZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzBdOwogICAgfQogICAgaWYgKHByb3ZpZGVkTWF4ID09PSAiYXV0byIpIHsKICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgIGZpbmFsTWF4ID0gTWF0aC5tYXgoLi4uZGF0YURvbWFpbik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIocHJvdmlkZWRNYXgpKSB7CiAgICAgIGZpbmFsTWF4ID0gcHJvdmlkZWRNYXg7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1heCA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cnkgewogICAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICAgIGZpbmFsTWF4ID0gcHJvdmlkZWRNYXgoZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzFdKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKF91bnVzZWQzKSB7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAic3RyaW5nIiAmJiBNQVhfVkFMVUVfUkVHLnRlc3QocHJvdmlkZWRNYXgpKSB7CiAgICAgIHZhciBfbWF0Y2ggPSBNQVhfVkFMVUVfUkVHLmV4ZWMocHJvdmlkZWRNYXgpOwogICAgICBpZiAoX21hdGNoID09IG51bGwgfHwgZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICAgICAgZmluYWxNYXggPSB2b2lkIDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF92YWx1ZSA9ICtfbWF0Y2hbMV07CiAgICAgICAgZmluYWxNYXggPSBkYXRhRG9tYWluWzFdICsgX3ZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmaW5hbE1heCA9IGRhdGFEb21haW4gPT09IG51bGwgfHwgZGF0YURvbWFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YURvbWFpblsxXTsKICAgIH0KICAgIHZhciBjYW5kaWRhdGUgPSBbZmluYWxNaW4sIGZpbmFsTWF4XTsKICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oY2FuZGlkYXRlKSkgewogICAgICBpZiAoZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gZXh0ZW5kRG9tYWluKGNhbmRpZGF0ZSwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgfQogIH0KICByZXR1cm4gdm9pZCAwOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvZ2V0TmljZVRpY2tWYWx1ZXMuanMKdmFyIGltcG9ydF9kZWNpbWFsMiA9IF9fdG9FU00ocmVxdWlyZV9kZWNpbWFsKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3NjYWxlL3V0aWwvdXRpbHMuanMKdmFyIGlkZW50aXR5MyA9IChpKSA9PiBpOwp2YXIgUExBQ0VfSE9MREVSID0gewogICJAQGZ1bmN0aW9uYWwvcGxhY2Vob2xkZXIiOiB0cnVlCn07CnZhciBpc1BsYWNlSG9sZGVyID0gKHZhbCkgPT4gdmFsID09PSBQTEFDRV9IT0xERVI7CnZhciBjdXJyeTAgPSAoZm4pID0+IGZ1bmN0aW9uIF9jdXJyaWVkKCkgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwIHx8IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgaXNQbGFjZUhvbGRlcihhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB2b2lkIDAgOiBhcmd1bWVudHNbMF0pKSB7CiAgICByZXR1cm4gX2N1cnJpZWQ7CiAgfQogIHJldHVybiBmbiguLi5hcmd1bWVudHMpOwp9Owp2YXIgY3VycnlOID0gKG4sIGZuKSA9PiB7CiAgaWYgKG4gPT09IDEpIHsKICAgIHJldHVybiBmbjsKICB9CiAgcmV0dXJuIGN1cnJ5MChmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgfQogICAgdmFyIGFyZ3NMZW5ndGggPSBhcmdzLmZpbHRlcigoYXJnKSA9PiBhcmcgIT09IFBMQUNFX0hPTERFUikubGVuZ3RoOwogICAgaWYgKGFyZ3NMZW5ndGggPj0gbikgewogICAgICByZXR1cm4gZm4oLi4uYXJncyk7CiAgICB9CiAgICByZXR1cm4gY3VycnlOKG4gLSBhcmdzTGVuZ3RoLCBjdXJyeTAoZnVuY3Rpb24oKSB7CiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgcmVzdEFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIpLCBfa2V5MiA9IDA7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICByZXN0QXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CiAgICAgIHZhciBuZXdBcmdzID0gYXJncy5tYXAoKGFyZykgPT4gaXNQbGFjZUhvbGRlcihhcmcpID8gcmVzdEFyZ3Muc2hpZnQoKSA6IGFyZyk7CiAgICAgIHJldHVybiBmbiguLi5uZXdBcmdzLCAuLi5yZXN0QXJncyk7CiAgICB9KSk7CiAgfSk7Cn07CnZhciBjdXJyeSA9IChmbikgPT4gY3VycnlOKGZuLmxlbmd0aCwgZm4pOwp2YXIgcmFuZ2UyID0gKGJlZ2luLCBlbmQpID0+IHsKICB2YXIgYXJyID0gW107CiAgZm9yICh2YXIgaSA9IGJlZ2luOyBpIDwgZW5kOyArK2kpIHsKICAgIGFycltpIC0gYmVnaW5dID0gaTsKICB9CiAgcmV0dXJuIGFycjsKfTsKdmFyIG1hcDIgPSBjdXJyeSgoZm4sIGFycikgPT4gewogIGlmIChBcnJheS5pc0FycmF5KGFycikpIHsKICAgIHJldHVybiBhcnIubWFwKGZuKTsKICB9CiAgcmV0dXJuIE9iamVjdC5rZXlzKGFycikubWFwKChrZXkpID0+IGFycltrZXldKS5tYXAoZm4pOwp9KTsKdmFyIGNvbXBvc2UyID0gZnVuY3Rpb24gY29tcG9zZTMoKSB7CiAgZm9yICh2YXIgX2xlbjMgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4zKSwgX2tleTMgPSAwOyBfa2V5MyA8IF9sZW4zOyBfa2V5MysrKSB7CiAgICBhcmdzW19rZXkzXSA9IGFyZ3VtZW50c1tfa2V5M107CiAgfQogIGlmICghYXJncy5sZW5ndGgpIHsKICAgIHJldHVybiBpZGVudGl0eTM7CiAgfQogIHZhciBmbnMgPSBhcmdzLnJldmVyc2UoKTsKICB2YXIgZmlyc3RGbiA9IGZuc1swXTsKICB2YXIgdGFpbHNGbiA9IGZucy5zbGljZSgxKTsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGFpbHNGbi5yZWR1Y2UoKHJlcywgZm4pID0+IGZuKHJlcyksIGZpcnN0Rm4oLi4uYXJndW1lbnRzKSk7CiAgfTsKfTsKdmFyIHJldmVyc2UgPSAoYXJyKSA9PiB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgcmV0dXJuIGFyci5yZXZlcnNlKCk7CiAgfQogIHJldHVybiBhcnIuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS91dGlsL2FyaXRobWV0aWMuanMKdmFyIGltcG9ydF9kZWNpbWFsID0gX190b0VTTShyZXF1aXJlX2RlY2ltYWwoKSk7CmZ1bmN0aW9uIGdldERpZ2l0Q291bnQodmFsdWUpIHsKICB2YXIgcmVzdWx0OwogIGlmICh2YWx1ZSA9PT0gMCkgewogICAgcmVzdWx0ID0gMTsKICB9IGVsc2UgewogICAgcmVzdWx0ID0gTWF0aC5mbG9vcihuZXcgaW1wb3J0X2RlY2ltYWwuZGVmYXVsdCh2YWx1ZSkuYWJzKCkubG9nKDEwKS50b051bWJlcigpKSArIDE7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gcmFuZ2VTdGVwKHN0YXJ0LCBlbmQsIHN0ZXApIHsKICB2YXIgbnVtID0gbmV3IGltcG9ydF9kZWNpbWFsLmRlZmF1bHQoc3RhcnQpOwogIHZhciBpID0gMDsKICB2YXIgcmVzdWx0ID0gW107CiAgd2hpbGUgKG51bS5sdChlbmQpICYmIGkgPCAxZTUpIHsKICAgIHJlc3VsdC5wdXNoKG51bS50b051bWJlcigpKTsKICAgIG51bSA9IG51bS5hZGQoc3RlcCk7CiAgICBpKys7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS9nZXROaWNlVGlja1ZhbHVlcy5qcwp2YXIgZ2V0VmFsaWRJbnRlcnZhbCA9IChfcmVmMikgPT4gewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMjsKICB2YXIgW3ZhbGlkTWluLCB2YWxpZE1heF0gPSBbbWluMiwgbWF4Ml07CiAgaWYgKG1pbjIgPiBtYXgyKSB7CiAgICBbdmFsaWRNaW4sIHZhbGlkTWF4XSA9IFttYXgyLCBtaW4yXTsKICB9CiAgcmV0dXJuIFt2YWxpZE1pbiwgdmFsaWRNYXhdOwp9Owp2YXIgZ2V0Rm9ybWF0U3RlcCA9IChyb3VnaFN0ZXAsIGFsbG93RGVjaW1hbHMsIGNvcnJlY3Rpb25GYWN0b3IpID0+IHsKICBpZiAocm91Z2hTdGVwLmx0ZSgwKSkgewogICAgcmV0dXJuIG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKTsKICB9CiAgdmFyIGRpZ2l0Q291bnQgPSBnZXREaWdpdENvdW50KHJvdWdoU3RlcC50b051bWJlcigpKTsKICB2YXIgZGlnaXRDb3VudFZhbHVlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEwKS5wb3coZGlnaXRDb3VudCk7CiAgdmFyIHN0ZXBSYXRpbyA9IHJvdWdoU3RlcC5kaXYoZGlnaXRDb3VudFZhbHVlKTsKICB2YXIgc3RlcFJhdGlvU2NhbGUgPSBkaWdpdENvdW50ICE9PSAxID8gMC4wNSA6IDAuMTsKICB2YXIgYW1lbmRTdGVwUmF0aW8gPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5jZWlsKHN0ZXBSYXRpby5kaXYoc3RlcFJhdGlvU2NhbGUpLnRvTnVtYmVyKCkpKS5hZGQoY29ycmVjdGlvbkZhY3RvcikubXVsKHN0ZXBSYXRpb1NjYWxlKTsKICB2YXIgZm9ybWF0U3RlcCA9IGFtZW5kU3RlcFJhdGlvLm11bChkaWdpdENvdW50VmFsdWUpOwogIHJldHVybiBhbGxvd0RlY2ltYWxzID8gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGZvcm1hdFN0ZXAudG9OdW1iZXIoKSkgOiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5jZWlsKGZvcm1hdFN0ZXAudG9OdW1iZXIoKSkpOwp9Owp2YXIgZ2V0VGlja09mU2luZ2xlVmFsdWUgPSAodmFsdWUsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscykgPT4gewogIHZhciBzdGVwID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEpOwogIHZhciBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQodmFsdWUpOwogIGlmICghbWlkZGxlLmlzaW50KCkgJiYgYWxsb3dEZWNpbWFscykgewogICAgdmFyIGFic1ZhbCA9IE1hdGguYWJzKHZhbHVlKTsKICAgIGlmIChhYnNWYWwgPCAxKSB7CiAgICAgIHN0ZXAgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMTApLnBvdyhnZXREaWdpdENvdW50KHZhbHVlKSAtIDEpOwogICAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcihtaWRkbGUuZGl2KHN0ZXApLnRvTnVtYmVyKCkpKS5tdWwoc3RlcCk7CiAgICB9IGVsc2UgaWYgKGFic1ZhbCA+IDEpIHsKICAgICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IodmFsdWUpKTsKICAgIH0KICB9IGVsc2UgaWYgKHZhbHVlID09PSAwKSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcigodGlja0NvdW50IC0gMSkgLyAyKSk7CiAgfSBlbHNlIGlmICghYWxsb3dEZWNpbWFscykgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IodmFsdWUpKTsKICB9CiAgdmFyIG1pZGRsZUluZGV4ID0gTWF0aC5mbG9vcigodGlja0NvdW50IC0gMSkgLyAyKTsKICB2YXIgZm4gPSBjb21wb3NlMihtYXAyKChuKSA9PiBtaWRkbGUuYWRkKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChuIC0gbWlkZGxlSW5kZXgpLm11bChzdGVwKSkudG9OdW1iZXIoKSksIHJhbmdlMik7CiAgcmV0dXJuIGZuKDAsIHRpY2tDb3VudCk7Cn07CnZhciBfY2FsY3VsYXRlU3RlcCA9IGZ1bmN0aW9uIGNhbGN1bGF0ZVN0ZXAobWluMiwgbWF4MiwgdGlja0NvdW50LCBhbGxvd0RlY2ltYWxzKSB7CiAgdmFyIGNvcnJlY3Rpb25GYWN0b3IgPSBhcmd1bWVudHMubGVuZ3RoID4gNCAmJiBhcmd1bWVudHNbNF0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1s0XSA6IDA7CiAgaWYgKCFOdW1iZXIuaXNGaW5pdGUoKG1heDIgLSBtaW4yKSAvICh0aWNrQ291bnQgLSAxKSkpIHsKICAgIHJldHVybiB7CiAgICAgIHN0ZXA6IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKSwKICAgICAgdGlja01pbjogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApLAogICAgICB0aWNrTWF4OiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCkKICAgIH07CiAgfQogIHZhciBzdGVwID0gZ2V0Rm9ybWF0U3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWF4Mikuc3ViKG1pbjIpLmRpdih0aWNrQ291bnQgLSAxKSwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3Rvcik7CiAgdmFyIG1pZGRsZTsKICBpZiAobWluMiA8PSAwICYmIG1heDIgPj0gMCkgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApOwogIH0gZWxzZSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWluMikuYWRkKG1heDIpLmRpdigyKTsKICAgIG1pZGRsZSA9IG1pZGRsZS5zdWIobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1pZGRsZSkubW9kKHN0ZXApKTsKICB9CiAgdmFyIGJlbG93Q291bnQgPSBNYXRoLmNlaWwobWlkZGxlLnN1YihtaW4yKS5kaXYoc3RlcCkudG9OdW1iZXIoKSk7CiAgdmFyIHVwQ291bnQgPSBNYXRoLmNlaWwobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1heDIpLnN1YihtaWRkbGUpLmRpdihzdGVwKS50b051bWJlcigpKTsKICB2YXIgc2NhbGVDb3VudCA9IGJlbG93Q291bnQgKyB1cENvdW50ICsgMTsKICBpZiAoc2NhbGVDb3VudCA+IHRpY2tDb3VudCkgewogICAgcmV0dXJuIF9jYWxjdWxhdGVTdGVwKG1pbjIsIG1heDIsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3RvciArIDEpOwogIH0KICBpZiAoc2NhbGVDb3VudCA8IHRpY2tDb3VudCkgewogICAgdXBDb3VudCA9IG1heDIgPiAwID8gdXBDb3VudCArICh0aWNrQ291bnQgLSBzY2FsZUNvdW50KSA6IHVwQ291bnQ7CiAgICBiZWxvd0NvdW50ID0gbWF4MiA+IDAgPyBiZWxvd0NvdW50IDogYmVsb3dDb3VudCArICh0aWNrQ291bnQgLSBzY2FsZUNvdW50KTsKICB9CiAgcmV0dXJuIHsKICAgIHN0ZXAsCiAgICB0aWNrTWluOiBtaWRkbGUuc3ViKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChiZWxvd0NvdW50KS5tdWwoc3RlcCkpLAogICAgdGlja01heDogbWlkZGxlLmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQodXBDb3VudCkubXVsKHN0ZXApKQogIH07Cn07CnZhciBnZXROaWNlVGlja1ZhbHVlcyA9IGZ1bmN0aW9uIGdldE5pY2VUaWNrVmFsdWVzMihfcmVmMikgewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMjsKICB2YXIgdGlja0NvdW50ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiA2OwogIHZhciBhbGxvd0RlY2ltYWxzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB0cnVlOwogIHZhciBjb3VudCA9IE1hdGgubWF4KHRpY2tDb3VudCwgMik7CiAgdmFyIFtjb3JtaW4sIGNvcm1heF0gPSBnZXRWYWxpZEludGVydmFsKFttaW4yLCBtYXgyXSk7CiAgaWYgKGNvcm1pbiA9PT0gLUluZmluaXR5IHx8IGNvcm1heCA9PT0gSW5maW5pdHkpIHsKICAgIHZhciBfdmFsdWVzID0gY29ybWF4ID09PSBJbmZpbml0eSA/IFtjb3JtaW4sIC4uLnJhbmdlMigwLCB0aWNrQ291bnQgLSAxKS5tYXAoKCkgPT4gSW5maW5pdHkpXSA6IFsuLi5yYW5nZTIoMCwgdGlja0NvdW50IC0gMSkubWFwKCgpID0+IC1JbmZpbml0eSksIGNvcm1heF07CiAgICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKF92YWx1ZXMpIDogX3ZhbHVlczsKICB9CiAgaWYgKGNvcm1pbiA9PT0gY29ybWF4KSB7CiAgICByZXR1cm4gZ2V0VGlja09mU2luZ2xlVmFsdWUoY29ybWluLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMpOwogIH0KICB2YXIgewogICAgc3RlcCwKICAgIHRpY2tNaW4sCiAgICB0aWNrTWF4CiAgfSA9IF9jYWxjdWxhdGVTdGVwKGNvcm1pbiwgY29ybWF4LCBjb3VudCwgYWxsb3dEZWNpbWFscywgMCk7CiAgdmFyIHZhbHVlcyA9IHJhbmdlU3RlcCh0aWNrTWluLCB0aWNrTWF4LmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMC4xKS5tdWwoc3RlcCkpLCBzdGVwKTsKICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKHZhbHVlcykgOiB2YWx1ZXM7Cn07CnZhciBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4gPSBmdW5jdGlvbiBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4yKF9yZWYzLCB0aWNrQ291bnQpIHsKICB2YXIgW21pbjIsIG1heDJdID0gX3JlZjM7CiAgdmFyIGFsbG93RGVjaW1hbHMgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IHRydWU7CiAgdmFyIFtjb3JtaW4sIGNvcm1heF0gPSBnZXRWYWxpZEludGVydmFsKFttaW4yLCBtYXgyXSk7CiAgaWYgKGNvcm1pbiA9PT0gLUluZmluaXR5IHx8IGNvcm1heCA9PT0gSW5maW5pdHkpIHsKICAgIHJldHVybiBbbWluMiwgbWF4Ml07CiAgfQogIGlmIChjb3JtaW4gPT09IGNvcm1heCkgewogICAgcmV0dXJuIFtjb3JtaW5dOwogIH0KICB2YXIgY291bnQgPSBNYXRoLm1heCh0aWNrQ291bnQsIDIpOwogIHZhciBzdGVwID0gZ2V0Rm9ybWF0U3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoY29ybWF4KS5zdWIoY29ybWluKS5kaXYoY291bnQgLSAxKSwgYWxsb3dEZWNpbWFscywgMCk7CiAgdmFyIHZhbHVlcyA9IFsuLi5yYW5nZVN0ZXAobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGNvcm1pbiksIG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChjb3JtYXgpLCBzdGVwKSwgY29ybWF4XTsKICBpZiAoYWxsb3dEZWNpbWFscyA9PT0gZmFsc2UpIHsKICAgIHZhbHVlcyA9IHZhbHVlcy5tYXAoKHZhbHVlKSA9PiBNYXRoLnJvdW5kKHZhbHVlKSk7CiAgfQogIHJldHVybiBtaW4yID4gbWF4MiA/IHJldmVyc2UodmFsdWVzKSA6IHZhbHVlczsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3Jvb3RQcm9wc1NlbGVjdG9ycy5qcwp2YXIgc2VsZWN0QmFyQ2F0ZWdvcnlHYXAgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5iYXJDYXRlZ29yeUdhcDsKdmFyIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnN0YWNrT2Zmc2V0Owp2YXIgc2VsZWN0UmV2ZXJzZVN0YWNrT3JkZXIgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5yZXZlcnNlU3RhY2tPcmRlcjsKdmFyIHNlbGVjdENoYXJ0TmFtZSA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy5jaGFydE5hbWU7CnZhciBzZWxlY3RTeW5jSWQgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5zeW5jSWQ7CnZhciBzZWxlY3RTeW5jTWV0aG9kID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuc3luY01ldGhvZDsKdmFyIHNlbGVjdEV2ZW50RW1pdHRlciA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy5ldmVudEVtaXR0ZXI7CnZhciBzZWxlY3RDaGFydEJhc2VWYWx1ZSA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLmJhc2VWYWx1ZTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L0RlZmF1bHRaSW5kZXhlcy5qcwp2YXIgRGVmYXVsdFpJbmRleGVzID0gewogIC8qKgogICAqIENhcnRlc2lhbkdyaWQgYW5kIFBvbGFyR3JpZAogICAqLwogIGdyaWQ6IC0xMDAsCiAgLyoqCiAgICogQmFja2dyb3VuZCBvZiBCYXIgYW5kIFJhZGlhbEJhci4KICAgKiBUaGlzIGlzIG5vdCB2aXNpYmxlIGJ5IGRlZmF1bHQgYnV0IGNhbiBiZSBlbmFibGVkIGJ5IHNldHRpbmcgYmFja2dyb3VuZD17dHJ1ZX0gb24gQmFyIG9yIFJhZGlhbEJhci4KICAgKi8KICBiYXJCYWNrZ3JvdW5kOiAtNTAsCiAgLyoKICAgKiBvdGhlciBjaGFydCBlbGVtZW50cyBvciBjdXN0b20gZWxlbWVudHMgd2l0aG91dCBzcGVjaWZpYyB6SW5kZXgKICAgKiByZW5kZXIgaW4gaGVyZSwgYXQgekluZGV4IDAKICAgKi8KICAvKioKICAgKiBBcmVhLCBQaWUsIFJhZGFyLCBhbmQgUmVmZXJlbmNlQXJlYQogICAqLwogIGFyZWE6IDEwMCwKICAvKioKICAgKiBDdXJzb3IgaXMgZW1iZWRkZWQgaW5zaWRlIFRvb2x0aXAgYW5kIGNvbnRyb2xsZWQgYnkgaXQuCiAgICogVGhlIFRvb2x0aXAgaXRzZWxmIGhhcyBhIHNlcGFyYXRlIHBvcnRhbCBhbmQgaXMgbm90IGluY2x1ZGVkIGluIHRoZSB6SW5kZXggc3lzdGVtOwogICAqIEN1cnNvciBpcyB0aGUgZGVjb3JhdGlvbiBpbnNpZGUgdGhlIGNoYXJ0IGFyZWEuIEN1cnNvclJlY3RhbmdsZSBpcyBhIHJlY3RhbmdsZSBib3guCiAgICogSXQgcmVuZGVycyBiZWxvdyBiYXIgc28gdGhhdCBpbiBhIHN0YWNrZWQgYmFyIGNoYXJ0IHRoZSBjdXJzb3IgcmVjdGFuZ2xlIGRvZXMgbm90IGhpZGUgdGhlIG90aGVyIGJhcnMuCiAgICovCiAgY3Vyc29yUmVjdGFuZ2xlOiAyMDAsCiAgLyoqCiAgICogQmFyIGFuZCBSYWRpYWxCYXIKICAgKi8KICBiYXI6IDMwMCwKICAvKioKICAgKiBMaW5lIGFuZCBSZWZlcmVuY2VMaW5lLCBhbmQgRXJyb3JCb3IKICAgKi8KICBsaW5lOiA0MDAsCiAgLyoqCiAgICogWEF4aXMgYW5kIFlBeGlzIGFuZCBQb2xhckFuZ2xlQXhpcyBhbmQgUG9sYXJSYWRpdXNBeGlzIHRpY2tzIGFuZCBsaW5lcyBhbmQgY2hpbGRyZW4KICAgKi8KICBheGlzOiA1MDAsCiAgLyoqCiAgICogU2NhdHRlciBhbmQgUmVmZXJlbmNlRG90LAogICAqIGFuZCBEb3RzIG9mIExpbmUgYW5kIEFyZWEgYW5kIFJhZGFyIGlmIHRoZXkgaGF2ZSBkb3Q9dHJ1ZQogICAqLwogIHNjYXR0ZXI6IDYwMCwKICAvKioKICAgKiBIb3ZlcmluZyBvdmVyIGEgQmFyIG9yIFJhZGlhbEJhciByZW5kZXJzIGEgaGlnaGxpZ2h0IHJlY3RhbmdsZQogICAqLwogIGFjdGl2ZUJhcjogMWUzLAogIC8qKgogICAqIEN1cnNvciBpcyBlbWJlZGRlZCBpbnNpZGUgVG9vbHRpcCBhbmQgY29udHJvbGxlZCBieSBpdC4KICAgKiBUaGUgVG9vbHRpcCBpdHNlbGYgaGFzIGEgc2VwYXJhdGUgcG9ydGFsIGFuZCBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHpJbmRleCBzeXN0ZW07CiAgICogQ3Vyc29yIGlzIHRoZSBkZWNvcmF0aW9uIGluc2lkZSB0aGUgY2hhcnQgYXJlYSwgdXN1YWxseSBhIGNyb3NzIG9yIGEgYm94LgogICAqIEN1cnNvckxpbmUgaXMgYSBsaW5lIGN1cnNvciByZW5kZXJlZCBpbiBMaW5lLCBBcmVhLCBTY2F0dGVyLCBSYWRhciBjaGFydHMuCiAgICogSXQgcmVuZGVycyBhYm92ZSB0aGUgTGluZSBhbmQgU2NhdHRlciBzbyB0aGF0IGl0IGlzIGFsd2F5cyB2aXNpYmxlLgogICAqIEl0IHJlbmRlcnMgYmVsb3cgYWN0aXZlIGRvdCBzbyB0aGF0IHRoZSBkb3QgaXMgYWx3YXlzIHZpc2libGUgYW5kIHNob3dzIHRoZSBjdXJyZW50IHBvaW50LgogICAqIFdlJ3JlIGFsc28gYXNzdW1pbmcgdGhhdCB0aGUgYWN0aXZlIGRvdCBpcyBzbWFsbCBlbm91Z2ggdGhhdCBpdCBkb2VzIG5vdCBmdWxseSBjb3ZlciB0aGUgY3Vyc29yIGxpbmUuCiAgICoKICAgKiBUaGlzIGFsc28gYXBwbGllcyB0byB0aGUgcmFkaWFsIGN1cnNvciBpbiBSYWRpYWxCYXJDaGFydC4KICAgKi8KICBjdXJzb3JMaW5lOiAxMTAwLAogIC8qKgogICAqIEhvdmVyaW5nIG92ZXIgYSBQb2ludCBpbiBMaW5lLCBBcmVhLCBTY2F0dGVyLCBSYWRhciByZW5kZXJzIGEgaGlnaGxpZ2h0IGRvdAogICAqLwogIGFjdGl2ZURvdDogMTIwMCwKICAvKioKICAgKiBMYWJlbExpc3QgYW5kIExhYmVsLCBpbmNsdWRpbmcgQXhpcyBsYWJlbHMKICAgKi8KICBsYWJlbDogMmUzCn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL2RlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmpzCnZhciBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcyA9IHsKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICAvLyBpZiBJIHNldCB0aGlzIHRvIGZhbHNlIHRoZW4gVG9vbHRpcCBzeW5jaHJvbmlzYXRpb24gc3RvcHMgd29ya2luZyBpbiBSYWRhciwgd3RmCiAgYW5nbGVBeGlzSWQ6IDAsCiAgYXhpc0xpbmU6IHRydWUsCiAgYXhpc0xpbmVUeXBlOiAicG9seWdvbiIsCiAgY3g6IDAsCiAgY3k6IDAsCiAgb3JpZW50YXRpb246ICJvdXRlciIsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrTGluZTogdHJ1ZSwKICB0aWNrU2l6ZTogOCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmF4aXMKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvcG9sYXIvZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmpzCnZhciBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiB0cnVlLAogIGFuZ2xlOiAwLAogIGF4aXNMaW5lOiB0cnVlLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIGxhYmVsOiBmYWxzZSwKICBvcmllbnRhdGlvbjogInJpZ2h0IiwKICByYWRpdXNBeGlzSWQ6IDAsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgc3Ryb2tlOiAiI2NjYyIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdHlwZTogIm51bWJlciIsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXhpcwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZS5qcwp2YXIgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlID0gKGF4aXNTZXR0aW5ncywgYXhpc1JhbmdlKSA9PiB7CiAgaWYgKCFheGlzU2V0dGluZ3MgfHwgIWF4aXNSYW5nZSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncyAhPT0gbnVsbCAmJiBheGlzU2V0dGluZ3MgIT09IHZvaWQgMCAmJiBheGlzU2V0dGluZ3MucmV2ZXJzZWQpIHsKICAgIHJldHVybiBbYXhpc1JhbmdlWzFdLCBheGlzUmFuZ2VbMF1dOwogIH0KICByZXR1cm4gYXhpc1JhbmdlOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcG9sYXJBeGlzU2VsZWN0b3JzLmpzCnZhciBpbXBsaWNpdEFuZ2xlQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGZhbHNlLAogIC8vIGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5IGhhcyBpdCBzZXQgdG8gdHJ1ZSBidXQgdGhlIGFjdHVhbCBheGlzIHJlbmRlcmluZyBpZ25vcmVzIHRoZSBwcm9wIGJlY2F1c2UgcmVhc29ucywKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFuZ2xlQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMucmV2ZXJzZWQsCiAgc2NhbGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy50eXBlLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpdXNBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5yYWRpdXNBeGlzSWQsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnRpY2tDb3VudCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50eXBlLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpYWxCYXJBbmdsZUF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFuZ2xlQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAibnVtYmVyIiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIGltcGxpY2l0UmFkaWFsQmFyUmFkaXVzQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMucmFkaXVzQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGljaywKICB0aWNrQ291bnQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrQ291bnQsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgc2VsZWN0QW5nbGVBeGlzID0gKHN0YXRlLCBhbmdsZUF4aXNJZCkgPT4gewogIGlmIChzdGF0ZS5wb2xhckF4aXMuYW5nbGVBeGlzW2FuZ2xlQXhpc0lkXSAhPSBudWxsKSB7CiAgICByZXR1cm4gc3RhdGUucG9sYXJBeGlzLmFuZ2xlQXhpc1thbmdsZUF4aXNJZF07CiAgfQogIGlmIChzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZSA9PT0gInJhZGlhbCIpIHsKICAgIHJldHVybiBpbXBsaWNpdFJhZGlhbEJhckFuZ2xlQXhpczsKICB9CiAgcmV0dXJuIGltcGxpY2l0QW5nbGVBeGlzOwp9Owp2YXIgc2VsZWN0UmFkaXVzQXhpcyA9IChzdGF0ZSwgcmFkaXVzQXhpc0lkKSA9PiB7CiAgaWYgKHN0YXRlLnBvbGFyQXhpcy5yYWRpdXNBeGlzW3JhZGl1c0F4aXNJZF0gIT0gbnVsbCkgewogICAgcmV0dXJuIHN0YXRlLnBvbGFyQXhpcy5yYWRpdXNBeGlzW3JhZGl1c0F4aXNJZF07CiAgfQogIGlmIChzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZSA9PT0gInJhZGlhbCIpIHsKICAgIHJldHVybiBpbXBsaWNpdFJhZGlhbEJhclJhZGl1c0F4aXM7CiAgfQogIHJldHVybiBpbXBsaWNpdFJhZGl1c0F4aXM7Cn07CnZhciBzZWxlY3RQb2xhck9wdGlvbnMgPSAoc3RhdGUpID0+IHN0YXRlLnBvbGFyT3B0aW9uczsKdmFyIHNlbGVjdE1heFJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIGdldE1heFJhZGl1cyk7CnZhciBzZWxlY3RJbm5lclJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnMsIHNlbGVjdE1heFJhZGl1c10sIChwb2xhckNoYXJ0T3B0aW9ucywgbWF4UmFkaXVzKSA9PiB7CiAgaWYgKHBvbGFyQ2hhcnRPcHRpb25zID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBnZXRQZXJjZW50VmFsdWUocG9sYXJDaGFydE9wdGlvbnMuaW5uZXJSYWRpdXMsIG1heFJhZGl1cywgMCk7Cn0pOwp2YXIgc2VsZWN0T3V0ZXJSYWRpdXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJPcHRpb25zLCBzZWxlY3RNYXhSYWRpdXNdLCAocG9sYXJDaGFydE9wdGlvbnMsIG1heFJhZGl1cykgPT4gewogIGlmIChwb2xhckNoYXJ0T3B0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZ2V0UGVyY2VudFZhbHVlKHBvbGFyQ2hhcnRPcHRpb25zLm91dGVyUmFkaXVzLCBtYXhSYWRpdXMsIG1heFJhZGl1cyAqIDAuOCk7Cn0pOwp2YXIgY29tYmluZUFuZ2xlQXhpc1JhbmdlID0gKHBvbGFyT3B0aW9ucykgPT4gewogIGlmIChwb2xhck9wdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIFswLCAwXTsKICB9CiAgdmFyIHsKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBwb2xhck9wdGlvbnM7CiAgcmV0dXJuIFtzdGFydEFuZ2xlLCBlbmRBbmdsZV07Cn07CnZhciBzZWxlY3RBbmdsZUF4aXNSYW5nZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnNdLCBjb21iaW5lQW5nbGVBeGlzUmFuZ2UpOwp2YXIgc2VsZWN0QW5nbGVBeGlzUmFuZ2VXaXRoUmV2ZXJzZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QW5nbGVBeGlzLCBzZWxlY3RBbmdsZUF4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RSYWRpdXNBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0TWF4UmFkaXVzLCBzZWxlY3RJbm5lclJhZGl1cywgc2VsZWN0T3V0ZXJSYWRpdXNdLCAobWF4UmFkaXVzLCBpbm5lclJhZGl1cywgb3V0ZXJSYWRpdXMpID0+IHsKICBpZiAobWF4UmFkaXVzID09IG51bGwgfHwgaW5uZXJSYWRpdXMgPT0gbnVsbCB8fCBvdXRlclJhZGl1cyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW2lubmVyUmFkaXVzLCBvdXRlclJhZGl1c107Cn0pOwp2YXIgc2VsZWN0UmFkaXVzQXhpc1JhbmdlV2l0aFJldmVyc2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJhZGl1c0F4aXMsIHNlbGVjdFJhZGl1c0F4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RQb2xhclZpZXdCb3ggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFBvbGFyT3B0aW9ucywgc2VsZWN0SW5uZXJSYWRpdXMsIHNlbGVjdE91dGVyUmFkaXVzLCBzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodF0sIChsYXlvdXQsIHBvbGFyT3B0aW9ucywgaW5uZXJSYWRpdXMsIG91dGVyUmFkaXVzLCB3aWR0aCwgaGVpZ2h0KSA9PiB7CiAgaWYgKGxheW91dCAhPT0gImNlbnRyaWMiICYmIGxheW91dCAhPT0gInJhZGlhbCIgfHwgcG9sYXJPcHRpb25zID09IG51bGwgfHwgaW5uZXJSYWRpdXMgPT0gbnVsbCB8fCBvdXRlclJhZGl1cyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBwb2xhck9wdGlvbnM7CiAgcmV0dXJuIHsKICAgIGN4OiBnZXRQZXJjZW50VmFsdWUoY3gsIHdpZHRoLCB3aWR0aCAvIDIpLAogICAgY3k6IGdldFBlcmNlbnRWYWx1ZShjeSwgaGVpZ2h0LCBoZWlnaHQgLyAyKSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUsCiAgICBjbG9ja1dpc2U6IGZhbHNlCiAgICAvLyB0aGlzIHByb3BlcnR5IGxvb2sgdXNlZnVsLCB3aHkgbm90IHVzZSBpdD8KICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3BpY2tBeGlzVHlwZS5qcwp2YXIgcGlja0F4aXNUeXBlID0gKF9zdGF0ZSwgYXhpc1R5cGUpID0+IGF4aXNUeXBlOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcGlja0F4aXNJZC5qcwp2YXIgcGlja0F4aXNJZCA9IChfc3RhdGUsIF9heGlzVHlwZSwgYXhpc0lkKSA9PiBheGlzSWQ7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3RhY2tzL2dldFN0YWNrU2VyaWVzSWRlbnRpZmllci5qcwpmdW5jdGlvbiBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoZ3JhcGhpY2FsSXRlbSkgewogIHJldHVybiBncmFwaGljYWxJdGVtID09PSBudWxsIHx8IGdyYXBoaWNhbEl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGdyYXBoaWNhbEl0ZW0uaWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEuanMKZnVuY3Rpb24gY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhKHN0YWNrZWRHcmFwaGljYWxJdGVtcywgX3JlZjIsIHRvb2x0aXBBeGlzU2V0dGluZ3MpIHsKICB2YXIgewogICAgY2hhcnREYXRhID0gW10KICB9ID0gX3JlZjI7CiAgdmFyIHsKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgZGF0YUtleTogdG9vbHRpcERhdGFLZXkKICB9ID0gdG9vbHRpcEF4aXNTZXR0aW5nczsKICB2YXIga25vd25JdGVtc0J5RGF0YUtleSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgc3RhY2tlZEdyYXBoaWNhbEl0ZW1zLmZvckVhY2goKGl0ZW0pID0+IHsKICAgIHZhciBfaXRlbSRkYXRhOwogICAgdmFyIHJlc29sdmVkRGF0YSA9IChfaXRlbSRkYXRhID0gaXRlbS5kYXRhKSAhPT0gbnVsbCAmJiBfaXRlbSRkYXRhICE9PSB2b2lkIDAgPyBfaXRlbSRkYXRhIDogY2hhcnREYXRhOwogICAgaWYgKHJlc29sdmVkRGF0YSA9PSBudWxsIHx8IHJlc29sdmVkRGF0YS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHN0YWNrSWRlbnRpZmllciA9IGdldFN0YWNrU2VyaWVzSWRlbnRpZmllcihpdGVtKTsKICAgIHJlc29sdmVkRGF0YS5mb3JFYWNoKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgdmFyIHRvb2x0aXBWYWx1ZSA9IHRvb2x0aXBEYXRhS2V5ID09IG51bGwgfHwgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgPyBpbmRleCA6IFN0cmluZyhnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgdG9vbHRpcERhdGFLZXksIG51bGwpKTsKICAgICAgdmFyIG51bWVyaWNWYWx1ZSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBpdGVtLmRhdGFLZXksIDApOwogICAgICB2YXIgY3VycjsKICAgICAgaWYgKGtub3duSXRlbXNCeURhdGFLZXkuaGFzKHRvb2x0aXBWYWx1ZSkpIHsKICAgICAgICBjdXJyID0ga25vd25JdGVtc0J5RGF0YUtleS5nZXQodG9vbHRpcFZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJyID0ge307CiAgICAgIH0KICAgICAgT2JqZWN0LmFzc2lnbihjdXJyLCB7CiAgICAgICAgW3N0YWNrSWRlbnRpZmllcl06IG51bWVyaWNWYWx1ZQogICAgICB9KTsKICAgICAga25vd25JdGVtc0J5RGF0YUtleS5zZXQodG9vbHRpcFZhbHVlLCBjdXJyKTsKICAgIH0pOwogIH0pOwogIHJldHVybiBBcnJheS5mcm9tKGtub3duSXRlbXNCeURhdGFLZXkudmFsdWVzKCkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3R5cGVzL1N0YWNrZWRHcmFwaGljYWxJdGVtLmpzCmZ1bmN0aW9uIGlzU3RhY2tlZChncmFwaGljYWxJdGVtKSB7CiAgcmV0dXJuIGdyYXBoaWNhbEl0ZW0uc3RhY2tJZCAhPSBudWxsICYmIGdyYXBoaWNhbEl0ZW0uZGF0YUtleSAhPSBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9udW1iZXJEb21haW5FcXVhbGl0eUNoZWNrLmpzCnZhciBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrID0gKGEsIGIpID0+IHsKICBpZiAoYSA9PT0gYikgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiBhWzBdID09PSBiWzBdICYmIGFbMV0gPT09IGJbMV07Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9hcnJheUVxdWFsaXR5Q2hlY2suanMKZnVuY3Rpb24gZW1wdHlBcnJheXNBcmVFcXVhbENoZWNrKGEsIGIpIHsKICBpZiAoQXJyYXkuaXNBcnJheShhKSAmJiBBcnJheS5pc0FycmF5KGIpICYmIGEubGVuZ3RoID09PSAwICYmIGIubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGEgPT09IGI7Cn0KZnVuY3Rpb24gYXJyYXlDb250ZW50c0FyZUVxdWFsQ2hlY2soYSwgYikgewogIGlmIChhLmxlbmd0aCA9PT0gYi5sZW5ndGgpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoYVtpXSAhPT0gYltpXSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBmYWxzZTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcEF4aXNUeXBlLmpzCnZhciBzZWxlY3RUb29sdGlwQXhpc1R5cGUgPSAoc3RhdGUpID0+IHsKICB2YXIgbGF5b3V0ID0gc2VsZWN0Q2hhcnRMYXlvdXQoc3RhdGUpOwogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuICJ4QXhpcyI7CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiAieUF4aXMiOwogIH0KICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgIHJldHVybiAiYW5nbGVBeGlzIjsKICB9CiAgcmV0dXJuICJyYWRpdXNBeGlzIjsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBBeGlzSWQuanMKdmFyIHNlbGVjdFRvb2x0aXBBeGlzSWQgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MuYXhpc0lkOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXhpc1NlbGVjdG9ycy5qcwpmdW5jdGlvbiBvd25LZXlzMTMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxMyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czEzKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxMyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxMyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTMoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxMyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxMyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxMyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGRlZmF1bHROdW1lcmljRG9tYWluID0gWzAsICJhdXRvIl07CnZhciBpbXBsaWNpdFhBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiB0cnVlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiB0cnVlLAogIGFuZ2xlOiAwLAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IHZvaWQgMCwKICBoZWlnaHQ6IDMwLAogIGhpZGU6IHRydWUsCiAgaWQ6IDAsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgaW50ZXJ2YWw6ICJwcmVzZXJ2ZUVuZCIsCiAgbWluVGlja0dhcDogNSwKICBtaXJyb3I6IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICBvcmllbnRhdGlvbjogImJvdHRvbSIsCiAgcGFkZGluZzogewogICAgbGVmdDogMCwKICAgIHJpZ2h0OiAwCiAgfSwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6ICJhdXRvIiwKICB0aWNrOiB0cnVlLAogIHRpY2tDb3VudDogNSwKICB0aWNrRm9ybWF0dGVyOiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgc2VsZWN0WEF4aXNTZXR0aW5nc05vRGVmYXVsdHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHJldHVybiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnhBeGlzW2F4aXNJZF07Cn07CnZhciBzZWxlY3RYQXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpcyA9IHNlbGVjdFhBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFhBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIGltcGxpY2l0WUF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IHRydWUsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHRydWUsCiAgYW5nbGU6IDAsCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogZGVmYXVsdE51bWVyaWNEb21haW4sCiAgaGlkZTogdHJ1ZSwKICBpZDogMCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBpbnRlcnZhbDogInByZXNlcnZlRW5kIiwKICBtaW5UaWNrR2FwOiA1LAogIG1pcnJvcjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIG9yaWVudGF0aW9uOiAibGVmdCIsCiAgcGFkZGluZzogewogICAgdG9wOiAwLAogICAgYm90dG9tOiAwCiAgfSwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6ICJhdXRvIiwKICB0aWNrOiB0cnVlLAogIHRpY2tDb3VudDogNSwKICB0aWNrRm9ybWF0dGVyOiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAibnVtYmVyIiwKICB1bml0OiB2b2lkIDAsCiAgd2lkdGg6IERFRkFVTFRfWV9BWElTX1dJRFRICn07CnZhciBzZWxlY3RZQXhpc1NldHRpbmdzTm9EZWZhdWx0cyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgcmV0dXJuIHN0YXRlLmNhcnRlc2lhbkF4aXMueUF4aXNbYXhpc0lkXTsKfTsKdmFyIHNlbGVjdFlBeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzID0gc2VsZWN0WUF4aXNTZXR0aW5nc05vRGVmYXVsdHMoc3RhdGUsIGF4aXNJZCk7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIGltcGxpY2l0WUF4aXM7CiAgfQogIHJldHVybiBheGlzOwp9Owp2YXIgaW1wbGljaXRaQXhpcyA9IHsKICBkb21haW46IFswLCAiYXV0byJdLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIHJldmVyc2VkOiBmYWxzZSwKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGZhbHNlLAogIGRhdGFLZXk6IHZvaWQgMCwKICBpZDogMCwKICBuYW1lOiAiIiwKICByYW5nZTogWzY0LCA2NF0sCiAgc2NhbGU6ICJhdXRvIiwKICB0eXBlOiAibnVtYmVyIiwKICB1bml0OiAiIgp9Owp2YXIgc2VsZWN0WkF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXMgPSBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnpBeGlzW2F4aXNJZF07CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIGltcGxpY2l0WkF4aXM7CiAgfQogIHJldHVybiBheGlzOwp9Owp2YXIgc2VsZWN0QmFzZUF4aXMgPSAoc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQpID0+IHsKICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICBjYXNlICJ4QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJ5QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJ6QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFpBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJhbmdsZUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RBbmdsZUF4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJyYWRpdXNBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0UmFkaXVzQXhpcyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBheGlzIHR5cGU6ICIuY29uY2F0KGF4aXNUeXBlKSk7CiAgfQp9Owp2YXIgc2VsZWN0Q2FydGVzaWFuQXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGF4aXMgdHlwZTogIi5jb25jYXQoYXhpc1R5cGUpKTsKICB9Cn07CnZhciBzZWxlY3RBeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQpID0+IHsKICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICBjYXNlICJ4QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJ5QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJhbmdsZUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RBbmdsZUF4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJyYWRpdXNBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0UmFkaXVzQXhpcyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBheGlzIHR5cGU6ICIuY29uY2F0KGF4aXNUeXBlKSk7CiAgfQp9Owp2YXIgc2VsZWN0SGFzQmFyID0gKHN0YXRlKSA9PiBzdGF0ZS5ncmFwaGljYWxJdGVtcy5jYXJ0ZXNpYW5JdGVtcy5zb21lKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJiYXIiKSB8fCBzdGF0ZS5ncmFwaGljYWxJdGVtcy5wb2xhckl0ZW1zLnNvbWUoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gInJhZGlhbEJhciIpOwpmdW5jdGlvbiBpdGVtQXhpc1ByZWRpY2F0ZShheGlzVHlwZSwgYXhpc0lkKSB7CiAgcmV0dXJuIChpdGVtKSA9PiB7CiAgICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICAgIGNhc2UgInhBeGlzIjoKICAgICAgICByZXR1cm4gInhBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS54QXhpc0lkID09PSBheGlzSWQ7CiAgICAgIGNhc2UgInlBeGlzIjoKICAgICAgICByZXR1cm4gInlBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS55QXhpc0lkID09PSBheGlzSWQ7CiAgICAgIGNhc2UgInpBeGlzIjoKICAgICAgICByZXR1cm4gInpBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS56QXhpc0lkID09PSBheGlzSWQ7CiAgICAgIGNhc2UgImFuZ2xlQXhpcyI6CiAgICAgICAgcmV0dXJuICJhbmdsZUF4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLmFuZ2xlQXhpc0lkID09PSBheGlzSWQ7CiAgICAgIGNhc2UgInJhZGl1c0F4aXMiOgogICAgICAgIHJldHVybiAicmFkaXVzQXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ucmFkaXVzQXhpc0lkID09PSBheGlzSWQ7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07Cn0KdmFyIHNlbGVjdFVuZmlsdGVyZWRDYXJ0ZXNpYW5JdGVtcyA9IChzdGF0ZSkgPT4gc3RhdGUuZ3JhcGhpY2FsSXRlbXMuY2FydGVzaWFuSXRlbXM7CnZhciBzZWxlY3RBeGlzUHJlZGljYXRlID0gY3JlYXRlU2VsZWN0b3IoW3BpY2tBeGlzVHlwZSwgcGlja0F4aXNJZF0sIGl0ZW1BeGlzUHJlZGljYXRlKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtc1NldHRpbmdzID0gKGdyYXBoaWNhbEl0ZW1zLCBheGlzU2V0dGluZ3MsIGF4aXNQcmVkaWNhdGUpID0+IGdyYXBoaWNhbEl0ZW1zLmZpbHRlcihheGlzUHJlZGljYXRlKS5maWx0ZXIoKGl0ZW0pID0+IHsKICBpZiAoKGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy5pbmNsdWRlSGlkZGVuKSA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiAhaXRlbS5oaWRlOwp9KTsKdmFyIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VW5maWx0ZXJlZENhcnRlc2lhbkl0ZW1zLCBzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc1ByZWRpY2F0ZV0sIGNvbWJpbmVHcmFwaGljYWxJdGVtc1NldHRpbmdzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RTdGFja2VkQ2FydGVzaWFuSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgKGNhcnRlc2lhbkl0ZW1zKSA9PiB7CiAgcmV0dXJuIGNhcnRlc2lhbkl0ZW1zLmZpbHRlcigoaXRlbSkgPT4gaXRlbS50eXBlID09PSAiYXJlYSIgfHwgaXRlbS50eXBlID09PSAiYmFyIikuZmlsdGVyKGlzU3RhY2tlZCk7Cn0pOwp2YXIgZmlsdGVyR3JhcGhpY2FsTm90U3RhY2tlZEl0ZW1zID0gKGNhcnRlc2lhbkl0ZW1zKSA9PiBjYXJ0ZXNpYW5JdGVtcy5maWx0ZXIoKGl0ZW0pID0+ICEoInN0YWNrSWQiIGluIGl0ZW0pIHx8IGl0ZW0uc3RhY2tJZCA9PT0gdm9pZCAwKTsKdmFyIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NdLCBmaWx0ZXJHcmFwaGljYWxOb3RTdGFja2VkSXRlbXMpOwp2YXIgY29tYmluZUdyYXBoaWNhbEl0ZW1zRGF0YSA9IChjYXJ0ZXNpYW5JdGVtcykgPT4gY2FydGVzaWFuSXRlbXMubWFwKChpdGVtKSA9PiBpdGVtLmRhdGEpLmZpbHRlcihCb29sZWFuKS5mbGF0KDEpOwp2YXIgc2VsZWN0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbXNEYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNEYXRhLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBjb21iaW5lRGlzcGxheWVkRGF0YSA9IChncmFwaGljYWxJdGVtc0RhdGEsIF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSA9IFtdLAogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICBkYXRhRW5kSW5kZXgKICB9ID0gX3JlZjI7CiAgaWYgKGdyYXBoaWNhbEl0ZW1zRGF0YS5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gZ3JhcGhpY2FsSXRlbXNEYXRhOwogIH0KICByZXR1cm4gY2hhcnREYXRhLnNsaWNlKGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXggKyAxKTsKfTsKdmFyIHNlbGVjdERpc3BsYXllZERhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbXNEYXRhLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc0lmTm90SW5QYW5vcmFtYV0sIGNvbWJpbmVEaXNwbGF5ZWREYXRhKTsKdmFyIGNvbWJpbmVBcHBsaWVkVmFsdWVzID0gKGRhdGEsIGF4aXNTZXR0aW5ncywgaXRlbXMpID0+IHsKICBpZiAoKGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy5kYXRhS2V5KSAhPSBudWxsKSB7CiAgICByZXR1cm4gZGF0YS5tYXAoKGl0ZW0pID0+ICh7CiAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleShpdGVtLCBheGlzU2V0dGluZ3MuZGF0YUtleSkKICAgIH0pKTsKICB9CiAgaWYgKGl0ZW1zLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBpdGVtcy5tYXAoKGl0ZW0pID0+IGl0ZW0uZGF0YUtleSkuZmxhdE1hcCgoZGF0YUtleSkgPT4gZGF0YS5tYXAoKGVudHJ5KSA9PiAoewogICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGRhdGFLZXkpCiAgICB9KSkpOwogIH0KICByZXR1cm4gZGF0YS5tYXAoKGVudHJ5KSA9PiAoewogICAgdmFsdWU6IGVudHJ5CiAgfSkpOwp9Owp2YXIgc2VsZWN0QWxsQXBwbGllZFZhbHVlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REaXNwbGF5ZWREYXRhLCBzZWxlY3RCYXNlQXhpcywgc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIGNvbWJpbmVBcHBsaWVkVmFsdWVzKTsKZnVuY3Rpb24gaXNFcnJvckJhclJlbGV2YW50Rm9yQXhpc1R5cGUoYXhpc1R5cGUsIGVycm9yQmFyKSB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOgogICAgICByZXR1cm4gZXJyb3JCYXIuZGlyZWN0aW9uID09PSAieCI7CiAgICBjYXNlICJ5QXhpcyI6CiAgICAgIHJldHVybiBlcnJvckJhci5kaXJlY3Rpb24gPT09ICJ5IjsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBmYWxzZTsKICB9Cn0KZnVuY3Rpb24gbWFrZU51bWJlcih2YWwpIHsKICBpZiAoaXNOdW1PclN0cih2YWwpIHx8IHZhbCBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHZhciBuID0gTnVtYmVyKHZhbCk7CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihuKSkgewogICAgICByZXR1cm4gbjsKICAgIH0KICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBtYWtlRG9tYWluKHZhbCkgewogIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHsKICAgIHZhciBhdHRlbXB0ID0gW21ha2VOdW1iZXIodmFsWzBdKSwgbWFrZU51bWJlcih2YWxbMV0pXTsKICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oYXR0ZW1wdCkpIHsKICAgICAgcmV0dXJuIGF0dGVtcHQ7CiAgICB9CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgbiA9IG1ha2VOdW1iZXIodmFsKTsKICBpZiAobiA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW24sIG5dOwp9CmZ1bmN0aW9uIG9ubHlBbGxvd051bWJlcnMoZGF0YSkgewogIHJldHVybiBkYXRhLm1hcChtYWtlTnVtYmVyKS5maWx0ZXIoaXNOb3ROaWwpOwp9CmZ1bmN0aW9uIGdldEVycm9yRG9tYWluQnlEYXRhS2V5KGVudHJ5LCBhcHBsaWVkVmFsdWUsIHJlbGV2YW50RXJyb3JCYXJzKSB7CiAgaWYgKCFyZWxldmFudEVycm9yQmFycyB8fCB0eXBlb2YgYXBwbGllZFZhbHVlICE9PSAibnVtYmVyIiB8fCBpc05hbihhcHBsaWVkVmFsdWUpKSB7CiAgICByZXR1cm4gW107CiAgfQogIGlmICghcmVsZXZhbnRFcnJvckJhcnMubGVuZ3RoKSB7CiAgICByZXR1cm4gW107CiAgfQogIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKHJlbGV2YW50RXJyb3JCYXJzLmZsYXRNYXAoKGViKSA9PiB7CiAgICB2YXIgZXJyb3JWYWx1ZSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBlYi5kYXRhS2V5KTsKICAgIHZhciBsb3dCb3VuZCwgaGlnaEJvdW5kOwogICAgaWYgKEFycmF5LmlzQXJyYXkoZXJyb3JWYWx1ZSkpIHsKICAgICAgW2xvd0JvdW5kLCBoaWdoQm91bmRdID0gZXJyb3JWYWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGxvd0JvdW5kID0gaGlnaEJvdW5kID0gZXJyb3JWYWx1ZTsKICAgIH0KICAgIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihsb3dCb3VuZCkgfHwgIWlzV2VsbEJlaGF2ZWROdW1iZXIoaGlnaEJvdW5kKSkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgcmV0dXJuIFthcHBsaWVkVmFsdWUgLSBsb3dCb3VuZCwgYXBwbGllZFZhbHVlICsgaGlnaEJvdW5kXTsKICB9KSk7Cn0KdmFyIHNlbGVjdFRvb2x0aXBBeGlzID0gKHN0YXRlKSA9PiB7CiAgdmFyIGF4aXNUeXBlID0gc2VsZWN0VG9vbHRpcEF4aXNUeXBlKHN0YXRlKTsKICB2YXIgYXhpc0lkID0gc2VsZWN0VG9vbHRpcEF4aXNJZChzdGF0ZSk7CiAgcmV0dXJuIHNlbGVjdEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCk7Cn07CnZhciBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXkgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNdLCAoYXhpcykgPT4gYXhpcyA9PT0gbnVsbCB8fCBheGlzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzLmRhdGFLZXkpOwp2YXIgc2VsZWN0RGlzcGxheWVkU3RhY2tlZERhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hLCBzZWxlY3RUb29sdGlwQXhpc10sIGNvbWJpbmVEaXNwbGF5ZWRTdGFja2VkRGF0YSk7CnZhciBjb21iaW5lU3RhY2tHcm91cHMgPSAoZGlzcGxheWVkRGF0YSwgaXRlbXMsIHN0YWNrT2Zmc2V0VHlwZSwgcmV2ZXJzZVN0YWNrT3JkZXIpID0+IHsKICB2YXIgaW5pdGlhbEl0ZW1zR3JvdXBzID0ge307CiAgdmFyIGl0ZW1zR3JvdXAgPSBpdGVtcy5yZWR1Y2UoKGFjYywgaXRlbSkgPT4gewogICAgaWYgKGl0ZW0uc3RhY2tJZCA9PSBudWxsKSB7CiAgICAgIHJldHVybiBhY2M7CiAgICB9CiAgICBpZiAoYWNjW2l0ZW0uc3RhY2tJZF0gPT0gbnVsbCkgewogICAgICBhY2NbaXRlbS5zdGFja0lkXSA9IFtdOwogICAgfQogICAgYWNjW2l0ZW0uc3RhY2tJZF0ucHVzaChpdGVtKTsKICAgIHJldHVybiBhY2M7CiAgfSwgaW5pdGlhbEl0ZW1zR3JvdXBzKTsKICByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKGl0ZW1zR3JvdXApLm1hcCgoX3JlZjIpID0+IHsKICAgIHZhciBbc3RhY2tJZCwgZ3JhcGhpY2FsSXRlbXNdID0gX3JlZjI7CiAgICB2YXIgb3JkZXJlZEdyYXBoaWNhbEl0ZW1zID0gcmV2ZXJzZVN0YWNrT3JkZXIgPyBbLi4uZ3JhcGhpY2FsSXRlbXNdLnJldmVyc2UoKSA6IGdyYXBoaWNhbEl0ZW1zOwogICAgdmFyIGRhdGFLZXlzID0gb3JkZXJlZEdyYXBoaWNhbEl0ZW1zLm1hcChnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIpOwogICAgcmV0dXJuIFtzdGFja0lkLCB7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0U3RhY2tlZERhdGEgcmVxdWlyZXMgdGhhdCB0aGUgaW5wdXQgaXMgYXJyYXkgb2Ygb2JqZWN0cywgUmVjaGFydHMgZG9lcyBub3QgdGVzdCBmb3IgdGhhdAogICAgICBzdGFja2VkRGF0YTogZ2V0U3RhY2tlZERhdGEoZGlzcGxheWVkRGF0YSwgZGF0YUtleXMsIHN0YWNrT2Zmc2V0VHlwZSksCiAgICAgIGdyYXBoaWNhbEl0ZW1zOiBvcmRlcmVkR3JhcGhpY2FsSXRlbXMKICAgIH1dOwogIH0pKTsKfTsKdmFyIHNlbGVjdFN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERpc3BsYXllZFN0YWNrZWREYXRhLCBzZWxlY3RTdGFja2VkQ2FydGVzaWFuSXRlbXNTZXR0aW5ncywgc2VsZWN0U3RhY2tPZmZzZXRUeXBlLCBzZWxlY3RSZXZlcnNlU3RhY2tPcmRlcl0sIGNvbWJpbmVTdGFja0dyb3Vwcyk7CnZhciBjb21iaW5lRG9tYWluT2ZTdGFja0dyb3VwcyA9IChzdGFja0dyb3VwcywgX3JlZjMsIGF4aXNUeXBlLCBkb21haW5Gcm9tVXNlclByZWZlcmVuY2UpID0+IHsKICB2YXIgewogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICBkYXRhRW5kSW5kZXgKICB9ID0gX3JlZjM7CiAgaWYgKGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSAhPSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoYXhpc1R5cGUgPT09ICJ6QXhpcyIpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBkb21haW5PZlN0YWNrR3JvdXBzID0gZ2V0RG9tYWluT2ZTdGFja0dyb3VwcyhzdGFja0dyb3VwcywgZGF0YVN0YXJ0SW5kZXgsIGRhdGFFbmRJbmRleCk7CiAgaWYgKGRvbWFpbk9mU3RhY2tHcm91cHMgIT0gbnVsbCAmJiBkb21haW5PZlN0YWNrR3JvdXBzWzBdID09PSAwICYmIGRvbWFpbk9mU3RhY2tHcm91cHNbMV0gPT09IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBkb21haW5PZlN0YWNrR3JvdXBzOwp9Owp2YXIgc2VsZWN0QWxsb3dzRGF0YU92ZXJmbG93ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzXSwgKGF4aXNTZXR0aW5ncykgPT4gYXhpc1NldHRpbmdzLmFsbG93RGF0YU92ZXJmbG93KTsKdmFyIGdldERvbWFpbkRlZmluaXRpb24gPSAoYXhpc1NldHRpbmdzKSA9PiB7CiAgdmFyIF9heGlzU2V0dGluZ3MkZG9tYWluOwogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCB8fCAhKCJkb21haW4iIGluIGF4aXNTZXR0aW5ncykpIHsKICAgIHJldHVybiBkZWZhdWx0TnVtZXJpY0RvbWFpbjsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncy5kb21haW4gIT0gbnVsbCkgewogICAgcmV0dXJuIGF4aXNTZXR0aW5ncy5kb21haW47CiAgfQogIGlmIChheGlzU2V0dGluZ3MudGlja3MgIT0gbnVsbCkgewogICAgaWYgKGF4aXNTZXR0aW5ncy50eXBlID09PSAibnVtYmVyIikgewogICAgICB2YXIgYWxsVmFsdWVzID0gb25seUFsbG93TnVtYmVycyhheGlzU2V0dGluZ3MudGlja3MpOwogICAgICByZXR1cm4gW01hdGgubWluKC4uLmFsbFZhbHVlcyksIE1hdGgubWF4KC4uLmFsbFZhbHVlcyldOwogICAgfQogICAgaWYgKGF4aXNTZXR0aW5ncy50eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICAgIHJldHVybiBheGlzU2V0dGluZ3MudGlja3MubWFwKFN0cmluZyk7CiAgICB9CiAgfQogIHJldHVybiAoX2F4aXNTZXR0aW5ncyRkb21haW4gPSBheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuZG9tYWluKSAhPT0gbnVsbCAmJiBfYXhpc1NldHRpbmdzJGRvbWFpbiAhPT0gdm9pZCAwID8gX2F4aXNTZXR0aW5ncyRkb21haW4gOiBkZWZhdWx0TnVtZXJpY0RvbWFpbjsKfTsKdmFyIHNlbGVjdERvbWFpbkRlZmluaXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXNdLCBnZXREb21haW5EZWZpbml0aW9uKTsKdmFyIHNlbGVjdERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REb21haW5EZWZpbml0aW9uLCBzZWxlY3RBbGxvd3NEYXRhT3ZlcmZsb3ddLCBudW1lcmljYWxEb21haW5TcGVjaWZpZWRXaXRob3V0UmVxdWlyaW5nRGF0YSk7CnZhciBzZWxlY3REb21haW5PZlN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFN0YWNrR3JvdXBzLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcywgcGlja0F4aXNUeXBlLCBzZWxlY3REb21haW5Gcm9tVXNlclByZWZlcmVuY2VdLCBjb21iaW5lRG9tYWluT2ZTdGFja0dyb3VwcywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MgPSAoc3RhdGUpID0+IHN0YXRlLmVycm9yQmFyczsKdmFyIGNvbWJpbmVSZWxldmFudEVycm9yQmFyU2V0dGluZ3MgPSAoY2FydGVzaWFuSXRlbXNTZXR0aW5ncywgYWxsRXJyb3JCYXJTZXR0aW5ncywgYXhpc1R5cGUpID0+IHsKICByZXR1cm4gY2FydGVzaWFuSXRlbXNTZXR0aW5ncy5mbGF0TWFwKChpdGVtKSA9PiB7CiAgICByZXR1cm4gYWxsRXJyb3JCYXJTZXR0aW5nc1tpdGVtLmlkXTsKICB9KS5maWx0ZXIoQm9vbGVhbikuZmlsdGVyKChlKSA9PiB7CiAgICByZXR1cm4gaXNFcnJvckJhclJlbGV2YW50Rm9yQXhpc1R5cGUoYXhpc1R5cGUsIGUpOwogIH0pOwp9Owp2YXIgbWVyZ2VEb21haW5zID0gZnVuY3Rpb24gbWVyZ2VEb21haW5zMigpIHsKICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgZG9tYWlucyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgIGRvbWFpbnNbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgfQogIHZhciBhbGxEb21haW5zID0gZG9tYWlucy5maWx0ZXIoQm9vbGVhbik7CiAgaWYgKGFsbERvbWFpbnMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgYWxsVmFsdWVzID0gYWxsRG9tYWlucy5mbGF0KCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbiguLi5hbGxWYWx1ZXMpOwogIHZhciBtYXgyID0gTWF0aC5tYXgoLi4uYWxsVmFsdWVzKTsKICByZXR1cm4gW21pbjIsIG1heDJdOwp9Owp2YXIgY29tYmluZURvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzID0gKGRhdGEsIGF4aXNTZXR0aW5ncywgaXRlbXMsIGVycm9yQmFycywgYXhpc1R5cGUpID0+IHsKICB2YXIgbG93ZXJFbmQsIHVwcGVyRW5kOwogIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7CiAgICBkYXRhLmZvckVhY2goKGVudHJ5KSA9PiB7CiAgICAgIGl0ZW1zLmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgICB2YXIgX2Vycm9yQmFycyRpdGVtJGlkLCBfYXhpc1NldHRpbmdzJGRhdGFLZXk7CiAgICAgICAgdmFyIHJlbGV2YW50RXJyb3JCYXJzID0gKF9lcnJvckJhcnMkaXRlbSRpZCA9IGVycm9yQmFyc1tpdGVtLmlkXSkgPT09IG51bGwgfHwgX2Vycm9yQmFycyRpdGVtJGlkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZXJyb3JCYXJzJGl0ZW0kaWQuZmlsdGVyKChlcnJvckJhcikgPT4gaXNFcnJvckJhclJlbGV2YW50Rm9yQXhpc1R5cGUoYXhpc1R5cGUsIGVycm9yQmFyKSk7CiAgICAgICAgdmFyIHZhbHVlQnlEYXRhS2V5ID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIChfYXhpc1NldHRpbmdzJGRhdGFLZXkgPSBheGlzU2V0dGluZ3MuZGF0YUtleSkgIT09IG51bGwgJiYgX2F4aXNTZXR0aW5ncyRkYXRhS2V5ICE9PSB2b2lkIDAgPyBfYXhpc1NldHRpbmdzJGRhdGFLZXkgOiBpdGVtLmRhdGFLZXkpOwogICAgICAgIHZhciBlcnJvckRvbWFpbiA9IGdldEVycm9yRG9tYWluQnlEYXRhS2V5KGVudHJ5LCB2YWx1ZUJ5RGF0YUtleSwgcmVsZXZhbnRFcnJvckJhcnMpOwogICAgICAgIGlmIChlcnJvckRvbWFpbi5sZW5ndGggPj0gMikgewogICAgICAgICAgdmFyIGxvY2FsTG93ZXIgPSBNYXRoLm1pbiguLi5lcnJvckRvbWFpbik7CiAgICAgICAgICB2YXIgbG9jYWxVcHBlciA9IE1hdGgubWF4KC4uLmVycm9yRG9tYWluKTsKICAgICAgICAgIGlmIChsb3dlckVuZCA9PSBudWxsIHx8IGxvY2FsTG93ZXIgPCBsb3dlckVuZCkgewogICAgICAgICAgICBsb3dlckVuZCA9IGxvY2FsTG93ZXI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXBwZXJFbmQgPT0gbnVsbCB8fCBsb2NhbFVwcGVyID4gdXBwZXJFbmQpIHsKICAgICAgICAgICAgdXBwZXJFbmQgPSBsb2NhbFVwcGVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGF0YVZhbHVlRG9tYWluID0gbWFrZURvbWFpbih2YWx1ZUJ5RGF0YUtleSk7CiAgICAgICAgaWYgKGRhdGFWYWx1ZURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgICBsb3dlckVuZCA9IGxvd2VyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMF0gOiBNYXRoLm1pbihsb3dlckVuZCwgZGF0YVZhbHVlRG9tYWluWzBdKTsKICAgICAgICAgIHVwcGVyRW5kID0gdXBwZXJFbmQgPT0gbnVsbCA/IGRhdGFWYWx1ZURvbWFpblsxXSA6IE1hdGgubWF4KHVwcGVyRW5kLCBkYXRhVmFsdWVEb21haW5bMV0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuZGF0YUtleSkgIT0gbnVsbCkgewogICAgZGF0YS5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgIHZhciBkYXRhVmFsdWVEb21haW4gPSBtYWtlRG9tYWluKGdldFZhbHVlQnlEYXRhS2V5KGl0ZW0sIGF4aXNTZXR0aW5ncy5kYXRhS2V5KSk7CiAgICAgIGlmIChkYXRhVmFsdWVEb21haW4gIT0gbnVsbCkgewogICAgICAgIGxvd2VyRW5kID0gbG93ZXJFbmQgPT0gbnVsbCA/IGRhdGFWYWx1ZURvbWFpblswXSA6IE1hdGgubWluKGxvd2VyRW5kLCBkYXRhVmFsdWVEb21haW5bMF0pOwogICAgICAgIHVwcGVyRW5kID0gdXBwZXJFbmQgPT0gbnVsbCA/IGRhdGFWYWx1ZURvbWFpblsxXSA6IE1hdGgubWF4KHVwcGVyRW5kLCBkYXRhVmFsdWVEb21haW5bMV0pOwogICAgICB9CiAgICB9KTsKICB9CiAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobG93ZXJFbmQpICYmIGlzV2VsbEJlaGF2ZWROdW1iZXIodXBwZXJFbmQpKSB7CiAgICByZXR1cm4gW2xvd2VyRW5kLCB1cHBlckVuZF07CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REaXNwbGF5ZWREYXRhLCBzZWxlY3RCYXNlQXhpcywgc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKZnVuY3Rpb24gb25seUFsbG93TnVtYmVyc0FuZFN0cmluZ3NBbmREYXRlcyhpdGVtKSB7CiAgdmFyIHsKICAgIHZhbHVlCiAgfSA9IGl0ZW07CiAgaWYgKGlzTnVtT3JTdHIodmFsdWUpIHx8IHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CnZhciBjb21wdXRlRG9tYWluT2ZUeXBlQ2F0ZWdvcnkgPSAoYWxsRGF0YVNxdWlzaGVkLCBheGlzU2V0dGluZ3MsIGlzQ2F0ZWdvcmljYWwpID0+IHsKICB2YXIgY2F0ZWdvcmljYWxEb21haW4gPSBhbGxEYXRhU3F1aXNoZWQubWFwKG9ubHlBbGxvd051bWJlcnNBbmRTdHJpbmdzQW5kRGF0ZXMpLmZpbHRlcigodikgPT4gdiAhPSBudWxsKTsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiAoYXhpc1NldHRpbmdzLmRhdGFLZXkgPT0gbnVsbCB8fCBheGlzU2V0dGluZ3MuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgJiYgaGFzRHVwbGljYXRlKGNhdGVnb3JpY2FsRG9tYWluKSkpIHsKICAgIHJldHVybiAoMCwgaW1wb3J0X3JhbmdlMi5kZWZhdWx0KSgwLCBhbGxEYXRhU3F1aXNoZWQubGVuZ3RoKTsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSkgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluOwogIH0KICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KGNhdGVnb3JpY2FsRG9tYWluKSk7Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzID0gKHN0YXRlKSA9PiBzdGF0ZS5yZWZlcmVuY2VFbGVtZW50cy5kb3RzOwp2YXIgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMgPSAoZWxlbWVudHMsIGF4aXNUeXBlLCBheGlzSWQpID0+IHsKICByZXR1cm4gZWxlbWVudHMuZmlsdGVyKChlbCkgPT4gZWwuaWZPdmVyZmxvdyA9PT0gImV4dGVuZERvbWFpbiIpLmZpbHRlcigoZWwpID0+IHsKICAgIGlmIChheGlzVHlwZSA9PT0gInhBeGlzIikgewogICAgICByZXR1cm4gZWwueEF4aXNJZCA9PT0gYXhpc0lkOwogICAgfQogICAgcmV0dXJuIGVsLnlBeGlzSWQgPT09IGF4aXNJZDsKICB9KTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNCeUF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlRG90cywgcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgc2VsZWN0UmVmZXJlbmNlQXJlYXMgPSAoc3RhdGUpID0+IHN0YXRlLnJlZmVyZW5jZUVsZW1lbnRzLmFyZWFzOwp2YXIgc2VsZWN0UmVmZXJlbmNlQXJlYXNCeUF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlQXJlYXMsIHBpY2tBeGlzVHlwZSwgcGlja0F4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFJlZmVyZW5jZUxpbmVzID0gKHN0YXRlKSA9PiBzdGF0ZS5yZWZlcmVuY2VFbGVtZW50cy5saW5lczsKdmFyIHNlbGVjdFJlZmVyZW5jZUxpbmVzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUxpbmVzLCBwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBjb21iaW5lRG90c0RvbWFpbiA9IChkb3RzLCBheGlzVHlwZSkgPT4gewogIHZhciBhbGxDb29yZHMgPSBvbmx5QWxsb3dOdW1iZXJzKGRvdHMubWFwKChkb3QpID0+IGF4aXNUeXBlID09PSAieEF4aXMiID8gZG90LnggOiBkb3QueSkpOwogIGlmIChhbGxDb29yZHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW01hdGgubWluKC4uLmFsbENvb3JkcyksIE1hdGgubWF4KC4uLmFsbENvb3JkcyldOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlRG90c0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFJlZmVyZW5jZURvdHNCeUF4aXMsIHBpY2tBeGlzVHlwZSwgY29tYmluZURvdHNEb21haW4pOwp2YXIgY29tYmluZUFyZWFzRG9tYWluID0gKGFyZWFzLCBheGlzVHlwZSkgPT4gewogIHZhciBhbGxDb29yZHMgPSBvbmx5QWxsb3dOdW1iZXJzKGFyZWFzLmZsYXRNYXAoKGFyZWEpID0+IFtheGlzVHlwZSA9PT0gInhBeGlzIiA/IGFyZWEueDEgOiBhcmVhLnkxLCBheGlzVHlwZSA9PT0gInhBeGlzIiA/IGFyZWEueDIgOiBhcmVhLnkyXSkpOwogIGlmIChhbGxDb29yZHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW01hdGgubWluKC4uLmFsbENvb3JkcyksIE1hdGgubWF4KC4uLmFsbENvb3JkcyldOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlQXJlYXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlQXJlYXNCeUF4aXMsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVBcmVhc0RvbWFpbik7CmZ1bmN0aW9uIGV4dHJhY3RYQ29vcmRpbmF0ZXMobGluZSkgewogIHZhciBfbGluZSRzZWdtZW50OwogIGlmIChsaW5lLnggIT0gbnVsbCkgewogICAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMoW2xpbmUueF0pOwogIH0KICB2YXIgc2VnbWVudENvb3JkaW5hdGVzID0gKF9saW5lJHNlZ21lbnQgPSBsaW5lLnNlZ21lbnQpID09PSBudWxsIHx8IF9saW5lJHNlZ21lbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9saW5lJHNlZ21lbnQubWFwKChzKSA9PiBzLngpOwogIGlmIChzZWdtZW50Q29vcmRpbmF0ZXMgPT0gbnVsbCB8fCBzZWdtZW50Q29vcmRpbmF0ZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gW107CiAgfQogIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKHNlZ21lbnRDb29yZGluYXRlcyk7Cn0KZnVuY3Rpb24gZXh0cmFjdFlDb29yZGluYXRlcyhsaW5lKSB7CiAgdmFyIF9saW5lJHNlZ21lbnQyOwogIGlmIChsaW5lLnkgIT0gbnVsbCkgewogICAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMoW2xpbmUueV0pOwogIH0KICB2YXIgc2VnbWVudENvb3JkaW5hdGVzID0gKF9saW5lJHNlZ21lbnQyID0gbGluZS5zZWdtZW50KSA9PT0gbnVsbCB8fCBfbGluZSRzZWdtZW50MiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2xpbmUkc2VnbWVudDIubWFwKChzKSA9PiBzLnkpOwogIGlmIChzZWdtZW50Q29vcmRpbmF0ZXMgPT0gbnVsbCB8fCBzZWdtZW50Q29vcmRpbmF0ZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gW107CiAgfQogIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKHNlZ21lbnRDb29yZGluYXRlcyk7Cn0KdmFyIGNvbWJpbmVMaW5lc0RvbWFpbiA9IChsaW5lcywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gbGluZXMuZmxhdE1hcCgobGluZSkgPT4gYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBleHRyYWN0WENvb3JkaW5hdGVzKGxpbmUpIDogZXh0cmFjdFlDb29yZGluYXRlcyhsaW5lKSk7CiAgaWYgKGFsbENvb3Jkcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBbTWF0aC5taW4oLi4uYWxsQ29vcmRzKSwgTWF0aC5tYXgoLi4uYWxsQ29vcmRzKV07Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lc0J5QXhpcywgcGlja0F4aXNUeXBlXSwgY29tYmluZUxpbmVzRG9tYWluKTsKdmFyIHNlbGVjdFJlZmVyZW5jZUVsZW1lbnRzRG9tYWluID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0UmVmZXJlbmNlRG90c0RvbWFpbiwgc2VsZWN0UmVmZXJlbmNlTGluZXNEb21haW4sIHNlbGVjdFJlZmVyZW5jZUFyZWFzRG9tYWluLCAoZG90c0RvbWFpbiwgbGluZXNEb21haW4sIGFyZWFzRG9tYWluKSA9PiB7CiAgcmV0dXJuIG1lcmdlRG9tYWlucyhkb3RzRG9tYWluLCBhcmVhc0RvbWFpbiwgbGluZXNEb21haW4pOwp9KTsKdmFyIGNvbWJpbmVOdW1lcmljYWxEb21haW4gPSAoYXhpc1NldHRpbmdzLCBkb21haW5EZWZpbml0aW9uLCBkb21haW5Gcm9tVXNlclByZWZlcmVuY2UsIGRvbWFpbk9mU3RhY2tHcm91cHMsIGRhdGFBbmRFcnJvckJhcnNEb21haW4sIHJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBsYXlvdXQsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSAhPSBudWxsKSB7CiAgICByZXR1cm4gZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlOwogIH0KICB2YXIgc2hvdWxkSW5jbHVkZURvbWFpbk9mU3RhY2tHcm91cHMgPSBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgJiYgYXhpc1R5cGUgPT09ICJ4QXhpcyIgfHwgbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgJiYgYXhpc1R5cGUgPT09ICJ5QXhpcyI7CiAgdmFyIG1lcmdlZERvbWFpbnMgPSBzaG91bGRJbmNsdWRlRG9tYWluT2ZTdGFja0dyb3VwcyA/IG1lcmdlRG9tYWlucyhkb21haW5PZlN0YWNrR3JvdXBzLCByZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgZGF0YUFuZEVycm9yQmFyc0RvbWFpbikgOiBtZXJnZURvbWFpbnMocmVmZXJlbmNlRWxlbWVudHNEb21haW4sIGRhdGFBbmRFcnJvckJhcnNEb21haW4pOwogIHJldHVybiBwYXJzZU51bWVyaWNhbFVzZXJEb21haW4oZG9tYWluRGVmaW5pdGlvbiwgbWVyZ2VkRG9tYWlucywgYXhpc1NldHRpbmdzLmFsbG93RGF0YU92ZXJmbG93KTsKfTsKdmFyIHNlbGVjdE51bWVyaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0RG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0RG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlLCBzZWxlY3REb21haW5PZlN0YWNrR3JvdXBzLCBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcywgc2VsZWN0UmVmZXJlbmNlRWxlbWVudHNEb21haW4sIHNlbGVjdENoYXJ0TGF5b3V0LCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lTnVtZXJpY2FsRG9tYWluLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IG51bWJlckRvbWFpbkVxdWFsaXR5Q2hlY2sKICB9Cn0pOwp2YXIgZXhwYW5kRG9tYWluID0gWzAsIDFdOwp2YXIgY29tYmluZUF4aXNEb21haW4gPSAoYXhpc1NldHRpbmdzLCBsYXlvdXQsIGRpc3BsYXllZERhdGEsIGFsbEFwcGxpZWRWYWx1ZXMsIHN0YWNrT2Zmc2V0VHlwZSwgYXhpc1R5cGUsIG51bWVyaWNhbERvbWFpbikgPT4gewogIGlmICgoYXhpc1NldHRpbmdzID09IG51bGwgfHwgZGlzcGxheWVkRGF0YSA9PSBudWxsIHx8IGRpc3BsYXllZERhdGEubGVuZ3RoID09PSAwKSAmJiBudW1lcmljYWxEb21haW4gPT09IHZvaWQgMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICB0eXBlCiAgfSA9IGF4aXNTZXR0aW5nczsKICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIGlmIChpc0NhdGVnb3JpY2FsICYmIGRhdGFLZXkgPT0gbnVsbCkgewogICAgdmFyIF9kaXNwbGF5ZWREYXRhJGxlbmd0aDsKICAgIHJldHVybiAoMCwgaW1wb3J0X3JhbmdlMi5kZWZhdWx0KSgwLCAoX2Rpc3BsYXllZERhdGEkbGVuZ3RoID0gZGlzcGxheWVkRGF0YSA9PT0gbnVsbCB8fCBkaXNwbGF5ZWREYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkaXNwbGF5ZWREYXRhLmxlbmd0aCkgIT09IG51bGwgJiYgX2Rpc3BsYXllZERhdGEkbGVuZ3RoICE9PSB2b2lkIDAgPyBfZGlzcGxheWVkRGF0YSRsZW5ndGggOiAwKTsKICB9CiAgaWYgKHR5cGUgPT09ICJjYXRlZ29yeSIpIHsKICAgIHJldHVybiBjb21wdXRlRG9tYWluT2ZUeXBlQ2F0ZWdvcnkoYWxsQXBwbGllZFZhbHVlcywgYXhpc1NldHRpbmdzLCBpc0NhdGVnb3JpY2FsKTsKICB9CiAgaWYgKHN0YWNrT2Zmc2V0VHlwZSA9PT0gImV4cGFuZCIpIHsKICAgIHJldHVybiBleHBhbmREb21haW47CiAgfQogIHJldHVybiBudW1lcmljYWxEb21haW47Cn07CnZhciBzZWxlY3RBeGlzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0U3RhY2tPZmZzZXRUeXBlLCBwaWNrQXhpc1R5cGUsIHNlbGVjdE51bWVyaWNhbERvbWFpbl0sIGNvbWJpbmVBeGlzRG9tYWluKTsKdmFyIGNvbWJpbmVSZWFsU2NhbGVUeXBlID0gKGF4aXNDb25maWcsIGxheW91dCwgaGFzQmFyLCBjaGFydFR5cGUsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXNDb25maWcgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHNjYWxlLAogICAgdHlwZQogIH0gPSBheGlzQ29uZmlnOwogIGlmIChzY2FsZSA9PT0gImF1dG8iKSB7CiAgICBpZiAobGF5b3V0ID09PSAicmFkaWFsIiAmJiBheGlzVHlwZSA9PT0gInJhZGl1c0F4aXMiKSB7CiAgICAgIHJldHVybiAiYmFuZCI7CiAgICB9CiAgICBpZiAobGF5b3V0ID09PSAicmFkaWFsIiAmJiBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIpIHsKICAgICAgcmV0dXJuICJsaW5lYXIiOwogICAgfQogICAgaWYgKHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgY2hhcnRUeXBlICYmIChjaGFydFR5cGUuaW5kZXhPZigiTGluZUNoYXJ0IikgPj0gMCB8fCBjaGFydFR5cGUuaW5kZXhPZigiQXJlYUNoYXJ0IikgPj0gMCB8fCBjaGFydFR5cGUuaW5kZXhPZigiQ29tcG9zZWRDaGFydCIpID49IDAgJiYgIWhhc0JhcikpIHsKICAgICAgcmV0dXJuICJwb2ludCI7CiAgICB9CiAgICBpZiAodHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgICByZXR1cm4gImJhbmQiOwogICAgfQogICAgcmV0dXJuICJsaW5lYXIiOwogIH0KICBpZiAodHlwZW9mIHNjYWxlID09PSAic3RyaW5nIikgewogICAgdmFyIG5hbWUgPSAic2NhbGUiLmNvbmNhdCh1cHBlckZpcnN0KHNjYWxlKSk7CiAgICByZXR1cm4gbmFtZSBpbiBkM19zY2FsZV9leHBvcnRzID8gbmFtZSA6ICJwb2ludCI7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3RSZWFsU2NhbGVUeXBlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0SGFzQmFyLCBzZWxlY3RDaGFydE5hbWUsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVSZWFsU2NhbGVUeXBlKTsKZnVuY3Rpb24gZ2V0RDNTY2FsZUZyb21UeXBlKHJlYWxTY2FsZVR5cGUpIHsKICBpZiAocmVhbFNjYWxlVHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAocmVhbFNjYWxlVHlwZSBpbiBkM19zY2FsZV9leHBvcnRzKSB7CiAgICByZXR1cm4gZDNfc2NhbGVfZXhwb3J0c1tyZWFsU2NhbGVUeXBlXSgpOwogIH0KICB2YXIgbmFtZSA9ICJzY2FsZSIuY29uY2F0KHVwcGVyRmlyc3QocmVhbFNjYWxlVHlwZSkpOwogIGlmIChuYW1lIGluIGQzX3NjYWxlX2V4cG9ydHMpIHsKICAgIHJldHVybiBkM19zY2FsZV9leHBvcnRzW25hbWVdKCk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gY29tYmluZVNjYWxlRnVuY3Rpb24oYXhpcywgcmVhbFNjYWxlVHlwZSwgYXhpc0RvbWFpbiwgYXhpc1JhbmdlKSB7CiAgaWYgKGF4aXNEb21haW4gPT0gbnVsbCB8fCBheGlzUmFuZ2UgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiBheGlzLnNjYWxlID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gYXhpcy5zY2FsZS5jb3B5KCkuZG9tYWluKGF4aXNEb21haW4pLnJhbmdlKGF4aXNSYW5nZSk7CiAgfQogIHZhciBkM1NjYWxlRnVuY3Rpb24gPSBnZXREM1NjYWxlRnJvbVR5cGUocmVhbFNjYWxlVHlwZSk7CiAgaWYgKGQzU2NhbGVGdW5jdGlvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc2NhbGUgPSBkM1NjYWxlRnVuY3Rpb24uZG9tYWluKGF4aXNEb21haW4pLnJhbmdlKGF4aXNSYW5nZSk7CiAgY2hlY2tEb21haW5PZlNjYWxlKHNjYWxlKTsKICByZXR1cm4gc2NhbGU7Cn0KdmFyIGNvbWJpbmVOaWNlVGlja3MgPSAoYXhpc0RvbWFpbiwgYXhpc1NldHRpbmdzLCByZWFsU2NhbGVUeXBlKSA9PiB7CiAgdmFyIGRvbWFpbkRlZmluaXRpb24gPSBnZXREb21haW5EZWZpbml0aW9uKGF4aXNTZXR0aW5ncyk7CiAgaWYgKHJlYWxTY2FsZVR5cGUgIT09ICJhdXRvIiAmJiByZWFsU2NhbGVUeXBlICE9PSAibGluZWFyIikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncyAhPSBudWxsICYmIGF4aXNTZXR0aW5ncy50aWNrQ291bnQgJiYgQXJyYXkuaXNBcnJheShkb21haW5EZWZpbml0aW9uKSAmJiAoZG9tYWluRGVmaW5pdGlvblswXSA9PT0gImF1dG8iIHx8IGRvbWFpbkRlZmluaXRpb25bMV0gPT09ICJhdXRvIikgJiYgaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGF4aXNEb21haW4pKSB7CiAgICByZXR1cm4gZ2V0TmljZVRpY2tWYWx1ZXMoYXhpc0RvbWFpbiwgYXhpc1NldHRpbmdzLnRpY2tDb3VudCwgYXhpc1NldHRpbmdzLmFsbG93RGVjaW1hbHMpOwogIH0KICBpZiAoYXhpc1NldHRpbmdzICE9IG51bGwgJiYgYXhpc1NldHRpbmdzLnRpY2tDb3VudCAmJiBheGlzU2V0dGluZ3MudHlwZSA9PT0gIm51bWJlciIgJiYgaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGF4aXNEb21haW4pKSB7CiAgICByZXR1cm4gZ2V0VGlja1ZhbHVlc0ZpeGVkRG9tYWluKGF4aXNEb21haW4sIGF4aXNTZXR0aW5ncy50aWNrQ291bnQsIGF4aXNTZXR0aW5ncy5hbGxvd0RlY2ltYWxzKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdE5pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBeGlzRG9tYWluLCBzZWxlY3RBeGlzU2V0dGluZ3MsIHNlbGVjdFJlYWxTY2FsZVR5cGVdLCBjb21iaW5lTmljZVRpY2tzKTsKdmFyIGNvbWJpbmVBeGlzRG9tYWluV2l0aE5pY2VUaWNrcyA9IChheGlzU2V0dGluZ3MsIGRvbWFpbiwgbmljZVRpY2tzLCBheGlzVHlwZSkgPT4gewogIGlmICgKICAgIC8qCiAgICAgKiBBbmdsZSBheGlzIGZvciBzb21lIHJlYXNvbiB1c2VzIG5pY2UgdGlja3Mgd2hlbiByZW5kZXJpbmcgYXhpcyB0aWNrIGxhYmVscywKICAgICAqIGJ1dCBkb2Vzbid0IHVzZSBuaWNlIHRpY2tzIGZvciBleHRlbmRpbmcgZG9tYWluIGxpa2UgYWxsIHRoZSBvdGhlciBheGVzIGRvLgogICAgICogTm90IHJlYWxseSBzdXJlIHdoeT8gSXMgdGhlcmUgYSBnb29kIHJlYXNvbiwKICAgICAqIG9yIGlzIGl0IGp1c3QgYmVjYXVzZSBzb21lb25lIGFkZGVkIHN1cHBvcnQgZm9yIG5pY2UgdGlja3MgdG8gdGhlIG90aGVyIGF4ZXMgYW5kIGZvcmdvdCB0aGlzIG9uZT8KICAgICAqLwogICAgYXhpc1R5cGUgIT09ICJhbmdsZUF4aXMiICYmIChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MudHlwZSkgPT09ICJudW1iZXIiICYmIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihkb21haW4pICYmIEFycmF5LmlzQXJyYXkobmljZVRpY2tzKSAmJiBuaWNlVGlja3MubGVuZ3RoID4gMAogICkgewogICAgdmFyIG1pbkZyb21Eb21haW4gPSBkb21haW5bMF07CiAgICB2YXIgbWluRnJvbVRpY2tzID0gbmljZVRpY2tzWzBdOwogICAgdmFyIG1heEZyb21Eb21haW4gPSBkb21haW5bMV07CiAgICB2YXIgbWF4RnJvbVRpY2tzID0gbmljZVRpY2tzW25pY2VUaWNrcy5sZW5ndGggLSAxXTsKICAgIHJldHVybiBbTWF0aC5taW4obWluRnJvbURvbWFpbiwgbWluRnJvbVRpY2tzKSwgTWF0aC5tYXgobWF4RnJvbURvbWFpbiwgbWF4RnJvbVRpY2tzKV07CiAgfQogIHJldHVybiBkb21haW47Cn07CnZhciBzZWxlY3RBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzRG9tYWluLCBzZWxlY3ROaWNlVGlja3MsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVBeGlzRG9tYWluV2l0aE5pY2VUaWNrcyk7CnZhciBzZWxlY3RTbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMsIHNlbGVjdEJhc2VBeGlzLCAoYWxsRGF0YVNxdWlzaGVkLCBheGlzU2V0dGluZ3MpID0+IHsKICBpZiAoIWF4aXNTZXR0aW5ncyB8fCBheGlzU2V0dGluZ3MudHlwZSAhPT0gIm51bWJlciIpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBzbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcyA9IEluZmluaXR5OwogIHZhciBzb3J0ZWRWYWx1ZXMgPSBBcnJheS5mcm9tKG9ubHlBbGxvd051bWJlcnMoYWxsRGF0YVNxdWlzaGVkLm1hcCgoZCkgPT4gZC52YWx1ZSkpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHNvcnRlZFZhbHVlcy5sZW5ndGggPCAyKSB7CiAgICByZXR1cm4gSW5maW5pdHk7CiAgfQogIHZhciBkaWZmID0gc29ydGVkVmFsdWVzW3NvcnRlZFZhbHVlcy5sZW5ndGggLSAxXSAtIHNvcnRlZFZhbHVlc1swXTsKICBpZiAoZGlmZiA9PT0gMCkgewogICAgcmV0dXJuIEluZmluaXR5OwogIH0KICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRlZFZhbHVlcy5sZW5ndGggLSAxOyBpKyspIHsKICAgIHZhciBkaXN0YW5jZSA9IHNvcnRlZFZhbHVlc1tpICsgMV0gLSBzb3J0ZWRWYWx1ZXNbaV07CiAgICBzbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcyA9IE1hdGgubWluKHNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzLCBkaXN0YW5jZSk7CiAgfQogIHJldHVybiBzbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcyAvIGRpZmY7Cn0pOwp2YXIgc2VsZWN0Q2FsY3VsYXRlZFBhZGRpbmcgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RTbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEJhckNhdGVnb3J5R2FwLCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCAoXzEsIF8yLCBfMywgcGFkZGluZykgPT4gcGFkZGluZywgKHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQsIGxheW91dCwgYmFyQ2F0ZWdvcnlHYXAsIG9mZnNldCwgcGFkZGluZykgPT4gewogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50KSkgewogICAgcmV0dXJuIDA7CiAgfQogIHZhciByYW5nZVdpZHRoID0gbGF5b3V0ID09PSAidmVydGljYWwiID8gb2Zmc2V0LmhlaWdodCA6IG9mZnNldC53aWR0aDsKICBpZiAocGFkZGluZyA9PT0gImdhcCIpIHsKICAgIHJldHVybiBzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50ICogcmFuZ2VXaWR0aCAvIDI7CiAgfQogIGlmIChwYWRkaW5nID09PSAibm8tZ2FwIikgewogICAgdmFyIGdhcCA9IGdldFBlcmNlbnRWYWx1ZShiYXJDYXRlZ29yeUdhcCwgc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCAqIHJhbmdlV2lkdGgpOwogICAgdmFyIGhhbGZCYW5kID0gc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCAqIHJhbmdlV2lkdGggLyAyOwogICAgcmV0dXJuIGhhbGZCYW5kIC0gZ2FwIC0gKGhhbGZCYW5kIC0gZ2FwKSAvIHJhbmdlV2lkdGggKiBnYXA7CiAgfQogIHJldHVybiAwOwp9KTsKdmFyIHNlbGVjdENhbGN1bGF0ZWRYQXhpc1BhZGRpbmcgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciB4QXhpc1NldHRpbmdzID0gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoeEF4aXNTZXR0aW5ncyA9PSBudWxsIHx8IHR5cGVvZiB4QXhpc1NldHRpbmdzLnBhZGRpbmcgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gMDsKICB9CiAgcmV0dXJuIHNlbGVjdENhbGN1bGF0ZWRQYWRkaW5nKHN0YXRlLCAieEF4aXMiLCBheGlzSWQsIHhBeGlzU2V0dGluZ3MucGFkZGluZyk7Cn07CnZhciBzZWxlY3RDYWxjdWxhdGVkWUF4aXNQYWRkaW5nID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgeUF4aXNTZXR0aW5ncyA9IHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKHlBeGlzU2V0dGluZ3MgPT0gbnVsbCB8fCB0eXBlb2YgeUF4aXNTZXR0aW5ncy5wYWRkaW5nICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIDA7CiAgfQogIHJldHVybiBzZWxlY3RDYWxjdWxhdGVkUGFkZGluZyhzdGF0ZSwgInlBeGlzIiwgYXhpc0lkLCB5QXhpc1NldHRpbmdzLnBhZGRpbmcpOwp9Owp2YXIgc2VsZWN0WEF4aXNQYWRkaW5nID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0WEF4aXNTZXR0aW5ncywgc2VsZWN0Q2FsY3VsYXRlZFhBeGlzUGFkZGluZywgKHhBeGlzU2V0dGluZ3MsIGNhbGN1bGF0ZWQpID0+IHsKICB2YXIgX3BhZGRpbmckbGVmdCwgX3BhZGRpbmckcmlnaHQ7CiAgaWYgKHhBeGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgbGVmdDogMCwKICAgICAgcmlnaHQ6IDAKICAgIH07CiAgfQogIHZhciB7CiAgICBwYWRkaW5nCiAgfSA9IHhBeGlzU2V0dGluZ3M7CiAgaWYgKHR5cGVvZiBwYWRkaW5nID09PSAic3RyaW5nIikgewogICAgcmV0dXJuIHsKICAgICAgbGVmdDogY2FsY3VsYXRlZCwKICAgICAgcmlnaHQ6IGNhbGN1bGF0ZWQKICAgIH07CiAgfQogIHJldHVybiB7CiAgICBsZWZ0OiAoKF9wYWRkaW5nJGxlZnQgPSBwYWRkaW5nLmxlZnQpICE9PSBudWxsICYmIF9wYWRkaW5nJGxlZnQgIT09IHZvaWQgMCA/IF9wYWRkaW5nJGxlZnQgOiAwKSArIGNhbGN1bGF0ZWQsCiAgICByaWdodDogKChfcGFkZGluZyRyaWdodCA9IHBhZGRpbmcucmlnaHQpICE9PSBudWxsICYmIF9wYWRkaW5nJHJpZ2h0ICE9PSB2b2lkIDAgPyBfcGFkZGluZyRyaWdodCA6IDApICsgY2FsY3VsYXRlZAogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNQYWRkaW5nID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0WUF4aXNTZXR0aW5ncywgc2VsZWN0Q2FsY3VsYXRlZFlBeGlzUGFkZGluZywgKHlBeGlzU2V0dGluZ3MsIGNhbGN1bGF0ZWQpID0+IHsKICB2YXIgX3BhZGRpbmckdG9wLCBfcGFkZGluZyRib3R0b207CiAgaWYgKHlBeGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgdG9wOiAwLAogICAgICBib3R0b206IDAKICAgIH07CiAgfQogIHZhciB7CiAgICBwYWRkaW5nCiAgfSA9IHlBeGlzU2V0dGluZ3M7CiAgaWYgKHR5cGVvZiBwYWRkaW5nID09PSAic3RyaW5nIikgewogICAgcmV0dXJuIHsKICAgICAgdG9wOiBjYWxjdWxhdGVkLAogICAgICBib3R0b206IGNhbGN1bGF0ZWQKICAgIH07CiAgfQogIHJldHVybiB7CiAgICB0b3A6ICgoX3BhZGRpbmckdG9wID0gcGFkZGluZy50b3ApICE9PSBudWxsICYmIF9wYWRkaW5nJHRvcCAhPT0gdm9pZCAwID8gX3BhZGRpbmckdG9wIDogMCkgKyBjYWxjdWxhdGVkLAogICAgYm90dG9tOiAoKF9wYWRkaW5nJGJvdHRvbSA9IHBhZGRpbmcuYm90dG9tKSAhPT0gbnVsbCAmJiBfcGFkZGluZyRib3R0b20gIT09IHZvaWQgMCA/IF9wYWRkaW5nJGJvdHRvbSA6IDApICsgY2FsY3VsYXRlZAogIH07Cn0pOwp2YXIgY29tYmluZVhBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WEF4aXNQYWRkaW5nLCBzZWxlY3RCcnVzaERpbWVuc2lvbnMsIHNlbGVjdEJydXNoU2V0dGluZ3MsIChfc3RhdGUsIF9heGlzSWQsIGlzUGFub3JhbWEpID0+IGlzUGFub3JhbWFdLCAob2Zmc2V0LCBwYWRkaW5nLCBicnVzaERpbWVuc2lvbnMsIF9yZWY0LCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIHsKICAgIHBhZGRpbmc6IGJydXNoUGFkZGluZwogIH0gPSBfcmVmNDsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIFticnVzaFBhZGRpbmcubGVmdCwgYnJ1c2hEaW1lbnNpb25zLndpZHRoIC0gYnJ1c2hQYWRkaW5nLnJpZ2h0XTsKICB9CiAgcmV0dXJuIFtvZmZzZXQubGVmdCArIHBhZGRpbmcubGVmdCwgb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGggLSBwYWRkaW5nLnJpZ2h0XTsKfSk7CnZhciBjb21iaW5lWUF4aXNSYW5nZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0WUF4aXNQYWRkaW5nLCBzZWxlY3RCcnVzaERpbWVuc2lvbnMsIHNlbGVjdEJydXNoU2V0dGluZ3MsIChfc3RhdGUsIF9heGlzSWQsIGlzUGFub3JhbWEpID0+IGlzUGFub3JhbWFdLCAob2Zmc2V0LCBsYXlvdXQsIHBhZGRpbmcsIGJydXNoRGltZW5zaW9ucywgX3JlZjUsIGlzUGFub3JhbWEpID0+IHsKICB2YXIgewogICAgcGFkZGluZzogYnJ1c2hQYWRkaW5nCiAgfSA9IF9yZWY1OwogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gW2JydXNoRGltZW5zaW9ucy5oZWlnaHQgLSBicnVzaFBhZGRpbmcuYm90dG9tLCBicnVzaFBhZGRpbmcudG9wXTsKICB9CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gW29mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0IC0gcGFkZGluZy5ib3R0b20sIG9mZnNldC50b3AgKyBwYWRkaW5nLnRvcF07CiAgfQogIHJldHVybiBbb2Zmc2V0LnRvcCArIHBhZGRpbmcudG9wLCBvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCAtIHBhZGRpbmcuYm90dG9tXTsKfSk7CnZhciBzZWxlY3RBeGlzUmFuZ2UgPSAoc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQsIGlzUGFub3JhbWEpID0+IHsKICB2YXIgX3NlbGVjdFpBeGlzU2V0dGluZ3M7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOgogICAgICByZXR1cm4gY29tYmluZVhBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgICBjYXNlICJ5QXhpcyI6CiAgICAgIHJldHVybiBjb21iaW5lWUF4aXNSYW5nZShzdGF0ZSwgYXhpc0lkLCBpc1Bhbm9yYW1hKTsKICAgIGNhc2UgInpBeGlzIjoKICAgICAgcmV0dXJuIChfc2VsZWN0WkF4aXNTZXR0aW5ncyA9IHNlbGVjdFpBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCkpID09PSBudWxsIHx8IF9zZWxlY3RaQXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfc2VsZWN0WkF4aXNTZXR0aW5ncy5yYW5nZTsKICAgIGNhc2UgImFuZ2xlQXhpcyI6CiAgICAgIHJldHVybiBzZWxlY3RBbmdsZUF4aXNSYW5nZShzdGF0ZSk7CiAgICBjYXNlICJyYWRpdXNBeGlzIjoKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXNSYW5nZShzdGF0ZSwgYXhpc0lkKTsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiB2b2lkIDA7CiAgfQp9Owp2YXIgc2VsZWN0QXhpc1JhbmdlV2l0aFJldmVyc2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RBeGlzU2NhbGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdFJlYWxTY2FsZVR5cGUsIHNlbGVjdEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MsIHNlbGVjdEF4aXNSYW5nZVdpdGhSZXZlcnNlXSwgY29tYmluZVNjYWxlRnVuY3Rpb24pOwp2YXIgc2VsZWN0RXJyb3JCYXJzU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5ncywgc2VsZWN0QWxsRXJyb3JCYXJTZXR0aW5ncywgcGlja0F4aXNUeXBlXSwgY29tYmluZVJlbGV2YW50RXJyb3JCYXJTZXR0aW5ncyk7CmZ1bmN0aW9uIGNvbXBhcmVJZHMoYSwgYikgewogIGlmIChhLmlkIDwgYi5pZCkgewogICAgcmV0dXJuIC0xOwogIH0KICBpZiAoYS5pZCA+IGIuaWQpIHsKICAgIHJldHVybiAxOwogIH0KICByZXR1cm4gMDsKfQp2YXIgcGlja0F4aXNPcmllbnRhdGlvbiA9IChfc3RhdGUsIG9yaWVudGF0aW9uKSA9PiBvcmllbnRhdGlvbjsKdmFyIHBpY2tNaXJyb3IgPSAoX3N0YXRlLCBfb3JpZW50YXRpb24sIG1pcnJvcikgPT4gbWlycm9yOwp2YXIgc2VsZWN0QWxsWEF4ZXNXaXRoT2Zmc2V0VHlwZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdEFsbFhBeGVzLCBwaWNrQXhpc09yaWVudGF0aW9uLCBwaWNrTWlycm9yLCAoYWxsQXhlcywgb3JpZW50YXRpb24sIG1pcnJvcikgPT4gYWxsQXhlcy5maWx0ZXIoKGF4aXMpID0+IGF4aXMub3JpZW50YXRpb24gPT09IG9yaWVudGF0aW9uKS5maWx0ZXIoKGF4aXMpID0+IGF4aXMubWlycm9yID09PSBtaXJyb3IpLnNvcnQoY29tcGFyZUlkcykpOwp2YXIgc2VsZWN0QWxsWUF4ZXNXaXRoT2Zmc2V0VHlwZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdEFsbFlBeGVzLCBwaWNrQXhpc09yaWVudGF0aW9uLCBwaWNrTWlycm9yLCAoYWxsQXhlcywgb3JpZW50YXRpb24sIG1pcnJvcikgPT4gYWxsQXhlcy5maWx0ZXIoKGF4aXMpID0+IGF4aXMub3JpZW50YXRpb24gPT09IG9yaWVudGF0aW9uKS5maWx0ZXIoKGF4aXMpID0+IGF4aXMubWlycm9yID09PSBtaXJyb3IpLnNvcnQoY29tcGFyZUlkcykpOwp2YXIgZ2V0WEF4aXNTaXplID0gKG9mZnNldCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgcmV0dXJuIHsKICAgIHdpZHRoOiBvZmZzZXQud2lkdGgsCiAgICBoZWlnaHQ6IGF4aXNTZXR0aW5ncy5oZWlnaHQKICB9Owp9Owp2YXIgZ2V0WUF4aXNTaXplID0gKG9mZnNldCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgdmFyIHdpZHRoID0gdHlwZW9mIGF4aXNTZXR0aW5ncy53aWR0aCA9PT0gIm51bWJlciIgPyBheGlzU2V0dGluZ3Mud2lkdGggOiBERUZBVUxUX1lfQVhJU19XSURUSDsKICByZXR1cm4gewogICAgd2lkdGgsCiAgICBoZWlnaHQ6IG9mZnNldC5oZWlnaHQKICB9Owp9Owp2YXIgc2VsZWN0WEF4aXNTaXplID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WEF4aXNTZXR0aW5ncywgZ2V0WEF4aXNTaXplKTsKdmFyIGNvbWJpbmVYQXhpc1Bvc2l0aW9uU3RhcnRpbmdQb2ludCA9IChvZmZzZXQsIG9yaWVudGF0aW9uLCBjaGFydEhlaWdodCkgPT4gewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgInRvcCI6CiAgICAgIHJldHVybiBvZmZzZXQudG9wOwogICAgY2FzZSAiYm90dG9tIjoKICAgICAgcmV0dXJuIGNoYXJ0SGVpZ2h0IC0gb2Zmc2V0LmJvdHRvbTsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiAwOwogIH0KfTsKdmFyIGNvbWJpbmVZQXhpc1Bvc2l0aW9uU3RhcnRpbmdQb2ludCA9IChvZmZzZXQsIG9yaWVudGF0aW9uLCBjaGFydFdpZHRoKSA9PiB7CiAgc3dpdGNoIChvcmllbnRhdGlvbikgewogICAgY2FzZSAibGVmdCI6CiAgICAgIHJldHVybiBvZmZzZXQubGVmdDsKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgcmV0dXJuIGNoYXJ0V2lkdGggLSBvZmZzZXQucmlnaHQ7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gMDsKICB9Cn07CnZhciBzZWxlY3RBbGxYQXhlc09mZnNldFN0ZXBzID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRIZWlnaHQsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdEFsbFhBeGVzV2l0aE9mZnNldFR5cGUsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChjaGFydEhlaWdodCwgb2Zmc2V0LCBhbGxBeGVzV2l0aFNhbWVPZmZzZXRUeXBlLCBvcmllbnRhdGlvbiwgbWlycm9yKSA9PiB7CiAgdmFyIHN0ZXBzID0ge307CiAgdmFyIHBvc2l0aW9uOwogIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUuZm9yRWFjaCgoYXhpcykgPT4gewogICAgdmFyIGF4aXNTaXplID0gZ2V0WEF4aXNTaXplKG9mZnNldCwgYXhpcyk7CiAgICBpZiAocG9zaXRpb24gPT0gbnVsbCkgewogICAgICBwb3NpdGlvbiA9IGNvbWJpbmVYQXhpc1Bvc2l0aW9uU3RhcnRpbmdQb2ludChvZmZzZXQsIG9yaWVudGF0aW9uLCBjaGFydEhlaWdodCk7CiAgICB9CiAgICB2YXIgbmVlZFNwYWNlID0gb3JpZW50YXRpb24gPT09ICJ0b3AiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iICYmIG1pcnJvcjsKICAgIHN0ZXBzW2F4aXMuaWRdID0gcG9zaXRpb24gLSBOdW1iZXIobmVlZFNwYWNlKSAqIGF4aXNTaXplLmhlaWdodDsKICAgIHBvc2l0aW9uICs9IChuZWVkU3BhY2UgPyAtMSA6IDEpICogYXhpc1NpemUuaGVpZ2h0OwogIH0pOwogIHJldHVybiBzdGVwczsKfSk7CnZhciBzZWxlY3RBbGxZQXhlc09mZnNldFN0ZXBzID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0QWxsWUF4ZXNXaXRoT2Zmc2V0VHlwZSwgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGNoYXJ0V2lkdGgsIG9mZnNldCwgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZSwgb3JpZW50YXRpb24sIG1pcnJvcikgPT4gewogIHZhciBzdGVwcyA9IHt9OwogIHZhciBwb3NpdGlvbjsKICBhbGxBeGVzV2l0aFNhbWVPZmZzZXRUeXBlLmZvckVhY2goKGF4aXMpID0+IHsKICAgIHZhciBheGlzU2l6ZSA9IGdldFlBeGlzU2l6ZShvZmZzZXQsIGF4aXMpOwogICAgaWYgKHBvc2l0aW9uID09IG51bGwpIHsKICAgICAgcG9zaXRpb24gPSBjb21iaW5lWUF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRXaWR0aCk7CiAgICB9CiAgICB2YXIgbmVlZFNwYWNlID0gb3JpZW50YXRpb24gPT09ICJsZWZ0IiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAicmlnaHQiICYmIG1pcnJvcjsKICAgIHN0ZXBzW2F4aXMuaWRdID0gcG9zaXRpb24gLSBOdW1iZXIobmVlZFNwYWNlKSAqIGF4aXNTaXplLndpZHRoOwogICAgcG9zaXRpb24gKz0gKG5lZWRTcGFjZSA/IC0xIDogMSkgKiBheGlzU2l6ZS53aWR0aDsKICB9KTsKICByZXR1cm4gc3RlcHM7Cn0pOwp2YXIgc2VsZWN0WEF4aXNPZmZzZXRTdGVwcyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXNTZXR0aW5ncyA9IHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gc2VsZWN0QWxsWEF4ZXNPZmZzZXRTdGVwcyhzdGF0ZSwgYXhpc1NldHRpbmdzLm9yaWVudGF0aW9uLCBheGlzU2V0dGluZ3MubWlycm9yKTsKfTsKdmFyIHNlbGVjdFhBeGlzUG9zaXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WEF4aXNTZXR0aW5ncywgc2VsZWN0WEF4aXNPZmZzZXRTdGVwcywgKF8sIGF4aXNJZCkgPT4gYXhpc0lkXSwgKG9mZnNldCwgYXhpc1NldHRpbmdzLCBhbGxTdGVwcywgYXhpc0lkKSA9PiB7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc3RlcE9mVGhpc0F4aXMgPSBhbGxTdGVwcyA9PT0gbnVsbCB8fCBhbGxTdGVwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWxsU3RlcHNbYXhpc0lkXTsKICBpZiAoc3RlcE9mVGhpc0F4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgeDogb2Zmc2V0LmxlZnQsCiAgICAgIHk6IDAKICAgIH07CiAgfQogIHJldHVybiB7CiAgICB4OiBvZmZzZXQubGVmdCwKICAgIHk6IHN0ZXBPZlRoaXNBeGlzCiAgfTsKfSk7CnZhciBzZWxlY3RZQXhpc09mZnNldFN0ZXBzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpc1NldHRpbmdzID0gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBzZWxlY3RBbGxZQXhlc09mZnNldFN0ZXBzKHN0YXRlLCBheGlzU2V0dGluZ3Mub3JpZW50YXRpb24sIGF4aXNTZXR0aW5ncy5taXJyb3IpOwp9Owp2YXIgc2VsZWN0WUF4aXNQb3NpdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RZQXhpc1NldHRpbmdzLCBzZWxlY3RZQXhpc09mZnNldFN0ZXBzLCAoXywgYXhpc0lkKSA9PiBheGlzSWRdLCAob2Zmc2V0LCBheGlzU2V0dGluZ3MsIGFsbFN0ZXBzLCBheGlzSWQpID0+IHsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBzdGVwT2ZUaGlzQXhpcyA9IGFsbFN0ZXBzID09PSBudWxsIHx8IGFsbFN0ZXBzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhbGxTdGVwc1theGlzSWRdOwogIGlmIChzdGVwT2ZUaGlzQXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICB4OiAwLAogICAgICB5OiBvZmZzZXQudG9wCiAgICB9OwogIH0KICByZXR1cm4gewogICAgeDogc3RlcE9mVGhpc0F4aXMsCiAgICB5OiBvZmZzZXQudG9wCiAgfTsKfSk7CnZhciBzZWxlY3RZQXhpc1NpemUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RZQXhpc1NldHRpbmdzLCAob2Zmc2V0LCBheGlzU2V0dGluZ3MpID0+IHsKICB2YXIgd2lkdGggPSB0eXBlb2YgYXhpc1NldHRpbmdzLndpZHRoID09PSAibnVtYmVyIiA/IGF4aXNTZXR0aW5ncy53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogIHJldHVybiB7CiAgICB3aWR0aCwKICAgIGhlaWdodDogb2Zmc2V0LmhlaWdodAogIH07Cn0pOwp2YXIgY29tYmluZUR1cGxpY2F0ZURvbWFpbiA9IChjaGFydExheW91dCwgYXBwbGllZFZhbHVlcywgYXhpcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgICB0eXBlLAogICAgZGF0YUtleQogIH0gPSBheGlzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMoY2hhcnRMYXlvdXQsIGF4aXNUeXBlKTsKICB2YXIgYWxsRGF0YSA9IGFwcGxpZWRWYWx1ZXMubWFwKChhdikgPT4gYXYudmFsdWUpOwogIGlmIChkYXRhS2V5ICYmIGlzQ2F0ZWdvcmljYWwgJiYgdHlwZSA9PT0gImNhdGVnb3J5IiAmJiBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSAmJiBoYXNEdXBsaWNhdGUoYWxsRGF0YSkpIHsKICAgIHJldHVybiBhbGxEYXRhOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0RHVwbGljYXRlRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBbGxBcHBsaWVkVmFsdWVzLCBzZWxlY3RCYXNlQXhpcywgcGlja0F4aXNUeXBlXSwgY29tYmluZUR1cGxpY2F0ZURvbWFpbik7CnZhciBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4gPSAobGF5b3V0LCBhcHBsaWVkVmFsdWVzLCBheGlzLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgYXhpcy5kYXRhS2V5ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICB0eXBlLAogICAgc2NhbGUKICB9ID0gYXhpczsKICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIGlmIChpc0NhdGVnb3JpY2FsICYmICh0eXBlID09PSAibnVtYmVyIiB8fCBzY2FsZSAhPT0gImF1dG8iKSkgewogICAgcmV0dXJuIGFwcGxpZWRWYWx1ZXMubWFwKChkKSA9PiBkLnZhbHVlKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBbGxBcHBsaWVkVmFsdWVzLCBzZWxlY3RBeGlzU2V0dGluZ3MsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVDYXRlZ29yaWNhbERvbWFpbik7CnZhciBzZWxlY3RBeGlzUHJvcHNOZWVkZWRGb3JDYXJ0ZXNpYW5HcmlkVGlja3NHZW5lcmF0b3IgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdENhcnRlc2lhbkF4aXNTZXR0aW5ncywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc1NjYWxlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBzZWxlY3RBeGlzUmFuZ2UsIHNlbGVjdE5pY2VUaWNrcywgcGlja0F4aXNUeXBlXSwgKGxheW91dCwgYXhpcywgcmVhbFNjYWxlVHlwZSwgc2NhbGUsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNSYW5nZSwgbmljZVRpY2tzLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgcmV0dXJuIHsKICAgIGFuZ2xlOiBheGlzLmFuZ2xlLAogICAgaW50ZXJ2YWw6IGF4aXMuaW50ZXJ2YWwsCiAgICBtaW5UaWNrR2FwOiBheGlzLm1pblRpY2tHYXAsCiAgICBvcmllbnRhdGlvbjogYXhpcy5vcmllbnRhdGlvbiwKICAgIHRpY2s6IGF4aXMudGljaywKICAgIHRpY2tDb3VudDogYXhpcy50aWNrQ291bnQsCiAgICB0aWNrRm9ybWF0dGVyOiBheGlzLnRpY2tGb3JtYXR0ZXIsCiAgICB0aWNrczogYXhpcy50aWNrcywKICAgIHR5cGU6IGF4aXMudHlwZSwKICAgIHVuaXQ6IGF4aXMudW5pdCwKICAgIGF4aXNUeXBlLAogICAgY2F0ZWdvcmljYWxEb21haW4sCiAgICBkdXBsaWNhdGVEb21haW4sCiAgICBpc0NhdGVnb3JpY2FsLAogICAgbmljZVRpY2tzLAogICAgcmFuZ2U6IGF4aXNSYW5nZSwKICAgIHJlYWxTY2FsZVR5cGUsCiAgICBzY2FsZQogIH07Cn0pOwp2YXIgY29tYmluZUF4aXNUaWNrcyA9IChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCBuaWNlVGlja3MsIGF4aXNSYW5nZSwgZHVwbGljYXRlRG9tYWluLCBjYXRlZ29yaWNhbERvbWFpbiwgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgdmFyIHsKICAgIHR5cGUsCiAgICB0aWNrczogdGlja3MyLAogICAgdGlja0NvdW50CiAgfSA9IGF4aXM7CiAgdmFyIG9mZnNldEZvckJhbmQgPSByZWFsU2NhbGVUeXBlID09PSAic2NhbGVCYW5kIiAmJiB0eXBlb2Ygc2NhbGUuYmFuZHdpZHRoID09PSAiZnVuY3Rpb24iID8gc2NhbGUuYmFuZHdpZHRoKCkgLyAyIDogMjsKICB2YXIgb2Zmc2V0ID0gdHlwZSA9PT0gImNhdGVnb3J5IiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIG9mZnNldEZvckJhbmQgOiAwOwogIG9mZnNldCA9IGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiBheGlzUmFuZ2UgIT0gbnVsbCAmJiBheGlzUmFuZ2UubGVuZ3RoID49IDIgPyBtYXRoU2lnbihheGlzUmFuZ2VbMF0gLSBheGlzUmFuZ2VbMV0pICogMiAqIG9mZnNldCA6IG9mZnNldDsKICB2YXIgdGlja3NPck5pY2VUaWNrcyA9IHRpY2tzMiB8fCBuaWNlVGlja3M7CiAgaWYgKHRpY2tzT3JOaWNlVGlja3MpIHsKICAgIHZhciByZXN1bHQgPSB0aWNrc09yTmljZVRpY2tzLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgIHZhciBzY2FsZUNvbnRlbnQgPSBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW4uaW5kZXhPZihlbnRyeSkgOiBlbnRyeTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbmRleCwKICAgICAgICAvLyBJZiB0aGUgc2NhbGVDb250ZW50IGlzIG5vdCBhIG51bWJlciwgdGhlIGNvb3JkaW5hdGUgd2lsbCBiZSBOYU4uCiAgICAgICAgLy8gVGhhdCBjb3VsZCBiZSB0aGUgY2FzZSBmb3IgZXhhbXBsZSB3aXRoIGEgUG9pbnRTY2FsZSBhbmQgYSBzdHJpbmcgYXMgZG9tYWluLgogICAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKHNjYWxlQ29udGVudCkgKyBvZmZzZXQsCiAgICAgICAgdmFsdWU6IGVudHJ5LAogICAgICAgIG9mZnNldAogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LmZpbHRlcigocm93KSA9PiBpc1dlbGxCZWhhdmVkTnVtYmVyKHJvdy5jb29yZGluYXRlKSk7CiAgfQogIGlmIChpc0NhdGVnb3JpY2FsICYmIGNhdGVnb3JpY2FsRG9tYWluKSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW4ubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBpbmRleCwKICAgICAgb2Zmc2V0CiAgICB9KSkuZmlsdGVyKChyb3cpID0+IGlzV2VsbEJlaGF2ZWROdW1iZXIocm93LmNvb3JkaW5hdGUpKTsKICB9CiAgaWYgKHNjYWxlLnRpY2tzKSB7CiAgICByZXR1cm4gc2NhbGUudGlja3ModGlja0NvdW50KS5tYXAoKGVudHJ5KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIHJldHVybiBzY2FsZS5kb21haW4oKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgIHZhbHVlOiBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW5bZW50cnldIDogZW50cnksCiAgICBpbmRleCwKICAgIG9mZnNldAogIH0pKTsKfTsKdmFyIHNlbGVjdFRpY2tzT2ZBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBeGlzU2V0dGluZ3MsIHNlbGVjdFJlYWxTY2FsZVR5cGUsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0TmljZVRpY2tzLCBzZWxlY3RBeGlzUmFuZ2UsIHNlbGVjdER1cGxpY2F0ZURvbWFpbiwgc2VsZWN0Q2F0ZWdvcmljYWxEb21haW4sIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVBeGlzVGlja3MpOwp2YXIgY29tYmluZUdyYXBoaWNhbEl0ZW1UaWNrcyA9IChsYXlvdXQsIGF4aXMsIHNjYWxlLCBheGlzUmFuZ2UsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBzY2FsZSA9PSBudWxsIHx8IGF4aXNSYW5nZSA9PSBudWxsIHx8IGF4aXNSYW5nZVswXSA9PT0gYXhpc1JhbmdlWzFdKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHZhciB7CiAgICB0aWNrQ291bnQKICB9ID0gYXhpczsKICB2YXIgb2Zmc2V0ID0gMDsKICBvZmZzZXQgPSBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgKGF4aXNSYW5nZSA9PT0gbnVsbCB8fCBheGlzUmFuZ2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNSYW5nZS5sZW5ndGgpID49IDIgPyBtYXRoU2lnbihheGlzUmFuZ2VbMF0gLSBheGlzUmFuZ2VbMV0pICogMiAqIG9mZnNldCA6IG9mZnNldDsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICBpZiAoc2NhbGUudGlja3MpIHsKICAgIHJldHVybiBzY2FsZS50aWNrcyh0aWNrQ291bnQpLm1hcCgoZW50cnkpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgc2VsZWN0VGlja3NPZkdyYXBoaWNhbEl0ZW0gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEF4aXNTZXR0aW5ncywgc2VsZWN0QXhpc1NjYWxlLCBzZWxlY3RBeGlzUmFuZ2UsIHNlbGVjdER1cGxpY2F0ZURvbWFpbiwgc2VsZWN0Q2F0ZWdvcmljYWxEb21haW4sIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVHcmFwaGljYWxJdGVtVGlja3MpOwp2YXIgc2VsZWN0QXhpc1dpdGhTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzU2NhbGUsIChheGlzLCBzY2FsZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMyhfb2JqZWN0U3ByZWFkMTMoe30sIGF4aXMpLCB7fSwgewogICAgc2NhbGUKICB9KTsKfSk7CnZhciBzZWxlY3RaQXhpc1NjYWxlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzRG9tYWluLCBzZWxlY3RBeGlzUmFuZ2VXaXRoUmV2ZXJzZV0sIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKTsKdmFyIHNlbGVjdFpBeGlzV2l0aFNjYWxlID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlLCBfYXhpc1R5cGUsIGF4aXNJZCkgPT4gc2VsZWN0WkF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKSwgc2VsZWN0WkF4aXNTY2FsZSwgKGF4aXMsIHNjYWxlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBzY2FsZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gX29iamVjdFNwcmVhZDEzKF9vYmplY3RTcHJlYWQxMyh7fSwgYXhpcyksIHt9LCB7CiAgICBzY2FsZQogIH0pOwp9KTsKdmFyIHNlbGVjdENoYXJ0RGlyZWN0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBbGxYQXhlcywgc2VsZWN0QWxsWUF4ZXNdLCAobGF5b3V0LCBhbGxYQXhlcywgYWxsWUF4ZXMpID0+IHsKICBzd2l0Y2ggKGxheW91dCkgewogICAgY2FzZSAiaG9yaXpvbnRhbCI6IHsKICAgICAgcmV0dXJuIGFsbFhBeGVzLnNvbWUoKGF4aXMpID0+IGF4aXMucmV2ZXJzZWQpID8gInJpZ2h0LXRvLWxlZnQiIDogImxlZnQtdG8tcmlnaHQiOwogICAgfQogICAgY2FzZSAidmVydGljYWwiOiB7CiAgICAgIHJldHVybiBhbGxZQXhlcy5zb21lKChheGlzKSA9PiBheGlzLnJldmVyc2VkKSA/ICJib3R0b20tdG8tdG9wIiA6ICJ0b3AtdG8tYm90dG9tIjsKICAgIH0KICAgIGNhc2UgImNlbnRyaWMiOgogICAgY2FzZSAicmFkaWFsIjogewogICAgICByZXR1cm4gImxlZnQtdG8tcmlnaHQiOwogICAgfQogICAgZGVmYXVsdDogewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwRXZlbnRUeXBlLmpzCnZhciBzZWxlY3REZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy5kZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTsKdmFyIHNlbGVjdFZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMudmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlczsKZnVuY3Rpb24gY29tYmluZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkLCBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcykgewogIGlmIChzaGFyZWQgPT0gbnVsbCkgewogICAgcmV0dXJuIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwogIH0KICB2YXIgZXZlbnRUeXBlID0gc2hhcmVkID8gImF4aXMiIDogIml0ZW0iOwogIGlmICh2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzID09IG51bGwpIHsKICAgIHJldHVybiBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTsKICB9CiAgcmV0dXJuIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMuaW5jbHVkZXMoZXZlbnRUeXBlKSA/IGV2ZW50VHlwZSA6IGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwp9CmZ1bmN0aW9uIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUsIHNoYXJlZCkgewogIHZhciBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSA9IHNlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlKHN0YXRlKTsKICB2YXIgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyA9IHNlbGVjdFZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMoc3RhdGUpOwogIHJldHVybiBjb21iaW5lVG9vbHRpcEV2ZW50VHlwZShzaGFyZWQsIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzKTsKfQpmdW5jdGlvbiB1c2VUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCkgewogIHJldHVybiB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUsIHNoYXJlZCkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUFjdGl2ZUxhYmVsLmpzCnZhciBjb21iaW5lQWN0aXZlTGFiZWwgPSAodG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCkgPT4gewogIHZhciBfdG9vbHRpcFRpY2tzJG47CiAgdmFyIG4gPSBOdW1iZXIoYWN0aXZlSW5kZXgpOwogIGlmIChpc05hbihuKSB8fCBhY3RpdmVJbmRleCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gbiA+PSAwID8gdG9vbHRpcFRpY2tzID09PSBudWxsIHx8IHRvb2x0aXBUaWNrcyA9PT0gdm9pZCAwIHx8IChfdG9vbHRpcFRpY2tzJG4gPSB0b29sdGlwVGlja3Nbbl0pID09PSBudWxsIHx8IF90b29sdGlwVGlja3MkbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Rvb2x0aXBUaWNrcyRuLnZhbHVlIDogdm9pZCAwOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcFNldHRpbmdzLmpzCnZhciBzZWxlY3RUb29sdGlwU2V0dGluZ3MgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3M7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3Rvb2x0aXBTbGljZS5qcwp2YXIgbm9JbnRlcmFjdGlvbiA9IHsKICBhY3RpdmU6IGZhbHNlLAogIGluZGV4OiBudWxsLAogIGRhdGFLZXk6IHZvaWQgMCwKICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMCwKICBjb29yZGluYXRlOiB2b2lkIDAKfTsKdmFyIGluaXRpYWxTdGF0ZTMgPSB7CiAgaXRlbUludGVyYWN0aW9uOiB7CiAgICBjbGljazogbm9JbnRlcmFjdGlvbiwKICAgIGhvdmVyOiBub0ludGVyYWN0aW9uCiAgfSwKICBheGlzSW50ZXJhY3Rpb246IHsKICAgIGNsaWNrOiBub0ludGVyYWN0aW9uLAogICAgaG92ZXI6IG5vSW50ZXJhY3Rpb24KICB9LAogIGtleWJvYXJkSW50ZXJhY3Rpb246IG5vSW50ZXJhY3Rpb24sCiAgc3luY0ludGVyYWN0aW9uOiB7CiAgICBhY3RpdmU6IGZhbHNlLAogICAgaW5kZXg6IG51bGwsCiAgICBkYXRhS2V5OiB2b2lkIDAsCiAgICBsYWJlbDogdm9pZCAwLAogICAgY29vcmRpbmF0ZTogdm9pZCAwLAogICAgc291cmNlVmlld0JveDogdm9pZCAwLAogICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICB9LAogIHRvb2x0aXBJdGVtUGF5bG9hZHM6IFtdLAogIHNldHRpbmdzOiB7CiAgICBzaGFyZWQ6IHZvaWQgMCwKICAgIHRyaWdnZXI6ICJob3ZlciIsCiAgICBheGlzSWQ6IDAsCiAgICBhY3RpdmU6IGZhbHNlLAogICAgZGVmYXVsdEluZGV4OiB2b2lkIDAKICB9Cn07CnZhciB0b29sdGlwU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInRvb2x0aXAiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMywKICByZWR1Y2VyczogewogICAgYWRkVG9vbHRpcEVudHJ5U2V0dGluZ3M6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VUb29sdGlwRW50cnlTZXR0aW5nczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkudG9vbHRpcEl0ZW1QYXlsb2Fkcy5pbmRleE9mKGNhc3REcmFmdChwcmV2KSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHNbaW5kZXhdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVUb29sdGlwRW50cnlTZXR0aW5nczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS50b29sdGlwSXRlbVBheWxvYWRzLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgc2V0VG9vbHRpcFNldHRpbmdzU3RhdGUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zZXR0aW5ncyA9IGFjdGlvbi5wYXlsb2FkOwogICAgfSwKICAgIHNldEFjdGl2ZU1vdXNlT3Zlckl0ZW1JbmRleChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5ncmFwaGljYWxJdGVtSWQgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVHcmFwaGljYWxJdGVtSWQ7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgIH0sCiAgICBtb3VzZUxlYXZlQ2hhcnQoc3RhdGUpIHsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gZmFsc2U7CiAgICB9LAogICAgbW91c2VMZWF2ZUl0ZW0oc3RhdGUpIHsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgfSwKICAgIHNldEFjdGl2ZUNsaWNrSXRlbUluZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmdyYXBoaWNhbEl0ZW1JZCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUdyYXBoaWNhbEl0ZW1JZDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIHNldE1vdXNlT3ZlckF4aXNJbmRleChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgIH0sCiAgICBzZXRNb3VzZUNsaWNrQXhpc0luZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIHNldFN5bmNJbnRlcmFjdGlvbihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbiA9IGFjdGlvbi5wYXlsb2FkOwogICAgfSwKICAgIHNldEtleWJvYXJkSW50ZXJhY3Rpb24oc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkVG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgcmVwbGFjZVRvb2x0aXBFbnRyeVNldHRpbmdzLAogIHJlbW92ZVRvb2x0aXBFbnRyeVNldHRpbmdzLAogIHNldFRvb2x0aXBTZXR0aW5nc1N0YXRlLAogIHNldEFjdGl2ZU1vdXNlT3Zlckl0ZW1JbmRleCwKICBtb3VzZUxlYXZlSXRlbSwKICBtb3VzZUxlYXZlQ2hhcnQsCiAgc2V0QWN0aXZlQ2xpY2tJdGVtSW5kZXgsCiAgc2V0TW91c2VPdmVyQXhpc0luZGV4LAogIHNldE1vdXNlQ2xpY2tBeGlzSW5kZXgsCiAgc2V0U3luY0ludGVyYWN0aW9uLAogIHNldEtleWJvYXJkSW50ZXJhY3Rpb24KfSA9IHRvb2x0aXBTbGljZS5hY3Rpb25zOwp2YXIgdG9vbHRpcFJlZHVjZXIgPSB0b29sdGlwU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUuanMKZnVuY3Rpb24gb3duS2V5czE0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGNob29zZUFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbih0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpIHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICBpZiAodHJpZ2dlciA9PT0gImNsaWNrIikgewogICAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljazsKICAgIH0KICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyOwogIH0KICBpZiAodHJpZ2dlciA9PT0gImNsaWNrIikgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2s7CiAgfQogIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyOwp9CmZ1bmN0aW9uIGhhc0JlZW5BY3RpdmVQcmV2aW91c2x5KHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKSB7CiAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmluZGV4ICE9IG51bGw7Cn0KdmFyIGNvbWJpbmVUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSA9ICh0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleCkgPT4gewogIGlmICh0b29sdGlwRXZlbnRUeXBlID09IG51bGwpIHsKICAgIHJldHVybiBub0ludGVyYWN0aW9uOwogIH0KICB2YXIgYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uID0gY2hvb3NlQXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKHRvb2x0aXBTdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcik7CiAgaWYgKGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gbm9JbnRlcmFjdGlvbjsKICB9CiAgaWYgKGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbi5hY3RpdmUpIHsKICAgIHJldHVybiBhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb247CiAgfQogIGlmICh0b29sdGlwU3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbjsKICB9CiAgaWYgKHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlICYmIHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb24uaW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb247CiAgfQogIHZhciBhY3RpdmVGcm9tUHJvcHMgPSB0b29sdGlwU3RhdGUuc2V0dGluZ3MuYWN0aXZlID09PSB0cnVlOwogIGlmIChoYXNCZWVuQWN0aXZlUHJldmlvdXNseShhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24pKSB7CiAgICBpZiAoYWN0aXZlRnJvbVByb3BzKSB7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTQoX29iamVjdFNwcmVhZDE0KHt9LCBhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24pLCB7fSwgewogICAgICAgIGFjdGl2ZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGRlZmF1bHRJbmRleCAhPSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICBhY3RpdmU6IHRydWUsCiAgICAgIGNvb3JkaW5hdGU6IHZvaWQgMCwKICAgICAgZGF0YUtleTogdm9pZCAwLAogICAgICBpbmRleDogZGVmYXVsdEluZGV4LAogICAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogICAgfTsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNChfb2JqZWN0U3ByZWFkMTQoe30sIG5vSW50ZXJhY3Rpb24pLCB7fSwgewogICAgY29vcmRpbmF0ZTogYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uLmNvb3JkaW5hdGUKICB9KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4LmpzCmZ1bmN0aW9uIHRvRmluaXRlTnVtYmVyKHZhbHVlKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiBOdW1iZXIuaXNGaW5pdGUodmFsdWUpID8gdmFsdWUgOiB2b2lkIDA7CiAgfQogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHZhciBudW1lcmljVmFsdWUgPSB2YWx1ZS52YWx1ZU9mKCk7CiAgICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKG51bWVyaWNWYWx1ZSkgPyBudW1lcmljVmFsdWUgOiB2b2lkIDA7CiAgfQogIHZhciBwYXJzZWQgPSBOdW1iZXIodmFsdWUpOwogIHJldHVybiBOdW1iZXIuaXNGaW5pdGUocGFyc2VkKSA/IHBhcnNlZCA6IHZvaWQgMDsKfQpmdW5jdGlvbiBpc1ZhbHVlV2l0aGluTnVtYmVyRG9tYWluKHZhbHVlLCBkb21haW4pIHsKICB2YXIgbnVtZXJpY1ZhbHVlID0gdG9GaW5pdGVOdW1iZXIodmFsdWUpOwogIHZhciBsb3dlckJvdW5kID0gZG9tYWluWzBdOwogIHZhciB1cHBlckJvdW5kID0gZG9tYWluWzFdOwogIGlmIChudW1lcmljVmFsdWUgPT09IHZvaWQgMCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgbWluMiA9IE1hdGgubWluKGxvd2VyQm91bmQsIHVwcGVyQm91bmQpOwogIHZhciBtYXgyID0gTWF0aC5tYXgobG93ZXJCb3VuZCwgdXBwZXJCb3VuZCk7CiAgcmV0dXJuIG51bWVyaWNWYWx1ZSA+PSBtaW4yICYmIG51bWVyaWNWYWx1ZSA8PSBtYXgyOwp9CmZ1bmN0aW9uIGlzVmFsdWVXaXRoaW5Eb21haW4oZW50cnksIGF4aXNEYXRhS2V5LCBkb21haW4pIHsKICBpZiAoZG9tYWluID09IG51bGwgfHwgYXhpc0RhdGFLZXkgPT0gbnVsbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHZhciB2YWx1ZSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBheGlzRGF0YUtleSk7CiAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAoIWlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihkb21haW4pKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGlzVmFsdWVXaXRoaW5OdW1iZXJEb21haW4odmFsdWUsIGRvbWFpbik7Cn0KdmFyIGNvbWJpbmVBY3RpdmVUb29sdGlwSW5kZXggPSAodG9vbHRpcEludGVyYWN0aW9uLCBjaGFydERhdGEsIGF4aXNEYXRhS2V5LCBkb21haW4pID0+IHsKICB2YXIgZGVzaXJlZEluZGV4ID0gdG9vbHRpcEludGVyYWN0aW9uID09PSBudWxsIHx8IHRvb2x0aXBJbnRlcmFjdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogdG9vbHRpcEludGVyYWN0aW9uLmluZGV4OwogIGlmIChkZXNpcmVkSW5kZXggPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBpbmRleEFzTnVtYmVyID0gTnVtYmVyKGRlc2lyZWRJbmRleCk7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKGluZGV4QXNOdW1iZXIpKSB7CiAgICByZXR1cm4gZGVzaXJlZEluZGV4OwogIH0KICB2YXIgbG93ZXJMaW1pdCA9IDA7CiAgdmFyIHVwcGVyTGltaXQgPSBJbmZpbml0eTsKICBpZiAoY2hhcnREYXRhLmxlbmd0aCA+IDApIHsKICAgIHVwcGVyTGltaXQgPSBjaGFydERhdGEubGVuZ3RoIC0gMTsKICB9CiAgdmFyIGNsYW1wZWRJbmRleCA9IE1hdGgubWF4KGxvd2VyTGltaXQsIE1hdGgubWluKGluZGV4QXNOdW1iZXIsIHVwcGVyTGltaXQpKTsKICB2YXIgZW50cnkgPSBjaGFydERhdGFbY2xhbXBlZEluZGV4XTsKICBpZiAoZW50cnkgPT0gbnVsbCkgewogICAgcmV0dXJuIFN0cmluZyhjbGFtcGVkSW5kZXgpOwogIH0KICBpZiAoIWlzVmFsdWVXaXRoaW5Eb21haW4oZW50cnksIGF4aXNEYXRhS2V5LCBkb21haW4pKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIFN0cmluZyhjbGFtcGVkSW5kZXgpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4LmpzCnZhciBjb21iaW5lQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCA9ICh3aWR0aCwgaGVpZ2h0LCBsYXlvdXQsIG9mZnNldCwgdG9vbHRpcFRpY2tzLCBkZWZhdWx0SW5kZXgsIHRvb2x0aXBDb25maWd1cmF0aW9ucywgdG9vbHRpcFBheWxvYWRTZWFyY2hlcikgPT4gewogIGlmIChkZWZhdWx0SW5kZXggPT0gbnVsbCB8fCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBmaXJzdENvbmZpZ3VyYXRpb24gPSB0b29sdGlwQ29uZmlndXJhdGlvbnNbMF07CiAgdmFyIG1heWJlUG9zaXRpb24gPSBmaXJzdENvbmZpZ3VyYXRpb24gPT0gbnVsbCA/IHZvaWQgMCA6IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIoZmlyc3RDb25maWd1cmF0aW9uLnBvc2l0aW9ucywgZGVmYXVsdEluZGV4KTsKICBpZiAobWF5YmVQb3NpdGlvbiAhPSBudWxsKSB7CiAgICByZXR1cm4gbWF5YmVQb3NpdGlvbjsKICB9CiAgdmFyIHRpY2sgPSB0b29sdGlwVGlja3MgPT09IG51bGwgfHwgdG9vbHRpcFRpY2tzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0b29sdGlwVGlja3NbTnVtYmVyKGRlZmF1bHRJbmRleCldOwogIGlmICghdGljaykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgc3dpdGNoIChsYXlvdXQpIHsKICAgIGNhc2UgImhvcml6b250YWwiOiB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogdGljay5jb29yZGluYXRlLAogICAgICAgIHk6IChvZmZzZXQudG9wICsgaGVpZ2h0KSAvIDIKICAgICAgfTsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiAob2Zmc2V0LmxlZnQgKyB3aWR0aCkgLyAyLAogICAgICAgIHk6IHRpY2suY29vcmRpbmF0ZQogICAgICB9OwogICAgfQogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucy5qcwp2YXIgY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMgPSAodG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXgpID0+IHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHM7CiAgfQogIGlmICh0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgdmFyIGZpbHRlckJ5RGF0YUtleTsKICBpZiAodHJpZ2dlciA9PT0gImhvdmVyIikgewogICAgZmlsdGVyQnlEYXRhS2V5ID0gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5OwogIH0gZWxzZSB7CiAgICBmaWx0ZXJCeURhdGFLZXkgPSB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXk7CiAgfQogIGlmIChmaWx0ZXJCeURhdGFLZXkgPT0gbnVsbCAmJiBkZWZhdWx0SW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIFt0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkc1swXV07CiAgfQogIHJldHVybiB0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5maWx0ZXIoKHRwYykgPT4gewogICAgdmFyIF90cGMkc2V0dGluZ3M7CiAgICByZXR1cm4gKChfdHBjJHNldHRpbmdzID0gdHBjLnNldHRpbmdzKSA9PT0gbnVsbCB8fCBfdHBjJHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdHBjJHNldHRpbmdzLmRhdGFLZXkpID09PSBmaWx0ZXJCeURhdGFLZXk7CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyLmpzCnZhciBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLnRvb2x0aXBQYXlsb2FkU2VhcmNoZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwU3RhdGUuanMKdmFyIHNlbGVjdFRvb2x0aXBTdGF0ZSA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcFBheWxvYWQuanMKZnVuY3Rpb24gb3duS2V5czE1KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTUoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTUoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTUoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTUocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTUodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTUodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIHNlbGVjdEZpbmFsRGF0YShkYXRhRGVmaW5lZE9uSXRlbSwgZGF0YURlZmluZWRPbkNoYXJ0KSB7CiAgaWYgKGRhdGFEZWZpbmVkT25JdGVtICE9IG51bGwpIHsKICAgIHJldHVybiBkYXRhRGVmaW5lZE9uSXRlbTsKICB9CiAgcmV0dXJuIGRhdGFEZWZpbmVkT25DaGFydDsKfQp2YXIgY29tYmluZVRvb2x0aXBQYXlsb2FkID0gKHRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMsIGFjdGl2ZUluZGV4LCBjaGFydERhdGFTdGF0ZSwgdG9vbHRpcEF4aXNEYXRhS2V5LCBhY3RpdmVMYWJlbCwgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwgdG9vbHRpcEV2ZW50VHlwZSkgPT4gewogIGlmIChhY3RpdmVJbmRleCA9PSBudWxsIHx8IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSwKICAgIGNvbXB1dGVkRGF0YSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IGNoYXJ0RGF0YVN0YXRlOwogIHZhciBpbml0ID0gW107CiAgcmV0dXJuIHRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMucmVkdWNlKChhZ2csIF9yZWYyKSA9PiB7CiAgICB2YXIgX3NldHRpbmdzJGRhdGFLZXk7CiAgICB2YXIgewogICAgICBkYXRhRGVmaW5lZE9uSXRlbSwKICAgICAgc2V0dGluZ3MKICAgIH0gPSBfcmVmMjsKICAgIHZhciBmaW5hbERhdGEgPSBzZWxlY3RGaW5hbERhdGEoZGF0YURlZmluZWRPbkl0ZW0sIGNoYXJ0RGF0YSk7CiAgICB2YXIgc2xpY2VkID0gQXJyYXkuaXNBcnJheShmaW5hbERhdGEpID8gZ2V0U2xpY2VkKGZpbmFsRGF0YSwgZGF0YVN0YXJ0SW5kZXgsIGRhdGFFbmRJbmRleCkgOiBmaW5hbERhdGE7CiAgICB2YXIgZmluYWxEYXRhS2V5ID0gKF9zZXR0aW5ncyRkYXRhS2V5ID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLmRhdGFLZXkpICE9PSBudWxsICYmIF9zZXR0aW5ncyRkYXRhS2V5ICE9PSB2b2lkIDAgPyBfc2V0dGluZ3MkZGF0YUtleSA6IHRvb2x0aXBBeGlzRGF0YUtleTsKICAgIHZhciBmaW5hbE5hbWVLZXkgPSBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MubmFtZUtleTsKICAgIHZhciB0b29sdGlwUGF5bG9hZDsKICAgIGlmICh0b29sdGlwQXhpc0RhdGFLZXkgJiYgQXJyYXkuaXNBcnJheShzbGljZWQpICYmIC8qCiAgICAgKiBmaW5kRW50cnlJbkFycmF5IHdvbid0IHdvcmsgZm9yIFNjYXR0ZXIgYmVjYXVzZSBTY2F0dGVyIHByb3ZpZGVzIGFuIGFycmF5IG9mIGFycmF5cwogICAgICogYXMgdG9vbHRpcCBwYXlsb2FkcyBhbmQgZmluZEVudHJ5SW5BcnJheSBpcyBub3QgcHJlcGFyZWQgdG8gaGFuZGxlIHRoYXQuCiAgICAgKiBTYWQgYnV0IGFsc28gU2NhdHRlckNoYXJ0IG9ubHkgYWxsb3dzICdpdGVtJyB0b29sdGlwRXZlbnRUeXBlCiAgICAgKiBhbmQgYWxzbyB0aGlzIGlzIG9ubHkgYSBwcm9ibGVtIGlmIHRoZXJlIGFyZSBtdWx0aXBsZSBTY2F0dGVycyBhbmQgZWFjaCBoYXMgaXRzIG93biBkYXRhIGFycmF5CiAgICAgKiBzbyBsZXQncyBmaXggdGhhdCBzb21lIG90aGVyIHRpbWUuCiAgICAgKi8KICAgICFBcnJheS5pc0FycmF5KHNsaWNlZFswXSkgJiYgLyoKICAgICAqIElmIHRoZSB0b29sdGlwRXZlbnRUeXBlIGlzICdheGlzJywgd2Ugc2hvdWxkIHNlYXJjaCBmb3IgdGhlIGRhdGFLZXkgaW4gdGhlIHNsaWNlZCBkYXRhCiAgICAgKiBiZWNhdXNlIHRoYW5rcyB0byBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeT1mYWxzZSwgdGhlIG9yZGVyIG9mIGVsZW1lbnRzIGluIHRoZSBhcnJheQogICAgICogbm8gbG9uZ2VyIG1hdGNoZXMgdGhlIG9yZGVyIG9mIGVsZW1lbnRzIGluIHRoZSBvcmlnaW5hbCBkYXRhCiAgICAgKiBhbmQgc28gd2UgbmVlZCB0byBzZWFyY2ggYnkgdGhlIGFjdGl2ZSBkYXRhS2V5ICsgbGFiZWwgcmF0aGVyIHRoYW4gYnkgaW5kZXguCiAgICAgKgogICAgICogVGhlIHNhbWUgaGFwcGVucyBpZiBtdWx0aXBsZSBncmFwaGljYWwgaXRlbXMgYXJlIHByZXNlbnQgaW4gdGhlIGNoYXJ0CiAgICAgKiBhbmQgZWFjaCBvZiB0aGVtIGhhcyBpdHMgb3duIGRhdGEgYXJyYXkuIFRob3NlIGFycmF5cyBnZXQgY29uY2F0ZW5hdGVkCiAgICAgKiBhbmQgYWdhaW4gdGhlIHRvb2x0aXAgaW5kZXggbm8gbG9uZ2VyIG1hdGNoZXMgdGhlIG9yaWdpbmFsIGRhdGEuCiAgICAgKgogICAgICogT24gdGhlIG90aGVyIGhhbmQgdGhlIHRvb2x0aXBFdmVudFR5cGUgJ2l0ZW0nIHNob3VsZCBhbHdheXMgc2VhcmNoIGJ5IGluZGV4CiAgICAgKiBiZWNhdXNlIHdlIGdldCB0aGUgaW5kZXggZnJvbSBpbnRlcmFjdGluZyBvdmVyIHRoZSBpbmRpdmlkdWFsIGVsZW1lbnRzCiAgICAgKiB3aGljaCBpcyBhbHdheXMgYWNjdXJhdGUsIGlycmVzcGVjdGl2ZSBvZiB0aGUgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgc2V0dGluZy4KICAgICAqLwogICAgdG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgIHRvb2x0aXBQYXlsb2FkID0gZmluZEVudHJ5SW5BcnJheShzbGljZWQsIHRvb2x0aXBBeGlzRGF0YUtleSwgYWN0aXZlTGFiZWwpOwogICAgfSBlbHNlIHsKICAgICAgdG9vbHRpcFBheWxvYWQgPSB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKHNsaWNlZCwgYWN0aXZlSW5kZXgsIGNvbXB1dGVkRGF0YSwgZmluYWxOYW1lS2V5KTsKICAgIH0KICAgIGlmIChBcnJheS5pc0FycmF5KHRvb2x0aXBQYXlsb2FkKSkgewogICAgICB0b29sdGlwUGF5bG9hZC5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgICAgdmFyIG5ld1NldHRpbmdzID0gX29iamVjdFNwcmVhZDE1KF9vYmplY3RTcHJlYWQxNSh7fSwgc2V0dGluZ3MpLCB7fSwgewogICAgICAgICAgbmFtZTogaXRlbS5uYW1lLAogICAgICAgICAgdW5pdDogaXRlbS51bml0LAogICAgICAgICAgLy8gY29sb3IgYW5kIGZpbGwgYXJlIGVyYXNlZCB0byBrZWVwIDEwMCUgdGhlIGlkZW50aWNhbCBiZWhhdmlvdXIgdG8gcmVjaGFydHMgMi54IC0gYnV0IHRoZXJlJ3Mgbm90aGluZyBzdG9wcGluZyB1cyBmcm9tIHJldHVybmluZyB0aGVtIGhlcmUuIEl0J3MgdGVjaG5pY2FsbHkgYSBicmVha2luZyBjaGFuZ2UuCiAgICAgICAgICBjb2xvcjogdm9pZCAwLAogICAgICAgICAgLy8gY29sb3IgYW5kIGZpbGwgYXJlIGVyYXNlZCB0byBrZWVwIDEwMCUgdGhlIGlkZW50aWNhbCBiZWhhdmlvdXIgdG8gcmVjaGFydHMgMi54IC0gYnV0IHRoZXJlJ3Mgbm90aGluZyBzdG9wcGluZyB1cyBmcm9tIHJldHVybmluZyB0aGVtIGhlcmUuIEl0J3MgdGVjaG5pY2FsbHkgYSBicmVha2luZyBjaGFuZ2UuCiAgICAgICAgICBmaWxsOiB2b2lkIDAKICAgICAgICB9KTsKICAgICAgICBhZ2cucHVzaChnZXRUb29sdGlwRW50cnkoewogICAgICAgICAgdG9vbHRpcEVudHJ5U2V0dGluZ3M6IG5ld1NldHRpbmdzLAogICAgICAgICAgZGF0YUtleTogaXRlbS5kYXRhS2V5LAogICAgICAgICAgcGF5bG9hZDogaXRlbS5wYXlsb2FkLAogICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBnZXRWYWx1ZUJ5RGF0YUtleSBkb2VzIG5vdCB2YWxpZGF0ZSB0aGUgb3V0cHV0IHR5cGUKICAgICAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleShpdGVtLnBheWxvYWQsIGl0ZW0uZGF0YUtleSksCiAgICAgICAgICBuYW1lOiBpdGVtLm5hbWUKICAgICAgICB9KSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdmFyIF9nZXRWYWx1ZUJ5RGF0YUtleTsKICAgICAgYWdnLnB1c2goZ2V0VG9vbHRpcEVudHJ5KHsKICAgICAgICB0b29sdGlwRW50cnlTZXR0aW5nczogc2V0dGluZ3MsCiAgICAgICAgZGF0YUtleTogZmluYWxEYXRhS2V5LAogICAgICAgIHBheWxvYWQ6IHRvb2x0aXBQYXlsb2FkLAogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KHRvb2x0aXBQYXlsb2FkLCBmaW5hbERhdGFLZXkpLAogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgbmFtZTogKF9nZXRWYWx1ZUJ5RGF0YUtleSA9IGdldFZhbHVlQnlEYXRhS2V5KHRvb2x0aXBQYXlsb2FkLCBmaW5hbE5hbWVLZXkpKSAhPT0gbnVsbCAmJiBfZ2V0VmFsdWVCeURhdGFLZXkgIT09IHZvaWQgMCA/IF9nZXRWYWx1ZUJ5RGF0YUtleSA6IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy5uYW1lCiAgICAgIH0pKTsKICAgIH0KICAgIHJldHVybiBhZ2c7CiAgfSwgaW5pdCk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy90b29sdGlwU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RUb29sdGlwQXhpc1JlYWxTY2FsZVR5cGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RIYXNCYXIsIHNlbGVjdENoYXJ0TmFtZSwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZVJlYWxTY2FsZVR5cGUpOwp2YXIgc2VsZWN0QWxsVW5maWx0ZXJlZEdyYXBoaWNhbEl0ZW1zID0gY3JlYXRlU2VsZWN0b3IoWyhzdGF0ZSkgPT4gc3RhdGUuZ3JhcGhpY2FsSXRlbXMuY2FydGVzaWFuSXRlbXMsIChzdGF0ZSkgPT4gc3RhdGUuZ3JhcGhpY2FsSXRlbXMucG9sYXJJdGVtc10sIChjYXJ0ZXNpYW5JdGVtcywgcG9sYXJJdGVtcykgPT4gWy4uLmNhcnRlc2lhbkl0ZW1zLCAuLi5wb2xhckl0ZW1zXSk7CnZhciBzZWxlY3RUb29sdGlwQXhpc1ByZWRpY2F0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzSWRdLCBpdGVtQXhpc1ByZWRpY2F0ZSk7CnZhciBzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbFVuZmlsdGVyZWRHcmFwaGljYWxJdGVtcywgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUHJlZGljYXRlXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogZW1wdHlBcnJheXNBcmVFcXVhbENoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdEFsbFN0YWNrZWRHcmFwaGljYWxJdGVtc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCAoZ3JhcGhpY2FsSXRlbXMpID0+IGdyYXBoaWNhbEl0ZW1zLmZpbHRlcihpc1N0YWNrZWQpKTsKdmFyIHNlbGVjdFRvb2x0aXBHcmFwaGljYWxJdGVtc0RhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGNvbWJpbmVHcmFwaGljYWxJdGVtc0RhdGEsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogZW1wdHlBcnJheXNBcmVFcXVhbENoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBHcmFwaGljYWxJdGVtc0RhdGEsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzXSwgY29tYmluZURpc3BsYXllZERhdGEpOwp2YXIgc2VsZWN0VG9vbHRpcFN0YWNrZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbFN0YWNrZWRHcmFwaGljYWxJdGVtc1NldHRpbmdzLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcywgc2VsZWN0VG9vbHRpcEF4aXNdLCBjb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEpOwp2YXIgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgY29tYmluZUFwcGxpZWRWYWx1ZXMpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5EZWZpbml0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzXSwgZ2V0RG9tYWluRGVmaW5pdGlvbik7CnZhciBzZWxlY3RUb29sdGlwRGF0YU92ZXJmbG93ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzXSwgKGF4aXNTZXR0aW5ncykgPT4gYXhpc1NldHRpbmdzLmFsbG93RGF0YU92ZXJmbG93KTsKdmFyIHNlbGVjdFRvb2x0aXBEb21haW5Gcm9tVXNlclByZWZlcmVuY2VzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0VG9vbHRpcERhdGFPdmVyZmxvd10sIG51bWVyaWNhbERvbWFpblNwZWNpZmllZFdpdGhvdXRSZXF1aXJpbmdEYXRhKTsKdmFyIHNlbGVjdEFsbFN0YWNrZWRHcmFwaGljYWxJdGVtcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgKGdyYXBoaWNhbEl0ZW1zKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoaXNTdGFja2VkKSk7CnZhciBzZWxlY3RUb29sdGlwU3RhY2tHcm91cHMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YWNrZWREYXRhLCBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXMsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0UmV2ZXJzZVN0YWNrT3JkZXJdLCBjb21iaW5lU3RhY2tHcm91cHMpOwp2YXIgc2VsZWN0VG9vbHRpcERvbWFpbk9mU3RhY2tHcm91cHMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YWNrR3JvdXBzLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwRG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlc10sIGNvbWJpbmVEb21haW5PZlN0YWNrR3JvdXBzKTsKdmFyIHNlbGVjdFRvb2x0aXBJdGVtc1NldHRpbmdzRXhjZXB0U3RhY2tlZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgZmlsdGVyR3JhcGhpY2FsTm90U3RhY2tlZEl0ZW1zKTsKdmFyIHNlbGVjdERvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBJdGVtc1NldHRpbmdzRXhjZXB0U3RhY2tlZCwgc2VsZWN0QWxsRXJyb3JCYXJTZXR0aW5ncywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZURvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IG51bWJlckRvbWFpbkVxdWFsaXR5Q2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0UmVmZXJlbmNlRG90c0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlRG90cywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZURvdHNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlRG90c0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVEb3RzRG9tYWluKTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzQnlUb29sdGlwQXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUFyZWFzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzQnlUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZUFyZWFzRG9tYWluKTsKdmFyIHNlbGVjdFJlZmVyZW5jZUxpbmVzQnlUb29sdGlwQXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUxpbmVzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUxpbmVzQnlUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZUxpbmVzRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwUmVmZXJlbmNlRG90c0RvbWFpbiwgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUxpbmVzRG9tYWluLCBzZWxlY3RUb29sdGlwUmVmZXJlbmNlQXJlYXNEb21haW5dLCBtZXJnZURvbWFpbnMpOwp2YXIgc2VsZWN0VG9vbHRpcE51bWVyaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5EZWZpbml0aW9uLCBzZWxlY3RUb29sdGlwRG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlcywgc2VsZWN0VG9vbHRpcERvbWFpbk9mU3RhY2tHcm91cHMsIHNlbGVjdERvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzMiwgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZU51bWVyaWNhbERvbWFpbik7CnZhciBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RBbGxUb29sdGlwQXBwbGllZFZhbHVlcywgc2VsZWN0U3RhY2tPZmZzZXRUeXBlLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBOdW1lcmljYWxEb21haW5dLCBjb21iaW5lQXhpc0RvbWFpbik7CnZhciBzZWxlY3RUb29sdGlwTmljZVRpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzRG9tYWluLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlXSwgY29tYmluZU5pY2VUaWNrcyk7CnZhciBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNEb21haW4sIHNlbGVjdFRvb2x0aXBOaWNlVGlja3MsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVBeGlzRG9tYWluV2l0aE5pY2VUaWNrcyk7CnZhciBzZWxlY3RUb29sdGlwQXhpc1JhbmdlID0gKHN0YXRlKSA9PiB7CiAgdmFyIGF4aXNUeXBlID0gc2VsZWN0VG9vbHRpcEF4aXNUeXBlKHN0YXRlKTsKICB2YXIgYXhpc0lkID0gc2VsZWN0VG9vbHRpcEF4aXNJZChzdGF0ZSk7CiAgdmFyIGlzUGFub3JhbWEgPSBmYWxzZTsKICByZXR1cm4gc2VsZWN0QXhpc1JhbmdlKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkLCBpc1Bhbm9yYW1hKTsKfTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VXaXRoUmV2ZXJzZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RUb29sdGlwQXhpc1NjYWxlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1JlYWxTY2FsZVR5cGUsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzLCBzZWxlY3RUb29sdGlwQXhpc1JhbmdlV2l0aFJldmVyc2VdLCBjb21iaW5lU2NhbGVGdW5jdGlvbik7CnZhciBzZWxlY3RUb29sdGlwRHVwbGljYXRlRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBbGxUb29sdGlwQXBwbGllZFZhbHVlcywgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVEdXBsaWNhdGVEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcENhdGVnb3JpY2FsRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBbGxUb29sdGlwQXBwbGllZFZhbHVlcywgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVDYXRlZ29yaWNhbERvbWFpbik7CnZhciBjb21iaW5lVGlja3NPZlRvb2x0aXBBeGlzID0gKGxheW91dCwgYXhpcywgcmVhbFNjYWxlVHlwZSwgc2NhbGUsIHJhbmdlNCwgZHVwbGljYXRlRG9tYWluLCBjYXRlZ29yaWNhbERvbWFpbiwgYXhpc1R5cGUpID0+IHsKICBpZiAoIWF4aXMpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICB0eXBlCiAgfSA9IGF4aXM7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICBpZiAoIXNjYWxlKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgb2Zmc2V0Rm9yQmFuZCA9IHJlYWxTY2FsZVR5cGUgPT09ICJzY2FsZUJhbmQiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gMiA6IDI7CiAgdmFyIG9mZnNldCA9IHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyBvZmZzZXRGb3JCYW5kIDogMDsKICBvZmZzZXQgPSBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgcmFuZ2U0ICE9IG51bGwgJiYgKHJhbmdlNCA9PT0gbnVsbCB8fCByYW5nZTQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJhbmdlNC5sZW5ndGgpID49IDIgPyBtYXRoU2lnbihyYW5nZTRbMF0gLSByYW5nZTRbMV0pICogMiAqIG9mZnNldCA6IG9mZnNldDsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBzZWxlY3RUb29sdGlwQXhpc1RpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlLCBzZWxlY3RUb29sdGlwQXhpc1NjYWxlLCBzZWxlY3RUb29sdGlwQXhpc1JhbmdlLCBzZWxlY3RUb29sdGlwRHVwbGljYXRlRG9tYWluLCBzZWxlY3RUb29sdGlwQ2F0ZWdvcmljYWxEb21haW4sIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVUaWNrc09mVG9vbHRpcEF4aXMpOwp2YXIgc2VsZWN0VG9vbHRpcEV2ZW50VHlwZTIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHNlbGVjdFZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMsIHNlbGVjdFRvb2x0aXBTZXR0aW5nc10sIChkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlLCBzZXR0aW5ncykgPT4gY29tYmluZVRvb2x0aXBFdmVudFR5cGUoc2V0dGluZ3Muc2hhcmVkLCBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlKSk7CnZhciBzZWxlY3RUb29sdGlwVHJpZ2dlciA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcC5zZXR0aW5ncy50cmlnZ2VyOwp2YXIgc2VsZWN0RGVmYXVsdEluZGV4ID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzLmRlZmF1bHRJbmRleDsKdmFyIHNlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZSwgc2VsZWN0VG9vbHRpcEV2ZW50VHlwZTIsIHNlbGVjdFRvb2x0aXBUcmlnZ2VyLCBzZWxlY3REZWZhdWx0SW5kZXhdLCBjb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5LCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbl0sIGNvbWJpbmVBY3RpdmVUb29sdGlwSW5kZXgpOwp2YXIgc2VsZWN0QWN0aXZlTGFiZWwgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4XSwgY29tYmluZUFjdGl2ZUxhYmVsKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhS2V5ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlXSwgKHRvb2x0aXBJbnRlcmFjdGlvbikgPT4gewogIGlmICghdG9vbHRpcEludGVyYWN0aW9uKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gdG9vbHRpcEludGVyYWN0aW9uLmRhdGFLZXk7Cn0pOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcEdyYXBoaWNhbEl0ZW1JZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb24pID0+IHsKICBpZiAoIXRvb2x0aXBJbnRlcmFjdGlvbikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvbi5ncmFwaGljYWxJdGVtSWQ7Cn0pOwp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyLCBzZWxlY3RUb29sdGlwVHJpZ2dlciwgc2VsZWN0RGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMpOwp2YXIgc2VsZWN0VG9vbHRpcENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHQsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBzZWxlY3REZWZhdWx0SW5kZXgsIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXJdLCBjb21iaW5lQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwQ29vcmRpbmF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgc2VsZWN0VG9vbHRpcENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXhdLCAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIGRlZmF1bHRJbmRleENvb3JkaW5hdGUpID0+IHsKICBpZiAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUgIT09IG51bGwgJiYgdG9vbHRpcEludGVyYWN0aW9uU3RhdGUgIT09IHZvaWQgMCAmJiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5jb29yZGluYXRlKSB7CiAgICByZXR1cm4gdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuY29vcmRpbmF0ZTsKICB9CiAgcmV0dXJuIGRlZmF1bHRJbmRleENvb3JkaW5hdGU7Cn0pOwp2YXIgc2VsZWN0SXNUb29sdGlwQWN0aXZlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlXSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKSA9PiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5hY3RpdmUpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcFBheWxvYWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucywgc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4LCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcywgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5LCBzZWxlY3RBY3RpdmVMYWJlbCwgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciwgc2VsZWN0VG9vbHRpcEV2ZW50VHlwZTJdLCBjb21iaW5lVG9vbHRpcFBheWxvYWQpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcERhdGFQb2ludHMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWN0aXZlVG9vbHRpcFBheWxvYWRdLCAocGF5bG9hZCkgPT4gewogIGlmIChwYXlsb2FkID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBkYXRhUG9pbnRzID0gcGF5bG9hZC5tYXAoKHApID0+IHAucGF5bG9hZCkuZmlsdGVyKChwKSA9PiBwICE9IG51bGwpOwogIHJldHVybiBBcnJheS5mcm9tKG5ldyBTZXQoZGF0YVBvaW50cykpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC91c2VUb29sdGlwQXhpcy5qcwpmdW5jdGlvbiBvd25LZXlzMTYoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxNihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE2KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxNihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxNihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxNihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxNih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxNih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxNih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHVzZVRvb2x0aXBBeGlzID0gKCkgPT4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXMpOwp2YXIgdXNlVG9vbHRpcEF4aXNCYW5kU2l6ZSA9ICgpID0+IHsKICB2YXIgdG9vbHRpcEF4aXMgPSB1c2VUb29sdGlwQXhpcygpOwogIHZhciB0b29sdGlwVGlja3MgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpc1RpY2tzKTsKICB2YXIgdG9vbHRpcEF4aXNTY2FsZSA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzU2NhbGUpOwogIGlmICghdG9vbHRpcEF4aXMgfHwgIXRvb2x0aXBBeGlzU2NhbGUpIHsKICAgIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyh2b2lkIDAsIHRvb2x0aXBUaWNrcyk7CiAgfQogIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyhfb2JqZWN0U3ByZWFkMTYoX29iamVjdFNwcmVhZDE2KHt9LCB0b29sdGlwQXhpcyksIHt9LCB7CiAgICBzY2FsZTogdG9vbHRpcEF4aXNTY2FsZQogIH0pLCB0b29sdGlwVGlja3MpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0b3JzLmpzCnZhciBpbXBvcnRfc29ydEJ5NCA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldEFjdGl2ZUNvb3JkaW5hdGUuanMKZnVuY3Rpb24gb3duS2V5czE3KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTcoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTcoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTcoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE3KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTcocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTcodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTcodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTcodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBnZXRBY3RpdmVDYXJ0ZXNpYW5Db29yZGluYXRlID0gKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgcG9pbnRlcikgPT4gewogIHZhciBlbnRyeSA9IHRvb2x0aXBUaWNrcy5maW5kKCh0aWNrKSA9PiB0aWNrICYmIHRpY2suaW5kZXggPT09IGFjdGl2ZUluZGV4KTsKICBpZiAoZW50cnkpIHsKICAgIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgICByZXR1cm4gewogICAgICAgIHg6IGVudHJ5LmNvb3JkaW5hdGUsCiAgICAgICAgeTogcG9pbnRlci5jaGFydFkKICAgICAgfTsKICAgIH0KICAgIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBwb2ludGVyLmNoYXJ0WCwKICAgICAgICB5OiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH07CiAgICB9CiAgfQogIHJldHVybiB7CiAgICB4OiAwLAogICAgeTogMAogIH07Cn07CnZhciBnZXRBY3RpdmVQb2xhckNvb3JkaW5hdGUgPSAobGF5b3V0LCB0b29sdGlwVGlja3MsIGFjdGl2ZUluZGV4LCByYW5nZU9iaikgPT4gewogIHZhciBlbnRyeSA9IHRvb2x0aXBUaWNrcy5maW5kKCh0aWNrKSA9PiB0aWNrICYmIHRpY2suaW5kZXggPT09IGFjdGl2ZUluZGV4KTsKICBpZiAoZW50cnkpIHsKICAgIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgICB2YXIgX2FuZ2xlID0gZW50cnkuY29vcmRpbmF0ZTsKICAgICAgdmFyIHsKICAgICAgICByYWRpdXM6IF9yYWRpdXMKICAgICAgfSA9IHJhbmdlT2JqOwogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyhfb2JqZWN0U3ByZWFkMTcoe30sIHJhbmdlT2JqKSwgcG9sYXJUb0NhcnRlc2lhbihyYW5nZU9iai5jeCwgcmFuZ2VPYmouY3ksIF9yYWRpdXMsIF9hbmdsZSkpLCB7fSwgewogICAgICAgIGFuZ2xlOiBfYW5nbGUsCiAgICAgICAgcmFkaXVzOiBfcmFkaXVzCiAgICAgIH0pOwogICAgfQogICAgdmFyIHJhZGl1cyA9IGVudHJ5LmNvb3JkaW5hdGU7CiAgICB2YXIgewogICAgICBhbmdsZQogICAgfSA9IHJhbmdlT2JqOwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNyhfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KHt9LCByYW5nZU9iaiksIHBvbGFyVG9DYXJ0ZXNpYW4ocmFuZ2VPYmouY3gsIHJhbmdlT2JqLmN5LCByYWRpdXMsIGFuZ2xlKSksIHt9LCB7CiAgICAgIGFuZ2xlLAogICAgICByYWRpdXMKICAgIH0pOwogIH0KICByZXR1cm4gewogICAgYW5nbGU6IDAsCiAgICBjbG9ja1dpc2U6IGZhbHNlLAogICAgY3g6IDAsCiAgICBjeTogMCwKICAgIGVuZEFuZ2xlOiAwLAogICAgaW5uZXJSYWRpdXM6IDAsCiAgICBvdXRlclJhZGl1czogMCwKICAgIHJhZGl1czogMCwKICAgIHN0YXJ0QW5nbGU6IDAsCiAgICB4OiAwLAogICAgeTogMAogIH07Cn07CmZ1bmN0aW9uIGlzSW5DYXJ0ZXNpYW5SYW5nZShwb2ludGVyLCBvZmZzZXQpIHsKICB2YXIgewogICAgY2hhcnRYOiB4MiwKICAgIGNoYXJ0WTogeTIKICB9ID0gcG9pbnRlcjsKICByZXR1cm4geDIgPj0gb2Zmc2V0LmxlZnQgJiYgeDIgPD0gb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGggJiYgeTIgPj0gb2Zmc2V0LnRvcCAmJiB5MiA8PSBvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodDsKfQp2YXIgY2FsY3VsYXRlQWN0aXZlVGlja0luZGV4ID0gKGNvb3JkaW5hdGUsIHRpY2tzMiwgdW5zb3J0ZWRUaWNrcywgYXhpc1R5cGUsIHJhbmdlNCkgPT4gewogIHZhciBfdGlja3MkbGVuZ3RoOwogIHZhciBpbmRleCA9IC0xOwogIHZhciBsZW4gPSAoX3RpY2tzJGxlbmd0aCA9IHRpY2tzMiA9PT0gbnVsbCB8fCB0aWNrczIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRpY2tzMi5sZW5ndGgpICE9PSBudWxsICYmIF90aWNrcyRsZW5ndGggIT09IHZvaWQgMCA/IF90aWNrcyRsZW5ndGggOiAwOwogIGlmIChsZW4gPD0gMSB8fCBjb29yZGluYXRlID09IG51bGwpIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAoYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIHJhbmdlNCAhPSBudWxsICYmIE1hdGguYWJzKE1hdGguYWJzKHJhbmdlNFsxXSAtIHJhbmdlNFswXSkgLSAzNjApIDw9IDFlLTYpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgdmFyIGJlZm9yZSA9IGkgPiAwID8gdW5zb3J0ZWRUaWNrc1tpIC0gMV0uY29vcmRpbmF0ZSA6IHVuc29ydGVkVGlja3NbbGVuIC0gMV0uY29vcmRpbmF0ZTsKICAgICAgdmFyIGN1ciA9IHVuc29ydGVkVGlja3NbaV0uY29vcmRpbmF0ZTsKICAgICAgdmFyIGFmdGVyID0gaSA+PSBsZW4gLSAxID8gdW5zb3J0ZWRUaWNrc1swXS5jb29yZGluYXRlIDogdW5zb3J0ZWRUaWNrc1tpICsgMV0uY29vcmRpbmF0ZTsKICAgICAgdmFyIHNhbWVEaXJlY3Rpb25Db29yZCA9IHZvaWQgMDsKICAgICAgaWYgKG1hdGhTaWduKGN1ciAtIGJlZm9yZSkgIT09IG1hdGhTaWduKGFmdGVyIC0gY3VyKSkgewogICAgICAgIHZhciBkaWZmSW50ZXJ2YWwgPSBbXTsKICAgICAgICBpZiAobWF0aFNpZ24oYWZ0ZXIgLSBjdXIpID09PSBtYXRoU2lnbihyYW5nZTRbMV0gLSByYW5nZTRbMF0pKSB7CiAgICAgICAgICBzYW1lRGlyZWN0aW9uQ29vcmQgPSBhZnRlcjsKICAgICAgICAgIHZhciBjdXJJblJhbmdlID0gY3VyICsgcmFuZ2U0WzFdIC0gcmFuZ2U0WzBdOwogICAgICAgICAgZGlmZkludGVydmFsWzBdID0gTWF0aC5taW4oY3VySW5SYW5nZSwgKGN1ckluUmFuZ2UgKyBiZWZvcmUpIC8gMik7CiAgICAgICAgICBkaWZmSW50ZXJ2YWxbMV0gPSBNYXRoLm1heChjdXJJblJhbmdlLCAoY3VySW5SYW5nZSArIGJlZm9yZSkgLyAyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2FtZURpcmVjdGlvbkNvb3JkID0gYmVmb3JlOwogICAgICAgICAgdmFyIGFmdGVySW5SYW5nZSA9IGFmdGVyICsgcmFuZ2U0WzFdIC0gcmFuZ2U0WzBdOwogICAgICAgICAgZGlmZkludGVydmFsWzBdID0gTWF0aC5taW4oY3VyLCAoYWZ0ZXJJblJhbmdlICsgY3VyKSAvIDIpOwogICAgICAgICAgZGlmZkludGVydmFsWzFdID0gTWF0aC5tYXgoY3VyLCAoYWZ0ZXJJblJhbmdlICsgY3VyKSAvIDIpOwogICAgICAgIH0KICAgICAgICB2YXIgc2FtZUludGVydmFsID0gW01hdGgubWluKGN1ciwgKHNhbWVEaXJlY3Rpb25Db29yZCArIGN1cikgLyAyKSwgTWF0aC5tYXgoY3VyLCAoc2FtZURpcmVjdGlvbkNvb3JkICsgY3VyKSAvIDIpXTsKICAgICAgICBpZiAoY29vcmRpbmF0ZSA+IHNhbWVJbnRlcnZhbFswXSAmJiBjb29yZGluYXRlIDw9IHNhbWVJbnRlcnZhbFsxXSB8fCBjb29yZGluYXRlID49IGRpZmZJbnRlcnZhbFswXSAmJiBjb29yZGluYXRlIDw9IGRpZmZJbnRlcnZhbFsxXSkgewogICAgICAgICAgKHsKICAgICAgICAgICAgaW5kZXgKICAgICAgICAgIH0gPSB1bnNvcnRlZFRpY2tzW2ldKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgbWluVmFsdWUgPSBNYXRoLm1pbihiZWZvcmUsIGFmdGVyKTsKICAgICAgICB2YXIgbWF4VmFsdWUgPSBNYXRoLm1heChiZWZvcmUsIGFmdGVyKTsKICAgICAgICBpZiAoY29vcmRpbmF0ZSA+IChtaW5WYWx1ZSArIGN1cikgLyAyICYmIGNvb3JkaW5hdGUgPD0gKG1heFZhbHVlICsgY3VyKSAvIDIpIHsKICAgICAgICAgICh7CiAgICAgICAgICAgIGluZGV4CiAgICAgICAgICB9ID0gdW5zb3J0ZWRUaWNrc1tpXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKHRpY2tzMikgewogICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGxlbjsgX2krKykgewogICAgICBpZiAoX2kgPT09IDAgJiYgY29vcmRpbmF0ZSA8PSAodGlja3MyW19pXS5jb29yZGluYXRlICsgdGlja3MyW19pICsgMV0uY29vcmRpbmF0ZSkgLyAyIHx8IF9pID4gMCAmJiBfaSA8IGxlbiAtIDEgJiYgY29vcmRpbmF0ZSA+ICh0aWNrczJbX2ldLmNvb3JkaW5hdGUgKyB0aWNrczJbX2kgLSAxXS5jb29yZGluYXRlKSAvIDIgJiYgY29vcmRpbmF0ZSA8PSAodGlja3MyW19pXS5jb29yZGluYXRlICsgdGlja3MyW19pICsgMV0uY29vcmRpbmF0ZSkgLyAyIHx8IF9pID09PSBsZW4gLSAxICYmIGNvb3JkaW5hdGUgPiAodGlja3MyW19pXS5jb29yZGluYXRlICsgdGlja3MyW19pIC0gMV0uY29vcmRpbmF0ZSkgLyAyKSB7CiAgICAgICAgKHsKICAgICAgICAgIGluZGV4CiAgICAgICAgfSA9IHRpY2tzMltfaV0pOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBpbmRleDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdG9ycy5qcwp2YXIgdXNlQ2hhcnROYW1lID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydE5hbWUpOwp9Owp2YXIgcGlja1Rvb2x0aXBFdmVudFR5cGUgPSAoX3N0YXRlLCB0b29sdGlwRXZlbnRUeXBlKSA9PiB0b29sdGlwRXZlbnRUeXBlOwp2YXIgcGlja1RyaWdnZXIgPSAoX3N0YXRlLCBfdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcikgPT4gdHJpZ2dlcjsKdmFyIHBpY2tEZWZhdWx0SW5kZXggPSAoX3N0YXRlLCBfdG9vbHRpcEV2ZW50VHlwZSwgX3RyaWdnZXIsIGRlZmF1bHRJbmRleCkgPT4gZGVmYXVsdEluZGV4Owp2YXIgc2VsZWN0T3JkZXJlZFRvb2x0aXBUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzVGlja3MsICh0aWNrczIpID0+ICgwLCBpbXBvcnRfc29ydEJ5NC5kZWZhdWx0KSh0aWNrczIsIChvKSA9PiBvLmNvb3JkaW5hdGUpKTsKdmFyIHNlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHBpY2tUb29sdGlwRXZlbnRUeXBlLCBwaWNrVHJpZ2dlciwgcGlja0RlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSk7CnZhciBzZWxlY3RBY3RpdmVJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZTIsIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXksIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluXSwgY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleCk7CnZhciBzZWxlY3RUb29sdGlwRGF0YUtleSA9IChzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcikgPT4gewogIGlmICh0b29sdGlwRXZlbnRUeXBlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB0b29sdGlwU3RhdGUgPSBzZWxlY3RUb29sdGlwU3RhdGUoc3RhdGUpOwogIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIpIHsKICAgIGlmICh0cmlnZ2VyID09PSAiaG92ZXIiKSB7CiAgICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXk7CiAgICB9CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5OwogIH0KICBpZiAodHJpZ2dlciA9PT0gImhvdmVyIikgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleTsKICB9CiAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleTsKfTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZSwgcGlja1Rvb2x0aXBFdmVudFR5cGUsIHBpY2tUcmlnZ2VyLCBwaWNrRGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMpOwp2YXIgc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHBpY2tEZWZhdWx0SW5kZXgsIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMyLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyXSwgY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgpOwp2YXIgc2VsZWN0QWN0aXZlQ29vcmRpbmF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZTIsIHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXhdLCAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIGRlZmF1bHRJbmRleENvb3JkaW5hdGUpID0+IHsKICB2YXIgX3Rvb2x0aXBJbnRlcmFjdGlvblN0OwogIHJldHVybiAoX3Rvb2x0aXBJbnRlcmFjdGlvblN0ID0gdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuY29vcmRpbmF0ZSkgIT09IG51bGwgJiYgX3Rvb2x0aXBJbnRlcmFjdGlvblN0ICE9PSB2b2lkIDAgPyBfdG9vbHRpcEludGVyYWN0aW9uU3QgOiBkZWZhdWx0SW5kZXhDb29yZGluYXRlOwp9KTsKdmFyIHNlbGVjdEFjdGl2ZUxhYmVsMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBzZWxlY3RBY3RpdmVJbmRleF0sIGNvbWJpbmVBY3RpdmVMYWJlbCk7CnZhciBzZWxlY3RUb29sdGlwUGF5bG9hZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zMiwgc2VsZWN0QWN0aXZlSW5kZXgsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXksIHNlbGVjdEFjdGl2ZUxhYmVsMiwgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciwgcGlja1Rvb2x0aXBFdmVudFR5cGVdLCBjb21iaW5lVG9vbHRpcFBheWxvYWQpOwp2YXIgc2VsZWN0SXNUb29sdGlwQWN0aXZlMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZTIsIHNlbGVjdEFjdGl2ZUluZGV4XSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBhY3RpdmVJbmRleCkgPT4gewogIHJldHVybiB7CiAgICBpc0FjdGl2ZTogdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuYWN0aXZlICYmIGFjdGl2ZUluZGV4ICE9IG51bGwsCiAgICBhY3RpdmVJbmRleAogIH07Cn0pOwp2YXIgY29tYmluZUFjdGl2ZUNhcnRlc2lhblByb3BzID0gKGNoYXJ0RXZlbnQsIGxheW91dCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIG9mZnNldCkgPT4gewogIGlmICghY2hhcnRFdmVudCB8fCAhdG9vbHRpcEF4aXNUeXBlIHx8ICF0b29sdGlwQXhpc1JhbmdlIHx8ICF0b29sdGlwVGlja3MpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmICghaXNJbkNhcnRlc2lhblJhbmdlKGNoYXJ0RXZlbnQsIG9mZnNldCkpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBwb3MgPSBjYWxjdWxhdGVDYXJ0ZXNpYW5Ub29sdGlwUG9zKGNoYXJ0RXZlbnQsIGxheW91dCk7CiAgdmFyIGFjdGl2ZUluZGV4ID0gY2FsY3VsYXRlQWN0aXZlVGlja0luZGV4KHBvcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgdG9vbHRpcFRpY2tzLCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UpOwogIHZhciBhY3RpdmVDb29yZGluYXRlID0gZ2V0QWN0aXZlQ2FydGVzaWFuQ29vcmRpbmF0ZShsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIGNoYXJ0RXZlbnQpOwogIHJldHVybiB7CiAgICBhY3RpdmVJbmRleDogU3RyaW5nKGFjdGl2ZUluZGV4KSwKICAgIGFjdGl2ZUNvb3JkaW5hdGUKICB9Owp9Owp2YXIgY29tYmluZUFjdGl2ZVBvbGFyUHJvcHMgPSAoY2hhcnRFdmVudCwgbGF5b3V0LCBwb2xhclZpZXdCb3gsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzKSA9PiB7CiAgaWYgKCFjaGFydEV2ZW50IHx8ICF0b29sdGlwQXhpc1R5cGUgfHwgIXRvb2x0aXBBeGlzUmFuZ2UgfHwgIXRvb2x0aXBUaWNrcyB8fCAhcG9sYXJWaWV3Qm94KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgcmFuZ2VPYmogPSBpblJhbmdlT2ZTZWN0b3IoY2hhcnRFdmVudCwgcG9sYXJWaWV3Qm94KTsKICBpZiAoIXJhbmdlT2JqKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgcG9zID0gY2FsY3VsYXRlUG9sYXJUb29sdGlwUG9zKHJhbmdlT2JqLCBsYXlvdXQpOwogIHZhciBhY3RpdmVJbmRleCA9IGNhbGN1bGF0ZUFjdGl2ZVRpY2tJbmRleChwb3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIHRvb2x0aXBUaWNrcywgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlKTsKICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IGdldEFjdGl2ZVBvbGFyQ29vcmRpbmF0ZShsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIHJhbmdlT2JqKTsKICByZXR1cm4gewogICAgYWN0aXZlSW5kZXg6IFN0cmluZyhhY3RpdmVJbmRleCksCiAgICBhY3RpdmVDb29yZGluYXRlCiAgfTsKfTsKdmFyIGNvbWJpbmVBY3RpdmVQcm9wcyA9IChjaGFydEV2ZW50LCBsYXlvdXQsIHBvbGFyVmlld0JveCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIG9mZnNldCkgPT4gewogIGlmICghY2hhcnRFdmVudCB8fCAhbGF5b3V0IHx8ICF0b29sdGlwQXhpc1R5cGUgfHwgIXRvb2x0aXBBeGlzUmFuZ2UgfHwgIXRvb2x0aXBUaWNrcykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIGNvbWJpbmVBY3RpdmVDYXJ0ZXNpYW5Qcm9wcyhjaGFydEV2ZW50LCBsYXlvdXQsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCBvZmZzZXQpOwogIH0KICByZXR1cm4gY29tYmluZUFjdGl2ZVBvbGFyUHJvcHMoY2hhcnRFdmVudCwgbGF5b3V0LCBwb2xhclZpZXdCb3gsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L1pJbmRleExheWVyLmpzCnZhciBpbXBvcnRfcmVhY3QyMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdF9kb20gPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3RfZG9tKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi96SW5kZXgvekluZGV4U2VsZWN0b3JzLmpzCnZhciBzZWxlY3RaSW5kZXhQb3J0YWxJZCA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUuekluZGV4LnpJbmRleE1hcCwgKF8sIHpJbmRleCkgPT4gekluZGV4LCAoXywgX3pJbmRleCwgaXNQYW5vcmFtYSkgPT4gaXNQYW5vcmFtYSwgKHpJbmRleE1hcCwgekluZGV4LCBpc1Bhbm9yYW1hKSA9PiB7CiAgaWYgKHpJbmRleCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZW50cnkgPSB6SW5kZXhNYXBbekluZGV4XTsKICBpZiAoZW50cnkgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBlbnRyeS5wYW5vcmFtYUVsZW1lbnRJZDsKICB9CiAgcmV0dXJuIGVudHJ5LmVsZW1lbnRJZDsKfSk7CnZhciBzZWxlY3RBbGxSZWdpc3RlcmVkWkluZGV4ZXMgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnpJbmRleC56SW5kZXhNYXAsICh6SW5kZXhNYXApID0+IHsKICB2YXIgYWxsTnVtYmVycyA9IE9iamVjdC5rZXlzKHpJbmRleE1hcCkubWFwKCh6SW5kZXhTdHIpID0+IHBhcnNlSW50KHpJbmRleFN0ciwgMTApKS5jb25jYXQoT2JqZWN0LnZhbHVlcyhEZWZhdWx0WkluZGV4ZXMpKTsKICB2YXIgdW5pcXVlTnVtYmVycyA9IEFycmF5LmZyb20obmV3IFNldChhbGxOdW1iZXJzKSk7CiAgcmV0dXJuIHVuaXF1ZU51bWJlcnMuc29ydCgoYSwgYikgPT4gYSAtIGIpOwp9LCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGFycmF5Q29udGVudHNBcmVFcXVhbENoZWNrCiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvekluZGV4U2xpY2UuanMKZnVuY3Rpb24gb3duS2V5czE4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTgoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxOChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTgoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTgoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE4KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTgocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTgodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTgodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTgodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBzZWVkID0ge307CnZhciBpbml0aWFsU3RhdGU0ID0gewogIHpJbmRleE1hcDogT2JqZWN0LnZhbHVlcyhEZWZhdWx0WkluZGV4ZXMpLnJlZHVjZSgoYWNjLCBjdXJyZW50MykgPT4gX29iamVjdFNwcmVhZDE4KF9vYmplY3RTcHJlYWQxOCh7fSwgYWNjKSwge30sIHsKICAgIFtjdXJyZW50M106IHsKICAgICAgZWxlbWVudElkOiB2b2lkIDAsCiAgICAgIHBhbm9yYW1hRWxlbWVudElkOiB2b2lkIDAsCiAgICAgIGNvbnN1bWVyczogMAogICAgfQogIH0pLCBzZWVkKQp9Owp2YXIgZGVmYXVsdFpJbmRleFNldCA9IG5ldyBTZXQoT2JqZWN0LnZhbHVlcyhEZWZhdWx0WkluZGV4ZXMpKTsKZnVuY3Rpb24gaXNEZWZhdWx0WkluZGV4KHpJbmRleCkgewogIHJldHVybiBkZWZhdWx0WkluZGV4U2V0Lmhhcyh6SW5kZXgpOwp9CnZhciB6SW5kZXhTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiekluZGV4IiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTQsCiAgcmVkdWNlcnM6IHsKICAgIHJlZ2lzdGVyWkluZGV4UG9ydGFsOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyArPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XSA9IHsKICAgICAgICAgICAgY29uc3VtZXJzOiAxLAogICAgICAgICAgICBlbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgICAgICAgcGFub3JhbWFFbGVtZW50SWQ6IHZvaWQgMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgdW5yZWdpc3RlclpJbmRleFBvcnRhbDogewogICAgICByZWR1Y2VyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB6SW5kZXgKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdKSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5jb25zdW1lcnMgLT0gMTsKICAgICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5jb25zdW1lcnMgPD0gMCAmJiAhaXNEZWZhdWx0WkluZGV4KHpJbmRleCkpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZWdpc3RlclpJbmRleFBvcnRhbElkOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleCwKICAgICAgICAgIGVsZW1lbnRJZCwKICAgICAgICAgIGlzUGFub3JhbWEKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdKSB7CiAgICAgICAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5wYW5vcmFtYUVsZW1lbnRJZCA9IGVsZW1lbnRJZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmVsZW1lbnRJZCA9IGVsZW1lbnRJZDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0gPSB7CiAgICAgICAgICAgIGNvbnN1bWVyczogMCwKICAgICAgICAgICAgZWxlbWVudElkOiBpc1Bhbm9yYW1hID8gdm9pZCAwIDogZWxlbWVudElkLAogICAgICAgICAgICBwYW5vcmFtYUVsZW1lbnRJZDogaXNQYW5vcmFtYSA/IGVsZW1lbnRJZCA6IHZvaWQgMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgdW5yZWdpc3RlclpJbmRleFBvcnRhbElkOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIGlmIChhY3Rpb24ucGF5bG9hZC5pc1Bhbm9yYW1hKSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLnBhbm9yYW1hRWxlbWVudElkID0gdm9pZCAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uZWxlbWVudElkID0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0KICB9Cn0pOwp2YXIgewogIHJlZ2lzdGVyWkluZGV4UG9ydGFsLAogIHVucmVnaXN0ZXJaSW5kZXhQb3J0YWwsCiAgcmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCwKICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsSWQKfSA9IHpJbmRleFNsaWNlLmFjdGlvbnM7CnZhciB6SW5kZXhSZWR1Y2VyID0gekluZGV4U2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L1pJbmRleExheWVyLmpzCmZ1bmN0aW9uIFpJbmRleExheWVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIHpJbmRleCwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBpc0luQ2hhcnRDb250ZXh0ID0gdXNlSXNJbkNoYXJ0Q29udGV4dCgpOwogIHZhciBzaG91bGRSZW5kZXJJblBvcnRhbCA9IGlzSW5DaGFydENvbnRleHQgJiYgekluZGV4ICE9PSB2b2lkIDAgJiYgekluZGV4ICE9PSAwOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFzaG91bGRSZW5kZXJJblBvcnRhbCkgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIGRpc3BhdGNoKHJlZ2lzdGVyWkluZGV4UG9ydGFsKHsKICAgICAgekluZGV4CiAgICB9KSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaCh1bnJlZ2lzdGVyWkluZGV4UG9ydGFsKHsKICAgICAgICB6SW5kZXgKICAgICAgfSkpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIHpJbmRleCwgc2hvdWxkUmVuZGVySW5Qb3J0YWxdKTsKICB2YXIgcG9ydGFsSWQgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFpJbmRleFBvcnRhbElkKHN0YXRlLCB6SW5kZXgsIGlzUGFub3JhbWEpKTsKICBpZiAoIXNob3VsZFJlbmRlckluUG9ydGFsKSB7CiAgICByZXR1cm4gY2hpbGRyZW47CiAgfQogIGlmICghcG9ydGFsSWQpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgekluZGV4UG9ydGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocG9ydGFsSWQpOwogIGlmICh6SW5kZXhQb3J0YWwpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdF9kb20uY3JlYXRlUG9ydGFsKShjaGlsZHJlbiwgekluZGV4UG9ydGFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0N1cnNvci5qcwpmdW5jdGlvbiBfZXh0ZW5kczkoKSB7CiAgcmV0dXJuIF9leHRlbmRzOSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzOS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXMxOShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE5KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTkoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE5KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxOShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE5KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE5KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBSZW5kZXJDdXJzb3IoX3JlZjIpIHsKICB2YXIgewogICAgY3Vyc29yLAogICAgY3Vyc29yQ29tcCwKICAgIGN1cnNvclByb3BzCiAgfSA9IF9yZWYyOwogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIxLmlzVmFsaWRFbGVtZW50KShjdXJzb3IpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMS5jbG9uZUVsZW1lbnQpKGN1cnNvciwgY3Vyc29yUHJvcHMpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMS5jcmVhdGVFbGVtZW50KShjdXJzb3JDb21wLCBjdXJzb3JQcm9wcyk7Cn0KZnVuY3Rpb24gQ3Vyc29ySW50ZXJuYWwocHJvcHMpIHsKICB2YXIgX3Byb3BzJHpJbmRleDsKICB2YXIgewogICAgY29vcmRpbmF0ZSwKICAgIHBheWxvYWQsCiAgICBpbmRleCwKICAgIG9mZnNldCwKICAgIHRvb2x0aXBBeGlzQmFuZFNpemUsCiAgICBsYXlvdXQsCiAgICBjdXJzb3IsCiAgICB0b29sdGlwRXZlbnRUeXBlLAogICAgY2hhcnROYW1lCiAgfSA9IHByb3BzOwogIHZhciBhY3RpdmVDb29yZGluYXRlID0gY29vcmRpbmF0ZTsKICB2YXIgYWN0aXZlUGF5bG9hZCA9IHBheWxvYWQ7CiAgdmFyIGFjdGl2ZVRvb2x0aXBJbmRleCA9IGluZGV4OwogIGlmICghY3Vyc29yIHx8ICFhY3RpdmVDb29yZGluYXRlIHx8IGNoYXJ0TmFtZSAhPT0gIlNjYXR0ZXJDaGFydCIgJiYgdG9vbHRpcEV2ZW50VHlwZSAhPT0gImF4aXMiKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJlc3RQcm9wcywgY3Vyc29yQ29tcCwgcHJlZmVycmVkWkluZGV4OwogIGlmIChjaGFydE5hbWUgPT09ICJTY2F0dGVyQ2hhcnQiKSB7CiAgICByZXN0UHJvcHMgPSBhY3RpdmVDb29yZGluYXRlOwogICAgY3Vyc29yQ29tcCA9IENyb3NzOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvckxpbmU7CiAgfSBlbHNlIGlmIChjaGFydE5hbWUgPT09ICJCYXJDaGFydCIpIHsKICAgIHJlc3RQcm9wcyA9IGdldEN1cnNvclJlY3RhbmdsZShsYXlvdXQsIGFjdGl2ZUNvb3JkaW5hdGUsIG9mZnNldCwgdG9vbHRpcEF4aXNCYW5kU2l6ZSk7CiAgICBjdXJzb3JDb21wID0gUmVjdGFuZ2xlOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvclJlY3RhbmdsZTsKICB9IGVsc2UgaWYgKGxheW91dCA9PT0gInJhZGlhbCIgJiYgaXNQb2xhckNvb3JkaW5hdGUoYWN0aXZlQ29vcmRpbmF0ZSkpIHsKICAgIHZhciB7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcmFkaXVzLAogICAgICBzdGFydEFuZ2xlLAogICAgICBlbmRBbmdsZQogICAgfSA9IGdldFJhZGlhbEN1cnNvclBvaW50cyhhY3RpdmVDb29yZGluYXRlKTsKICAgIHJlc3RQcm9wcyA9IHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBzdGFydEFuZ2xlLAogICAgICBlbmRBbmdsZSwKICAgICAgaW5uZXJSYWRpdXM6IHJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXM6IHJhZGl1cwogICAgfTsKICAgIGN1cnNvckNvbXAgPSBTZWN0b3I7CiAgICBwcmVmZXJyZWRaSW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuY3Vyc29yTGluZTsKICB9IGVsc2UgewogICAgcmVzdFByb3BzID0gewogICAgICBwb2ludHM6IGdldEN1cnNvclBvaW50cyhsYXlvdXQsIGFjdGl2ZUNvb3JkaW5hdGUsIG9mZnNldCkKICAgIH07CiAgICBjdXJzb3JDb21wID0gQ3VydmU7CiAgICBwcmVmZXJyZWRaSW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuY3Vyc29yTGluZTsKICB9CiAgdmFyIGV4dHJhQ2xhc3NOYW1lID0gdHlwZW9mIGN1cnNvciA9PT0gIm9iamVjdCIgJiYgImNsYXNzTmFtZSIgaW4gY3Vyc29yID8gY3Vyc29yLmNsYXNzTmFtZSA6IHZvaWQgMDsKICB2YXIgY3Vyc29yUHJvcHMgPSBfb2JqZWN0U3ByZWFkMTkoX29iamVjdFNwcmVhZDE5KF9vYmplY3RTcHJlYWQxOShfb2JqZWN0U3ByZWFkMTkoewogICAgc3Ryb2tlOiAiI2NjYyIsCiAgICBwb2ludGVyRXZlbnRzOiAibm9uZSIKICB9LCBvZmZzZXQpLCByZXN0UHJvcHMpLCBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihjdXJzb3IpKSwge30sIHsKICAgIHBheWxvYWQ6IGFjdGl2ZVBheWxvYWQsCiAgICBwYXlsb2FkSW5kZXg6IGFjdGl2ZVRvb2x0aXBJbmRleCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtdG9vbHRpcC1jdXJzb3IiLCBleHRyYUNsYXNzTmFtZSkKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTEuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiAoX3Byb3BzJHpJbmRleCA9IHByb3BzLnpJbmRleCkgIT09IG51bGwgJiYgX3Byb3BzJHpJbmRleCAhPT0gdm9pZCAwID8gX3Byb3BzJHpJbmRleCA6IHByZWZlcnJlZFpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDExLmNyZWF0ZUVsZW1lbnQoUmVuZGVyQ3Vyc29yLCB7CiAgICBjdXJzb3IsCiAgICBjdXJzb3JDb21wLAogICAgY3Vyc29yUHJvcHMKICB9KSk7Cn0KZnVuY3Rpb24gQ3Vyc29yKHByb3BzKSB7CiAgdmFyIHRvb2x0aXBBeGlzQmFuZFNpemUgPSB1c2VUb29sdGlwQXhpc0JhbmRTaXplKCk7CiAgdmFyIG9mZnNldCA9IHVzZU9mZnNldEludGVybmFsKCk7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgdmFyIGNoYXJ0TmFtZSA9IHVzZUNoYXJ0TmFtZSgpOwogIGlmICh0b29sdGlwQXhpc0JhbmRTaXplID09IG51bGwgfHwgb2Zmc2V0ID09IG51bGwgfHwgbGF5b3V0ID09IG51bGwgfHwgY2hhcnROYW1lID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTEuY3JlYXRlRWxlbWVudChDdXJzb3JJbnRlcm5hbCwgX2V4dGVuZHM5KHt9LCBwcm9wcywgewogICAgb2Zmc2V0LAogICAgbGF5b3V0LAogICAgdG9vbHRpcEF4aXNCYW5kU2l6ZSwKICAgIGNoYXJ0TmFtZQogIH0pKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L3Rvb2x0aXBQb3J0YWxDb250ZXh0LmpzCnZhciBpbXBvcnRfcmVhY3QyMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFRvb2x0aXBQb3J0YWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMi5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIHVzZVRvb2x0aXBQb3J0YWwgPSAoKSA9PiAoMCwgaW1wb3J0X3JlYWN0MjIudXNlQ29udGV4dCkoVG9vbHRpcFBvcnRhbENvbnRleHQpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zeW5jaHJvbmlzYXRpb24vdXNlQ2hhcnRTeW5jaHJvbmlzYXRpb24uanMKdmFyIGltcG9ydF9yZWFjdDIzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXgubWpzCnZhciBpbXBvcnRfaW5kZXggPSBfX3RvRVNNKHJlcXVpcmVfZXZlbnRlbWl0dGVyMygpLCAxKTsKdmFyIGV2ZW50ZW1pdHRlcjNfZGVmYXVsdCA9IGltcG9ydF9pbmRleC5kZWZhdWx0OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0V2ZW50cy5qcwp2YXIgZXZlbnRDZW50ZXIgPSBuZXcgZXZlbnRlbWl0dGVyM19kZWZhdWx0KCk7CnZhciBUT09MVElQX1NZTkNfRVZFTlQgPSAicmVjaGFydHMuc3luY0V2ZW50LnRvb2x0aXAiOwp2YXIgQlJVU0hfU1lOQ19FVkVOVCA9ICJyZWNoYXJ0cy5zeW5jRXZlbnQuYnJ1c2giOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9vcHRpb25zU2xpY2UuanMKZnVuY3Rpb24gYXJyYXlUb29sdGlwU2VhcmNoZXIoZGF0YSwgc3RySW5kZXgpIHsKICBpZiAoIXN0ckluZGV4KSByZXR1cm4gdm9pZCAwOwogIHZhciBudW1JbmRleCA9IE51bWJlci5wYXJzZUludChzdHJJbmRleCwgMTApOwogIGlmIChpc05hbihudW1JbmRleCkpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFbbnVtSW5kZXhdOwp9CnZhciBpbml0aWFsU3RhdGU1ID0gewogIGNoYXJ0TmFtZTogIiIsCiAgdG9vbHRpcFBheWxvYWRTZWFyY2hlcjogdm9pZCAwLAogIGV2ZW50RW1pdHRlcjogdm9pZCAwLAogIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOiAiYXhpcyIKfTsKdmFyIG9wdGlvbnNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAib3B0aW9ucyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU1LAogIHJlZHVjZXJzOiB7CiAgICBjcmVhdGVFdmVudEVtaXR0ZXI6IChzdGF0ZSkgPT4gewogICAgICBpZiAoc3RhdGUuZXZlbnRFbWl0dGVyID09IG51bGwpIHsKICAgICAgICBzdGF0ZS5ldmVudEVtaXR0ZXIgPSBTeW1ib2woInJlY2hhcnRzRXZlbnRFbWl0dGVyIik7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgb3B0aW9uc1JlZHVjZXIgPSBvcHRpb25zU2xpY2UucmVkdWNlcjsKdmFyIHsKICBjcmVhdGVFdmVudEVtaXR0ZXIKfSA9IG9wdGlvbnNTbGljZS5hY3Rpb25zOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zeW5jaHJvbmlzYXRpb24vc3luY1NlbGVjdG9ycy5qcwpmdW5jdGlvbiBzZWxlY3RTeW5jaHJvbmlzZWRUb29sdGlwU3RhdGUoc3RhdGUpIHsKICByZXR1cm4gc3RhdGUudG9vbHRpcC5zeW5jSW50ZXJhY3Rpb247Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvY2hhcnREYXRhU2xpY2UuanMKdmFyIGluaXRpYWxDaGFydERhdGFTdGF0ZSA9IHsKICBjaGFydERhdGE6IHZvaWQgMCwKICBjb21wdXRlZERhdGE6IHZvaWQgMCwKICBkYXRhU3RhcnRJbmRleDogMCwKICBkYXRhRW5kSW5kZXg6IDAKfTsKdmFyIGNoYXJ0RGF0YVNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJjaGFydERhdGEiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbENoYXJ0RGF0YVN0YXRlLAogIHJlZHVjZXJzOiB7CiAgICBzZXRDaGFydERhdGEoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5jaGFydERhdGEgPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkID09IG51bGwpIHsKICAgICAgICBzdGF0ZS5kYXRhU3RhcnRJbmRleCA9IDA7CiAgICAgICAgc3RhdGUuZGF0YUVuZEluZGV4ID0gMDsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkLmxlbmd0aCA+IDAgJiYgc3RhdGUuZGF0YUVuZEluZGV4ICE9PSBhY3Rpb24ucGF5bG9hZC5sZW5ndGggLSAxKSB7CiAgICAgICAgc3RhdGUuZGF0YUVuZEluZGV4ID0gYWN0aW9uLnBheWxvYWQubGVuZ3RoIC0gMTsKICAgICAgfQogICAgfSwKICAgIHNldENvbXB1dGVkRGF0YShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmNvbXB1dGVkRGF0YSA9IGFjdGlvbi5wYXlsb2FkOwogICAgfSwKICAgIHNldERhdGFTdGFydEVuZEluZGV4ZXMoc3RhdGUsIGFjdGlvbikgewogICAgICB2YXIgewogICAgICAgIHN0YXJ0SW5kZXgsCiAgICAgICAgZW5kSW5kZXgKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoc3RhcnRJbmRleCAhPSBudWxsKSB7CiAgICAgICAgc3RhdGUuZGF0YVN0YXJ0SW5kZXggPSBzdGFydEluZGV4OwogICAgICB9CiAgICAgIGlmIChlbmRJbmRleCAhPSBudWxsKSB7CiAgICAgICAgc3RhdGUuZGF0YUVuZEluZGV4ID0gZW5kSW5kZXg7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgewogIHNldENoYXJ0RGF0YSwKICBzZXREYXRhU3RhcnRFbmRJbmRleGVzLAogIHNldENvbXB1dGVkRGF0YQp9ID0gY2hhcnREYXRhU2xpY2UuYWN0aW9uczsKdmFyIGNoYXJ0RGF0YVJlZHVjZXIgPSBjaGFydERhdGFTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zeW5jaHJvbmlzYXRpb24vdXNlQ2hhcnRTeW5jaHJvbmlzYXRpb24uanMKdmFyIF9leGNsdWRlZDUgPSBbIngiLCAieSJdOwpmdW5jdGlvbiBvd25LZXlzMjAoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIwKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyMChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjAoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNShlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gdXNlVG9vbHRpcFN5bmNFdmVudHNMaXN0ZW5lcigpIHsKICB2YXIgbXlTeW5jSWQgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jSWQpOwogIHZhciBteUV2ZW50RW1pdHRlciA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEV2ZW50RW1pdHRlcik7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgc3luY01ldGhvZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNNZXRob2QpOwogIHZhciB0b29sdGlwVGlja3MgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpc1RpY2tzKTsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICB2YXIgdmlld0JveCA9IHVzZVZpZXdCb3goKTsKICB2YXIgY2xhc3NOYW1lID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuY2xhc3NOYW1lKTsKICAoMCwgaW1wb3J0X3JlYWN0MjMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAobXlTeW5jSWQgPT0gbnVsbCkgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBsaXN0ZW5lcjIgPSAoaW5jb21pbmdTeW5jSWQsIGFjdGlvbiwgZW1pdHRlcikgPT4gewogICAgICBpZiAobXlFdmVudEVtaXR0ZXIgPT09IGVtaXR0ZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKG15U3luY0lkICE9PSBpbmNvbWluZ1N5bmNJZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoc3luY01ldGhvZCA9PT0gImluZGV4IikgewogICAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQ7CiAgICAgICAgaWYgKHZpZXdCb3ggJiYgYWN0aW9uICE9PSBudWxsICYmIGFjdGlvbiAhPT0gdm9pZCAwICYmIChfYWN0aW9uJHBheWxvYWQgPSBhY3Rpb24ucGF5bG9hZCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkICE9PSB2b2lkIDAgJiYgX2FjdGlvbiRwYXlsb2FkLmNvb3JkaW5hdGUgJiYgYWN0aW9uLnBheWxvYWQuc291cmNlVmlld0JveCkgewogICAgICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZCRjb29yZCA9IGFjdGlvbi5wYXlsb2FkLmNvb3JkaW5hdGUsIHsKICAgICAgICAgICAgeDogX3gsCiAgICAgICAgICAgIHk6IF95CiAgICAgICAgICB9ID0gX2FjdGlvbiRwYXlsb2FkJGNvb3JkLCBvdGhlckNvb3JkaW5hdGVQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczUoX2FjdGlvbiRwYXlsb2FkJGNvb3JkLCBfZXhjbHVkZWQ1KTsKICAgICAgICAgIHZhciB7CiAgICAgICAgICAgIHg6IHNvdXJjZVgsCiAgICAgICAgICAgIHk6IHNvdXJjZVksCiAgICAgICAgICAgIHdpZHRoOiBzb3VyY2VXaWR0aCwKICAgICAgICAgICAgaGVpZ2h0OiBzb3VyY2VIZWlnaHQKICAgICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZC5zb3VyY2VWaWV3Qm94OwogICAgICAgICAgdmFyIHNjYWxlZENvb3JkaW5hdGUgPSBfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKHt9LCBvdGhlckNvb3JkaW5hdGVQcm9wcyksIHt9LCB7CiAgICAgICAgICAgIHg6IHZpZXdCb3gueCArIChzb3VyY2VXaWR0aCA/IChfeCAtIHNvdXJjZVgpIC8gc291cmNlV2lkdGggOiAwKSAqIHZpZXdCb3gud2lkdGgsCiAgICAgICAgICAgIHk6IHZpZXdCb3gueSArIChzb3VyY2VIZWlnaHQgPyAoX3kgLSBzb3VyY2VZKSAvIHNvdXJjZUhlaWdodCA6IDApICogdmlld0JveC5oZWlnaHQKICAgICAgICAgIH0pOwogICAgICAgICAgZGlzcGF0Y2goX29iamVjdFNwcmVhZDIwKF9vYmplY3RTcHJlYWQyMCh7fSwgYWN0aW9uKSwge30sIHsKICAgICAgICAgICAgcGF5bG9hZDogX29iamVjdFNwcmVhZDIwKF9vYmplY3RTcHJlYWQyMCh7fSwgYWN0aW9uLnBheWxvYWQpLCB7fSwgewogICAgICAgICAgICAgIGNvb3JkaW5hdGU6IHNjYWxlZENvb3JkaW5hdGUKICAgICAgICAgICAgfSkKICAgICAgICAgIH0pKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGlzcGF0Y2goYWN0aW9uKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0b29sdGlwVGlja3MgPT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgYWN0aXZlVGljazsKICAgICAgaWYgKHR5cGVvZiBzeW5jTWV0aG9kID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdmFyIHN5bmNNZXRob2RQYXJhbSA9IHsKICAgICAgICAgIGFjdGl2ZVRvb2x0aXBJbmRleDogYWN0aW9uLnBheWxvYWQuaW5kZXggPT0gbnVsbCA/IHZvaWQgMCA6IE51bWJlcihhY3Rpb24ucGF5bG9hZC5pbmRleCksCiAgICAgICAgICBpc1Rvb2x0aXBBY3RpdmU6IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZSwKICAgICAgICAgIGFjdGl2ZUluZGV4OiBhY3Rpb24ucGF5bG9hZC5pbmRleCA9PSBudWxsID8gdm9pZCAwIDogTnVtYmVyKGFjdGlvbi5wYXlsb2FkLmluZGV4KSwKICAgICAgICAgIGFjdGl2ZUxhYmVsOiBhY3Rpb24ucGF5bG9hZC5sYWJlbCwKICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IGFjdGlvbi5wYXlsb2FkLmRhdGFLZXksCiAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3Rpb24ucGF5bG9hZC5jb29yZGluYXRlCiAgICAgICAgfTsKICAgICAgICB2YXIgYWN0aXZlVG9vbHRpcEluZGV4ID0gc3luY01ldGhvZCh0b29sdGlwVGlja3MsIHN5bmNNZXRob2RQYXJhbSk7CiAgICAgICAgYWN0aXZlVGljayA9IHRvb2x0aXBUaWNrc1thY3RpdmVUb29sdGlwSW5kZXhdOwogICAgICB9IGVsc2UgaWYgKHN5bmNNZXRob2QgPT09ICJ2YWx1ZSIpIHsKICAgICAgICBhY3RpdmVUaWNrID0gdG9vbHRpcFRpY2tzLmZpbmQoKHRpY2spID0+IFN0cmluZyh0aWNrLnZhbHVlKSA9PT0gYWN0aW9uLnBheWxvYWQubGFiZWwpOwogICAgICB9CiAgICAgIHZhciB7CiAgICAgICAgY29vcmRpbmF0ZQogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChhY3RpdmVUaWNrID09IG51bGwgfHwgYWN0aW9uLnBheWxvYWQuYWN0aXZlID09PSBmYWxzZSB8fCBjb29yZGluYXRlID09IG51bGwgfHwgdmlld0JveCA9PSBudWxsKSB7CiAgICAgICAgZGlzcGF0Y2goc2V0U3luY0ludGVyYWN0aW9uKHsKICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICBjb29yZGluYXRlOiB2b2lkIDAsCiAgICAgICAgICBkYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgICBpbmRleDogbnVsbCwKICAgICAgICAgIGxhYmVsOiB2b2lkIDAsCiAgICAgICAgICBzb3VyY2VWaWV3Qm94OiB2b2lkIDAsCiAgICAgICAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogICAgICAgIH0pKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHsKICAgICAgICB4OiB4MiwKICAgICAgICB5OiB5MgogICAgICB9ID0gY29vcmRpbmF0ZTsKICAgICAgdmFyIHZhbGlkYXRlQ2hhcnRYID0gTWF0aC5taW4oeDIsIHZpZXdCb3gueCArIHZpZXdCb3gud2lkdGgpOwogICAgICB2YXIgdmFsaWRhdGVDaGFydFkgPSBNYXRoLm1pbih5Miwgdmlld0JveC55ICsgdmlld0JveC5oZWlnaHQpOwogICAgICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IHsKICAgICAgICB4OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IGFjdGl2ZVRpY2suY29vcmRpbmF0ZSA6IHZhbGlkYXRlQ2hhcnRYLAogICAgICAgIHk6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gdmFsaWRhdGVDaGFydFkgOiBhY3RpdmVUaWNrLmNvb3JkaW5hdGUKICAgICAgfTsKICAgICAgdmFyIHN5bmNBY3Rpb24gPSBzZXRTeW5jSW50ZXJhY3Rpb24oewogICAgICAgIGFjdGl2ZTogYWN0aW9uLnBheWxvYWQuYWN0aXZlLAogICAgICAgIGNvb3JkaW5hdGU6IGFjdGl2ZUNvb3JkaW5hdGUsCiAgICAgICAgZGF0YUtleTogYWN0aW9uLnBheWxvYWQuZGF0YUtleSwKICAgICAgICBpbmRleDogU3RyaW5nKGFjdGl2ZVRpY2suaW5kZXgpLAogICAgICAgIGxhYmVsOiBhY3Rpb24ucGF5bG9hZC5sYWJlbCwKICAgICAgICBzb3VyY2VWaWV3Qm94OiBhY3Rpb24ucGF5bG9hZC5zb3VyY2VWaWV3Qm94LAogICAgICAgIGdyYXBoaWNhbEl0ZW1JZDogYWN0aW9uLnBheWxvYWQuZ3JhcGhpY2FsSXRlbUlkCiAgICAgIH0pOwogICAgICBkaXNwYXRjaChzeW5jQWN0aW9uKTsKICAgIH07CiAgICBldmVudENlbnRlci5vbihUT09MVElQX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBldmVudENlbnRlci5vZmYoVE9PTFRJUF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgfTsKICB9LCBbY2xhc3NOYW1lLCBkaXNwYXRjaCwgbXlFdmVudEVtaXR0ZXIsIG15U3luY0lkLCBzeW5jTWV0aG9kLCB0b29sdGlwVGlja3MsIGxheW91dCwgdmlld0JveF0pOwp9CmZ1bmN0aW9uIHVzZUJydXNoU3luY0V2ZW50c0xpc3RlbmVyKCkgewogIHZhciBteVN5bmNJZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNJZCk7CiAgdmFyIG15RXZlbnRFbWl0dGVyID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0RXZlbnRFbWl0dGVyKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChteVN5bmNJZCA9PSBudWxsKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIGxpc3RlbmVyMiA9IChpbmNvbWluZ1N5bmNJZCwgYWN0aW9uLCBlbWl0dGVyKSA9PiB7CiAgICAgIGlmIChteUV2ZW50RW1pdHRlciA9PT0gZW1pdHRlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAobXlTeW5jSWQgPT09IGluY29taW5nU3luY0lkKSB7CiAgICAgICAgZGlzcGF0Y2goc2V0RGF0YVN0YXJ0RW5kSW5kZXhlcyhhY3Rpb24pKTsKICAgICAgfQogICAgfTsKICAgIGV2ZW50Q2VudGVyLm9uKEJSVVNIX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBldmVudENlbnRlci5vZmYoQlJVU0hfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIH07CiAgfSwgW2Rpc3BhdGNoLCBteUV2ZW50RW1pdHRlciwgbXlTeW5jSWRdKTsKfQpmdW5jdGlvbiB1c2VTeW5jaHJvbmlzZWRFdmVudHNGcm9tT3RoZXJDaGFydHMoKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0MjMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaChjcmVhdGVFdmVudEVtaXR0ZXIoKSk7CiAgfSwgW2Rpc3BhdGNoXSk7CiAgdXNlVG9vbHRpcFN5bmNFdmVudHNMaXN0ZW5lcigpOwogIHVzZUJydXNoU3luY0V2ZW50c0xpc3RlbmVyKCk7Cn0KZnVuY3Rpb24gdXNlVG9vbHRpcENoYXJ0U3luY2hyb25pc2F0aW9uKHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGFjdGl2ZUNvb3JkaW5hdGUsIGFjdGl2ZUxhYmVsLCBhY3RpdmVJbmRleCwgaXNUb29sdGlwQWN0aXZlKSB7CiAgdmFyIGFjdGl2ZURhdGFLZXkgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRvb2x0aXBEYXRhS2V5KHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSk7CiAgdmFyIGV2ZW50RW1pdHRlclN5bWJvbCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEV2ZW50RW1pdHRlcik7CiAgdmFyIHN5bmNJZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNJZCk7CiAgdmFyIHN5bmNNZXRob2QgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jTWV0aG9kKTsKICB2YXIgdG9vbHRpcFN0YXRlID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY2hyb25pc2VkVG9vbHRpcFN0YXRlKTsKICB2YXIgaXNSZWNlaXZpbmdTeW5jaHJvbmlzYXRpb24gPSB0b29sdGlwU3RhdGUgPT09IG51bGwgfHwgdG9vbHRpcFN0YXRlID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0b29sdGlwU3RhdGUuYWN0aXZlOwogIHZhciB2aWV3Qm94ID0gdXNlVmlld0JveCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChpc1JlY2VpdmluZ1N5bmNocm9uaXNhdGlvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc3luY0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGV2ZW50RW1pdHRlclN5bWJvbCA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzeW5jQWN0aW9uID0gc2V0U3luY0ludGVyYWN0aW9uKHsKICAgICAgYWN0aXZlOiBpc1Rvb2x0aXBBY3RpdmUsCiAgICAgIGNvb3JkaW5hdGU6IGFjdGl2ZUNvb3JkaW5hdGUsCiAgICAgIGRhdGFLZXk6IGFjdGl2ZURhdGFLZXksCiAgICAgIGluZGV4OiBhY3RpdmVJbmRleCwKICAgICAgbGFiZWw6IHR5cGVvZiBhY3RpdmVMYWJlbCA9PT0gIm51bWJlciIgPyBTdHJpbmcoYWN0aXZlTGFiZWwpIDogYWN0aXZlTGFiZWwsCiAgICAgIHNvdXJjZVZpZXdCb3g6IHZpZXdCb3gsCiAgICAgIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwCiAgICB9KTsKICAgIGV2ZW50Q2VudGVyLmVtaXQoVE9PTFRJUF9TWU5DX0VWRU5ULCBzeW5jSWQsIHN5bmNBY3Rpb24sIGV2ZW50RW1pdHRlclN5bWJvbCk7CiAgfSwgW2lzUmVjZWl2aW5nU3luY2hyb25pc2F0aW9uLCBhY3RpdmVDb29yZGluYXRlLCBhY3RpdmVEYXRhS2V5LCBhY3RpdmVJbmRleCwgYWN0aXZlTGFiZWwsIGV2ZW50RW1pdHRlclN5bWJvbCwgc3luY0lkLCBzeW5jTWV0aG9kLCBpc1Rvb2x0aXBBY3RpdmUsIHZpZXdCb3hdKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcC5qcwpmdW5jdGlvbiBvd25LZXlzMjEoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIxKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyMShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjEoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZGVmYXVsdFVuaXFCeShlbnRyeSkgewogIHJldHVybiBlbnRyeS5kYXRhS2V5Owp9CmZ1bmN0aW9uIHJlbmRlckNvbnRlbnQoY29udGVudCwgcHJvcHMpIHsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MTIuaXNWYWxpZEVsZW1lbnQoY29udGVudCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jbG9uZUVsZW1lbnQoY29udGVudCwgcHJvcHMpOwogIH0KICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KGNvbnRlbnQsIHByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoRGVmYXVsdFRvb2x0aXBDb250ZW50LCBwcm9wcyk7Cn0KdmFyIGVtcHR5UGF5bG9hZCA9IFtdOwp2YXIgZGVmYXVsdFRvb2x0aXBQcm9wcyA9IHsKICBhbGxvd0VzY2FwZVZpZXdCb3g6IHsKICAgIHg6IGZhbHNlLAogICAgeTogZmFsc2UKICB9LAogIGFuaW1hdGlvbkR1cmF0aW9uOiA0MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIsCiAgYXhpc0lkOiAwLAogIGNvbnRlbnRTdHlsZToge30sCiAgY3Vyc29yOiB0cnVlLAogIGZpbHRlck51bGw6IHRydWUsCiAgaXNBbmltYXRpb25BY3RpdmU6ICJhdXRvIiwKICBpdGVtU29ydGVyOiAibmFtZSIsCiAgaXRlbVN0eWxlOiB7fSwKICBsYWJlbFN0eWxlOiB7fSwKICBvZmZzZXQ6IDEwLAogIHJldmVyc2VEaXJlY3Rpb246IHsKICAgIHg6IGZhbHNlLAogICAgeTogZmFsc2UKICB9LAogIHNlcGFyYXRvcjogIiA6ICIsCiAgdHJpZ2dlcjogImhvdmVyIiwKICB1c2VUcmFuc2xhdGUzZDogZmFsc2UsCiAgd3JhcHBlclN0eWxlOiB7fQp9OwpmdW5jdGlvbiBUb29sdGlwKG91dHNpZGVQcm9wcykgewogIHZhciBfdXNlQXBwU2VsZWN0b3IsIF9yZWYyOwogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0VG9vbHRpcFByb3BzKTsKICB2YXIgewogICAgYWN0aXZlOiBhY3RpdmVGcm9tUHJvcHMsCiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGNvbnRlbnQsCiAgICBmaWx0ZXJOdWxsLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBvZmZzZXQsCiAgICBwYXlsb2FkVW5pcUJ5LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdXNlVHJhbnNsYXRlM2QsCiAgICB3cmFwcGVyU3R5bGUsCiAgICBjdXJzb3IsCiAgICBzaGFyZWQsCiAgICB0cmlnZ2VyLAogICAgZGVmYXVsdEluZGV4LAogICAgcG9ydGFsOiBwb3J0YWxGcm9tUHJvcHMsCiAgICBheGlzSWQKICB9ID0gcHJvcHM7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgZGVmYXVsdEluZGV4QXNTdHJpbmcgPSB0eXBlb2YgZGVmYXVsdEluZGV4ID09PSAibnVtYmVyIiA/IFN0cmluZyhkZWZhdWx0SW5kZXgpIDogZGVmYXVsdEluZGV4OwogICgwLCBpbXBvcnRfcmVhY3QyNC51c2VFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKHNldFRvb2x0aXBTZXR0aW5nc1N0YXRlKHsKICAgICAgc2hhcmVkLAogICAgICB0cmlnZ2VyLAogICAgICBheGlzSWQsCiAgICAgIGFjdGl2ZTogYWN0aXZlRnJvbVByb3BzLAogICAgICBkZWZhdWx0SW5kZXg6IGRlZmF1bHRJbmRleEFzU3RyaW5nCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBzaGFyZWQsIHRyaWdnZXIsIGF4aXNJZCwgYWN0aXZlRnJvbVByb3BzLCBkZWZhdWx0SW5kZXhBc1N0cmluZ10pOwogIHZhciB2aWV3Qm94ID0gdXNlVmlld0JveCgpOwogIHZhciBhY2Nlc3NpYmlsaXR5TGF5ZXIgPSB1c2VBY2Nlc3NpYmlsaXR5TGF5ZXIoKTsKICB2YXIgdG9vbHRpcEV2ZW50VHlwZSA9IHVzZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkKTsKICB2YXIgewogICAgYWN0aXZlSW5kZXgsCiAgICBpc0FjdGl2ZQogIH0gPSAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUyKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXhBc1N0cmluZykpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvciA6IHt9OwogIHZhciBwYXlsb2FkRnJvbVJlZHV4ID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUb29sdGlwUGF5bG9hZChzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgbGFiZWxGcm9tUmVkdXggPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFjdGl2ZUxhYmVsMihzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgY29vcmRpbmF0ZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QWN0aXZlQ29vcmRpbmF0ZShzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgcGF5bG9hZCA9IHBheWxvYWRGcm9tUmVkdXg7CiAgdmFyIHRvb2x0aXBQb3J0YWxGcm9tQ29udGV4dCA9IHVzZVRvb2x0aXBQb3J0YWwoKTsKICB2YXIgZmluYWxJc0FjdGl2ZSA9IChfcmVmMiA9IGFjdGl2ZUZyb21Qcm9wcyAhPT0gbnVsbCAmJiBhY3RpdmVGcm9tUHJvcHMgIT09IHZvaWQgMCA/IGFjdGl2ZUZyb21Qcm9wcyA6IGlzQWN0aXZlKSAhPT0gbnVsbCAmJiBfcmVmMiAhPT0gdm9pZCAwID8gX3JlZjIgOiBmYWxzZTsKICB2YXIgW2xhc3RCb3VuZGluZ0JveCwgdXBkYXRlQm91bmRpbmdCb3hdID0gdXNlRWxlbWVudE9mZnNldChbcGF5bG9hZCwgZmluYWxJc0FjdGl2ZV0pOwogIHZhciBmaW5hbExhYmVsID0gdG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiID8gbGFiZWxGcm9tUmVkdXggOiB2b2lkIDA7CiAgdXNlVG9vbHRpcENoYXJ0U3luY2hyb25pc2F0aW9uKHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGNvb3JkaW5hdGUsIGZpbmFsTGFiZWwsIGFjdGl2ZUluZGV4LCBmaW5hbElzQWN0aXZlKTsKICB2YXIgdG9vbHRpcFBvcnRhbCA9IHBvcnRhbEZyb21Qcm9wcyAhPT0gbnVsbCAmJiBwb3J0YWxGcm9tUHJvcHMgIT09IHZvaWQgMCA/IHBvcnRhbEZyb21Qcm9wcyA6IHRvb2x0aXBQb3J0YWxGcm9tQ29udGV4dDsKICBpZiAodG9vbHRpcFBvcnRhbCA9PSBudWxsIHx8IHZpZXdCb3ggPT0gbnVsbCB8fCB0b29sdGlwRXZlbnRUeXBlID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgZmluYWxQYXlsb2FkID0gcGF5bG9hZCAhPT0gbnVsbCAmJiBwYXlsb2FkICE9PSB2b2lkIDAgPyBwYXlsb2FkIDogZW1wdHlQYXlsb2FkOwogIGlmICghZmluYWxJc0FjdGl2ZSkgewogICAgZmluYWxQYXlsb2FkID0gZW1wdHlQYXlsb2FkOwogIH0KICBpZiAoZmlsdGVyTnVsbCAmJiBmaW5hbFBheWxvYWQubGVuZ3RoKSB7CiAgICBmaW5hbFBheWxvYWQgPSBnZXRVbmlxUGF5bG9hZChmaW5hbFBheWxvYWQuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkudmFsdWUgIT0gbnVsbCAmJiAoZW50cnkuaGlkZSAhPT0gdHJ1ZSB8fCBwcm9wcy5pbmNsdWRlSGlkZGVuKSksIHBheWxvYWRVbmlxQnksIGRlZmF1bHRVbmlxQnkpOwogIH0KICB2YXIgaGFzUGF5bG9hZCA9IGZpbmFsUGF5bG9hZC5sZW5ndGggPiAwOwogIHZhciB0b29sdGlwRWxlbWVudCA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoVG9vbHRpcEJvdW5kaW5nQm94LCB7CiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgYWN0aXZlOiBmaW5hbElzQWN0aXZlLAogICAgY29vcmRpbmF0ZSwKICAgIGhhc1BheWxvYWQsCiAgICBvZmZzZXQsCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB1c2VUcmFuc2xhdGUzZCwKICAgIHZpZXdCb3gsCiAgICB3cmFwcGVyU3R5bGUsCiAgICBsYXN0Qm91bmRpbmdCb3gsCiAgICBpbm5lclJlZjogdXBkYXRlQm91bmRpbmdCb3gsCiAgICBoYXNQb3J0YWxGcm9tUHJvcHM6IEJvb2xlYW4ocG9ydGFsRnJvbVByb3BzKQogIH0sIHJlbmRlckNvbnRlbnQoY29udGVudCwgX29iamVjdFNwcmVhZDIxKF9vYmplY3RTcHJlYWQyMSh7fSwgcHJvcHMpLCB7fSwgewogICAgcGF5bG9hZDogZmluYWxQYXlsb2FkLAogICAgbGFiZWw6IGZpbmFsTGFiZWwsCiAgICBhY3RpdmU6IGZpbmFsSXNBY3RpdmUsCiAgICBhY3RpdmVJbmRleCwKICAgIGNvb3JkaW5hdGUsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXIKICB9KSkpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KFJlYWN0MTIuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0X2RvbTIuY3JlYXRlUG9ydGFsKSh0b29sdGlwRWxlbWVudCwgdG9vbHRpcFBvcnRhbCksIGZpbmFsSXNBY3RpdmUgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChDdXJzb3IsIHsKICAgIGN1cnNvciwKICAgIHRvb2x0aXBFdmVudFR5cGUsCiAgICBjb29yZGluYXRlLAogICAgcGF5bG9hZDogZmluYWxQYXlsb2FkLAogICAgaW5kZXg6IGFjdGl2ZUluZGV4CiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9UZXh0LmpzCnZhciBSZWFjdDEzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvTFJVQ2FjaGUuanMKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIExSVUNhY2hlID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKG1heFNpemUpIHsKICAgIF9kZWZpbmVQcm9wZXJ0eTIyKHRoaXMsICJjYWNoZSIsIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogICAgdGhpcy5tYXhTaXplID0gbWF4U2l6ZTsKICB9CiAgZ2V0KGtleSkgewogICAgdmFyIHZhbHVlID0gdGhpcy5jYWNoZS5nZXQoa2V5KTsKICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKSB7CiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7CiAgICAgIHRoaXMuY2FjaGUuc2V0KGtleSwgdmFsdWUpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KICBzZXQoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMuY2FjaGUuaGFzKGtleSkpIHsKICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTsKICAgIH0gZWxzZSBpZiAodGhpcy5jYWNoZS5zaXplID49IHRoaXMubWF4U2l6ZSkgewogICAgICB2YXIgZmlyc3RLZXkgPSB0aGlzLmNhY2hlLmtleXMoKS5uZXh0KCkudmFsdWU7CiAgICAgIGlmIChmaXJzdEtleSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5jYWNoZS5kZWxldGUoZmlyc3RLZXkpOwogICAgICB9CiAgICB9CiAgICB0aGlzLmNhY2hlLnNldChrZXksIHZhbHVlKTsKICB9CiAgY2xlYXIoKSB7CiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7CiAgfQogIHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5jYWNoZS5zaXplOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9ET01VdGlscy5qcwpmdW5jdGlvbiBvd25LZXlzMjIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyMyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjMoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGRlZmF1bHRDb25maWcgPSB7CiAgY2FjaGVTaXplOiAyZTMsCiAgZW5hYmxlQ2FjaGU6IHRydWUKfTsKdmFyIGN1cnJlbnRDb25maWcgPSBfb2JqZWN0U3ByZWFkMjIoe30sIGRlZmF1bHRDb25maWcpOwp2YXIgc3RyaW5nQ2FjaGUgPSBuZXcgTFJVQ2FjaGUoY3VycmVudENvbmZpZy5jYWNoZVNpemUpOwp2YXIgU1BBTl9TVFlMRSA9IHsKICBwb3NpdGlvbjogImFic29sdXRlIiwKICB0b3A6ICItMjAwMDBweCIsCiAgbGVmdDogMCwKICBwYWRkaW5nOiAwLAogIG1hcmdpbjogMCwKICBib3JkZXI6ICJub25lIiwKICB3aGl0ZVNwYWNlOiAicHJlIgp9Owp2YXIgTUVBU1VSRU1FTlRfU1BBTl9JRCA9ICJyZWNoYXJ0c19tZWFzdXJlbWVudF9zcGFuIjsKZnVuY3Rpb24gY3JlYXRlQ2FjaGVLZXkodGV4dCwgc3R5bGUpIHsKICB2YXIgZm9udFNpemUgPSBzdHlsZS5mb250U2l6ZSB8fCAiIjsKICB2YXIgZm9udEZhbWlseSA9IHN0eWxlLmZvbnRGYW1pbHkgfHwgIiI7CiAgdmFyIGZvbnRXZWlnaHQgPSBzdHlsZS5mb250V2VpZ2h0IHx8ICIiOwogIHZhciBmb250U3R5bGUgPSBzdHlsZS5mb250U3R5bGUgfHwgIiI7CiAgdmFyIGxldHRlclNwYWNpbmcgPSBzdHlsZS5sZXR0ZXJTcGFjaW5nIHx8ICIiOwogIHZhciB0ZXh0VHJhbnNmb3JtID0gc3R5bGUudGV4dFRyYW5zZm9ybSB8fCAiIjsKICByZXR1cm4gIiIuY29uY2F0KHRleHQsICJ8IikuY29uY2F0KGZvbnRTaXplLCAifCIpLmNvbmNhdChmb250RmFtaWx5LCAifCIpLmNvbmNhdChmb250V2VpZ2h0LCAifCIpLmNvbmNhdChmb250U3R5bGUsICJ8IikuY29uY2F0KGxldHRlclNwYWNpbmcsICJ8IikuY29uY2F0KHRleHRUcmFuc2Zvcm0pOwp9CnZhciBtZWFzdXJlVGV4dFdpdGhET00gPSAodGV4dCwgc3R5bGUpID0+IHsKICB0cnkgewogICAgdmFyIG1lYXN1cmVtZW50U3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKE1FQVNVUkVNRU5UX1NQQU5fSUQpOwogICAgaWYgKCFtZWFzdXJlbWVudFNwYW4pIHsKICAgICAgbWVhc3VyZW1lbnRTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICBtZWFzdXJlbWVudFNwYW4uc2V0QXR0cmlidXRlKCJpZCIsIE1FQVNVUkVNRU5UX1NQQU5fSUQpOwogICAgICBtZWFzdXJlbWVudFNwYW4uc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsICJ0cnVlIik7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobWVhc3VyZW1lbnRTcGFuKTsKICAgIH0KICAgIE9iamVjdC5hc3NpZ24obWVhc3VyZW1lbnRTcGFuLnN0eWxlLCBTUEFOX1NUWUxFLCBzdHlsZSk7CiAgICBtZWFzdXJlbWVudFNwYW4udGV4dENvbnRlbnQgPSAiIi5jb25jYXQodGV4dCk7CiAgICB2YXIgcmVjdCA9IG1lYXN1cmVtZW50U3Bhbi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiByZWN0LndpZHRoLAogICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0CiAgICB9OwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgfQp9Owp2YXIgZ2V0U3RyaW5nU2l6ZSA9IGZ1bmN0aW9uIGdldFN0cmluZ1NpemUyKHRleHQpIHsKICB2YXIgc3R5bGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogIGlmICh0ZXh0ID09PSB2b2lkIDAgfHwgdGV4dCA9PT0gbnVsbCB8fCBHbG9iYWwuaXNTc3IpIHsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgfQogIGlmICghY3VycmVudENvbmZpZy5lbmFibGVDYWNoZSkgewogICAgcmV0dXJuIG1lYXN1cmVUZXh0V2l0aERPTSh0ZXh0LCBzdHlsZSk7CiAgfQogIHZhciBjYWNoZUtleSA9IGNyZWF0ZUNhY2hlS2V5KHRleHQsIHN0eWxlKTsKICB2YXIgY2FjaGVkUmVzdWx0ID0gc3RyaW5nQ2FjaGUuZ2V0KGNhY2hlS2V5KTsKICBpZiAoY2FjaGVkUmVzdWx0KSB7CiAgICByZXR1cm4gY2FjaGVkUmVzdWx0OwogIH0KICB2YXIgcmVzdWx0ID0gbWVhc3VyZVRleHRXaXRoRE9NKHRleHQsIHN0eWxlKTsKICBzdHJpbmdDYWNoZS5zZXQoY2FjaGVLZXksIHJlc3VsdCk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9SZWR1Y2VDU1NDYWxjLmpzCnZhciBNVUxUSVBMWV9PUl9ESVZJREVfUkVHRVggPSAvKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopKFsqL10pKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopLzsKdmFyIEFERF9PUl9TVUJUUkFDVF9SRUdFWCA9IC8oLT9cZCsoPzpcLlxkKyk/W2EtekEtWiVdKikoWystXSkoLT9cZCsoPzpcLlxkKyk/W2EtekEtWiVdKikvOwp2YXIgQ1NTX0xFTkdUSF9VTklUX1JFR0VYID0gL15weHxjbXx2aHx2d3xlbXxyZW18JXxtbXxpbnxwdHxwY3xleHxjaHx2bWlufHZtYXh8USQvOwp2YXIgTlVNX1NQTElUX1JFR0VYID0gLygtP1xkKyg/OlwuXGQrKT8pKFthLXpBLVolXSspPy87CnZhciBDT05WRVJTSU9OX1JBVEVTID0gewogIGNtOiA5NiAvIDIuNTQsCiAgbW06IDk2IC8gMjUuNCwKICBwdDogOTYgLyA3MiwKICBwYzogOTYgLyA2LAogIGluOiA5NiwKICBROiA5NiAvICgyLjU0ICogNDApLAogIHB4OiAxCn07CnZhciBGSVhFRF9DU1NfTEVOR1RIX1VOSVRTID0gT2JqZWN0LmtleXMoQ09OVkVSU0lPTl9SQVRFUyk7CnZhciBTVFJfTkFOID0gIk5hTiI7CmZ1bmN0aW9uIGNvbnZlcnRUb1B4KHZhbHVlLCB1bml0MikgewogIHJldHVybiB2YWx1ZSAqIENPTlZFUlNJT05fUkFURVNbdW5pdDJdOwp9CnZhciBEZWNpbWFsQ1NTID0gY2xhc3MgX0RlY2ltYWxDU1MgewogIHN0YXRpYyBwYXJzZShzdHIpIHsKICAgIHZhciBfTlVNX1NQTElUX1JFR0VYJGV4ZWM7CiAgICB2YXIgWywgbnVtU3RyLCB1bml0Ml0gPSAoX05VTV9TUExJVF9SRUdFWCRleGVjID0gTlVNX1NQTElUX1JFR0VYLmV4ZWMoc3RyKSkgIT09IG51bGwgJiYgX05VTV9TUExJVF9SRUdFWCRleGVjICE9PSB2b2lkIDAgPyBfTlVNX1NQTElUX1JFR0VYJGV4ZWMgOiBbXTsKICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MocGFyc2VGbG9hdChudW1TdHIpLCB1bml0MiAhPT0gbnVsbCAmJiB1bml0MiAhPT0gdm9pZCAwID8gdW5pdDIgOiAiIik7CiAgfQogIGNvbnN0cnVjdG9yKG51bSwgdW5pdDIpIHsKICAgIHRoaXMubnVtID0gbnVtOwogICAgdGhpcy51bml0ID0gdW5pdDI7CiAgICB0aGlzLm51bSA9IG51bTsKICAgIHRoaXMudW5pdCA9IHVuaXQyOwogICAgaWYgKGlzTmFuKG51bSkpIHsKICAgICAgdGhpcy51bml0ID0gIiI7CiAgICB9CiAgICBpZiAodW5pdDIgIT09ICIiICYmICFDU1NfTEVOR1RIX1VOSVRfUkVHRVgudGVzdCh1bml0MikpIHsKICAgICAgdGhpcy5udW0gPSBOYU47CiAgICAgIHRoaXMudW5pdCA9ICIiOwogICAgfQogICAgaWYgKEZJWEVEX0NTU19MRU5HVEhfVU5JVFMuaW5jbHVkZXModW5pdDIpKSB7CiAgICAgIHRoaXMubnVtID0gY29udmVydFRvUHgobnVtLCB1bml0Mik7CiAgICAgIHRoaXMudW5pdCA9ICJweCI7CiAgICB9CiAgfQogIGFkZChvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gb3RoZXIudW5pdCkgewogICAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKE5hTiwgIiIpOwogICAgfQogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyh0aGlzLm51bSArIG90aGVyLm51bSwgdGhpcy51bml0KTsKICB9CiAgc3VidHJhY3Qob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gLSBvdGhlci5udW0sIHRoaXMudW5pdCk7CiAgfQogIG11bHRpcGx5KG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSAiIiAmJiBvdGhlci51bml0ICE9PSAiIiAmJiB0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gKiBvdGhlci5udW0sIHRoaXMudW5pdCB8fCBvdGhlci51bml0KTsKICB9CiAgZGl2aWRlKG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSAiIiAmJiBvdGhlci51bml0ICE9PSAiIiAmJiB0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gLyBvdGhlci5udW0sIHRoaXMudW5pdCB8fCBvdGhlci51bml0KTsKICB9CiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gIiIuY29uY2F0KHRoaXMubnVtKS5jb25jYXQodGhpcy51bml0KTsKICB9CiAgaXNOYU4oKSB7CiAgICByZXR1cm4gaXNOYW4odGhpcy5udW0pOwogIH0KfTsKZnVuY3Rpb24gY2FsY3VsYXRlQXJpdGhtZXRpYyhleHByKSB7CiAgaWYgKGV4cHIuaW5jbHVkZXMoU1RSX05BTikpIHsKICAgIHJldHVybiBTVFJfTkFOOwogIH0KICB2YXIgbmV3RXhwciA9IGV4cHI7CiAgd2hpbGUgKG5ld0V4cHIuaW5jbHVkZXMoIioiKSB8fCBuZXdFeHByLmluY2x1ZGVzKCIvIikpIHsKICAgIHZhciBfTVVMVElQTFlfT1JfRElWSURFX1I7CiAgICB2YXIgWywgbGVmdE9wZXJhbmQsIG9wZXJhdG9yLCByaWdodE9wZXJhbmRdID0gKF9NVUxUSVBMWV9PUl9ESVZJREVfUiA9IE1VTFRJUExZX09SX0RJVklERV9SRUdFWC5leGVjKG5ld0V4cHIpKSAhPT0gbnVsbCAmJiBfTVVMVElQTFlfT1JfRElWSURFX1IgIT09IHZvaWQgMCA/IF9NVUxUSVBMWV9PUl9ESVZJREVfUiA6IFtdOwogICAgdmFyIGxUcyA9IERlY2ltYWxDU1MucGFyc2UobGVmdE9wZXJhbmQgIT09IG51bGwgJiYgbGVmdE9wZXJhbmQgIT09IHZvaWQgMCA/IGxlZnRPcGVyYW5kIDogIiIpOwogICAgdmFyIHJUcyA9IERlY2ltYWxDU1MucGFyc2UocmlnaHRPcGVyYW5kICE9PSBudWxsICYmIHJpZ2h0T3BlcmFuZCAhPT0gdm9pZCAwID8gcmlnaHRPcGVyYW5kIDogIiIpOwogICAgdmFyIHJlc3VsdCA9IG9wZXJhdG9yID09PSAiKiIgPyBsVHMubXVsdGlwbHkoclRzKSA6IGxUcy5kaXZpZGUoclRzKTsKICAgIGlmIChyZXN1bHQuaXNOYU4oKSkgewogICAgICByZXR1cm4gU1RSX05BTjsKICAgIH0KICAgIG5ld0V4cHIgPSBuZXdFeHByLnJlcGxhY2UoTVVMVElQTFlfT1JfRElWSURFX1JFR0VYLCByZXN1bHQudG9TdHJpbmcoKSk7CiAgfQogIHdoaWxlIChuZXdFeHByLmluY2x1ZGVzKCIrIikgfHwgLy4tXGQrKD86XC5cZCspPy8udGVzdChuZXdFeHByKSkgewogICAgdmFyIF9BRERfT1JfU1VCVFJBQ1RfUkVHRTsKICAgIHZhciBbLCBfbGVmdE9wZXJhbmQsIF9vcGVyYXRvciwgX3JpZ2h0T3BlcmFuZF0gPSAoX0FERF9PUl9TVUJUUkFDVF9SRUdFID0gQUREX09SX1NVQlRSQUNUX1JFR0VYLmV4ZWMobmV3RXhwcikpICE9PSBudWxsICYmIF9BRERfT1JfU1VCVFJBQ1RfUkVHRSAhPT0gdm9pZCAwID8gX0FERF9PUl9TVUJUUkFDVF9SRUdFIDogW107CiAgICB2YXIgX2xUcyA9IERlY2ltYWxDU1MucGFyc2UoX2xlZnRPcGVyYW5kICE9PSBudWxsICYmIF9sZWZ0T3BlcmFuZCAhPT0gdm9pZCAwID8gX2xlZnRPcGVyYW5kIDogIiIpOwogICAgdmFyIF9yVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKF9yaWdodE9wZXJhbmQgIT09IG51bGwgJiYgX3JpZ2h0T3BlcmFuZCAhPT0gdm9pZCAwID8gX3JpZ2h0T3BlcmFuZCA6ICIiKTsKICAgIHZhciBfcmVzdWx0ID0gX29wZXJhdG9yID09PSAiKyIgPyBfbFRzLmFkZChfclRzKSA6IF9sVHMuc3VidHJhY3QoX3JUcyk7CiAgICBpZiAoX3Jlc3VsdC5pc05hTigpKSB7CiAgICAgIHJldHVybiBTVFJfTkFOOwogICAgfQogICAgbmV3RXhwciA9IG5ld0V4cHIucmVwbGFjZShBRERfT1JfU1VCVFJBQ1RfUkVHRVgsIF9yZXN1bHQudG9TdHJpbmcoKSk7CiAgfQogIHJldHVybiBuZXdFeHByOwp9CnZhciBQQVJFTlRIRVNFU19SRUdFWCA9IC9cKChbXigpXSopXCkvOwpmdW5jdGlvbiBjYWxjdWxhdGVQYXJlbnRoZXNlcyhleHByKSB7CiAgdmFyIG5ld0V4cHIgPSBleHByOwogIHZhciBtYXRjaDsKICB3aGlsZSAoKG1hdGNoID0gUEFSRU5USEVTRVNfUkVHRVguZXhlYyhuZXdFeHByKSkgIT0gbnVsbCkgewogICAgdmFyIFssIHBhcmVudGhldGljYWxFeHByZXNzaW9uXSA9IG1hdGNoOwogICAgbmV3RXhwciA9IG5ld0V4cHIucmVwbGFjZShQQVJFTlRIRVNFU19SRUdFWCwgY2FsY3VsYXRlQXJpdGhtZXRpYyhwYXJlbnRoZXRpY2FsRXhwcmVzc2lvbikpOwogIH0KICByZXR1cm4gbmV3RXhwcjsKfQpmdW5jdGlvbiBldmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbikgewogIHZhciBuZXdFeHByID0gZXhwcmVzc2lvbi5yZXBsYWNlKC9ccysvZywgIiIpOwogIG5ld0V4cHIgPSBjYWxjdWxhdGVQYXJlbnRoZXNlcyhuZXdFeHByKTsKICBuZXdFeHByID0gY2FsY3VsYXRlQXJpdGhtZXRpYyhuZXdFeHByKTsKICByZXR1cm4gbmV3RXhwcjsKfQpmdW5jdGlvbiBzYWZlRXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24pIHsKICB0cnkgewogICAgcmV0dXJuIGV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uKTsKICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICByZXR1cm4gU1RSX05BTjsKICB9Cn0KZnVuY3Rpb24gcmVkdWNlQ1NTQ2FsYyhleHByZXNzaW9uKSB7CiAgdmFyIHJlc3VsdCA9IHNhZmVFdmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbi5zbGljZSg1LCAtMSkpOwogIGlmIChyZXN1bHQgPT09IFNUUl9OQU4pIHsKICAgIHJldHVybiAiIjsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVGV4dC5qcwp2YXIgX2V4Y2x1ZGVkNiA9IFsieCIsICJ5IiwgImxpbmVIZWlnaHQiLCAiY2FwSGVpZ2h0IiwgImZpbGwiLCAic2NhbGVUb0ZpdCIsICJ0ZXh0QW5jaG9yIiwgInZlcnRpY2FsQW5jaG9yIl07CnZhciBfZXhjbHVkZWQyMyA9IFsiZHgiLCAiZHkiLCAiYW5nbGUiLCAiY2xhc3NOYW1lIiwgImJyZWFrQWxsIl07CmZ1bmN0aW9uIF9leHRlbmRzMTAoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTAgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczEwLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNihlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIEJSRUFLSU5HX1NQQUNFUyA9IC9bIFxmXG5cclx0XHZcdTIwMjhcdTIwMjldKy87CnZhciBjYWxjdWxhdGVXb3JkV2lkdGhzID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgYnJlYWtBbGwsCiAgICBzdHlsZQogIH0gPSBfcmVmMjsKICB0cnkgewogICAgdmFyIHdvcmRzID0gW107CiAgICBpZiAoIWlzTnVsbGlzaChjaGlsZHJlbikpIHsKICAgICAgaWYgKGJyZWFrQWxsKSB7CiAgICAgICAgd29yZHMgPSBjaGlsZHJlbi50b1N0cmluZygpLnNwbGl0KCIiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3b3JkcyA9IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoQlJFQUtJTkdfU1BBQ0VTKTsKICAgICAgfQogICAgfQogICAgdmFyIHdvcmRzV2l0aENvbXB1dGVkV2lkdGggPSB3b3Jkcy5tYXAoKHdvcmQpID0+ICh7CiAgICAgIHdvcmQsCiAgICAgIHdpZHRoOiBnZXRTdHJpbmdTaXplKHdvcmQsIHN0eWxlKS53aWR0aAogICAgfSkpOwogICAgdmFyIHNwYWNlV2lkdGggPSBicmVha0FsbCA/IDAgOiBnZXRTdHJpbmdTaXplKCJceEEwIiwgc3R5bGUpLndpZHRoOwogICAgcmV0dXJuIHsKICAgICAgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwKICAgICAgc3BhY2VXaWR0aAogICAgfTsKICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn07CmZ1bmN0aW9uIGlzVmFsaWRUZXh0QW5jaG9yKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlID09PSAic3RhcnQiIHx8IHZhbHVlID09PSAibWlkZGxlIiB8fCB2YWx1ZSA9PT0gImVuZCIgfHwgdmFsdWUgPT09ICJpbmhlcml0IjsKfQp2YXIgY2FsY3VsYXRlID0gKHdvcmRzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpID0+IHdvcmRzLnJlZHVjZSgocmVzdWx0LCBfcmVmMikgPT4gewogIHZhciB7CiAgICB3b3JkLAogICAgd2lkdGgKICB9ID0gX3JlZjI7CiAgdmFyIGN1cnJlbnRMaW5lID0gcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXTsKICBpZiAoY3VycmVudExpbmUgJiYgd2lkdGggIT0gbnVsbCAmJiAobGluZVdpZHRoID09IG51bGwgfHwgc2NhbGVUb0ZpdCB8fCBjdXJyZW50TGluZS53aWR0aCArIHdpZHRoICsgc3BhY2VXaWR0aCA8IE51bWJlcihsaW5lV2lkdGgpKSkgewogICAgY3VycmVudExpbmUud29yZHMucHVzaCh3b3JkKTsKICAgIGN1cnJlbnRMaW5lLndpZHRoICs9IHdpZHRoICsgc3BhY2VXaWR0aDsKICB9IGVsc2UgewogICAgdmFyIG5ld0xpbmUgPSB7CiAgICAgIHdvcmRzOiBbd29yZF0sCiAgICAgIHdpZHRoCiAgICB9OwogICAgcmVzdWx0LnB1c2gobmV3TGluZSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0sIFtdKTsKdmFyIGZpbmRMb25nZXN0TGluZSA9ICh3b3JkcykgPT4gd29yZHMucmVkdWNlKChhLCBiKSA9PiBhLndpZHRoID4gYi53aWR0aCA/IGEgOiBiKTsKdmFyIHN1ZmZpeCA9ICJcdTIwMjYiOwp2YXIgY2hlY2tPdmVyZmxvdyA9ICh0ZXh0LCBpbmRleCwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KSA9PiB7CiAgdmFyIHRlbXBUZXh0ID0gdGV4dC5zbGljZSgwLCBpbmRleCk7CiAgdmFyIHdvcmRzID0gY2FsY3VsYXRlV29yZFdpZHRocyh7CiAgICBicmVha0FsbCwKICAgIHN0eWxlLAogICAgY2hpbGRyZW46IHRlbXBUZXh0ICsgc3VmZml4CiAgfSk7CiAgaWYgKCF3b3JkcykgewogICAgcmV0dXJuIFtmYWxzZSwgW11dOwogIH0KICB2YXIgcmVzdWx0ID0gY2FsY3VsYXRlKHdvcmRzLndvcmRzV2l0aENvbXB1dGVkV2lkdGgsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgdmFyIGRvZXNPdmVyZmxvdyA9IHJlc3VsdC5sZW5ndGggPiBtYXhMaW5lcyB8fCBmaW5kTG9uZ2VzdExpbmUocmVzdWx0KS53aWR0aCA+IE51bWJlcihsaW5lV2lkdGgpOwogIHJldHVybiBbZG9lc092ZXJmbG93LCByZXN1bHRdOwp9Owp2YXIgY2FsY3VsYXRlV29yZHNCeUxpbmVzID0gKF9yZWYzLCBpbml0aWFsV29yZHNXaXRoQ29tcHV0ZWRXaXRoLCBzcGFjZVdpZHRoLCBsaW5lV2lkdGgsIHNjYWxlVG9GaXQpID0+IHsKICB2YXIgewogICAgbWF4TGluZXMsCiAgICBjaGlsZHJlbiwKICAgIHN0eWxlLAogICAgYnJlYWtBbGwKICB9ID0gX3JlZjM7CiAgdmFyIHNob3VsZExpbWl0TGluZXMgPSBpc051bWJlcihtYXhMaW5lcyk7CiAgdmFyIHRleHQgPSBTdHJpbmcoY2hpbGRyZW4pOwogIHZhciBvcmlnaW5hbFJlc3VsdCA9IGNhbGN1bGF0ZShpbml0aWFsV29yZHNXaXRoQ29tcHV0ZWRXaXRoLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpOwogIGlmICghc2hvdWxkTGltaXRMaW5lcyB8fCBzY2FsZVRvRml0KSB7CiAgICByZXR1cm4gb3JpZ2luYWxSZXN1bHQ7CiAgfQogIHZhciBvdmVyZmxvd3MgPSBvcmlnaW5hbFJlc3VsdC5sZW5ndGggPiBtYXhMaW5lcyB8fCBmaW5kTG9uZ2VzdExpbmUob3JpZ2luYWxSZXN1bHQpLndpZHRoID4gTnVtYmVyKGxpbmVXaWR0aCk7CiAgaWYgKCFvdmVyZmxvd3MpIHsKICAgIHJldHVybiBvcmlnaW5hbFJlc3VsdDsKICB9CiAgdmFyIHN0YXJ0ID0gMDsKICB2YXIgZW5kID0gdGV4dC5sZW5ndGggLSAxOwogIHZhciBpdGVyYXRpb25zID0gMDsKICB2YXIgdHJpbW1lZFJlc3VsdDsKICB3aGlsZSAoc3RhcnQgPD0gZW5kICYmIGl0ZXJhdGlvbnMgPD0gdGV4dC5sZW5ndGggLSAxKSB7CiAgICB2YXIgbWlkZGxlID0gTWF0aC5mbG9vcigoc3RhcnQgKyBlbmQpIC8gMik7CiAgICB2YXIgcHJldiA9IG1pZGRsZSAtIDE7CiAgICB2YXIgW2RvZXNQcmV2T3ZlcmZsb3csIHJlc3VsdF0gPSBjaGVja092ZXJmbG93KHRleHQsIHByZXYsIGJyZWFrQWxsLCBzdHlsZSwgbWF4TGluZXMsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgICB2YXIgW2RvZXNNaWRkbGVPdmVyZmxvd10gPSBjaGVja092ZXJmbG93KHRleHQsIG1pZGRsZSwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICAgIGlmICghZG9lc1ByZXZPdmVyZmxvdyAmJiAhZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIHN0YXJ0ID0gbWlkZGxlICsgMTsKICAgIH0KICAgIGlmIChkb2VzUHJldk92ZXJmbG93ICYmIGRvZXNNaWRkbGVPdmVyZmxvdykgewogICAgICBlbmQgPSBtaWRkbGUgLSAxOwogICAgfQogICAgaWYgKCFkb2VzUHJldk92ZXJmbG93ICYmIGRvZXNNaWRkbGVPdmVyZmxvdykgewogICAgICB0cmltbWVkUmVzdWx0ID0gcmVzdWx0OwogICAgICBicmVhazsKICAgIH0KICAgIGl0ZXJhdGlvbnMrKzsKICB9CiAgcmV0dXJuIHRyaW1tZWRSZXN1bHQgfHwgb3JpZ2luYWxSZXN1bHQ7Cn07CnZhciBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUgPSAoY2hpbGRyZW4pID0+IHsKICB2YXIgd29yZHMgPSAhaXNOdWxsaXNoKGNoaWxkcmVuKSA/IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoQlJFQUtJTkdfU1BBQ0VTKSA6IFtdOwogIHJldHVybiBbewogICAgd29yZHMsCiAgICB3aWR0aDogdm9pZCAwCiAgfV07Cn07CnZhciBnZXRXb3Jkc0J5TGluZXMgPSAoX3JlZjQpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBzY2FsZVRvRml0LAogICAgY2hpbGRyZW4sCiAgICBzdHlsZSwKICAgIGJyZWFrQWxsLAogICAgbWF4TGluZXMKICB9ID0gX3JlZjQ7CiAgaWYgKCh3aWR0aCB8fCBzY2FsZVRvRml0KSAmJiAhR2xvYmFsLmlzU3NyKSB7CiAgICB2YXIgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwgc3BhY2VXaWR0aDsKICAgIHZhciB3b3JkV2lkdGhzID0gY2FsY3VsYXRlV29yZFdpZHRocyh7CiAgICAgIGJyZWFrQWxsLAogICAgICBjaGlsZHJlbiwKICAgICAgc3R5bGUKICAgIH0pOwogICAgaWYgKHdvcmRXaWR0aHMpIHsKICAgICAgdmFyIHsKICAgICAgICB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoOiB3Y3csCiAgICAgICAgc3BhY2VXaWR0aDogc3cKICAgICAgfSA9IHdvcmRXaWR0aHM7CiAgICAgIHdvcmRzV2l0aENvbXB1dGVkV2lkdGggPSB3Y3c7CiAgICAgIHNwYWNlV2lkdGggPSBzdzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUoY2hpbGRyZW4pOwogICAgfQogICAgcmV0dXJuIGNhbGN1bGF0ZVdvcmRzQnlMaW5lcyh7CiAgICAgIGJyZWFrQWxsLAogICAgICBjaGlsZHJlbiwKICAgICAgbWF4TGluZXMsCiAgICAgIHN0eWxlCiAgICB9LCB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLCBzcGFjZVdpZHRoLCB3aWR0aCwgQm9vbGVhbihzY2FsZVRvRml0KSk7CiAgfQogIHJldHVybiBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUoY2hpbGRyZW4pOwp9Owp2YXIgREVGQVVMVF9GSUxMID0gIiM4MDgwODAiOwp2YXIgdGV4dERlZmF1bHRQcm9wcyA9IHsKICBhbmdsZTogMCwKICBicmVha0FsbDogZmFsc2UsCiAgLy8gTWFnaWMgbnVtYmVyIGZyb20gZDMKICBjYXBIZWlnaHQ6ICIwLjcxZW0iLAogIGZpbGw6IERFRkFVTFRfRklMTCwKICBsaW5lSGVpZ2h0OiAiMWVtIiwKICBzY2FsZVRvRml0OiBmYWxzZSwKICB0ZXh0QW5jaG9yOiAic3RhcnQiLAogIC8vIE1haW50YWluIGNvbXBhdCB3aXRoIGV4aXN0aW5nIGNoYXJ0cyAvIGRlZmF1bHQgU1ZHIGJlaGF2aW9yCiAgdmVydGljYWxBbmNob3I6ICJlbmQiLAogIHg6IDAsCiAgeTogMAp9Owp2YXIgVGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjUuZm9yd2FyZFJlZikoKG91dHNpZGVQcm9wcywgcmVmKSA9PiB7CiAgdmFyIF9yZXNvbHZlRGVmYXVsdFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHRleHREZWZhdWx0UHJvcHMpLCB7CiAgICB4OiBwcm9wc1gsCiAgICB5OiBwcm9wc1ksCiAgICBsaW5lSGVpZ2h0LAogICAgY2FwSGVpZ2h0LAogICAgZmlsbCwKICAgIHNjYWxlVG9GaXQsCiAgICB0ZXh0QW5jaG9yLAogICAgdmVydGljYWxBbmNob3IKICB9ID0gX3Jlc29sdmVEZWZhdWx0UHJvcHMsIHByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNihfcmVzb2x2ZURlZmF1bHRQcm9wcywgX2V4Y2x1ZGVkNik7CiAgdmFyIHdvcmRzQnlMaW5lcyA9ICgwLCBpbXBvcnRfcmVhY3QyNS51c2VNZW1vKSgoKSA9PiB7CiAgICByZXR1cm4gZ2V0V29yZHNCeUxpbmVzKHsKICAgICAgYnJlYWtBbGw6IHByb3BzLmJyZWFrQWxsLAogICAgICBjaGlsZHJlbjogcHJvcHMuY2hpbGRyZW4sCiAgICAgIG1heExpbmVzOiBwcm9wcy5tYXhMaW5lcywKICAgICAgc2NhbGVUb0ZpdCwKICAgICAgc3R5bGU6IHByb3BzLnN0eWxlLAogICAgICB3aWR0aDogcHJvcHMud2lkdGgKICAgIH0pOwogIH0sIFtwcm9wcy5icmVha0FsbCwgcHJvcHMuY2hpbGRyZW4sIHByb3BzLm1heExpbmVzLCBzY2FsZVRvRml0LCBwcm9wcy5zdHlsZSwgcHJvcHMud2lkdGhdKTsKICB2YXIgewogICAgZHgsCiAgICBkeSwKICAgIGFuZ2xlLAogICAgY2xhc3NOYW1lLAogICAgYnJlYWtBbGwKICB9ID0gcHJvcHMsIHRleHRQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczYocHJvcHMsIF9leGNsdWRlZDIzKTsKICBpZiAoIWlzTnVtT3JTdHIocHJvcHNYKSB8fCAhaXNOdW1PclN0cihwcm9wc1kpIHx8IHdvcmRzQnlMaW5lcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgeDIgPSBOdW1iZXIocHJvcHNYKSArIChpc051bWJlcihkeCkgPyBkeCA6IDApOwogIHZhciB5MiA9IE51bWJlcihwcm9wc1kpICsgKGlzTnVtYmVyKGR5KSA/IGR5IDogMCk7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHgyKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcih5MikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgc3RhcnREeTsKICBzd2l0Y2ggKHZlcnRpY2FsQW5jaG9yKSB7CiAgICBjYXNlICJzdGFydCI6CiAgICAgIHN0YXJ0RHkgPSByZWR1Y2VDU1NDYWxjKCJjYWxjKCIuY29uY2F0KGNhcEhlaWdodCwgIikiKSk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAibWlkZGxlIjoKICAgICAgc3RhcnREeSA9IHJlZHVjZUNTU0NhbGMoImNhbGMoIi5jb25jYXQoKHdvcmRzQnlMaW5lcy5sZW5ndGggLSAxKSAvIDIsICIgKiAtIikuY29uY2F0KGxpbmVIZWlnaHQsICIgKyAoIikuY29uY2F0KGNhcEhlaWdodCwgIiAvIDIpKSIpKTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICBzdGFydER5ID0gcmVkdWNlQ1NTQ2FsYygiY2FsYygiLmNvbmNhdCh3b3Jkc0J5TGluZXMubGVuZ3RoIC0gMSwgIiAqIC0iKS5jb25jYXQobGluZUhlaWdodCwgIikiKSk7CiAgICAgIGJyZWFrOwogIH0KICB2YXIgdHJhbnNmb3JtcyA9IFtdOwogIGlmIChzY2FsZVRvRml0KSB7CiAgICB2YXIgbGluZVdpZHRoID0gd29yZHNCeUxpbmVzWzBdLndpZHRoOwogICAgdmFyIHsKICAgICAgd2lkdGgKICAgIH0gPSBwcm9wczsKICAgIHRyYW5zZm9ybXMucHVzaCgic2NhbGUoIi5jb25jYXQoaXNOdW1iZXIod2lkdGgpICYmIGlzTnVtYmVyKGxpbmVXaWR0aCkgPyB3aWR0aCAvIGxpbmVXaWR0aCA6IDEsICIpIikpOwogIH0KICBpZiAoYW5nbGUpIHsKICAgIHRyYW5zZm9ybXMucHVzaCgicm90YXRlKCIuY29uY2F0KGFuZ2xlLCAiLCAiKS5jb25jYXQoeDIsICIsICIpLmNvbmNhdCh5MiwgIikiKSk7CiAgfQogIGlmICh0cmFuc2Zvcm1zLmxlbmd0aCkgewogICAgdGV4dFByb3BzLnRyYW5zZm9ybSA9IHRyYW5zZm9ybXMuam9pbigiICIpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTMuY3JlYXRlRWxlbWVudCgidGV4dCIsIF9leHRlbmRzMTAoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHModGV4dFByb3BzKSwgewogICAgcmVmLAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtdGV4dCIsIGNsYXNzTmFtZSksCiAgICB0ZXh0QW5jaG9yLAogICAgZmlsbDogZmlsbC5pbmNsdWRlcygidXJsIikgPyBERUZBVUxUX0ZJTEwgOiBmaWxsCiAgfSksIHdvcmRzQnlMaW5lcy5tYXAoKGxpbmUsIGluZGV4KSA9PiB7CiAgICB2YXIgd29yZHMgPSBsaW5lLndvcmRzLmpvaW4oYnJlYWtBbGwgPyAiIiA6ICIgIik7CiAgICByZXR1cm4gKAogICAgICAvLyBkdXBsaWNhdGUgd29yZHMgd2lsbCBjYXVzZSBkdXBsaWNhdGUga2V5cyB3aGljaCBpcyB3aHkgd2UgYWRkIHRoZSBhcnJheSBpbmRleCBoZXJlCiAgICAgIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEzLmNyZWF0ZUVsZW1lbnQoInRzcGFuIiwgewogICAgICAgIHg6IHgyLAogICAgICAgIGR5OiBpbmRleCA9PT0gMCA/IHN0YXJ0RHkgOiBsaW5lSGVpZ2h0LAogICAgICAgIGtleTogIiIuY29uY2F0KHdvcmRzLCAiLSIpLmNvbmNhdChpbmRleCkKICAgICAgfSwgd29yZHMpCiAgICApOwogIH0pKTsKfSk7ClRleHQuZGlzcGxheU5hbWUgPSAiVGV4dCI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9MYWJlbC5qcwp2YXIgUmVhY3QxNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkNyA9IFsibGFiZWxSZWYiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNyhlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gb3duS2V5czIzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjMoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTEoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTEgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczExLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIENhcnRlc2lhbkxhYmVsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciBDYXJ0ZXNpYW5MYWJlbENvbnRleHRQcm92aWRlciA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciB2aWV3Qm94ID0gKDAsIGltcG9ydF9yZWFjdDI2LnVzZU1lbW8pKCgpID0+ICh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCBbeDIsIHkyLCB1cHBlcldpZHRoLCBsb3dlcldpZHRoLCB3aWR0aCwgaGVpZ2h0XSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogdmlld0JveAogIH0sIGNoaWxkcmVuKTsKfTsKdmFyIHVzZUNhcnRlc2lhbkxhYmVsQ29udGV4dCA9ICgpID0+IHsKICB2YXIgbGFiZWxDaGlsZENvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0MjYudXNlQ29udGV4dCkoQ2FydGVzaWFuTGFiZWxDb250ZXh0KTsKICB2YXIgY2hhcnRDb250ZXh0ID0gdXNlVmlld0JveCgpOwogIHJldHVybiBsYWJlbENoaWxkQ29udGV4dCB8fCBjYXJ0ZXNpYW5WaWV3Qm94VG9UcmFwZXpvaWQoY2hhcnRDb250ZXh0KTsKfTsKdmFyIFBvbGFyTGFiZWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIHVzZVBvbGFyTGFiZWxDb250ZXh0ID0gKCkgPT4gewogIHZhciBsYWJlbENoaWxkQ29udGV4dCA9ICgwLCBpbXBvcnRfcmVhY3QyNi51c2VDb250ZXh0KShQb2xhckxhYmVsQ29udGV4dCk7CiAgdmFyIGNoYXJ0Q29udGV4dCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFBvbGFyVmlld0JveCk7CiAgcmV0dXJuIGxhYmVsQ2hpbGRDb250ZXh0IHx8IGNoYXJ0Q29udGV4dDsKfTsKdmFyIGdldExhYmVsID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHZhbHVlLAogICAgZm9ybWF0dGVyCiAgfSA9IHByb3BzOwogIHZhciBsYWJlbCA9IGlzTnVsbGlzaChwcm9wcy5jaGlsZHJlbikgPyB2YWx1ZSA6IHByb3BzLmNoaWxkcmVuOwogIGlmICh0eXBlb2YgZm9ybWF0dGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZm9ybWF0dGVyKGxhYmVsKTsKICB9CiAgcmV0dXJuIGxhYmVsOwp9Owp2YXIgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24gPSAoY29udGVudCkgPT4gewogIHJldHVybiBjb250ZW50ICE9IG51bGwgJiYgdHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiI7Cn07CnZhciBnZXREZWx0YUFuZ2xlMiA9IChzdGFydEFuZ2xlLCBlbmRBbmdsZSkgPT4gewogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBNYXRoLm1pbihNYXRoLmFicyhlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpLCAzNjApOwogIHJldHVybiBzaWduMiAqIGRlbHRhQW5nbGU7Cn07CnZhciByZW5kZXJSYWRpYWxMYWJlbCA9IChsYWJlbFByb3BzLCBwb3NpdGlvbiwgbGFiZWwsIGF0dHJzLCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIG9mZnNldCwKICAgIGNsYXNzTmFtZQogIH0gPSBsYWJlbFByb3BzOwogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZSwKICAgIGNsb2NrV2lzZQogIH0gPSB2aWV3Qm94OwogIHZhciByYWRpdXMgPSAoaW5uZXJSYWRpdXMgKyBvdXRlclJhZGl1cykgLyAyOwogIHZhciBkZWx0YUFuZ2xlID0gZ2V0RGVsdGFBbmdsZTIoc3RhcnRBbmdsZSwgZW5kQW5nbGUpOwogIHZhciBzaWduMiA9IGRlbHRhQW5nbGUgPj0gMCA/IDEgOiAtMTsKICB2YXIgbGFiZWxBbmdsZSwgZGlyZWN0aW9uOwogIHN3aXRjaCAocG9zaXRpb24pIHsKICAgIGNhc2UgImluc2lkZVN0YXJ0IjoKICAgICAgbGFiZWxBbmdsZSA9IHN0YXJ0QW5nbGUgKyBzaWduMiAqIG9mZnNldDsKICAgICAgZGlyZWN0aW9uID0gY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGNhc2UgImluc2lkZUVuZCI6CiAgICAgIGxhYmVsQW5nbGUgPSBlbmRBbmdsZSAtIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSAhY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGNhc2UgImVuZCI6CiAgICAgIGxhYmVsQW5nbGUgPSBlbmRBbmdsZSArIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSBjbG9ja1dpc2U7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCBwb3NpdGlvbiAiLmNvbmNhdChwb3NpdGlvbikpOwogIH0KICBkaXJlY3Rpb24gPSBkZWx0YUFuZ2xlIDw9IDAgPyBkaXJlY3Rpb24gOiAhZGlyZWN0aW9uOwogIHZhciBzdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgbGFiZWxBbmdsZSk7CiAgdmFyIGVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgbGFiZWxBbmdsZSArIChkaXJlY3Rpb24gPyAxIDogLTEpICogMzU5KTsKICB2YXIgcGF0aDIgPSAiTSIuY29uY2F0KHN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQoc3RhcnRQb2ludC55LCAiXG4gICAgQSIpLmNvbmNhdChyYWRpdXMsICIsIikuY29uY2F0KHJhZGl1cywgIiwwLDEsIikuY29uY2F0KGRpcmVjdGlvbiA/IDAgOiAxLCAiLFxuICAgICIpLmNvbmNhdChlbmRQb2ludC54LCAiLCIpLmNvbmNhdChlbmRQb2ludC55KTsKICB2YXIgaWQgPSBpc051bGxpc2gobGFiZWxQcm9wcy5pZCkgPyB1bmlxdWVJZCgicmVjaGFydHMtcmFkaWFsLWxpbmUtIikgOiBsYWJlbFByb3BzLmlkOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJ0ZXh0IiwgX2V4dGVuZHMxMSh7fSwgYXR0cnMsIHsKICAgIGRvbWluYW50QmFzZWxpbmU6ICJjZW50cmFsIiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtcmFkaWFsLWJhci1sYWJlbCIsIGNsYXNzTmFtZSkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCB7CiAgICBpZCwKICAgIGQ6IHBhdGgyCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJ0ZXh0UGF0aCIsIHsKICAgIHhsaW5rSHJlZjogIiMiLmNvbmNhdChpZCkKICB9LCBsYWJlbCkpOwp9Owp2YXIgZ2V0QXR0cnNPZlBvbGFyTGFiZWwgPSAodmlld0JveCwgb2Zmc2V0LCBwb3NpdGlvbikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSB2aWV3Qm94OwogIHZhciBtaWRBbmdsZSA9IChzdGFydEFuZ2xlICsgZW5kQW5nbGUpIC8gMjsKICBpZiAocG9zaXRpb24gPT09ICJvdXRzaWRlIikgewogICAgdmFyIHsKICAgICAgeDogX3gsCiAgICAgIHk6IF95CiAgICB9ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzICsgb2Zmc2V0LCBtaWRBbmdsZSk7CiAgICByZXR1cm4gewogICAgICB4OiBfeCwKICAgICAgeTogX3ksCiAgICAgIHRleHRBbmNob3I6IF94ID49IGN4ID8gInN0YXJ0IiA6ICJlbmQiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlciIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiY2VudGVyVG9wIikgewogICAgcmV0dXJuIHsKICAgICAgeDogY3gsCiAgICAgIHk6IGN5LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJzdGFydCIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlckJvdHRvbSIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAiZW5kIgogICAgfTsKICB9CiAgdmFyIHIyID0gKGlubmVyUmFkaXVzICsgb3V0ZXJSYWRpdXMpIC8gMjsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MgogIH0gPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcjIsIG1pZEFuZ2xlKTsKICByZXR1cm4gewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgfTsKfTsKdmFyIGlzUG9sYXIgPSAodmlld0JveCkgPT4gImN4IiBpbiB2aWV3Qm94ICYmIGlzTnVtYmVyKHZpZXdCb3guY3gpOwp2YXIgZ2V0QXR0cnNPZkNhcnRlc2lhbkxhYmVsID0gKHByb3BzLCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIHBhcmVudFZpZXdCb3g6IHBhcmVudFZpZXdCb3hGcm9tUHJvcHMsCiAgICBvZmZzZXQsCiAgICBwb3NpdGlvbgogIH0gPSBwcm9wczsKICB2YXIgcGFyZW50Vmlld0JveDsKICBpZiAocGFyZW50Vmlld0JveEZyb21Qcm9wcyAhPSBudWxsICYmICFpc1BvbGFyKHBhcmVudFZpZXdCb3hGcm9tUHJvcHMpKSB7CiAgICBwYXJlbnRWaWV3Qm94ID0gcGFyZW50Vmlld0JveEZyb21Qcm9wczsKICB9CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB1cHBlcldpZHRoLAogICAgbG93ZXJXaWR0aCwKICAgIGhlaWdodAogIH0gPSB2aWV3Qm94OwogIHZhciB1cHBlclggPSB4MjsKICB2YXIgbG93ZXJYID0geDIgKyAodXBwZXJXaWR0aCAtIGxvd2VyV2lkdGgpIC8gMjsKICB2YXIgbWlkZGxlWCA9ICh1cHBlclggKyBsb3dlclgpIC8gMjsKICB2YXIgbWlkSGVpZ2h0V2lkdGggPSAodXBwZXJXaWR0aCArIGxvd2VyV2lkdGgpIC8gMjsKICB2YXIgY2VudGVyWCA9IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyOwogIHZhciB2ZXJ0aWNhbFNpZ24gPSBoZWlnaHQgPj0gMCA/IDEgOiAtMTsKICB2YXIgdmVydGljYWxPZmZzZXQgPSB2ZXJ0aWNhbFNpZ24gKiBvZmZzZXQ7CiAgdmFyIHZlcnRpY2FsRW5kID0gdmVydGljYWxTaWduID4gMCA/ICJlbmQiIDogInN0YXJ0IjsKICB2YXIgdmVydGljYWxTdGFydCA9IHZlcnRpY2FsU2lnbiA+IDAgPyAic3RhcnQiIDogImVuZCI7CiAgdmFyIGhvcml6b250YWxTaWduID0gdXBwZXJXaWR0aCA+PSAwID8gMSA6IC0xOwogIHZhciBob3Jpem9udGFsT2Zmc2V0ID0gaG9yaXpvbnRhbFNpZ24gKiBvZmZzZXQ7CiAgdmFyIGhvcml6b250YWxFbmQgPSBob3Jpem9udGFsU2lnbiA+IDAgPyAiZW5kIiA6ICJzdGFydCI7CiAgdmFyIGhvcml6b250YWxTdGFydCA9IGhvcml6b250YWxTaWduID4gMCA/ICJzdGFydCIgOiAiZW5kIjsKICBpZiAocG9zaXRpb24gPT09ICJ0b3AiKSB7CiAgICB2YXIgYXR0cnMgPSB7CiAgICAgIHg6IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyLAogICAgICB5OiB5MiAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIGF0dHJzKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgaGVpZ2h0OiBNYXRoLm1heCh5MiAtIHBhcmVudFZpZXdCb3gueSwgMCksCiAgICAgIHdpZHRoOiB1cHBlcldpZHRoCiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJib3R0b20iKSB7CiAgICB2YXIgX2F0dHJzID0gewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyBoZWlnaHQgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRycyksIHBhcmVudFZpZXdCb3ggPyB7CiAgICAgIGhlaWdodDogTWF0aC5tYXgocGFyZW50Vmlld0JveC55ICsgcGFyZW50Vmlld0JveC5oZWlnaHQgLSAoeTIgKyBoZWlnaHQpLCAwKSwKICAgICAgd2lkdGg6IGxvd2VyV2lkdGgKICAgIH0gOiB7fSk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImxlZnQiKSB7CiAgICB2YXIgX2F0dHJzMiA9IHsKICAgICAgeDogbWlkZGxlWCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRyczIpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICB3aWR0aDogTWF0aC5tYXgoX2F0dHJzMi54IC0gcGFyZW50Vmlld0JveC54LCAwKSwKICAgICAgaGVpZ2h0CiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJyaWdodCIpIHsKICAgIHZhciBfYXR0cnMzID0gewogICAgICB4OiBtaWRkbGVYICsgbWlkSGVpZ2h0V2lkdGggKyBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRyczMpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICB3aWR0aDogTWF0aC5tYXgocGFyZW50Vmlld0JveC54ICsgcGFyZW50Vmlld0JveC53aWR0aCAtIF9hdHRyczMueCwgMCksCiAgICAgIGhlaWdodAogICAgfSA6IHt9KTsKICB9CiAgdmFyIHNpemVBdHRycyA9IHBhcmVudFZpZXdCb3ggPyB7CiAgICB3aWR0aDogbWlkSGVpZ2h0V2lkdGgsCiAgICBoZWlnaHQKICB9IDoge307CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlTGVmdCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBtaWRkbGVYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbWlkZGxlWCArIG1pZEhlaWdodFdpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsRW5kLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiB1cHBlclggKyB1cHBlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b20iKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbG93ZXJYICsgbG93ZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxFbmQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcExlZnQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogdXBwZXJYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbFN0YXJ0LAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlVG9wUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogdXBwZXJYICsgdXBwZXJXaWR0aCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b21MZWZ0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IGxvd2VyWCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b21SaWdodCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLSB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAoISFwb3NpdGlvbiAmJiB0eXBlb2YgcG9zaXRpb24gPT09ICJvYmplY3QiICYmIChpc051bWJlcihwb3NpdGlvbi54KSB8fCBpc1BlcmNlbnQocG9zaXRpb24ueCkpICYmIChpc051bWJlcihwb3NpdGlvbi55KSB8fCBpc1BlcmNlbnQocG9zaXRpb24ueSkpKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogeDIgKyBnZXRQZXJjZW50VmFsdWUocG9zaXRpb24ueCwgbWlkSGVpZ2h0V2lkdGgpLAogICAgICB5OiB5MiArIGdldFBlcmNlbnRWYWx1ZShwb3NpdGlvbi55LCBoZWlnaHQpLAogICAgICB0ZXh0QW5jaG9yOiAiZW5kIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJlbmQiCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgIHg6IGNlbnRlclgsCiAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogIH0sIHNpemVBdHRycyk7Cn07CnZhciBkZWZhdWx0TGFiZWxQcm9wcyA9IHsKICBhbmdsZTogMCwKICBvZmZzZXQ6IDUsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMubGFiZWwsCiAgcG9zaXRpb246ICJtaWRkbGUiLAogIHRleHRCcmVha0FsbDogZmFsc2UKfTsKZnVuY3Rpb24gTGFiZWwob3V0ZXJQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0ZXJQcm9wcywgZGVmYXVsdExhYmVsUHJvcHMpOwogIHZhciB7CiAgICB2aWV3Qm94OiB2aWV3Qm94RnJvbVByb3BzLAogICAgcG9zaXRpb24sCiAgICB2YWx1ZSwKICAgIGNoaWxkcmVuLAogICAgY29udGVudCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgdGV4dEJyZWFrQWxsLAogICAgbGFiZWxSZWYKICB9ID0gcHJvcHM7CiAgdmFyIHBvbGFyVmlld0JveCA9IHVzZVBvbGFyTGFiZWxDb250ZXh0KCk7CiAgdmFyIGNhcnRlc2lhblZpZXdCb3ggPSB1c2VDYXJ0ZXNpYW5MYWJlbENvbnRleHQoKTsKICB2YXIgcmVzb2x2ZWRWaWV3Qm94ID0gcG9zaXRpb24gPT09ICJjZW50ZXIiID8gY2FydGVzaWFuVmlld0JveCA6IHBvbGFyVmlld0JveCAhPT0gbnVsbCAmJiBwb2xhclZpZXdCb3ggIT09IHZvaWQgMCA/IHBvbGFyVmlld0JveCA6IGNhcnRlc2lhblZpZXdCb3g7CiAgdmFyIHZpZXdCb3gsIGxhYmVsLCBwb3NpdGlvbkF0dHJzOwogIGlmICh2aWV3Qm94RnJvbVByb3BzID09IG51bGwpIHsKICAgIHZpZXdCb3ggPSByZXNvbHZlZFZpZXdCb3g7CiAgfSBlbHNlIGlmIChpc1BvbGFyKHZpZXdCb3hGcm9tUHJvcHMpKSB7CiAgICB2aWV3Qm94ID0gdmlld0JveEZyb21Qcm9wczsKICB9IGVsc2UgewogICAgdmlld0JveCA9IGNhcnRlc2lhblZpZXdCb3hUb1RyYXBlem9pZCh2aWV3Qm94RnJvbVByb3BzKTsKICB9CiAgaWYgKCF2aWV3Qm94IHx8IGlzTnVsbGlzaCh2YWx1ZSkgJiYgaXNOdWxsaXNoKGNoaWxkcmVuKSAmJiAhLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkoY29udGVudCkgJiYgdHlwZW9mIGNvbnRlbnQgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcHJvcHNXaXRoVmlld0JveCA9IF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIHByb3BzKSwge30sIHsKICAgIHZpZXdCb3gKICB9KTsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkoY29udGVudCkpIHsKICAgIHZhciB7CiAgICAgIGxhYmVsUmVmOiBfCiAgICB9ID0gcHJvcHNXaXRoVmlld0JveCwgcHJvcHNXaXRob3V0TGFiZWxSZWYgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM3KHByb3BzV2l0aFZpZXdCb3gsIF9leGNsdWRlZDcpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY2xvbmVFbGVtZW50KShjb250ZW50LCBwcm9wc1dpdGhvdXRMYWJlbFJlZik7CiAgfQogIGlmICh0eXBlb2YgY29udGVudCA9PT0gImZ1bmN0aW9uIikgewogICAgbGFiZWwgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNyZWF0ZUVsZW1lbnQpKGNvbnRlbnQsIHByb3BzV2l0aFZpZXdCb3gpOwogICAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSkgewogICAgICByZXR1cm4gbGFiZWw7CiAgICB9CiAgfSBlbHNlIHsKICAgIGxhYmVsID0gZ2V0TGFiZWwocHJvcHMpOwogIH0KICB2YXIgYXR0cnMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKTsKICBpZiAoaXNQb2xhcih2aWV3Qm94KSkgewogICAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlU3RhcnQiIHx8IHBvc2l0aW9uID09PSAiaW5zaWRlRW5kIiB8fCBwb3NpdGlvbiA9PT0gImVuZCIpIHsKICAgICAgcmV0dXJuIHJlbmRlclJhZGlhbExhYmVsKHByb3BzLCBwb3NpdGlvbiwgbGFiZWwsIGF0dHJzLCB2aWV3Qm94KTsKICAgIH0KICAgIHBvc2l0aW9uQXR0cnMgPSBnZXRBdHRyc09mUG9sYXJMYWJlbCh2aWV3Qm94LCBwcm9wcy5vZmZzZXQsIHByb3BzLnBvc2l0aW9uKTsKICB9IGVsc2UgewogICAgcG9zaXRpb25BdHRycyA9IGdldEF0dHJzT2ZDYXJ0ZXNpYW5MYWJlbChwcm9wcywgdmlld0JveCk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoVGV4dCwgX2V4dGVuZHMxMSh7CiAgICByZWY6IGxhYmVsUmVmLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1sYWJlbCIsIGNsYXNzTmFtZSkKICB9LCBhdHRycywgcG9zaXRpb25BdHRycywgewogICAgLyoKICAgICAqIHRleHRBbmNob3IgaXMgZGVjaWRlZCBieSBkZWZhdWx0IGJhc2VkIG9uIHRoZSBgcG9zaXRpb25gCiAgICAgKiBidXQgd2UgYWxsb3cgb3ZlcnJpZGluZyB2aWEgcHJvcHMgZm9yIHByZWNpc2UgY29udHJvbC4KICAgICAqLwogICAgdGV4dEFuY2hvcjogaXNWYWxpZFRleHRBbmNob3IoYXR0cnMudGV4dEFuY2hvcikgPyBhdHRycy50ZXh0QW5jaG9yIDogcG9zaXRpb25BdHRycy50ZXh0QW5jaG9yLAogICAgYnJlYWtBbGw6IHRleHRCcmVha0FsbAogIH0pLCBsYWJlbCkpOwp9CkxhYmVsLmRpc3BsYXlOYW1lID0gIkxhYmVsIjsKdmFyIHBhcnNlTGFiZWwgPSAobGFiZWwsIHZpZXdCb3gsIGxhYmVsUmVmKSA9PiB7CiAgaWYgKCFsYWJlbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBjb21tb25Qcm9wcyA9IHsKICAgIHZpZXdCb3gsCiAgICBsYWJlbFJlZgogIH07CiAgaWYgKGxhYmVsID09PSB0cnVlKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGlzTnVtT3JTdHIobGFiZWwpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IiwKICAgICAgdmFsdWU6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkobGFiZWwpKSB7CiAgICBpZiAobGFiZWwudHlwZSA9PT0gTGFiZWwpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY2xvbmVFbGVtZW50KShsYWJlbCwgX29iamVjdFNwcmVhZDIzKHsKICAgICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIKICAgICAgfSwgY29tbW9uUHJvcHMpKTsKICAgIH0KICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiLAogICAgICBjb250ZW50OiBsYWJlbAogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIsCiAgICAgIGNvbnRlbnQ6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAobGFiZWwgJiYgdHlwZW9mIGxhYmVsID09PSAib2JqZWN0IikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoe30sIGxhYmVsLCB7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CmZ1bmN0aW9uIENhcnRlc2lhbkxhYmVsRnJvbUxhYmVsUHJvcChfcmVmMykgewogIHZhciB7CiAgICBsYWJlbCwKICAgIGxhYmVsUmVmCiAgfSA9IF9yZWYzOwogIHZhciB2aWV3Qm94ID0gdXNlQ2FydGVzaWFuTGFiZWxDb250ZXh0KCk7CiAgcmV0dXJuIHBhcnNlTGFiZWwobGFiZWwsIHZpZXdCb3gsIGxhYmVsUmVmKSB8fCBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9MYWJlbExpc3QuanMKdmFyIFJlYWN0MTUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9sYXN0ID0gX190b0VTTShyZXF1aXJlX2xhc3QzKCkpOwp2YXIgX2V4Y2x1ZGVkOCA9IFsidmFsdWVBY2Nlc3NvciJdOwp2YXIgX2V4Y2x1ZGVkMjQgPSBbImRhdGFLZXkiLCAiY2xvY2tXaXNlIiwgImlkIiwgInRleHRCcmVha0FsbCIsICJ6SW5kZXgiXTsKZnVuY3Rpb24gX2V4dGVuZHMxMigpIHsKICByZXR1cm4gX2V4dGVuZHMxMiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM4KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U4KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U4KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgZGVmYXVsdEFjY2Vzc29yID0gKGVudHJ5KSA9PiBBcnJheS5pc0FycmF5KGVudHJ5LnZhbHVlKSA/ICgwLCBpbXBvcnRfbGFzdC5kZWZhdWx0KShlbnRyeS52YWx1ZSkgOiBlbnRyeS52YWx1ZTsKdmFyIENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI3LmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0UHJvdmlkZXIgPSBDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0LlByb3ZpZGVyOwp2YXIgUG9sYXJMYWJlbExpc3RDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNy5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgUG9sYXJMYWJlbExpc3RDb250ZXh0UHJvdmlkZXIgPSBQb2xhckxhYmVsTGlzdENvbnRleHQuUHJvdmlkZXI7CmZ1bmN0aW9uIHVzZUNhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQoKSB7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QyNy51c2VDb250ZXh0KShDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0KTsKfQpmdW5jdGlvbiB1c2VQb2xhckxhYmVsTGlzdENvbnRleHQoKSB7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QyNy51c2VDb250ZXh0KShQb2xhckxhYmVsTGlzdENvbnRleHQpOwp9CmZ1bmN0aW9uIExhYmVsTGlzdChfcmVmMikgewogIHZhciB7CiAgICB2YWx1ZUFjY2Vzc29yID0gZGVmYXVsdEFjY2Vzc29yCiAgfSA9IF9yZWYyLCByZXN0UHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM4KF9yZWYyLCBfZXhjbHVkZWQ4KTsKICB2YXIgewogICAgZGF0YUtleSwKICAgIGNsb2NrV2lzZSwKICAgIGlkLAogICAgdGV4dEJyZWFrQWxsLAogICAgekluZGV4CiAgfSA9IHJlc3RQcm9wcywgb3RoZXJzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOChyZXN0UHJvcHMsIF9leGNsdWRlZDI0KTsKICB2YXIgY2FydGVzaWFuRGF0YSA9IHVzZUNhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQoKTsKICB2YXIgcG9sYXJEYXRhID0gdXNlUG9sYXJMYWJlbExpc3RDb250ZXh0KCk7CiAgdmFyIGRhdGEgPSBjYXJ0ZXNpYW5EYXRhIHx8IHBvbGFyRGF0YTsKICBpZiAoIWRhdGEgfHwgIWRhdGEubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogekluZGV4ICE9PSBudWxsICYmIHpJbmRleCAhPT0gdm9pZCAwID8gekluZGV4IDogRGVmYXVsdFpJbmRleGVzLmxhYmVsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtbGFiZWwtbGlzdCIKICB9LCBkYXRhLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICB2YXIgX3Jlc3RQcm9wcyRmaWxsOwogICAgdmFyIHZhbHVlID0gaXNOdWxsaXNoKGRhdGFLZXkpID8gdmFsdWVBY2Nlc3NvcihlbnRyeSwgaW5kZXgpIDogZ2V0VmFsdWVCeURhdGFLZXkoZW50cnkgJiYgZW50cnkucGF5bG9hZCwgZGF0YUtleSk7CiAgICB2YXIgaWRQcm9wcyA9IGlzTnVsbGlzaChpZCkgPyB7fSA6IHsKICAgICAgaWQ6ICIiLmNvbmNhdChpZCwgIi0iKS5jb25jYXQoaW5kZXgpCiAgICB9OwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTIoewogICAgICBrZXk6ICJsYWJlbC0iLmNvbmNhdChpbmRleCkKICAgIH0sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMoZW50cnkpLCBvdGhlcnMsIGlkUHJvcHMsIHsKICAgICAgLyoKICAgICAgICogUHJlZmVyIHRvIHVzZSB0aGUgZXhwbGljaXQgZmlsbCBmcm9tIExhYmVsTGlzdCBwcm9wcy4KICAgICAgICogT25seSBpbiBhbiBhYnNlbmNlIG9mIHRoYXQsIGZhbGwgYmFjayB0byB0aGUgZmlsbCBvZiB0aGUgZW50cnkuCiAgICAgICAqIFRoZSBlbnRyeSBmaWxsIGNhbiBiZSBxdWl0ZSBkaWZmaWN1bHQgdG8gc2VlIGVzcGVjaWFsbHkgaW4gQmFyLCBQaWUsIFJhZGlhbEJhciBpbiBpbnNpZGUgcG9zaXRpb25zLgogICAgICAgKiBPbiB0aGUgb3RoZXIgaGFuZCBpdCdzIHF1aXRlIGNvbnZlbmllbnQgaW4gU2NhdHRlciwgTGluZSwgb3Igd2hlbiB0aGUgcG9zaXRpb24gaXMgb3V0c2lkZSB0aGUgQmFyLCBQaWUgZmlsbGVkIHNoYXBlcy4KICAgICAgICovCiAgICAgIGZpbGw6IChfcmVzdFByb3BzJGZpbGwgPSByZXN0UHJvcHMuZmlsbCkgIT09IG51bGwgJiYgX3Jlc3RQcm9wcyRmaWxsICE9PSB2b2lkIDAgPyBfcmVzdFByb3BzJGZpbGwgOiBlbnRyeS5maWxsLAogICAgICBwYXJlbnRWaWV3Qm94OiBlbnRyeS5wYXJlbnRWaWV3Qm94LAogICAgICB2YWx1ZSwKICAgICAgdGV4dEJyZWFrQWxsLAogICAgICB2aWV3Qm94OiBlbnRyeS52aWV3Qm94LAogICAgICBpbmRleCwKICAgICAgekluZGV4OiAwCiAgICB9KSk7CiAgfSkpKTsKfQpMYWJlbExpc3QuZGlzcGxheU5hbWUgPSAiTGFiZWxMaXN0IjsKZnVuY3Rpb24gTGFiZWxMaXN0RnJvbUxhYmVsUHJvcChfcmVmMikgewogIHZhciB7CiAgICBsYWJlbAogIH0gPSBfcmVmMjsKICBpZiAoIWxhYmVsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKGxhYmVsID09PSB0cnVlKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYWJlbExpc3QsIHsKICAgICAga2V5OiAibGFiZWxMaXN0LWltcGxpY2l0IgogICAgfSk7CiAgfQogIGlmICgvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5pc1ZhbGlkRWxlbWVudChsYWJlbCkgfHwgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24obGFiZWwpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYWJlbExpc3QsIHsKICAgICAga2V5OiAibGFiZWxMaXN0LWltcGxpY2l0IiwKICAgICAgY29udGVudDogbGFiZWwKICAgIH0pOwogIH0KICBpZiAodHlwZW9mIGxhYmVsID09PSAib2JqZWN0IikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0LCBfZXh0ZW5kczEyKHsKICAgICAga2V5OiAibGFiZWxMaXN0LWltcGxpY2l0IgogICAgfSwgbGFiZWwsIHsKICAgICAgdHlwZTogU3RyaW5nKGxhYmVsLnR5cGUpCiAgICB9KSk7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL0RvdC5qcwp2YXIgUmVhY3QxNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gX2V4dGVuZHMxMygpIHsKICByZXR1cm4gX2V4dGVuZHMxMyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRG90ID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICByOiByMiwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLWRvdCIsIGNsYXNzTmFtZSk7CiAgaWYgKGlzTnVtYmVyKGN4KSAmJiBpc051bWJlcihjeSkgJiYgaXNOdW1iZXIocjIpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTYuY3JlYXRlRWxlbWVudCgiY2lyY2xlIiwgX2V4dGVuZHMxMyh7fSwgc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKSwgYWRhcHRFdmVudEhhbmRsZXJzKHByb3BzKSwgewogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcjogcjIKICAgIH0pKTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3BvbGFyQXhpc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGU2ID0gewogIHJhZGl1c0F4aXM6IHt9LAogIGFuZ2xlQXhpczoge30KfTsKdmFyIHBvbGFyQXhpc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJwb2xhckF4aXMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNiwKICByZWR1Y2VyczogewogICAgYWRkUmFkaXVzQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnJhZGl1c0F4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVSYWRpdXNBeGlzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgZGVsZXRlIHN0YXRlLnJhZGl1c0F4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgfSwKICAgIGFkZEFuZ2xlQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmFuZ2xlQXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgfSwKICAgIHJlbW92ZUFuZ2xlQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5hbmdsZUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkUmFkaXVzQXhpcywKICByZW1vdmVSYWRpdXNBeGlzLAogIGFkZEFuZ2xlQXhpcywKICByZW1vdmVBbmdsZUF4aXMKfSA9IHBvbGFyQXhpc1NsaWNlLmFjdGlvbnM7CnZhciBwb2xhckF4aXNSZWR1Y2VyID0gcG9sYXJBeGlzU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9SZWFjdFV0aWxzLmpzCnZhciBpbXBvcnRfcmVhY3QyOCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGlzQ2xpcERvdCA9IChkb3QpID0+IHsKICBpZiAoZG90ICYmIHR5cGVvZiBkb3QgPT09ICJvYmplY3QiICYmICJjbGlwRG90IiBpbiBkb3QpIHsKICAgIHJldHVybiBCb29sZWFuKGRvdC5jbGlwRG90KTsKICB9CiAgcmV0dXJuIHRydWU7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldFRvb2x0aXBFbnRyeVNldHRpbmdzLmpzCnZhciBpbXBvcnRfcmVhY3QyOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MoX3JlZjIpIHsKICB2YXIgewogICAgdG9vbHRpcEVudHJ5U2V0dGluZ3MKICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDI5LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDI5LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFRvb2x0aXBFbnRyeVNldHRpbmdzKHRvb2x0aXBFbnRyeVNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSB0b29sdGlwRW50cnlTZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlVG9vbHRpcEVudHJ5U2V0dGluZ3MoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHRvb2x0aXBFbnRyeVNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gdG9vbHRpcEVudHJ5U2V0dGluZ3M7CiAgfSwgW3Rvb2x0aXBFbnRyeVNldHRpbmdzLCBkaXNwYXRjaCwgaXNQYW5vcmFtYV0pOwogICgwLCBpbXBvcnRfcmVhY3QyOS51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVRvb2x0aXBFbnRyeVNldHRpbmdzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldExlZ2VuZFBheWxvYWQuanMKdmFyIGltcG9ydF9yZWFjdDMwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBTZXRMZWdlbmRQYXlsb2FkKF9yZWYyKSB7CiAgdmFyIHsKICAgIGxlZ2VuZFBheWxvYWQKICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcHJldlBheWxvYWRSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzAudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCA9PT0gbnVsbCkgewogICAgICBkaXNwYXRjaChhZGRMZWdlbmRQYXlsb2FkKGxlZ2VuZFBheWxvYWQpKTsKICAgIH0gZWxzZSBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCAhPT0gbGVnZW5kUGF5bG9hZCkgewogICAgICBkaXNwYXRjaChyZXBsYWNlTGVnZW5kUGF5bG9hZCh7CiAgICAgICAgcHJldjogcHJldlBheWxvYWRSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiBsZWdlbmRQYXlsb2FkCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPSBsZWdlbmRQYXlsb2FkOwogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgbGVnZW5kUGF5bG9hZF0pOwogICgwLCBpbXBvcnRfcmVhY3QzMC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2UGF5bG9hZFJlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlTGVnZW5kUGF5bG9hZChwcmV2UGF5bG9hZFJlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlBheWxvYWRSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9SZWdpc3RlckdyYXBoaWNhbEl0ZW1JZC5qcwp2YXIgUmVhY3QxOCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDMxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3VzZUlkLmpzCnZhciBSZWFjdDE3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX3JlZjsKdmFyIHVzZUlkRmFsbGJhY2sgPSAoKSA9PiB7CiAgdmFyIFtpZF0gPSBSZWFjdDE3LnVzZVN0YXRlKCgpID0+IHVuaXF1ZUlkKCJ1aWQtIikpOwogIHJldHVybiBpZDsKfTsKdmFyIHVzZUlkID0gKF9yZWYgPSBSZWFjdDE3WyJ1c2VJZCIudG9TdHJpbmcoKV0pICE9PSBudWxsICYmIF9yZWYgIT09IHZvaWQgMCA/IF9yZWYgOiB1c2VJZEZhbGxiYWNrOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3VzZVVuaXF1ZUlkLmpzCmZ1bmN0aW9uIHVzZVVuaXF1ZUlkKHByZWZpeCwgY3VzdG9tSWQpIHsKICB2YXIgZ2VuZXJhdGVkSWQgPSB1c2VJZCgpOwogIGlmIChjdXN0b21JZCkgewogICAgcmV0dXJuIGN1c3RvbUlkOwogIH0KICByZXR1cm4gcHJlZml4ID8gIiIuY29uY2F0KHByZWZpeCwgIi0iKS5jb25jYXQoZ2VuZXJhdGVkSWQpIDogZ2VuZXJhdGVkSWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9SZWdpc3RlckdyYXBoaWNhbEl0ZW1JZC5qcwp2YXIgR3JhcGhpY2FsSXRlbUlkQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzEuY3JlYXRlQ29udGV4dCkodm9pZCAwKTsKdmFyIFJlZ2lzdGVyR3JhcGhpY2FsSXRlbUlkID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGlkLAogICAgdHlwZSwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciByZXNvbHZlZElkID0gdXNlVW5pcXVlSWQoInJlY2hhcnRzLSIuY29uY2F0KHR5cGUpLCBpZCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE4LmNyZWF0ZUVsZW1lbnQoR3JhcGhpY2FsSXRlbUlkQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IHJlc29sdmVkSWQKICB9LCBjaGlsZHJlbihyZXNvbHZlZElkKSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldEdyYXBoaWNhbEl0ZW0uanMKdmFyIGltcG9ydF9yZWFjdDMyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9ncmFwaGljYWxJdGVtc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGU3ID0gewogIGNhcnRlc2lhbkl0ZW1zOiBbXSwKICBwb2xhckl0ZW1zOiBbXQp9Owp2YXIgZ3JhcGhpY2FsSXRlbXNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiZ3JhcGhpY2FsSXRlbXMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNywKICByZWR1Y2VyczogewogICAgYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5jYXJ0ZXNpYW5JdGVtcy5pbmRleE9mKGNhc3REcmFmdChwcmV2KSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLmNhcnRlc2lhbkl0ZW1zW2luZGV4XSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5jYXJ0ZXNpYW5JdGVtcy5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBhZGRQb2xhckdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUucG9sYXJJdGVtcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVBvbGFyR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5wb2xhckl0ZW1zLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBvbGFySXRlbXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIHJlcGxhY2VDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0sCiAgYWRkUG9sYXJHcmFwaGljYWxJdGVtLAogIHJlbW92ZVBvbGFyR3JhcGhpY2FsSXRlbQp9ID0gZ3JhcGhpY2FsSXRlbXNTbGljZS5hY3Rpb25zOwp2YXIgZ3JhcGhpY2FsSXRlbXNSZWR1Y2VyID0gZ3JhcGhpY2FsSXRlbXNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9TZXRHcmFwaGljYWxJdGVtLmpzCnZhciBTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtSW1wbCA9IChwcm9wcykgPT4gewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIHByZXZQcm9wc1JlZiA9ICgwLCBpbXBvcnRfcmVhY3QzMi51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QzMi51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCA9PT0gbnVsbCkgewogICAgICBkaXNwYXRjaChhZGRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtKHByb3BzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZQcm9wc1JlZi5jdXJyZW50ICE9PSBwcm9wcykgewogICAgICBkaXNwYXRjaChyZXBsYWNlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbSh7CiAgICAgICAgcHJldjogcHJldlByb3BzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogcHJvcHMKICAgICAgfSkpOwogICAgfQogICAgcHJldlByb3BzUmVmLmN1cnJlbnQgPSBwcm9wczsKICB9LCBbZGlzcGF0Y2gsIHByb3BzXSk7CiAgKDAsIGltcG9ydF9yZWFjdDMyLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZQcm9wc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbShwcmV2UHJvcHNSZWYuY3VycmVudCkpOwogICAgICAgIHByZXZQcm9wc1JlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgfQogICAgfTsKICB9LCBbZGlzcGF0Y2hdKTsKICByZXR1cm4gbnVsbDsKfTsKdmFyIFNldENhcnRlc2lhbkdyYXBoaWNhbEl0ZW0gPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMyLm1lbW8pKFNldENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1JbXBsKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0RvdHMuanMKdmFyIFJlYWN0MTkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9leGNsdWRlZDkgPSBbInBvaW50cyJdOwpmdW5jdGlvbiBvd25LZXlzMjQoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyNChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI0KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyNShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyNChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjUoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyNShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyNSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyNSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyNSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHMxNCgpIHsKICByZXR1cm4gX2V4dGVuZHMxNCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM5KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U5KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U5KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBEb3RJdGVtKF9yZWYyKSB7CiAgdmFyIHsKICAgIG9wdGlvbiwKICAgIGRvdFByb3BzLAogICAgY2xhc3NOYW1lCiAgfSA9IF9yZWYyOwogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMzLmlzVmFsaWRFbGVtZW50KShvcHRpb24pKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMy5jbG9uZUVsZW1lbnQpKG9wdGlvbiwgZG90UHJvcHMpOwogIH0KICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG9wdGlvbihkb3RQcm9wcyk7CiAgfQogIHZhciBmaW5hbENsYXNzTmFtZSA9IGNsc3goY2xhc3NOYW1lLCB0eXBlb2Ygb3B0aW9uICE9PSAiYm9vbGVhbiIgPyBvcHRpb24uY2xhc3NOYW1lIDogIiIpOwogIHZhciBfcmVmMjIgPSBkb3RQcm9wcyAhPT0gbnVsbCAmJiBkb3RQcm9wcyAhPT0gdm9pZCAwID8gZG90UHJvcHMgOiB7fSwgewogICAgcG9pbnRzCiAgfSA9IF9yZWYyMiwgcHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM5KF9yZWYyMiwgX2V4Y2x1ZGVkOSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoRG90LCBfZXh0ZW5kczE0KHt9LCBwcm9wcywgewogICAgY2xhc3NOYW1lOiBmaW5hbENsYXNzTmFtZQogIH0pKTsKfQpmdW5jdGlvbiBzaG91bGRSZW5kZXJEb3RzKHBvaW50cywgZG90KSB7CiAgaWYgKHBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChkb3QpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gcG9pbnRzLmxlbmd0aCA9PT0gMTsKfQpmdW5jdGlvbiBEb3RzKF9yZWYzKSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGRvdCwKICAgIGNsYXNzTmFtZSwKICAgIGRvdENsYXNzTmFtZSwKICAgIGRhdGFLZXksCiAgICBiYXNlUHJvcHMsCiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICB6SW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuc2NhdHRlcgogIH0gPSBfcmVmMzsKICBpZiAoIXNob3VsZFJlbmRlckRvdHMocG9pbnRzLCBkb3QpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGNsaXBEb3QgPSBpc0NsaXBEb3QoZG90KTsKICB2YXIgY3VzdG9tRG90UHJvcHMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzRnJvbVVua25vd24oZG90KTsKICB2YXIgZG90cyA9IHBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgX2VudHJ5JHgsIF9lbnRyeSR5OwogICAgdmFyIGRvdFByb3BzID0gX29iamVjdFNwcmVhZDI0KF9vYmplY3RTcHJlYWQyNChfb2JqZWN0U3ByZWFkMjQoewogICAgICByOiAzCiAgICB9LCBiYXNlUHJvcHMpLCBjdXN0b21Eb3RQcm9wcyksIHt9LCB7CiAgICAgIGluZGV4OiBpLAogICAgICBjeDogKF9lbnRyeSR4ID0gZW50cnkueCkgIT09IG51bGwgJiYgX2VudHJ5JHggIT09IHZvaWQgMCA/IF9lbnRyeSR4IDogdm9pZCAwLAogICAgICBjeTogKF9lbnRyeSR5ID0gZW50cnkueSkgIT09IG51bGwgJiYgX2VudHJ5JHkgIT09IHZvaWQgMCA/IF9lbnRyeSR5IDogdm9pZCAwLAogICAgICBkYXRhS2V5LAogICAgICB2YWx1ZTogZW50cnkudmFsdWUsCiAgICAgIHBheWxvYWQ6IGVudHJ5LnBheWxvYWQsCiAgICAgIHBvaW50cwogICAgfSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChEb3RJdGVtLCB7CiAgICAgIGtleTogImRvdC0iLmNvbmNhdChpKSwKICAgICAgb3B0aW9uOiBkb3QsCiAgICAgIGRvdFByb3BzLAogICAgICBjbGFzc05hbWU6IGRvdENsYXNzTmFtZQogICAgfSk7CiAgfSk7CiAgdmFyIGxheWVyUHJvcHMgPSB7fTsKICBpZiAobmVlZENsaXAgJiYgY2xpcFBhdGhJZCAhPSBudWxsKSB7CiAgICBsYXllclByb3BzLmNsaXBQYXRoID0gInVybCgjY2xpcFBhdGgtIi5jb25jYXQoY2xpcERvdCA/ICIiIDogImRvdHMtIikuY29uY2F0KGNsaXBQYXRoSWQsICIpIik7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KExheWVyLCBfZXh0ZW5kczE0KHsKICAgIGNsYXNzTmFtZQogIH0sIGxheWVyUHJvcHMpLCBkb3RzKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0FjdGl2ZVBvaW50cy5qcwp2YXIgUmVhY3QyMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9jYXJ0ZXNpYW5BeGlzU2xpY2UuanMKZnVuY3Rpb24gb3duS2V5czI1KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjUoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyNShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjYoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjUoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI2KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjYocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjYodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjYodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjYodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBpbml0aWFsU3RhdGU4ID0gewogIHhBeGlzOiB7fSwKICB5QXhpczoge30sCiAgekF4aXM6IHt9Cn07CnZhciBjYXJ0ZXNpYW5BeGlzU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImNhcnRlc2lhbkF4aXMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlOCwKICByZWR1Y2VyczogewogICAgYWRkWEF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUueEF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlWEF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS54QXhpc1twcmV2LmlkXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAocHJldi5pZCAhPT0gbmV4dC5pZCkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUueEF4aXNbcHJldi5pZF07CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS54QXhpc1tuZXh0LmlkXSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlWEF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlLnhBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBhZGRZQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS55QXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VZQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnlBeGlzW3ByZXYuaWRdICE9PSB2b2lkIDApIHsKICAgICAgICAgIGlmIChwcmV2LmlkICE9PSBuZXh0LmlkKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS55QXhpc1twcmV2LmlkXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlLnlBeGlzW25leHQuaWRdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVZQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBkZWxldGUgc3RhdGUueUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIGFkZFpBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnpBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVpBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekF4aXNbcHJldi5pZF0gIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHByZXYuaWQgIT09IG5leHQuaWQpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnpBeGlzW3ByZXYuaWRdOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUuekF4aXNbbmV4dC5pZF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVpBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIGRlbGV0ZSBzdGF0ZS56QXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgdXBkYXRlWUF4aXNXaWR0aChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHZhciB7CiAgICAgICAgaWQsCiAgICAgICAgd2lkdGgKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICB2YXIgYXhpcyA9IHN0YXRlLnlBeGlzW2lkXTsKICAgICAgaWYgKGF4aXMpIHsKICAgICAgICB2YXIgaGlzdG9yeSA9IGF4aXMud2lkdGhIaXN0b3J5IHx8IFtdOwogICAgICAgIGlmIChoaXN0b3J5Lmxlbmd0aCA9PT0gMyAmJiBoaXN0b3J5WzBdID09PSBoaXN0b3J5WzJdICYmIHdpZHRoID09PSBoaXN0b3J5WzFdICYmIHdpZHRoICE9PSBheGlzLndpZHRoICYmIE1hdGguYWJzKHdpZHRoIC0gaGlzdG9yeVswXSkgPD0gMSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgbmV3SGlzdG9yeSA9IFsuLi5oaXN0b3J5LCB3aWR0aF0uc2xpY2UoLTMpOwogICAgICAgIHN0YXRlLnlBeGlzW2lkXSA9IF9vYmplY3RTcHJlYWQyNShfb2JqZWN0U3ByZWFkMjUoe30sIHN0YXRlLnlBeGlzW2lkXSksIHt9LCB7CiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIHdpZHRoSGlzdG9yeTogbmV3SGlzdG9yeQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRYQXhpcywKICByZXBsYWNlWEF4aXMsCiAgcmVtb3ZlWEF4aXMsCiAgYWRkWUF4aXMsCiAgcmVwbGFjZVlBeGlzLAogIHJlbW92ZVlBeGlzLAogIGFkZFpBeGlzLAogIHJlcGxhY2VaQXhpcywKICByZW1vdmVaQXhpcywKICB1cGRhdGVZQXhpc1dpZHRoCn0gPSBjYXJ0ZXNpYW5BeGlzU2xpY2UuYWN0aW9uczsKdmFyIGNhcnRlc2lhbkF4aXNSZWR1Y2VyID0gY2FydGVzaWFuQXhpc1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RDaGFydE9mZnNldC5qcwp2YXIgc2VsZWN0Q2hhcnRPZmZzZXQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIChvZmZzZXRJbnRlcm5hbCkgPT4gewogIHJldHVybiB7CiAgICB0b3A6IG9mZnNldEludGVybmFsLnRvcCwKICAgIGJvdHRvbTogb2Zmc2V0SW50ZXJuYWwuYm90dG9tLAogICAgbGVmdDogb2Zmc2V0SW50ZXJuYWwubGVmdCwKICAgIHJpZ2h0OiBvZmZzZXRJbnRlcm5hbC5yaWdodAogIH07Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0UGxvdEFyZWEuanMKdmFyIHNlbGVjdFBsb3RBcmVhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0LCBzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodF0sIChvZmZzZXQsIGNoYXJ0V2lkdGgsIGNoYXJ0SGVpZ2h0KSA9PiB7CiAgaWYgKCFvZmZzZXQgfHwgY2hhcnRXaWR0aCA9PSBudWxsIHx8IGNoYXJ0SGVpZ2h0ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB7CiAgICB4OiBvZmZzZXQubGVmdCwKICAgIHk6IG9mZnNldC50b3AsCiAgICB3aWR0aDogTWF0aC5tYXgoMCwgY2hhcnRXaWR0aCAtIG9mZnNldC5sZWZ0IC0gb2Zmc2V0LnJpZ2h0KSwKICAgIGhlaWdodDogTWF0aC5tYXgoMCwgY2hhcnRIZWlnaHQgLSBvZmZzZXQudG9wIC0gb2Zmc2V0LmJvdHRvbSkKICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvaG9va3MuanMKdmFyIHVzZVBsb3RBcmVhID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RQbG90QXJlYSk7Cn07CnZhciB1c2VBY3RpdmVUb29sdGlwRGF0YVBvaW50cyA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QWN0aXZlVG9vbHRpcERhdGFQb2ludHMpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQWN0aXZlUG9pbnRzLmpzCmZ1bmN0aW9uIG93bktleXMyNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI2KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI3KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI3KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI3KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI3KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgQWN0aXZlUG9pbnQgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgcG9pbnQ6IHBvaW50NCwKICAgIGNoaWxkSW5kZXgsCiAgICBtYWluQ29sb3IsCiAgICBhY3RpdmVEb3QsCiAgICBkYXRhS2V5LAogICAgY2xpcFBhdGgKICB9ID0gX3JlZjI7CiAgaWYgKGFjdGl2ZURvdCA9PT0gZmFsc2UgfHwgcG9pbnQ0LnggPT0gbnVsbCB8fCBwb2ludDQueSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGRvdFByb3BzVHlwZWQgPSB7CiAgICBpbmRleDogY2hpbGRJbmRleCwKICAgIGRhdGFLZXksCiAgICBjeDogcG9pbnQ0LngsCiAgICBjeTogcG9pbnQ0LnksCiAgICByOiA0LAogICAgZmlsbDogbWFpbkNvbG9yICE9PSBudWxsICYmIG1haW5Db2xvciAhPT0gdm9pZCAwID8gbWFpbkNvbG9yIDogIm5vbmUiLAogICAgc3Ryb2tlV2lkdGg6IDIsCiAgICBzdHJva2U6ICIjZmZmIiwKICAgIHBheWxvYWQ6IHBvaW50NC5wYXlsb2FkLAogICAgdmFsdWU6IHBvaW50NC52YWx1ZQogIH07CiAgdmFyIGRvdFByb3BzID0gX29iamVjdFNwcmVhZDI2KF9vYmplY3RTcHJlYWQyNihfb2JqZWN0U3ByZWFkMjYoe30sIGRvdFByb3BzVHlwZWQpLCBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihhY3RpdmVEb3QpKSwgYWRhcHRFdmVudEhhbmRsZXJzKGFjdGl2ZURvdCkpOwogIHZhciBkb3Q7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzQuaXNWYWxpZEVsZW1lbnQpKGFjdGl2ZURvdCkpIHsKICAgIGRvdCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzQuY2xvbmVFbGVtZW50KShhY3RpdmVEb3QsIGRvdFByb3BzKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBhY3RpdmVEb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgIGRvdCA9IGFjdGl2ZURvdChkb3RQcm9wcyk7CiAgfSBlbHNlIHsKICAgIGRvdCA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIwLmNyZWF0ZUVsZW1lbnQoRG90LCBkb3RQcm9wcyk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hY3RpdmUtZG90IiwKICAgIGNsaXBQYXRoCiAgfSwgZG90KTsKfTsKZnVuY3Rpb24gQWN0aXZlUG9pbnRzKF9yZWYyKSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIG1haW5Db2xvciwKICAgIGFjdGl2ZURvdCwKICAgIGl0ZW1EYXRhS2V5LAogICAgY2xpcFBhdGgsCiAgICB6SW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuYWN0aXZlRG90CiAgfSA9IF9yZWYyOwogIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgpOwogIHZhciBhY3RpdmVEYXRhUG9pbnRzID0gdXNlQWN0aXZlVG9vbHRpcERhdGFQb2ludHMoKTsKICBpZiAocG9pbnRzID09IG51bGwgfHwgYWN0aXZlRGF0YVBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGFjdGl2ZVBvaW50ID0gcG9pbnRzLmZpbmQoKHApID0+IGFjdGl2ZURhdGFQb2ludHMuaW5jbHVkZXMocC5wYXlsb2FkKSk7CiAgaWYgKGlzTnVsbGlzaChhY3RpdmVQb2ludCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjAuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjAuY3JlYXRlRWxlbWVudChBY3RpdmVQb2ludCwgewogICAgcG9pbnQ6IGFjdGl2ZVBvaW50LAogICAgY2hpbGRJbmRleDogTnVtYmVyKGFjdGl2ZVRvb2x0aXBJbmRleCksCiAgICBtYWluQ29sb3IsCiAgICBkYXRhS2V5OiBpdGVtRGF0YUtleSwKICAgIGFjdGl2ZURvdCwKICAgIGNsaXBQYXRoCiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2Vycm9yQmFyU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTkgPSB7fTsKdmFyIGVycm9yQmFyU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImVycm9yQmFycyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU5LAogIHJlZHVjZXJzOiB7CiAgICBhZGRFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgZXJyb3JCYXIKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoIXN0YXRlW2l0ZW1JZF0pIHsKICAgICAgICBzdGF0ZVtpdGVtSWRdID0gW107CiAgICAgIH0KICAgICAgc3RhdGVbaXRlbUlkXS5wdXNoKGVycm9yQmFyKTsKICAgIH0sCiAgICByZXBsYWNlRXJyb3JCYXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciB7CiAgICAgICAgaXRlbUlkLAogICAgICAgIHByZXYsCiAgICAgICAgbmV4dAogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChzdGF0ZVtpdGVtSWRdKSB7CiAgICAgICAgc3RhdGVbaXRlbUlkXSA9IHN0YXRlW2l0ZW1JZF0ubWFwKChlKSA9PiBlLmRhdGFLZXkgPT09IHByZXYuZGF0YUtleSAmJiBlLmRpcmVjdGlvbiA9PT0gcHJldi5kaXJlY3Rpb24gPyBuZXh0IDogZSk7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgZXJyb3JCYXIKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoc3RhdGVbaXRlbUlkXSkgewogICAgICAgIHN0YXRlW2l0ZW1JZF0gPSBzdGF0ZVtpdGVtSWRdLmZpbHRlcigoZSkgPT4gZS5kYXRhS2V5ICE9PSBlcnJvckJhci5kYXRhS2V5IHx8IGUuZGlyZWN0aW9uICE9PSBlcnJvckJhci5kaXJlY3Rpb24pOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRFcnJvckJhciwKICByZXBsYWNlRXJyb3JCYXIsCiAgcmVtb3ZlRXJyb3JCYXIKfSA9IGVycm9yQmFyU2xpY2UuYWN0aW9uczsKdmFyIGVycm9yQmFyUmVkdWNlciA9IGVycm9yQmFyU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0dyYXBoaWNhbEl0ZW1DbGlwUGF0aC5qcwp2YXIgUmVhY3QyMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gdXNlTmVlZHNDbGlwKHhBeGlzSWQsIHlBeGlzSWQpIHsKICB2YXIgX3hBeGlzJGFsbG93RGF0YU92ZXJmLCBfeUF4aXMkYWxsb3dEYXRhT3ZlcmY7CiAgdmFyIHhBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCB4QXhpc0lkKSk7CiAgdmFyIHlBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCB5QXhpc0lkKSk7CiAgdmFyIG5lZWRDbGlwWCA9IChfeEF4aXMkYWxsb3dEYXRhT3ZlcmYgPSB4QXhpcyA9PT0gbnVsbCB8fCB4QXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogeEF4aXMuYWxsb3dEYXRhT3ZlcmZsb3cpICE9PSBudWxsICYmIF94QXhpcyRhbGxvd0RhdGFPdmVyZiAhPT0gdm9pZCAwID8gX3hBeGlzJGFsbG93RGF0YU92ZXJmIDogaW1wbGljaXRYQXhpcy5hbGxvd0RhdGFPdmVyZmxvdzsKICB2YXIgbmVlZENsaXBZID0gKF95QXhpcyRhbGxvd0RhdGFPdmVyZiA9IHlBeGlzID09PSBudWxsIHx8IHlBeGlzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB5QXhpcy5hbGxvd0RhdGFPdmVyZmxvdykgIT09IG51bGwgJiYgX3lBeGlzJGFsbG93RGF0YU92ZXJmICE9PSB2b2lkIDAgPyBfeUF4aXMkYWxsb3dEYXRhT3ZlcmYgOiBpbXBsaWNpdFlBeGlzLmFsbG93RGF0YU92ZXJmbG93OwogIHZhciBuZWVkQ2xpcCA9IG5lZWRDbGlwWCB8fCBuZWVkQ2xpcFk7CiAgcmV0dXJuIHsKICAgIG5lZWRDbGlwLAogICAgbmVlZENsaXBYLAogICAgbmVlZENsaXBZCiAgfTsKfQpmdW5jdGlvbiBHcmFwaGljYWxJdGVtQ2xpcFBhdGgoX3JlZjIpIHsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQsCiAgICBjbGlwUGF0aElkCiAgfSA9IF9yZWYyOwogIHZhciBwbG90QXJlYSA9IHVzZVBsb3RBcmVhKCk7CiAgdmFyIHsKICAgIG5lZWRDbGlwWCwKICAgIG5lZWRDbGlwWSwKICAgIG5lZWRDbGlwCiAgfSA9IHVzZU5lZWRzQ2xpcCh4QXhpc0lkLCB5QXhpc0lkKTsKICBpZiAoIW5lZWRDbGlwIHx8ICFwbG90QXJlYSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcGxvdEFyZWE7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIxLmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIiwgewogICAgaWQ6ICJjbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkKQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIxLmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICB4OiBuZWVkQ2xpcFggPyB4MiA6IHgyIC0gd2lkdGggLyAyLAogICAgeTogbmVlZENsaXBZID8geTIgOiB5MiAtIGhlaWdodCAvIDIsCiAgICB3aWR0aDogbmVlZENsaXBYID8gd2lkdGggOiB3aWR0aCAqIDIsCiAgICBoZWlnaHQ6IG5lZWRDbGlwWSA/IGhlaWdodCA6IGhlaWdodCAqIDIKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1yZWR1eC9kaXN0L3JlYWN0LXJlZHV4Lm1qcwp2YXIgUmVhY3QyMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKdmFyIGltcG9ydF93aXRoX3NlbGVjdG9yMiA9IF9fdG9FU00ocmVxdWlyZV93aXRoX3NlbGVjdG9yMigpLCAxKTsKdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKdmFyIFJFQUNUX01FTU9fVFlQRSA9IC8qIEBfX1BVUkVfXyAqLyBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CnZhciBGb3J3YXJkUmVmID0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTsKdmFyIE1lbW8gPSBSRUFDVF9NRU1PX1RZUEU7CmZ1bmN0aW9uIGRlZmF1bHROb29wQmF0Y2goY2FsbGJhY2spIHsKICBjYWxsYmFjaygpOwp9CmZ1bmN0aW9uIGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpIHsKICBsZXQgZmlyc3QgPSBudWxsOwogIGxldCBsYXN0MiA9IG51bGw7CiAgcmV0dXJuIHsKICAgIGNsZWFyKCkgewogICAgICBmaXJzdCA9IG51bGw7CiAgICAgIGxhc3QyID0gbnVsbDsKICAgIH0sCiAgICBub3RpZnkoKSB7CiAgICAgIGRlZmF1bHROb29wQmF0Y2goKCkgPT4gewogICAgICAgIGxldCBsaXN0ZW5lcjIgPSBmaXJzdDsKICAgICAgICB3aGlsZSAobGlzdGVuZXIyKSB7CiAgICAgICAgICBsaXN0ZW5lcjIuY2FsbGJhY2soKTsKICAgICAgICAgIGxpc3RlbmVyMiA9IGxpc3RlbmVyMi5uZXh0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZ2V0KCkgewogICAgICBjb25zdCBsaXN0ZW5lcnMgPSBbXTsKICAgICAgbGV0IGxpc3RlbmVyMiA9IGZpcnN0OwogICAgICB3aGlsZSAobGlzdGVuZXIyKSB7CiAgICAgICAgbGlzdGVuZXJzLnB1c2gobGlzdGVuZXIyKTsKICAgICAgICBsaXN0ZW5lcjIgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfSwKICAgIHN1YnNjcmliZShjYWxsYmFjaykgewogICAgICBsZXQgaXNTdWJzY3JpYmVkID0gdHJ1ZTsKICAgICAgY29uc3QgbGlzdGVuZXIyID0gbGFzdDIgPSB7CiAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgbmV4dDogbnVsbCwKICAgICAgICBwcmV2OiBsYXN0MgogICAgICB9OwogICAgICBpZiAobGlzdGVuZXIyLnByZXYpIHsKICAgICAgICBsaXN0ZW5lcjIucHJldi5uZXh0ID0gbGlzdGVuZXIyOwogICAgICB9IGVsc2UgewogICAgICAgIGZpcnN0ID0gbGlzdGVuZXIyOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbiB1bnN1YnNjcmliZSgpIHsKICAgICAgICBpZiAoIWlzU3Vic2NyaWJlZCB8fCBmaXJzdCA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgIGlzU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICAgIGlmIChsaXN0ZW5lcjIubmV4dCkgewogICAgICAgICAgbGlzdGVuZXIyLm5leHQucHJldiA9IGxpc3RlbmVyMi5wcmV2OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsYXN0MiA9IGxpc3RlbmVyMi5wcmV2OwogICAgICAgIH0KICAgICAgICBpZiAobGlzdGVuZXIyLnByZXYpIHsKICAgICAgICAgIGxpc3RlbmVyMi5wcmV2Lm5leHQgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmlyc3QgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKfQp2YXIgbnVsbExpc3RlbmVycyA9IHsKICBub3RpZnkoKSB7CiAgfSwKICBnZXQ6ICgpID0+IFtdCn07CmZ1bmN0aW9uIGNyZWF0ZVN1YnNjcmlwdGlvbihzdG9yZSwgcGFyZW50U3ViKSB7CiAgbGV0IHVuc3Vic2NyaWJlOwogIGxldCBsaXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzOwogIGxldCBzdWJzY3JpcHRpb25zQW1vdW50ID0gMDsKICBsZXQgc2VsZlN1YnNjcmliZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBhZGROZXN0ZWRTdWIobGlzdGVuZXIyKSB7CiAgICB0cnlTdWJzY3JpYmUoKTsKICAgIGNvbnN0IGNsZWFudXBMaXN0ZW5lciA9IGxpc3RlbmVycy5zdWJzY3JpYmUobGlzdGVuZXIyKTsKICAgIGxldCByZW1vdmVkID0gZmFsc2U7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAoIXJlbW92ZWQpIHsKICAgICAgICByZW1vdmVkID0gdHJ1ZTsKICAgICAgICBjbGVhbnVwTGlzdGVuZXIoKTsKICAgICAgICB0cnlVbnN1YnNjcmliZSgpOwogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBub3RpZnlOZXN0ZWRTdWJzKCkgewogICAgbGlzdGVuZXJzLm5vdGlmeSgpOwogIH0KICBmdW5jdGlvbiBoYW5kbGVDaGFuZ2VXcmFwcGVyKCkgewogICAgaWYgKHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKSB7CiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzU3Vic2NyaWJlZCgpIHsKICAgIHJldHVybiBzZWxmU3Vic2NyaWJlZDsKICB9CiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlKCkgewogICAgc3Vic2NyaXB0aW9uc0Ftb3VudCsrOwogICAgaWYgKCF1bnN1YnNjcmliZSkgewogICAgICB1bnN1YnNjcmliZSA9IHBhcmVudFN1YiA/IHBhcmVudFN1Yi5hZGROZXN0ZWRTdWIoaGFuZGxlQ2hhbmdlV3JhcHBlcikgOiBzdG9yZS5zdWJzY3JpYmUoaGFuZGxlQ2hhbmdlV3JhcHBlcik7CiAgICAgIGxpc3RlbmVycyA9IGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpOwogICAgfQogIH0KICBmdW5jdGlvbiB0cnlVbnN1YnNjcmliZSgpIHsKICAgIHN1YnNjcmlwdGlvbnNBbW91bnQtLTsKICAgIGlmICh1bnN1YnNjcmliZSAmJiBzdWJzY3JpcHRpb25zQW1vdW50ID09PSAwKSB7CiAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICAgIHVuc3Vic2NyaWJlID0gdm9pZCAwOwogICAgICBsaXN0ZW5lcnMuY2xlYXIoKTsKICAgICAgbGlzdGVuZXJzID0gbnVsbExpc3RlbmVyczsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlU2VsZigpIHsKICAgIGlmICghc2VsZlN1YnNjcmliZWQpIHsKICAgICAgc2VsZlN1YnNjcmliZWQgPSB0cnVlOwogICAgICB0cnlTdWJzY3JpYmUoKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5VW5zdWJzY3JpYmVTZWxmKCkgewogICAgaWYgKHNlbGZTdWJzY3JpYmVkKSB7CiAgICAgIHNlbGZTdWJzY3JpYmVkID0gZmFsc2U7CiAgICAgIHRyeVVuc3Vic2NyaWJlKCk7CiAgICB9CiAgfQogIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHsKICAgIGFkZE5lc3RlZFN1YiwKICAgIG5vdGlmeU5lc3RlZFN1YnMsCiAgICBoYW5kbGVDaGFuZ2VXcmFwcGVyLAogICAgaXNTdWJzY3JpYmVkLAogICAgdHJ5U3Vic2NyaWJlOiB0cnlTdWJzY3JpYmVTZWxmLAogICAgdHJ5VW5zdWJzY3JpYmU6IHRyeVVuc3Vic2NyaWJlU2VsZiwKICAgIGdldExpc3RlbmVyczogKCkgPT4gbGlzdGVuZXJzCiAgfTsKICByZXR1cm4gc3Vic2NyaXB0aW9uOwp9CnZhciBjYW5Vc2VET00gPSAoKSA9PiAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKdmFyIGlzRE9NID0gLyogQF9fUFVSRV9fICovIGNhblVzZURPTSgpOwp2YXIgaXNSdW5uaW5nSW5SZWFjdE5hdGl2ZSA9ICgpID0+IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5wcm9kdWN0ID09PSAiUmVhY3ROYXRpdmUiOwp2YXIgaXNSZWFjdE5hdGl2ZSA9IC8qIEBfX1BVUkVfXyAqLyBpc1J1bm5pbmdJblJlYWN0TmF0aXZlKCk7CnZhciBnZXRVc2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gKCkgPT4gaXNET00gfHwgaXNSZWFjdE5hdGl2ZSA/IFJlYWN0MjIudXNlTGF5b3V0RWZmZWN0IDogUmVhY3QyMi51c2VFZmZlY3Q7CnZhciB1c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gLyogQF9fUFVSRV9fICovIGdldFVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoKTsKZnVuY3Rpb24gaXMzKHgyLCB5MikgewogIGlmICh4MiA9PT0geTIpIHsKICAgIHJldHVybiB4MiAhPT0gMCB8fCB5MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MjsKICB9IGVsc2UgewogICAgcmV0dXJuIHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQp9CmZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgaWYgKGlzMyhvYmpBLCBvYmpCKSkgcmV0dXJuIHRydWU7CiAgaWYgKHR5cGVvZiBvYmpBICE9PSAib2JqZWN0IiB8fCBvYmpBID09PSBudWxsIHx8IHR5cGVvZiBvYmpCICE9PSAib2JqZWN0IiB8fCBvYmpCID09PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbnN0IGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgY29uc3Qga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICBpZiAoa2V5c0EubGVuZ3RoICE9PSBrZXlzQi5sZW5ndGgpIHJldHVybiBmYWxzZTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBrZXlzQVtpXSkgfHwgIWlzMyhvYmpBW2tleXNBW2ldXSwgb2JqQltrZXlzQVtpXV0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KdmFyIEZPUldBUkRfUkVGX1NUQVRJQ1MgPSB7CiAgJCR0eXBlb2Y6IHRydWUsCiAgcmVuZGVyOiB0cnVlLAogIGRlZmF1bHRQcm9wczogdHJ1ZSwKICBkaXNwbGF5TmFtZTogdHJ1ZSwKICBwcm9wVHlwZXM6IHRydWUKfTsKdmFyIE1FTU9fU1RBVElDUyA9IHsKICAkJHR5cGVvZjogdHJ1ZSwKICBjb21wYXJlOiB0cnVlLAogIGRlZmF1bHRQcm9wczogdHJ1ZSwKICBkaXNwbGF5TmFtZTogdHJ1ZSwKICBwcm9wVHlwZXM6IHRydWUsCiAgdHlwZTogdHJ1ZQp9Owp2YXIgVFlQRV9TVEFUSUNTID0gewogIFtGb3J3YXJkUmVmXTogRk9SV0FSRF9SRUZfU1RBVElDUywKICBbTWVtb106IE1FTU9fU1RBVElDUwp9Owp2YXIgb2JqZWN0UHJvdG90eXBlID0gT2JqZWN0LnByb3RvdHlwZTsKdmFyIENvbnRleHRLZXkgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcihgcmVhY3QtcmVkdXgtY29udGV4dGApOwp2YXIgZ1QgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWxUaGlzIDogKAogIC8qIGZhbGwgYmFjayB0byBhIHBlci1tb2R1bGUgc2NvcGUgKHByZS04LjEgYmVoYXZpb3VyKSBpZiBgZ2xvYmFsVGhpc2AgaXMgbm90IGF2YWlsYWJsZSAqLwogIHt9Cik7CmZ1bmN0aW9uIGdldENvbnRleHQoKSB7CiAgaWYgKCFSZWFjdDIyLmNyZWF0ZUNvbnRleHQpIHJldHVybiB7fTsKICBjb25zdCBjb250ZXh0TWFwID0gZ1RbQ29udGV4dEtleV0gPz89IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgbGV0IHJlYWxDb250ZXh0ID0gY29udGV4dE1hcC5nZXQoUmVhY3QyMi5jcmVhdGVDb250ZXh0KTsKICBpZiAoIXJlYWxDb250ZXh0KSB7CiAgICByZWFsQ29udGV4dCA9IFJlYWN0MjIuY3JlYXRlQ29udGV4dCgKICAgICAgbnVsbAogICAgKTsKICAgIGlmICh0cnVlKSB7CiAgICAgIHJlYWxDb250ZXh0LmRpc3BsYXlOYW1lID0gIlJlYWN0UmVkdXgiOwogICAgfQogICAgY29udGV4dE1hcC5zZXQoUmVhY3QyMi5jcmVhdGVDb250ZXh0LCByZWFsQ29udGV4dCk7CiAgfQogIHJldHVybiByZWFsQ29udGV4dDsKfQp2YXIgUmVhY3RSZWR1eENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gZ2V0Q29udGV4dCgpOwpmdW5jdGlvbiBQcm92aWRlcihwcm92aWRlclByb3BzKSB7CiAgY29uc3QgeyBjaGlsZHJlbiwgY29udGV4dCwgc2VydmVyU3RhdGUsIHN0b3JlIH0gPSBwcm92aWRlclByb3BzOwogIGNvbnN0IGNvbnRleHRWYWx1ZSA9IFJlYWN0MjIudXNlTWVtbygoKSA9PiB7CiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBjcmVhdGVTdWJzY3JpcHRpb24oc3RvcmUpOwogICAgY29uc3QgYmFzZUNvbnRleHRWYWx1ZSA9IHsKICAgICAgc3RvcmUsCiAgICAgIHN1YnNjcmlwdGlvbiwKICAgICAgZ2V0U2VydmVyU3RhdGU6IHNlcnZlclN0YXRlID8gKCkgPT4gc2VydmVyU3RhdGUgOiB2b2lkIDAKICAgIH07CiAgICBpZiAoZmFsc2UpIHsKICAgICAgcmV0dXJuIGJhc2VDb250ZXh0VmFsdWU7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9ICJvbmNlIiwgc3RhYmlsaXR5Q2hlY2sgPSAib25jZSIgfSA9IHByb3ZpZGVyUHJvcHM7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmFzc2lnbihiYXNlQ29udGV4dFZhbHVlLCB7CiAgICAgICAgc3RhYmlsaXR5Q2hlY2ssCiAgICAgICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrCiAgICAgIH0pOwogICAgfQogIH0sIFtzdG9yZSwgc2VydmVyU3RhdGVdKTsKICBjb25zdCBwcmV2aW91c1N0YXRlID0gUmVhY3QyMi51c2VNZW1vKCgpID0+IHN0b3JlLmdldFN0YXRlKCksIFtzdG9yZV0pOwogIHVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoKCkgPT4gewogICAgY29uc3QgeyBzdWJzY3JpcHRpb24gfSA9IGNvbnRleHRWYWx1ZTsKICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gc3Vic2NyaXB0aW9uLm5vdGlmeU5lc3RlZFN1YnM7CiAgICBzdWJzY3JpcHRpb24udHJ5U3Vic2NyaWJlKCk7CiAgICBpZiAocHJldmlvdXNTdGF0ZSAhPT0gc3RvcmUuZ2V0U3RhdGUoKSkgewogICAgICBzdWJzY3JpcHRpb24ubm90aWZ5TmVzdGVkU3VicygpOwogICAgfQogICAgcmV0dXJuICgpID0+IHsKICAgICAgc3Vic2NyaXB0aW9uLnRyeVVuc3Vic2NyaWJlKCk7CiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gdm9pZCAwOwogICAgfTsKICB9LCBbY29udGV4dFZhbHVlLCBwcmV2aW91c1N0YXRlXSk7CiAgY29uc3QgQ29udGV4dCA9IGNvbnRleHQgfHwgUmVhY3RSZWR1eENvbnRleHQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoQ29udGV4dC5Qcm92aWRlciwgeyB2YWx1ZTogY29udGV4dFZhbHVlIH0sIGNoaWxkcmVuKTsKfQp2YXIgUHJvdmlkZXJfZGVmYXVsdCA9IFByb3ZpZGVyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3Byb3BzQXJlRXF1YWwuanMKdmFyIHByb3BzVG9TaGFsbG93Q29tcGFyZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsiYXhpc0xpbmUiLCAidGlja0xpbmUiLCAiYWN0aXZlQmFyIiwgImFjdGl2ZURvdCIsICJhY3RpdmVMYWJlbCIsICJhY3RpdmVTaGFwZSIsICJhbGxvd0VzY2FwZVZpZXdCb3giLCAiYmFja2dyb3VuZCIsICJjdXJzb3IiLCAiZG90IiwgImxhYmVsIiwgImxpbmUiLCAibWFyZ2luIiwgInBhZGRpbmciLCAicG9zaXRpb24iLCAic2hhcGUiLCAic3R5bGUiLCAidGljayIsICJ3cmFwcGVyU3R5bGUiXSk7CmZ1bmN0aW9uIHNhbWVWYWx1ZVplcm8oeDIsIHkyKSB7CiAgaWYgKHgyID09IG51bGwgJiYgeTIgPT0gbnVsbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmICh0eXBlb2YgeDIgPT09ICJudW1iZXIiICYmIHR5cGVvZiB5MiA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiB4MiA9PT0geTIgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9CiAgcmV0dXJuIHgyID09PSB5MjsKfQpmdW5jdGlvbiBwcm9wc0FyZUVxdWFsKHByZXZQcm9wcywgbmV4dFByb3BzKSB7CiAgdmFyIGFsbEtleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbLi4uT2JqZWN0LmtleXMocHJldlByb3BzKSwgLi4uT2JqZWN0LmtleXMobmV4dFByb3BzKV0pOwogIGZvciAodmFyIGtleSBvZiBhbGxLZXlzKSB7CiAgICBpZiAocHJvcHNUb1NoYWxsb3dDb21wYXJlLmhhcyhrZXkpKSB7CiAgICAgIGlmIChwcmV2UHJvcHNba2V5XSA9PSBudWxsICYmIG5leHRQcm9wc1trZXldID09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoIXNoYWxsb3dFcXVhbChwcmV2UHJvcHNba2V5XSwgbmV4dFByb3BzW2tleV0pKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCFzYW1lVmFsdWVaZXJvKHByZXZQcm9wc1trZXldLCBuZXh0UHJvcHNba2V5XSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2NoYXJ0RGF0YUNvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDM1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgQ2hhcnREYXRhQ29udGV4dFByb3ZpZGVyID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YQogIH0gPSBwcm9wczsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogICgwLCBpbXBvcnRfcmVhY3QzNS51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChpc1Bhbm9yYW1hKSB7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgIH07CiAgICB9CiAgICBkaXNwYXRjaChzZXRDaGFydERhdGEoY2hhcnREYXRhKSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaChzZXRDaGFydERhdGEodm9pZCAwKSk7CiAgICB9OwogIH0sIFtjaGFydERhdGEsIGRpc3BhdGNoLCBpc1Bhbm9yYW1hXSk7CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2JydXNoU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTEwID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgcGFkZGluZzogewogICAgdG9wOiAwLAogICAgcmlnaHQ6IDAsCiAgICBib3R0b206IDAsCiAgICBsZWZ0OiAwCiAgfQp9Owp2YXIgYnJ1c2hTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiYnJ1c2giLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTAsCiAgcmVkdWNlcnM6IHsKICAgIHNldEJydXNoU2V0dGluZ3MoX3N0YXRlLCBhY3Rpb24pIHsKICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkID09IG51bGwpIHsKICAgICAgICByZXR1cm4gaW5pdGlhbFN0YXRlMTA7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0QnJ1c2hTZXR0aW5ncwp9ID0gYnJ1c2hTbGljZS5hY3Rpb25zOwp2YXIgYnJ1c2hSZWR1Y2VyID0gYnJ1c2hTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NhcnRlc2lhblV0aWxzLmpzCmZ1bmN0aW9uIG93bktleXMyNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI4KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyOChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI4KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI4KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI4KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgU2NhbGVIZWxwZXIgPSBjbGFzcyBfU2NhbGVIZWxwZXIgewogIHN0YXRpYyBjcmVhdGUob2JqKSB7CiAgICByZXR1cm4gbmV3IF9TY2FsZUhlbHBlcihvYmopOwogIH0KICBjb25zdHJ1Y3RvcihzY2FsZSkgewogICAgdGhpcy5zY2FsZSA9IHNjYWxlOwogIH0KICBnZXQgZG9tYWluKCkgewogICAgcmV0dXJuIHRoaXMuc2NhbGUuZG9tYWluOwogIH0KICBnZXQgcmFuZ2UoKSB7CiAgICByZXR1cm4gdGhpcy5zY2FsZS5yYW5nZTsKICB9CiAgZ2V0IHJhbmdlTWluKCkgewogICAgcmV0dXJuIHRoaXMucmFuZ2UoKVswXTsKICB9CiAgZ2V0IHJhbmdlTWF4KCkgewogICAgcmV0dXJuIHRoaXMucmFuZ2UoKVsxXTsKICB9CiAgZ2V0IGJhbmR3aWR0aCgpIHsKICAgIHJldHVybiB0aGlzLnNjYWxlLmJhbmR3aWR0aDsKICB9CiAgYXBwbHkodmFsdWUpIHsKICAgIHZhciB7CiAgICAgIGJhbmRBd2FyZSwKICAgICAgcG9zaXRpb24KICAgIH0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmIChwb3NpdGlvbikgewogICAgICBzd2l0Y2ggKHBvc2l0aW9uKSB7CiAgICAgICAgY2FzZSAic3RhcnQiOiB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGNhc2UgIm1pZGRsZSI6IHsKICAgICAgICAgIHZhciBvZmZzZXQgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgLyAyIDogMDsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIG9mZnNldDsKICAgICAgICB9CiAgICAgICAgY2FzZSAiZW5kIjogewogICAgICAgICAgdmFyIF9vZmZzZXQgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgOiAwOwogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpICsgX29mZnNldDsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKGJhbmRBd2FyZSkgewogICAgICB2YXIgX29mZnNldDIgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgLyAyIDogMDsKICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpICsgX29mZnNldDI7CiAgICB9CiAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSk7CiAgfQogIGlzSW5SYW5nZSh2YWx1ZSkgewogICAgdmFyIHJhbmdlNCA9IHRoaXMucmFuZ2UoKTsKICAgIHZhciBmaXJzdCA9IHJhbmdlNFswXTsKICAgIHZhciBsYXN0MiA9IHJhbmdlNFtyYW5nZTQubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gZmlyc3QgPD0gbGFzdDIgPyB2YWx1ZSA+PSBmaXJzdCAmJiB2YWx1ZSA8PSBsYXN0MiA6IHZhbHVlID49IGxhc3QyICYmIHZhbHVlIDw9IGZpcnN0OwogIH0KfTsKX2RlZmluZVByb3BlcnR5MjgoU2NhbGVIZWxwZXIsICJFUFMiLCAxZS00KTsKdmFyIGNyZWF0ZUxhYmVsZWRTY2FsZXMgPSAob3B0aW9ucykgPT4gewogIHZhciBzY2FsZXMgPSBPYmplY3Qua2V5cyhvcHRpb25zKS5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCByZXMpLCB7fSwgewogICAgW2tleV06IFNjYWxlSGVscGVyLmNyZWF0ZShvcHRpb25zW2tleV0pCiAgfSksIHt9KTsKICByZXR1cm4gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgc2NhbGVzKSwge30sIHsKICAgIGFwcGx5KGNvb3JkKSB7CiAgICAgIHZhciB7CiAgICAgICAgYmFuZEF3YXJlLAogICAgICAgIHBvc2l0aW9uCiAgICAgIH0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogICAgICByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKGNvb3JkKS5tYXAoKF9yZWY0KSA9PiB7CiAgICAgICAgdmFyIFtsYWJlbCwgdmFsdWVdID0gX3JlZjQ7CiAgICAgICAgcmV0dXJuIFtsYWJlbCwgc2NhbGVzW2xhYmVsXS5hcHBseSh2YWx1ZSwgewogICAgICAgICAgYmFuZEF3YXJlLAogICAgICAgICAgcG9zaXRpb24KICAgICAgICB9KV07CiAgICAgIH0pKTsKICAgIH0sCiAgICBpc0luUmFuZ2UoY29vcmQpIHsKICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGNvb3JkKS5ldmVyeSgobGFiZWwpID0+IHNjYWxlc1tsYWJlbF0uaXNJblJhbmdlKGNvb3JkW2xhYmVsXSkpOwogICAgfQogIH0pOwp9OwpmdW5jdGlvbiBub3JtYWxpemVBbmdsZShhbmdsZSkgewogIHJldHVybiAoYW5nbGUgJSAxODAgKyAxODApICUgMTgwOwp9CnZhciBnZXRBbmdsZWRSZWN0YW5nbGVXaWR0aCA9IGZ1bmN0aW9uIGdldEFuZ2xlZFJlY3RhbmdsZVdpZHRoMihfcmVmNSkgewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBfcmVmNTsKICB2YXIgYW5nbGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IDA7CiAgdmFyIG5vcm1hbGl6ZWRBbmdsZSA9IG5vcm1hbGl6ZUFuZ2xlKGFuZ2xlKTsKICB2YXIgYW5nbGVSYWRpYW5zID0gbm9ybWFsaXplZEFuZ2xlICogTWF0aC5QSSAvIDE4MDsKICB2YXIgYW5nbGVUaHJlc2hvbGQgPSBNYXRoLmF0YW4oaGVpZ2h0IC8gd2lkdGgpOwogIHZhciBhbmdsZWRXaWR0aCA9IGFuZ2xlUmFkaWFucyA+IGFuZ2xlVGhyZXNob2xkICYmIGFuZ2xlUmFkaWFucyA8IE1hdGguUEkgLSBhbmdsZVRocmVzaG9sZCA/IGhlaWdodCAvIE1hdGguc2luKGFuZ2xlUmFkaWFucykgOiB3aWR0aCAvIE1hdGguY29zKGFuZ2xlUmFkaWFucyk7CiAgcmV0dXJuIE1hdGguYWJzKGFuZ2xlZFdpZHRoKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcmVmZXJlbmNlRWxlbWVudHNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlMTEgPSB7CiAgZG90czogW10sCiAgYXJlYXM6IFtdLAogIGxpbmVzOiBbXQp9Owp2YXIgcmVmZXJlbmNlRWxlbWVudHNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicmVmZXJlbmNlRWxlbWVudHMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTEsCiAgcmVkdWNlcnM6IHsKICAgIGFkZERvdDogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUuZG90cy5wdXNoKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVEb3Q6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmRvdHMuZmluZEluZGV4KChkb3QpID0+IGRvdCA9PT0gYWN0aW9uLnBheWxvYWQpOwogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgc3RhdGUuZG90cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9LAogICAgYWRkQXJlYTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUuYXJlYXMucHVzaChhY3Rpb24ucGF5bG9hZCk7CiAgICB9LAogICAgcmVtb3ZlQXJlYTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuYXJlYXMuZmluZEluZGV4KChhcmVhKSA9PiBhcmVhID09PSBhY3Rpb24ucGF5bG9hZCk7CiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICBzdGF0ZS5hcmVhcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9LAogICAgYWRkTGluZTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUubGluZXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgIH0sCiAgICByZW1vdmVMaW5lOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5saW5lcy5maW5kSW5kZXgoKGxpbmUpID0+IGxpbmUgPT09IGFjdGlvbi5wYXlsb2FkKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHN0YXRlLmxpbmVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZERvdCwKICByZW1vdmVEb3QsCiAgYWRkQXJlYSwKICByZW1vdmVBcmVhLAogIGFkZExpbmUsCiAgcmVtb3ZlTGluZQp9ID0gcmVmZXJlbmNlRWxlbWVudHNTbGljZS5hY3Rpb25zOwp2YXIgcmVmZXJlbmNlRWxlbWVudHNSZWR1Y2VyID0gcmVmZXJlbmNlRWxlbWVudHNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvQ2xpcFBhdGhQcm92aWRlci5qcwp2YXIgUmVhY3QyMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgQ2xpcFBhdGhJZENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM2LmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBDbGlwUGF0aFByb3ZpZGVyID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBbY2xpcFBhdGhJZF0gPSAoMCwgaW1wb3J0X3JlYWN0MzYudXNlU3RhdGUpKCIiLmNvbmNhdCh1bmlxdWVJZCgicmVjaGFydHMiKSwgIi1jbGlwIikpOwogIHZhciBwbG90QXJlYSA9IHVzZVBsb3RBcmVhKCk7CiAgaWYgKHBsb3RBcmVhID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHBsb3RBcmVhOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KENsaXBQYXRoSWRDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogY2xpcFBhdGhJZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIzLmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgIGlkOiBjbGlwUGF0aElkCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICBoZWlnaHQsCiAgICB3aWR0aAogIH0pKSksIGNoaWxkcmVuKTsKfTsKdmFyIHVzZUNsaXBQYXRoSWQgPSAoKSA9PiB7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QzNi51c2VDb250ZXh0KShDbGlwUGF0aElkQ29udGV4dCk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9SZWZlcmVuY2VEb3QuanMKdmFyIFJlYWN0MjQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gb3duS2V5czI4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjgoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyOChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjgoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjkodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTUoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTUgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE1LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIHVzZUNvb3JkaW5hdGUgPSAoeDIsIHkyLCB4QXhpc0lkLCB5QXhpc0lkLCBpZk92ZXJmbG93KSA9PiB7CiAgdmFyIGlzWCA9IGlzTnVtT3JTdHIoeDIpOwogIHZhciBpc1kgPSBpc051bU9yU3RyKHkyKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgeEF4aXNTY2FsZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXhpc1NjYWxlKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIHlBeGlzU2NhbGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNTY2FsZShzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIGlmICghaXNYIHx8ICFpc1kgfHwgeEF4aXNTY2FsZSA9PSBudWxsIHx8IHlBeGlzU2NhbGUgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBzY2FsZXMgPSBjcmVhdGVMYWJlbGVkU2NhbGVzKHsKICAgIHg6IHhBeGlzU2NhbGUsCiAgICB5OiB5QXhpc1NjYWxlCiAgfSk7CiAgdmFyIHJlc3VsdCA9IHNjYWxlcy5hcHBseSh7CiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSwgewogICAgYmFuZEF3YXJlOiB0cnVlCiAgfSk7CiAgaWYgKGlmT3ZlcmZsb3cgPT09ICJkaXNjYXJkIiAmJiAhc2NhbGVzLmlzSW5SYW5nZShyZXN1bHQpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfTsKZnVuY3Rpb24gUmVwb3J0UmVmZXJlbmNlRG90KHByb3BzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0MzcudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaChhZGREb3QocHJvcHMpKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGRpc3BhdGNoKHJlbW92ZURvdChwcm9wcykpOwogICAgfTsKICB9KTsKICByZXR1cm4gbnVsbDsKfQp2YXIgcmVuZGVyRG90ID0gKG9wdGlvbiwgcHJvcHMpID0+IHsKICB2YXIgZG90OwogIGlmICgvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5pc1ZhbGlkRWxlbWVudChvcHRpb24pKSB7CiAgICBkb3QgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jbG9uZUVsZW1lbnQob3B0aW9uLCBwcm9wcyk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICBkb3QgPSBvcHRpb24ocHJvcHMpOwogIH0gZWxzZSB7CiAgICBkb3QgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KERvdCwgX2V4dGVuZHMxNSh7fSwgcHJvcHMsIHsKICAgICAgY3g6IHByb3BzLmN4LAogICAgICBjeTogcHJvcHMuY3ksCiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXJlZmVyZW5jZS1kb3QtZG90IgogICAgfSkpOwogIH0KICByZXR1cm4gZG90Owp9OwpmdW5jdGlvbiBSZWZlcmVuY2VEb3RJbXBsKHByb3BzKSB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICByOiByMgogIH0gPSBwcm9wczsKICB2YXIgY2xpcFBhdGhJZCA9IHVzZUNsaXBQYXRoSWQoKTsKICB2YXIgY29vcmRpbmF0ZSA9IHVzZUNvb3JkaW5hdGUoeDIsIHkyLCBwcm9wcy54QXhpc0lkLCBwcm9wcy55QXhpc0lkLCBwcm9wcy5pZk92ZXJmbG93KTsKICBpZiAoIWNvb3JkaW5hdGUpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeDogY3gsCiAgICB5OiBjeQogIH0gPSBjb29yZGluYXRlOwogIHZhciB7CiAgICBzaGFwZSwKICAgIGNsYXNzTmFtZSwKICAgIGlmT3ZlcmZsb3cKICB9ID0gcHJvcHM7CiAgdmFyIGNsaXBQYXRoID0gaWZPdmVyZmxvdyA9PT0gImhpZGRlbiIgPyAidXJsKCMiLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpIDogdm9pZCAwOwogIHZhciBkb3RQcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoewogICAgY2xpcFBhdGgKICB9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSksIHt9LCB7CiAgICBjeCwKICAgIGN5CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogcHJvcHMuekluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1yZWZlcmVuY2UtZG90IiwgY2xhc3NOYW1lKQogIH0sIHJlbmRlckRvdChzaGFwZSwgZG90UHJvcHMpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsQ29udGV4dFByb3ZpZGVyLCB7CiAgICB4OiBjeCAtIHIyLAogICAgeTogY3kgLSByMiwKICAgIHdpZHRoOiAyICogcjIsCiAgICBoZWlnaHQ6IDIgKiByMiwKICAgIHVwcGVyV2lkdGg6IDIgKiByMiwKICAgIGxvd2VyV2lkdGg6IDIgKiByMgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxGcm9tTGFiZWxQcm9wLCB7CiAgICBsYWJlbDogcHJvcHMubGFiZWwKICB9KSwgcHJvcHMuY2hpbGRyZW4pKSk7Cn0KdmFyIHJlZmVyZW5jZURvdERlZmF1bHRQcm9wcyA9IHsKICBpZk92ZXJmbG93OiAiZGlzY2FyZCIsCiAgeEF4aXNJZDogMCwKICB5QXhpc0lkOiAwLAogIHI6IDEwLAogIGZpbGw6ICIjZmZmIiwKICBzdHJva2U6ICIjY2NjIiwKICBmaWxsT3BhY2l0eTogMSwKICBzdHJva2VXaWR0aDogMSwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5zY2F0dGVyCn07CmZ1bmN0aW9uIFJlZmVyZW5jZURvdChvdXRzaWRlUHJvcHMpIHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgcmVmZXJlbmNlRG90RGVmYXVsdFByb3BzKTsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHI6IHIyLAogICAgaWZPdmVyZmxvdywKICAgIHlBeGlzSWQsCiAgICB4QXhpc0lkCiAgfSA9IHByb3BzOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFJlYWN0MjQuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoUmVwb3J0UmVmZXJlbmNlRG90LCB7CiAgICB5OiB5MiwKICAgIHg6IHgyLAogICAgcjogcjIsCiAgICB5QXhpc0lkLAogICAgeEF4aXNJZCwKICAgIGlmT3ZlcmZsb3cKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChSZWZlcmVuY2VEb3RJbXBsLCBwcm9wcykpOwp9ClJlZmVyZW5jZURvdC5kaXNwbGF5TmFtZSA9ICJSZWZlcmVuY2VEb3QiOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQ2FydGVzaWFuQXhpcy5qcwp2YXIgUmVhY3QyNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X2dldDMgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRFdmVyeU50aFdpdGhDb25kaXRpb24uanMKZnVuY3Rpb24gZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKGFycmF5LCBuKSB7CiAgaWYgKG4gPCAxKSB7CiAgICByZXR1cm4gW107CiAgfQogIGlmIChuID09PSAxKSB7CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIHZhciByZXN1bHQgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSArPSBuKSB7CiAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9UaWNrVXRpbHMuanMKZnVuY3Rpb24gZ2V0QW5nbGVkVGlja1dpZHRoKGNvbnRlbnRTaXplLCB1bml0U2l6ZSwgYW5nbGUpIHsKICB2YXIgc2l6ZSA9IHsKICAgIHdpZHRoOiBjb250ZW50U2l6ZS53aWR0aCArIHVuaXRTaXplLndpZHRoLAogICAgaGVpZ2h0OiBjb250ZW50U2l6ZS5oZWlnaHQgKyB1bml0U2l6ZS5oZWlnaHQKICB9OwogIHJldHVybiBnZXRBbmdsZWRSZWN0YW5nbGVXaWR0aChzaXplLCBhbmdsZSk7Cn0KZnVuY3Rpb24gZ2V0VGlja0JvdW5kYXJpZXModmlld0JveCwgc2lnbjIsIHNpemVLZXkpIHsKICB2YXIgaXNXaWR0aCA9IHNpemVLZXkgPT09ICJ3aWR0aCI7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSB2aWV3Qm94OwogIGlmIChzaWduMiA9PT0gMSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGlzV2lkdGggPyB4MiA6IHkyLAogICAgICBlbmQ6IGlzV2lkdGggPyB4MiArIHdpZHRoIDogeTIgKyBoZWlnaHQKICAgIH07CiAgfQogIHJldHVybiB7CiAgICBzdGFydDogaXNXaWR0aCA/IHgyICsgd2lkdGggOiB5MiArIGhlaWdodCwKICAgIGVuZDogaXNXaWR0aCA/IHgyIDogeTIKICB9Owp9CmZ1bmN0aW9uIGlzVmlzaWJsZShzaWduMiwgdGlja1Bvc2l0aW9uLCBnZXRTaXplLCBzdGFydCwgZW5kKSB7CiAgaWYgKHNpZ24yICogdGlja1Bvc2l0aW9uIDwgc2lnbjIgKiBzdGFydCB8fCBzaWduMiAqIHRpY2tQb3NpdGlvbiA+IHNpZ24yICogZW5kKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBzaXplID0gZ2V0U2l6ZSgpOwogIHJldHVybiBzaWduMiAqICh0aWNrUG9zaXRpb24gLSBzaWduMiAqIHNpemUgLyAyIC0gc3RhcnQpID49IDAgJiYgc2lnbjIgKiAodGlja1Bvc2l0aW9uICsgc2lnbjIgKiBzaXplIC8gMiAtIGVuZCkgPD0gMDsKfQpmdW5jdGlvbiBnZXROdW1iZXJJbnRlcnZhbFRpY2tzKHRpY2tzMiwgaW50ZXJ2YWwpIHsKICByZXR1cm4gZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKHRpY2tzMiwgaW50ZXJ2YWwgKyAxKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vZ2V0RXF1aWRpc3RhbnRUaWNrcy5qcwpmdW5jdGlvbiBnZXRFcXVpZGlzdGFudFRpY2tzKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKSB7CiAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgW10pLnNsaWNlKCk7CiAgdmFyIHsKICAgIHN0YXJ0OiBpbml0aWFsU3RhcnQsCiAgICBlbmQKICB9ID0gYm91bmRhcmllczsKICB2YXIgaW5kZXggPSAwOwogIHZhciBzdGVwc2l6ZSA9IDE7CiAgdmFyIHN0YXJ0ID0gaW5pdGlhbFN0YXJ0OwogIHZhciBfbG9vcCA9IGZ1bmN0aW9uIF9sb29wMigpIHsKICAgIHZhciBlbnRyeSA9IHRpY2tzMiA9PT0gbnVsbCB8fCB0aWNrczIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRpY2tzMltpbmRleF07CiAgICBpZiAoZW50cnkgPT09IHZvaWQgMCkgewogICAgICByZXR1cm4gewogICAgICAgIHY6IGdldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbih0aWNrczIsIHN0ZXBzaXplKQogICAgICB9OwogICAgfQogICAgdmFyIGkgPSBpbmRleDsKICAgIHZhciBzaXplOwogICAgdmFyIGdldFNpemUgPSAoKSA9PiB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gZ2V0VGlja1NpemUoZW50cnksIGkpOwogICAgICB9CiAgICAgIHJldHVybiBzaXplOwogICAgfTsKICAgIHZhciB0aWNrQ29vcmQgPSBlbnRyeS5jb29yZGluYXRlOwogICAgdmFyIGlzU2hvdyA9IGluZGV4ID09PSAwIHx8IGlzVmlzaWJsZShzaWduMiwgdGlja0Nvb3JkLCBnZXRTaXplLCBzdGFydCwgZW5kKTsKICAgIGlmICghaXNTaG93KSB7CiAgICAgIGluZGV4ID0gMDsKICAgICAgc3RhcnQgPSBpbml0aWFsU3RhcnQ7CiAgICAgIHN0ZXBzaXplICs9IDE7CiAgICB9CiAgICBpZiAoaXNTaG93KSB7CiAgICAgIHN0YXJ0ID0gdGlja0Nvb3JkICsgc2lnbjIgKiAoZ2V0U2l6ZSgpIC8gMiArIG1pblRpY2tHYXApOwogICAgICBpbmRleCArPSBzdGVwc2l6ZTsKICAgIH0KICB9LCBfcmV0OwogIHdoaWxlIChzdGVwc2l6ZSA8PSByZXN1bHQubGVuZ3RoKSB7CiAgICBfcmV0ID0gX2xvb3AoKTsKICAgIGlmIChfcmV0KSByZXR1cm4gX3JldC52OwogIH0KICByZXR1cm4gW107Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL2dldFRpY2tzLmpzCmZ1bmN0aW9uIG93bktleXMyOShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI5KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjkoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI5KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRUaWNrc0VuZChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCkgewogIHZhciByZXN1bHQgPSAodGlja3MyIHx8IFtdKS5zbGljZSgpOwogIHZhciBsZW4gPSByZXN1bHQubGVuZ3RoOwogIHZhciB7CiAgICBzdGFydAogIH0gPSBib3VuZGFyaWVzOwogIHZhciB7CiAgICBlbmQKICB9ID0gYm91bmRhcmllczsKICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcDIoaTIpIHsKICAgIHZhciBlbnRyeSA9IHJlc3VsdFtpMl07CiAgICB2YXIgc2l6ZTsKICAgIHZhciBnZXRTaXplID0gKCkgPT4gewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IGdldFRpY2tTaXplKGVudHJ5LCBpMik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgaWYgKGkyID09PSBsZW4gLSAxKSB7CiAgICAgIHZhciBnYXAgPSBzaWduMiAqIChlbnRyeS5jb29yZGluYXRlICsgc2lnbjIgKiBnZXRTaXplKCkgLyAyIC0gZW5kKTsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZ2FwID4gMCA/IGVudHJ5LmNvb3JkaW5hdGUgLSBnYXAgKiBzaWduMiA6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXN1bHRbaTJdID0gZW50cnkgPSBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgdGlja0Nvb3JkOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfQogICAgaWYgKGVudHJ5LnRpY2tDb29yZCAhPSBudWxsKSB7CiAgICAgIHZhciBpc1Nob3cgPSBpc1Zpc2libGUoc2lnbjIsIGVudHJ5LnRpY2tDb29yZCwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1Nob3cpIHsKICAgICAgICBlbmQgPSBlbnRyeS50aWNrQ29vcmQgLSBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2kyXSA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKICBmb3IgKHZhciBpID0gbGVuIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIF9sb29wKGkpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGdldFRpY2tzU3RhcnQoc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXAsIHByZXNlcnZlRW5kKSB7CiAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgW10pLnNsaWNlKCk7CiAgdmFyIGxlbiA9IHJlc3VsdC5sZW5ndGg7CiAgdmFyIHsKICAgIHN0YXJ0LAogICAgZW5kCiAgfSA9IGJvdW5kYXJpZXM7CiAgaWYgKHByZXNlcnZlRW5kKSB7CiAgICB2YXIgdGFpbCA9IHRpY2tzMltsZW4gLSAxXTsKICAgIHZhciB0YWlsU2l6ZSA9IGdldFRpY2tTaXplKHRhaWwsIGxlbiAtIDEpOwogICAgdmFyIHRhaWxHYXAgPSBzaWduMiAqICh0YWlsLmNvb3JkaW5hdGUgKyBzaWduMiAqIHRhaWxTaXplIC8gMiAtIGVuZCk7CiAgICByZXN1bHRbbGVuIC0gMV0gPSB0YWlsID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgdGFpbCksIHt9LCB7CiAgICAgIHRpY2tDb29yZDogdGFpbEdhcCA+IDAgPyB0YWlsLmNvb3JkaW5hdGUgLSB0YWlsR2FwICogc2lnbjIgOiB0YWlsLmNvb3JkaW5hdGUKICAgIH0pOwogICAgaWYgKHRhaWwudGlja0Nvb3JkICE9IG51bGwpIHsKICAgICAgdmFyIGlzVGFpbFNob3cgPSBpc1Zpc2libGUoc2lnbjIsIHRhaWwudGlja0Nvb3JkLCAoKSA9PiB0YWlsU2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1RhaWxTaG93KSB7CiAgICAgICAgZW5kID0gdGFpbC50aWNrQ29vcmQgLSBzaWduMiAqICh0YWlsU2l6ZSAvIDIgKyBtaW5UaWNrR2FwKTsKICAgICAgICByZXN1bHRbbGVuIC0gMV0gPSBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCB0YWlsKSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfQogIHZhciBjb3VudCA9IHByZXNlcnZlRW5kID8gbGVuIC0gMSA6IGxlbjsKICB2YXIgX2xvb3AyID0gZnVuY3Rpb24gX2xvb3AyMihpMikgewogICAgdmFyIGVudHJ5ID0gcmVzdWx0W2kyXTsKICAgIHZhciBzaXplOwogICAgdmFyIGdldFNpemUgPSAoKSA9PiB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gZ2V0VGlja1NpemUoZW50cnksIGkyKTsKICAgICAgfQogICAgICByZXR1cm4gc2l6ZTsKICAgIH07CiAgICBpZiAoaTIgPT09IDApIHsKICAgICAgdmFyIGdhcCA9IHNpZ24yICogKGVudHJ5LmNvb3JkaW5hdGUgLSBzaWduMiAqIGdldFNpemUoKSAvIDIgLSBzdGFydCk7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGdhcCA8IDAgPyBlbnRyeS5jb29yZGluYXRlIC0gZ2FwICogc2lnbjIgOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0KICAgIGlmIChlbnRyeS50aWNrQ29vcmQgIT0gbnVsbCkgewogICAgICB2YXIgaXNTaG93ID0gaXNWaXNpYmxlKHNpZ24yLCBlbnRyeS50aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaXNTaG93KSB7CiAgICAgICAgc3RhcnQgPSBlbnRyeS50aWNrQ29vcmQgKyBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2kyXSA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgIF9sb29wMihpKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBnZXRUaWNrcyhwcm9wcywgZm9udFNpemUsIGxldHRlclNwYWNpbmcpIHsKICB2YXIgewogICAgdGljaywKICAgIHRpY2tzOiB0aWNrczIsCiAgICB2aWV3Qm94LAogICAgbWluVGlja0dhcCwKICAgIG9yaWVudGF0aW9uLAogICAgaW50ZXJ2YWwsCiAgICB0aWNrRm9ybWF0dGVyLAogICAgdW5pdDogdW5pdDIsCiAgICBhbmdsZQogIH0gPSBwcm9wczsKICBpZiAoIXRpY2tzMiB8fCAhdGlja3MyLmxlbmd0aCB8fCAhdGljaykgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAoaXNOdW1iZXIoaW50ZXJ2YWwpIHx8IEdsb2JhbC5pc1NzcikgewogICAgdmFyIF9nZXROdW1iZXJJbnRlcnZhbFRpYzsKICAgIHJldHVybiAoX2dldE51bWJlckludGVydmFsVGljID0gZ2V0TnVtYmVySW50ZXJ2YWxUaWNrcyh0aWNrczIsIGlzTnVtYmVyKGludGVydmFsKSA/IGludGVydmFsIDogMCkpICE9PSBudWxsICYmIF9nZXROdW1iZXJJbnRlcnZhbFRpYyAhPT0gdm9pZCAwID8gX2dldE51bWJlckludGVydmFsVGljIDogW107CiAgfQogIHZhciBjYW5kaWRhdGVzID0gW107CiAgdmFyIHNpemVLZXkgPSBvcmllbnRhdGlvbiA9PT0gInRvcCIgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iID8gIndpZHRoIiA6ICJoZWlnaHQiOwogIHZhciB1bml0U2l6ZSA9IHVuaXQyICYmIHNpemVLZXkgPT09ICJ3aWR0aCIgPyBnZXRTdHJpbmdTaXplKHVuaXQyLCB7CiAgICBmb250U2l6ZSwKICAgIGxldHRlclNwYWNpbmcKICB9KSA6IHsKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwCiAgfTsKICB2YXIgZ2V0VGlja1NpemUgPSAoY29udGVudCwgaW5kZXgpID0+IHsKICAgIHZhciB2YWx1ZSA9IHR5cGVvZiB0aWNrRm9ybWF0dGVyID09PSAiZnVuY3Rpb24iID8gdGlja0Zvcm1hdHRlcihjb250ZW50LnZhbHVlLCBpbmRleCkgOiBjb250ZW50LnZhbHVlOwogICAgcmV0dXJuIHNpemVLZXkgPT09ICJ3aWR0aCIgPyBnZXRBbmdsZWRUaWNrV2lkdGgoZ2V0U3RyaW5nU2l6ZSh2YWx1ZSwgewogICAgICBmb250U2l6ZSwKICAgICAgbGV0dGVyU3BhY2luZwogICAgfSksIHVuaXRTaXplLCBhbmdsZSkgOiBnZXRTdHJpbmdTaXplKHZhbHVlLCB7CiAgICAgIGZvbnRTaXplLAogICAgICBsZXR0ZXJTcGFjaW5nCiAgICB9KVtzaXplS2V5XTsKICB9OwogIHZhciBzaWduMiA9IHRpY2tzMi5sZW5ndGggPj0gMiA/IG1hdGhTaWduKHRpY2tzMlsxXS5jb29yZGluYXRlIC0gdGlja3MyWzBdLmNvb3JkaW5hdGUpIDogMTsKICB2YXIgYm91bmRhcmllcyA9IGdldFRpY2tCb3VuZGFyaWVzKHZpZXdCb3gsIHNpZ24yLCBzaXplS2V5KTsKICBpZiAoaW50ZXJ2YWwgPT09ICJlcXVpZGlzdGFudFByZXNlcnZlU3RhcnQiKSB7CiAgICByZXR1cm4gZ2V0RXF1aWRpc3RhbnRUaWNrcyhzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCk7CiAgfQogIGlmIChpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnQiIHx8IGludGVydmFsID09PSAicHJlc2VydmVTdGFydEVuZCIpIHsKICAgIGNhbmRpZGF0ZXMgPSBnZXRUaWNrc1N0YXJ0KHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwLCBpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnRFbmQiKTsKICB9IGVsc2UgewogICAgY2FuZGlkYXRlcyA9IGdldFRpY2tzRW5kKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKTsKICB9CiAgcmV0dXJuIGNhbmRpZGF0ZXMuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkuaXNTaG93KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1lBeGlzVXRpbHMuanMKdmFyIGdldENhbGN1bGF0ZWRZQXhpc1dpZHRoID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHRpY2tzOiB0aWNrczIsCiAgICBsYWJlbCwKICAgIGxhYmVsR2FwV2l0aFRpY2sgPSA1LAogICAgLy8gRGVmYXVsdCBnYXAgYmV0d2VlbiBsYWJlbCBhbmQgdGljawogICAgdGlja1NpemUgPSAwLAogICAgdGlja01hcmdpbiA9IDAKICB9ID0gX3JlZjI7CiAgdmFyIG1heFRpY2tXaWR0aCA9IDA7CiAgaWYgKHRpY2tzMikgewogICAgQXJyYXkuZnJvbSh0aWNrczIpLmZvckVhY2goKHRpY2tOb2RlKSA9PiB7CiAgICAgIGlmICh0aWNrTm9kZSkgewogICAgICAgIHZhciBiYm94ID0gdGlja05vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgaWYgKGJib3gud2lkdGggPiBtYXhUaWNrV2lkdGgpIHsKICAgICAgICAgIG1heFRpY2tXaWR0aCA9IGJib3gud2lkdGg7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciBsYWJlbFdpZHRoID0gbGFiZWwgPyBsYWJlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCA6IDA7CiAgICB2YXIgdGlja1dpZHRoID0gdGlja1NpemUgKyB0aWNrTWFyZ2luOwogICAgdmFyIHVwZGF0ZWRZQXhpc1dpZHRoID0gbWF4VGlja1dpZHRoICsgdGlja1dpZHRoICsgbGFiZWxXaWR0aCArIChsYWJlbCA/IGxhYmVsR2FwV2l0aFRpY2sgOiAwKTsKICAgIHJldHVybiBNYXRoLnJvdW5kKHVwZGF0ZWRZQXhpc1dpZHRoKTsKICB9CiAgcmV0dXJuIDA7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9DYXJ0ZXNpYW5BeGlzLmpzCnZhciBfZXhjbHVkZWQxMCA9IFsiYXhpc0xpbmUiLCAid2lkdGgiLCAiaGVpZ2h0IiwgImNsYXNzTmFtZSIsICJoaWRlIiwgInRpY2tzIiwgImF4aXNUeXBlIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczEwKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTAocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9leHRlbmRzMTYoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTYgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE2LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czMwKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMzAoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMzMChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMzAoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMxKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgdmlld0JveDogewogICAgeDogMCwKICAgIHk6IDAsCiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMAogIH0sCiAgLy8gVGhlIG9yaWVudGF0aW9uIG9mIGF4aXMKICBvcmllbnRhdGlvbjogImJvdHRvbSIsCiAgLy8gVGhlIHRpY2tzCiAgdGlja3M6IFtdLAogIHN0cm9rZTogIiM2NjYiLAogIHRpY2tMaW5lOiB0cnVlLAogIGF4aXNMaW5lOiB0cnVlLAogIHRpY2s6IHRydWUsCiAgbWlycm9yOiBmYWxzZSwKICBtaW5UaWNrR2FwOiA1LAogIC8vIFRoZSB3aWR0aCBvciBoZWlnaHQgb2YgdGljawogIHRpY2tTaXplOiA2LAogIHRpY2tNYXJnaW46IDIsCiAgaW50ZXJ2YWw6ICJwcmVzZXJ2ZUVuZCIsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXhpcwp9OwpmdW5jdGlvbiBBeGlzTGluZShheGlzTGluZVByb3BzKSB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9yaWVudGF0aW9uLAogICAgbWlycm9yLAogICAgYXhpc0xpbmUsCiAgICBvdGhlclN2Z1Byb3BzCiAgfSA9IGF4aXNMaW5lUHJvcHM7CiAgaWYgKCFheGlzTGluZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBwcm9wcyA9IF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCBvdGhlclN2Z1Byb3BzKSwgc3ZnUHJvcGVydGllc05vRXZlbnRzKGF4aXNMaW5lKSksIHt9LCB7CiAgICBmaWxsOiAibm9uZSIKICB9KTsKICBpZiAob3JpZW50YXRpb24gPT09ICJ0b3AiIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIikgewogICAgdmFyIG5lZWRIZWlnaHQgPSArKG9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiBtaXJyb3IpOwogICAgcHJvcHMgPSBfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCBwcm9wcyksIHt9LCB7CiAgICAgIHgxOiB4MiwKICAgICAgeTE6IHkyICsgbmVlZEhlaWdodCAqIGhlaWdodCwKICAgICAgeDI6IHgyICsgd2lkdGgsCiAgICAgIHkyOiB5MiArIG5lZWRIZWlnaHQgKiBoZWlnaHQKICAgIH0pOwogIH0gZWxzZSB7CiAgICB2YXIgbmVlZFdpZHRoID0gKyhvcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJyaWdodCIgJiYgbWlycm9yKTsKICAgIHByb3BzID0gX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7fSwgcHJvcHMpLCB7fSwgewogICAgICB4MTogeDIgKyBuZWVkV2lkdGggKiB3aWR0aCwKICAgICAgeTE6IHkyLAogICAgICB4MjogeDIgKyBuZWVkV2lkdGggKiB3aWR0aCwKICAgICAgeTI6IHkyICsgaGVpZ2h0CiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImxpbmUiLCBfZXh0ZW5kczE2KHt9LCBwcm9wcywgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy1saW5lIiwgKDAsIGltcG9ydF9nZXQzLmRlZmF1bHQpKGF4aXNMaW5lLCAiY2xhc3NOYW1lIikpCiAgfSkpOwp9CmZ1bmN0aW9uIGdldFRpY2tMaW5lQ29vcmQoZGF0YSwgeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCBvcmllbnRhdGlvbiwgdGlja1NpemUsIG1pcnJvciwgdGlja01hcmdpbikgewogIHZhciB4MSwgeDIyLCB5MSwgeTIyLCB0eCwgdHk7CiAgdmFyIHNpZ24yID0gbWlycm9yID8gLTEgOiAxOwogIHZhciBmaW5hbFRpY2tTaXplID0gZGF0YS50aWNrU2l6ZSB8fCB0aWNrU2l6ZTsKICB2YXIgdGlja0Nvb3JkID0gaXNOdW1iZXIoZGF0YS50aWNrQ29vcmQpID8gZGF0YS50aWNrQ29vcmQgOiBkYXRhLmNvb3JkaW5hdGU7CiAgc3dpdGNoIChvcmllbnRhdGlvbikgewogICAgY2FzZSAidG9wIjoKICAgICAgeDEgPSB4MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHkyMiA9IHkyICsgKyFtaXJyb3IgKiBoZWlnaHQ7CiAgICAgIHkxID0geTIyIC0gc2lnbjIgKiBmaW5hbFRpY2tTaXplOwogICAgICB0eSA9IHkxIC0gc2lnbjIgKiB0aWNrTWFyZ2luOwogICAgICB0eCA9IHRpY2tDb29yZDsKICAgICAgYnJlYWs7CiAgICBjYXNlICJsZWZ0IjoKICAgICAgeTEgPSB5MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHgyMiA9IHgyICsgKyFtaXJyb3IgKiB3aWR0aDsKICAgICAgeDEgPSB4MjIgLSBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR4ID0geDEgLSBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR5ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgeTEgPSB5MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHgyMiA9IHgyICsgK21pcnJvciAqIHdpZHRoOwogICAgICB4MSA9IHgyMiArIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHggPSB4MSArIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHkgPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgeDEgPSB4MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHkyMiA9IHkyICsgK21pcnJvciAqIGhlaWdodDsKICAgICAgeTEgPSB5MjIgKyBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR5ID0geTEgKyBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR4ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICB9CiAgcmV0dXJuIHsKICAgIGxpbmU6IHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MjogeDIyLAogICAgICB5MjogeTIyCiAgICB9LAogICAgdGljazogewogICAgICB4OiB0eCwKICAgICAgeTogdHkKICAgIH0KICB9Owp9CmZ1bmN0aW9uIGdldFRpY2tUZXh0QW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpIHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJsZWZ0IjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJzdGFydCIgOiAiZW5kIjsKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJlbmQiIDogInN0YXJ0IjsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiAibWlkZGxlIjsKICB9Cn0KZnVuY3Rpb24gZ2V0VGlja1ZlcnRpY2FsQW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpIHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJsZWZ0IjoKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgcmV0dXJuICJtaWRkbGUiOwogICAgY2FzZSAidG9wIjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJzdGFydCIgOiAiZW5kIjsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBtaXJyb3IgPyAiZW5kIiA6ICJzdGFydCI7CiAgfQp9CmZ1bmN0aW9uIFRpY2tJdGVtKHByb3BzKSB7CiAgdmFyIHsKICAgIG9wdGlvbiwKICAgIHRpY2tQcm9wcywKICAgIHZhbHVlCiAgfSA9IHByb3BzOwogIHZhciB0aWNrSXRlbTsKICB2YXIgY29tYmluZWRDbGFzc05hbWUgPSBjbHN4KHRpY2tQcm9wcy5jbGFzc05hbWUsICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLXZhbHVlIik7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmlzVmFsaWRFbGVtZW50KG9wdGlvbikpIHsKICAgIHRpY2tJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY2xvbmVFbGVtZW50KG9wdGlvbiwgX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7fSwgdGlja1Byb3BzKSwge30sIHsKICAgICAgY2xhc3NOYW1lOiBjb21iaW5lZENsYXNzTmFtZQogICAgfSkpOwogIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgdGlja0l0ZW0gPSBvcHRpb24oX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7fSwgdGlja1Byb3BzKSwge30sIHsKICAgICAgY2xhc3NOYW1lOiBjb21iaW5lZENsYXNzTmFtZQogICAgfSkpOwogIH0gZWxzZSB7CiAgICB2YXIgY2xhc3NOYW1lID0gInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiOwogICAgaWYgKHR5cGVvZiBvcHRpb24gIT09ICJib29sZWFuIikgewogICAgICBjbGFzc05hbWUgPSBjbHN4KGNsYXNzTmFtZSwgb3B0aW9uID09PSBudWxsIHx8IG9wdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9uLmNsYXNzTmFtZSk7CiAgICB9CiAgICB0aWNrSXRlbSA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoVGV4dCwgX2V4dGVuZHMxNih7fSwgdGlja1Byb3BzLCB7CiAgICAgIGNsYXNzTmFtZQogICAgfSksIHZhbHVlKTsKICB9CiAgcmV0dXJuIHRpY2tJdGVtOwp9CnZhciBUaWNrcyA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzguZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgdGlja3M6IHRpY2tzMiA9IFtdLAogICAgdGljaywKICAgIHRpY2tMaW5lLAogICAgc3Ryb2tlLAogICAgdGlja0Zvcm1hdHRlciwKICAgIHVuaXQ6IHVuaXQyLAogICAgcGFkZGluZywKICAgIHRpY2tUZXh0UHJvcHMsCiAgICBvcmllbnRhdGlvbiwKICAgIG1pcnJvciwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHRpY2tTaXplLAogICAgdGlja01hcmdpbiwKICAgIGZvbnRTaXplLAogICAgbGV0dGVyU3BhY2luZywKICAgIGdldFRpY2tzQ29uZmlnLAogICAgZXZlbnRzLAogICAgYXhpc1R5cGUKICB9ID0gcHJvcHM7CiAgdmFyIGZpbmFsVGlja3MgPSBnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCBnZXRUaWNrc0NvbmZpZyksIHt9LCB7CiAgICB0aWNrczogdGlja3MyCiAgfSksIGZvbnRTaXplLCBsZXR0ZXJTcGFjaW5nKTsKICB2YXIgdGV4dEFuY2hvciA9IGdldFRpY2tUZXh0QW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpOwogIHZhciB2ZXJ0aWNhbEFuY2hvciA9IGdldFRpY2tWZXJ0aWNhbEFuY2hvcihvcmllbnRhdGlvbiwgbWlycm9yKTsKICB2YXIgYXhpc1Byb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKGdldFRpY2tzQ29uZmlnKTsKICB2YXIgY3VzdG9tVGlja1Byb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24odGljayk7CiAgdmFyIHRpY2tMaW5lUHJvcHNPYmplY3QgPSB7fTsKICBpZiAodHlwZW9mIHRpY2tMaW5lID09PSAib2JqZWN0IikgewogICAgdGlja0xpbmVQcm9wc09iamVjdCA9IHRpY2tMaW5lOwogIH0KICB2YXIgdGlja0xpbmVQcm9wcyA9IF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoe30sIGF4aXNQcm9wcyksIHt9LCB7CiAgICBmaWxsOiAibm9uZSIKICB9LCB0aWNrTGluZVByb3BzT2JqZWN0KTsKICB2YXIgdGlja0xpbmVDb29yZHMgPSBmaW5hbFRpY2tzLm1hcCgoZW50cnkpID0+IF9vYmplY3RTcHJlYWQzMCh7CiAgICBlbnRyeQogIH0sIGdldFRpY2tMaW5lQ29vcmQoZW50cnksIHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgb3JpZW50YXRpb24sIHRpY2tTaXplLCBtaXJyb3IsIHRpY2tNYXJnaW4pKSk7CiAgdmFyIHRpY2tMaW5lcyA9IHRpY2tMaW5lQ29vcmRzLm1hcCgoX3JlZjIpID0+IHsKICAgIHZhciB7CiAgICAgIGVudHJ5LAogICAgICBsaW5lOiBsaW5lQ29vcmQKICAgIH0gPSBfcmVmMjsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2siLAogICAgICBrZXk6ICJ0aWNrLSIuY29uY2F0KGVudHJ5LnZhbHVlLCAiLSIpLmNvbmNhdChlbnRyeS5jb29yZGluYXRlLCAiLSIpLmNvbmNhdChlbnRyeS50aWNrQ29vcmQpCiAgICB9LCB0aWNrTGluZSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJsaW5lIiwgX2V4dGVuZHMxNih7fSwgdGlja0xpbmVQcm9wcywgbGluZUNvb3JkLCB7CiAgICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay1saW5lIiwgKDAsIGltcG9ydF9nZXQzLmRlZmF1bHQpKHRpY2tMaW5lLCAiY2xhc3NOYW1lIikpCiAgICB9KSkpOwogIH0pOwogIHZhciB0aWNrTGFiZWxzID0gdGlja0xpbmVDb29yZHMubWFwKChfcmVmMiwgaSkgPT4gewogICAgdmFyIHsKICAgICAgZW50cnksCiAgICAgIHRpY2s6IHRpY2tDb29yZAogICAgfSA9IF9yZWYyOwogICAgdmFyIHRpY2tQcm9wcyA9IF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdGV4dEFuY2hvciBmcm9tIGF4aXNQcm9wcyBpcyB0eXBlZCBhcyBgc3RyaW5nYCBidXQgVGV4dCB3YW50cyB0eXBlIGBUZXh0QW5jaG9yYAogICAgICB0ZXh0QW5jaG9yLAogICAgICB2ZXJ0aWNhbEFuY2hvcgogICAgfSwgYXhpc1Byb3BzKSwge30sIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBjdXN0b21UaWNrUHJvcHMgaXMgY29udHJpYnV0aW5nIHVua25vd24gcHJvcHMKICAgICAgc3Ryb2tlOiAibm9uZSIsCiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgY3VzdG9tVGlja1Byb3BzIGlzIGNvbnRyaWJ1dGluZyB1bmtub3duIHByb3BzCiAgICAgIGZpbGw6IHN0cm9rZQogICAgfSwgY3VzdG9tVGlja1Byb3BzKSwgdGlja0Nvb3JkKSwge30sIHsKICAgICAgaW5kZXg6IGksCiAgICAgIHBheWxvYWQ6IGVudHJ5LAogICAgICB2aXNpYmxlVGlja3NDb3VudDogZmluYWxUaWNrcy5sZW5ndGgsCiAgICAgIHRpY2tGb3JtYXR0ZXIsCiAgICAgIHBhZGRpbmcKICAgIH0sIHRpY2tUZXh0UHJvcHMpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIF9leHRlbmRzMTYoewogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxhYmVsIiwKICAgICAga2V5OiAidGljay1sYWJlbC0iLmNvbmNhdChlbnRyeS52YWx1ZSwgIi0iKS5jb25jYXQoZW50cnkuY29vcmRpbmF0ZSwgIi0iKS5jb25jYXQoZW50cnkudGlja0Nvb3JkKQogICAgfSwgYWRhcHRFdmVudHNPZkNoaWxkKGV2ZW50cywgZW50cnksIGkpKSwgdGljayAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KFRpY2tJdGVtLCB7CiAgICAgIG9wdGlvbjogdGljaywKICAgICAgdGlja1Byb3BzLAogICAgICB2YWx1ZTogIiIuY29uY2F0KHR5cGVvZiB0aWNrRm9ybWF0dGVyID09PSAiZnVuY3Rpb24iID8gdGlja0Zvcm1hdHRlcihlbnRyeS52YWx1ZSwgaSkgOiBlbnRyeS52YWx1ZSkuY29uY2F0KHVuaXQyIHx8ICIiKQogICAgfSkpOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGlja3MgcmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICItdGlja3MiKQogIH0sIHRpY2tMYWJlbHMubGVuZ3RoID4gMCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5sYWJlbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxhYmVscyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrLWxhYmVscyIpLAogICAgcmVmCiAgfSwgdGlja0xhYmVscykpLCB0aWNrTGluZXMubGVuZ3RoID4gMCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay1saW5lcyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrLWxpbmVzIikKICB9LCB0aWNrTGluZXMpKTsKfSk7CnZhciBDYXJ0ZXNpYW5BeGlzQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzOC5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBheGlzTGluZSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgY2xhc3NOYW1lLAogICAgaGlkZSwKICAgIHRpY2tzOiB0aWNrczIsCiAgICBheGlzVHlwZQogIH0gPSBwcm9wcywgcmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEwKHByb3BzLCBfZXhjbHVkZWQxMCk7CiAgdmFyIFtmb250U2l6ZSwgc2V0Rm9udFNpemVdID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZVN0YXRlKSgiIik7CiAgdmFyIFtsZXR0ZXJTcGFjaW5nLCBzZXRMZXR0ZXJTcGFjaW5nXSA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VTdGF0ZSkoIiIpOwogIHZhciB0aWNrUmVmcyA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QzOC51c2VJbXBlcmF0aXZlSGFuZGxlKShyZWYsICgpID0+ICh7CiAgICBnZXRDYWxjdWxhdGVkV2lkdGg6ICgpID0+IHsKICAgICAgdmFyIF9wcm9wcyRsYWJlbFJlZjsKICAgICAgcmV0dXJuIGdldENhbGN1bGF0ZWRZQXhpc1dpZHRoKHsKICAgICAgICB0aWNrczogdGlja1JlZnMuY3VycmVudCwKICAgICAgICBsYWJlbDogKF9wcm9wcyRsYWJlbFJlZiA9IHByb3BzLmxhYmVsUmVmKSA9PT0gbnVsbCB8fCBfcHJvcHMkbGFiZWxSZWYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wcm9wcyRsYWJlbFJlZi5jdXJyZW50LAogICAgICAgIGxhYmVsR2FwV2l0aFRpY2s6IDUsCiAgICAgICAgdGlja1NpemU6IHByb3BzLnRpY2tTaXplLAogICAgICAgIHRpY2tNYXJnaW46IHByb3BzLnRpY2tNYXJnaW4KICAgICAgfSk7CiAgICB9CiAgfSkpOwogIHZhciBsYXllclJlZiA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VDYWxsYmFjaykoKGVsKSA9PiB7CiAgICBpZiAoZWwpIHsKICAgICAgdmFyIHRpY2tOb2RlcyA9IGVsLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiKTsKICAgICAgdGlja1JlZnMuY3VycmVudCA9IHRpY2tOb2RlczsKICAgICAgdmFyIHRpY2sgPSB0aWNrTm9kZXNbMF07CiAgICAgIGlmICh0aWNrKSB7CiAgICAgICAgdmFyIGNvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0aWNrKTsKICAgICAgICB2YXIgY2FsY3VsYXRlZEZvbnRTaXplID0gY29tcHV0ZWRTdHlsZS5mb250U2l6ZTsKICAgICAgICB2YXIgY2FsY3VsYXRlZExldHRlclNwYWNpbmcgPSBjb21wdXRlZFN0eWxlLmxldHRlclNwYWNpbmc7CiAgICAgICAgaWYgKGNhbGN1bGF0ZWRGb250U2l6ZSAhPT0gZm9udFNpemUgfHwgY2FsY3VsYXRlZExldHRlclNwYWNpbmcgIT09IGxldHRlclNwYWNpbmcpIHsKICAgICAgICAgIHNldEZvbnRTaXplKGNhbGN1bGF0ZWRGb250U2l6ZSk7CiAgICAgICAgICBzZXRMZXR0ZXJTcGFjaW5nKGNhbGN1bGF0ZWRMZXR0ZXJTcGFjaW5nKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCBbZm9udFNpemUsIGxldHRlclNwYWNpbmddKTsKICBpZiAoaGlkZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICh3aWR0aCAhPSBudWxsICYmIHdpZHRoIDw9IDAgfHwgaGVpZ2h0ICE9IG51bGwgJiYgaGVpZ2h0IDw9IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiBwcm9wcy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzIiwgY2xhc3NOYW1lKQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoQXhpc0xpbmUsIHsKICAgIHg6IHByb3BzLngsCiAgICB5OiBwcm9wcy55LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBtaXJyb3I6IHByb3BzLm1pcnJvciwKICAgIGF4aXNMaW5lLAogICAgb3RoZXJTdmdQcm9wczogc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KFRpY2tzLCB7CiAgICByZWY6IGxheWVyUmVmLAogICAgYXhpc1R5cGUsCiAgICBldmVudHM6IHJlc3QsCiAgICBmb250U2l6ZSwKICAgIGdldFRpY2tzQ29uZmlnOiBwcm9wcywKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgbGV0dGVyU3BhY2luZywKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgcGFkZGluZzogcHJvcHMucGFkZGluZywKICAgIHN0cm9rZTogcHJvcHMuc3Ryb2tlLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tGb3JtYXR0ZXI6IHByb3BzLnRpY2tGb3JtYXR0ZXIsCiAgICB0aWNrTGluZTogcHJvcHMudGlja0xpbmUsCiAgICB0aWNrTWFyZ2luOiBwcm9wcy50aWNrTWFyZ2luLAogICAgdGlja1NpemU6IHByb3BzLnRpY2tTaXplLAogICAgdGlja1RleHRQcm9wczogcHJvcHMudGlja1RleHRQcm9wcywKICAgIHRpY2tzOiB0aWNrczIsCiAgICB1bml0OiBwcm9wcy51bml0LAogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbENvbnRleHRQcm92aWRlciwgewogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnksCiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGxvd2VyV2lkdGg6IHByb3BzLndpZHRoLAogICAgdXBwZXJXaWR0aDogcHJvcHMud2lkdGgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsRnJvbUxhYmVsUHJvcCwgewogICAgbGFiZWw6IHByb3BzLmxhYmVsLAogICAgbGFiZWxSZWY6IHByb3BzLmxhYmVsUmVmCiAgfSksIHByb3BzLmNoaWxkcmVuKSkpOwp9KTsKdmFyIENhcnRlc2lhbkF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5mb3J3YXJkUmVmKChvdXRzaWRlUHJvcHMsIHJlZikgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzQ29tcG9uZW50LCBfZXh0ZW5kczE2KHt9LCBwcm9wcywgewogICAgcmVmCiAgfSkpOwp9KTsKQ2FydGVzaWFuQXhpcy5kaXNwbGF5TmFtZSA9ICJDYXJ0ZXNpYW5BeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0NhcnRlc2lhbkdyaWQuanMKdmFyIFJlYWN0MjYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQxMSA9IFsieDEiLCAieTEiLCAieDIiLCAieTIiLCAia2V5Il07CnZhciBfZXhjbHVkZWQyNSA9IFsib2Zmc2V0Il07CnZhciBfZXhjbHVkZWQzMiA9IFsieEF4aXNJZCIsICJ5QXhpc0lkIl07CnZhciBfZXhjbHVkZWQ0MiA9IFsieEF4aXNJZCIsICJ5QXhpc0lkIl07CmZ1bmN0aW9uIG93bktleXMzMShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMxKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzEoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMyKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMxKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE3KCkgewogIHJldHVybiBfZXh0ZW5kczE3ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTEocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBCYWNrZ3JvdW5kID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGZpbGwKICB9ID0gcHJvcHM7CiAgaWYgKCFmaWxsIHx8IGZpbGwgPT09ICJub25lIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJ5CiAgfSA9IHByb3BzOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHJ5LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHJva2U6ICJub25lIiwKICAgIGZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWJnIgogIH0pOwp9OwpmdW5jdGlvbiBMaW5lSXRlbShfcmVmMikgewogIHZhciB7CiAgICBvcHRpb24sCiAgICBsaW5lSXRlbVByb3BzCiAgfSA9IF9yZWYyOwogIHZhciBsaW5lSXRlbTsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjYuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgbGluZUl0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jbG9uZUVsZW1lbnQob3B0aW9uLCBsaW5lSXRlbVByb3BzKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIGxpbmVJdGVtID0gb3B0aW9uKGxpbmVJdGVtUHJvcHMpOwogIH0gZWxzZSB7CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNOb0V2ZW50OwogICAgdmFyIHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MiwKICAgICAgeTIsCiAgICAgIGtleQogICAgfSA9IGxpbmVJdGVtUHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGxpbmVJdGVtUHJvcHMsIF9leGNsdWRlZDExKTsKICAgIHZhciBfcmVmMjIgPSAoX3N2Z1Byb3BlcnRpZXNOb0V2ZW50ID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKG90aGVycykpICE9PSBudWxsICYmIF9zdmdQcm9wZXJ0aWVzTm9FdmVudCAhPT0gdm9pZCAwID8gX3N2Z1Byb3BlcnRpZXNOb0V2ZW50IDoge30sIHsKICAgICAgb2Zmc2V0OiBfXwogICAgfSA9IF9yZWYyMiwgcmVzdE9mRmlsdGVyZWRQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKF9yZWYyMiwgX2V4Y2x1ZGVkMjUpOwogICAgbGluZUl0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJsaW5lIiwgX2V4dGVuZHMxNyh7fSwgcmVzdE9mRmlsdGVyZWRQcm9wcywgewogICAgICB4MSwKICAgICAgeTEsCiAgICAgIHgyLAogICAgICB5MiwKICAgICAgZmlsbDogIm5vbmUiLAogICAgICBrZXkKICAgIH0pKTsKICB9CiAgcmV0dXJuIGxpbmVJdGVtOwp9CmZ1bmN0aW9uIEhvcml6b250YWxHcmlkTGluZXMocHJvcHMpIHsKICB2YXIgewogICAgeDogeDIsCiAgICB3aWR0aCwKICAgIGhvcml6b250YWwgPSB0cnVlLAogICAgaG9yaXpvbnRhbFBvaW50cwogIH0gPSBwcm9wczsKICBpZiAoIWhvcml6b250YWwgfHwgIWhvcml6b250YWxQb2ludHMgfHwgIWhvcml6b250YWxQb2ludHMubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSA9IHByb3BzLCBvdGhlckxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShwcm9wcywgX2V4Y2x1ZGVkMzIpOwogIHZhciBpdGVtcyA9IGhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0U3ByZWFkMzEoX29iamVjdFNwcmVhZDMxKHt9LCBvdGhlckxpbmVJdGVtUHJvcHMpLCB7fSwgewogICAgICB4MTogeDIsCiAgICAgIHkxOiBlbnRyeSwKICAgICAgeDI6IHgyICsgd2lkdGgsCiAgICAgIHkyOiBlbnRyeSwKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgaW5kZXg6IGkKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGluZUl0ZW0sIHsKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgb3B0aW9uOiBob3Jpem9udGFsLAogICAgICBsaW5lSXRlbVByb3BzCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsR3JpZExpbmVzKHByb3BzKSB7CiAgdmFyIHsKICAgIHk6IHkyLAogICAgaGVpZ2h0LAogICAgdmVydGljYWwgPSB0cnVlLAogICAgdmVydGljYWxQb2ludHMKICB9ID0gcHJvcHM7CiAgaWYgKCF2ZXJ0aWNhbCB8fCAhdmVydGljYWxQb2ludHMgfHwgIXZlcnRpY2FsUG9pbnRzLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0gPSBwcm9wcywgb3RoZXJMaW5lSXRlbVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEocHJvcHMsIF9leGNsdWRlZDQyKTsKICB2YXIgaXRlbXMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgbGluZUl0ZW1Qcm9wcyA9IF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIG90aGVyTGluZUl0ZW1Qcm9wcyksIHt9LCB7CiAgICAgIHgxOiBlbnRyeSwKICAgICAgeTE6IHkyLAogICAgICB4MjogZW50cnksCiAgICAgIHkyOiB5MiArIGhlaWdodCwKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgaW5kZXg6IGkKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGluZUl0ZW0sIHsKICAgICAgb3B0aW9uOiB2ZXJ0aWNhbCwKICAgICAgbGluZUl0ZW1Qcm9wcywKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKQogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC12ZXJ0aWNhbCIKICB9LCBpdGVtcyk7Cn0KZnVuY3Rpb24gSG9yaXpvbnRhbFN0cmlwZXMocHJvcHMpIHsKICB2YXIgewogICAgaG9yaXpvbnRhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGhvcml6b250YWxQb2ludHMsCiAgICBob3Jpem9udGFsID0gdHJ1ZQogIH0gPSBwcm9wczsKICBpZiAoIWhvcml6b250YWwgfHwgIWhvcml6b250YWxGaWxsIHx8ICFob3Jpem9udGFsRmlsbC5sZW5ndGggfHwgaG9yaXpvbnRhbFBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzID0gaG9yaXpvbnRhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHkyIC0geTIpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHkyICE9PSByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50c1swXSkgewogICAgcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMudW5zaGlmdCgwKTsKICB9CiAgdmFyIGl0ZW1zID0gcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHNbaSArIDFdOwogICAgdmFyIGxpbmVIZWlnaHQgPSBsYXN0U3RyaXBlID8geTIgKyBoZWlnaHQgLSBlbnRyeSA6IHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVIZWlnaHQgPD0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBjb2xvckluZGV4ID0gaSAlIGhvcml6b250YWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeTogZW50cnksCiAgICAgIHg6IHgyLAogICAgICBoZWlnaHQ6IGxpbmVIZWlnaHQsCiAgICAgIHdpZHRoLAogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgZmlsbDogaG9yaXpvbnRhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsU3RyaXBlcyhwcm9wcykgewogIHZhciB7CiAgICB2ZXJ0aWNhbCA9IHRydWUsCiAgICB2ZXJ0aWNhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzOwogIGlmICghdmVydGljYWwgfHwgIXZlcnRpY2FsRmlsbCB8fCAhdmVydGljYWxGaWxsLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHgyIC0geDIpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHgyICE9PSByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHNbMF0pIHsKICAgIHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50cy51bnNoaWZ0KDApOwogIH0KICB2YXIgaXRlbXMgPSByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzW2kgKyAxXTsKICAgIHZhciBsaW5lV2lkdGggPSBsYXN0U3RyaXBlID8geDIgKyB3aWR0aCAtIGVudHJ5IDogcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVXaWR0aCA8PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIGNvbG9ySW5kZXggPSBpICUgdmVydGljYWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeDogZW50cnksCiAgICAgIHk6IHkyLAogICAgICB3aWR0aDogbGluZVdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIHN0cm9rZTogIm5vbmUiLAogICAgICBmaWxsOiB2ZXJ0aWNhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLXZlcnRpY2FsIgogIH0sIGl0ZW1zKTsKfQp2YXIgZGVmYXVsdFZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPSAoX3JlZjMsIHN5bmNXaXRoVGlja3MpID0+IHsKICB2YXIgewogICAgeEF4aXMsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9mZnNldAogIH0gPSBfcmVmMzsKICByZXR1cm4gZ2V0Q29vcmRpbmF0ZXNPZkdyaWQoZ2V0VGlja3MoX29iamVjdFNwcmVhZDMxKF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMpLCB4QXhpcyksIHt9LCB7CiAgICB0aWNrczogZ2V0VGlja3NPZkF4aXMoeEF4aXMsIHRydWUpLAogICAgdmlld0JveDogewogICAgICB4OiAwLAogICAgICB5OiAwLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9CiAgfSkpLCBvZmZzZXQubGVmdCwgb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGgsIHN5bmNXaXRoVGlja3MpOwp9Owp2YXIgZGVmYXVsdEhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciA9IChfcmVmNCwgc3luY1dpdGhUaWNrcykgPT4gewogIHZhciB7CiAgICB5QXhpcywKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb2Zmc2V0CiAgfSA9IF9yZWY0OwogIHJldHVybiBnZXRDb29yZGluYXRlc09mR3JpZChnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMzEoX29iamVjdFNwcmVhZDMxKF9vYmplY3RTcHJlYWQzMSh7fSwgZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcyksIHlBeGlzKSwge30sIHsKICAgIHRpY2tzOiBnZXRUaWNrc09mQXhpcyh5QXhpcywgdHJ1ZSksCiAgICB2aWV3Qm94OiB7CiAgICAgIHg6IDAsCiAgICAgIHk6IDAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0KICB9KSksIG9mZnNldC50b3AsIG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0LCBzeW5jV2l0aFRpY2tzKTsKfTsKdmFyIGRlZmF1bHRDYXJ0ZXNpYW5HcmlkUHJvcHMgPSB7CiAgaG9yaXpvbnRhbDogdHJ1ZSwKICB2ZXJ0aWNhbDogdHJ1ZSwKICAvLyBUaGUgb3JkaW5hdGVzIG9mIGhvcml6b250YWwgZ3JpZCBsaW5lcwogIGhvcml6b250YWxQb2ludHM6IFtdLAogIC8vIFRoZSBhYnNjaXNzYXMgb2YgdmVydGljYWwgZ3JpZCBsaW5lcwogIHZlcnRpY2FsUG9pbnRzOiBbXSwKICBzdHJva2U6ICIjY2NjIiwKICBmaWxsOiAibm9uZSIsCiAgLy8gVGhlIGZpbGwgb2YgY29sb3JzIG9mIGdyaWQgbGluZXMKICB2ZXJ0aWNhbEZpbGw6IFtdLAogIGhvcml6b250YWxGaWxsOiBbXSwKICB4QXhpc0lkOiAwLAogIHlBeGlzSWQ6IDAsCiAgc3luY1dpdGhUaWNrczogZmFsc2UsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuZ3JpZAp9OwpmdW5jdGlvbiBDYXJ0ZXNpYW5HcmlkKHByb3BzKSB7CiAgdmFyIGNoYXJ0V2lkdGggPSB1c2VDaGFydFdpZHRoKCk7CiAgdmFyIGNoYXJ0SGVpZ2h0ID0gdXNlQ2hhcnRIZWlnaHQoKTsKICB2YXIgb2Zmc2V0ID0gdXNlT2Zmc2V0SW50ZXJuYWwoKTsKICB2YXIgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cyA9IF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIHJlc29sdmVEZWZhdWx0UHJvcHMocHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5HcmlkUHJvcHMpKSwge30sIHsKICAgIHg6IGlzTnVtYmVyKHByb3BzLngpID8gcHJvcHMueCA6IG9mZnNldC5sZWZ0LAogICAgeTogaXNOdW1iZXIocHJvcHMueSkgPyBwcm9wcy55IDogb2Zmc2V0LnRvcCwKICAgIHdpZHRoOiBpc051bWJlcihwcm9wcy53aWR0aCkgPyBwcm9wcy53aWR0aCA6IG9mZnNldC53aWR0aCwKICAgIGhlaWdodDogaXNOdW1iZXIocHJvcHMuaGVpZ2h0KSA/IHByb3BzLmhlaWdodCA6IG9mZnNldC5oZWlnaHQKICB9KTsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQsCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzeW5jV2l0aFRpY2tzLAogICAgaG9yaXpvbnRhbFZhbHVlcywKICAgIHZlcnRpY2FsVmFsdWVzCiAgfSA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHM7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHhBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzUHJvcHNOZWVkZWRGb3JDYXJ0ZXNpYW5HcmlkVGlja3NHZW5lcmF0b3Ioc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgeUF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNQcm9wc05lZWRlZEZvckNhcnRlc2lhbkdyaWRUaWNrc0dlbmVyYXRvcihzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIGlmICghaXNQb3NpdGl2ZU51bWJlcih3aWR0aCkgfHwgIWlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSB8fCAhaXNOdW1iZXIoeDIpIHx8ICFpc051bWJlcih5MikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMudmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciB8fCBkZWZhdWx0VmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvcjsKICB2YXIgaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5ob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgfHwgZGVmYXVsdEhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvcjsKICB2YXIgewogICAgaG9yaXpvbnRhbFBvaW50cywKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHM7CiAgaWYgKCghaG9yaXpvbnRhbFBvaW50cyB8fCAhaG9yaXpvbnRhbFBvaW50cy5sZW5ndGgpICYmIHR5cGVvZiBob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgIHZhciBpc0hvcml6b250YWxWYWx1ZXMgPSBob3Jpem9udGFsVmFsdWVzICYmIGhvcml6b250YWxWYWx1ZXMubGVuZ3RoOwogICAgdmFyIGdlbmVyYXRvclJlc3VsdCA9IGhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvcih7CiAgICAgIHlBeGlzOiB5QXhpcyA/IF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIHlBeGlzKSwge30sIHsKICAgICAgICB0aWNrczogaXNIb3Jpem9udGFsVmFsdWVzID8gaG9yaXpvbnRhbFZhbHVlcyA6IHlBeGlzLnRpY2tzCiAgICAgIH0pIDogdm9pZCAwLAogICAgICB3aWR0aDogY2hhcnRXaWR0aCAhPT0gbnVsbCAmJiBjaGFydFdpZHRoICE9PSB2b2lkIDAgPyBjaGFydFdpZHRoIDogd2lkdGgsCiAgICAgIGhlaWdodDogY2hhcnRIZWlnaHQgIT09IG51bGwgJiYgY2hhcnRIZWlnaHQgIT09IHZvaWQgMCA/IGNoYXJ0SGVpZ2h0IDogaGVpZ2h0LAogICAgICBvZmZzZXQKICAgIH0sIGlzSG9yaXpvbnRhbFZhbHVlcyA/IHRydWUgOiBzeW5jV2l0aFRpY2tzKTsKICAgIHdhcm4oQXJyYXkuaXNBcnJheShnZW5lcmF0b3JSZXN1bHQpLCAiaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHNob3VsZCByZXR1cm4gQXJyYXkgYnV0IGluc3RlYWQgaXQgcmV0dXJuZWQgWyIuY29uY2F0KHR5cGVvZiBnZW5lcmF0b3JSZXN1bHQsICJdIikpOwogICAgaWYgKEFycmF5LmlzQXJyYXkoZ2VuZXJhdG9yUmVzdWx0KSkgewogICAgICBob3Jpem9udGFsUG9pbnRzID0gZ2VuZXJhdG9yUmVzdWx0OwogICAgfQogIH0KICBpZiAoKCF2ZXJ0aWNhbFBvaW50cyB8fCAhdmVydGljYWxQb2ludHMubGVuZ3RoKSAmJiB0eXBlb2YgdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgdmFyIGlzVmVydGljYWxWYWx1ZXMgPSB2ZXJ0aWNhbFZhbHVlcyAmJiB2ZXJ0aWNhbFZhbHVlcy5sZW5ndGg7CiAgICB2YXIgX2dlbmVyYXRvclJlc3VsdCA9IHZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IoewogICAgICB4QXhpczogeEF4aXMgPyBfb2JqZWN0U3ByZWFkMzEoX29iamVjdFNwcmVhZDMxKHt9LCB4QXhpcyksIHt9LCB7CiAgICAgICAgdGlja3M6IGlzVmVydGljYWxWYWx1ZXMgPyB2ZXJ0aWNhbFZhbHVlcyA6IHhBeGlzLnRpY2tzCiAgICAgIH0pIDogdm9pZCAwLAogICAgICB3aWR0aDogY2hhcnRXaWR0aCAhPT0gbnVsbCAmJiBjaGFydFdpZHRoICE9PSB2b2lkIDAgPyBjaGFydFdpZHRoIDogd2lkdGgsCiAgICAgIGhlaWdodDogY2hhcnRIZWlnaHQgIT09IG51bGwgJiYgY2hhcnRIZWlnaHQgIT09IHZvaWQgMCA/IGNoYXJ0SGVpZ2h0IDogaGVpZ2h0LAogICAgICBvZmZzZXQKICAgIH0sIGlzVmVydGljYWxWYWx1ZXMgPyB0cnVlIDogc3luY1dpdGhUaWNrcyk7CiAgICB3YXJuKEFycmF5LmlzQXJyYXkoX2dlbmVyYXRvclJlc3VsdCksICJ2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHNob3VsZCByZXR1cm4gQXJyYXkgYnV0IGluc3RlYWQgaXQgcmV0dXJuZWQgWyIuY29uY2F0KHR5cGVvZiBfZ2VuZXJhdG9yUmVzdWx0LCAiXSIpKTsKICAgIGlmIChBcnJheS5pc0FycmF5KF9nZW5lcmF0b3JSZXN1bHQpKSB7CiAgICAgIHZlcnRpY2FsUG9pbnRzID0gX2dlbmVyYXRvclJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQiCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChCYWNrZ3JvdW5kLCB7CiAgICBmaWxsOiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmZpbGwsCiAgICBmaWxsT3BhY2l0eTogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5maWxsT3BhY2l0eSwKICAgIHg6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMueCwKICAgIHk6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMueSwKICAgIHdpZHRoOiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLndpZHRoLAogICAgaGVpZ2h0OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmhlaWdodCwKICAgIHJ5OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLnJ5CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoSG9yaXpvbnRhbFN0cmlwZXMsIF9leHRlbmRzMTcoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIGhvcml6b250YWxQb2ludHMKICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoVmVydGljYWxTdHJpcGVzLCBfZXh0ZW5kczE3KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICB2ZXJ0aWNhbFBvaW50cwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChIb3Jpem9udGFsR3JpZExpbmVzLCBfZXh0ZW5kczE3KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICBvZmZzZXQsCiAgICBob3Jpem9udGFsUG9pbnRzLAogICAgeEF4aXMsCiAgICB5QXhpcwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChWZXJ0aWNhbEdyaWRMaW5lcywgX2V4dGVuZHMxNyh7fSwgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cywgewogICAgb2Zmc2V0LAogICAgdmVydGljYWxQb2ludHMsCiAgICB4QXhpcywKICAgIHlBeGlzCiAgfSkpKSk7Cn0KQ2FydGVzaWFuR3JpZC5kaXNwbGF5TmFtZSA9ICJDYXJ0ZXNpYW5HcmlkIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRSYWRpdXNBbmRTdHJva2VXaWR0aEZyb21Eb3QuanMKZnVuY3Rpb24gZ2V0UmFkaXVzQW5kU3Ryb2tlV2lkdGhGcm9tRG90KGRvdCkgewogIHZhciBwcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKGRvdCk7CiAgdmFyIGRlZmF1bHRSID0gMzsKICB2YXIgZGVmYXVsdFN0cm9rZVdpZHRoID0gMjsKICBpZiAocHJvcHMgIT0gbnVsbCkgewogICAgdmFyIHsKICAgICAgcjogcjIsCiAgICAgIHN0cm9rZVdpZHRoCiAgICB9ID0gcHJvcHM7CiAgICB2YXIgcmVhbFIgPSBOdW1iZXIocjIpOwogICAgdmFyIHJlYWxTdHJva2VXaWR0aCA9IE51bWJlcihzdHJva2VXaWR0aCk7CiAgICBpZiAoTnVtYmVyLmlzTmFOKHJlYWxSKSB8fCByZWFsUiA8IDApIHsKICAgICAgcmVhbFIgPSBkZWZhdWx0UjsKICAgIH0KICAgIGlmIChOdW1iZXIuaXNOYU4ocmVhbFN0cm9rZVdpZHRoKSB8fCByZWFsU3Ryb2tlV2lkdGggPCAwKSB7CiAgICAgIHJlYWxTdHJva2VXaWR0aCA9IGRlZmF1bHRTdHJva2VXaWR0aDsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHI6IHJlYWxSLAogICAgICBzdHJva2VXaWR0aDogcmVhbFN0cm9rZVdpZHRoCiAgICB9OwogIH0KICByZXR1cm4gewogICAgcjogZGVmYXVsdFIsCiAgICBzdHJva2VXaWR0aDogZGVmYXVsdFN0cm9rZVdpZHRoCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQXJlYS5qcwp2YXIgUmVhY3QyNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXJlYVNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0WEF4aXNXaXRoU2NhbGUgPSAoc3RhdGUsIHhBeGlzSWQsIF95QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RBeGlzV2l0aFNjYWxlKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdFhBeGlzVGlja3MgPSAoc3RhdGUsIHhBeGlzSWQsIF95QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RUaWNrc09mR3JhcGhpY2FsSXRlbShzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSk7CnZhciBzZWxlY3RZQXhpc1dpdGhTY2FsZSA9IChzdGF0ZSwgX3hBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdEF4aXNXaXRoU2NhbGUoc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0WUF4aXNUaWNrcyA9IChzdGF0ZSwgX3hBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdEJhbmRTaXplID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RYQXhpc1dpdGhTY2FsZSwgc2VsZWN0WUF4aXNXaXRoU2NhbGUsIHNlbGVjdFhBeGlzVGlja3MsIHNlbGVjdFlBeGlzVGlja3NdLCAobGF5b3V0LCB4QXhpcywgeUF4aXMsIHhBeGlzVGlja3MsIHlBeGlzVGlja3MpID0+IHsKICBpZiAoaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCAieEF4aXMiKSkgewogICAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHhBeGlzLCB4QXhpc1RpY2tzLCBmYWxzZSk7CiAgfQogIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyh5QXhpcywgeUF4aXNUaWNrcywgZmFsc2UpOwp9KTsKdmFyIHBpY2tBcmVhSWQgPSAoX3N0YXRlLCBfeEF4aXNJZCwgX3lBeGlzSWQsIF9pc1Bhbm9yYW1hLCBpZCkgPT4gaWQ7CnZhciBzZWxlY3RTeW5jaHJvbmlzZWRBcmVhU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VW5maWx0ZXJlZENhcnRlc2lhbkl0ZW1zLCBwaWNrQXJlYUlkXSwgKGdyYXBoaWNhbEl0ZW1zLCBpZCkgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJhcmVhIikuZmluZCgoaXRlbSkgPT4gaXRlbS5pZCA9PT0gaWQpKTsKdmFyIHNlbGVjdEdyYXBoaWNhbEl0ZW1TdGFja2VkRGF0YSA9IChzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgaWQpID0+IHsKICB2YXIgX3N0YWNrR3JvdXBzJHN0YWNrSWQ7CiAgdmFyIGFyZWFTZXR0aW5ncyA9IHNlbGVjdFN5bmNocm9uaXNlZEFyZWFTZXR0aW5ncyhzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgaWQpOwogIGlmIChhcmVhU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGxheW91dCA9IHNlbGVjdENoYXJ0TGF5b3V0KHN0YXRlKTsKICB2YXIgaXNYQXhpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCAieEF4aXMiKTsKICB2YXIgc3RhY2tHcm91cHM7CiAgaWYgKGlzWEF4aXNDYXRlZ29yaWNhbCkgewogICAgc3RhY2tHcm91cHMgPSBzZWxlY3RTdGFja0dyb3VwcyhzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgfSBlbHNlIHsKICAgIHN0YWNrR3JvdXBzID0gc2VsZWN0U3RhY2tHcm91cHMoc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpOwogIH0KICBpZiAoc3RhY2tHcm91cHMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHN0YWNrSWQKICB9ID0gYXJlYVNldHRpbmdzOwogIHZhciBzdGFja1Nlcmllc0lkZW50aWZpZXIgPSBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoYXJlYVNldHRpbmdzKTsKICBpZiAoc3RhY2tJZCA9PSBudWxsIHx8IHN0YWNrU2VyaWVzSWRlbnRpZmllciA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZ3JvdXBzID0gKF9zdGFja0dyb3VwcyRzdGFja0lkID0gc3RhY2tHcm91cHNbc3RhY2tJZF0pID09PSBudWxsIHx8IF9zdGFja0dyb3VwcyRzdGFja0lkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfc3RhY2tHcm91cHMkc3RhY2tJZC5zdGFja2VkRGF0YTsKICByZXR1cm4gZ3JvdXBzID09PSBudWxsIHx8IGdyb3VwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZ3JvdXBzLmZpbmQoKHYpID0+IHYua2V5ID09PSBzdGFja1Nlcmllc0lkZW50aWZpZXIpOwp9Owp2YXIgc2VsZWN0QXJlYSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0WEF4aXNXaXRoU2NhbGUsIHNlbGVjdFlBeGlzV2l0aFNjYWxlLCBzZWxlY3RYQXhpc1RpY2tzLCBzZWxlY3RZQXhpc1RpY2tzLCBzZWxlY3RHcmFwaGljYWxJdGVtU3RhY2tlZERhdGEsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hLCBzZWxlY3RCYW5kU2l6ZSwgc2VsZWN0U3luY2hyb25pc2VkQXJlYVNldHRpbmdzLCBzZWxlY3RDaGFydEJhc2VWYWx1ZV0sIChsYXlvdXQsIHhBeGlzLCB5QXhpcywgeEF4aXNUaWNrcywgeUF4aXNUaWNrcywgc3RhY2tlZERhdGEsIF9yZWYyLCBiYW5kU2l6ZSwgYXJlYVNldHRpbmdzLCBjaGFydEJhc2VWYWx1ZSkgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBfcmVmMjsKICBpZiAoYXJlYVNldHRpbmdzID09IG51bGwgfHwgbGF5b3V0ICE9PSAiaG9yaXpvbnRhbCIgJiYgbGF5b3V0ICE9PSAidmVydGljYWwiIHx8IHhBeGlzID09IG51bGwgfHwgeUF4aXMgPT0gbnVsbCB8fCB4QXhpc1RpY2tzID09IG51bGwgfHwgeUF4aXNUaWNrcyA9PSBudWxsIHx8IHhBeGlzVGlja3MubGVuZ3RoID09PSAwIHx8IHlBeGlzVGlja3MubGVuZ3RoID09PSAwIHx8IGJhbmRTaXplID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBkYXRhCiAgfSA9IGFyZWFTZXR0aW5nczsKICB2YXIgZGlzcGxheWVkRGF0YTsKICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCA+IDApIHsKICAgIGRpc3BsYXllZERhdGEgPSBkYXRhOwogIH0gZWxzZSB7CiAgICBkaXNwbGF5ZWREYXRhID0gY2hhcnREYXRhID09PSBudWxsIHx8IGNoYXJ0RGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2hhcnREYXRhLnNsaWNlKGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXggKyAxKTsKICB9CiAgaWYgKGRpc3BsYXllZERhdGEgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGNvbXB1dGVBcmVhKHsKICAgIGxheW91dCwKICAgIHhBeGlzLAogICAgeUF4aXMsCiAgICB4QXhpc1RpY2tzLAogICAgeUF4aXNUaWNrcywKICAgIGRhdGFTdGFydEluZGV4LAogICAgYXJlYVNldHRpbmdzLAogICAgc3RhY2tlZERhdGEsCiAgICBkaXNwbGF5ZWREYXRhLAogICAgY2hhcnRCYXNlVmFsdWUsCiAgICBiYW5kU2l6ZQogIH0pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0FyZWEuanMKdmFyIF9leGNsdWRlZDEyID0gWyJpZCJdOwp2YXIgX2V4Y2x1ZGVkMjYgPSBbImFjdGl2ZURvdCIsICJhbmltYXRpb25CZWdpbiIsICJhbmltYXRpb25EdXJhdGlvbiIsICJhbmltYXRpb25FYXNpbmciLCAiY29ubmVjdE51bGxzIiwgImRvdCIsICJmaWxsIiwgImZpbGxPcGFjaXR5IiwgImhpZGUiLCAiaXNBbmltYXRpb25BY3RpdmUiLCAibGVnZW5kVHlwZSIsICJzdHJva2UiLCAieEF4aXNJZCIsICJ5QXhpc0lkIl07CmZ1bmN0aW9uIF9leHRlbmRzMTgoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTggPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE4LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTIoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEyKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gb3duS2V5czMyKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMzIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMzMihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMzIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGdldExlZ2VuZEl0ZW1Db2xvcihzdHJva2UsIGZpbGwpIHsKICByZXR1cm4gc3Ryb2tlICYmIHN0cm9rZSAhPT0gIm5vbmUiID8gc3Ryb2tlIDogZmlsbDsKfQp2YXIgY29tcHV0ZUxlZ2VuZFBheWxvYWRGcm9tQXJlYURhdGEgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgZGF0YUtleSwKICAgIG5hbWUsCiAgICBzdHJva2UsCiAgICBmaWxsLAogICAgbGVnZW5kVHlwZSwKICAgIGhpZGUKICB9ID0gcHJvcHM7CiAgcmV0dXJuIFt7CiAgICBpbmFjdGl2ZTogaGlkZSwKICAgIGRhdGFLZXksCiAgICB0eXBlOiBsZWdlbmRUeXBlLAogICAgY29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcihzdHJva2UsIGZpbGwpLAogICAgdmFsdWU6IGdldFRvb2x0aXBOYW1lUHJvcChuYW1lLCBkYXRhS2V5KSwKICAgIHBheWxvYWQ6IHByb3BzCiAgfV07Cn07CnZhciBTZXRBcmVhVG9vbHRpcEVudHJ5U2V0dGluZ3MgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5tZW1vKChfcmVmMikgPT4gewogIHZhciB7CiAgICBkYXRhS2V5LAogICAgZGF0YSwKICAgIHN0cm9rZSwKICAgIHN0cm9rZVdpZHRoLAogICAgZmlsbCwKICAgIG5hbWUsCiAgICBoaWRlLAogICAgdW5pdDogdW5pdDIsCiAgICB0b29sdGlwVHlwZQogIH0gPSBfcmVmMjsKICB2YXIgdG9vbHRpcEVudHJ5U2V0dGluZ3MgPSB7CiAgICBkYXRhRGVmaW5lZE9uSXRlbTogZGF0YSwKICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgc2V0dGluZ3M6IHsKICAgICAgc3Ryb2tlLAogICAgICBzdHJva2VXaWR0aCwKICAgICAgZmlsbCwKICAgICAgZGF0YUtleSwKICAgICAgbmFtZUtleTogdm9pZCAwLAogICAgICBuYW1lOiBnZXRUb29sdGlwTmFtZVByb3AobmFtZSwgZGF0YUtleSksCiAgICAgIGhpZGUsCiAgICAgIHR5cGU6IHRvb2x0aXBUeXBlLAogICAgICBjb2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHN0cm9rZSwgZmlsbCksCiAgICAgIHVuaXQ6IHVuaXQyCiAgICB9CiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChTZXRUb29sdGlwRW50cnlTZXR0aW5ncywgewogICAgdG9vbHRpcEVudHJ5U2V0dGluZ3MKICB9KTsKfSk7CmZ1bmN0aW9uIEFyZWFEb3RzV3JhcHBlcihfcmVmMikgewogIHZhciB7CiAgICBjbGlwUGF0aElkLAogICAgcG9pbnRzLAogICAgcHJvcHMKICB9ID0gX3JlZjI7CiAgdmFyIHsKICAgIG5lZWRDbGlwLAogICAgZG90LAogICAgZGF0YUtleQogIH0gPSBwcm9wczsKICB2YXIgYXJlYVByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChEb3RzLCB7CiAgICBwb2ludHMsCiAgICBkb3QsCiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWRvdHMiLAogICAgZG90Q2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1kb3QiLAogICAgZGF0YUtleSwKICAgIGJhc2VQcm9wczogYXJlYVByb3BzLAogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkCiAgfSk7Cn0KZnVuY3Rpb24gQXJlYUxhYmVsTGlzdFByb3ZpZGVyKF9yZWYzKSB7CiAgdmFyIHsKICAgIHNob3dMYWJlbHMsCiAgICBjaGlsZHJlbiwKICAgIHBvaW50cwogIH0gPSBfcmVmMzsKICB2YXIgbGFiZWxMaXN0RW50cmllcyA9IHBvaW50cy5tYXAoKHBvaW50NCkgPT4gewogICAgdmFyIF9wb2ludCR4LCBfcG9pbnQkeTsKICAgIHZhciB2aWV3Qm94ID0gewogICAgICB4OiAoX3BvaW50JHggPSBwb2ludDQueCkgIT09IG51bGwgJiYgX3BvaW50JHggIT09IHZvaWQgMCA/IF9wb2ludCR4IDogMCwKICAgICAgeTogKF9wb2ludCR5ID0gcG9pbnQ0LnkpICE9PSBudWxsICYmIF9wb2ludCR5ICE9PSB2b2lkIDAgPyBfcG9pbnQkeSA6IDAsCiAgICAgIHdpZHRoOiAwLAogICAgICBsb3dlcldpZHRoOiAwLAogICAgICB1cHBlcldpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDMyKF9vYmplY3RTcHJlYWQzMih7fSwgdmlld0JveCksIHt9LCB7CiAgICAgIHZhbHVlOiBwb2ludDQudmFsdWUsCiAgICAgIHBheWxvYWQ6IHBvaW50NC5wYXlsb2FkLAogICAgICBwYXJlbnRWaWV3Qm94OiB2b2lkIDAsCiAgICAgIHZpZXdCb3gsCiAgICAgIGZpbGw6IHZvaWQgMAogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyLCB7CiAgICB2YWx1ZTogc2hvd0xhYmVscyA/IGxhYmVsTGlzdEVudHJpZXMgOiB2b2lkIDAKICB9LCBjaGlsZHJlbik7Cn0KZnVuY3Rpb24gU3RhdGljQXJlYShfcmVmNCkgewogIHZhciB7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzCiAgfSA9IF9yZWY0OwogIHZhciB7CiAgICBsYXlvdXQsCiAgICB0eXBlLAogICAgc3Ryb2tlLAogICAgY29ubmVjdE51bGxzLAogICAgaXNSYW5nZQogIH0gPSBwcm9wczsKICB2YXIgewogICAgaWQKICB9ID0gcHJvcHMsIHByb3BzV2l0aG91dElkID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTIocHJvcHMsIF9leGNsdWRlZDEyKTsKICB2YXIgYWxsT3RoZXJQcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wc1dpdGhvdXRJZCk7CiAgdmFyIHByb3BzV2l0aEV2ZW50cyA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHNXaXRob3V0SWQpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFJlYWN0MjcuRnJhZ21lbnQsIG51bGwsIChwb2ludHMgPT09IG51bGwgfHwgcG9pbnRzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwb2ludHMubGVuZ3RoKSA+IDEgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgY2xpcFBhdGg6IG5lZWRDbGlwID8gInVybCgjY2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCwgIikiKSA6IHZvaWQgMAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQ3VydmUsIF9leHRlbmRzMTgoe30sIHByb3BzV2l0aEV2ZW50cywgewogICAgaWQsCiAgICBwb2ludHMsCiAgICBjb25uZWN0TnVsbHMsCiAgICB0eXBlLAogICAgYmFzZUxpbmUsCiAgICBsYXlvdXQsCiAgICBzdHJva2U6ICJub25lIiwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtYXJlYSIKICB9KSksIHN0cm9rZSAhPT0gIm5vbmUiICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQ3VydmUsIF9leHRlbmRzMTgoe30sIGFsbE90aGVyUHJvcHMsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtY3VydmUiLAogICAgbGF5b3V0LAogICAgdHlwZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGZpbGw6ICJub25lIiwKICAgIHBvaW50cwogIH0pKSwgc3Ryb2tlICE9PSAibm9uZSIgJiYgaXNSYW5nZSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEN1cnZlLCBfZXh0ZW5kczE4KHt9LCBhbGxPdGhlclByb3BzLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWN1cnZlIiwKICAgIGxheW91dCwKICAgIHR5cGUsCiAgICBjb25uZWN0TnVsbHMsCiAgICBmaWxsOiAibm9uZSIsCiAgICBwb2ludHM6IGJhc2VMaW5lCiAgfSkpKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChBcmVhRG90c1dyYXBwZXIsIHsKICAgIHBvaW50cywKICAgIHByb3BzOiBwcm9wc1dpdGhvdXRJZCwKICAgIGNsaXBQYXRoSWQKICB9KSk7Cn0KZnVuY3Rpb24gVmVydGljYWxSZWN0KF9yZWY1KSB7CiAgdmFyIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBiYXNlTGluZSwKICAgIHBvaW50cywKICAgIHN0cm9rZVdpZHRoCiAgfSA9IF9yZWY1OwogIHZhciBzdGFydFkgPSBwb2ludHNbMF0ueTsKICB2YXIgZW5kWSA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0ueTsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoc3RhcnRZKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcihlbmRZKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBoZWlnaHQgPSBhbHBoYTIgKiBNYXRoLmFicyhzdGFydFkgLSBlbmRZKTsKICB2YXIgbWF4WCA9IE1hdGgubWF4KC4uLnBvaW50cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS54IHx8IDApKTsKICBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBtYXhYID0gTWF0aC5tYXgoYmFzZUxpbmUsIG1heFgpOwogIH0gZWxzZSBpZiAoYmFzZUxpbmUgJiYgQXJyYXkuaXNBcnJheShiYXNlTGluZSkgJiYgYmFzZUxpbmUubGVuZ3RoKSB7CiAgICBtYXhYID0gTWF0aC5tYXgoLi4uYmFzZUxpbmUubWFwKChlbnRyeSkgPT4gZW50cnkueCB8fCAwKSwgbWF4WCk7CiAgfQogIGlmIChpc051bWJlcihtYXhYKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIHg6IDAsCiAgICAgIHk6IHN0YXJ0WSA8IGVuZFkgPyBzdGFydFkgOiBzdGFydFkgLSBoZWlnaHQsCiAgICAgIHdpZHRoOiBtYXhYICsgKHN0cm9rZVdpZHRoID8gcGFyc2VJbnQoIiIuY29uY2F0KHN0cm9rZVdpZHRoKSwgMTApIDogMSksCiAgICAgIGhlaWdodDogTWF0aC5mbG9vcihoZWlnaHQpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gSG9yaXpvbnRhbFJlY3QoX3JlZjYpIHsKICB2YXIgewogICAgYWxwaGE6IGFscGhhMiwKICAgIGJhc2VMaW5lLAogICAgcG9pbnRzLAogICAgc3Ryb2tlV2lkdGgKICB9ID0gX3JlZjY7CiAgdmFyIHN0YXJ0WCA9IHBvaW50c1swXS54OwogIHZhciBlbmRYID0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXS54OwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihzdGFydFgpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGVuZFgpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHdpZHRoID0gYWxwaGEyICogTWF0aC5hYnMoc3RhcnRYIC0gZW5kWCk7CiAgdmFyIG1heFkgPSBNYXRoLm1heCguLi5wb2ludHMubWFwKChlbnRyeSkgPT4gZW50cnkueSB8fCAwKSk7CiAgaWYgKGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgbWF4WSA9IE1hdGgubWF4KGJhc2VMaW5lLCBtYXhZKTsKICB9IGVsc2UgaWYgKGJhc2VMaW5lICYmIEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpICYmIGJhc2VMaW5lLmxlbmd0aCkgewogICAgbWF4WSA9IE1hdGgubWF4KC4uLmJhc2VMaW5lLm1hcCgoZW50cnkpID0+IGVudHJ5LnkgfHwgMCksIG1heFkpOwogIH0KICBpZiAoaXNOdW1iZXIobWF4WSkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICB4OiBzdGFydFggPCBlbmRYID8gc3RhcnRYIDogc3RhcnRYIC0gd2lkdGgsCiAgICAgIHk6IDAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQ6IE1hdGguZmxvb3IobWF4WSArIChzdHJva2VXaWR0aCA/IHBhcnNlSW50KCIiLmNvbmNhdChzdHJva2VXaWR0aCksIDEwKSA6IDEpKQogICAgfSk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIENsaXBSZWN0KF9yZWY3KSB7CiAgdmFyIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBsYXlvdXQsCiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIHN0cm9rZVdpZHRoCiAgfSA9IF9yZWY3OwogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFZlcnRpY2FsUmVjdCwgewogICAgICBhbHBoYTogYWxwaGEyLAogICAgICBwb2ludHMsCiAgICAgIGJhc2VMaW5lLAogICAgICBzdHJva2VXaWR0aAogICAgfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEhvcml6b250YWxSZWN0LCB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBzdHJva2VXaWR0aAogIH0pOwp9CmZ1bmN0aW9uIEFyZWFXaXRoQW5pbWF0aW9uKF9yZWY4KSB7CiAgdmFyIHsKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzLAogICAgcHJldmlvdXNQb2ludHNSZWYsCiAgICBwcmV2aW91c0Jhc2VsaW5lUmVmCiAgfSA9IF9yZWY4OwogIHZhciB7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIG9uQW5pbWF0aW9uU3RhcnQsCiAgICBvbkFuaW1hdGlvbkVuZAogIH0gPSBwcm9wczsKICB2YXIgYW5pbWF0aW9uSW5wdXQgPSAoMCwgaW1wb3J0X3JlYWN0MzkudXNlTWVtbykoKCkgPT4gKHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lCiAgfSksIFtwb2ludHMsIGJhc2VMaW5lXSk7CiAgdmFyIGFuaW1hdGlvbklkID0gdXNlQW5pbWF0aW9uSWQoYW5pbWF0aW9uSW5wdXQsICJyZWNoYXJ0cy1hcmVhLSIpOwogIHZhciBsYXlvdXQgPSB1c2VDYXJ0ZXNpYW5DaGFydExheW91dCgpOwogIHZhciBbaXNBbmltYXRpbmcsIHNldElzQW5pbWF0aW5nXSA9ICgwLCBpbXBvcnRfcmVhY3QzOS51c2VTdGF0ZSkoZmFsc2UpOwogIHZhciBzaG93TGFiZWxzID0gIWlzQW5pbWF0aW5nOwogIHZhciBoYW5kbGVBbmltYXRpb25FbmQgPSAoMCwgaW1wb3J0X3JlYWN0MzkudXNlQ2FsbGJhY2spKCgpID0+IHsKICAgIGlmICh0eXBlb2Ygb25BbmltYXRpb25FbmQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgb25BbmltYXRpb25FbmQoKTsKICAgIH0KICAgIHNldElzQW5pbWF0aW5nKGZhbHNlKTsKICB9LCBbb25BbmltYXRpb25FbmRdKTsKICB2YXIgaGFuZGxlQW5pbWF0aW9uU3RhcnQgPSAoMCwgaW1wb3J0X3JlYWN0MzkudXNlQ2FsbGJhY2spKCgpID0+IHsKICAgIGlmICh0eXBlb2Ygb25BbmltYXRpb25TdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICBvbkFuaW1hdGlvblN0YXJ0KCk7CiAgICB9CiAgICBzZXRJc0FuaW1hdGluZyh0cnVlKTsKICB9LCBbb25BbmltYXRpb25TdGFydF0pOwogIGlmIChsYXlvdXQgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBwcmV2UG9pbnRzID0gcHJldmlvdXNQb2ludHNSZWYuY3VycmVudDsKICB2YXIgcHJldkJhc2VMaW5lID0gcHJldmlvdXNCYXNlbGluZVJlZi5jdXJyZW50OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEFyZWFMYWJlbExpc3RQcm92aWRlciwgewogICAgc2hvd0xhYmVscywKICAgIHBvaW50cwogIH0sIHByb3BzLmNoaWxkcmVuLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEphdmFzY3JpcHRBbmltYXRlLCB7CiAgICBhbmltYXRpb25JZCwKICAgIGJlZ2luOiBhbmltYXRpb25CZWdpbiwKICAgIGR1cmF0aW9uOiBhbmltYXRpb25EdXJhdGlvbiwKICAgIGlzQWN0aXZlOiBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGVhc2luZzogYW5pbWF0aW9uRWFzaW5nLAogICAgb25BbmltYXRpb25FbmQ6IGhhbmRsZUFuaW1hdGlvbkVuZCwKICAgIG9uQW5pbWF0aW9uU3RhcnQ6IGhhbmRsZUFuaW1hdGlvblN0YXJ0LAogICAga2V5OiBhbmltYXRpb25JZAogIH0sICh0KSA9PiB7CiAgICBpZiAocHJldlBvaW50cykgewogICAgICB2YXIgcHJldlBvaW50c0RpZmZGYWN0b3IgPSBwcmV2UG9pbnRzLmxlbmd0aCAvIHBvaW50cy5sZW5ndGg7CiAgICAgIHZhciBzdGVwUG9pbnRzID0gKAogICAgICAgIC8qCiAgICAgICAgICogSGVyZSBpdCBpcyBpbXBvcnRhbnQgdGhhdCBhdCB0aGUgdmVyeSBlbmQgb2YgdGhlIGFuaW1hdGlvbiwgb24gdGhlIGxhc3QgZnJhbWUsCiAgICAgICAgICogd2UgcmVuZGVyIHRoZSBvcmlnaW5hbCBwb2ludHMgd2l0aG91dCBhbnkgaW50ZXJwb2xhdGlvbi4KICAgICAgICAgKiBUaGlzIGlzIG5lZWRlZCBiZWNhdXNlIHRoZSBjb2RlIGFib3ZlIGlzIGNoZWNraW5nIGZvciByZWZlcmVuY2UgZXF1YWxpdHkgdG8gZGVjaWRlIGlmIHRoZSBhbmltYXRpb24gc2hvdWxkIHJ1bgogICAgICAgICAqIGFuZCBpZiB3ZSBjcmVhdGUgYSBuZXcgYXJyYXkgaW5zdGFuY2UgKGV2ZW4gaWYgdGhlIG51bWJlcnMgd2VyZSB0aGUgc2FtZSkKICAgICAgICAgKiB0aGVuIHdlIHdvdWxkIGJyZWFrIGFuaW1hdGlvbnMuCiAgICAgICAgICovCiAgICAgICAgdCA9PT0gMSA/IHBvaW50cyA6IHBvaW50cy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICAgICAgdmFyIHByZXZQb2ludEluZGV4ID0gTWF0aC5mbG9vcihpbmRleCAqIHByZXZQb2ludHNEaWZmRmFjdG9yKTsKICAgICAgICAgIGlmIChwcmV2UG9pbnRzW3ByZXZQb2ludEluZGV4XSkgewogICAgICAgICAgICB2YXIgcHJldiA9IHByZXZQb2ludHNbcHJldlBvaW50SW5kZXhdOwogICAgICAgICAgICByZXR1cm4gX29iamVjdFNwcmVhZDMyKF9vYmplY3RTcHJlYWQzMih7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgICAgIHg6IGludGVycG9sYXRlKHByZXYueCwgZW50cnkueCwgdCksCiAgICAgICAgICAgICAgeTogaW50ZXJwb2xhdGUocHJldi55LCBlbnRyeS55LCB0KQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnRyeTsKICAgICAgICB9KQogICAgICApOwogICAgICB2YXIgc3RlcEJhc2VMaW5lOwogICAgICBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICAgICAgc3RlcEJhc2VMaW5lID0gaW50ZXJwb2xhdGUocHJldkJhc2VMaW5lLCBiYXNlTGluZSwgdCk7CiAgICAgIH0gZWxzZSBpZiAoaXNOdWxsaXNoKGJhc2VMaW5lKSB8fCBpc05hbihiYXNlTGluZSkpIHsKICAgICAgICBzdGVwQmFzZUxpbmUgPSBpbnRlcnBvbGF0ZShwcmV2QmFzZUxpbmUsIDAsIHQpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0ZXBCYXNlTGluZSA9IGJhc2VMaW5lLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgICAgICB2YXIgcHJldlBvaW50SW5kZXggPSBNYXRoLmZsb29yKGluZGV4ICogcHJldlBvaW50c0RpZmZGYWN0b3IpOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocHJldkJhc2VMaW5lKSAmJiBwcmV2QmFzZUxpbmVbcHJldlBvaW50SW5kZXhdKSB7CiAgICAgICAgICAgIHZhciBwcmV2ID0gcHJldkJhc2VMaW5lW3ByZXZQb2ludEluZGV4XTsKICAgICAgICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQzMihfb2JqZWN0U3ByZWFkMzIoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgICAgICB4OiBpbnRlcnBvbGF0ZShwcmV2LngsIGVudHJ5LngsIHQpLAogICAgICAgICAgICAgIHk6IGludGVycG9sYXRlKHByZXYueSwgZW50cnkueSwgdCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZW50cnk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHQgPiAwKSB7CiAgICAgICAgcHJldmlvdXNQb2ludHNSZWYuY3VycmVudCA9IHN0ZXBQb2ludHM7CiAgICAgICAgcHJldmlvdXNCYXNlbGluZVJlZi5jdXJyZW50ID0gc3RlcEJhc2VMaW5lOwogICAgICB9CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFN0YXRpY0FyZWEsIHsKICAgICAgICBwb2ludHM6IHN0ZXBQb2ludHMsCiAgICAgICAgYmFzZUxpbmU6IHN0ZXBCYXNlTGluZSwKICAgICAgICBuZWVkQ2xpcCwKICAgICAgICBjbGlwUGF0aElkLAogICAgICAgIHByb3BzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHQgPiAwKSB7CiAgICAgIHByZXZpb3VzUG9pbnRzUmVmLmN1cnJlbnQgPSBwb2ludHM7CiAgICAgIHByZXZpb3VzQmFzZWxpbmVSZWYuY3VycmVudCA9IGJhc2VMaW5lOwogICAgfQogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIG51bGwsIGlzQW5pbWF0aW9uQWN0aXZlICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgICAgaWQ6ICJhbmltYXRpb25DbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkKQogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChDbGlwUmVjdCwgewogICAgICBhbHBoYTogdCwKICAgICAgcG9pbnRzLAogICAgICBiYXNlTGluZSwKICAgICAgbGF5b3V0LAogICAgICBzdHJva2VXaWR0aDogcHJvcHMuc3Ryb2tlV2lkdGgKICAgIH0pKSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgICAgY2xpcFBhdGg6ICJ1cmwoI2FuaW1hdGlvbkNsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQsICIpIikKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoU3RhdGljQXJlYSwgewogICAgICBwb2ludHMsCiAgICAgIGJhc2VMaW5lLAogICAgICBuZWVkQ2xpcCwKICAgICAgY2xpcFBhdGhJZCwKICAgICAgcHJvcHMKICAgIH0pKSk7CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0RnJvbUxhYmVsUHJvcCwgewogICAgbGFiZWw6IHByb3BzLmxhYmVsCiAgfSkpOwp9CmZ1bmN0aW9uIFJlbmRlckFyZWEoX3JlZjkpIHsKICB2YXIgewogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMKICB9ID0gX3JlZjk7CiAgdmFyIHByZXZpb3VzUG9pbnRzUmVmID0gKDAsIGltcG9ydF9yZWFjdDM5LnVzZVJlZikobnVsbCk7CiAgdmFyIHByZXZpb3VzQmFzZWxpbmVSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzkudXNlUmVmKSgpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEFyZWFXaXRoQW5pbWF0aW9uLCB7CiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcywKICAgIHByZXZpb3VzUG9pbnRzUmVmLAogICAgcHJldmlvdXNCYXNlbGluZVJlZgogIH0pOwp9CnZhciBBcmVhV2l0aFN0YXRlID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3QzOS5QdXJlQ29tcG9uZW50IHsKICByZW5kZXIoKSB7CiAgICB2YXIgewogICAgICBoaWRlLAogICAgICBkb3QsCiAgICAgIHBvaW50cywKICAgICAgY2xhc3NOYW1lLAogICAgICB0b3AsCiAgICAgIGxlZnQsCiAgICAgIG5lZWRDbGlwLAogICAgICB4QXhpc0lkLAogICAgICB5QXhpc0lkLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0LAogICAgICBpZCwKICAgICAgYmFzZUxpbmUsCiAgICAgIHpJbmRleAogICAgfSA9IHRoaXMucHJvcHM7CiAgICBpZiAoaGlkZSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtYXJlYSIsIGNsYXNzTmFtZSk7CiAgICB2YXIgY2xpcFBhdGhJZCA9IGlkOwogICAgdmFyIHsKICAgICAgcjogcjIsCiAgICAgIHN0cm9rZVdpZHRoCiAgICB9ID0gZ2V0UmFkaXVzQW5kU3Ryb2tlV2lkdGhGcm9tRG90KGRvdCk7CiAgICB2YXIgY2xpcERvdCA9IGlzQ2xpcERvdChkb3QpOwogICAgdmFyIGRvdFNpemUgPSByMiAqIDIgKyBzdHJva2VXaWR0aDsKICAgIHZhciBhY3RpdmVQb2ludHNDbGlwUGF0aCA9IG5lZWRDbGlwID8gInVybCgjY2xpcFBhdGgtIi5jb25jYXQoY2xpcERvdCA/ICIiIDogImRvdHMtIikuY29uY2F0KGNsaXBQYXRoSWQsICIpIikgOiB2b2lkIDA7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgICB6SW5kZXgKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzCiAgICB9LCBuZWVkQ2xpcCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KCJkZWZzIiwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChHcmFwaGljYWxJdGVtQ2xpcFBhdGgsIHsKICAgICAgY2xpcFBhdGhJZCwKICAgICAgeEF4aXNJZCwKICAgICAgeUF4aXNJZAogICAgfSksICFjbGlwRG90ICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIiwgewogICAgICBpZDogImNsaXBQYXRoLWRvdHMtIi5jb25jYXQoY2xpcFBhdGhJZCkKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIHg6IGxlZnQgLSBkb3RTaXplIC8gMiwKICAgICAgeTogdG9wIC0gZG90U2l6ZSAvIDIsCiAgICAgIHdpZHRoOiB3aWR0aCArIGRvdFNpemUsCiAgICAgIGhlaWdodDogaGVpZ2h0ICsgZG90U2l6ZQogICAgfSkpKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChSZW5kZXJBcmVhLCB7CiAgICAgIG5lZWRDbGlwLAogICAgICBjbGlwUGF0aElkLAogICAgICBwcm9wczogdGhpcy5wcm9wcwogICAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEFjdGl2ZVBvaW50cywgewogICAgICBwb2ludHMsCiAgICAgIG1haW5Db2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHRoaXMucHJvcHMuc3Ryb2tlLCB0aGlzLnByb3BzLmZpbGwpLAogICAgICBpdGVtRGF0YUtleTogdGhpcy5wcm9wcy5kYXRhS2V5LAogICAgICBhY3RpdmVEb3Q6IHRoaXMucHJvcHMuYWN0aXZlRG90LAogICAgICBjbGlwUGF0aDogYWN0aXZlUG9pbnRzQ2xpcFBhdGgKICAgIH0pLCB0aGlzLnByb3BzLmlzUmFuZ2UgJiYgQXJyYXkuaXNBcnJheShiYXNlTGluZSkgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChBY3RpdmVQb2ludHMsIHsKICAgICAgcG9pbnRzOiBiYXNlTGluZSwKICAgICAgbWFpbkNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3IodGhpcy5wcm9wcy5zdHJva2UsIHRoaXMucHJvcHMuZmlsbCksCiAgICAgIGl0ZW1EYXRhS2V5OiB0aGlzLnByb3BzLmRhdGFLZXksCiAgICAgIGFjdGl2ZURvdDogdGhpcy5wcm9wcy5hY3RpdmVEb3QsCiAgICAgIGNsaXBQYXRoOiBhY3RpdmVQb2ludHNDbGlwUGF0aAogICAgfSkpOwogIH0KfTsKdmFyIGRlZmF1bHRBcmVhUHJvcHMgPSB7CiAgYWN0aXZlRG90OiB0cnVlLAogIGFuaW1hdGlvbkJlZ2luOiAwLAogIGFuaW1hdGlvbkR1cmF0aW9uOiAxNTAwLAogIGFuaW1hdGlvbkVhc2luZzogImVhc2UiLAogIGNvbm5lY3ROdWxsczogZmFsc2UsCiAgZG90OiBmYWxzZSwKICBmaWxsOiAiIzMxODJiZCIsCiAgZmlsbE9wYWNpdHk6IDAuNiwKICBoaWRlOiBmYWxzZSwKICBpc0FuaW1hdGlvbkFjdGl2ZTogImF1dG8iLAogIGxlZ2VuZFR5cGU6ICJsaW5lIiwKICBzdHJva2U6ICIjMzE4MmJkIiwKICBzdHJva2VXaWR0aDogMSwKICB0eXBlOiAibGluZWFyIiwKICBsYWJlbDogZmFsc2UsCiAgeEF4aXNJZDogMCwKICB5QXhpc0lkOiAwLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmFyZWEKfTsKZnVuY3Rpb24gQXJlYUltcGwocHJvcHMpIHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yOwogIHZhciBfcmVzb2x2ZURlZmF1bHRQcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMocHJvcHMsIGRlZmF1bHRBcmVhUHJvcHMpLCB7CiAgICBhY3RpdmVEb3QsCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgY29ubmVjdE51bGxzLAogICAgZG90LAogICAgZmlsbCwKICAgIGZpbGxPcGFjaXR5LAogICAgaGlkZSwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgbGVnZW5kVHlwZSwKICAgIHN0cm9rZSwKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSA9IF9yZXNvbHZlRGVmYXVsdFByb3BzLCBldmVyeXRoaW5nRWxzZSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEyKF9yZXNvbHZlRGVmYXVsdFByb3BzLCBfZXhjbHVkZWQyNik7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgdmFyIGNoYXJ0TmFtZSA9IHVzZUNoYXJ0TmFtZSgpOwogIHZhciB7CiAgICBuZWVkQ2xpcAogIH0gPSB1c2VOZWVkc0NsaXAoeEF4aXNJZCwgeUF4aXNJZCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGlzUmFuZ2UsCiAgICBiYXNlTGluZQogIH0gPSAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBcmVhKHN0YXRlLCB4QXhpc0lkLCB5QXhpc0lkLCBpc1Bhbm9yYW1hLCBwcm9wcy5pZCkpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvciA6IHt9OwogIHZhciBwbG90QXJlYSA9IHVzZVBsb3RBcmVhKCk7CiAgaWYgKGxheW91dCAhPT0gImhvcml6b250YWwiICYmIGxheW91dCAhPT0gInZlcnRpY2FsIiB8fCBwbG90QXJlYSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKGNoYXJ0TmFtZSAhPT0gIkFyZWFDaGFydCIgJiYgY2hhcnROYW1lICE9PSAiQ29tcG9zZWRDaGFydCIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgaGVpZ2h0LAogICAgd2lkdGgsCiAgICB4OiBsZWZ0LAogICAgeTogdG9wCiAgfSA9IHBsb3RBcmVhOwogIGlmICghcG9pbnRzIHx8ICFwb2ludHMubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQXJlYVdpdGhTdGF0ZSwgX2V4dGVuZHMxOCh7fSwgZXZlcnl0aGluZ0Vsc2UsIHsKICAgIGFjdGl2ZURvdCwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBiYXNlTGluZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGRvdCwKICAgIGZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIGhlaWdodCwKICAgIGhpZGUsCiAgICBsYXlvdXQsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZTogaXNBbmltYXRpb25BY3RpdmUgPT09ICJhdXRvIiA/ICFHbG9iYWwuaXNTc3IgOiBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGlzUmFuZ2UsCiAgICBsZWdlbmRUeXBlLAogICAgbmVlZENsaXAsCiAgICBwb2ludHMsCiAgICBzdHJva2UsCiAgICB3aWR0aCwKICAgIGxlZnQsCiAgICB0b3AsCiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0pKTsKfQp2YXIgZ2V0QmFzZVZhbHVlID0gKGxheW91dCwgY2hhcnRCYXNlVmFsdWUsIGl0ZW1CYXNlVmFsdWUsIHhBeGlzLCB5QXhpcykgPT4gewogIHZhciBiYXNlVmFsdWUgPSBpdGVtQmFzZVZhbHVlICE9PSBudWxsICYmIGl0ZW1CYXNlVmFsdWUgIT09IHZvaWQgMCA/IGl0ZW1CYXNlVmFsdWUgOiBjaGFydEJhc2VWYWx1ZTsKICBpZiAoaXNOdW1iZXIoYmFzZVZhbHVlKSkgewogICAgcmV0dXJuIGJhc2VWYWx1ZTsKICB9CiAgdmFyIG51bWVyaWNBeGlzID0gbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyB5QXhpcyA6IHhBeGlzOwogIHZhciBkb21haW4gPSBudW1lcmljQXhpcy5zY2FsZS5kb21haW4oKTsKICBpZiAobnVtZXJpY0F4aXMudHlwZSA9PT0gIm51bWJlciIpIHsKICAgIHZhciBkb21haW5NYXggPSBNYXRoLm1heChkb21haW5bMF0sIGRvbWFpblsxXSk7CiAgICB2YXIgZG9tYWluTWluID0gTWF0aC5taW4oZG9tYWluWzBdLCBkb21haW5bMV0pOwogICAgaWYgKGJhc2VWYWx1ZSA9PT0gImRhdGFNaW4iKSB7CiAgICAgIHJldHVybiBkb21haW5NaW47CiAgICB9CiAgICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1heCIpIHsKICAgICAgcmV0dXJuIGRvbWFpbk1heDsKICAgIH0KICAgIHJldHVybiBkb21haW5NYXggPCAwID8gZG9tYWluTWF4IDogTWF0aC5tYXgoTWF0aC5taW4oZG9tYWluWzBdLCBkb21haW5bMV0pLCAwKTsKICB9CiAgaWYgKGJhc2VWYWx1ZSA9PT0gImRhdGFNaW4iKSB7CiAgICByZXR1cm4gZG9tYWluWzBdOwogIH0KICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1heCIpIHsKICAgIHJldHVybiBkb21haW5bMV07CiAgfQogIHJldHVybiBkb21haW5bMF07Cn07CmZ1bmN0aW9uIGNvbXB1dGVBcmVhKF9yZWYwKSB7CiAgdmFyIHsKICAgIGFyZWFTZXR0aW5nczogewogICAgICBjb25uZWN0TnVsbHMsCiAgICAgIGJhc2VWYWx1ZTogaXRlbUJhc2VWYWx1ZSwKICAgICAgZGF0YUtleQogICAgfSwKICAgIHN0YWNrZWREYXRhLAogICAgbGF5b3V0LAogICAgY2hhcnRCYXNlVmFsdWUsCiAgICB4QXhpcywKICAgIHlBeGlzLAogICAgZGlzcGxheWVkRGF0YSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgeEF4aXNUaWNrcywKICAgIHlBeGlzVGlja3MsCiAgICBiYW5kU2l6ZQogIH0gPSBfcmVmMDsKICB2YXIgaGFzU3RhY2sgPSBzdGFja2VkRGF0YSAmJiBzdGFja2VkRGF0YS5sZW5ndGg7CiAgdmFyIGJhc2VWYWx1ZSA9IGdldEJhc2VWYWx1ZShsYXlvdXQsIGNoYXJ0QmFzZVZhbHVlLCBpdGVtQmFzZVZhbHVlLCB4QXhpcywgeUF4aXMpOwogIHZhciBpc0hvcml6b250YWxMYXlvdXQgPSBsYXlvdXQgPT09ICJob3Jpem9udGFsIjsKICB2YXIgaXNSYW5nZSA9IGZhbHNlOwogIHZhciBwb2ludHMgPSBkaXNwbGF5ZWREYXRhLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICB2YXIgdmFsdWU7CiAgICBpZiAoaGFzU3RhY2spIHsKICAgICAgdmFsdWUgPSBzdGFja2VkRGF0YVtkYXRhU3RhcnRJbmRleCArIGluZGV4XTsKICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGRhdGFLZXkpOwogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgdmFsdWUgPSBbYmFzZVZhbHVlLCB2YWx1ZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaXNSYW5nZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIHZhciBpc0JyZWFrUG9pbnQgPSB2YWx1ZVsxXSA9PSBudWxsIHx8IGhhc1N0YWNrICYmICFjb25uZWN0TnVsbHMgJiYgZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGRhdGFLZXkpID09IG51bGw7CiAgICBpZiAoaXNIb3Jpem9udGFsTGF5b3V0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogZ2V0Q2F0ZUNvb3JkaW5hdGVPZkxpbmUoewogICAgICAgICAgYXhpczogeEF4aXMsCiAgICAgICAgICB0aWNrczogeEF4aXNUaWNrcywKICAgICAgICAgIGJhbmRTaXplLAogICAgICAgICAgZW50cnksCiAgICAgICAgICBpbmRleAogICAgICAgIH0pLAogICAgICAgIHk6IGlzQnJlYWtQb2ludCA/IG51bGwgOiB5QXhpcy5zY2FsZSh2YWx1ZVsxXSksCiAgICAgICAgdmFsdWUsCiAgICAgICAgcGF5bG9hZDogZW50cnkKICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHg6IGlzQnJlYWtQb2ludCA/IG51bGwgOiB4QXhpcy5zY2FsZSh2YWx1ZVsxXSksCiAgICAgIHk6IGdldENhdGVDb29yZGluYXRlT2ZMaW5lKHsKICAgICAgICBheGlzOiB5QXhpcywKICAgICAgICB0aWNrczogeUF4aXNUaWNrcywKICAgICAgICBiYW5kU2l6ZSwKICAgICAgICBlbnRyeSwKICAgICAgICBpbmRleAogICAgICB9KSwKICAgICAgdmFsdWUsCiAgICAgIHBheWxvYWQ6IGVudHJ5CiAgICB9OwogIH0pOwogIHZhciBiYXNlTGluZTsKICBpZiAoaGFzU3RhY2sgfHwgaXNSYW5nZSkgewogICAgYmFzZUxpbmUgPSBwb2ludHMubWFwKChlbnRyeSkgPT4gewogICAgICB2YXIgeDIgPSBBcnJheS5pc0FycmF5KGVudHJ5LnZhbHVlKSA/IGVudHJ5LnZhbHVlWzBdIDogbnVsbDsKICAgICAgaWYgKGlzSG9yaXpvbnRhbExheW91dCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB4OiBlbnRyeS54LAogICAgICAgICAgeTogeDIgIT0gbnVsbCAmJiBlbnRyeS55ICE9IG51bGwgPyB5QXhpcy5zY2FsZSh4MikgOiBudWxsLAogICAgICAgICAgcGF5bG9hZDogZW50cnkucGF5bG9hZAogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB4OiB4MiAhPSBudWxsID8geEF4aXMuc2NhbGUoeDIpIDogbnVsbCwKICAgICAgICB5OiBlbnRyeS55LAogICAgICAgIHBheWxvYWQ6IGVudHJ5LnBheWxvYWQKICAgICAgfTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBiYXNlTGluZSA9IGlzSG9yaXpvbnRhbExheW91dCA/IHlBeGlzLnNjYWxlKGJhc2VWYWx1ZSkgOiB4QXhpcy5zY2FsZShiYXNlVmFsdWUpOwogIH0KICByZXR1cm4gewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBpc1JhbmdlCiAgfTsKfQpmdW5jdGlvbiBBcmVhRm4ob3V0c2lkZVByb3BzKSB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRBcmVhUHJvcHMpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFJlZ2lzdGVyR3JhcGhpY2FsSXRlbUlkLCB7CiAgICBpZDogcHJvcHMuaWQsCiAgICB0eXBlOiAiYXJlYSIKICB9LCAoaWQpID0+IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoUmVhY3QyNy5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChTZXRMZWdlbmRQYXlsb2FkLCB7CiAgICBsZWdlbmRQYXlsb2FkOiBjb21wdXRlTGVnZW5kUGF5bG9hZEZyb21BcmVhRGF0YShwcm9wcykKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChTZXRBcmVhVG9vbHRpcEVudHJ5U2V0dGluZ3MsIHsKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBkYXRhOiBwcm9wcy5kYXRhLAogICAgc3Ryb2tlOiBwcm9wcy5zdHJva2UsCiAgICBzdHJva2VXaWR0aDogcHJvcHMuc3Ryb2tlV2lkdGgsCiAgICBmaWxsOiBwcm9wcy5maWxsLAogICAgbmFtZTogcHJvcHMubmFtZSwKICAgIGhpZGU6IHByb3BzLmhpZGUsCiAgICB1bml0OiBwcm9wcy51bml0LAogICAgdG9vbHRpcFR5cGU6IHByb3BzLnRvb2x0aXBUeXBlCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbSwgewogICAgdHlwZTogImFyZWEiLAogICAgaWQsCiAgICBkYXRhOiBwcm9wcy5kYXRhLAogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIHhBeGlzSWQ6IHByb3BzLnhBeGlzSWQsCiAgICB5QXhpc0lkOiBwcm9wcy55QXhpc0lkLAogICAgekF4aXNJZDogMCwKICAgIHN0YWNrSWQ6IGdldE5vcm1hbGl6ZWRTdGFja0lkKHByb3BzLnN0YWNrSWQpLAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIGJhclNpemU6IHZvaWQgMCwKICAgIGJhc2VWYWx1ZTogcHJvcHMuYmFzZVZhbHVlLAogICAgaXNQYW5vcmFtYSwKICAgIGNvbm5lY3ROdWxsczogcHJvcHMuY29ubmVjdE51bGxzCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQXJlYUltcGwsIF9leHRlbmRzMTgoe30sIHByb3BzLCB7CiAgICBpZAogIH0pKSkpOwp9CnZhciBBcmVhID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjcubWVtbyhBcmVhRm4sIHByb3BzQXJlRXF1YWwpOwpBcmVhLmRpc3BsYXlOYW1lID0gIkFyZWEiOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vWEF4aXMuanMKdmFyIFJlYWN0MjggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0MCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9heGlzUHJvcHNBcmVFcXVhbC5qcwp2YXIgX2V4Y2x1ZGVkMTMgPSBbImRvbWFpbiIsICJyYW5nZSJdOwp2YXIgX2V4Y2x1ZGVkMjcgPSBbImRvbWFpbiIsICJyYW5nZSJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEzKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBzaG9ydEFycmF5c0FyZUVxdWFsKGFycjEsIGFycjIpIHsKICBpZiAoYXJyMSA9PT0gYXJyMikgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KGFycjEpICYmIGFycjEubGVuZ3RoID09PSAyICYmIEFycmF5LmlzQXJyYXkoYXJyMikgJiYgYXJyMi5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiBhcnIxWzBdID09PSBhcnIyWzBdICYmIGFycjFbMV0gPT09IGFycjJbMV07CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBheGlzUHJvcHNBcmVFcXVhbChwcmV2UHJvcHMsIG5leHRQcm9wcykgewogIGlmIChwcmV2UHJvcHMgPT09IG5leHRQcm9wcykgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHZhciB7CiAgICBkb21haW46IHByZXZEb21haW4sCiAgICByYW5nZTogcHJldlJhbmdlCiAgfSA9IHByZXZQcm9wcywgcHJldlJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhwcmV2UHJvcHMsIF9leGNsdWRlZDEzKTsKICB2YXIgewogICAgZG9tYWluOiBuZXh0RG9tYWluLAogICAgcmFuZ2U6IG5leHRSYW5nZQogIH0gPSBuZXh0UHJvcHMsIG5leHRSZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTMobmV4dFByb3BzLCBfZXhjbHVkZWQyNyk7CiAgaWYgKCFzaG9ydEFycmF5c0FyZUVxdWFsKHByZXZEb21haW4sIG5leHREb21haW4pKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmICghc2hvcnRBcnJheXNBcmVFcXVhbChwcmV2UmFuZ2UsIG5leHRSYW5nZSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHByb3BzQXJlRXF1YWwocHJldlJlc3QsIG5leHRSZXN0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vWEF4aXMuanMKdmFyIF9leGNsdWRlZDE0ID0gWyJkYW5nZXJvdXNseVNldElubmVySFRNTCIsICJ0aWNrcyJdOwp2YXIgX2V4Y2x1ZGVkMjggPSBbImlkIl07CmZ1bmN0aW9uIF9leHRlbmRzMTkoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTkgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE5LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTQoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE0KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gU2V0WEF4aXNTZXR0aW5ncyhzZXR0aW5ncykgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIHByZXZTZXR0aW5nc1JlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9PT0gbnVsbCkgewogICAgICBkaXNwYXRjaChhZGRYQXhpcyhzZXR0aW5ncykpOwogICAgfSBlbHNlIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCAhPT0gc2V0dGluZ3MpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZVhBeGlzKHsKICAgICAgICBwcmV2OiBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiBzZXR0aW5ncwogICAgICB9KSk7CiAgICB9CiAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IHNldHRpbmdzOwogIH0sIFtzZXR0aW5ncywgZGlzcGF0Y2hdKTsKICAoMCwgaW1wb3J0X3JlYWN0NDAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpIHsKICAgICAgICBkaXNwYXRjaChyZW1vdmVYQXhpcyhwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkpOwogICAgICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgfQogICAgfTsKICB9LCBbZGlzcGF0Y2hdKTsKICByZXR1cm4gbnVsbDsKfQp2YXIgWEF4aXNJbXBsID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHM7CiAgdmFyIHZpZXdCb3ggPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RBeGlzVmlld0JveCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIGF4aXNUeXBlID0gInhBeGlzIjsKICB2YXIgc2NhbGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNTY2FsZShzdGF0ZSwgYXhpc1R5cGUsIHhBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgY2FydGVzaWFuVGlja0l0ZW1zID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUaWNrc09mQXhpcyhzdGF0ZSwgYXhpc1R5cGUsIHhBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgYXhpc1NpemUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFhBeGlzU2l6ZShzdGF0ZSwgeEF4aXNJZCkpOwogIHZhciBwb3NpdGlvbiA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNQb3NpdGlvbihzdGF0ZSwgeEF4aXNJZCkpOwogIHZhciBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNTZXR0aW5nc05vRGVmYXVsdHMoc3RhdGUsIHhBeGlzSWQpKTsKICBpZiAoYXhpc1NpemUgPT0gbnVsbCB8fCBwb3NpdGlvbiA9PSBudWxsIHx8IHN5bmNocm9uaXplZFNldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwsCiAgICB0aWNrczogdGlja3MyCiAgfSA9IHByb3BzLCBhbGxPdGhlclByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTQocHJvcHMsIF9leGNsdWRlZDE0KTsKICB2YXIgewogICAgaWQKICB9ID0gc3luY2hyb25pemVkU2V0dGluZ3MsIHJlc3RTeW5jaHJvbml6ZWRTZXR0aW5ncyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE0KHN5bmNocm9uaXplZFNldHRpbmdzLCBfZXhjbHVkZWQyOCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuQXhpcywgX2V4dGVuZHMxOSh7fSwgYWxsT3RoZXJQcm9wcywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzLCB7CiAgICBzY2FsZSwKICAgIHg6IHBvc2l0aW9uLngsCiAgICB5OiBwb3NpdGlvbi55LAogICAgd2lkdGg6IGF4aXNTaXplLndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2l6ZS5oZWlnaHQsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiICIpLmNvbmNhdChheGlzVHlwZSksIGNsYXNzTmFtZSksCiAgICB2aWV3Qm94LAogICAgdGlja3M6IGNhcnRlc2lhblRpY2tJdGVtcywKICAgIGF4aXNUeXBlCiAgfSkpOwp9Owp2YXIgeEF4aXNEZWZhdWx0UHJvcHMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGltcGxpY2l0WEF4aXMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogaW1wbGljaXRYQXhpcy5hbGxvd0RlY2ltYWxzLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBpbXBsaWNpdFhBeGlzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGFuZ2xlOiBpbXBsaWNpdFhBeGlzLmFuZ2xlLAogIGF4aXNMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLmF4aXNMaW5lLAogIGhlaWdodDogaW1wbGljaXRYQXhpcy5oZWlnaHQsCiAgaGlkZTogZmFsc2UsCiAgaW5jbHVkZUhpZGRlbjogaW1wbGljaXRYQXhpcy5pbmNsdWRlSGlkZGVuLAogIGludGVydmFsOiBpbXBsaWNpdFhBeGlzLmludGVydmFsLAogIG1pblRpY2tHYXA6IGltcGxpY2l0WEF4aXMubWluVGlja0dhcCwKICBtaXJyb3I6IGltcGxpY2l0WEF4aXMubWlycm9yLAogIG9yaWVudGF0aW9uOiBpbXBsaWNpdFhBeGlzLm9yaWVudGF0aW9uLAogIHBhZGRpbmc6IGltcGxpY2l0WEF4aXMucGFkZGluZywKICByZXZlcnNlZDogaW1wbGljaXRYQXhpcy5yZXZlcnNlZCwKICBzY2FsZTogaW1wbGljaXRYQXhpcy5zY2FsZSwKICB0aWNrOiBpbXBsaWNpdFhBeGlzLnRpY2ssCiAgdGlja0NvdW50OiBpbXBsaWNpdFhBeGlzLnRpY2tDb3VudCwKICB0aWNrTGluZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrTGluZSwKICB0aWNrU2l6ZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrU2l6ZSwKICB0eXBlOiBpbXBsaWNpdFhBeGlzLnR5cGUsCiAgeEF4aXNJZDogMAp9Owp2YXIgWEF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIgPSAob3V0c2lkZVByb3BzKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHhBeGlzRGVmYXVsdFByb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChSZWFjdDI4LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KFNldFhBeGlzU2V0dGluZ3MsIHsKICAgIGFsbG93RGF0YU92ZXJmbG93OiBwcm9wcy5hbGxvd0RhdGFPdmVyZmxvdywKICAgIGFsbG93RGVjaW1hbHM6IHByb3BzLmFsbG93RGVjaW1hbHMsCiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogcHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgICBhbmdsZTogcHJvcHMuYW5nbGUsCiAgICBkYXRhS2V5OiBwcm9wcy5kYXRhS2V5LAogICAgZG9tYWluOiBwcm9wcy5kb21haW4sCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGhpZGU6IHByb3BzLmhpZGUsCiAgICBpZDogcHJvcHMueEF4aXNJZCwKICAgIGluY2x1ZGVIaWRkZW46IHByb3BzLmluY2x1ZGVIaWRkZW4sCiAgICBpbnRlcnZhbDogcHJvcHMuaW50ZXJ2YWwsCiAgICBtaW5UaWNrR2FwOiBwcm9wcy5taW5UaWNrR2FwLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBuYW1lOiBwcm9wcy5uYW1lLAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgcGFkZGluZzogcHJvcHMucGFkZGluZywKICAgIHJldmVyc2VkOiBwcm9wcy5yZXZlcnNlZCwKICAgIHNjYWxlOiBwcm9wcy5zY2FsZSwKICAgIHRpY2s6IHByb3BzLnRpY2ssCiAgICB0aWNrQ291bnQ6IHByb3BzLnRpY2tDb3VudCwKICAgIHRpY2tGb3JtYXR0ZXI6IHByb3BzLnRpY2tGb3JtYXR0ZXIsCiAgICB0aWNrczogcHJvcHMudGlja3MsCiAgICB0eXBlOiBwcm9wcy50eXBlLAogICAgdW5pdDogcHJvcHMudW5pdAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KFhBeGlzSW1wbCwgcHJvcHMpKTsKfTsKdmFyIFhBeGlzID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjgubWVtbyhYQXhpc1NldHRpbmdzRGlzcGF0Y2hlciwgYXhpc1Byb3BzQXJlRXF1YWwpOwpYQXhpcy5kaXNwbGF5TmFtZSA9ICJYQXhpcyI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9ZQXhpcy5qcwp2YXIgUmVhY3QyOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMTUgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgInRpY2tzIl07CnZhciBfZXhjbHVkZWQyOSA9IFsiaWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMyMCgpIHsKICByZXR1cm4gX2V4dGVuZHMyMCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjAuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTUoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE1KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBTZXRZQXhpc1NldHRpbmdzKHNldHRpbmdzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDQxLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDQxLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFlBeGlzKHNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSBzZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlWUF4aXMoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gc2V0dGluZ3M7CiAgfSwgW3NldHRpbmdzLCBkaXNwYXRjaF0pOwogICgwLCBpbXBvcnRfcmVhY3Q0MS51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVlBeGlzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CnZhciBZQXhpc0ltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgeUF4aXNJZCwKICAgIGNsYXNzTmFtZSwKICAgIHdpZHRoLAogICAgbGFiZWwKICB9ID0gcHJvcHM7CiAgdmFyIGNhcnRlc2lhbkF4aXNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDEudXNlUmVmKShudWxsKTsKICB2YXIgbGFiZWxSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDEudXNlUmVmKShudWxsKTsKICB2YXIgdmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEF4aXNWaWV3Qm94KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBheGlzVHlwZSA9ICJ5QXhpcyI7CiAgdmFyIHNjYWxlID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzU2NhbGUoc3RhdGUsIGF4aXNUeXBlLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIGF4aXNTaXplID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RZQXhpc1NpemUoc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgcG9zaXRpb24gPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzUG9zaXRpb24oc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgY2FydGVzaWFuVGlja0l0ZW1zID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUaWNrc09mQXhpcyhzdGF0ZSwgYXhpc1R5cGUsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgc3luY2hyb25pemVkU2V0dGluZ3MgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCB5QXhpc0lkKSk7CiAgKDAsIGltcG9ydF9yZWFjdDQxLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHdpZHRoICE9PSAiYXV0byIgfHwgIWF4aXNTaXplIHx8IGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSB8fCAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQxLmlzVmFsaWRFbGVtZW50KShsYWJlbCkgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgYXhpc0NvbXBvbmVudCA9IGNhcnRlc2lhbkF4aXNSZWYuY3VycmVudDsKICAgIGlmICghYXhpc0NvbXBvbmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdXBkYXRlZFlBeGlzV2lkdGggPSBheGlzQ29tcG9uZW50LmdldENhbGN1bGF0ZWRXaWR0aCgpOwogICAgaWYgKE1hdGgucm91bmQoYXhpc1NpemUud2lkdGgpICE9PSBNYXRoLnJvdW5kKHVwZGF0ZWRZQXhpc1dpZHRoKSkgewogICAgICBkaXNwYXRjaCh1cGRhdGVZQXhpc1dpZHRoKHsKICAgICAgICBpZDogeUF4aXNJZCwKICAgICAgICB3aWR0aDogdXBkYXRlZFlBeGlzV2lkdGgKICAgICAgfSkpOwogICAgfQogIH0sIFsKICAgIC8vIFRoZSBkZXBlbmRlbmN5IG9uIGNhcnRlc2lhbkF4aXNSZWYuY3VycmVudCBpcyBub3QgbmVlZGVkIGJlY2F1c2UgdXNlTGF5b3V0RWZmZWN0IHdpbGwgcnVuIGFmdGVyIGV2ZXJ5IHJlbmRlci4KICAgIC8vIFRoZSByZWYgd2lsbCBiZSBwb3B1bGF0ZWQgYnkgdGhlbi4KICAgIC8vIFRvIHJlLXJ1biB0aGlzIGVmZmVjdCB3aGVuIHRpY2tzIGNoYW5nZSwgd2UgY2FuIGRlcGVuZCBvbiB0aGUgdGlja3MgYXJyYXkgZnJvbSB0aGUgc3RvcmUuCiAgICBjYXJ0ZXNpYW5UaWNrSXRlbXMsCiAgICBheGlzU2l6ZSwKICAgIGRpc3BhdGNoLAogICAgbGFiZWwsCiAgICB5QXhpc0lkLAogICAgd2lkdGgsCiAgICBzeW5jaHJvbml6ZWRTZXR0aW5ncwogIF0pOwogIGlmIChheGlzU2l6ZSA9PSBudWxsIHx8IHBvc2l0aW9uID09IG51bGwgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBkYW5nZXJvdXNseVNldElubmVySFRNTCwKICAgIHRpY2tzOiB0aWNrczIKICB9ID0gcHJvcHMsIGFsbE90aGVyUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShwcm9wcywgX2V4Y2x1ZGVkMTUpOwogIHZhciB7CiAgICBpZAogIH0gPSBzeW5jaHJvbml6ZWRTZXR0aW5ncywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTUoc3luY2hyb25pemVkU2V0dGluZ3MsIF9leGNsdWRlZDI5KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzLCBfZXh0ZW5kczIwKHt9LCBhbGxPdGhlclByb3BzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MsIHsKICAgIHJlZjogY2FydGVzaWFuQXhpc1JlZiwKICAgIGxhYmVsUmVmLAogICAgc2NhbGUsCiAgICB4OiBwb3NpdGlvbi54LAogICAgeTogcG9zaXRpb24ueSwKICAgIHRpY2tUZXh0UHJvcHM6IHdpZHRoID09PSAiYXV0byIgPyB7CiAgICAgIHdpZHRoOiB2b2lkIDAKICAgIH0gOiB7CiAgICAgIHdpZHRoCiAgICB9LAogICAgd2lkdGg6IGF4aXNTaXplLndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2l6ZS5oZWlnaHQsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiICIpLmNvbmNhdChheGlzVHlwZSksIGNsYXNzTmFtZSksCiAgICB2aWV3Qm94LAogICAgdGlja3M6IGNhcnRlc2lhblRpY2tJdGVtcywKICAgIGF4aXNUeXBlCiAgfSkpOwp9Owp2YXIgeUF4aXNEZWZhdWx0UHJvcHMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGltcGxpY2l0WUF4aXMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogaW1wbGljaXRZQXhpcy5hbGxvd0RlY2ltYWxzLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBpbXBsaWNpdFlBeGlzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGFuZ2xlOiBpbXBsaWNpdFlBeGlzLmFuZ2xlLAogIGF4aXNMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLmF4aXNMaW5lLAogIGhpZGU6IGZhbHNlLAogIGluY2x1ZGVIaWRkZW46IGltcGxpY2l0WUF4aXMuaW5jbHVkZUhpZGRlbiwKICBpbnRlcnZhbDogaW1wbGljaXRZQXhpcy5pbnRlcnZhbCwKICBtaW5UaWNrR2FwOiBpbXBsaWNpdFlBeGlzLm1pblRpY2tHYXAsCiAgbWlycm9yOiBpbXBsaWNpdFlBeGlzLm1pcnJvciwKICBvcmllbnRhdGlvbjogaW1wbGljaXRZQXhpcy5vcmllbnRhdGlvbiwKICBwYWRkaW5nOiBpbXBsaWNpdFlBeGlzLnBhZGRpbmcsCiAgcmV2ZXJzZWQ6IGltcGxpY2l0WUF4aXMucmV2ZXJzZWQsCiAgc2NhbGU6IGltcGxpY2l0WUF4aXMuc2NhbGUsCiAgdGljazogaW1wbGljaXRZQXhpcy50aWNrLAogIHRpY2tDb3VudDogaW1wbGljaXRZQXhpcy50aWNrQ291bnQsCiAgdGlja0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja0xpbmUsCiAgdGlja1NpemU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja1NpemUsCiAgdHlwZTogaW1wbGljaXRZQXhpcy50eXBlLAogIHdpZHRoOiBpbXBsaWNpdFlBeGlzLndpZHRoLAogIHlBeGlzSWQ6IDAKfTsKdmFyIFlBeGlzU2V0dGluZ3NEaXNwYXRjaGVyID0gKG91dHNpZGVQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCB5QXhpc0RlZmF1bHRQcm9wcyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmNyZWF0ZUVsZW1lbnQoUmVhY3QyOS5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudChTZXRZQXhpc1NldHRpbmdzLCB7CiAgICBpbnRlcnZhbDogcHJvcHMuaW50ZXJ2YWwsCiAgICBpZDogcHJvcHMueUF4aXNJZCwKICAgIHNjYWxlOiBwcm9wcy5zY2FsZSwKICAgIHR5cGU6IHByb3BzLnR5cGUsCiAgICBkb21haW46IHByb3BzLmRvbWFpbiwKICAgIGFsbG93RGF0YU92ZXJmbG93OiBwcm9wcy5hbGxvd0RhdGFPdmVyZmxvdywKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogcHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgICBhbGxvd0RlY2ltYWxzOiBwcm9wcy5hbGxvd0RlY2ltYWxzLAogICAgdGlja0NvdW50OiBwcm9wcy50aWNrQ291bnQsCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgaW5jbHVkZUhpZGRlbjogcHJvcHMuaW5jbHVkZUhpZGRlbiwKICAgIHJldmVyc2VkOiBwcm9wcy5yZXZlcnNlZCwKICAgIHRpY2tzOiBwcm9wcy50aWNrcywKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICBuYW1lOiBwcm9wcy5uYW1lLAogICAgYW5nbGU6IHByb3BzLmFuZ2xlLAogICAgbWluVGlja0dhcDogcHJvcHMubWluVGlja0dhcCwKICAgIHRpY2s6IHByb3BzLnRpY2ssCiAgICB0aWNrRm9ybWF0dGVyOiBwcm9wcy50aWNrRm9ybWF0dGVyCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmNyZWF0ZUVsZW1lbnQoWUF4aXNJbXBsLCBwcm9wcykpOwp9Owp2YXIgWUF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5tZW1vKFlBeGlzU2V0dGluZ3NEaXNwYXRjaGVyLCBheGlzUHJvcHNBcmVFcXVhbCk7CllBeGlzLmRpc3BsYXlOYW1lID0gIllBeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2FydGVzaWFuQ2hhcnQuanMKdmFyIFJlYWN0MzUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1MCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVjaGFydHNTdG9yZVByb3ZpZGVyLmpzCnZhciBSZWFjdDMwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIuanMKdmFyIHBpY2tDaGFydFBvaW50ZXIgPSAoX3N0YXRlLCBjaGFydFBvaW50ZXIpID0+IGNoYXJ0UG9pbnRlcjsKdmFyIHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlciA9IGNyZWF0ZVNlbGVjdG9yKFtwaWNrQ2hhcnRQb2ludGVyLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0UG9sYXJWaWV3Qm94LCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VXaXRoUmV2ZXJzZSwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0T3JkZXJlZFRvb2x0aXBUaWNrcywgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIGNvbWJpbmVBY3RpdmVQcm9wcyk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0Q2hhcnRQb2ludGVyLmpzCnZhciBnZXRDaGFydFBvaW50ZXIgPSAoZXZlbnQpID0+IHsKICB2YXIgcmVjdCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgdmFyIHNjYWxlWCA9IHJlY3Qud2lkdGggLyBldmVudC5jdXJyZW50VGFyZ2V0Lm9mZnNldFdpZHRoOwogIHZhciBzY2FsZVkgPSByZWN0LmhlaWdodCAvIGV2ZW50LmN1cnJlbnRUYXJnZXQub2Zmc2V0SGVpZ2h0OwogIHJldHVybiB7CiAgICAvKgogICAgICogSGVyZSBpdCdzIGltcG9ydGFudCB0byB1c2U6CiAgICAgKiAtIGV2ZW50LmNsaWVudFggYW5kIGV2ZW50LmNsaWVudFkgdG8gZ2V0IHRoZSBtb3VzZSBwb3NpdGlvbiByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQsIGluY2x1ZGluZyBzY3JvbGwuCiAgICAgKiAtIHBhZ2VYIGFuZCBwYWdlWSBhcmUgbm90IHVzZWQgYmVjYXVzZSB0aGV5IGFyZSByZWxhdGl2ZSB0byB0aGUgd2hvbGUgZG9jdW1lbnQsIGFuZCBpZ25vcmUgc2Nyb2xsLgogICAgICogLSByZWN0LmxlZnQgYW5kIHJlY3QudG9wIGFyZSB1c2VkIHRvIGdldCB0aGUgcG9zaXRpb24gb2YgdGhlIGNoYXJ0IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydC4KICAgICAqIC0gb2Zmc2V0WCBhbmQgb2Zmc2V0WSBhcmUgbm90IHVzZWQgYmVjYXVzZSB0aGV5IGFyZSByZWxhdGl2ZSB0byB0aGUgb2Zmc2V0IHBhcmVudAogICAgICogIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIHRoZSBzYW1lIGFzIHRoZSBjbGllbnRYIGFuZCBjbGllbnRZLCBkZXBlbmRpbmcgb24gdGhlIHBvc2l0aW9uIG9mIHRoZSBjaGFydCBpbiB0aGUgRE9NCiAgICAgKiAgYW5kIHN1cnJvdW5kaW5nIGVsZW1lbnQgc3R5bGVzLiBDU1MgcG9zaXRpb246IHJlbGF0aXZlLCBhYnNvbHV0ZSwgZml4ZWQsIHdpbGwgY2hhbmdlIHRoZSBvZmZzZXQgcGFyZW50LgogICAgICogLSBzY2FsZVggYW5kIHNjYWxlWSBhcmUgbmVjZXNzYXJ5IGZvciB3aGVuIHRoZSBjaGFydCBlbGVtZW50IGlzIHNjYWxlZCB1c2luZyBDU1MgYHRyYW5zZm9ybTogc2NhbGUoTilgLgogICAgICovCiAgICBjaGFydFg6IE1hdGgucm91bmQoKGV2ZW50LmNsaWVudFggLSByZWN0LmxlZnQpIC8gc2NhbGVYKSwKICAgIGNoYXJ0WTogTWF0aC5yb3VuZCgoZXZlbnQuY2xpZW50WSAtIHJlY3QudG9wKSAvIHNjYWxlWSkKICB9Owp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9tb3VzZUV2ZW50c01pZGRsZXdhcmUuanMKdmFyIG1vdXNlQ2xpY2tBY3Rpb24gPSBjcmVhdGVBY3Rpb24oIm1vdXNlQ2xpY2siKTsKdmFyIG1vdXNlQ2xpY2tNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7Cm1vdXNlQ2xpY2tNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBtb3VzZUNsaWNrQWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBtb3VzZVBvaW50ZXIgPSBhY3Rpb24ucGF5bG9hZDsKICAgIHZhciBhY3RpdmVQcm9wcyA9IHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlcihsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpLCBnZXRDaGFydFBvaW50ZXIobW91c2VQb2ludGVyKSk7CiAgICBpZiAoKGFjdGl2ZVByb3BzID09PSBudWxsIHx8IGFjdGl2ZVByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCkgIT0gbnVsbCkgewogICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRNb3VzZUNsaWNrQXhpc0luZGV4KHsKICAgICAgICBhY3RpdmVJbmRleDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgsCiAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGFjdGl2ZVByb3BzLmFjdGl2ZUNvb3JkaW5hdGUKICAgICAgfSkpOwogICAgfQogIH0KfSk7CnZhciBtb3VzZU1vdmVBY3Rpb24gPSBjcmVhdGVBY3Rpb24oIm1vdXNlTW92ZSIpOwp2YXIgbW91c2VNb3ZlTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp2YXIgcmFmSWQgPSBudWxsOwptb3VzZU1vdmVNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBtb3VzZU1vdmVBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIG1vdXNlUG9pbnRlciA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKHJhZklkICE9PSBudWxsKSB7CiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJhZklkKTsKICAgIH0KICAgIHZhciBjaGFydFBvaW50ZXIgPSBnZXRDaGFydFBvaW50ZXIobW91c2VQb2ludGVyKTsKICAgIHJhZklkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsKICAgICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgICAgdmFyIHRvb2x0aXBFdmVudFR5cGUgPSBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzdGF0ZS50b29sdGlwLnNldHRpbmdzLnNoYXJlZCk7CiAgICAgIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIpIHsKICAgICAgICB2YXIgYWN0aXZlUHJvcHMgPSBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIoc3RhdGUsIGNoYXJ0UG9pbnRlcik7CiAgICAgICAgaWYgKChhY3RpdmVQcm9wcyA9PT0gbnVsbCB8fCBhY3RpdmVQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgpICE9IG51bGwpIHsKICAgICAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldE1vdXNlT3ZlckF4aXNJbmRleCh7CiAgICAgICAgICAgIGFjdGl2ZUluZGV4OiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCwKICAgICAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3RpdmVQcm9wcy5hY3RpdmVDb29yZGluYXRlCiAgICAgICAgICB9KSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKG1vdXNlTGVhdmVDaGFydCgpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmFmSWQgPSBudWxsOwogICAgfSk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcmVkdXhEZXZ0b29sc0pzb25TdHJpbmdpZnlSZXBsYWNlci5qcwpmdW5jdGlvbiByZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyKGtleSwgdmFsdWUpIHsKICBpZiAodmFsdWUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgcmV0dXJuICJIVE1MRWxlbWVudCA8Ii5jb25jYXQodmFsdWUudGFnTmFtZSwgJyBjbGFzcz0iJykuY29uY2F0KHZhbHVlLmNsYXNzTmFtZSwgJyI+Jyk7CiAgfQogIGlmICh2YWx1ZSA9PT0gd2luZG93KSB7CiAgICByZXR1cm4gImdsb2JhbC53aW5kb3ciOwogIH0KICBpZiAoa2V5ID09PSAiY2hpbGRyZW4iICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgIHJldHVybiAiPDxDSElMRFJFTj4+IjsKICB9CiAgcmV0dXJuIHZhbHVlOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3Jvb3RQcm9wc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMiA9IHsKICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHRydWUsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBiYXJTaXplOiB2b2lkIDAsCiAgY2xhc3NOYW1lOiB2b2lkIDAsCiAgbWF4QmFyU2l6ZTogdm9pZCAwLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgc3luY0lkOiB2b2lkIDAsCiAgc3luY01ldGhvZDogImluZGV4IiwKICBiYXNlVmFsdWU6IHZvaWQgMCwKICByZXZlcnNlU3RhY2tPcmRlcjogZmFsc2UKfTsKdmFyIHJvb3RQcm9wc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJyb290UHJvcHMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTIsCiAgcmVkdWNlcnM6IHsKICAgIHVwZGF0ZU9wdGlvbnM6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkYmFyR2E7CiAgICAgIHN0YXRlLmFjY2Vzc2liaWxpdHlMYXllciA9IGFjdGlvbi5wYXlsb2FkLmFjY2Vzc2liaWxpdHlMYXllcjsKICAgICAgc3RhdGUuYmFyQ2F0ZWdvcnlHYXAgPSBhY3Rpb24ucGF5bG9hZC5iYXJDYXRlZ29yeUdhcDsKICAgICAgc3RhdGUuYmFyR2FwID0gKF9hY3Rpb24kcGF5bG9hZCRiYXJHYSA9IGFjdGlvbi5wYXlsb2FkLmJhckdhcCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGJhckdhICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkYmFyR2EgOiBpbml0aWFsU3RhdGUxMi5iYXJHYXA7CiAgICAgIHN0YXRlLmJhclNpemUgPSBhY3Rpb24ucGF5bG9hZC5iYXJTaXplOwogICAgICBzdGF0ZS5tYXhCYXJTaXplID0gYWN0aW9uLnBheWxvYWQubWF4QmFyU2l6ZTsKICAgICAgc3RhdGUuc3RhY2tPZmZzZXQgPSBhY3Rpb24ucGF5bG9hZC5zdGFja09mZnNldDsKICAgICAgc3RhdGUuc3luY0lkID0gYWN0aW9uLnBheWxvYWQuc3luY0lkOwogICAgICBzdGF0ZS5zeW5jTWV0aG9kID0gYWN0aW9uLnBheWxvYWQuc3luY01ldGhvZDsKICAgICAgc3RhdGUuY2xhc3NOYW1lID0gYWN0aW9uLnBheWxvYWQuY2xhc3NOYW1lOwogICAgICBzdGF0ZS5iYXNlVmFsdWUgPSBhY3Rpb24ucGF5bG9hZC5iYXNlVmFsdWU7CiAgICAgIHN0YXRlLnJldmVyc2VTdGFja09yZGVyID0gYWN0aW9uLnBheWxvYWQucmV2ZXJzZVN0YWNrT3JkZXI7CiAgICB9CiAgfQp9KTsKdmFyIHJvb3RQcm9wc1JlZHVjZXIgPSByb290UHJvcHNTbGljZS5yZWR1Y2VyOwp2YXIgewogIHVwZGF0ZU9wdGlvbnMKfSA9IHJvb3RQcm9wc1NsaWNlLmFjdGlvbnM7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3BvbGFyT3B0aW9uc1NsaWNlLmpzCnZhciBwb2xhck9wdGlvbnNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicG9sYXJPcHRpb25zIiwKICBpbml0aWFsU3RhdGU6IG51bGwsCiAgcmVkdWNlcnM6IHsKICAgIHVwZGF0ZVBvbGFyT3B0aW9uczogKF9zdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHJldHVybiBhY3Rpb24ucGF5bG9hZDsKICAgIH0KICB9Cn0pOwp2YXIgewogIHVwZGF0ZVBvbGFyT3B0aW9ucwp9ID0gcG9sYXJPcHRpb25zU2xpY2UuYWN0aW9uczsKdmFyIHBvbGFyT3B0aW9uc1JlZHVjZXIgPSBwb2xhck9wdGlvbnNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9rZXlib2FyZEV2ZW50c01pZGRsZXdhcmUuanMKdmFyIGtleURvd25BY3Rpb24gPSBjcmVhdGVBY3Rpb24oImtleURvd24iKTsKdmFyIGZvY3VzQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJmb2N1cyIpOwp2YXIga2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CmtleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjoga2V5RG93bkFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIGFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlID0gc3RhdGUucm9vdFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciAhPT0gZmFsc2U7CiAgICBpZiAoIWFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB7CiAgICAgIGtleWJvYXJkSW50ZXJhY3Rpb24KICAgIH0gPSBzdGF0ZS50b29sdGlwOwogICAgdmFyIGtleSA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKGtleSAhPT0gIkFycm93UmlnaHQiICYmIGtleSAhPT0gIkFycm93TGVmdCIgJiYga2V5ICE9PSAiRW50ZXIiKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciByZXNvbHZlZEluZGV4ID0gY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleChrZXlib2FyZEludGVyYWN0aW9uLCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YShzdGF0ZSksIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleShzdGF0ZSksIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluKHN0YXRlKSk7CiAgICB2YXIgY3VycmVudEluZGV4ID0gcmVzb2x2ZWRJbmRleCA9PSBudWxsID8gLTEgOiBOdW1iZXIocmVzb2x2ZWRJbmRleCk7CiAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShjdXJyZW50SW5kZXgpIHx8IGN1cnJlbnRJbmRleCA8IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHRvb2x0aXBUaWNrcyA9IHNlbGVjdFRvb2x0aXBBeGlzVGlja3Moc3RhdGUpOwogICAgaWYgKGtleSA9PT0gIkVudGVyIikgewogICAgICB2YXIgX2Nvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhrZXlib2FyZEludGVyYWN0aW9uLmluZGV4KSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICAgIGFjdGl2ZTogIWtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlLAogICAgICAgIGFjdGl2ZUluZGV4OiBrZXlib2FyZEludGVyYWN0aW9uLmluZGV4LAogICAgICAgIGFjdGl2ZURhdGFLZXk6IGtleWJvYXJkSW50ZXJhY3Rpb24uZGF0YUtleSwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBfY29vcmRpbmF0ZQogICAgICB9KSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBkaXJlY3Rpb24gPSBzZWxlY3RDaGFydERpcmVjdGlvbihzdGF0ZSk7CiAgICB2YXIgZGlyZWN0aW9uTXVsdGlwbGllciA9IGRpcmVjdGlvbiA9PT0gImxlZnQtdG8tcmlnaHQiID8gMSA6IC0xOwogICAgdmFyIG1vdmVtZW50ID0ga2V5ID09PSAiQXJyb3dSaWdodCIgPyAxIDogLTE7CiAgICB2YXIgbmV4dEluZGV4ID0gY3VycmVudEluZGV4ICsgbW92ZW1lbnQgKiBkaXJlY3Rpb25NdWx0aXBsaWVyOwogICAgaWYgKHRvb2x0aXBUaWNrcyA9PSBudWxsIHx8IG5leHRJbmRleCA+PSB0b29sdGlwVGlja3MubGVuZ3RoIHx8IG5leHRJbmRleCA8IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhuZXh0SW5kZXgpKTsKICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICBhY3RpdmU6IHRydWUsCiAgICAgIGFjdGl2ZUluZGV4OiBuZXh0SW5kZXgudG9TdHJpbmcoKSwKICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICB9KSk7CiAgfQp9KTsKa2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBmb2N1c0FjdGlvbiwKICBlZmZlY3Q6IChfYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgIHZhciBhY2Nlc3NpYmlsaXR5TGF5ZXJJc0FjdGl2ZSA9IHN0YXRlLnJvb3RQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIgIT09IGZhbHNlOwogICAgaWYgKCFhY2Nlc3NpYmlsaXR5TGF5ZXJJc0FjdGl2ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgewogICAgICBrZXlib2FyZEludGVyYWN0aW9uCiAgICB9ID0gc3RhdGUudG9vbHRpcDsKICAgIGlmIChrZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoa2V5Ym9hcmRJbnRlcmFjdGlvbi5pbmRleCA9PSBudWxsKSB7CiAgICAgIHZhciBuZXh0SW5kZXggPSAiMCI7CiAgICAgIHZhciBjb29yZGluYXRlID0gc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleChzdGF0ZSwgImF4aXMiLCAiaG92ZXIiLCBTdHJpbmcobmV4dEluZGV4KSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICBhY3RpdmU6IHRydWUsCiAgICAgICAgYWN0aXZlSW5kZXg6IG5leHRJbmRleCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9leHRlcm5hbEV2ZW50c01pZGRsZXdhcmUuanMKdmFyIGV4dGVybmFsRXZlbnRBY3Rpb24gPSBjcmVhdGVBY3Rpb24oImV4dGVybmFsRXZlbnQiKTsKdmFyIGV4dGVybmFsRXZlbnRzTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp2YXIgcmFmSWRNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwpleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IGV4dGVybmFsRXZlbnRBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHsKICAgICAgaGFuZGxlciwKICAgICAgcmVhY3RFdmVudAogICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKGhhbmRsZXIgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZWFjdEV2ZW50LnBlcnNpc3QoKTsKICAgIHZhciBldmVudFR5cGUgPSByZWFjdEV2ZW50LnR5cGU7CiAgICB2YXIgZXhpc3RpbmdSYWZJZCA9IHJhZklkTWFwLmdldChldmVudFR5cGUpOwogICAgaWYgKGV4aXN0aW5nUmFmSWQgIT09IHZvaWQgMCkgewogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShleGlzdGluZ1JhZklkKTsKICAgIH0KICAgIHZhciByYWZJZDIgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICB0cnkgewogICAgICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHsKICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IHNlbGVjdEFjdGl2ZVRvb2x0aXBDb29yZGluYXRlKHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhS2V5KHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZUluZGV4OiBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgoc3RhdGUpLAogICAgICAgICAgYWN0aXZlTGFiZWw6IHNlbGVjdEFjdGl2ZUxhYmVsKHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZVRvb2x0aXBJbmRleDogc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4KHN0YXRlKSwKICAgICAgICAgIGlzVG9vbHRpcEFjdGl2ZTogc2VsZWN0SXNUb29sdGlwQWN0aXZlKHN0YXRlKQogICAgICAgIH07CiAgICAgICAgaGFuZGxlcihuZXh0U3RhdGUsIHJlYWN0RXZlbnQpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHJhZklkTWFwLmRlbGV0ZShldmVudFR5cGUpOwogICAgICB9CiAgICB9KTsKICAgIHJhZklkTWFwLnNldChldmVudFR5cGUsIHJhZklkMik7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3RvdWNoU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RBbGxUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlXSwgKHRvb2x0aXBTdGF0ZSkgPT4gdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMpOwp2YXIgc2VsZWN0VG9vbHRpcENvb3JkaW5hdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyLCAoX3N0YXRlLCB0b29sdGlwSW5kZXgsIF9kYXRhS2V5KSA9PiB0b29sdGlwSW5kZXgsIChfc3RhdGUsIF90b29sdGlwSW5kZXgsIGRhdGFLZXkpID0+IGRhdGFLZXldLCAoYWxsVG9vbHRpcENvbmZpZ3VyYXRpb25zLCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyLCB0b29sdGlwSW5kZXgsIGRhdGFLZXkpID0+IHsKICB2YXIgbW9zdFJlbGV2YW50VG9vbHRpcENvbmZpZ3VyYXRpb24gPSBhbGxUb29sdGlwQ29uZmlndXJhdGlvbnMuZmluZCgodG9vbHRpcENvbmZpZ3VyYXRpb24pID0+IHsKICAgIHJldHVybiB0b29sdGlwQ29uZmlndXJhdGlvbi5zZXR0aW5ncy5kYXRhS2V5ID09PSBkYXRhS2V5OwogIH0pOwogIGlmIChtb3N0UmVsZXZhbnRUb29sdGlwQ29uZmlndXJhdGlvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgcG9zaXRpb25zCiAgfSA9IG1vc3RSZWxldmFudFRvb2x0aXBDb25maWd1cmF0aW9uOwogIGlmIChwb3NpdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG1heWJlUG9zaXRpb24gPSB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKHBvc2l0aW9ucywgdG9vbHRpcEluZGV4KTsKICByZXR1cm4gbWF5YmVQb3NpdGlvbjsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3RvdWNoRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIgdG91Y2hFdmVudEFjdGlvbiA9IGNyZWF0ZUFjdGlvbigidG91Y2hNb3ZlIik7CnZhciB0b3VjaEV2ZW50TWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp0b3VjaEV2ZW50TWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogdG91Y2hFdmVudEFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgdG91Y2hFdmVudCA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKHRvdWNoRXZlbnQudG91Y2hlcyA9PSBudWxsIHx8IHRvdWNoRXZlbnQudG91Y2hlcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgIHZhciB0b29sdGlwRXZlbnRUeXBlID0gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5zaGFyZWQpOwogICAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgICB2YXIgYWN0aXZlUHJvcHMgPSBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIoc3RhdGUsIGdldENoYXJ0UG9pbnRlcih7CiAgICAgICAgY2xpZW50WDogdG91Y2hFdmVudC50b3VjaGVzWzBdLmNsaWVudFgsCiAgICAgICAgY2xpZW50WTogdG91Y2hFdmVudC50b3VjaGVzWzBdLmNsaWVudFksCiAgICAgICAgY3VycmVudFRhcmdldDogdG91Y2hFdmVudC5jdXJyZW50VGFyZ2V0CiAgICAgIH0pKTsKICAgICAgaWYgKChhY3RpdmVQcm9wcyA9PT0gbnVsbCB8fCBhY3RpdmVQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgpICE9IG51bGwpIHsKICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRNb3VzZU92ZXJBeGlzSW5kZXgoewogICAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4LAogICAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aXZlUHJvcHMuYWN0aXZlQ29vcmRpbmF0ZQogICAgICAgIH0pKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiaXRlbSIpIHsKICAgICAgdmFyIF90YXJnZXQkZ2V0QXR0cmlidXRlOwogICAgICB2YXIgdG91Y2ggPSB0b3VjaEV2ZW50LnRvdWNoZXNbMF07CiAgICAgIGlmIChkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50ID09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRhcmdldCA9IGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7CiAgICAgIGlmICghdGFyZ2V0IHx8ICF0YXJnZXQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBpdGVtSW5kZXggPSB0YXJnZXQuZ2V0QXR0cmlidXRlKERBVEFfSVRFTV9JTkRFWF9BVFRSSUJVVEVfTkFNRSk7CiAgICAgIHZhciBkYXRhS2V5ID0gKF90YXJnZXQkZ2V0QXR0cmlidXRlID0gdGFyZ2V0LmdldEF0dHJpYnV0ZShEQVRBX0lURU1fREFUQUtFWV9BVFRSSUJVVEVfTkFNRSkpICE9PSBudWxsICYmIF90YXJnZXQkZ2V0QXR0cmlidXRlICE9PSB2b2lkIDAgPyBfdGFyZ2V0JGdldEF0dHJpYnV0ZSA6IHZvaWQgMDsKICAgICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZShsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpLCBpdGVtSW5kZXgsIGRhdGFLZXkpOwogICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRBY3RpdmVNb3VzZU92ZXJJdGVtSW5kZXgoewogICAgICAgIGFjdGl2ZURhdGFLZXk6IGRhdGFLZXksCiAgICAgICAgYWN0aXZlSW5kZXg6IGl0ZW1JbmRleCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zdG9yZS5qcwp2YXIgcm9vdFJlZHVjZXIgPSBjb21iaW5lUmVkdWNlcnMoewogIGJydXNoOiBicnVzaFJlZHVjZXIsCiAgY2FydGVzaWFuQXhpczogY2FydGVzaWFuQXhpc1JlZHVjZXIsCiAgY2hhcnREYXRhOiBjaGFydERhdGFSZWR1Y2VyLAogIGVycm9yQmFyczogZXJyb3JCYXJSZWR1Y2VyLAogIGdyYXBoaWNhbEl0ZW1zOiBncmFwaGljYWxJdGVtc1JlZHVjZXIsCiAgbGF5b3V0OiBjaGFydExheW91dFJlZHVjZXIsCiAgbGVnZW5kOiBsZWdlbmRSZWR1Y2VyLAogIG9wdGlvbnM6IG9wdGlvbnNSZWR1Y2VyLAogIHBvbGFyQXhpczogcG9sYXJBeGlzUmVkdWNlciwKICBwb2xhck9wdGlvbnM6IHBvbGFyT3B0aW9uc1JlZHVjZXIsCiAgcmVmZXJlbmNlRWxlbWVudHM6IHJlZmVyZW5jZUVsZW1lbnRzUmVkdWNlciwKICByb290UHJvcHM6IHJvb3RQcm9wc1JlZHVjZXIsCiAgdG9vbHRpcDogdG9vbHRpcFJlZHVjZXIsCiAgekluZGV4OiB6SW5kZXhSZWR1Y2VyCn0pOwp2YXIgY3JlYXRlUmVjaGFydHNTdG9yZSA9IGZ1bmN0aW9uIGNyZWF0ZVJlY2hhcnRzU3RvcmUyKHByZWxvYWRlZFN0YXRlKSB7CiAgdmFyIGNoYXJ0TmFtZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogIkNoYXJ0IjsKICByZXR1cm4gY29uZmlndXJlU3RvcmUoewogICAgcmVkdWNlcjogcm9vdFJlZHVjZXIsCiAgICAvLyByZWR1eC10b29sa2l0IHYxIHR5cGVzIGFyZSB1bmhhcHB5IHdpdGggdGhlIHByZWxvYWRlZFN0YXRlIHR5cGUuIFJlbW92ZSB0aGUgYGFzIGFueWAgd2hlbiBidW1waW5nIHRvIHYyCiAgICBwcmVsb2FkZWRTdGF0ZSwKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgcmVkdXgtdG9vbGtpdCB2MSB0eXBlcyBhcmUgdW5oYXBweSB3aXRoIHRoZSBtaWRkbGV3YXJlIGFycmF5LiBSZW1vdmUgdGhpcyBjb21tZW50IHdoZW4gYnVtcGluZyB0byB2MgogICAgbWlkZGxld2FyZTogKGdldERlZmF1bHRNaWRkbGV3YXJlKSA9PiB7CiAgICAgIHZhciBfcHJvY2VzcyRlbnYkTk9ERV9FTlY7CiAgICAgIHJldHVybiBnZXREZWZhdWx0TWlkZGxld2FyZSh7CiAgICAgICAgc2VyaWFsaXphYmxlQ2hlY2s6IGZhbHNlLAogICAgICAgIGltbXV0YWJsZUNoZWNrOiAhWyJjb21tb25qcyIsICJlczYiLCAicHJvZHVjdGlvbiJdLmluY2x1ZGVzKChfcHJvY2VzcyRlbnYkTk9ERV9FTlYgPSAiZXM2IikgIT09IG51bGwgJiYgX3Byb2Nlc3MkZW52JE5PREVfRU5WICE9PSB2b2lkIDAgPyBfcHJvY2VzcyRlbnYkTk9ERV9FTlYgOiAiIikKICAgICAgfSkuY29uY2F0KFttb3VzZUNsaWNrTWlkZGxld2FyZS5taWRkbGV3YXJlLCBtb3VzZU1vdmVNaWRkbGV3YXJlLm1pZGRsZXdhcmUsIGtleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5taWRkbGV3YXJlLCBleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUubWlkZGxld2FyZSwgdG91Y2hFdmVudE1pZGRsZXdhcmUubWlkZGxld2FyZV0pOwogICAgfSwKICAgIC8qCiAgICAgKiBJIGNhbid0IGZpbmQgb3V0IGhvdyB0byBzYXRpc2Z5IHR5cGVzY3JpcHQgaGVyZS4KICAgICAqIFdlIHJldHVybiBgRW5oYW5jZXJBcnJheTxbU3RvcmVFbmhhbmNlcjx7fSwge30+LCBTdG9yZUVuaGFuY2VyXT5gIGZyb20gdGhpcyBmdW5jdGlvbiwKICAgICAqIGJ1dCB0aGUgdHlwZXMgc2F5IHdlIHNob3VsZCByZXR1cm4gYEVuaGFuY2VyQXJyYXk8U3RvcmVFbmhhbmNlcjx7fSwge30+YC4KICAgICAqIExvb2tzIGxpa2UgaXQncyBiYWRseSBpbmZlcnJlZCBnZW5lcmljcywgYnV0IGl0IHdvbid0IGFsbG93IG1lIHRvIHByb3ZpZGUgdGhlIGNvcnJlY3QgdHlwZSBtYW51YWxseSBlaXRoZXIuCiAgICAgKiBTbyBsZXQncyBqdXN0IGlnbm9yZSB0aGUgZXJyb3IgZm9yIG5vdy4KICAgICAqLwogICAgLy8gQHRzLWV4cGVjdC1lcnJvciBtaXNtYXRjaGVkIGdlbmVyaWNzCiAgICBlbmhhbmNlcnM6IChnZXREZWZhdWx0RW5oYW5jZXJzKSA9PiB7CiAgICAgIHZhciBlbmhhbmNlcnMgPSBnZXREZWZhdWx0RW5oYW5jZXJzOwogICAgICBpZiAodHlwZW9mIGdldERlZmF1bHRFbmhhbmNlcnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBlbmhhbmNlcnMgPSBnZXREZWZhdWx0RW5oYW5jZXJzKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuaGFuY2Vycy5jb25jYXQoYXV0b0JhdGNoRW5oYW5jZXIoewogICAgICAgIHR5cGU6ICJyYWYiCiAgICAgIH0pKTsKICAgIH0sCiAgICBkZXZUb29sczogR2xvYmFsLmRldlRvb2xzRW5hYmxlZCAmJiB7CiAgICAgIHNlcmlhbGl6ZTogewogICAgICAgIHJlcGxhY2VyOiByZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyCiAgICAgIH0sCiAgICAgIG5hbWU6ICJyZWNoYXJ0cy0iLmNvbmNhdChjaGFydE5hbWUpCiAgICB9CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlY2hhcnRzU3RvcmVQcm92aWRlci5qcwpmdW5jdGlvbiBSZWNoYXJ0c1N0b3JlUHJvdmlkZXIoX3JlZjIpIHsKICB2YXIgewogICAgcHJlbG9hZGVkU3RhdGUsCiAgICBjaGlsZHJlbiwKICAgIHJlZHV4U3RvcmVOYW1lCiAgfSA9IF9yZWYyOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBzdG9yZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0Mi51c2VSZWYpKG51bGwpOwogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gY2hpbGRyZW47CiAgfQogIGlmIChzdG9yZVJlZi5jdXJyZW50ID09IG51bGwpIHsKICAgIHN0b3JlUmVmLmN1cnJlbnQgPSBjcmVhdGVSZWNoYXJ0c1N0b3JlKHByZWxvYWRlZFN0YXRlLCByZWR1eFN0b3JlTmFtZSk7CiAgfQogIHZhciBub25OdWxsQ29udGV4dCA9IFJlY2hhcnRzUmVkdXhDb250ZXh0OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFByb3ZpZGVyX2RlZmF1bHQsIHsKICAgIGNvbnRleHQ6IG5vbk51bGxDb250ZXh0LAogICAgc3RvcmU6IHN0b3JlUmVmLmN1cnJlbnQKICB9LCBjaGlsZHJlbik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVwb3J0TWFpbkNoYXJ0UHJvcHMuanMKdmFyIGltcG9ydF9yZWFjdDQzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBSZXBvcnRNYWluQ2hhcnRQcm9wc0ltcGwoX3JlZjIpIHsKICB2YXIgewogICAgbGF5b3V0LAogICAgbWFyZ2luCiAgfSA9IF9yZWYyOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc1Bhbm9yYW1hKSB7CiAgICAgIGRpc3BhdGNoKHNldExheW91dChsYXlvdXQpKTsKICAgICAgZGlzcGF0Y2goc2V0TWFyZ2luKG1hcmdpbikpOwogICAgfQogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgbGF5b3V0LCBtYXJnaW5dKTsKICByZXR1cm4gbnVsbDsKfQp2YXIgUmVwb3J0TWFpbkNoYXJ0UHJvcHMgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQzLm1lbW8pKFJlcG9ydE1haW5DaGFydFByb3BzSW1wbCwgcHJvcHNBcmVFcXVhbCk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlcG9ydENoYXJ0UHJvcHMuanMKdmFyIGltcG9ydF9yZWFjdDQ0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBSZXBvcnRDaGFydFByb3BzKHByb3BzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0NDQudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaCh1cGRhdGVPcHRpb25zKHByb3BzKSk7CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhdGVnb3JpY2FsQ2hhcnQuanMKdmFyIFJlYWN0MzQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0OSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1Jvb3RTdXJmYWNlLmpzCnZhciBSZWFjdDMyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhQb3J0YWwuanMKdmFyIFJlYWN0MzEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gWkluZGV4U3ZnUG9ydGFsKF9yZWYyKSB7CiAgdmFyIHsKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9ID0gX3JlZjI7CiAgdmFyIHByZWZpeCA9IGlzUGFub3JhbWEgPyAicmVjaGFydHMtemluZGV4LXBhbm9yYW1hLSIgOiAicmVjaGFydHMtemluZGV4LSI7CiAgdmFyIHBvcnRhbElkID0gdXNlVW5pcXVlSWQoIiIuY29uY2F0KHByZWZpeCkuY29uY2F0KHpJbmRleCkpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQ1LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2gocmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCh7CiAgICAgIHpJbmRleCwKICAgICAgZWxlbWVudElkOiBwb3J0YWxJZCwKICAgICAgaXNQYW5vcmFtYQogICAgfSkpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZGlzcGF0Y2godW5yZWdpc3RlclpJbmRleFBvcnRhbElkKHsKICAgICAgICB6SW5kZXgsCiAgICAgICAgaXNQYW5vcmFtYQogICAgICB9KSk7CiAgICB9OwogIH0sIFtkaXNwYXRjaCwgekluZGV4LCBwb3J0YWxJZCwgaXNQYW5vcmFtYV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgdGFiSW5kZXg6IC0xLAogICAgaWQ6IHBvcnRhbElkCiAgfSk7Cn0KZnVuY3Rpb24gQWxsWkluZGV4UG9ydGFscyhfcmVmMikgewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIGlzUGFub3JhbWEKICB9ID0gX3JlZjI7CiAgdmFyIGFsbFJlZ2lzdGVyZWRaSW5kZXhlcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFsbFJlZ2lzdGVyZWRaSW5kZXhlcyk7CiAgaWYgKCFhbGxSZWdpc3RlcmVkWkluZGV4ZXMgfHwgYWxsUmVnaXN0ZXJlZFpJbmRleGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICB2YXIgYWxsTmVnYXRpdmVaSW5kZXhlcyA9IGFsbFJlZ2lzdGVyZWRaSW5kZXhlcy5maWx0ZXIoKHpJbmRleCkgPT4gekluZGV4IDwgMCk7CiAgdmFyIGFsbFBvc2l0aXZlWkluZGV4ZXMgPSBhbGxSZWdpc3RlcmVkWkluZGV4ZXMuZmlsdGVyKCh6SW5kZXgpID0+IHpJbmRleCA+IDApOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KFJlYWN0MzEuRnJhZ21lbnQsIG51bGwsIGFsbE5lZ2F0aXZlWkluZGV4ZXMubWFwKCh6SW5kZXgpID0+IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoWkluZGV4U3ZnUG9ydGFsLCB7CiAgICBrZXk6IHpJbmRleCwKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9KSksIGNoaWxkcmVuLCBhbGxQb3NpdGl2ZVpJbmRleGVzLm1hcCgoekluZGV4KSA9PiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KFpJbmRleFN2Z1BvcnRhbCwgewogICAga2V5OiB6SW5kZXgsCiAgICB6SW5kZXgsCiAgICBpc1Bhbm9yYW1hCiAgfSkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvUm9vdFN1cmZhY2UuanMKdmFyIF9leGNsdWRlZDE2ID0gWyJjaGlsZHJlbiJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNihlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTYoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE2KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfZXh0ZW5kczIxKCkgewogIHJldHVybiBfZXh0ZW5kczIxID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyMS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBGVUxMX1dJRFRIX0FORF9IRUlHSFQgPSB7CiAgd2lkdGg6ICIxMDAlIiwKICBoZWlnaHQ6ICIxMDAlIiwKICAvKgogICAqIGRpc3BsYXk6IGJsb2NrIGlzIG5lY2Vzc2FyeSBoZXJlIGJlY2F1c2UgdGhlIGRlZmF1bHQgZm9yIGFuIFNWRyBpcyBkaXNwbGF5OiBpbmxpbmUsCiAgICogd2hpY2ggaW4gc29tZSBicm93c2VycyAoQ2hyb21lKSBhZGRzIGEgbGl0dGxlIGJpdCBvZiBleHRyYSBzcGFjZSBhYm92ZSBhbmQgYmVsb3cgdGhlIFNWRwogICAqIHRvIG1ha2Ugc3BhY2UgZm9yIHRoZSBkZXNjZW5kZXIgb2YgbGV0dGVycyBsaWtlICJnIiBhbmQgInkiLiBUaGlzIHRocm93cyBvZmYgdGhlIGhlaWdodCBjYWxjdWxhdGlvbgogICAqIGFuZCBjYXVzZXMgdGhlIGNvbnRhaW5lciB0byBncm93IGluZGVmaW5pdGVseSBvbiBlYWNoIHJlbmRlciB3aXRoIHJlc3BvbnNpdmU9dHJ1ZS4KICAgKiBEaXNwbGF5OiBibG9jayByZW1vdmVzIHRoYXQgZXh0cmEgc3BhY2UuCiAgICoKICAgKiBJbnRlcmVzdGluZ2x5LCBGaXJlZm94IGRvZXMgbm90IGhhdmUgdGhpcyBwcm9ibGVtLCBidXQgaXQgZG9lc24ndCBodXJ0IHRvIGFkZCB0aGUgc3R5bGUgYW55d2F5LgogICAqLwogIGRpc3BsYXk6ICJibG9jayIKfTsKdmFyIE1haW5DaGFydFN1cmZhY2UgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ2LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHdpZHRoID0gdXNlQ2hhcnRXaWR0aCgpOwogIHZhciBoZWlnaHQgPSB1c2VDaGFydEhlaWdodCgpOwogIHZhciBoYXNBY2Nlc3NpYmlsaXR5TGF5ZXIgPSB1c2VBY2Nlc3NpYmlsaXR5TGF5ZXIoKTsKICBpZiAoIWlzUG9zaXRpdmVOdW1iZXIod2lkdGgpIHx8ICFpc1Bvc2l0aXZlTnVtYmVyKGhlaWdodCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBvdGhlckF0dHJpYnV0ZXMsCiAgICB0aXRsZSwKICAgIGRlc2MKICB9ID0gcHJvcHM7CiAgdmFyIHRhYkluZGV4LCByb2xlOwogIGlmIChvdGhlckF0dHJpYnV0ZXMgIT0gbnVsbCkgewogICAgaWYgKHR5cGVvZiBvdGhlckF0dHJpYnV0ZXMudGFiSW5kZXggPT09ICJudW1iZXIiKSB7CiAgICAgIHRhYkluZGV4ID0gb3RoZXJBdHRyaWJ1dGVzLnRhYkluZGV4OwogICAgfSBlbHNlIHsKICAgICAgdGFiSW5kZXggPSBoYXNBY2Nlc3NpYmlsaXR5TGF5ZXIgPyAwIDogdm9pZCAwOwogICAgfQogICAgaWYgKHR5cGVvZiBvdGhlckF0dHJpYnV0ZXMucm9sZSA9PT0gInN0cmluZyIpIHsKICAgICAgcm9sZSA9IG90aGVyQXR0cmlidXRlcy5yb2xlOwogICAgfSBlbHNlIHsKICAgICAgcm9sZSA9IGhhc0FjY2Vzc2liaWxpdHlMYXllciA/ICJhcHBsaWNhdGlvbiIgOiB2b2lkIDA7CiAgICB9CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFN1cmZhY2UsIF9leHRlbmRzMjEoe30sIG90aGVyQXR0cmlidXRlcywgewogICAgdGl0bGUsCiAgICBkZXNjLAogICAgcm9sZSwKICAgIHRhYkluZGV4LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHlsZTogRlVMTF9XSURUSF9BTkRfSEVJR0hULAogICAgcmVmCiAgfSksIGNoaWxkcmVuKTsKfSk7CnZhciBCcnVzaFBhbm9yYW1hU3VyZmFjZSA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgYnJ1c2hEaW1lbnNpb25zID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QnJ1c2hEaW1lbnNpb25zKTsKICBpZiAoIWJydXNoRGltZW5zaW9ucykgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHk6IHkyLAogICAgeDogeDIKICB9ID0gYnJ1c2hEaW1lbnNpb25zOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFN1cmZhY2UsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIGNoaWxkcmVuKTsKfTsKdmFyIFJvb3RTdXJmYWNlID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ni5mb3J3YXJkUmVmKSgoX3JlZjIsIHJlZikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMiwgcmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE2KF9yZWYyLCBfZXhjbHVkZWQxNik7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KEJydXNoUGFub3JhbWFTdXJmYWNlLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KEFsbFpJbmRleFBvcnRhbHMsIHsKICAgICAgaXNQYW5vcmFtYTogdHJ1ZQogICAgfSwgY2hpbGRyZW4pKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoTWFpbkNoYXJ0U3VyZmFjZSwgX2V4dGVuZHMyMSh7CiAgICByZWYKICB9LCByZXN0KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChBbGxaSW5kZXhQb3J0YWxzLCB7CiAgICBpc1Bhbm9yYW1hOiBmYWxzZQogIH0sIGNoaWxkcmVuKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9SZWNoYXJ0c1dyYXBwZXIuanMKdmFyIFJlYWN0MzMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0OCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VSZXBvcnRTY2FsZS5qcwp2YXIgaW1wb3J0X3JlYWN0NDcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZVJlcG9ydFNjYWxlKCkgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIFtyZWYsIHNldFJlZl0gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlU3RhdGUpKG51bGwpOwogIHZhciBzY2FsZSA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENvbnRhaW5lclNjYWxlKTsKICAoMCwgaW1wb3J0X3JlYWN0NDcudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocmVmID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHJlY3QgPSByZWYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB2YXIgbmV3U2NhbGUgPSByZWN0LndpZHRoIC8gcmVmLm9mZnNldFdpZHRoOwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobmV3U2NhbGUpICYmIG5ld1NjYWxlICE9PSBzY2FsZSkgewogICAgICBkaXNwYXRjaChzZXRTY2FsZShuZXdTY2FsZSkpOwogICAgfQogIH0sIFtyZWYsIGRpc3BhdGNoLCBzY2FsZV0pOwogIHJldHVybiBzZXRSZWY7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvUmVjaGFydHNXcmFwcGVyLmpzCmZ1bmN0aW9uIG93bktleXMzMyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTM0KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzNChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTM0KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTM0KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTM0KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTM0KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczIyKCkgewogIHJldHVybiBfZXh0ZW5kczIyID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyMi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBFdmVudFN5bmNocm9uaXplciA9ICgpID0+IHsKICB1c2VTeW5jaHJvbmlzZWRFdmVudHNGcm9tT3RoZXJDaGFydHMoKTsKICByZXR1cm4gbnVsbDsKfTsKZnVuY3Rpb24gZ2V0TnVtYmVyT3JaZXJvKHZhbHVlKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgIHZhciBwYXJzZWQgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgIGlmICghTnVtYmVyLmlzTmFOKHBhcnNlZCkpIHsKICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH0KICB9CiAgcmV0dXJuIDA7Cn0KdmFyIFJlc3BvbnNpdmVEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ4LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIF9wcm9wcyRzdHlsZSwgX3Byb3BzJHN0eWxlMjsKICB2YXIgb2JzZXJ2ZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlUmVmKShudWxsKTsKICB2YXIgW3NpemVzLCBzZXRTaXplc10gPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlU3RhdGUpKHsKICAgIGNvbnRhaW5lcldpZHRoOiBnZXROdW1iZXJPclplcm8oKF9wcm9wcyRzdHlsZSA9IHByb3BzLnN0eWxlKSA9PT0gbnVsbCB8fCBfcHJvcHMkc3R5bGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wcm9wcyRzdHlsZS53aWR0aCksCiAgICBjb250YWluZXJIZWlnaHQ6IGdldE51bWJlck9yWmVybygoX3Byb3BzJHN0eWxlMiA9IHByb3BzLnN0eWxlKSA9PT0gbnVsbCB8fCBfcHJvcHMkc3R5bGUyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfcHJvcHMkc3R5bGUyLmhlaWdodCkKICB9KTsKICB2YXIgc2V0Q29udGFpbmVyU2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKG5ld1dpZHRoLCBuZXdIZWlnaHQpID0+IHsKICAgIHNldFNpemVzKChwcmV2U3RhdGUpID0+IHsKICAgICAgdmFyIHJvdW5kZWRXaWR0aCA9IE1hdGgucm91bmQobmV3V2lkdGgpOwogICAgICB2YXIgcm91bmRlZEhlaWdodCA9IE1hdGgucm91bmQobmV3SGVpZ2h0KTsKICAgICAgaWYgKHByZXZTdGF0ZS5jb250YWluZXJXaWR0aCA9PT0gcm91bmRlZFdpZHRoICYmIHByZXZTdGF0ZS5jb250YWluZXJIZWlnaHQgPT09IHJvdW5kZWRIZWlnaHQpIHsKICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgY29udGFpbmVyV2lkdGg6IHJvdW5kZWRXaWR0aCwKICAgICAgICBjb250YWluZXJIZWlnaHQ6IHJvdW5kZWRIZWlnaHQKICAgICAgfTsKICAgIH0pOwogIH0sIFtdKTsKICB2YXIgaW5uZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChub2RlKSA9PiB7CiAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICByZWYobm9kZSk7CiAgICB9CiAgICBpZiAobm9kZSAhPSBudWxsICYmIHR5cGVvZiBSZXNpemVPYnNlcnZlciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdmFyIHsKICAgICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgsCiAgICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQKICAgICAgfSA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCk7CiAgICAgIHZhciBjYWxsYmFjayA9IChlbnRyaWVzKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgaGVpZ2h0CiAgICAgICAgfSA9IGVudHJpZXNbMF0uY29udGVudFJlY3Q7CiAgICAgICAgc2V0Q29udGFpbmVyU2l6ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgfTsKICAgICAgdmFyIG9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKGNhbGxiYWNrKTsKICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShub2RlKTsKICAgICAgb2JzZXJ2ZXJSZWYuY3VycmVudCA9IG9ic2VydmVyOwogICAgfQogIH0sIFtyZWYsIHNldENvbnRhaW5lclNpemVdKTsKICAoMCwgaW1wb3J0X3JlYWN0NDgudXNlRWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICB2YXIgb2JzZXJ2ZXIgPSBvYnNlcnZlclJlZi5jdXJyZW50OwogICAgICBpZiAob2JzZXJ2ZXIgIT0gbnVsbCkgewogICAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgICAgfQogICAgfTsKICB9LCBbc2V0Q29udGFpbmVyU2l6ZV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlYWN0MzMuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICB3aWR0aDogc2l6ZXMuY29udGFpbmVyV2lkdGgsCiAgICBoZWlnaHQ6IHNpemVzLmNvbnRhaW5lckhlaWdodAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczIyKHsKICAgIHJlZjogaW5uZXJSZWYKICB9LCBwcm9wcykpKTsKfSk7CnZhciBSZWFkU2l6ZU9uY2VEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ4LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIHZhciBbc2l6ZXMsIHNldFNpemVzXSA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VTdGF0ZSkoewogICAgY29udGFpbmVyV2lkdGg6IGdldE51bWJlck9yWmVybyh3aWR0aCksCiAgICBjb250YWluZXJIZWlnaHQ6IGdldE51bWJlck9yWmVybyhoZWlnaHQpCiAgfSk7CiAgdmFyIHNldENvbnRhaW5lclNpemUgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChuZXdXaWR0aCwgbmV3SGVpZ2h0KSA9PiB7CiAgICBzZXRTaXplcygocHJldlN0YXRlKSA9PiB7CiAgICAgIHZhciByb3VuZGVkV2lkdGggPSBNYXRoLnJvdW5kKG5ld1dpZHRoKTsKICAgICAgdmFyIHJvdW5kZWRIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCk7CiAgICAgIGlmIChwcmV2U3RhdGUuY29udGFpbmVyV2lkdGggPT09IHJvdW5kZWRXaWR0aCAmJiBwcmV2U3RhdGUuY29udGFpbmVySGVpZ2h0ID09PSByb3VuZGVkSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGNvbnRhaW5lcldpZHRoOiByb3VuZGVkV2lkdGgsCiAgICAgICAgY29udGFpbmVySGVpZ2h0OiByb3VuZGVkSGVpZ2h0CiAgICAgIH07CiAgICB9KTsKICB9LCBbXSk7CiAgdmFyIGlubmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgobm9kZSkgPT4gewogICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVmKG5vZGUpOwogICAgfQogICAgaWYgKG5vZGUgIT0gbnVsbCkgewogICAgICB2YXIgewogICAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aCwKICAgICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodAogICAgICB9ID0gbm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgc2V0Q29udGFpbmVyU2l6ZShjb250YWluZXJXaWR0aCwgY29udGFpbmVySGVpZ2h0KTsKICAgIH0KICB9LCBbcmVmLCBzZXRDb250YWluZXJTaXplXSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVhY3QzMy5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSZXBvcnRDaGFydFNpemUsIHsKICAgIHdpZHRoOiBzaXplcy5jb250YWluZXJXaWR0aCwKICAgIGhlaWdodDogc2l6ZXMuY29udGFpbmVySGVpZ2h0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoImRpdiIsIF9leHRlbmRzMjIoewogICAgcmVmOiBpbm5lclJlZgogIH0sIHByb3BzKSkpOwp9KTsKdmFyIFN0YXRpY0RpdiA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDguZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcHJvcHM7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVhY3QzMy5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSZXBvcnRDaGFydFNpemUsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoImRpdiIsIF9leHRlbmRzMjIoewogICAgcmVmCiAgfSwgcHJvcHMpKSk7Cn0pOwp2YXIgTm9uUmVzcG9uc2l2ZURpdiA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDguZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcHJvcHM7CiAgaWYgKGlzUGVyY2VudCh3aWR0aCkgfHwgaXNQZXJjZW50KGhlaWdodCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlYWRTaXplT25jZURpdiwgX2V4dGVuZHMyMih7fSwgcHJvcHMsIHsKICAgICAgcmVmCiAgICB9KSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFN0YXRpY0RpdiwgX2V4dGVuZHMyMih7fSwgcHJvcHMsIHsKICAgIHJlZgogIH0pKTsKfSk7CmZ1bmN0aW9uIGdldFdyYXBwZXJEaXZDb21wb25lbnQocmVzcG9uc2l2ZSkgewogIHJldHVybiByZXNwb25zaXZlID09PSB0cnVlID8gUmVzcG9uc2l2ZURpdiA6IE5vblJlc3BvbnNpdmVEaXY7Cn0KdmFyIFJlY2hhcnRzV3JhcHBlciA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDguZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUsCiAgICBoZWlnaHQ6IGhlaWdodEZyb21Qcm9wcywKICAgIG9uQ2xpY2ssCiAgICBvbkNvbnRleHRNZW51LAogICAgb25Eb3VibGVDbGljaywKICAgIG9uTW91c2VEb3duLAogICAgb25Nb3VzZUVudGVyLAogICAgb25Nb3VzZUxlYXZlLAogICAgb25Nb3VzZU1vdmUsCiAgICBvbk1vdXNlVXAsCiAgICBvblRvdWNoRW5kLAogICAgb25Ub3VjaE1vdmUsCiAgICBvblRvdWNoU3RhcnQsCiAgICBzdHlsZSwKICAgIHdpZHRoOiB3aWR0aEZyb21Qcm9wcywKICAgIHJlc3BvbnNpdmUsCiAgICBkaXNwYXRjaFRvdWNoRXZlbnRzID0gdHJ1ZQogIH0gPSBwcm9wczsKICB2YXIgY29udGFpbmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZVJlZikobnVsbCk7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgW3Rvb2x0aXBQb3J0YWwsIHNldFRvb2x0aXBQb3J0YWxdID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZVN0YXRlKShudWxsKTsKICB2YXIgW2xlZ2VuZFBvcnRhbCwgc2V0TGVnZW5kUG9ydGFsXSA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VTdGF0ZSkobnVsbCk7CiAgdmFyIHNldFNjYWxlUmVmID0gdXNlUmVwb3J0U2NhbGUoKTsKICB2YXIgcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9IHVzZVJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0KCk7CiAgdmFyIHdpZHRoID0gKHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IG51bGwgfHwgcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCkgPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCA6IHdpZHRoRnJvbVByb3BzOwogIHZhciBoZWlnaHQgPSAocmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gbnVsbCB8fCByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCkgPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQgOiBoZWlnaHRGcm9tUHJvcHM7CiAgdmFyIGlubmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgobm9kZSkgPT4gewogICAgc2V0U2NhbGVSZWYobm9kZSk7CiAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICByZWYobm9kZSk7CiAgICB9CiAgICBzZXRUb29sdGlwUG9ydGFsKG5vZGUpOwogICAgc2V0TGVnZW5kUG9ydGFsKG5vZGUpOwogICAgaWYgKG5vZGUgIT0gbnVsbCkgewogICAgICBjb250YWluZXJSZWYuY3VycmVudCA9IG5vZGU7CiAgICB9CiAgfSwgW3NldFNjYWxlUmVmLCByZWYsIHNldFRvb2x0aXBQb3J0YWwsIHNldExlZ2VuZFBvcnRhbF0pOwogIHZhciBteU9uQ2xpY2sgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZUNsaWNrQWN0aW9uKGUpKTsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbkNsaWNrLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbkNsaWNrXSk7CiAgdmFyIG15T25Nb3VzZUVudGVyID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VNb3ZlQWN0aW9uKGUpKTsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlRW50ZXIsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VFbnRlcl0pOwogIHZhciBteU9uTW91c2VMZWF2ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlTGVhdmVDaGFydCgpKTsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlTGVhdmUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VMZWF2ZV0pOwogIHZhciBteU9uTW91c2VNb3ZlID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VNb3ZlQWN0aW9uKGUpKTsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlTW92ZSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZU1vdmVdKTsKICB2YXIgb25Gb2N1cyA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKCkgPT4gewogICAgZGlzcGF0Y2goZm9jdXNBY3Rpb24oKSk7CiAgfSwgW2Rpc3BhdGNoXSk7CiAgdmFyIG9uS2V5RG93biA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGtleURvd25BY3Rpb24oZS5rZXkpKTsKICB9LCBbZGlzcGF0Y2hdKTsKICB2YXIgbXlPbkNvbnRleHRNZW51ID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uQ29udGV4dE1lbnUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uQ29udGV4dE1lbnVdKTsKICB2YXIgbXlPbkRvdWJsZUNsaWNrID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uRG91YmxlQ2xpY2ssCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uRG91YmxlQ2xpY2tdKTsKICB2YXIgbXlPbk1vdXNlRG93biA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlRG93biwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZURvd25dKTsKICB2YXIgbXlPbk1vdXNlVXAgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZVVwLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlVXBdKTsKICB2YXIgbXlPblRvdWNoU3RhcnQgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Ub3VjaFN0YXJ0LAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvblRvdWNoU3RhcnRdKTsKICB2YXIgbXlPblRvdWNoTW92ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGlmIChkaXNwYXRjaFRvdWNoRXZlbnRzKSB7CiAgICAgIGRpc3BhdGNoKHRvdWNoRXZlbnRBY3Rpb24oZSkpOwogICAgfQogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uVG91Y2hNb3ZlLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBkaXNwYXRjaFRvdWNoRXZlbnRzLCBvblRvdWNoTW92ZV0pOwogIHZhciBteU9uVG91Y2hFbmQgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Ub3VjaEVuZCwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Ub3VjaEVuZF0pOwogIHZhciBXcmFwcGVyRGl2ID0gZ2V0V3JhcHBlckRpdkNvbXBvbmVudChyZXNwb25zaXZlKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChUb29sdGlwUG9ydGFsQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IHRvb2x0aXBQb3J0YWwKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KExlZ2VuZFBvcnRhbENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiBsZWdlbmRQb3J0YWwKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFdyYXBwZXJEaXYsIHsKICAgIHdpZHRoOiB3aWR0aCAhPT0gbnVsbCAmJiB3aWR0aCAhPT0gdm9pZCAwID8gd2lkdGggOiBzdHlsZSA9PT0gbnVsbCB8fCBzdHlsZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3R5bGUud2lkdGgsCiAgICBoZWlnaHQ6IGhlaWdodCAhPT0gbnVsbCAmJiBoZWlnaHQgIT09IHZvaWQgMCA/IGhlaWdodCA6IHN0eWxlID09PSBudWxsIHx8IHN0eWxlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdHlsZS5oZWlnaHQsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXdyYXBwZXIiLCBjbGFzc05hbWUpLAogICAgc3R5bGU6IF9vYmplY3RTcHJlYWQzMyh7CiAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICBjdXJzb3I6ICJkZWZhdWx0IiwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSwgc3R5bGUpLAogICAgb25DbGljazogbXlPbkNsaWNrLAogICAgb25Db250ZXh0TWVudTogbXlPbkNvbnRleHRNZW51LAogICAgb25Eb3VibGVDbGljazogbXlPbkRvdWJsZUNsaWNrLAogICAgb25Gb2N1cywKICAgIG9uS2V5RG93biwKICAgIG9uTW91c2VEb3duOiBteU9uTW91c2VEb3duLAogICAgb25Nb3VzZUVudGVyOiBteU9uTW91c2VFbnRlciwKICAgIG9uTW91c2VMZWF2ZTogbXlPbk1vdXNlTGVhdmUsCiAgICBvbk1vdXNlTW92ZTogbXlPbk1vdXNlTW92ZSwKICAgIG9uTW91c2VVcDogbXlPbk1vdXNlVXAsCiAgICBvblRvdWNoRW5kOiBteU9uVG91Y2hFbmQsCiAgICBvblRvdWNoTW92ZTogbXlPblRvdWNoTW92ZSwKICAgIG9uVG91Y2hTdGFydDogbXlPblRvdWNoU3RhcnQsCiAgICByZWY6IGlubmVyUmVmCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChFdmVudFN5bmNocm9uaXplciwgbnVsbCksIGNoaWxkcmVuKSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2F0ZWdvcmljYWxDaGFydC5qcwp2YXIgX2V4Y2x1ZGVkMTcgPSBbIndpZHRoIiwgImhlaWdodCIsICJyZXNwb25zaXZlIiwgImNoaWxkcmVuIiwgImNsYXNzTmFtZSIsICJzdHlsZSIsICJjb21wYWN0IiwgInRpdGxlIiwgImRlc2MiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTcoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE3KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIENhdGVnb3JpY2FsQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ5LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmVzcG9uc2l2ZSwKICAgIGNoaWxkcmVuLAogICAgY2xhc3NOYW1lLAogICAgc3R5bGUsCiAgICBjb21wYWN0LAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNyhwcm9wcywgX2V4Y2x1ZGVkMTcpOwogIHZhciBhdHRycyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhvdGhlcnMpOwogIGlmIChjb21wYWN0KSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChSZWFjdDM0LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChSb290U3VyZmFjZSwgewogICAgICBvdGhlckF0dHJpYnV0ZXM6IGF0dHJzLAogICAgICB0aXRsZSwKICAgICAgZGVzYwogICAgfSwgY2hpbGRyZW4pKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoUmVjaGFydHNXcmFwcGVyLCB7CiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmVzcG9uc2l2ZTogcmVzcG9uc2l2ZSAhPT0gbnVsbCAmJiByZXNwb25zaXZlICE9PSB2b2lkIDAgPyByZXNwb25zaXZlIDogZmFsc2UsCiAgICBvbkNsaWNrOiBwcm9wcy5vbkNsaWNrLAogICAgb25Nb3VzZUxlYXZlOiBwcm9wcy5vbk1vdXNlTGVhdmUsCiAgICBvbk1vdXNlRW50ZXI6IHByb3BzLm9uTW91c2VFbnRlciwKICAgIG9uTW91c2VNb3ZlOiBwcm9wcy5vbk1vdXNlTW92ZSwKICAgIG9uTW91c2VEb3duOiBwcm9wcy5vbk1vdXNlRG93biwKICAgIG9uTW91c2VVcDogcHJvcHMub25Nb3VzZVVwLAogICAgb25Db250ZXh0TWVudTogcHJvcHMub25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2s6IHByb3BzLm9uRG91YmxlQ2xpY2ssCiAgICBvblRvdWNoU3RhcnQ6IHByb3BzLm9uVG91Y2hTdGFydCwKICAgIG9uVG91Y2hNb3ZlOiBwcm9wcy5vblRvdWNoTW92ZSwKICAgIG9uVG91Y2hFbmQ6IHByb3BzLm9uVG91Y2hFbmQKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFJvb3RTdXJmYWNlLCB7CiAgICBvdGhlckF0dHJpYnV0ZXM6IGF0dHJzLAogICAgdGl0bGUsCiAgICBkZXNjLAogICAgcmVmCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChDbGlwUGF0aFByb3ZpZGVyLCBudWxsLCBjaGlsZHJlbikpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhcnRlc2lhbkNoYXJ0LmpzCmZ1bmN0aW9uIF9leHRlbmRzMjMoKSB7CiAgcmV0dXJuIF9leHRlbmRzMjMgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIzLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIGRlZmF1bHRNYXJnaW4gPSB7CiAgdG9wOiA1LAogIHJpZ2h0OiA1LAogIGJvdHRvbTogNSwKICBsZWZ0OiA1Cn07CnZhciBkZWZhdWx0Q2FydGVzaWFuQ2hhcnRQcm9wcyA9IHsKICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHRydWUsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBsYXlvdXQ6ICJob3Jpem9udGFsIiwKICBtYXJnaW46IGRlZmF1bHRNYXJnaW4sCiAgcmVzcG9uc2l2ZTogZmFsc2UsCiAgcmV2ZXJzZVN0YWNrT3JkZXI6IGZhbHNlLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgc3luY01ldGhvZDogImluZGV4Igp9Owp2YXIgQ2FydGVzaWFuQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUwLmZvcndhcmRSZWYpKGZ1bmN0aW9uIENhcnRlc2lhbkNoYXJ0Mihwcm9wcywgcmVmKSB7CiAgdmFyIF9jYXRlZ29yaWNhbENoYXJ0UHJvcDsKICB2YXIgcm9vdENoYXJ0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHByb3BzLmNhdGVnb3JpY2FsQ2hhcnRQcm9wcywgZGVmYXVsdENhcnRlc2lhbkNoYXJ0UHJvcHMpOwogIHZhciB7CiAgICBjaGFydE5hbWUsCiAgICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwKICAgIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMsCiAgICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyLAogICAgY2F0ZWdvcmljYWxDaGFydFByb3BzCiAgfSA9IHByb3BzOwogIHZhciBvcHRpb25zID0gewogICAgY2hhcnROYW1lLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwKICAgIGV2ZW50RW1pdHRlcjogdm9pZCAwCiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzUuY3JlYXRlRWxlbWVudChSZWNoYXJ0c1N0b3JlUHJvdmlkZXIsIHsKICAgIHByZWxvYWRlZFN0YXRlOiB7CiAgICAgIG9wdGlvbnMKICAgIH0sCiAgICByZWR1eFN0b3JlTmFtZTogKF9jYXRlZ29yaWNhbENoYXJ0UHJvcCA9IGNhdGVnb3JpY2FsQ2hhcnRQcm9wcy5pZCkgIT09IG51bGwgJiYgX2NhdGVnb3JpY2FsQ2hhcnRQcm9wICE9PSB2b2lkIDAgPyBfY2F0ZWdvcmljYWxDaGFydFByb3AgOiBjaGFydE5hbWUKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNS5jcmVhdGVFbGVtZW50KENoYXJ0RGF0YUNvbnRleHRQcm92aWRlciwgewogICAgY2hhcnREYXRhOiBjYXRlZ29yaWNhbENoYXJ0UHJvcHMuZGF0YQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNS5jcmVhdGVFbGVtZW50KFJlcG9ydE1haW5DaGFydFByb3BzLCB7CiAgICBsYXlvdXQ6IHJvb3RDaGFydFByb3BzLmxheW91dCwKICAgIG1hcmdpbjogcm9vdENoYXJ0UHJvcHMubWFyZ2luCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM1LmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRQcm9wcywgewogICAgYmFzZVZhbHVlOiByb290Q2hhcnRQcm9wcy5iYXNlVmFsdWUsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHJvb3RDaGFydFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciwKICAgIGJhckNhdGVnb3J5R2FwOiByb290Q2hhcnRQcm9wcy5iYXJDYXRlZ29yeUdhcCwKICAgIG1heEJhclNpemU6IHJvb3RDaGFydFByb3BzLm1heEJhclNpemUsCiAgICBzdGFja09mZnNldDogcm9vdENoYXJ0UHJvcHMuc3RhY2tPZmZzZXQsCiAgICBiYXJHYXA6IHJvb3RDaGFydFByb3BzLmJhckdhcCwKICAgIGJhclNpemU6IHJvb3RDaGFydFByb3BzLmJhclNpemUsCiAgICBzeW5jSWQ6IHJvb3RDaGFydFByb3BzLnN5bmNJZCwKICAgIHN5bmNNZXRob2Q6IHJvb3RDaGFydFByb3BzLnN5bmNNZXRob2QsCiAgICBjbGFzc05hbWU6IHJvb3RDaGFydFByb3BzLmNsYXNzTmFtZSwKICAgIHJldmVyc2VTdGFja09yZGVyOiByb290Q2hhcnRQcm9wcy5yZXZlcnNlU3RhY2tPcmRlcgogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNS5jcmVhdGVFbGVtZW50KENhdGVnb3JpY2FsQ2hhcnQsIF9leHRlbmRzMjMoe30sIHJvb3RDaGFydFByb3BzLCB7CiAgICByZWYKICB9KSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQXJlYUNoYXJ0LmpzCnZhciBSZWFjdDM2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NTEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBhbGxvd2VkVG9vbHRpcFR5cGVzID0gWyJheGlzIl07CnZhciBBcmVhQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUxLmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM2LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuQ2hhcnQsIHsKICAgIGNoYXJ0TmFtZTogIkFyZWFDaGFydCIsCiAgICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTogImF4aXMiLAogICAgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlczogYWxsb3dlZFRvb2x0aXBUeXBlcywKICAgIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXI6IGFycmF5VG9vbHRpcFNlYXJjaGVyLAogICAgY2F0ZWdvcmljYWxDaGFydFByb3BzOiBwcm9wcywKICAgIHJlZgogIH0pOwp9KTsKCi8vIHNyYy9jb21wb25lbnQudHN4CnZhciBpbXBvcnRfanN4X3J1bnRpbWUgPSBfX3RvRVNNKHJlcXVpcmVfanN4X3J1bnRpbWUoKSwgMSk7CnZhciBDT0xPUlMgPSB7CiAgcHJpbWFyeTogIiM1NkM1OTYiLAogIC8vIE1pbnQgR3JlZW4KICBwcmltYXJ5RGFyazogIiMzYWE4N2IiLAogIGJnOiAiI0ZBRkFGQSIsCiAgY2FyZDogIiNGRkZGRkYiLAogIHRleHRNYWluOiAiIzFBMUExQSIsCiAgdGV4dFNlY29uZGFyeTogIiM5Q0EzQUYiLAogIGJvcmRlcjogIiNGM0Y0RjYiLAogIGlucHV0Qmc6ICIjRjlGQUZCIiwKICBhY2NlbnRMaWdodDogIiNFNkY3RjAiLAogIGJsdWU6ICIjNUQ5Q0VDIiwKICB5ZWxsb3c6ICIjRjU5RTBCIiwKICByZWQ6ICIjRkY2QjZCIiwKICBvcmFuZ2U6ICIjRjI5OTRBIiwKICBvcmFuZ2VMaWdodDogIiNGRkY3RUQiLAogIHNhdmVHcmVlbjogIiM0RDdDMEYiLAogIHRhYmxlSGVhZGVyOiAiIzI1NjNFQiIKfTsKdmFyIE51bWJlckNvbnRyb2wgPSAoewogIHZhbHVlLAogIG9uQ2hhbmdlLAogIG1pbjogbWluMiA9IDAsCiAgbWF4OiBtYXgyID0gMWU3LAogIHN0ZXAgPSAxLAogIGxhYmVsLAogIHN1ZmZpeDogc3VmZml4MiwKICBwcmVmaXgKfSkgPT4gewogIGNvbnN0IGhhbmRsZURlYyA9ICgpID0+IHsKICAgIGNvbnN0IG51bSA9IHBhcnNlRmxvYXQodmFsdWUpIHx8IDA7CiAgICBpZiAobnVtIC0gc3RlcCA+PSBtaW4yKSBvbkNoYW5nZShNYXRoLnJvdW5kKChudW0gLSBzdGVwKSAqIDEwMCkgLyAxMDAgKyAiIik7CiAgfTsKICBjb25zdCBoYW5kbGVJbmMgPSAoKSA9PiB7CiAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHZhbHVlKSB8fCAwOwogICAgaWYgKG51bSArIHN0ZXAgPD0gbWF4Mikgb25DaGFuZ2UoTWF0aC5yb3VuZCgobnVtICsgc3RlcCkgKiAxMDApIC8gMTAwICsgIiIpOwogIH07CiAgY29uc3QgaGFuZGxlQ2hhbmdlID0gKGUpID0+IHsKICAgIGNvbnN0IHJhdyA9IGUudGFyZ2V0LnZhbHVlLnJlcGxhY2UoLywvZywgIiIpOwogICAgY29uc3QgdmFsID0gcmF3LnJlcGxhY2UoL1teMC05Ll0vZywgIiIpOwogICAgb25DaGFuZ2UodmFsKTsKICB9OwogIGNvbnN0IGJ0blN0eWxlID0gewogICAgd2lkdGg6ICIzMnB4IiwKICAgIGhlaWdodDogIjMycHgiLAogICAgYm9yZGVyUmFkaXVzOiAiOHB4IiwKICAgIGJvcmRlcjogIm5vbmUiLAogICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgY29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgZGlzcGxheTogImZsZXgiLAogICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgIGJveFNoYWRvdzogIjAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMDUpIgogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLAogICAgYm9yZGVyUmFkaXVzOiAiMTJweCIsCiAgICBwYWRkaW5nOiAiNnB4IiwKICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICAgIGdhcDogIjhweCIsCiAgICBoZWlnaHQ6ICI0NHB4IgogIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZURlYywgc3R5bGU6IGJ0blN0eWxlLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShNaW51cywgeyBzaXplOiAxNiwgc3Ryb2tlV2lkdGg6IDMgfSkgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxLCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGdhcDogIjRweCIgfSwgY2hpbGRyZW46IFsKICAgICAgcHJlZml4ICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMTZweCIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogcHJlZml4IH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICJpbnB1dCIsCiAgICAgICAgewogICAgICAgICAgdHlwZTogInRleHQiLAogICAgICAgICAgdmFsdWU6IHZhbHVlID8gTnVtYmVyKHZhbHVlKS50b0xvY2FsZVN0cmluZygpIDogIiIsCiAgICAgICAgICBvbkNoYW5nZTogaGFuZGxlQ2hhbmdlLAogICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgIHRleHRBbGlnbjogImNlbnRlciIsCiAgICAgICAgICAgIGZvbnRTaXplOiAiMTZweCIsCiAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDcwMCwKICAgICAgICAgICAgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwKICAgICAgICAgICAgb3V0bGluZTogIm5vbmUiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICApLAogICAgICBzdWZmaXgyICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMTRweCIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFdlaWdodDogNTAwIH0sIGNoaWxkcmVuOiBzdWZmaXgyIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVJbmMsIHN0eWxlOiBidG5TdHlsZSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGx1cywgeyBzaXplOiAxNiwgc3Ryb2tlV2lkdGg6IDMgfSkgfSkKICBdIH0pOwp9Owp2YXIgREVGQVVMVF9WQUxVRVMgPSB7CiAgY3VycmVudEFnZTogIjM1IiwKICBpbmNvbWU6ICI2MDAwMCIsCiAgc2F2aW5nczogIjMwMDAwIiwKICBjb250cmlidXRpb25zOiAiNTAwIiwKICBidWRnZXQ6ICIyNTYxIiwKICBvdGhlckluY29tZTogIjAiLAogIHJldGlyZW1lbnRBZ2U6ICI2NyIsCiAgbGlmZUV4cGVjdGFuY3k6ICI5NSIsCiAgcHJlUmV0aXJlUmF0ZTogIjciLAogIHBvc3RSZXRpcmVSYXRlOiAiNSIsCiAgaW5mbGF0aW9uOiAiMyIsCiAgaW5jb21lSW5jcmVhc2U6ICIyIiwKICBjb250cmlidXRpb25Nb2RlOiAiJCIsCiAgYnVkZ2V0TW9kZTogIiQiCn07CnZhciBTVE9SQUdFX0tFWSA9ICJSRVRJUkVNRU5UX0NBTENVTEFUT1JfREFUQSI7CnZhciBFWFBJUkFUSU9OX0RBWVMgPSAzMDsKdmFyIGxvYWRTYXZlZERhdGEgPSAoKSA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHNhdmVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVkpOwogICAgaWYgKHNhdmVkKSB7CiAgICAgIGNvbnN0IHsgZGF0YSwgdGltZXN0YW1wIH0gPSBKU09OLnBhcnNlKHNhdmVkKTsKICAgICAgY29uc3Qgbm93ID0gKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CiAgICAgIGNvbnN0IGRheXNEaWZmID0gKG5vdyAtIHRpbWVzdGFtcCkgLyAoMWUzICogNjAgKiA2MCAqIDI0KTsKICAgICAgaWYgKGRheXNEaWZmIDwgRVhQSVJBVElPTl9EQVlTKSB7CiAgICAgICAgY29uc3QgbWVyZ2VkID0gewogICAgICAgICAgIlJldGlyZW1lbnQgQ2FsY3VsYXRvciI6IHsgdmFsdWVzOiB7IC4uLkRFRkFVTFRfVkFMVUVTIH0sIHRvdWNoZWQ6IHt9LCByZXN1bHQ6IG51bGwgfQogICAgICAgIH07CiAgICAgICAgaWYgKGRhdGFbIlJldGlyZW1lbnQgQ2FsY3VsYXRvciJdKSB7CiAgICAgICAgICBtZXJnZWRbIlJldGlyZW1lbnQgQ2FsY3VsYXRvciJdID0gewogICAgICAgICAgICAuLi5tZXJnZWRbIlJldGlyZW1lbnQgQ2FsY3VsYXRvciJdLAogICAgICAgICAgICAuLi5kYXRhWyJSZXRpcmVtZW50IENhbGN1bGF0b3IiXSwKICAgICAgICAgICAgdmFsdWVzOiB7IC4uLm1lcmdlZFsiUmV0aXJlbWVudCBDYWxjdWxhdG9yIl0udmFsdWVzLCAuLi5kYXRhWyJSZXRpcmVtZW50IENhbGN1bGF0b3IiXS52YWx1ZXMgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgICAgfQogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIHNhdmVkIGRhdGEiLCBlKTsKICB9CiAgcmV0dXJuIHsKICAgICJSZXRpcmVtZW50IENhbGN1bGF0b3IiOiB7IHZhbHVlczogeyAuLi5ERUZBVUxUX1ZBTFVFUyB9LCB0b3VjaGVkOiB7fSwgcmVzdWx0OiBudWxsIH0KICB9Owp9OwpmdW5jdGlvbiBSZXRpcmVtZW50Q2FsY3VsYXRvckhlbGxvV29ybGQoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICBjb25zdCBbY2FsY3VsYXRvclR5cGUsIHNldENhbGN1bGF0b3JUeXBlXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIlJldGlyZW1lbnQgQ2FsY3VsYXRvciIpOwogIGNvbnN0IFtpc0FuYWx5emluZywgc2V0SXNBbmFseXppbmddID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2NhbGN1bGF0b3JzLCBzZXRDYWxjdWxhdG9yc10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCgpID0+IHsKICAgIGNvbnN0IGxvYWRlZCA9IGxvYWRTYXZlZERhdGEoKTsKICAgIGlmIChpbml0aWFsRGF0YTIgJiYgT2JqZWN0LmtleXMoaW5pdGlhbERhdGEyKS5sZW5ndGggPiAwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgY3VycmVudDMgPSBsb2FkZWRbIlJldGlyZW1lbnQgQ2FsY3VsYXRvciJdOwogICAgICAgIGxvYWRlZFsiUmV0aXJlbWVudCBDYWxjdWxhdG9yIl0gPSB7CiAgICAgICAgICAuLi5jdXJyZW50MywKICAgICAgICAgIHZhbHVlczogewogICAgICAgICAgICAuLi5jdXJyZW50My52YWx1ZXMsCiAgICAgICAgICAgIGN1cnJlbnRBZ2U6IGluaXRpYWxEYXRhMi5jdXJyZW50X2FnZSA/IFN0cmluZyhpbml0aWFsRGF0YTIuY3VycmVudF9hZ2UpIDogY3VycmVudDMudmFsdWVzLmN1cnJlbnRBZ2UsCiAgICAgICAgICAgIGluY29tZTogaW5pdGlhbERhdGEyLmFubnVhbF9wcmVfdGF4X2luY29tZSA/IFN0cmluZyhpbml0aWFsRGF0YTIuYW5udWFsX3ByZV90YXhfaW5jb21lKSA6IGN1cnJlbnQzLnZhbHVlcy5pbmNvbWUsCiAgICAgICAgICAgIHNhdmluZ3M6IGluaXRpYWxEYXRhMi5jdXJyZW50X3JldGlyZW1lbnRfc2F2aW5ncyA/IFN0cmluZyhpbml0aWFsRGF0YTIuY3VycmVudF9yZXRpcmVtZW50X3NhdmluZ3MpIDogY3VycmVudDMudmFsdWVzLnNhdmluZ3MsCiAgICAgICAgICAgIGNvbnRyaWJ1dGlvbnM6IGluaXRpYWxEYXRhMi5tb250aGx5X2NvbnRyaWJ1dGlvbnMgPyBTdHJpbmcoaW5pdGlhbERhdGEyLm1vbnRobHlfY29udHJpYnV0aW9ucykgOiBjdXJyZW50My52YWx1ZXMuY29udHJpYnV0aW9ucywKICAgICAgICAgICAgYnVkZ2V0OiBpbml0aWFsRGF0YTIubW9udGhseV9idWRnZXRfaW5fcmV0aXJlbWVudCA/IFN0cmluZyhpbml0aWFsRGF0YTIubW9udGhseV9idWRnZXRfaW5fcmV0aXJlbWVudCkgOiBjdXJyZW50My52YWx1ZXMuYnVkZ2V0LAogICAgICAgICAgICBvdGhlckluY29tZTogaW5pdGlhbERhdGEyLm90aGVyX3JldGlyZW1lbnRfaW5jb21lID8gU3RyaW5nKGluaXRpYWxEYXRhMi5vdGhlcl9yZXRpcmVtZW50X2luY29tZSkgOiBjdXJyZW50My52YWx1ZXMub3RoZXJJbmNvbWUsCiAgICAgICAgICAgIHJldGlyZW1lbnRBZ2U6IGluaXRpYWxEYXRhMi5yZXRpcmVtZW50X2FnZSA/IFN0cmluZyhpbml0aWFsRGF0YTIucmV0aXJlbWVudF9hZ2UpIDogY3VycmVudDMudmFsdWVzLnJldGlyZW1lbnRBZ2UsCiAgICAgICAgICAgIGxpZmVFeHBlY3RhbmN5OiBpbml0aWFsRGF0YTIubGlmZV9leHBlY3RhbmN5ID8gU3RyaW5nKGluaXRpYWxEYXRhMi5saWZlX2V4cGVjdGFuY3kpIDogY3VycmVudDMudmFsdWVzLmxpZmVFeHBlY3RhbmN5LAogICAgICAgICAgICBwcmVSZXRpcmVSYXRlOiBpbml0aWFsRGF0YTIucHJlX3JldGlyZW1lbnRfcmF0ZV9vZl9yZXR1cm4gPyBTdHJpbmcoaW5pdGlhbERhdGEyLnByZV9yZXRpcmVtZW50X3JhdGVfb2ZfcmV0dXJuKSA6IGN1cnJlbnQzLnZhbHVlcy5wcmVSZXRpcmVSYXRlLAogICAgICAgICAgICBwb3N0UmV0aXJlUmF0ZTogaW5pdGlhbERhdGEyLnBvc3RfcmV0aXJlbWVudF9yYXRlX29mX3JldHVybiA/IFN0cmluZyhpbml0aWFsRGF0YTIucG9zdF9yZXRpcmVtZW50X3JhdGVfb2ZfcmV0dXJuKSA6IGN1cnJlbnQzLnZhbHVlcy5wb3N0UmV0aXJlUmF0ZSwKICAgICAgICAgICAgaW5mbGF0aW9uOiBpbml0aWFsRGF0YTIuaW5mbGF0aW9uX3JhdGUgPyBTdHJpbmcoaW5pdGlhbERhdGEyLmluZmxhdGlvbl9yYXRlKSA6IGN1cnJlbnQzLnZhbHVlcy5pbmZsYXRpb24sCiAgICAgICAgICAgIGluY29tZUluY3JlYXNlOiBpbml0aWFsRGF0YTIuYW5udWFsX2luY29tZV9pbmNyZWFzZSA/IFN0cmluZyhpbml0aWFsRGF0YTIuYW5udWFsX2luY29tZV9pbmNyZWFzZSkgOiBjdXJyZW50My52YWx1ZXMuaW5jb21lSW5jcmVhc2UKICAgICAgICAgIH0sCiAgICAgICAgICB0b3VjaGVkOiB7fQogICAgICAgICAgLy8gUmVzZXQgdG91Y2hlZCBvbiBmcmVzaCBsb2FkCiAgICAgICAgfTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBhcHBseSBpbml0aWFsRGF0YToiLCBlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGxvYWRlZDsKICB9KTsKICBjb25zdCBbc2hvd1N1YnNjcmliZU1vZGFsLCBzZXRTaG93U3Vic2NyaWJlTW9kYWxdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2VtYWlsLCBzZXRFbWFpbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbdHVybnN0aWxlVG9rZW4sIHNldFR1cm5zdGlsZVRva2VuXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkobnVsbCk7CiAgY29uc3QgW3N1YnNjcmliZVN0YXR1cywgc2V0U3Vic2NyaWJlU3RhdHVzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoImlkbGUiKTsKICBjb25zdCBbc3Vic2NyaWJlTWVzc2FnZSwgc2V0U3Vic2NyaWJlTWVzc2FnZV0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbcGVyc29uYWxOb3Rlcywgc2V0UGVyc29uYWxOb3Rlc10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbc2hvd0ZlZWRiYWNrTW9kYWwsIHNldFNob3dGZWVkYmFja01vZGFsXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtmZWVkYmFja1RleHQsIHNldEZlZWRiYWNrVGV4dF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbZmVlZGJhY2tTdGF0dXMsIHNldEZlZWRiYWNrU3RhdHVzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoImlkbGUiKTsKICAoMCwgaW1wb3J0X3JlYWN0NTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoc2hvd1N1YnNjcmliZU1vZGFsICYmIHdpbmRvdy50dXJuc3RpbGUpIHsKICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHdpbmRvdy50dXJuc3RpbGUucmVuZGVyKCIjdHVybnN0aWxlLXdpZGdldCIsIHsKICAgICAgICAgICAgc2l0ZWtleTogd2luZG93LlRVUk5TVElMRV9TSVRFX0tFWSwKICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICAgICAgc2V0VHVybnN0aWxlVG9rZW4odG9rZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgfQogICAgICB9LCAxMDApOwogICAgfQogIH0sIFtzaG93U3Vic2NyaWJlTW9kYWxdKTsKICBjb25zdCBoYW5kbGVTdWJzY3JpYmUgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIWVtYWlsIHx8ICFlbWFpbC5pbmNsdWRlcygiQCIpKSB7CiAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsLiIpOwogICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdHVybnN0aWxlVG9rZW4pIHsKICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiUGxlYXNlIGNvbXBsZXRlIHRoZSBzZWN1cml0eSBjaGVjay4iKTsKICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJlcnJvciIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImxvYWRpbmciKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goIi9hcGkvc3Vic2NyaWJlIiwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGVtYWlsLAogICAgICAgICAgdG9waWNJZDogInJldGlyZW1lbnQtbmV3cyIsCiAgICAgICAgICB0b3BpY05hbWU6ICJSZXRpcmVtZW50IENhbGN1bGF0b3IgVXBkYXRlcyIsCiAgICAgICAgICB0dXJuc3RpbGVUb2tlbgogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICBpZiAocmVzcG9uc2Uub2sgJiYgZGF0YS5zdWNjZXNzKSB7CiAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZShkYXRhLm1lc3NhZ2UpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldEVtYWlsKCIiKTsKICAgICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiaWRsZSIpOwogICAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiIik7CiAgICAgICAgICBzZXRUdXJuc3RpbGVUb2tlbihudWxsKTsKICAgICAgICB9LCAzZTMpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKGRhdGEuZXJyb3IgfHwgIkZhaWxlZCB0byBzdWJzY3JpYmUuIik7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcigiU3Vic2NyaWJlIGVycm9yOiIsIGUpOwogICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIk5ldHdvcmsgZXJyb3IuIFBsZWFzZSB0cnkgYWdhaW4uIik7CiAgICB9CiAgfTsKICBjb25zdCBoYW5kbGVGZWVkYmFja1N1Ym1pdCA9IGFzeW5jICgpID0+IHsKICAgIGlmICghZmVlZGJhY2tUZXh0LnRyaW0oKSkgcmV0dXJuOwogICAgc2V0RmVlZGJhY2tTdGF0dXMoInN1Ym1pdHRpbmciKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goIi9hcGkvdHJhY2siLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZXZlbnQ6ICJ1c2VyX2ZlZWRiYWNrIiwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgZmVlZGJhY2s6IGZlZWRiYWNrVGV4dCwKICAgICAgICAgICAgY2FsY3VsYXRvclR5cGUKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KTsKICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoInN1Y2Nlc3MiKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldEZlZWRiYWNrVGV4dCgiIik7CiAgICAgICAgICBzZXRGZWVkYmFja1N0YXR1cygiaWRsZSIpOwogICAgICAgIH0sIDJlMyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImVycm9yIik7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcigiRmVlZGJhY2sgZXJyb3I6IiwgZSk7CiAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJlcnJvciIpOwogICAgfQogIH07CiAgKDAsIGltcG9ydF9yZWFjdDUyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgY29uc3QgZGF0YVRvU2F2ZSA9IHsKICAgICAgZGF0YTogY2FsY3VsYXRvcnMsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS5nZXRUaW1lKCkKICAgIH07CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShTVE9SQUdFX0tFWSwgSlNPTi5zdHJpbmdpZnkoZGF0YVRvU2F2ZSkpOwogIH0sIFtjYWxjdWxhdG9yc10pOwogIGNvbnN0IGN1cnJlbnRDYWxjID0gY2FsY3VsYXRvcnNbY2FsY3VsYXRvclR5cGVdOwogIGNvbnN0IHsKICAgIGN1cnJlbnRBZ2UsCiAgICBpbmNvbWUsCiAgICBzYXZpbmdzLAogICAgY29udHJpYnV0aW9ucywKICAgIGJ1ZGdldCwKICAgIG90aGVySW5jb21lLAogICAgcmV0aXJlbWVudEFnZSwKICAgIGxpZmVFeHBlY3RhbmN5LAogICAgcHJlUmV0aXJlUmF0ZSwKICAgIHBvc3RSZXRpcmVSYXRlLAogICAgaW5mbGF0aW9uLAogICAgaW5jb21lSW5jcmVhc2UsCiAgICBjb250cmlidXRpb25Nb2RlLAogICAgYnVkZ2V0TW9kZQogIH0gPSBjdXJyZW50Q2FsYy52YWx1ZXM7CiAgY29uc3QgdXBkYXRlVmFsID0gKGZpZWxkLCB2YWx1ZSkgPT4gewogICAgc2V0Q2FsY3VsYXRvcnMoKHByZXYpID0+IHsKICAgICAgY29uc3QgbmV4dCA9IHsgLi4ucHJldiB9OwogICAgICBuZXh0W2NhbGN1bGF0b3JUeXBlXSA9IHsKICAgICAgICAuLi5uZXh0W2NhbGN1bGF0b3JUeXBlXSwKICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgIC4uLm5leHRbY2FsY3VsYXRvclR5cGVdLnZhbHVlcywKICAgICAgICAgIFtmaWVsZF06IHZhbHVlCiAgICAgICAgfSwKICAgICAgICB0b3VjaGVkOiB7CiAgICAgICAgICAuLi5uZXh0W2NhbGN1bGF0b3JUeXBlXS50b3VjaGVkLAogICAgICAgICAgW2ZpZWxkXTogdHJ1ZQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIG5leHQ7CiAgICB9KTsKICB9OwogIGNvbnN0IHVwZGF0ZVJlc3VsdCA9IChyZXN1bHQpID0+IHsKICAgIHNldENhbGN1bGF0b3JzKChwcmV2KSA9PiAoewogICAgICAuLi5wcmV2LAogICAgICBbY2FsY3VsYXRvclR5cGVdOiB7CiAgICAgICAgLi4ucHJldltjYWxjdWxhdG9yVHlwZV0sCiAgICAgICAgcmVzdWx0CiAgICAgIH0KICAgIH0pKTsKICB9OwogIGNvbnN0IGNhbGN1bGF0ZVJldGlyZW1lbnQgPSAoKSA9PiB7CiAgICBjb25zdCBjdXJyZW50QWdlTnVtID0gcGFyc2VGbG9hdChjdXJyZW50QWdlKTsKICAgIGNvbnN0IHJldGlyZW1lbnRBZ2VOdW0gPSBwYXJzZUZsb2F0KHJldGlyZW1lbnRBZ2UpOwogICAgY29uc3QgbGlmZUV4cGVjdGFuY3lOdW0gPSBwYXJzZUZsb2F0KGxpZmVFeHBlY3RhbmN5KTsKICAgIGNvbnN0IGluY29tZU51bSA9IHBhcnNlRmxvYXQoaW5jb21lKTsKICAgIGxldCBzYXZpbmdzTnVtID0gcGFyc2VGbG9hdChzYXZpbmdzKTsKICAgIGlmIChpc05hTihjdXJyZW50QWdlTnVtKSB8fCBpc05hTihyZXRpcmVtZW50QWdlTnVtKSB8fCBpc05hTihpbmNvbWVOdW0pIHx8IGlzTmFOKHNhdmluZ3NOdW0pKSB7CiAgICAgIGNvbnNvbGUud2FybigiQ2FsY3VsYXRpb24gc2tpcHBlZCBkdWUgdG8gaW52YWxpZCBpbnB1dHM6IiwgeyBjdXJyZW50QWdlLCByZXRpcmVtZW50QWdlLCBpbmNvbWUsIHNhdmluZ3MgfSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHByZVJhdGUgPSBwYXJzZUZsb2F0KHByZVJldGlyZVJhdGUpIC8gMTAwOwogICAgY29uc3QgcG9zdFJhdGUgPSBwYXJzZUZsb2F0KHBvc3RSZXRpcmVSYXRlKSAvIDEwMDsKICAgIGNvbnN0IGluZmwgPSBwYXJzZUZsb2F0KGluZmxhdGlvbikgLyAxMDA7CiAgICBjb25zdCBpbmNJbmNyZWFzZSA9IHBhcnNlRmxvYXQoaW5jb21lSW5jcmVhc2UpIC8gMTAwOwogICAgY29uc3Qgbm90ZVRleHQgPSBwZXJzb25hbE5vdGVzLnRvTG93ZXJDYXNlKCk7CiAgICBsZXQgYnVkZ2V0QWRqID0gMDsKICAgIGxldCBpbmNvbWVBZGogPSAwOwogICAgbGV0IHNhdmluZ3NBZGogPSAwOwogICAgY29uc3Qgc2VudGVuY2VzID0gbm90ZVRleHQuc3BsaXQoL1suIT9dKy8pLmZpbHRlcigocykgPT4gcy50cmltKCkubGVuZ3RoID4gMCk7CiAgICBmb3IgKGNvbnN0IHNlbnRlbmNlIG9mIHNlbnRlbmNlcykgewogICAgICBjb25zdCBhbW91bnRNYXRjaCA9IHNlbnRlbmNlLm1hdGNoKC9bXCRdPyhbMC05LF0rKS8pOwogICAgICBpZiAoYW1vdW50TWF0Y2gpIHsKICAgICAgICBjb25zdCBhbW91bnQgPSBwYXJzZUZsb2F0KGFtb3VudE1hdGNoWzFdLnJlcGxhY2UoLywvZywgIiIpKTsKICAgICAgICBpZiAoIWlzTmFOKGFtb3VudCkgJiYgYW1vdW50ID4gMCkgewogICAgICAgICAgY29uc3QgaXNNb250aGx5ID0gc2VudGVuY2UuaW5jbHVkZXMoIm1vbnRoIikgfHwgc2VudGVuY2UuaW5jbHVkZXMoIi9tbyIpOwogICAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IGlzTW9udGhseSA/IDEyIDogMTsKICAgICAgICAgIGNvbnN0IGlzUmVjdXJyaW5nID0gaXNNb250aGx5IHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJ5ZWFyIikgfHwgc2VudGVuY2UuaW5jbHVkZXMoImFubnVhbCIpOwogICAgICAgICAgaWYgKGlzUmVjdXJyaW5nKSB7CiAgICAgICAgICAgIGlmIChzZW50ZW5jZS5pbmNsdWRlcygicGVuc2lvbiIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJzb2NpYWwgc2VjdXJpdHkiKSB8fCBzZW50ZW5jZS5pbmNsdWRlcygiYW5udWl0eSIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJlYXJuIikgfHwgc2VudGVuY2UuaW5jbHVkZXMoInNhbGFyeSIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJyZW50IikgfHwgc2VudGVuY2UuaW5jbHVkZXMoImluY29tZSIpKSB7CiAgICAgICAgICAgICAgaW5jb21lQWRqICs9IGFtb3VudCAqIG11bHRpcGxpZXI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2VudGVuY2UuaW5jbHVkZXMoInNhdmUiKSB8fCBzZW50ZW5jZS5pbmNsdWRlcygiY3V0IikgfHwgc2VudGVuY2UuaW5jbHVkZXMoInJlZHVjZSIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJsb3dlciIpKSB7CiAgICAgICAgICAgICAgYnVkZ2V0QWRqIC09IGFtb3VudCAqIG11bHRpcGxpZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYnVkZ2V0QWRqICs9IGFtb3VudCAqIG11bHRpcGxpZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChzZW50ZW5jZS5pbmNsdWRlcygiaW5oZXJpdCIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJnaWZ0IikgfHwgc2VudGVuY2UuaW5jbHVkZXMoInNlbGwiKSB8fCBzZW50ZW5jZS5pbmNsdWRlcygid2luZGZhbGwiKSB8fCBzZW50ZW5jZS5pbmNsdWRlcygiYm9udXMiKSB8fCBzZW50ZW5jZS5pbmNsdWRlcygicHJvZml0IikpIHsKICAgICAgICAgICAgICBzYXZpbmdzQWRqICs9IGFtb3VudDsKICAgICAgICAgICAgfSBlbHNlIGlmIChzZW50ZW5jZS5pbmNsdWRlcygiZGVidCIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJsb2FuIikgfHwgc2VudGVuY2UuaW5jbHVkZXMoIm93ZSIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJjb3N0IikgfHwgc2VudGVuY2UuaW5jbHVkZXMoImJ1eSIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJwdXJjaGFzZSIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJzcGVuZCIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJwYXkiKSB8fCBzZW50ZW5jZS5pbmNsdWRlcygiY29sbGVnZSIpIHx8IHNlbnRlbmNlLmluY2x1ZGVzKCJ3ZWRkaW5nIikgfHwgc2VudGVuY2UuaW5jbHVkZXMoInJlbm92YXRpb24iKSB8fCBzZW50ZW5jZS5pbmNsdWRlcygic3VyZ2VyeSIpKSB7CiAgICAgICAgICAgICAgc2F2aW5nc0FkaiAtPSBhbW91bnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChub3RlVGV4dC5pbmNsdWRlcygid2lmZSIpIHx8IG5vdGVUZXh0LmluY2x1ZGVzKCJodXNiYW5kIikgfHwgbm90ZVRleHQuaW5jbHVkZXMoInNwb3VzZSIpIHx8IG5vdGVUZXh0LmluY2x1ZGVzKCJzaWNrIikgfHwgbm90ZVRleHQuaW5jbHVkZXMoImNhcmUiKSB8fCBub3RlVGV4dC5pbmNsdWRlcygiZGlzYWJsZWQiKSB8fCBub3RlVGV4dC5pbmNsdWRlcygic3VwcG9ydCIpIHx8IG5vdGVUZXh0LmluY2x1ZGVzKCJtb3RoZXIiKSB8fCBub3RlVGV4dC5pbmNsdWRlcygiZmF0aGVyIikpIHsKICAgICAgYnVkZ2V0QWRqICs9IDE1MDAgKiAxMjsKICAgIH0KICAgIGNvbnN0IHllYXJzUHJlID0gcmV0aXJlbWVudEFnZU51bSAtIGN1cnJlbnRBZ2VOdW07CiAgICBjb25zdCB5ZWFyc1Bvc3QgPSBsaWZlRXhwZWN0YW5jeU51bSAtIHJldGlyZW1lbnRBZ2VOdW07CiAgICBjb25zdCBhbm51YWxFeHBlbnNlc1RvZGF5ID0gcGFyc2VGbG9hdChidWRnZXQpICogMTIgKyBidWRnZXRBZGo7CiAgICBjb25zdCBhbm51YWxJbmNvbWVUb2RheSA9IHBhcnNlRmxvYXQob3RoZXJJbmNvbWUpICogMTIgKyBpbmNvbWVBZGo7CiAgICBjb25zdCBtb250aGx5U2hvcnRmYWxsVG9kYXkgPSBNYXRoLm1heCgwLCBwYXJzZUZsb2F0KGJ1ZGdldCkgLSBwYXJzZUZsb2F0KG90aGVySW5jb21lKSk7CiAgICBjb25zdCBhbm51YWxTaG9ydGZhbGxUb2RheSA9IG1vbnRobHlTaG9ydGZhbGxUb2RheSAqIDEyOwogICAgY29uc3QgYW5udWFsU2hvcnRmYWxsQXRSZXRpcmUgPSBhbm51YWxTaG9ydGZhbGxUb2RheSAqIE1hdGgucG93KDEgKyBpbmZsLCB5ZWFyc1ByZSk7CiAgICBjb25zdCBhbm51YWxFeHBlbnNlc0F0UmV0aXJlID0gYW5udWFsRXhwZW5zZXNUb2RheSAqIE1hdGgucG93KDEgKyBpbmZsLCB5ZWFyc1ByZSk7CiAgICBjb25zdCBhbm51YWxJbmNvbWVBdFJldGlyZSA9IGFubnVhbEluY29tZVRvZGF5ICogTWF0aC5wb3coMSArIGluZmwsIHllYXJzUHJlKTsKICAgIGNvbnN0IHNhZmVXaXRoZHJhd2FsUmF0ZSA9IDAuMDQ7CiAgICBsZXQgZ3Jvc3NOZWVkQXRSZXRpcmVtZW50ID0gMDsKICAgIGxldCBpbmNvbWVWYWx1ZUF0UmV0aXJlbWVudCA9IDA7CiAgICBsZXQgbmV0TmVlZEF0UmV0aXJlbWVudCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHllYXJzUG9zdDsgaSsrKSB7CiAgICAgIGNvbnN0IHllYXJseUV4cGVuc2UgPSBhbm51YWxFeHBlbnNlc0F0UmV0aXJlICogTWF0aC5wb3coMSArIGluZmwsIGkpOwogICAgICBjb25zdCB5ZWFybHlJbmNvbWUgPSBhbm51YWxJbmNvbWVBdFJldGlyZSAqIE1hdGgucG93KDEgKyBpbmZsLCBpKTsKICAgICAgY29uc3QgeWVhcmx5U2hvcnRmYWxsID0gYW5udWFsU2hvcnRmYWxsQXRSZXRpcmUgKiBNYXRoLnBvdygxICsgaW5mbCwgaSk7CiAgICAgIGNvbnN0IGRpc2NvdW50RmFjdG9yID0gTWF0aC5wb3coMSArIHNhZmVXaXRoZHJhd2FsUmF0ZSwgaSk7CiAgICAgIGdyb3NzTmVlZEF0UmV0aXJlbWVudCArPSB5ZWFybHlFeHBlbnNlIC8gZGlzY291bnRGYWN0b3I7CiAgICAgIGluY29tZVZhbHVlQXRSZXRpcmVtZW50ICs9IHllYXJseUluY29tZSAvIGRpc2NvdW50RmFjdG9yOwogICAgICBuZXROZWVkQXRSZXRpcmVtZW50ICs9IHllYXJseVNob3J0ZmFsbCAvIGRpc2NvdW50RmFjdG9yOwogICAgfQogICAgY29uc3QgZnZTYXZpbmdzID0gc2F2aW5nc051bSAqIE1hdGgucG93KDEgKyBwcmVSYXRlLCB5ZWFyc1ByZSk7CiAgICBjb25zdCBnYXAgPSBuZXROZWVkQXRSZXRpcmVtZW50IC0gZnZTYXZpbmdzOwogICAgbGV0IGluaXRpYWxBbm51YWxDb250cmliTmVlZGVkID0gMDsKICAgIGxldCBhY2N1bUZhY3RvciA9IDA7CiAgICBmb3IgKGxldCBrID0gMDsgayA8IHllYXJzUHJlOyBrKyspIHsKICAgICAgYWNjdW1GYWN0b3IgKz0gTWF0aC5wb3coMSArIGluY0luY3JlYXNlLCBrKSAqIE1hdGgucG93KDEgKyBwcmVSYXRlLCB5ZWFyc1ByZSAtIDEgLSBrKTsKICAgIH0KICAgIGlmIChhY2N1bUZhY3RvciA+IDApIHsKICAgICAgaW5pdGlhbEFubnVhbENvbnRyaWJOZWVkZWQgPSBnYXAgLyBhY2N1bUZhY3RvcjsKICAgIH0KICAgIGxldCBhbm51YWxDb250cmliID0gcGFyc2VGbG9hdChjb250cmlidXRpb25zKTsKICAgIGlmIChjb250cmlidXRpb25Nb2RlID09PSAiJSIpIHsKICAgICAgYW5udWFsQ29udHJpYiA9IGluY29tZU51bSAqIChwYXJzZUZsb2F0KGNvbnRyaWJ1dGlvbnMpIC8gMTAwKTsKICAgIH0gZWxzZSB7CiAgICAgIGFubnVhbENvbnRyaWIgPSBhbm51YWxDb250cmliICogMTI7CiAgICB9CiAgICBjb25zdCBmdkluaXRpYWwgPSBzYXZpbmdzTnVtICogTWF0aC5wb3coMSArIHByZVJhdGUsIHllYXJzUHJlKTsKICAgIGxldCBmdkNvbnRyaWJ1dGlvbnMgPSAwOwogICAgaWYgKGNvbnRyaWJ1dGlvbk1vZGUgPT09ICIkIikgewogICAgICBmdkNvbnRyaWJ1dGlvbnMgPSBhbm51YWxDb250cmliICogKE1hdGgucG93KDEgKyBwcmVSYXRlLCB5ZWFyc1ByZSkgLSAxKSAvIHByZVJhdGU7CiAgICB9IGVsc2UgewogICAgICBpZiAoTWF0aC5hYnMocHJlUmF0ZSAtIGluY0luY3JlYXNlKSA8IDFlLTQpIHsKICAgICAgICBmdkNvbnRyaWJ1dGlvbnMgPSBhbm51YWxDb250cmliICogeWVhcnNQcmUgKiBNYXRoLnBvdygxICsgcHJlUmF0ZSwgeWVhcnNQcmUgLSAxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmdkNvbnRyaWJ1dGlvbnMgPSBhbm51YWxDb250cmliICogKE1hdGgucG93KDEgKyBwcmVSYXRlLCB5ZWFyc1ByZSkgLSBNYXRoLnBvdygxICsgaW5jSW5jcmVhc2UsIHllYXJzUHJlKSkgLyAocHJlUmF0ZSAtIGluY0luY3JlYXNlKTsKICAgICAgfQogICAgfQogICAgY29uc3Qgd2hhdFlvdUhhdmVMaXF1aWQgPSBNYXRoLnJvdW5kKGZ2SW5pdGlhbCArIGZ2Q29udHJpYnV0aW9ucyk7CiAgICBjb25zdCB0b3RhbFdlYWx0aEF0UmV0aXJlbWVudCA9IHdoYXRZb3VIYXZlTGlxdWlkICsgaW5jb21lVmFsdWVBdFJldGlyZW1lbnQgKyBzYXZpbmdzQWRqOwogICAgY29uc3QgZ3JhcGhEYXRhID0gW107CiAgICBsZXQgc2ltQ3VycmVudCA9IHNhdmluZ3NOdW07CiAgICBsZXQgc2ltSWRlYWwgPSBzYXZpbmdzTnVtOwogICAgbGV0IHNpbVNhbGFyeSA9IGluY29tZU51bTsKICAgIGxldCBzaW1DdXJyZW50Q29udHJpYiA9IGFubnVhbENvbnRyaWI7CiAgICBsZXQgc2ltSWRlYWxDb250cmliID0gTWF0aC5tYXgoMCwgaW5pdGlhbEFubnVhbENvbnRyaWJOZWVkZWQpOwogICAgbGV0IHJ1bk91dEFnZUN1cnJlbnQgPSBudWxsOwogICAgbGV0IHJ1bk91dEFnZUlkZWFsID0gbnVsbDsKICAgIGNvbnN0IHRvdGFsWWVhcnMgPSBsaWZlRXhwZWN0YW5jeU51bSAtIGN1cnJlbnRBZ2VOdW07CiAgICBmb3IgKGxldCB5ciA9IDA7IHlyIDw9IHRvdGFsWWVhcnM7IHlyKyspIHsKICAgICAgY29uc3QgYWdlID0gY3VycmVudEFnZU51bSArIHlyOwogICAgICBjb25zdCBpc1JldGlyZWQgPSBhZ2UgPiByZXRpcmVtZW50QWdlTnVtOwogICAgICBncmFwaERhdGEucHVzaCh7CiAgICAgICAgYWdlLAogICAgICAgIGN1cnJlbnQ6IE1hdGgucm91bmQoc2ltQ3VycmVudCksCiAgICAgICAgcmVjb21tZW5kZWQ6IE1hdGgucm91bmQoc2ltSWRlYWwpCiAgICAgIH0pOwogICAgICBpZiAoaXNSZXRpcmVkKSB7CiAgICAgICAgY29uc3QgeWVhcnNJbnRvUmV0aXJlbWVudCA9IGFnZSAtIHJldGlyZW1lbnRBZ2VOdW07CiAgICAgICAgY29uc3QgcGF5b3V0ID0gYW5udWFsU2hvcnRmYWxsQXRSZXRpcmUgKiBNYXRoLnBvdygxICsgaW5mbCwgeWVhcnNJbnRvUmV0aXJlbWVudCAtIDEpOwogICAgICAgIGlmIChzaW1DdXJyZW50ID4gMCkgewogICAgICAgICAgc2ltQ3VycmVudCA9IHNpbUN1cnJlbnQgKiAoMSArIHBvc3RSYXRlKSAtIHBheW91dDsKICAgICAgICAgIGlmIChzaW1DdXJyZW50IDwgMCkgewogICAgICAgICAgICBzaW1DdXJyZW50ID0gMDsKICAgICAgICAgICAgaWYgKCFydW5PdXRBZ2VDdXJyZW50KSBydW5PdXRBZ2VDdXJyZW50ID0gYWdlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc2ltSWRlYWwgPiAwKSB7CiAgICAgICAgICBzaW1JZGVhbCA9IHNpbUlkZWFsICogKDEgKyBwb3N0UmF0ZSkgLSBwYXlvdXQ7CiAgICAgICAgICBpZiAoc2ltSWRlYWwgPCAwKSB7CiAgICAgICAgICAgIHNpbUlkZWFsID0gMDsKICAgICAgICAgICAgaWYgKCFydW5PdXRBZ2VJZGVhbCkgcnVuT3V0QWdlSWRlYWwgPSBhZ2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNpbUN1cnJlbnQgPSBzaW1DdXJyZW50ICogKDEgKyBwcmVSYXRlKSArIHNpbUN1cnJlbnRDb250cmliOwogICAgICAgIHNpbUlkZWFsID0gc2ltSWRlYWwgKiAoMSArIHByZVJhdGUpICsgc2ltSWRlYWxDb250cmliOwogICAgICAgIHNpbVNhbGFyeSAqPSAxICsgaW5jSW5jcmVhc2U7CiAgICAgICAgaWYgKGNvbnRyaWJ1dGlvbk1vZGUgPT09ICIlIikgewogICAgICAgICAgc2ltQ3VycmVudENvbnRyaWIgPSBzaW1TYWxhcnkgKiAocGFyc2VGbG9hdChjb250cmlidXRpb25zKSAvIDEwMCk7CiAgICAgICAgfQogICAgICAgIHNpbUlkZWFsQ29udHJpYiAqPSAxICsgaW5jSW5jcmVhc2U7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHdoYXRZb3VOZWVkID0gZ3Jvc3NOZWVkQXRSZXRpcmVtZW50OwogICAgdXBkYXRlUmVzdWx0KHsKICAgICAgaGF2ZTogTWF0aC5yb3VuZCh0b3RhbFdlYWx0aEF0UmV0aXJlbWVudCksCiAgICAgIG5lZWQ6IE1hdGgucm91bmQod2hhdFlvdU5lZWQpLAogICAgICBncmFwaERhdGEsCiAgICAgIHJ1bk91dEFnZUN1cnJlbnQ6IHJ1bk91dEFnZUN1cnJlbnQgfHwgbGlmZUV4cGVjdGFuY3lOdW0sCiAgICAgIHJ1bk91dEFnZUlkZWFsOiBydW5PdXRBZ2VJZGVhbCB8fCBsaWZlRXhwZWN0YW5jeU51bSwKICAgICAgbW9udGhseUNvbnRyaWJOZWVkZWQ6IE1hdGgucm91bmQoaW5pdGlhbEFubnVhbENvbnRyaWJOZWVkZWQgLyAxMiksCiAgICAgIGN1cnJlbnRNb250aGx5Q29udHJpYjogTWF0aC5yb3VuZChzaW1DdXJyZW50Q29udHJpYiAvIDEyKSwKICAgICAgbW9udGhseVNob3J0ZmFsbDogbW9udGhseVNob3J0ZmFsbFRvZGF5CiAgICB9KTsKICB9OwogIGNvbnN0IGNhbGN1bGF0ZTIgPSAoKSA9PiB7CiAgICBjYWxjdWxhdGVSZXRpcmVtZW50KCk7CiAgfTsKICAoMCwgaW1wb3J0X3JlYWN0NTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBjYWxjdWxhdGUyKCk7CiAgfSwgW2N1cnJlbnRDYWxjLnZhbHVlcywgcGVyc29uYWxOb3Rlc10pOwogIGNvbnN0IFtzaG93QWR2YW5jZWQsIHNldFNob3dBZHZhbmNlZF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbcmVzdWx0Vmlldywgc2V0UmVzdWx0Vmlld10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCJncmFwaCIpOwogIGNvbnN0IHRvZ2dsZU1vZGUgPSAoZmllbGQpID0+IHsKICAgIGNvbnN0IGN1cnJlbnQzID0gY3VycmVudENhbGMudmFsdWVzW2ZpZWxkXTsKICAgIHVwZGF0ZVZhbChmaWVsZCwgY3VycmVudDMgPT09ICIkIiA/ICIlIiA6ICIkIik7CiAgfTsKICAoMCwgaW1wb3J0X3JlYWN0NTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBjb25zdCBpbmNvbWVOdW0gPSBwYXJzZUZsb2F0KGluY29tZSk7CiAgICBpZiAoIWlzTmFOKGluY29tZU51bSkgJiYgIWN1cnJlbnRDYWxjLnRvdWNoZWQuYnVkZ2V0KSB7CiAgICAgIGNvbnN0IHN1Z2dlc3RlZEFubnVhbEJ1ZGdldCA9IGluY29tZU51bSAqIDAuNzU7CiAgICAgIGNvbnN0IHN1Z2dlc3RlZE1vbnRobHlCdWRnZXQgPSBNYXRoLnJvdW5kKHN1Z2dlc3RlZEFubnVhbEJ1ZGdldCAvIDEyKTsKICAgICAgc2V0Q2FsY3VsYXRvcnMoKHByZXYpID0+IHsKICAgICAgICBjb25zdCBuZXh0ID0geyAuLi5wcmV2IH07CiAgICAgICAgbmV4dFtjYWxjdWxhdG9yVHlwZV0gPSB7CiAgICAgICAgICAuLi5uZXh0W2NhbGN1bGF0b3JUeXBlXSwKICAgICAgICAgIHZhbHVlczogewogICAgICAgICAgICAuLi5uZXh0W2NhbGN1bGF0b3JUeXBlXS52YWx1ZXMsCiAgICAgICAgICAgIGJ1ZGdldDogU3RyaW5nKHN1Z2dlc3RlZE1vbnRobHlCdWRnZXQpCiAgICAgICAgICB9CiAgICAgICAgICAvLyBEbyBOT1QgbWFyayBhcyB0b3VjaGVkIHNvIGl0IGNvbnRpbnVlcyB0byB1cGRhdGUgdW50aWwgdXNlciBtYW51YWxseSBvdmVycmlkZXMKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXh0OwogICAgICB9KTsKICAgIH0KICB9LCBbaW5jb21lLCBjdXJyZW50Q2FsYy50b3VjaGVkLmJ1ZGdldCwgY2FsY3VsYXRvclR5cGVdKTsKICBjb25zdCBoYW5kbGVJbnZlc3RtZW50U3RyYXRlZ3kgPSAoc3RyYXRlZ3kpID0+IHsKICAgIGxldCBwcmUgPSAiNiI7CiAgICBsZXQgcG9zdCA9ICI1IjsKICAgIGlmIChzdHJhdGVneSA9PT0gImNvbnNlcnZhdGl2ZSIpIHsKICAgICAgcHJlID0gIjQiOwogICAgICBwb3N0ID0gIjMiOwogICAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gImFnZ3Jlc3NpdmUiKSB7CiAgICAgIHByZSA9ICI5IjsKICAgICAgcG9zdCA9ICI3IjsKICAgIH0gZWxzZSB7CiAgICAgIHByZSA9ICI3IjsKICAgICAgcG9zdCA9ICI1IjsKICAgIH0KICAgIHNldENhbGN1bGF0b3JzKChwcmV2KSA9PiB7CiAgICAgIGNvbnN0IG5leHQgPSB7IC4uLnByZXYgfTsKICAgICAgbmV4dFtjYWxjdWxhdG9yVHlwZV0gPSB7CiAgICAgICAgLi4ubmV4dFtjYWxjdWxhdG9yVHlwZV0sCiAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAuLi5uZXh0W2NhbGN1bGF0b3JUeXBlXS52YWx1ZXMsCiAgICAgICAgICBwcmVSZXRpcmVSYXRlOiBwcmUsCiAgICAgICAgICBwb3N0UmV0aXJlUmF0ZTogcG9zdAogICAgICAgIH0sCiAgICAgICAgdG91Y2hlZDogewogICAgICAgICAgLi4ubmV4dFtjYWxjdWxhdG9yVHlwZV0udG91Y2hlZCwKICAgICAgICAgIHByZVJldGlyZVJhdGU6IHRydWUsCiAgICAgICAgICBwb3N0UmV0aXJlUmF0ZTogdHJ1ZQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIG5leHQ7CiAgICB9KTsKICB9OwogIGNvbnN0IHJlc2V0VG9EZWZhdWx0cyA9ICgpID0+IHsKICAgIHNldENhbGN1bGF0b3JzKChwcmV2KSA9PiB7CiAgICAgIGNvbnN0IG5leHQgPSB7IC4uLnByZXYgfTsKICAgICAgbmV4dFtjYWxjdWxhdG9yVHlwZV0gPSB7CiAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAuLi5ERUZBVUxUX1ZBTFVFUywKICAgICAgICAgIHByZVJldGlyZVJhdGU6ICI3IiwKICAgICAgICAgIC8vIE1vZGVyYXRlIGludmVzdG1lbnQgc3RyYXRlZ3kKICAgICAgICAgIHBvc3RSZXRpcmVSYXRlOiAiNSIKICAgICAgICB9LAogICAgICAgIHRvdWNoZWQ6IHt9LAogICAgICAgIHJlc3VsdDogbnVsbAogICAgICB9OwogICAgICByZXR1cm4gbmV4dDsKICAgIH0pOwogICAgc2V0VHJhdmVsUGxhbigibW9kZXJhdGUiKTsKICAgIHNldEZhbWlseVBsYW4oIm5vbmUiKTsKICAgIHNldEhlbHBXaXRoQ29sbGVnZShmYWxzZSk7CiAgICBzZXRTYXZpbmdzRGV0YWlscyh7IHNhdmluZ3M6ICIiLCBjaGVja2luZzogIiIsIGNyeXB0bzogIiIsIHJldGlyZW1lbnQ6ICIiLCBzdG9ja1BvcnRmb2xpbzogIiIgfSk7CiAgICBzZXRJbmNvbWVEZXRhaWxzKHsgc29jaWFsU2VjdXJpdHk6ICIiLCByZWFsRXN0YXRlOiAiIiwgdHJ1c3Q6ICIiLCBpbnZlc3RtZW50czogIiIsIG90aGVyOiAiIiB9KTsKICB9OwogIGNvbnN0IFt0cmF2ZWxQbGFuLCBzZXRUcmF2ZWxQbGFuXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIm1vZGVyYXRlIik7CiAgY29uc3QgW2ZhbWlseVBsYW4sIHNldEZhbWlseVBsYW5dID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgibm9uZSIpOwogIGNvbnN0IFtoZWxwV2l0aENvbGxlZ2UsIHNldEhlbHBXaXRoQ29sbGVnZV0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBnZXRUcmF2ZWxDb3N0ID0gKHBsYW4pID0+IHsKICAgIGlmIChwbGFuID09PSAibG93IikgcmV0dXJuIDIwMDsKICAgIGlmIChwbGFuID09PSAibW9kZXJhdGUiKSByZXR1cm4gODAwOwogICAgcmV0dXJuIDI1MDA7CiAgfTsKICBjb25zdCBoYW5kbGVUcmF2ZWxQbGFuQ2hhbmdlID0gKG5ld1BsYW4pID0+IHsKICAgIGNvbnN0IG9sZENvc3QgPSBnZXRUcmF2ZWxDb3N0KHRyYXZlbFBsYW4pOwogICAgY29uc3QgbmV3Q29zdCA9IGdldFRyYXZlbENvc3QobmV3UGxhbik7CiAgICBjb25zdCBkaWZmID0gbmV3Q29zdCAtIG9sZENvc3Q7CiAgICBjb25zdCBjdXJyZW50QnVkZ2V0ID0gcGFyc2VGbG9hdChidWRnZXQpIHx8IDA7CiAgICBjb25zdCBuZXdCdWRnZXQgPSBNYXRoLm1heCgwLCBjdXJyZW50QnVkZ2V0ICsgZGlmZik7CiAgICBzZXRUcmF2ZWxQbGFuKG5ld1BsYW4pOwogICAgdXBkYXRlVmFsKCJidWRnZXQiLCBTdHJpbmcoTWF0aC5yb3VuZChuZXdCdWRnZXQpKSk7CiAgfTsKICBjb25zdCBnZXRGYW1pbHlDb3N0ID0gKHBsYW4pID0+IHsKICAgIGlmIChwbGFuID09PSAibm9uZSIpIHJldHVybiAwOwogICAgaWYgKHBsYW4gPT09ICJzbWFsbCIpIHJldHVybiAzMDA7CiAgICByZXR1cm4gNjAwOwogIH07CiAgY29uc3QgZ2V0Q29sbGVnZUNvbnRyaWJSZWR1Y3Rpb24gPSAocGxhbikgPT4gewogICAgaWYgKHBsYW4gPT09ICJub25lIikgcmV0dXJuIDA7CiAgICBpZiAocGxhbiA9PT0gInNtYWxsIikgcmV0dXJuIDQwMDsKICAgIHJldHVybiA4MDA7CiAgfTsKICBjb25zdCBoYW5kbGVGYW1pbHlQbGFuQ2hhbmdlID0gKG5ld1BsYW4pID0+IHsKICAgIGNvbnN0IG9sZENvc3QgPSBnZXRGYW1pbHlDb3N0KGZhbWlseVBsYW4pOwogICAgY29uc3QgbmV3Q29zdCA9IGdldEZhbWlseUNvc3QobmV3UGxhbik7CiAgICBjb25zdCBidWRnZXREaWZmID0gbmV3Q29zdCAtIG9sZENvc3Q7CiAgICBjb25zdCBjdXJyZW50QnVkZ2V0ID0gcGFyc2VGbG9hdChidWRnZXQpIHx8IDA7CiAgICBjb25zdCBuZXdCdWRnZXQgPSBNYXRoLm1heCgwLCBjdXJyZW50QnVkZ2V0ICsgYnVkZ2V0RGlmZik7CiAgICBpZiAoaGVscFdpdGhDb2xsZWdlKSB7CiAgICAgIGNvbnN0IG9sZFJlZHVjdGlvbiA9IGdldENvbGxlZ2VDb250cmliUmVkdWN0aW9uKGZhbWlseVBsYW4pOwogICAgICBjb25zdCBuZXdSZWR1Y3Rpb24gPSBnZXRDb2xsZWdlQ29udHJpYlJlZHVjdGlvbihuZXdQbGFuKTsKICAgICAgY29uc3QgY29udHJpYkRpZmYgPSBuZXdSZWR1Y3Rpb24gLSBvbGRSZWR1Y3Rpb247CiAgICAgIGNvbnN0IGN1cnJlbnRDb250cmliID0gcGFyc2VGbG9hdChjb250cmlidXRpb25zKSB8fCAwOwogICAgICB1cGRhdGVWYWwoImNvbnRyaWJ1dGlvbnMiLCBTdHJpbmcoTWF0aC5tYXgoMCwgTWF0aC5yb3VuZChjdXJyZW50Q29udHJpYiAtIGNvbnRyaWJEaWZmKSkpKTsKICAgIH0KICAgIHNldEZhbWlseVBsYW4obmV3UGxhbik7CiAgICB1cGRhdGVWYWwoImJ1ZGdldCIsIFN0cmluZyhNYXRoLnJvdW5kKG5ld0J1ZGdldCkpKTsKICB9OwogIGNvbnN0IGhhbmRsZUNvbGxlZ2VUb2dnbGUgPSAoY2hlY2tlZCkgPT4gewogICAgY29uc3QgcmVkdWN0aW9uID0gZ2V0Q29sbGVnZUNvbnRyaWJSZWR1Y3Rpb24oZmFtaWx5UGxhbik7CiAgICBjb25zdCBjdXJyZW50Q29udHJpYiA9IHBhcnNlRmxvYXQoY29udHJpYnV0aW9ucykgfHwgMDsKICAgIGlmIChjaGVja2VkKSB7CiAgICAgIHVwZGF0ZVZhbCgiY29udHJpYnV0aW9ucyIsIFN0cmluZyhNYXRoLm1heCgwLCBNYXRoLnJvdW5kKGN1cnJlbnRDb250cmliIC0gcmVkdWN0aW9uKSkpKTsKICAgIH0gZWxzZSB7CiAgICAgIHVwZGF0ZVZhbCgiY29udHJpYnV0aW9ucyIsIFN0cmluZyhNYXRoLnJvdW5kKGN1cnJlbnRDb250cmliICsgcmVkdWN0aW9uKSkpOwogICAgfQogICAgc2V0SGVscFdpdGhDb2xsZWdlKGNoZWNrZWQpOwogIH07CiAgY29uc3QgYXBwbHlTbWFydEJ1ZGdldCA9ICgpID0+IHsKICAgIGNvbnN0IGluY29tZU51bSA9IHBhcnNlRmxvYXQoaW5jb21lKTsKICAgIGlmICghaXNOYU4oaW5jb21lTnVtKSkgewogICAgICBjb25zdCBzdWdnZXN0ZWQgPSBNYXRoLnJvdW5kKGluY29tZU51bSAqIDAuNzUgLyAxMik7CiAgICAgIHVwZGF0ZVZhbCgiYnVkZ2V0IiwgU3RyaW5nKHN1Z2dlc3RlZCkpOwogICAgfQogIH07CiAgY29uc3QgW3NhdmluZ3NEZXRhaWxzLCBzZXRTYXZpbmdzRGV0YWlsc10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKHsKICAgIHNhdmluZ3M6ICIiLAogICAgY2hlY2tpbmc6ICIiLAogICAgY3J5cHRvOiAiIiwKICAgIHJldGlyZW1lbnQ6ICIiLAogICAgc3RvY2tQb3J0Zm9saW86ICIiCiAgfSk7CiAgY29uc3QgW3Nob3dTYXZpbmdzTW9kYWwsIHNldFNob3dTYXZpbmdzTW9kYWxdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2luY29tZURldGFpbHMsIHNldEluY29tZURldGFpbHNdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSh7CiAgICBzb2NpYWxTZWN1cml0eTogIiIsCiAgICByZWFsRXN0YXRlOiAiIiwKICAgIHRydXN0OiAiIiwKICAgIGludmVzdG1lbnRzOiAiIiwKICAgIG90aGVyOiAiIgogIH0pOwogIGNvbnN0IFtzaG93SW5jb21lTW9kYWwsIHNldFNob3dJbmNvbWVNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCB1cGRhdGVTYXZpbmdzVG90YWwgPSAoZGV0YWlscykgPT4gewogICAgY29uc3QgdG90YWwgPSBbCiAgICAgIGRldGFpbHMuc2F2aW5ncywKICAgICAgZGV0YWlscy5jaGVja2luZywKICAgICAgZGV0YWlscy5jcnlwdG8sCiAgICAgIGRldGFpbHMucmV0aXJlbWVudCwKICAgICAgZGV0YWlscy5zdG9ja1BvcnRmb2xpbwogICAgXS5yZWR1Y2UoKGFjYywgdmFsKSA9PiBhY2MgKyAocGFyc2VGbG9hdCh2YWwpIHx8IDApLCAwKTsKICAgIHVwZGF0ZVZhbCgic2F2aW5ncyIsIFN0cmluZyh0b3RhbCkpOwogIH07CiAgY29uc3QgaGFuZGxlU2F2aW5nc0RldGFpbENoYW5nZSA9IChmaWVsZCwgdmFsdWUpID0+IHsKICAgIGNvbnN0IG5ld0RldGFpbHMgPSB7IC4uLnNhdmluZ3NEZXRhaWxzLCBbZmllbGRdOiB2YWx1ZSB9OwogICAgc2V0U2F2aW5nc0RldGFpbHMobmV3RGV0YWlscyk7CiAgICB1cGRhdGVTYXZpbmdzVG90YWwobmV3RGV0YWlscyk7CiAgfTsKICBjb25zdCB1cGRhdGVJbmNvbWVUb3RhbCA9IChkZXRhaWxzKSA9PiB7CiAgICBjb25zdCB0b3RhbCA9IFsKICAgICAgZGV0YWlscy5zb2NpYWxTZWN1cml0eSwKICAgICAgZGV0YWlscy5yZWFsRXN0YXRlLAogICAgICBkZXRhaWxzLnRydXN0LAogICAgICBkZXRhaWxzLmludmVzdG1lbnRzLAogICAgICBkZXRhaWxzLm90aGVyCiAgICBdLnJlZHVjZSgoYWNjLCB2YWwpID0+IGFjYyArIChwYXJzZUZsb2F0KHZhbCkgfHwgMCksIDApOwogICAgdXBkYXRlVmFsKCJvdGhlckluY29tZSIsIFN0cmluZyh0b3RhbCkpOwogIH07CiAgY29uc3QgaGFuZGxlSW5jb21lRGV0YWlsQ2hhbmdlID0gKGZpZWxkLCB2YWx1ZSkgPT4gewogICAgY29uc3QgbmV3RGV0YWlscyA9IHsgLi4uaW5jb21lRGV0YWlscywgW2ZpZWxkXTogdmFsdWUgfTsKICAgIHNldEluY29tZURldGFpbHMobmV3RGV0YWlscyk7CiAgICB1cGRhdGVJbmNvbWVUb3RhbChuZXdEZXRhaWxzKTsKICB9OwogIGNvbnN0IGhhbmRsZUVzdGltYXRlU29jaWFsU2VjdXJpdHkgPSAoKSA9PiB7CiAgICBjb25zdCBhbm51YWxJbmNvbWUgPSBwYXJzZUZsb2F0KGluY29tZSkgfHwgMDsKICAgIGNvbnN0IGVzdGltYXRlZCA9IE1hdGgubWluKE1hdGgucm91bmQoYW5udWFsSW5jb21lICogMC40IC8gMTIpLCAzODAwKTsKICAgIGNvbnN0IG5ld0RldGFpbHMgPSB7IC4uLmluY29tZURldGFpbHMsIHNvY2lhbFNlY3VyaXR5OiBTdHJpbmcoZXN0aW1hdGVkKSB9OwogICAgc2V0SW5jb21lRGV0YWlscyhuZXdEZXRhaWxzKTsKICAgIHVwZGF0ZUluY29tZVRvdGFsKG5ld0RldGFpbHMpOwogIH07CiAgY29uc3QgZ2VuZXJhdGVUaXBzID0gKCkgPT4gewogICAgaWYgKCFjdXJyZW50Q2FsYy5yZXN1bHQpIHJldHVybiBbXTsKICAgIGNvbnN0IHRpcHMgPSBbXTsKICAgIGNvbnN0IHsgaGF2ZSwgbmVlZCwgbW9udGhseUNvbnRyaWJOZWVkZWQsIGN1cnJlbnRNb250aGx5Q29udHJpYiB9ID0gY3VycmVudENhbGMucmVzdWx0OwogICAgY29uc3Qgc2hvcnRmYWxsID0gbmVlZCAtIGhhdmU7CiAgICBjb25zdCBpbmNvbWVOdW0gPSBwYXJzZUZsb2F0KGluY29tZSk7CiAgICBpZiAoc2hvcnRmYWxsID4gMCkgewogICAgICB0aXBzLnB1c2goewogICAgICAgIHRpdGxlOiAiSW5jcmVhc2UgTW9udGhseSBTYXZpbmdzIiwKICAgICAgICBkZXNjOiBgWW91IGFyZSBzYXZpbmcgJCR7Y3VycmVudE1vbnRobHlDb250cmliLnRvTG9jYWxlU3RyaW5nKCl9L21vLiBUbyByZWFjaCB5b3VyIGdvYWwsIGFpbSBmb3IgJCR7bW9udGhseUNvbnRyaWJOZWVkZWQudG9Mb2NhbGVTdHJpbmcoKX0vbW8gKCskJHsobW9udGhseUNvbnRyaWJOZWVkZWQgLSBjdXJyZW50TW9udGhseUNvbnRyaWIpLnRvTG9jYWxlU3RyaW5nKCl9KS5gLAogICAgICAgIGljb246ICJcdXsxRjRCMH0iLAogICAgICAgIHByaW9yaXR5OiAiaGlnaCIKICAgICAgfSk7CiAgICB9CiAgICBpZiAoaW5jb21lTnVtID4gMCkgewogICAgICBjb25zdCBjdXJyZW50UmF0ZSA9IGN1cnJlbnRNb250aGx5Q29udHJpYiAqIDEyIC8gaW5jb21lTnVtOwogICAgICBjb25zdCB0YXJnZXRSYXRlID0gMC4xNTsKICAgICAgaWYgKGN1cnJlbnRSYXRlIDwgdGFyZ2V0UmF0ZSkgewogICAgICAgIGNvbnN0IHRhcmdldE1vbnRobHkgPSBNYXRoLnJvdW5kKGluY29tZU51bSAqIHRhcmdldFJhdGUgLyAxMik7CiAgICAgICAgdGlwcy5wdXNoKHsKICAgICAgICAgIHRpdGxlOiAiQm9vc3QgWW91ciBTYXZpbmdzIFJhdGUiLAogICAgICAgICAgZGVzYzogYFlvdXIgc2F2aW5ncyByYXRlIGlzICR7KGN1cnJlbnRSYXRlICogMTAwKS50b0ZpeGVkKDEpfSUuIEV4cGVydHMgcmVjb21tZW5kIDE1JSAoJCR7dGFyZ2V0TW9udGhseS50b0xvY2FsZVN0cmluZygpfS9tbykgZm9yIGEgc2VjdXJlIHJldGlyZW1lbnQuYCwKICAgICAgICAgIGljb246ICJcdXsxRjRDOH0iLAogICAgICAgICAgcHJpb3JpdHk6ICJoaWdoIgogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICBjb25zdCBidWRnZXROdW0gPSBwYXJzZUZsb2F0KGJ1ZGdldCk7CiAgICBpZiAoaW5jb21lTnVtID4gMCAmJiBidWRnZXROdW0gKiAxMiA+IGluY29tZU51bSAqIDAuODUpIHsKICAgICAgY29uc3QgdGFyZ2V0QnVkZ2V0ID0gTWF0aC5yb3VuZChpbmNvbWVOdW0gKiAwLjggLyAxMik7CiAgICAgIHRpcHMucHVzaCh7CiAgICAgICAgdGl0bGU6ICJSZXZpZXcgUmV0aXJlbWVudCBCdWRnZXQiLAogICAgICAgIGRlc2M6IGBZb3VyIHBsYW5uZWQgc3BlbmRpbmcgKCQke2J1ZGdldE51bS50b0xvY2FsZVN0cmluZygpfS9tbykgaXMgaGlnaCByZWxhdGl2ZSB0byB5b3VyIGluY29tZS4gUmVkdWNpbmcgaXQgdG8gfiQke3RhcmdldEJ1ZGdldC50b0xvY2FsZVN0cmluZygpfS9tbyB3b3VsZCBkcmFzdGljYWxseSBsb3dlciB5b3VyIHNhdmluZ3MgdGFyZ2V0LmAsCiAgICAgICAgaWNvbjogIlx1ezFGNEM5fSIsCiAgICAgICAgcHJpb3JpdHk6ICJtZWRpdW0iCiAgICAgIH0pOwogICAgfQogICAgaWYgKHNob3J0ZmFsbCA+IDAgJiYgKHByZVJldGlyZVJhdGUgPT09ICI0IiB8fCBwcmVSZXRpcmVSYXRlID09PSAiNiIpKSB7CiAgICAgIHRpcHMucHVzaCh7CiAgICAgICAgdGl0bGU6ICJPcHRpbWl6ZSBBc3NldCBBbGxvY2F0aW9uIiwKICAgICAgICBkZXNjOiAiWW91ciA0LTYlIHJldHVybiBhc3N1bXB0aW9uIGlzIGNvbnNlcnZhdGl2ZS4gQSBiYWxhbmNlZCBwb3J0Zm9saW8gKDYwLzQwIHN0b2Nrcy9ib25kcykgaGlzdG9yaWNhbGx5IHJldHVybnMgfjctOCUgb3ZlciBsb25nIHBlcmlvZHMuIiwKICAgICAgICBpY29uOiAiXHV7MUY0Q0F9IiwKICAgICAgICBwcmlvcml0eTogIm1lZGl1bSIKICAgICAgfSk7CiAgICB9CiAgICBpZiAoc2hvcnRmYWxsID4gMCAmJiBwYXJzZUludChyZXRpcmVtZW50QWdlKSA8IDY3KSB7CiAgICAgIHRpcHMucHVzaCh7CiAgICAgICAgdGl0bGU6ICJDb25zaWRlciBEZWxheWluZyBSZXRpcmVtZW50IiwKICAgICAgICBkZXNjOiBgUmV0aXJpbmcgYXQgJHtwYXJzZUludChyZXRpcmVtZW50QWdlKSArIDJ9IGluc3RlYWQgb2YgJHtyZXRpcmVtZW50QWdlfSBnaXZlcyB5b3VyIG1vbmV5IDIgbW9yZSB5ZWFycyB0byBncm93IGFuZCByZWR1Y2VzIHRoZSB3aXRoZHJhd2FsIHBlcmlvZC5gLAogICAgICAgIGljb246ICJcdTIzRjMiLAogICAgICAgIHByaW9yaXR5OiAibWVkaXVtIgogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGZpbGxlclRpcHMgPSBbCiAgICAgIHsKICAgICAgICB0aXRsZTogIk1heGltaXplIFRheCBBZHZhbnRhZ2VzIiwKICAgICAgICBkZXNjOiBgRW5zdXJlIHlvdSBhcmUgY29udHJpYnV0aW5nIGF0IGxlYXN0IGVub3VnaCB0byBnZXQgYW55IGVtcGxveWVyIDQwMShrKSBtYXRjaCAob2Z0ZW4gZnJlZSBtb25leSEpLmAsCiAgICAgICAgaWNvbjogIlx1ezFGM0RCfVx1RkUwRiIsCiAgICAgICAgcHJpb3JpdHk6ICJsb3ciCiAgICAgIH0sCiAgICAgIHsKICAgICAgICB0aXRsZTogIkVtZXJnZW5jeSBGdW5kIiwKICAgICAgICBkZXNjOiBgQmVmb3JlIGFnZ3Jlc3NpdmUgaW52ZXN0aW5nLCBlbnN1cmUgeW91IGhhdmUgMy02IG1vbnRocyBvZiBleHBlbnNlcyAoJCR7KGJ1ZGdldE51bSAqIDMpLnRvTG9jYWxlU3RyaW5nKCl9IC0gJCR7KGJ1ZGdldE51bSAqIDYpLnRvTG9jYWxlU3RyaW5nKCl9KSBpbiBjYXNoLmAsCiAgICAgICAgaWNvbjogIlx1ezFGNkUxfVx1RkUwRiIsCiAgICAgICAgcHJpb3JpdHk6ICJsb3ciCiAgICAgIH0sCiAgICAgIHsKICAgICAgICB0aXRsZTogIkRlYnQgTWFuYWdlbWVudCIsCiAgICAgICAgZGVzYzogIlBheSBvZmYgaGlnaC1pbnRlcmVzdCBkZWJ0ICg+NyUpIGJlZm9yZSBpbmNyZWFzaW5nIHJldGlyZW1lbnQgY29udHJpYnV0aW9ucyBmdXJ0aGVyLiIsCiAgICAgICAgaWNvbjogIlx1ezFGNEIzfSIsCiAgICAgICAgcHJpb3JpdHk6ICJsb3ciCiAgICAgIH0KICAgIF07CiAgICBsZXQgZmlsbGVySW5kZXggPSAwOwogICAgd2hpbGUgKHRpcHMubGVuZ3RoIDwgMyAmJiBmaWxsZXJJbmRleCA8IGZpbGxlclRpcHMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGlzRHVwbGljYXRlID0gdGlwcy5zb21lKCh0KSA9PiB0LnRpdGxlID09PSBmaWxsZXJUaXBzW2ZpbGxlckluZGV4XS50aXRsZSk7CiAgICAgIGlmICghaXNEdXBsaWNhdGUpIHsKICAgICAgICB0aXBzLnB1c2goZmlsbGVyVGlwc1tmaWxsZXJJbmRleF0pOwogICAgICB9CiAgICAgIGZpbGxlckluZGV4Kys7CiAgICB9CiAgICByZXR1cm4gdGlwczsKICB9OwogIGNvbnN0IHN0eWxlcyA9IHsKICAgIGNvbnRhaW5lcjogewogICAgICB3aWR0aDogIjEwMCUiLAogICAgICBtYXhXaWR0aDogIjYwMHB4IiwKICAgICAgbWFyZ2luOiAiMCBhdXRvIiwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYmcsCiAgICAgIGZvbnRGYW1pbHk6ICInSW50ZXInLCBzYW5zLXNlcmlmIiwKICAgICAgcGFkZGluZzogIjIwcHgiLAogICAgICBib3hTaXppbmc6ICJib3JkZXItYm94IgogICAgfSwKICAgIHRpdGxlOiB7CiAgICAgIGZvbnRTaXplOiAiMjhweCIsCiAgICAgIGZvbnRXZWlnaHQ6IDgwMCwKICAgICAgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwKICAgICAgbWFyZ2luQm90dG9tOiAiMTBweCIsCiAgICAgIHRleHRBbGlnbjogImxlZnQiCiAgICB9LAogICAgc3ViaGVhZGVyOiB7CiAgICAgIGZvbnRTaXplOiAiMTRweCIsCiAgICAgIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgbWFyZ2luQm90dG9tOiAiMjBweCIsCiAgICAgIG1hcmdpblRvcDogIi01cHgiCiAgICB9LAogICAgY2FyZDogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICBib3JkZXJSYWRpdXM6ICIyNHB4IiwKICAgICAgcGFkZGluZzogIjI0cHgiLAogICAgICBib3hTaGFkb3c6ICIwIDEwcHggNDBweCAtMTBweCByZ2JhKDAsMCwwLDAuMDgpIiwKICAgICAgbWFyZ2luQm90dG9tOiAiMjBweCIKICAgIH0sCiAgICByb3c6IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIsCiAgICAgIG1hcmdpbkJvdHRvbTogIjIwcHgiLAogICAgICBnYXA6ICIxNnB4IgogICAgfSwKICAgIGNvbHVtbjogewogICAgICBmbGV4OiAxLAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iCiAgICB9LAogICAgbGFiZWw6IHsKICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICBjb2xvcjogQ09MT1JTLnRleHRNYWluLAogICAgICBmb250U2l6ZTogIjE1cHgiLAogICAgICBtYXJnaW5Cb3R0b206ICIwcHgiCiAgICB9LAogICAgc3ViaGVhZGVyTGFiZWw6IHsKICAgICAgZm9udFNpemU6ICIxMnB4IiwKICAgICAgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICBmb250V2VpZ2h0OiA0MDAsCiAgICAgIG1hcmdpblRvcDogIjBweCIsCiAgICAgIG1hcmdpbkJvdHRvbTogIjhweCIsCiAgICAgIGxpbmVIZWlnaHQ6ICIxLjMiLAogICAgICBtYXhXaWR0aDogIjkwJSIKICAgIH0sCiAgICB0b2dnbGVDb250YWluZXI6IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBnYXA6ICI0cHgiLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLAogICAgICBib3JkZXJSYWRpdXM6ICI4cHgiLAogICAgICBwYWRkaW5nOiAiMnB4IiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIKICAgIH0sCiAgICB0b2dnbGVCdG46IChpc0FjdGl2ZSkgPT4gKHsKICAgICAgcGFkZGluZzogIjRweCAxMnB4IiwKICAgICAgYm9yZGVyUmFkaXVzOiAiNnB4IiwKICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgZm9udFNpemU6ICIxNHB4IiwKICAgICAgY29sb3I6IGlzQWN0aXZlID8gIndoaXRlIiA6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IGlzQWN0aXZlID8gQ09MT1JTLmJsdWUgOiAidHJhbnNwYXJlbnQiLAogICAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMnMiCiAgICB9KSwKICAgIGJ1dHRvblJvdzogewogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGdhcDogIjEycHgiLAogICAgICBtYXJnaW5Ub3A6ICIxMHB4IgogICAgfSwKICAgIGNhbGNCdXR0b246IHsKICAgICAgZmxleDogMSwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICBwYWRkaW5nOiAiMTRweCIsCiAgICAgIGJvcmRlclJhZGl1czogIjE2cHgiLAogICAgICBmb250U2l6ZTogIjE2cHgiLAogICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgIGdhcDogIjhweCIsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSg4NiwgMTk3LCAxNTAsIDAuMikiCiAgICB9LAogICAgcmVzdWx0Q2FyZDogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICBib3JkZXJSYWRpdXM6ICIyNHB4IiwKICAgICAgcGFkZGluZzogIjI0cHgiLAogICAgICBib3hTaGFkb3c6ICIwIDEwcHggNDBweCAtMTBweCByZ2JhKDAsMCwwLDAuMDgpIiwKICAgICAgbWFyZ2luVG9wOiAiMjRweCIKICAgIH0sCiAgICByZXN1bHRIZWFkZXI6IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLAogICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgbWFyZ2luQm90dG9tOiAiMjBweCIsCiAgICAgIGJvcmRlckJvdHRvbTogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgcGFkZGluZ0JvdHRvbTogIjE2cHgiCiAgICB9LAogICAgcmVzdWx0VGl0bGU6IHsKICAgICAgZm9udFNpemU6ICIxOHB4IiwKICAgICAgZm9udFdlaWdodDogNzAwLAogICAgICBjb2xvcjogQ09MT1JTLnRleHRNYWluCiAgICB9LAogICAgbGlzdDogewogICAgICBmb250U2l6ZTogIjE0cHgiLAogICAgICBsaW5lSGVpZ2h0OiAiMS44IiwKICAgICAgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLAogICAgICBwYWRkaW5nOiAiMTZweCIsCiAgICAgIGJvcmRlclJhZGl1czogIjE2cHgiCiAgICB9LAogICAgbGlzdEl0ZW06IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLAogICAgICBtYXJnaW5Cb3R0b206ICI4cHgiLAogICAgICBib3JkZXJCb3R0b206ICIxcHggZGFzaGVkICNFNUU3RUIiLAogICAgICBwYWRkaW5nQm90dG9tOiAiOHB4IgogICAgfSwKICAgIGZvb3RlcjogewogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgZ2FwOiAiMjRweCIsCiAgICAgIG1hcmdpblRvcDogIjQwcHgiLAogICAgICBwYWRkaW5nVG9wOiAiMjRweCIsCiAgICAgIGJvcmRlclRvcDogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YAogICAgfSwKICAgIGZvb3RlckJ0bjogewogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBnYXA6ICI4cHgiLAogICAgICBiYWNrZ3JvdW5kOiAibm9uZSIsCiAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICBmb250U2l6ZTogIjE0cHgiLAogICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgIHRyYW5zaXRpb246ICJjb2xvciAwLjJzIiwKICAgICAgcGFkZGluZzogIjhweCIKICAgIH0sCiAgICBzZWN0aW9uVGl0bGU6IHsKICAgICAgZm9udFNpemU6ICIyMHB4IiwKICAgICAgZm9udFdlaWdodDogNzAwLAogICAgICBjb2xvcjogQ09MT1JTLnRleHRNYWluLAogICAgICBtYXJnaW5Cb3R0b206ICIxNnB4IiwKICAgICAgcGFkZGluZ0xlZnQ6ICI0cHgiCiAgICB9LAogICAgYm90dG9tTW9kYWxPdmVybGF5OiB7CiAgICAgIHBvc2l0aW9uOiAiZml4ZWQiLAogICAgICB0b3A6IDAsCiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwLAogICAgICBib3R0b206IDAsCiAgICAgIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC41KSIsCiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgYWxpZ25JdGVtczogImZsZXgtZW5kIiwKICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICB6SW5kZXg6IDFlMywKICAgICAgcGFkZGluZzogIjIwcHgiLAogICAgICBwYWRkaW5nQm90dG9tOiAiNDBweCIKICAgIH0sCiAgICBtb2RhbE92ZXJsYXk6IHsKICAgICAgcG9zaXRpb246ICJmaXhlZCIsCiAgICAgIHRvcDogMCwKICAgICAgbGVmdDogMCwKICAgICAgcmlnaHQ6IDAsCiAgICAgIGJvdHRvbTogMCwKICAgICAgYmFja2dyb3VuZENvbG9yOiAicmdiYSgwLDAsMCwwLjUpIiwKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIsCiAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgekluZGV4OiAxZTMsCiAgICAgIHBhZGRpbmc6ICIyMHB4IiwKICAgICAgcGFkZGluZ1RvcDogIjQwcHgiLAogICAgICBvdmVyZmxvd1k6ICJhdXRvIgogICAgfSwKICAgIG1vZGFsQ29udGVudDogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgIGJvcmRlclJhZGl1czogIjI0cHgiLAogICAgICBwYWRkaW5nOiAiMjRweCIsCiAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgIG1heFdpZHRoOiAiNTYwcHgiLAogICAgICBib3hTaGFkb3c6ICIwIDIwcHggNjBweCAtMTBweCByZ2JhKDAsMCwwLDAuMikiLAogICAgICBwb3NpdGlvbjogInJlbGF0aXZlIgogICAgfSwKICAgIG1vZGFsQ2xvc2U6IHsKICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgIHRvcDogIjIwcHgiLAogICAgICByaWdodDogIjIwcHgiLAogICAgICBiYWNrZ3JvdW5kOiAibm9uZSIsCiAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICBwYWRkaW5nOiAiNHB4IgogICAgfSwKICAgIGlucHV0OiB7CiAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgIHBhZGRpbmc6ICIxMnB4IDE2cHgiLAogICAgICBib3JkZXJSYWRpdXM6ICIxMnB4IiwKICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICBmb250U2l6ZTogIjE2cHgiLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLAogICAgICBjb2xvcjogQ09MT1JTLnRleHRNYWluLAogICAgICBtYXJnaW5Cb3R0b206ICIxNnB4IiwKICAgICAgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsCiAgICAgIG91dGxpbmU6ICJub25lIgogICAgfSwKICAgIGhlYWRlclJvdzogewogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBtYXJnaW5Cb3R0b206ICIxMHB4IgogICAgfSwKICAgIHN0cmF0ZWd5QnRuOiAoYWN0aXZlKSA9PiAoewogICAgICBmbGV4OiAxLAogICAgICBwYWRkaW5nOiAiOHB4IiwKICAgICAgYm9yZGVyUmFkaXVzOiAiOHB4IiwKICAgICAgYm9yZGVyOiBhY3RpdmUgPyBgMnB4IHNvbGlkICR7Q09MT1JTLnByaW1hcnl9YCA6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgIGJhY2tncm91bmRDb2xvcjogYWN0aXZlID8gQ09MT1JTLmFjY2VudExpZ2h0IDogIndoaXRlIiwKICAgICAgY29sb3I6IGFjdGl2ZSA/IENPTE9SUy5wcmltYXJ5RGFyayA6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgIGZvbnRTaXplOiAiMTJweCIsCiAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICB0ZXh0QWxpZ246ICJjZW50ZXIiCiAgICB9KSwKICAgIHN1YnNjcmliZUJ0bjogewogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBnYXA6ICI2cHgiLAogICAgICBwYWRkaW5nOiAiOHB4IDEycHgiLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLAogICAgICBjb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgIGJvcmRlclJhZGl1czogIjhweCIsCiAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICBmb250U2l6ZTogIjEycHgiLAogICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICB0ZXh0RGVjb3JhdGlvbjogIm5vbmUiLAogICAgICB0cmFuc2l0aW9uOiAiYmFja2dyb3VuZC1jb2xvciAwLjJzIgogICAgfQogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29udGFpbmVyLCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5oZWFkZXJSb3csIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy50aXRsZSwgY2hpbGRyZW46ICJSZXRpcmVtZW50IENhbGN1bGF0b3IiIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLnN1YnNjcmliZUJ0biwgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwgb25DbGljazogKCkgPT4gc2V0U2hvd1N1YnNjcmliZU1vZGFsKHRydWUpLCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTWFpbCwgeyBzaXplOiAxNCB9KSwKICAgICAgICAiU3Vic2NyaWJlIgogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN1YmhlYWRlciwgY2hpbGRyZW46ICJQbGFuIHlvdXIgZmluYW5jaWFsIGZ1dHVyZS4iIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5jYXJkLCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJvdywgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5sYWJlbCwgY2hpbGRyZW46ICJDdXJyZW50IGFnZSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3ViaGVhZGVyTGFiZWwsIGNoaWxkcmVuOiAiQWdlIHlvdSBhcmUgbm93IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWx1ZTogY3VycmVudEFnZSwKICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IHVwZGF0ZVZhbCgiY3VycmVudEFnZSIsIHYpLAogICAgICAgICAgICAgIG1pbjogMTgsCiAgICAgICAgICAgICAgbWF4OiAxMDAKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5jb2x1bW4sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiQW5udWFsIHByZS10YXggaW5jb21lIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5zdWJoZWFkZXJMYWJlbCwgY2hpbGRyZW46ICJZb3VyIHllYXJseSBlYXJuaW5ncyBiZWZvcmUgdGF4IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWx1ZTogaW5jb21lLAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gdXBkYXRlVmFsKCJpbmNvbWUiLCB2KSwKICAgICAgICAgICAgICBtaW46IDAsCiAgICAgICAgICAgICAgbWF4OiAxZTcsCiAgICAgICAgICAgICAgc3RlcDogMWUzLAogICAgICAgICAgICAgIHByZWZpeDogIiQiCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMucm93LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIkN1cnJlbnQgU2F2aW5ncyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3ViaGVhZGVyTGFiZWwsIGNoaWxkcmVuOiAiVG90YWwgYW1vdW50IHNhdmVkIGZvciByZXRpcmVtZW50IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWx1ZTogc2F2aW5ncywKICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IHVwZGF0ZVZhbCgic2F2aW5ncyIsIHYpLAogICAgICAgICAgICAgIG1pbjogMCwKICAgICAgICAgICAgICBtYXg6IDFlNywKICAgICAgICAgICAgICBzdGVwOiAxZTMsCiAgICAgICAgICAgICAgcHJlZml4OiAiJCIKICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRXZWlnaHQ6IDcwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJmbGV4LWVuZCIsIG1hcmdpblRvcDogNCB9LAogICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFNob3dTYXZpbmdzTW9kYWwodHJ1ZSksCiAgICAgICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IGNoaWxkcmVuOiAiKyBBZGQgRGV0YWlscyIgfSkKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5jb2x1bW4sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiT3RoZXIgTW9udGhseSBJbmNvbWUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN1YmhlYWRlckxhYmVsLCBjaGlsZHJlbjogIk1vbnRobHkgaW5jb21lIGZyb20gb3RoZXIgc291cmNlcyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IG90aGVySW5jb21lLAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gdXBkYXRlVmFsKCJvdGhlckluY29tZSIsIHYpLAogICAgICAgICAgICAgIG1pbjogMCwKICAgICAgICAgICAgICBtYXg6IDFlNSwKICAgICAgICAgICAgICBzdGVwOiAxMDAsCiAgICAgICAgICAgICAgcHJlZml4OiAiJCIKICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRXZWlnaHQ6IDcwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJmbGV4LWVuZCIsIG1hcmdpblRvcDogNCB9LAogICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFNob3dJbmNvbWVNb2RhbCh0cnVlKSwKICAgICAgICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICIrIEFkZCBEZXRhaWxzIiB9KQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJvdywgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIk1vbnRobHkgY29udHJpYnV0aW9ucyIgfSkgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3ViaGVhZGVyTGFiZWwsIGNoaWxkcmVuOiAiQW1vdW50IHlvdSBzYXZlIGVhY2ggbW9udGgiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgTnVtYmVyQ29udHJvbCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbHVlOiBjb250cmlidXRpb25zLAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gdXBkYXRlVmFsKCJjb250cmlidXRpb25zIiwgdiksCiAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgIG1heDogMWU1LAogICAgICAgICAgICAgIHN0ZXA6IDEwMCwKICAgICAgICAgICAgICBwcmVmaXg6ICIkIgogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIk1vbnRobHkgYnVkZ2V0IGluIHJldGlyZW1lbnQiIH0pIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN1YmhlYWRlckxhYmVsLCBjaGlsZHJlbjogIkVzdGltYXRlZCBtb250aGx5IHNwZW5kaW5nIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWx1ZTogYnVkZ2V0LAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gdXBkYXRlVmFsKCJidWRnZXQiLCB2KSwKICAgICAgICAgICAgICBtaW46IDAsCiAgICAgICAgICAgICAgbWF4OiAxZTUsCiAgICAgICAgICAgICAgc3RlcDogMTAwLAogICAgICAgICAgICAgIHByZWZpeDogIiQiCiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250V2VpZ2h0OiA3MDAsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiZmxleC1lbmQiLCBtYXJnaW5Ub3A6IDQgfSwKICAgICAgICAgICAgICBvbkNsaWNrOiBhcHBseVNtYXJ0QnVkZ2V0LAogICAgICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogIlx1ezFGQTg0fSBFc3RpbWF0ZSIgfSkKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgImRpdiIsCiAgICAgICAgewogICAgICAgICAgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4LCBjdXJzb3I6ICJwb2ludGVyIiwgbWFyZ2luVG9wOiAyMCwgbWFyZ2luQm90dG9tOiAyMCwgY29sb3I6IENPTE9SUy5ibHVlLCBmb250V2VpZ2h0OiA3MDAsIGZvbnRTaXplOiAxNCB9LAogICAgICAgICAgb25DbGljazogKCkgPT4gc2V0U2hvd0FkdmFuY2VkKCFzaG93QWR2YW5jZWQpLAogICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgc2hvd0FkdmFuY2VkID8gIkhJREUgQURWQU5DRUQgREVUQUlMUyIgOiAiQURWQU5DRUQgREVUQUlMUyIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hldnJvbkRvd24sIHsgc2l6ZTogMTYsIHN0eWxlOiB7IHRyYW5zZm9ybTogc2hvd0FkdmFuY2VkID8gInJvdGF0ZSgxODBkZWcpIiA6ICJub25lIiwgdHJhbnNpdGlvbjogInRyYW5zZm9ybSAwLjJzIiB9IH0pCiAgICAgICAgICBdCiAgICAgICAgfQogICAgICApLAogICAgICBzaG93QWR2YW5jZWQgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoaW1wb3J0X2pzeF9ydW50aW1lLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5yb3csIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIlJldGlyZW1lbnQgYWdlIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN1YmhlYWRlckxhYmVsLCBjaGlsZHJlbjogIkFnZSB5b3UgcGxhbiB0byByZXRpcmUiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsdWU6IHJldGlyZW1lbnRBZ2UsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IHVwZGF0ZVZhbCgicmV0aXJlbWVudEFnZSIsIHYpLAogICAgICAgICAgICAgICAgbWluOiBwYXJzZUludChjdXJyZW50QWdlKSArIDEsCiAgICAgICAgICAgICAgICBtYXg6IDEwMAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiTGlmZSBleHBlY3RhbmN5IiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN1YmhlYWRlckxhYmVsLCBjaGlsZHJlbjogIkVzdGltYXRlZCBhZ2Ugb2YgbGlmZXNwYW4iIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsdWU6IGxpZmVFeHBlY3RhbmN5LAogICAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2KSA9PiB1cGRhdGVWYWwoImxpZmVFeHBlY3RhbmN5IiwgdiksCiAgICAgICAgICAgICAgICBtaW46IHBhcnNlSW50KHJldGlyZW1lbnRBZ2UpICsgMSwKICAgICAgICAgICAgICAgIG1heDogMTIwCiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDE2LCBtYXJnaW5Ub3A6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJJbnZlc3RtZW50IFN0cmF0ZWd5IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3RyYXRlZ3lCdG4ocHJlUmV0aXJlUmF0ZSA9PT0gIjQiICYmIHBvc3RSZXRpcmVSYXRlID09PSAiMyIpLCBvbkNsaWNrOiAoKSA9PiBoYW5kbGVJbnZlc3RtZW50U3RyYXRlZ3koImNvbnNlcnZhdGl2ZSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgY2hpbGRyZW46ICJDb25zZXJ2YXRpdmUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIkJvbmRzICYgU3RhYmlsaXR5IiB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHByZVJldGlyZVJhdGUgPT09ICI3IiAmJiBwb3N0UmV0aXJlUmF0ZSA9PT0gIjUiKSwgb25DbGljazogKCkgPT4gaGFuZGxlSW52ZXN0bWVudFN0cmF0ZWd5KCJtb2RlcmF0ZSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgY2hpbGRyZW46ICJNb2RlcmF0ZSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGZvbnRXZWlnaHQ6IDQwMCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiAiQmFsYW5jZWQgR3Jvd3RoIiB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHByZVJldGlyZVJhdGUgPT09ICI5IiAmJiBwb3N0UmV0aXJlUmF0ZSA9PT0gIjciKSwgb25DbGljazogKCkgPT4gaGFuZGxlSW52ZXN0bWVudFN0cmF0ZWd5KCJhZ2dyZXNzaXZlIiksIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBjaGlsZHJlbjogIkFnZ3Jlc3NpdmUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIk1heCBSZXR1cm5zIiB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJQb3N0LVJldGlyZW1lbnQgVHJhdmVsIFBsYW5zIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3RyYXRlZ3lCdG4odHJhdmVsUGxhbiA9PT0gImxvdyIpLCBvbkNsaWNrOiAoKSA9PiBoYW5kbGVUcmF2ZWxQbGFuQ2hhbmdlKCJsb3ciKSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiQ29uc2VydmF0aXZlIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgZm9udFdlaWdodDogNDAwLCBtYXJnaW5Ub3A6IDIgfSwgY2hpbGRyZW46ICJMb2NhbCB0cmlwcyIgfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5zdHJhdGVneUJ0bih0cmF2ZWxQbGFuID09PSAibW9kZXJhdGUiKSwgb25DbGljazogKCkgPT4gaGFuZGxlVHJhdmVsUGxhbkNoYW5nZSgibW9kZXJhdGUiKSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiTW9kZXJhdGUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIjEtMiB0cmlwcy95ZWFyIiB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHRyYXZlbFBsYW4gPT09ICJoaWdoIiksIG9uQ2xpY2s6ICgpID0+IGhhbmRsZVRyYXZlbFBsYW5DaGFuZ2UoImhpZ2giKSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiQWdncmVzc2l2ZSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGZvbnRXZWlnaHQ6IDQwMCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiAiRnJlcXVlbnQgdHJhdmVsIiB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJGYW1pbHkgUGxhbnMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDgsIG1hcmdpbkJvdHRvbTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5zdHJhdGVneUJ0bihmYW1pbHlQbGFuID09PSAibm9uZSIpLCBvbkNsaWNrOiAoKSA9PiBoYW5kbGVGYW1pbHlQbGFuQ2hhbmdlKCJub25lIiksIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBjaGlsZHJlbjogIk5vIEZhbWlseSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGZvbnRXZWlnaHQ6IDQwMCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiAiTm8gY2hpbGRyZW4iIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3RyYXRlZ3lCdG4oZmFtaWx5UGxhbiA9PT0gInNtYWxsIiksIG9uQ2xpY2s6ICgpID0+IGhhbmRsZUZhbWlseVBsYW5DaGFuZ2UoInNtYWxsIiksIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBjaGlsZHJlbjogIlNtYWxsIEZhbWlseSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGZvbnRXZWlnaHQ6IDQwMCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiAiMS0yIGNoaWxkcmVuIiB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKGZhbWlseVBsYW4gPT09ICJsYXJnZSIpLCBvbkNsaWNrOiAoKSA9PiBoYW5kbGVGYW1pbHlQbGFuQ2hhbmdlKCJsYXJnZSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgY2hpbGRyZW46ICJMYXJnZSBGYW1pbHkiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIjMrIGNoaWxkcmVuIiB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgZmFtaWx5UGxhbiAhPT0gIm5vbmUiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4LCBjdXJzb3I6ICJwb2ludGVyIiwgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHR5cGU6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICBjaGVja2VkOiBoZWxwV2l0aENvbGxlZ2UsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IGhhbmRsZUNvbGxlZ2VUb2dnbGUoZS50YXJnZXQuY2hlY2tlZCksCiAgICAgICAgICAgICAgICBzdHlsZTogeyB3aWR0aDogMTYsIGhlaWdodDogMTYsIGFjY2VudENvbG9yOiBDT0xPUlMucHJpbWFyeSB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICApLAogICAgICAgICAgICAiQ2hlY2sgaGVyZSBpZiB5b3UgcGxhbiB0byBoZWxwIHdpdGggY29sbGVnZSB0dWl0aW9uIgogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxNiwgYm9yZGVyVG9wOiBgMXB4IGRhc2hlZCAke0NPTE9SUy5ib3JkZXJ9YCwgcGFkZGluZ1RvcDogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIkFkZGl0aW9uYWwgTm90ZXMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luQm90dG9tOiA4LCB3aGl0ZVNwYWNlOiAibm93cmFwIiwgb3ZlcmZsb3c6ICJoaWRkZW4iLCB0ZXh0T3ZlcmZsb3c6ICJlbGxpcHNpcyIgfSwgY2hpbGRyZW46ICJBZGQgYW55IGV4dHJhIGRldGFpbHMgYWJvdXQgeW91ciByZXRpcmVtZW50IHBsYW5zIGhlcmUuIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICJ0ZXh0YXJlYSIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWx1ZTogcGVyc29uYWxOb3RlcywKICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldFBlcnNvbmFsTm90ZXMoZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiVHlwZSBoZXJlLi4uIiwKICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgICAgIGhlaWdodDogIjUycHgiLAogICAgICAgICAgICAgICAgcGFkZGluZzogIjEwcHggMTJweCIsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICIxMnB4IiwKICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAiMTRweCIsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiAiaW5oZXJpdCIsCiAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206ICI4cHgiLAogICAgICAgICAgICAgICAgcmVzaXplOiAidmVydGljYWwiLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgICAgICAgICAgIGJveFNpemluZzogImJvcmRlci1ib3giCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuYnV0dG9uUm93LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBjbGFzc05hbWU6ICJidG4tcHJlc3MiLCBzdHlsZTogc3R5bGVzLmNhbGNCdXR0b24sIG9uQ2xpY2s6IGNhbGN1bGF0ZTIsIGRpc2FibGVkOiBpc0FuYWx5emluZywgY2hpbGRyZW46IGlzQW5hbHl6aW5nID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShMb2FkZXIsIHsgc2l6ZTogMjAsIGNsYXNzTmFtZTogInNwaW4iIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoaW1wb3J0X2pzeF9ydW50aW1lLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgIkNhbGN1bGF0ZSAiLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGxheSwgeyBzaXplOiAyMCwgZmlsbDogIndoaXRlIiB9KQogICAgICBdIH0pIH0pIH0pCiAgICBdIH0pLAogICAgY3VycmVudENhbGMucmVzdWx0ICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMucmVzdWx0Q2FyZCwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJlc3VsdEhlYWRlciwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogc3R5bGVzLnJlc3VsdFRpdGxlLCBjaGlsZHJlbjogWwogICAgICAgICJSZXRpcmVtZW50IHNhdmluZ3MgYXQgYWdlICIsCiAgICAgICAgY3VycmVudENhbGMudmFsdWVzLnJldGlyZW1lbnRBZ2UKICAgICAgXSB9KSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBtYXJnaW5Cb3R0b206IDI0LCBnYXA6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogIldoYXQgeW91J2xsIGhhdmUiIH0pLAogICAgICAgICAgKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgaGF2ZSA9IGN1cnJlbnRDYWxjLnJlc3VsdC5oYXZlOwogICAgICAgICAgICBjb25zdCBuZWVkID0gY3VycmVudENhbGMucmVzdWx0Lm5lZWQ7CiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gbmVlZCA+IDAgPyBoYXZlIC8gbmVlZCA6IDE7CiAgICAgICAgICAgIGxldCBjb2xvcjIgPSBDT0xPUlMucHJpbWFyeTsKICAgICAgICAgICAgbGV0IG1lc3NhZ2UgPSAiWW91J3JlIG9uIHRyYWNrISI7CiAgICAgICAgICAgIGlmIChyYXRpbyA8IDAuOCkgewogICAgICAgICAgICAgIGNvbG9yMiA9IENPTE9SUy5yZWQ7CiAgICAgICAgICAgICAgbWVzc2FnZSA9ICJZb3UncmUgZmFsbGluZyBzaG9ydC4iOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJhdGlvIDwgMSkgewogICAgICAgICAgICAgIGNvbG9yMiA9IENPTE9SUy55ZWxsb3c7CiAgICAgICAgICAgICAgbWVzc2FnZSA9ICJZb3UncmUgZ2V0dGluZyBjbG9zZS4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjgsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IGNvbG9yMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgaGF2ZS50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogY29sb3IyLCBtYXJnaW5Ub3A6IDQgfSwgY2hpbGRyZW46IG1lc3NhZ2UgfSkKICAgICAgICAgICAgXSB9KTsKICAgICAgICAgIH0pKCkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEsIGJvcmRlckxlZnQ6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIHBhZGRpbmdMZWZ0OiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogIldoYXQgeW91J2xsIG5lZWQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIiQiLAogICAgICAgICAgICBjdXJyZW50Q2FsYy5yZXN1bHQubmVlZC50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGJvcmRlckJvdHRvbTogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgbWFyZ2luQm90dG9tOiAyNCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyQm90dG9tOiByZXN1bHRWaWV3ID09PSAiZ3JhcGgiID8gYDJweCBzb2xpZCAke0NPTE9SUy5wcmltYXJ5fWAgOiAibm9uZSIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IHJlc3VsdFZpZXcgPT09ICJncmFwaCIgPyBDT0xPUlMucHJpbWFyeSA6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBjdXJzb3I6ICJwb2ludGVyIiwgZm9udFNpemU6IDEyLCBsZXR0ZXJTcGFjaW5nOiAxIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFJlc3VsdFZpZXcoImdyYXBoIiksCiAgICAgICAgICAgIGNoaWxkcmVuOiAiR1JBUEggVklFVyIKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyQm90dG9tOiByZXN1bHRWaWV3ID09PSAic3VtbWFyeSIgPyBgMnB4IHNvbGlkICR7Q09MT1JTLnByaW1hcnl9YCA6ICJub25lIiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogcmVzdWx0VmlldyA9PT0gInN1bW1hcnkiID8gQ09MT1JTLnByaW1hcnkgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgY3Vyc29yOiAicG9pbnRlciIsIGZvbnRTaXplOiAxMiwgbGV0dGVyU3BhY2luZzogMSB9LAogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRSZXN1bHRWaWV3KCJzdW1tYXJ5IiksCiAgICAgICAgICAgIGNoaWxkcmVuOiAiU1VNTUFSWSBWSUVXIgogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJkaXYiLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE2cHgiLCBib3JkZXJCb3R0b206IHJlc3VsdFZpZXcgPT09ICJ0aXBzIiA/IGAycHggc29saWQgJHtDT0xPUlMucHJpbWFyeX1gIDogIm5vbmUiLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiByZXN1bHRWaWV3ID09PSAidGlwcyIgPyBDT0xPUlMucHJpbWFyeSA6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBjdXJzb3I6ICJwb2ludGVyIiwgZm9udFNpemU6IDEyLCBsZXR0ZXJTcGFjaW5nOiAxIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFJlc3VsdFZpZXcoInRpcHMiKSwKICAgICAgICAgICAgY2hpbGRyZW46ICJUSVBTIgogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KSwKICAgICAgcmVzdWx0VmlldyA9PT0gImdyYXBoIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBoZWlnaHQ6IDMwMCwgd2lkdGg6ICIxMDAlIiwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShSZXNwb25zaXZlQ29udGFpbmVyLCB7IGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShBcmVhQ2hhcnQsIHsgZGF0YTogY3VycmVudENhbGMucmVzdWx0LmdyYXBoRGF0YSwgbWFyZ2luOiB7IHRvcDogMTAsIHJpZ2h0OiAxMCwgbGVmdDogLTIwLCBib3R0b206IDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRlZnMiLCB7IGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgibGluZWFyR3JhZGllbnQiLCB7IGlkOiAiY29sb3JDdXJyZW50IiwgeDE6ICIwIiwgeTE6ICIwIiwgeDI6ICIwIiwgeTI6ICIxIiwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiNSUiLCBzdG9wQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBzdG9wT3BhY2l0eTogMC4xIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI5NSUiLCBzdG9wQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBzdG9wT3BhY2l0eTogMCB9KQogICAgICAgICAgXSB9KSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2FydGVzaWFuR3JpZCwgeyBzdHJva2VEYXNoYXJyYXk6ICIzIDMiLCB2ZXJ0aWNhbDogZmFsc2UsIHN0cm9rZTogQ09MT1JTLmJvcmRlciB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoWEF4aXMsIHsgZGF0YUtleTogImFnZSIsIHRpY2s6IHsgZmlsbDogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgdGlja0xpbmU6IGZhbHNlLCBheGlzTGluZTogeyBzdHJva2U6IENPTE9SUy5ib3JkZXIgfSwgbWluVGlja0dhcDogMzAgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFlBeGlzLCB7IHRpY2s6IHsgZmlsbDogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgdGlja0Zvcm1hdHRlcjogKHZhbCkgPT4gYCQkeyh2YWwgLyAxZTYpLnRvRml4ZWQoMSl9bWAsIHRpY2tMaW5lOiBmYWxzZSwgYXhpc0xpbmU6IGZhbHNlIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgVG9vbHRpcCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvbnRlbnQ6ICh7IGFjdGl2ZSwgcGF5bG9hZCwgbGFiZWwgfSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGFjdGl2ZSAmJiBwYXlsb2FkICYmIHBheWxvYWQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYyA9IHBheWxvYWQuZmluZCgocCkgPT4gcC5uYW1lID09PSAiUmVjb21tZW5kZWQiKT8udmFsdWU7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGN1ciA9IHBheWxvYWQuZmluZCgocCkgPT4gcC5uYW1lID09PSAiQ3VycmVudCBwYXRoIik/LnZhbHVlOwogICAgICAgICAgICAgICAgICBjb25zdCBkaWZmID0gY3VyICE9PSB2b2lkIDAgJiYgcmVjICE9PSB2b2lkIDAgPyBjdXIgLSByZWMgOiAwOwogICAgICAgICAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiA4LCBib3hTaGFkb3c6ICIwIDRweCAxMnB4IHJnYmEoMCwwLDAsMC4xKSIsIGJvcmRlcjogIjFweCBzb2xpZCAjRTVFN0VCIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDYwMCwgbWFyZ2luQm90dG9tOiA4LCBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgIkFnZSAiLAogICAgICAgICAgICAgICAgICAgICAgbGFiZWwKICAgICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZ2FwOiAxNiwgbWFyZ2luQm90dG9tOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLmJsdWUsIGZvbnRXZWlnaHQ6IDYwMCwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiAiUmVjb21tZW5kZWQiIH0pLAogICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgICAgICAgICAgcmVjPy50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGdhcDogMTYsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250V2VpZ2h0OiA2MDAsIGZvbnRTaXplOiAxMiB9LCBjaGlsZHJlbjogIkN1cnJlbnQgcGF0aCIgfSksCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgICAgICAgICBjdXI/LnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZ2FwOiAxNiwgYm9yZGVyVG9wOiAiMXB4IGRhc2hlZCAjRTVFN0VCIiwgcGFkZGluZ1RvcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46ICJEaWZmZXJlbmNlIiB9KSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBkaWZmID49IDAgPyBDT0xPUlMucHJpbWFyeSA6IENPTE9SUy5yZWQsIGZvbnRTaXplOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICBkaWZmID49IDAgPyAiKyIgOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgICAgICAgICBkaWZmLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgICAgICAgIF0gfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFyZWEsIHsgdHlwZTogIm1vbm90b25lIiwgZGF0YUtleTogInJlY29tbWVuZGVkIiwgc3Ryb2tlOiBDT0xPUlMuYmx1ZSwgc3Ryb2tlRGFzaGFycmF5OiAiNSA1IiwgZmlsbDogInRyYW5zcGFyZW50Iiwgc3Ryb2tlV2lkdGg6IDIsIG5hbWU6ICJSZWNvbW1lbmRlZCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFyZWEsIHsgdHlwZTogIm1vbm90b25lIiwgZGF0YUtleTogImN1cnJlbnQiLCBzdHJva2U6IENPTE9SUy5wcmltYXJ5LCBmaWxsOiAidXJsKCNjb2xvckN1cnJlbnQpIiwgc3Ryb2tlV2lkdGg6IDIsIG5hbWU6ICJDdXJyZW50IHBhdGgiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShSZWZlcmVuY2VEb3QsIHsgeDogcGFyc2VJbnQoY3VycmVudENhbGMudmFsdWVzLnJldGlyZW1lbnRBZ2UpLCB5OiBjdXJyZW50Q2FsYy5yZXN1bHQuaGF2ZSwgcjogNCwgZmlsbDogQ09MT1JTLnByaW1hcnksIHN0cm9rZTogIndoaXRlIiwgc3Ryb2tlV2lkdGg6IDIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlZmVyZW5jZURvdCwgeyB4OiBwYXJzZUludChjdXJyZW50Q2FsYy52YWx1ZXMucmV0aXJlbWVudEFnZSksIHk6IGN1cnJlbnRDYWxjLnJlc3VsdC5uZWVkLCByOiA0LCBmaWxsOiBDT0xPUlMuYmx1ZSwgc3Ryb2tlOiAid2hpdGUiLCBzdHJva2VXaWR0aDogMiB9KQogICAgICAgIF0gfSkgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGdhcDogMTYsIG1hcmdpblRvcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDEyLCBoZWlnaHQ6IDIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmJsdWUgfSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46ICJSZWNvbW1lbmRlZCIgfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogMTIsIGhlaWdodDogMiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMiB9LCBjaGlsZHJlbjogIkN1cnJlbnQgcGF0aCIgfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIHJlc3VsdFZpZXcgPT09ICJzdW1tYXJ5IiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxpc3QsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAyMCwgYm9yZGVyQm90dG9tOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBwYWRkaW5nQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIGZvbnRTaXplOiAxNiB9LCBjaGlsZHJlbjogIlBsYW4gQW5hbHlzaXMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkNvbXBhcmlzb24gb2YgeW91ciBjdXJyZW50IHRyYWplY3RvcnkgdnMuIHlvdXIgZ29hbHMiIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDI0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJNb250aGx5IENvbnRyaWJ1dGlvbnMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBwYWRkaW5nOiAxNiwgYm9yZGVyUmFkaXVzOiAxMiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBib3hTaGFkb3c6ICIwIDJweCA0cHggcmdiYSgwLDAsMCwwLjAyKSIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogNCwgZm9udFdlaWdodDogNTAwIH0sIGNoaWxkcmVuOiAiQ3VycmVudCBDb250cmlidXRpb24iIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxOCwgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICBjdXJyZW50Q2FsYy5yZXN1bHQuY3VycmVudE1vbnRobHlDb250cmliLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBvcGFjaXR5OiAwLjUgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJyb3dSaWdodCwgeyBzaXplOiAyNCB9KSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogNCwgZm9udFdlaWdodDogNTAwIH0sIGNoaWxkcmVuOiAiUmVxdWlyZWQgQ29udHJpYnV0aW9uIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTgsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IENPTE9SUy5ibHVlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICBjdXJyZW50Q2FsYy5yZXN1bHQubW9udGhseUNvbnRyaWJOZWVkZWQudG9Mb2NhbGVTdHJpbmcoKQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgICgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBjdXJyZW50Q2FsYy5yZXN1bHQubW9udGhseUNvbnRyaWJOZWVkZWQgLSBjdXJyZW50Q2FsYy5yZXN1bHQuY3VycmVudE1vbnRobHlDb250cmliOwogICAgICAgICAgICBpZiAoZGlmZiA+IDApIHsKICAgICAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogOCwgcGFkZGluZ0xlZnQ6IDQsIGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogIlx1ezFGNEExfSIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgIlRvIG1lZXQgeW91ciBnb2FsLCBpbmNyZWFzZSBjb250cmlidXRpb25zIGJ5ICIsCiAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICAgICAgZGlmZi50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICIgL21vLiIKICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICBdIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwgbWFyZ2luVG9wOiA4LCBwYWRkaW5nTGVmdDogNCwgZm9udFdlaWdodDogNjAwLCBkaXNwbGF5OiAiZmxleCIsIGdhcDogNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICJcdTI3MDUiIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICJZb3UgYXJlIGNvbnRyaWJ1dGluZyBlbm91Z2ggdG8gbWVldCB5b3VyIGdvYWwhIiB9KQogICAgICAgICAgICAgIF0gfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pKCkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogMjQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIlRvdGFsIFNhdmluZ3MgYXQgUmV0aXJlbWVudCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDEyLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIHBhZGRpbmc6IDE2LCBib3JkZXJSYWRpdXM6IDEyLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGJveFNoYWRvdzogIjAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMDIpIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luQm90dG9tOiA0LCBmb250V2VpZ2h0OiA1MDAgfSwgY2hpbGRyZW46ICJQcm9qZWN0ZWQgT3V0Y29tZSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgIGN1cnJlbnRDYWxjLnJlc3VsdC5oYXZlLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBvcGFjaXR5OiAwLjUgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJyb3dSaWdodCwgeyBzaXplOiAyNCB9KSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogNCwgZm9udFdlaWdodDogNTAwIH0sIGNoaWxkcmVuOiAiUmV0aXJlbWVudCBHb2FsIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTgsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IENPTE9SUy5ibHVlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICBjdXJyZW50Q2FsYy5yZXN1bHQubmVlZC50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiAiU3VzdGFpbmFiaWxpdHkiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBwYWRkaW5nOiAxNiwgYm9yZGVyUmFkaXVzOiAxMiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBib3hTaGFkb3c6ICIwIDJweCA0cHggcmdiYSgwLDAsMCwwLjAyKSIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogNCwgZm9udFdlaWdodDogNTAwIH0sIGNoaWxkcmVuOiAiRnVuZHMgbGFzdCB1bnRpbCIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBjdXJyZW50Q2FsYy5yZXN1bHQucnVuT3V0QWdlQ3VycmVudCA8IHBhcnNlSW50KGN1cnJlbnRDYWxjLnZhbHVlcy5saWZlRXhwZWN0YW5jeSkgPyBDT0xPUlMucmVkIDogQ09MT1JTLnByaW1hcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICJBZ2UgIiwKICAgICAgICAgICAgICAgIGN1cnJlbnRDYWxjLnJlc3VsdC5ydW5PdXRBZ2VDdXJyZW50CiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgb3BhY2l0eTogMC41IH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFycm93UmlnaHQsIHsgc2l6ZTogMjQgfSkgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDQsIGZvbnRXZWlnaHQ6IDUwMCB9LCBjaGlsZHJlbjogIlRhcmdldCBEdXJhdGlvbiIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMuYmx1ZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIkFnZSAiLAogICAgICAgICAgICAgICAgY3VycmVudENhbGMudmFsdWVzLmxpZmVFeHBlY3RhbmN5LAogICAgICAgICAgICAgICAgIisiCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICByZXN1bHRWaWV3ID09PSAidGlwcyIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5saXN0LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogMjAsIGJvcmRlckJvdHRvbTogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgcGFkZGluZ0JvdHRvbTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBmb250U2l6ZTogMTYgfSwgY2hpbGRyZW46ICJQZXJzb25hbGl6ZWQgUmVjb21tZW5kYXRpb25zIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJBY3Rpb25hYmxlIHN0ZXBzIHRvIGltcHJvdmUgeW91ciByZXRpcmVtZW50IG91dGxvb2siIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZmxleERpcmVjdGlvbjogImNvbHVtbiIsIGdhcDogMTYgfSwgY2hpbGRyZW46IGdlbmVyYXRlVGlwcygpLm1hcCgodGlwLCBpZHgpID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgcGFkZGluZzogMTYsIGJvcmRlclJhZGl1czogMTIsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgYm94U2hhZG93OiAiMCAycHggNHB4IHJnYmEoMCwwLDAsMC4wMikiLCBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI0LCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCB3aWR0aDogNDgsIGhlaWdodDogNDgsIGJvcmRlclJhZGl1czogMjQsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgZmxleFNocmluazogMCB9LCBjaGlsZHJlbjogdGlwLmljb24gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46IHRpcC50aXRsZSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbGluZUhlaWdodDogMS41IH0sIGNoaWxkcmVuOiB0aXAuZGVzYyB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSwgaWR4KSkgfSkKICAgICAgXSB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuZm9vdGVyLCBjbGFzc05hbWU6ICJuby1wcmludCIsIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMuZm9vdGVyQnRuLCBvbkNsaWNrOiByZXNldFRvRGVmYXVsdHMsIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShSb3RhdGVDY3csIHsgc2l6ZTogMTYgfSksCiAgICAgICAgIiBSZXNldCIKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImJ1dHRvbiIsIHsgc3R5bGU6IHN0eWxlcy5mb290ZXJCdG4sIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShIZWFydCwgeyBzaXplOiAxNiB9KSwKICAgICAgICAiIERvbmF0ZSIKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImJ1dHRvbiIsIHsgc3R5bGU6IHN0eWxlcy5mb290ZXJCdG4sIG9uQ2xpY2s6ICgpID0+IHNldFNob3dGZWVkYmFja01vZGFsKHRydWUpLCBjbGFzc05hbWU6ICJidG4tcHJlc3MiLCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTWVzc2FnZVNxdWFyZSwgeyBzaXplOiAxNiB9KSwKICAgICAgICAiIEZlZWRiYWNrIgogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLmZvb3RlckJ0biwgb25DbGljazogKCkgPT4gd2luZG93LnByaW50KCksIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQcmludGVyLCB7IHNpemU6IDE2IH0pLAogICAgICAgICIgUHJpbnQiCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICBzaG93RmVlZGJhY2tNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuYm90dG9tTW9kYWxPdmVybGF5LCBvbkNsaWNrOiAoKSA9PiBzZXRTaG93RmVlZGJhY2tNb2RhbChmYWxzZSksIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ29udGVudCwgb25DbGljazogKGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCksIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgc3R5bGU6IHN0eWxlcy5tb2RhbENsb3NlLCBvbkNsaWNrOiAoKSA9PiBzZXRTaG93RmVlZGJhY2tNb2RhbChmYWxzZSksIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1pbnVzLCB7IHNpemU6IDI0LCBzdHlsZTogeyB0cmFuc2Zvcm06ICJyb3RhdGUoNDVkZWcpIiB9IH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMjRweCIsIGZvbnRXZWlnaHQ6IDgwMCwgbWFyZ2luQm90dG9tOiAiOHB4IiwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIkZlZWRiYWNrIiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjE0cHgiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogIjI0cHgiIH0sIGNoaWxkcmVuOiAiSGVscCB1cyBpbXByb3ZlIHRoZSBjYWxjdWxhdG9yLiIgfSksCiAgICAgIGZlZWRiYWNrU3RhdHVzID09PSAic3VjY2VzcyIgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogImNlbnRlciIsIHBhZGRpbmc6ICIyMHB4IiwgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250V2VpZ2h0OiA2MDAgfSwgY2hpbGRyZW46ICJUaGFua3MgZm9yIHlvdXIgZmVlZGJhY2shIiB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZS5GcmFnbWVudCwgeyBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAidGV4dGFyZWEiLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyAuLi5zdHlsZXMuaW5wdXQsIGhlaWdodDogIjEyMHB4IiwgcmVzaXplOiAibm9uZSIsIGZvbnRGYW1pbHk6ICJpbmhlcml0IiB9LAogICAgICAgICAgICBwbGFjZWhvbGRlcjogIlRlbGwgdXMgd2hhdCB5b3UgdGhpbmsuLi4iLAogICAgICAgICAgICB2YWx1ZTogZmVlZGJhY2tUZXh0LAogICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEZlZWRiYWNrVGV4dChlLnRhcmdldC52YWx1ZSkKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIGZlZWRiYWNrU3RhdHVzID09PSAiZXJyb3IiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5yZWQsIGZvbnRTaXplOiAiMTRweCIsIG1hcmdpbkJvdHRvbTogIjEwcHgiIH0sIGNoaWxkcmVuOiAiRmFpbGVkIHRvIHNlbmQuIFBsZWFzZSB0cnkgYWdhaW4uIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IC4uLnN0eWxlcy5jYWxjQnV0dG9uLCB3aWR0aDogIjEwMCUiIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IGhhbmRsZUZlZWRiYWNrU3VibWl0LAogICAgICAgICAgICBkaXNhYmxlZDogZmVlZGJhY2tTdGF0dXMgPT09ICJzdWJtaXR0aW5nIiB8fCAhZmVlZGJhY2tUZXh0LnRyaW0oKSwKICAgICAgICAgICAgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwKICAgICAgICAgICAgY2hpbGRyZW46IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgPyAiU2VuZGluZy4uLiIgOiAiU2VuZCBGZWVkYmFjayIKICAgICAgICAgIH0KICAgICAgICApCiAgICAgIF0gfSkKICAgIF0gfSkgfSksCiAgICBzaG93U2F2aW5nc01vZGFsICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5tb2RhbE92ZXJsYXksIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ29udGVudCwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ2xvc2UsIG9uQ2xpY2s6ICgpID0+IHNldFNob3dTYXZpbmdzTW9kYWwoZmFsc2UpLCBjaGlsZHJlbjogIlx1MjcxNSIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAyNCwgdGV4dEFsaWduOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjAsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiAiQ3VycmVudCBTYXZpbmdzIEJyZWFrZG93biIgfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5sYWJlbCwgY2hpbGRyZW46ICJTYXZpbmdzIEFjY291bnQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgTnVtYmVyQ29udHJvbCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbHVlOiBzYXZpbmdzRGV0YWlscy5zYXZpbmdzLAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gaGFuZGxlU2F2aW5nc0RldGFpbENoYW5nZSgic2F2aW5ncyIsIHYpLAogICAgICAgICAgICAgIHByZWZpeDogIiQiCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiQ2hlY2tpbmcgQWNjb3VudCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IHNhdmluZ3NEZXRhaWxzLmNoZWNraW5nLAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gaGFuZGxlU2F2aW5nc0RldGFpbENoYW5nZSgiY2hlY2tpbmciLCB2KSwKICAgICAgICAgICAgICBwcmVmaXg6ICIkIgogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIlN0b2NrIFBvcnRmb2xpbyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IHNhdmluZ3NEZXRhaWxzLnN0b2NrUG9ydGZvbGlvLAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gaGFuZGxlU2F2aW5nc0RldGFpbENoYW5nZSgic3RvY2tQb3J0Zm9saW8iLCB2KSwKICAgICAgICAgICAgICBwcmVmaXg6ICIkIgogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIkNyeXB0byBBY2NvdW50cyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IHNhdmluZ3NEZXRhaWxzLmNyeXB0bywKICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IGhhbmRsZVNhdmluZ3NEZXRhaWxDaGFuZ2UoImNyeXB0byIsIHYpLAogICAgICAgICAgICAgIHByZWZpeDogIiQiCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiNDAxayAvIFJldGlyZW1lbnQgQWNjb3VudHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgTnVtYmVyQ29udHJvbCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbHVlOiBzYXZpbmdzRGV0YWlscy5yZXRpcmVtZW50LAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gaGFuZGxlU2F2aW5nc0RldGFpbENoYW5nZSgicmV0aXJlbWVudCIsIHYpLAogICAgICAgICAgICAgIHByZWZpeDogIiQiCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgewogICAgICAgICAgb25DbGljazogKCkgPT4gc2V0U2hvd1NhdmluZ3NNb2RhbChmYWxzZSksCiAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICBtYXJnaW5Ub3A6IDI0LAogICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICBwYWRkaW5nOiAiMTRweCIsCiAgICAgICAgICAgIGJvcmRlclJhZGl1czogIjEycHgiLAogICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgIGZvbnRTaXplOiAiMTZweCIsCiAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDcwMCwKICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgICAgIH0sCiAgICAgICAgICBjaGlsZHJlbjogIlNhdmUiCiAgICAgICAgfQogICAgICApCiAgICBdIH0pIH0pLAogICAgc2hvd0luY29tZU1vZGFsICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5tb2RhbE92ZXJsYXksIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ29udGVudCwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ2xvc2UsIG9uQ2xpY2s6ICgpID0+IHNldFNob3dJbmNvbWVNb2RhbChmYWxzZSksIGNoaWxkcmVuOiAiXHUyNzE1IiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAyNCwgdGV4dEFsaWduOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDIwLCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIk90aGVyIE1vbnRobHkgSW5jb21lIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiRW50ZXIgbW9udGhseSBpbmNvbWUgYW1vdW50cyIgfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGdhcDogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIlNvY2lhbCBTZWN1cml0eSBQYXltZW50IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWx1ZTogaW5jb21lRGV0YWlscy5zb2NpYWxTZWN1cml0eSwKICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IGhhbmRsZUluY29tZURldGFpbENoYW5nZSgic29jaWFsU2VjdXJpdHkiLCB2KSwKICAgICAgICAgICAgICBwcmVmaXg6ICIkIgogICAgICAgICAgICB9CiAgICAgICAgICApLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwgZm9udFdlaWdodDogNzAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogImZsZXgtZW5kIiwgbWFyZ2luVG9wOiA0IH0sCiAgICAgICAgICAgICAgb25DbGljazogaGFuZGxlRXN0aW1hdGVTb2NpYWxTZWN1cml0eSwKICAgICAgICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICJcdXsxRkE4NH0gRXN0aW1hdGUiIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiUmVhbCBFc3RhdGUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgTnVtYmVyQ29udHJvbCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbHVlOiBpbmNvbWVEZXRhaWxzLnJlYWxFc3RhdGUsCiAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2KSA9PiBoYW5kbGVJbmNvbWVEZXRhaWxDaGFuZ2UoInJlYWxFc3RhdGUiLCB2KSwKICAgICAgICAgICAgICBwcmVmaXg6ICIkIgogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIlRydXN0IEZ1bmQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgTnVtYmVyQ29udHJvbCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbHVlOiBpbmNvbWVEZXRhaWxzLnRydXN0LAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gaGFuZGxlSW5jb21lRGV0YWlsQ2hhbmdlKCJ0cnVzdCIsIHYpLAogICAgICAgICAgICAgIHByZWZpeDogIiQiCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiSW52ZXN0bWVudCBGdW5kcyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IGluY29tZURldGFpbHMuaW52ZXN0bWVudHMsCiAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2KSA9PiBoYW5kbGVJbmNvbWVEZXRhaWxDaGFuZ2UoImludmVzdG1lbnRzIiwgdiksCiAgICAgICAgICAgICAgcHJlZml4OiAiJCIKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5sYWJlbCwgY2hpbGRyZW46ICJPdGhlciIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IGluY29tZURldGFpbHMub3RoZXIsCiAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2KSA9PiBoYW5kbGVJbmNvbWVEZXRhaWxDaGFuZ2UoIm90aGVyIiwgdiksCiAgICAgICAgICAgICAgcHJlZml4OiAiJCIKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAiYnV0dG9uIiwKICAgICAgICB7CiAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRTaG93SW5jb21lTW9kYWwoZmFsc2UpLAogICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgbWFyZ2luVG9wOiAyNCwKICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgcGFkZGluZzogIjE0cHgiLAogICAgICAgICAgICBib3JkZXJSYWRpdXM6ICIxMnB4IiwKICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBmb250U2l6ZTogIjE2cHgiLAogICAgICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICB9LAogICAgICAgICAgY2hpbGRyZW46ICJTYXZlIgogICAgICAgIH0KICAgICAgKQogICAgXSB9KSB9KSwKICAgIHNob3dTdWJzY3JpYmVNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubW9kYWxPdmVybGF5LCBvbkNsaWNrOiAoKSA9PiBzZXRTaG93U3Vic2NyaWJlTW9kYWwoZmFsc2UpLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5tb2RhbENvbnRlbnQsIG9uQ2xpY2s6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMubW9kYWxDbG9zZSwgb25DbGljazogKCkgPT4gc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTWludXMsIHsgc2l6ZTogMjQsIHN0eWxlOiB7IHRyYW5zZm9ybTogInJvdGF0ZSg0NWRlZykiIH0gfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6ICIyNHB4IiwgZm9udFdlaWdodDogODAwLCBtYXJnaW5Cb3R0b206ICI4cHgiLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiU3RheSBVcGRhdGVkIiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjE0cHgiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogIjI0cHgiIH0sIGNoaWxkcmVuOiAiR2V0IHRoZSBsYXRlc3QgdXBkYXRlcyBkZWxpdmVyZWQgdG8geW91ciBpbmJveC4iIH0pLAogICAgICBzdWJzY3JpYmVTdGF0dXMgPT09ICJzdWNjZXNzIiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogImNlbnRlciIsIHBhZGRpbmc6ICIyMHB4IiwgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250V2VpZ2h0OiA2MDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiNDBweCIsIG1hcmdpbkJvdHRvbTogIjEwcHgiIH0sIGNoaWxkcmVuOiAiXHV7MUYzODl9IiB9KSwKICAgICAgICBzdWJzY3JpYmVNZXNzYWdlCiAgICAgIF0gfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206ICIxNnB4IiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJibG9jayIsIGZvbnRTaXplOiAiMTRweCIsIGZvbnRXZWlnaHQ6IDYwMCwgbWFyZ2luQm90dG9tOiAiOHB4IiwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIkVtYWlsIEFkZHJlc3MiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuaW5wdXQsCiAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJ5b3VAZXhhbXBsZS5jb20iLAogICAgICAgICAgICAgIHZhbHVlOiBlbWFpbCwKICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEVtYWlsKGUudGFyZ2V0LnZhbHVlKQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogIjIwcHgiLCBtaW5IZWlnaHQ6ICIxMjBweCIsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGlkOiAidHVybnN0aWxlLXdpZGdldCIgfSkgfSksCiAgICAgICAgc3Vic2NyaWJlU3RhdHVzID09PSAiZXJyb3IiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5yZWQsIGZvbnRTaXplOiAiMTRweCIsIG1hcmdpbkJvdHRvbTogIjE2cHgiLCB0ZXh0QWxpZ246ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBzdWJzY3JpYmVNZXNzYWdlIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgLi4uc3R5bGVzLmNhbGNCdXR0b24sIHdpZHRoOiAiMTAwJSIgfSwKICAgICAgICAgICAgb25DbGljazogaGFuZGxlU3Vic2NyaWJlLAogICAgICAgICAgICBkaXNhYmxlZDogc3Vic2NyaWJlU3RhdHVzID09PSAibG9hZGluZyIsCiAgICAgICAgICAgIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBzdWJzY3JpYmVTdGF0dXMgPT09ICJsb2FkaW5nIiA/ICJTdWJzY3JpYmluZy4uLiIgOiAiU3Vic2NyaWJlIgogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KQogICAgXSB9KSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInN0eWxlIiwgeyBjaGlsZHJlbjogYAogICAgICAgIGlucHV0W3R5cGU9bnVtYmVyXTo6LXdlYmtpdC1pbm5lci1zcGluLWJ1dHRvbiwgCiAgICAgICAgaW5wdXRbdHlwZT1udW1iZXJdOjotd2Via2l0LW91dGVyLXNwaW4tYnV0dG9uIHsgCiAgICAgICAgICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsgCiAgICAgICAgICAgIG1hcmdpbjogMDsgCiAgICAgICAgfQogICAgICAgIC5idG4tcHJlc3MgewogICAgICAgICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMgZWFzZSwgb3BhY2l0eSAwLjJzOwogICAgICAgIH0KICAgICAgICAuYnRuLXByZXNzOmFjdGl2ZSB7CiAgICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDAuOTUpOwogICAgICAgIH0KICAgICAgICAuYnRuLXByZXNzOmhvdmVyIHsKICAgICAgICAgIG9wYWNpdHk6IDAuNzsKICAgICAgICB9CiAgICAgICAgQGtleWZyYW1lcyBzcGluIHsKICAgICAgICAgICAgZnJvbSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpOyB9CiAgICAgICAgICAgIHRvIHsgdHJhbnNmb3JtOiByb3RhdGUoMzYwZGVnKTsgfQogICAgICAgIH0KICAgICAgICAuc3BpbiB7CiAgICAgICAgICAgIGFuaW1hdGlvbjogc3BpbiAxcyBsaW5lYXIgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIEBtZWRpYSBwcmludCB7CiAgICAgICAgICBib2R5IHsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7CiAgICAgICAgICB9CiAgICAgICAgICAubm8tcHJpbnQgewogICAgICAgICAgICBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICBgIH0pCiAgXSB9KTsKfQoKLy8gc3JjL21haW4udHN4CnZhciBpbXBvcnRfanN4X3J1bnRpbWUyID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgRXJyb3JCb3VuZGFyeSA9IGNsYXNzIGV4dGVuZHMgaW1wb3J0X3JlYWN0NTMuZGVmYXVsdC5Db21wb25lbnQgewogIGNvbnN0cnVjdG9yKHByb3BzKSB7CiAgICBzdXBlcihwcm9wcyk7CiAgICB0aGlzLnN0YXRlID0geyBoYXNFcnJvcjogZmFsc2UgfTsKICB9CiAgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcihlcnJvcikgewogICAgcmV0dXJuIHsgaGFzRXJyb3I6IHRydWUsIGVycm9yIH07CiAgfQogIGNvbXBvbmVudERpZENhdGNoKGVycm9yLCBlcnJvckluZm8pIHsKICAgIGNvbnNvbGUuZXJyb3IoIldpZGdldCBFcnJvciBCb3VuZGFyeSBjYXVnaHQgZXJyb3I6IiwgZXJyb3IsIGVycm9ySW5mbyk7CiAgICB0cnkgewogICAgICBmZXRjaCgiL2FwaS90cmFjayIsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBldmVudDogImNyYXNoIiwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgZXJyb3I6IGVycm9yPy5tZXNzYWdlIHx8ICJVbmtub3duIGVycm9yIiwKICAgICAgICAgICAgc3RhY2s6IGVycm9yPy5zdGFjaywKICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IGVycm9ySW5mbz8uY29tcG9uZW50U3RhY2sKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KS5jYXRjaCgoZSkgPT4gY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHJlcG9ydCBjcmFzaCIsIGUpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuc3RhdGUuaGFzRXJyb3IpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCwgdGV4dEFsaWduOiAiY2VudGVyIiwgZm9udEZhbWlseTogInNhbnMtc2VyaWYiLCBjb2xvcjogIiNEQzI2MjYiLCB3b3JkQnJlYWs6ICJicmVhay13b3JkIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJoMyIsIHsgY2hpbGRyZW46ICJTb21ldGhpbmcgd2VudCB3cm9uZy4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJwIiwgeyBjaGlsZHJlbjogIlBsZWFzZSB0cnkgcmVmcmVzaGluZyB0aGUgcGFnZS4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGV0YWlscyIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxMCwgdGV4dEFsaWduOiAibGVmdCIsIGZvbnRTaXplOiAiMTJweCIsIGNvbG9yOiAiIzY2NiIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdW1tYXJ5IiwgeyBjaGlsZHJlbjogIkRlYnVnIEVycm9yIERldGFpbHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJwcmUiLCB7IHN0eWxlOiB7IHdoaXRlU3BhY2U6ICJwcmUtd3JhcCIsIGJhY2tncm91bmQ6ICIjZjVmNWY1IiwgcGFkZGluZzogMTAsIGJvcmRlclJhZGl1czogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy50b1N0cmluZygpLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnIiLCB7fSksCiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXJyb3I/LnN0YWNrCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvcHMuY2hpbGRyZW47CiAgfQp9Owp2YXIgZ2V0SHlkcmF0aW9uRGF0YSA9ICgpID0+IHsKICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gU3RhcnRpbmcgaHlkcmF0aW9uIGNoZWNrLi4uIik7CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gV2luZG93IGlzIHVuZGVmaW5lZCIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zdCBvYSA9IHdpbmRvdy5vcGVuYWk7CiAgaWYgKCFvYSkgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgbm90IGZvdW5kLCByZW5kZXJpbmcgd2l0aCBkZWZhdWx0cyIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gd2luZG93Lm9wZW5haSBmb3VuZDoiLCBPYmplY3Qua2V5cyhvYSkpOwogIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICBvYS50b29sT3V0cHV0LAogICAgb2Euc3RydWN0dXJlZENvbnRlbnQsCiAgICBvYS5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EudG9vbElucHV0CiAgXTsKICBmb3IgKGNvbnN0IGNhbmRpZGF0ZSBvZiBjYW5kaWRhdGVzKSB7CiAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gRm91bmQgZGF0YToiLCBjYW5kaWRhdGUpOwogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfQogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTm8gZGF0YSBmb3VuZCBpbiBhbnkgY2FuZGlkYXRlIHNvdXJjZSIpOwogIHJldHVybiB7fTsKfTsKY29uc29sZS5sb2coIltNYWluXSBSZXRpcmVtZW50IENhbGN1bGF0b3IgbWFpbi50c3ggbG9hZGluZy4uLiIpOwp2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJldGlyZW1lbnQtY2FsY3VsYXRvci1yb290Iik7CmlmICghY29udGFpbmVyKSB7CiAgdGhyb3cgbmV3IEVycm9yKCJyZXRpcmVtZW50LWNhbGN1bGF0b3Itcm9vdCBlbGVtZW50IG5vdCBmb3VuZCIpOwp9CnZhciByb290ID0gKDAsIGltcG9ydF9jbGllbnQuY3JlYXRlUm9vdCkoY29udGFpbmVyKTsKdmFyIHJlbmRlckFwcCA9IChkYXRhKSA9PiB7CiAgcm9vdC5yZW5kZXIoCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShpbXBvcnRfcmVhY3Q1My5kZWZhdWx0LlN0cmljdE1vZGUsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEVycm9yQm91bmRhcnksIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFJldGlyZW1lbnRDYWxjdWxhdG9ySGVsbG9Xb3JsZCwgeyBpbml0aWFsRGF0YTogZGF0YSB9LCBEYXRlLm5vdygpKSB9KSB9KQogICk7Cn07CnZhciBpbml0aWFsRGF0YSA9IGdldEh5ZHJhdGlvbkRhdGEoKTsKcmVuZGVyQXBwKGluaXRpYWxEYXRhKTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm9wZW5haTpzZXRfZ2xvYmFscyIsIChldikgPT4gewogIGNvbnN0IGdsb2JhbHMgPSBldj8uZGV0YWlsPy5nbG9iYWxzOwogIGlmIChnbG9iYWxzKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTGF0ZSBldmVudCByZWNlaXZlZDoiLCBnbG9iYWxzKTsKICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICAgIGdsb2JhbHMudG9vbE91dHB1dCwKICAgICAgZ2xvYmFscy5zdHJ1Y3R1cmVkQ29udGVudCwKICAgICAgZ2xvYmFscy5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnRvb2xJbnB1dAogICAgXTsKICAgIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHsKICAgICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gUmUtcmVuZGVyaW5nIHdpdGggbGF0ZSBkYXRhOiIsIGNhbmRpZGF0ZSk7CiAgICAgICAgcmVuZGVyQXBwKGNhbmRpZGF0ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQp9KTsKLyohIEJ1bmRsZWQgbGljZW5zZSBpbmZvcm1hdGlvbjoKCnJlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnNjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKICAoKioKICAgKiBDaGVja3MgaWYgYW4gZXZlbnQgaXMgc3VwcG9ydGVkIGluIHRoZSBjdXJyZW50IGV4ZWN1dGlvbiBlbnZpcm9ubWVudC4KICAgKgogICAqIE5PVEU6IFRoaXMgd2lsbCBub3Qgd29yayBjb3JyZWN0bHkgZm9yIG5vbi1nZW5lcmljIGV2ZW50cyBzdWNoIGFzIGBjaGFuZ2VgLAogICAqIGByZXNldGAsIGBsb2FkYCwgYGVycm9yYCwgYW5kIGBzZWxlY3RgLgogICAqCiAgICogQm9ycm93cyBmcm9tIE1vZGVybml6ci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVTdWZmaXggRXZlbnQgbmFtZSwgZS5nLiAiY2xpY2siLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZC4KICAgKiBAaW50ZXJuYWwKICAgKiBAbGljZW5zZSBNb2Rlcm5penIgMy4wLjBwcmUgKEN1c3RvbSBCdWlsZCkgfCBNSVQKICAgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiB1c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5kIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpkZWNpbWFsLmpzLWxpZ2h0L2RlY2ltYWwuanM6CiAgKCohIGRlY2ltYWwuanMtbGlnaHQgdjIuNS4xIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWtlTWNsL2RlY2ltYWwuanMtbGlnaHQvTElDRU5DRSAqKQoKdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXdpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiB1c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL3NoYXJlZC9zcmMvdXRpbHMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9kZWZhdWx0QXR0cmlidXRlcy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9jcmVhdGVMdWNpZGVJY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctcmlnaHQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLWRvd24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9oZWFydC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvYWRlci5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21haWwuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tZXNzYWdlLXNxdWFyZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21pbnVzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGxheS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsdXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wcmludGVyLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcm90YXRlLWNjdy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2x1Y2lkZS1yZWFjdC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoqLwo=";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[Retirement Calculator] Failed to load:', err);
          const root = document.getElementById('retirement-calculator-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load calculator</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
