<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Optimizer — Simulate Cash, Stocks, Bonds, Crypto, Real Estate, and more.</title>
    <meta name="description" content="A portfolio simulator to project investment growth based on asset allocation, time horizon, and contribution strategy. Analyze stocks, bonds, crypto, and more." />
    <meta property="og:title" content="Portfolio Optimizer — Optimize Stocks, Bonds, Crypto, Real Estate, Cash, and more." />
    <meta property="og:description" content="A simulator to project investment growth based on asset allocation, time horizon, and contribution strategy. Analyze stocks, bonds, crypto, and more." />
    <meta name="keywords" content="portfolio optimizer, monte carlo simulation, asset allocation, stocks, bonds, crypto, investment growth, diversification, risk tolerance, 401k" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #F3F4F6;
        color: #1F2937;
        -webkit-font-smoothing: antialiased;
      }
      #portfolio-optimizer-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }
    </style>
      </head>
  <body>
    <div id="portfolio-optimizer-root"></div>
    <!-- 
      Load script via import() to avoid HTML parser issues with inline code
    -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9Owp2YXIgX19jb3B5UHJvcHMgPSAodG8yLCBmcm9tMiwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgaWYgKGZyb20yICYmIHR5cGVvZiBmcm9tMiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20yID09PSAiZnVuY3Rpb24iKSB7CiAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbTIpKQogICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvMiwga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8yLCBrZXksIHsgZ2V0OiAoKSA9PiBmcm9tMltrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20yLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzI7Cn07CnZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogIC8vIGZpbGUgdGhhdCBoYXMgYmVlbiBjb252ZXJ0ZWQgdG8gYSBDb21tb25KUyBmaWxlIHVzaW5nIGEgQmFiZWwtCiAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogIGlzTm9kZU1vZGUgfHwgIW1vZCB8fCAhbW9kLl9fZXNNb2R1bGUgPyBfX2RlZlByb3AodGFyZ2V0LCAiZGVmYXVsdCIsIHsgdmFsdWU6IG1vZCwgZW51bWVyYWJsZTogdHJ1ZSB9KSA6IHRhcmdldCwKICBtb2QKKSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmVsZW1lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfUE9SVEFMX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wb3J0YWwiKTsKICAgICAgICB2YXIgUkVBQ1RfRlJBR01FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmZyYWdtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdHJpY3RfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9QUk9GSUxFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvZmlsZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPVklERVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb3ZpZGVyIik7CiAgICAgICAgdmFyIFJFQUNUX0NPTlRFWFRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmNvbnRleHQiKTsKICAgICAgICB2YXIgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSB7CiAgICAgICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSB7CiAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgLy8gVXNlZCB0byByZXByb2R1Y2UgYmVoYXZpb3Igb2YgYGJhdGNoZWRVcGRhdGVzYCBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgIGlzQmF0Y2hpbmdMZWdhY3k6IGZhbHNlLAogICAgICAgICAgZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IHt9OwogICAgICAgIHZhciBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZSA9IGZ1bmN0aW9uKHN0YWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gIiI7CiAgICAgICAgICAgIGlmIChjdXJyZW50RXh0cmFTdGFja0ZyYW1lKSB7CiAgICAgICAgICAgICAgc3RhY2sgKz0gY3VycmVudEV4dHJhU3RhY2tGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwogICAgICAgICAgICBpZiAoaW1wbCkgewogICAgICAgICAgICAgIHN0YWNrICs9IGltcGwoKSB8fCAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLAogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcsCiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lcgogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJ3YXJuIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfY29uc3RydWN0b3IgPSBwdWJsaWNJbnN0YW5jZS5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBfY29uc3RydWN0b3IgJiYgKF9jb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSB8fCBfY29uc3RydWN0b3IubmFtZSkgfHwgIlJlYWN0Q2xhc3MiOwogICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IGNvbXBvbmVudE5hbWUgKyAiLiIgKyBjYWxsZXJOYW1lOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVycm9yKCJDYW4ndCBjYWxsICVzIG9uIGEgY29tcG9uZW50IHRoYXQgaXMgbm90IHlldCBtb3VudGVkLiBUaGlzIGlzIGEgbm8tb3AsIGJ1dCBpdCBtaWdodCBpbmRpY2F0ZSBhIGJ1ZyBpbiB5b3VyIGFwcGxpY2F0aW9uLiBJbnN0ZWFkLCBhc3NpZ24gdG8gYHRoaXMuc3RhdGVgIGRpcmVjdGx5IG9yIGRlZmluZSBhIGBzdGF0ZSA9IHt9O2AgY2xhc3MgcHJvcGVydHkgd2l0aCB0aGUgZGVzaXJlZCBzdGF0ZSBpbiB0aGUgJXMgY29tcG9uZW50LiIsIGNhbGxlck5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3ROb29wVXBkYXRlUXVldWUgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIENoZWNrcyB3aGV0aGVyIG9yIG5vdCB0aGlzIGNvbXBvc2l0ZSBjb21wb25lbnQgaXMgbW91bnRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHdlIHdhbnQgdG8gdGVzdC4KICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgbW91bnRlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICogQHByb3RlY3RlZAogICAgICAgICAgICogQGZpbmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGlzTW91bnRlZDogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogRm9yY2VzIGFuIHVwZGF0ZS4gVGhpcyBzaG91bGQgb25seSBiZSBpbnZva2VkIHdoZW4gaXQgaXMga25vd24gd2l0aAogICAgICAgICAgICogY2VydGFpbnR5IHRoYXQgd2UgYXJlICoqbm90KiogaW4gYSBET00gdHJhbnNhY3Rpb24uCiAgICAgICAgICAgKgogICAgICAgICAgICogWW91IG1heSB3YW50IHRvIGNhbGwgdGhpcyB3aGVuIHlvdSBrbm93IHRoYXQgc29tZSBkZWVwZXIgYXNwZWN0IG9mIHRoZQogICAgICAgICAgICogY29tcG9uZW50J3Mgc3RhdGUgaGFzIGNoYW5nZWQgYnV0IGBzZXRTdGF0ZWAgd2FzIG5vdCBjYWxsZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhpcyB3aWxsIG5vdCBpbnZva2UgYHNob3VsZENvbXBvbmVudFVwZGF0ZWAsIGJ1dCBpdCB3aWxsIGludm9rZQogICAgICAgICAgICogYGNvbXBvbmVudFdpbGxVcGRhdGVgIGFuZCBgY29tcG9uZW50RGlkVXBkYXRlYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgImZvcmNlVXBkYXRlIik7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBSZXBsYWNlcyBhbGwgb2YgdGhlIHN0YXRlLiBBbHdheXMgdXNlIHRoaXMgb3IgYHNldFN0YXRlYCB0byBtdXRhdGUgc3RhdGUuCiAgICAgICAgICAgKiBZb3Ugc2hvdWxkIHRyZWF0IGB0aGlzLnN0YXRlYCBhcyBpbW11dGFibGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlcmUgaXMgbm8gZ3VhcmFudGVlIHRoYXQgYHRoaXMuc3RhdGVgIHdpbGwgYmUgaW1tZWRpYXRlbHkgdXBkYXRlZCwgc28KICAgICAgICAgICAqIGFjY2Vzc2luZyBgdGhpcy5zdGF0ZWAgYWZ0ZXIgY2FsbGluZyB0aGlzIG1ldGhvZCBtYXkgcmV0dXJuIHRoZSBvbGQgdmFsdWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29tcGxldGVTdGF0ZSBOZXh0IHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gY2FsbGVyTmFtZSBuYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjb21wbGV0ZVN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInJlcGxhY2VTdGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogU2V0cyBhIHN1YnNldCBvZiB0aGUgc3RhdGUuIFRoaXMgb25seSBleGlzdHMgYmVjYXVzZSBfcGVuZGluZ1N0YXRlIGlzCiAgICAgICAgICAgKiBpbnRlcm5hbC4gVGhpcyBwcm92aWRlcyBhIG1lcmdpbmcgc3RyYXRlZ3kgdGhhdCBpcyBub3QgYXZhaWxhYmxlIHRvIGRlZXAKICAgICAgICAgICAqIHByb3BlcnRpZXMgd2hpY2ggaXMgY29uZnVzaW5nLiBUT0RPOiBFeHBvc2UgcGVuZGluZ1N0YXRlIG9yIGRvbid0IHVzZSBpdAogICAgICAgICAgICogZHVyaW5nIHRoZSBtZXJnZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJ0aWFsU3RhdGUgTmV4dCBwYXJ0aWFsIHN0YXRlIHRvIGJlIG1lcmdlZCB3aXRoIHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gTmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAic2V0U3RhdGUiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZW1wdHlPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50KHByb3BzLCBjb250ZXh0LCB1cGRhdGVyKSB7CiAgICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgdGhpcy5yZWZzID0gZW1wdHlPYmplY3Q7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICAgIH0KICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQgPSB7fTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24ocGFydGlhbFN0YXRlLCBjYWxsYmFjaykgewogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJvYmplY3QiICYmIHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJmdW5jdGlvbiIgJiYgcGFydGlhbFN0YXRlICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZXRTdGF0ZSguLi4pOiB0YWtlcyBhbiBvYmplY3Qgb2Ygc3RhdGUgdmFyaWFibGVzIHRvIHVwZGF0ZSBvciBhIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUodGhpcywgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgfTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmZvcmNlVXBkYXRlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlRm9yY2VVcGRhdGUodGhpcywgY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGRlcHJlY2F0ZWRBUElzID0gewogICAgICAgICAgICBpc01vdW50ZWQ6IFsiaXNNb3VudGVkIiwgIkluc3RlYWQsIG1ha2Ugc3VyZSB0byBjbGVhbiB1cCBzdWJzY3JpcHRpb25zIGFuZCBwZW5kaW5nIHJlcXVlc3RzIGluIGNvbXBvbmVudFdpbGxVbm1vdW50IHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzLiJdLAogICAgICAgICAgICByZXBsYWNlU3RhdGU6IFsicmVwbGFjZVN0YXRlIiwgIlJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2Ugc2V0U3RhdGUgaW5zdGVhZCAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMvMzIzNikuIl0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nID0gZnVuY3Rpb24obWV0aG9kTmFtZSwgaW5mbykgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ29tcG9uZW50LnByb3RvdHlwZSwgbWV0aG9kTmFtZSwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiJXMoLi4uKSBpcyBkZXByZWNhdGVkIGluIHBsYWluIEphdmFTY3JpcHQgUmVhY3QgY2xhc3Nlcy4gJXMiLCBpbmZvWzBdLCBpbmZvWzFdKTsKICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBmb3IgKHZhciBmbk5hbWUgaW4gZGVwcmVjYXRlZEFQSXMpIHsKICAgICAgICAgICAgaWYgKGRlcHJlY2F0ZWRBUElzLmhhc093blByb3BlcnR5KGZuTmFtZSkpIHsKICAgICAgICAgICAgICBkZWZpbmVEZXByZWNhdGlvbldhcm5pbmcoZm5OYW1lLCBkZXByZWNhdGVkQVBJc1tmbk5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDb21wb25lbnREdW1teSgpIHsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50RHVtbXkucHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICBmdW5jdGlvbiBQdXJlQ29tcG9uZW50Myhwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHB1cmVDb21wb25lbnRQcm90b3R5cGUgPSBQdXJlQ29tcG9uZW50My5wcm90b3R5cGUgPSBuZXcgQ29tcG9uZW50RHVtbXkoKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUHVyZUNvbXBvbmVudDM7CiAgICAgICAgYXNzaWduMihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSZWYoKSB7CiAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBPYmplY3Quc2VhbChyZWZPYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlZk9iamVjdDsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhMikgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lKHR5cGUsIHR5cGUucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgIHZhciBvdXRlck5hbWUgPSB0eXBlLmRpc3BsYXlOYW1lIHx8IG51bGw7CiAgICAgICAgICAgICAgICBpZiAob3V0ZXJOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBvdXRlck5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIk1lbW8iOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGluaXQocGF5bG9hZCkpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgICByZWY6IHRydWUsCiAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duLCBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biwgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgInJlZiIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5yZWYgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgImtleSIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYGtleWAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ0tleSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGByZWZgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nUmVmLmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcucmVmID09PSAic3RyaW5nIiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50ICYmIGNvbmZpZy5fX3NlbGYgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC5zdGF0ZU5vZGUgIT09IGNvbmZpZy5fX3NlbGYpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoJ0NvbXBvbmVudCAiJXMiIGNvbnRhaW5zIHRoZSBzdHJpbmcgcmVmICIlcyIuIFN1cHBvcnQgZm9yIHN0cmluZyByZWZzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBUaGlzIGNhc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uLiBXZSBhc2sgeW91IHRvIG1hbnVhbGx5IGZpeCB0aGlzIGNhc2UgYnkgdXNpbmcgdXNlUmVmKCkgb3IgY3JlYXRlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZicsIGNvbXBvbmVudE5hbWUsIGNvbmZpZy5yZWYpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbih0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYyCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zb3VyY2UiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNvdXJjZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudDQ1KHR5cGUsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgICAgdmFyIGtleSA9IG51bGw7CiAgICAgICAgICB2YXIgcmVmID0gbnVsbDsKICAgICAgICAgIHZhciBzZWxmMiA9IG51bGw7CiAgICAgICAgICB2YXIgc291cmNlID0gbnVsbDsKICAgICAgICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYyID0gY29uZmlnLl9fc2VsZiA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbmZpZy5fX3NlbGY7CiAgICAgICAgICAgIHNvdXJjZSA9IGNvbmZpZy5fX3NvdXJjZSA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbmZpZy5fX3NvdXJjZTsKICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkcmVuTGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCAtIDI7CiAgICAgICAgICBpZiAoY2hpbGRyZW5MZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW5MZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHZhciBjaGlsZEFycmF5ID0gQXJyYXkoY2hpbGRyZW5MZW5ndGgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjaGlsZEFycmF5W2ldID0gYXJndW1lbnRzW2kgKyAyXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoY2hpbGRBcnJheSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRBcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlICYmIHR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBkZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gUmVhY3RFbGVtZW50KHR5cGUsIGtleSwgcmVmLCBzZWxmMiwgc291cmNlLCBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lQW5kUmVwbGFjZUtleShvbGRFbGVtZW50LCBuZXdLZXkpIHsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gUmVhY3RFbGVtZW50KG9sZEVsZW1lbnQudHlwZSwgbmV3S2V5LCBvbGRFbGVtZW50LnJlZiwgb2xkRWxlbWVudC5fc2VsZiwgb2xkRWxlbWVudC5fc291cmNlLCBvbGRFbGVtZW50Ll9vd25lciwgb2xkRWxlbWVudC5wcm9wcyk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50MTAoZWxlbWVudCwgY29uZmlnLCBjaGlsZHJlbikgewogICAgICAgICAgaWYgKGVsZW1lbnQgPT09IG51bGwgfHwgZWxlbWVudCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuY2xvbmVFbGVtZW50KC4uLik6IFRoZSBhcmd1bWVudCBtdXN0IGJlIGEgUmVhY3QgZWxlbWVudCwgYnV0IHlvdSBwYXNzZWQgIiArIGVsZW1lbnQgKyAiLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgdmFyIHByb3BzID0gYXNzaWduMih7fSwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5rZXk7CiAgICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICB2YXIgc2VsZjIgPSBlbGVtZW50Ll9zZWxmOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSAmJiBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChjb25maWdbcHJvcE5hbWVdID09PSB2b2lkIDAgJiYgZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRBcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQoZWxlbWVudC50eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQxNyhvYmplY3QpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgfQogICAgICAgIHZhciBTRVBBUkFUT1IgPSAiLiI7CiAgICAgICAgdmFyIFNVQlNFUEFSQVRPUiA9ICI6IjsKICAgICAgICBmdW5jdGlvbiBlc2NhcGUoa2V5KSB7CiAgICAgICAgICB2YXIgZXNjYXBlUmVnZXggPSAvWz06XS9nOwogICAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAgICI9IjogIj0wIiwKICAgICAgICAgICAgIjoiOiAiPTIiCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVzY2FwZWRTdHJpbmcgPSBrZXkucmVwbGFjZShlc2NhcGVSZWdleCwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIGVzY2FwZXJMb29rdXBbbWF0Y2hdOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gIiQiICsgZXNjYXBlZFN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICB2YXIgdXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXggPSAvXC8rL2c7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlVXNlclByb3ZpZGVkS2V5KHRleHQpIHsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXgsICIkJi8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEtleShlbGVtZW50LCBpbmRleCkgewogICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAib2JqZWN0IiAmJiBlbGVtZW50ICE9PSBudWxsICYmIGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlc2NhcGUoIiIgKyBlbGVtZW50LmtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5kZXgudG9TdHJpbmcoMzYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuYW1lU29GYXIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IHR5cGVvZiBjaGlsZHJlbjsKICAgICAgICAgIGlmICh0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgY2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGludm9rZUNhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT09IG51bGwpIHsKICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGRyZW4uJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW52b2tlQ2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNoaWxkcmVuOwogICAgICAgICAgICB2YXIgbWFwcGVkQ2hpbGQgPSBjYWxsYmFjayhfY2hpbGQpOwogICAgICAgICAgICB2YXIgY2hpbGRLZXkgPSBuYW1lU29GYXIgPT09ICIiID8gU0VQQVJBVE9SICsgZ2V0RWxlbWVudEtleShfY2hpbGQsIDApIDogbmFtZVNvRmFyOwogICAgICAgICAgICBpZiAoaXNBcnJheTIobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgdmFyIGVzY2FwZWRDaGlsZEtleSA9ICIiOwogICAgICAgICAgICAgIGlmIChjaGlsZEtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlc2NhcGVkQ2hpbGRLZXkgPSBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoY2hpbGRLZXkpICsgIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYXBJbnRvQXJyYXkobWFwcGVkQ2hpbGQsIGFycmF5LCBlc2NhcGVkQ2hpbGRLZXksICIiLCBmdW5jdGlvbihjMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGMyOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1hcHBlZENoaWxkICE9IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNyhtYXBwZWRDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKG1hcHBlZENoaWxkLmtleSAmJiAoIV9jaGlsZCB8fCBfY2hpbGQua2V5ICE9PSBtYXBwZWRDaGlsZC5rZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihtYXBwZWRDaGlsZC5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtYXBwZWRDaGlsZCA9IGNsb25lQW5kUmVwbGFjZUtleSgKICAgICAgICAgICAgICAgICAgbWFwcGVkQ2hpbGQsCiAgICAgICAgICAgICAgICAgIC8vIEtlZXAgYm90aCB0aGUgKG1hcHBlZCkgYW5kIG9sZCBrZXlzIGlmIHRoZXkgZGlmZmVyLCBqdXN0IGFzCiAgICAgICAgICAgICAgICAgIC8vIHRyYXZlcnNlQWxsQ2hpbGRyZW4gdXNlZCB0byBkbyBmb3Igb2JqZWN0cyBhcyBjaGlsZHJlbgogICAgICAgICAgICAgICAgICBlc2NhcGVkUHJlZml4ICsgLy8gJEZsb3dGaXhNZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBSZWFjdC5Qb3J0YWwgZG9lc24ndCBoYXZlIGEga2V5CiAgICAgICAgICAgICAgICAgIChtYXBwZWRDaGlsZC5rZXkgJiYgKCFfY2hpbGQgfHwgX2NoaWxkLmtleSAhPT0gbWFwcGVkQ2hpbGQua2V5KSA/ICgKICAgICAgICAgICAgICAgICAgICAvLyAkRmxvd0ZpeE1lIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIGV4aXN0aW5nIGVsZW1lbnQncyBrZXkgY2FuIGJlIGEgbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWludGVybmFsL3NhZmUtc3RyaW5nLWNvZXJjaW9uCiAgICAgICAgICAgICAgICAgICAgZXNjYXBlVXNlclByb3ZpZGVkS2V5KCIiICsgbWFwcGVkQ2hpbGQua2V5KSArICIvIgogICAgICAgICAgICAgICAgICApIDogIiIpICsgY2hpbGRLZXkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFycmF5LnB1c2gobWFwcGVkQ2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgdmFyIG5leHROYW1lOwogICAgICAgICAgdmFyIHN1YnRyZWVDb3VudCA9IDA7CiAgICAgICAgICB2YXIgbmV4dE5hbWVQcmVmaXggPSBuYW1lU29GYXIgPT09ICIiID8gU0VQQVJBVE9SIDogbmFtZVNvRmFyICsgU1VCU0VQQVJBVE9SOwogICAgICAgICAgaWYgKGlzQXJyYXkyKGNoaWxkcmVuKSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICAgICAgICBuZXh0TmFtZSA9IG5leHROYW1lUHJlZml4ICsgZ2V0RWxlbWVudEtleShjaGlsZCwgaSk7CiAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5leHROYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihjaGlsZHJlbik7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBpdGVyYWJsZUNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gPT09IGl0ZXJhYmxlQ2hpbGRyZW4uZW50cmllcykgewogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1hcHMpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuMygiVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyBub3Qgc3VwcG9ydGVkLiBVc2UgYW4gYXJyYXkgb2Yga2V5ZWQgUmVhY3RFbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwoaXRlcmFibGVDaGlsZHJlbik7CiAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgdmFyIGlpID0gMDsKICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICBjaGlsZCA9IHN0ZXAudmFsdWU7CiAgICAgICAgICAgICAgICBuZXh0TmFtZSA9IG5leHROYW1lUHJlZml4ICsgZ2V0RWxlbWVudEtleShjaGlsZCwgaWkrKyk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlQ291bnQgKz0gbWFwSW50b0FycmF5KGNoaWxkLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmV4dE5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW5TdHJpbmcgPSBTdHJpbmcoY2hpbGRyZW4pOwogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT2JqZWN0cyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQgKGZvdW5kOiAiICsgKGNoaWxkcmVuU3RyaW5nID09PSAiW29iamVjdCBPYmplY3RdIiA/ICJvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY2hpbGRyZW4pLmpvaW4oIiwgIikgKyAifSIgOiBjaGlsZHJlblN0cmluZykgKyAiKS4gSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIGNvbGxlY3Rpb24gb2YgY2hpbGRyZW4sIHVzZSBhbiBhcnJheSBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3VidHJlZUNvdW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXBDaGlsZHJlbihjaGlsZHJlbiwgZnVuYywgY29udGV4dCkgewogICAgICAgICAgaWYgKGNoaWxkcmVuID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgIG1hcEludG9BcnJheShjaGlsZHJlbiwgcmVzdWx0LCAiIiwgIiIsIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgY2hpbGQsIGNvdW50KyspOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb3VudENoaWxkcmVuKGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgbiA9IDA7CiAgICAgICAgICBtYXBDaGlsZHJlbihjaGlsZHJlbiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG4rKzsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIG47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvckVhY2hDaGlsZHJlbihjaGlsZHJlbiwgZm9yRWFjaEZ1bmMsIGZvckVhY2hDb250ZXh0KSB7CiAgICAgICAgICBtYXBDaGlsZHJlbihjaGlsZHJlbiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZvckVhY2hGdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBmb3JFYWNoQ29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvQXJyYXkyKGNoaWxkcmVuKSB7CiAgICAgICAgICByZXR1cm4gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0pIHx8IFtdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbmx5Q2hpbGQoY2hpbGRyZW4pIHsKICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnQxNyhjaGlsZHJlbikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdC5DaGlsZHJlbi5vbmx5IGV4cGVjdGVkIHRvIHJlY2VpdmUgYSBzaW5nbGUgUmVhY3QgZWxlbWVudCBjaGlsZC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGV4dDEyKGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgIC8vIEFzIGEgd29ya2Fyb3VuZCB0byBzdXBwb3J0IG11bHRpcGxlIGNvbmN1cnJlbnQgcmVuZGVyZXJzLCB3ZSBjYXRlZ29yaXplCiAgICAgICAgICAgIC8vIHNvbWUgcmVuZGVyZXJzIGFzIHByaW1hcnkgYW5kIG90aGVycyBhcyBzZWNvbmRhcnkuIFdlIG9ubHkgZXhwZWN0CiAgICAgICAgICAgIC8vIHRoZXJlIHRvIGJlIHR3byBjb25jdXJyZW50IHJlbmRlcmVycyBhdCBtb3N0OiBSZWFjdCBOYXRpdmUgKHByaW1hcnkpIGFuZAogICAgICAgICAgICAvLyBGYWJyaWMgKHNlY29uZGFyeSk7IFJlYWN0IERPTSAocHJpbWFyeSkgYW5kIFJlYWN0IEFSVCAoc2Vjb25kYXJ5KS4KICAgICAgICAgICAgLy8gU2Vjb25kYXJ5IHJlbmRlcmVycyBzdG9yZSB0aGVpciBjb250ZXh0IHZhbHVlcyBvbiBzZXBhcmF0ZSBmaWVsZHMuCiAgICAgICAgICAgIF9jdXJyZW50VmFsdWU6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgLy8gVXNlZCB0byB0cmFjayBob3cgbWFueSBjb25jdXJyZW50IHJlbmRlcmVycyB0aGlzIGNvbnRleHQgY3VycmVudGx5CiAgICAgICAgICAgIC8vIHN1cHBvcnRzIHdpdGhpbiBpbiBhIHNpbmdsZSByZW5kZXJlci4gU3VjaCBhcyBwYXJhbGxlbCBzZXJ2ZXIgcmVuZGVyaW5nLgogICAgICAgICAgICBfdGhyZWFkQ291bnQ6IDAsCiAgICAgICAgICAgIC8vIFRoZXNlIGFyZSBjaXJjdWxhcgogICAgICAgICAgICBQcm92aWRlcjogbnVsbCwKICAgICAgICAgICAgQ29uc3VtZXI6IG51bGwsCiAgICAgICAgICAgIC8vIEFkZCB0aGVzZSB0byB1c2Ugc2FtZSBoaWRkZW4gY2xhc3MgaW4gVk0gYXMgU2VydmVyQ29udGV4dAogICAgICAgICAgICBfZGVmYXVsdFZhbHVlOiBudWxsLAogICAgICAgICAgICBfZ2xvYmFsTmFtZTogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QUk9WSURFUl9UWVBFLAogICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IGZhbHNlOwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIENvbnN1bWVyID0gewogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgICAgX2NvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ29uc3VtZXIsIHsKICAgICAgICAgICAgICBQcm92aWRlcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nQ29uc3VtZXJQcm92aWRlcikgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLlByb3ZpZGVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Qcm92aWRlcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Qcm92aWRlcjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9Qcm92aWRlcikgewogICAgICAgICAgICAgICAgICBjb250ZXh0LlByb3ZpZGVyID0gX1Byb3ZpZGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF9jdXJyZW50VmFsdWUyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTIgPSBfY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF90aHJlYWRDb3VudDogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX3RocmVhZENvdW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX3RocmVhZENvdW50ID0gX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgQ29uc3VtZXI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ05lc3RlZENvbnRleHRDb25zdW1lcnMpIHsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlcmluZyA8Q29udGV4dC5Db25zdW1lci5Db25zdW1lcj4gaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byByZW5kZXIgPENvbnRleHQuQ29uc3VtZXI+IGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuQ29uc3VtZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihkaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjMoIlNldHRpbmcgYGRpc3BsYXlOYW1lYCBvbiBDb250ZXh0LkNvbnN1bWVyIGhhcyBubyBlZmZlY3QuIFlvdSBzaG91bGQgc2V0IGl0IGRpcmVjdGx5IG9uIHRoZSBjb250ZXh0IHdpdGggQ29udGV4dC5kaXNwbGF5TmFtZSA9ICclcycuIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnRleHQuQ29uc3VtZXIgPSBDb25zdW1lcjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyID0gbnVsbDsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyMiA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgdmFyIFVuaW5pdGlhbGl6ZWQgPSAtMTsKICAgICAgICB2YXIgUGVuZGluZyA9IDA7CiAgICAgICAgdmFyIFJlc29sdmVkID0gMTsKICAgICAgICB2YXIgUmVqZWN0ZWQgPSAyOwogICAgICAgIGZ1bmN0aW9uIGxhenlJbml0aWFsaXplcihwYXlsb2FkKSB7CiAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgIHZhciBjdG9yID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICB2YXIgdGhlbmFibGUgPSBjdG9yKCk7CiAgICAgICAgICAgIHRoZW5hYmxlLnRoZW4oZnVuY3Rpb24obW9kdWxlT2JqZWN0MikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3N0YXR1cyA9IFJlc29sdmVkOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3Jlc3VsdCA9IG1vZHVsZU9iamVjdDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBQZW5kaW5nIHx8IHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgdmFyIHJlamVjdGVkID0gcGF5bG9hZDsKICAgICAgICAgICAgICAgIHJlamVjdGVkLl9zdGF0dXMgPSBSZWplY3RlZDsKICAgICAgICAgICAgICAgIHJlamVjdGVkLl9yZXN1bHQgPSBlcnJvcjI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gcGF5bG9hZDsKICAgICAgICAgICAgICBwZW5kaW5nLl9zdGF0dXMgPSBQZW5kaW5nOwogICAgICAgICAgICAgIHBlbmRpbmcuX3Jlc3VsdCA9IHRoZW5hYmxlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBSZXNvbHZlZCkgewogICAgICAgICAgICB2YXIgbW9kdWxlT2JqZWN0ID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG1vZHVsZU9iamVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpXG5cbkRpZCB5b3UgYWNjaWRlbnRhbGx5IHB1dCBjdXJseSBicmFjZXMgYXJvdW5kIHRoZSBpbXBvcnQ/IiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghKCJkZWZhdWx0IiBpbiBtb2R1bGVPYmplY3QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpIiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZHVsZU9iamVjdC5kZWZhdWx0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYXp5KGN0b3IpIHsKICAgICAgICAgIHZhciBwYXlsb2FkID0gewogICAgICAgICAgICAvLyBXZSB1c2UgdGhlc2UgZmllbGRzIHRvIHN0b3JlIHRoZSByZXN1bHQuCiAgICAgICAgICAgIF9zdGF0dXM6IFVuaW5pdGlhbGl6ZWQsCiAgICAgICAgICAgIF9yZXN1bHQ6IGN0b3IKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgbGF6eVR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9MQVpZX1RZUEUsCiAgICAgICAgICAgIF9wYXlsb2FkOiBwYXlsb2FkLAogICAgICAgICAgICBfaW5pdDogbGF6eUluaXRpYWxpemVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhsYXp5VHlwZSwgewogICAgICAgICAgICAgIGRlZmF1bHRQcm9wczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld0RlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgZGVmYXVsdFByb3BzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcm9wcyA9IG5ld0RlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAiZGVmYXVsdFByb3BzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBwcm9wVHlwZXM6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9wVHlwZXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuZXdQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmxhenkoLi4uKTogSXQgaXMgbm90IHN1cHBvcnRlZCB0byBhc3NpZ24gYHByb3BUeXBlc2AgdG8gYSBsYXp5IGNvbXBvbmVudCBpbXBvcnQuIEVpdGhlciBzcGVjaWZ5IHRoZW0gd2hlcmUgdGhlIGNvbXBvbmVudCBpcyBkZWZpbmVkLCBvciBjcmVhdGUgYSB3cmFwcGluZyBjb21wb25lbnQgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICAgICAgICBwcm9wVHlwZXMgPSBuZXdQcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShsYXp5VHlwZSwgInByb3BUeXBlcyIsIHsKICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGF6eVR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcndhcmRSZWYxNyhyZW5kZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsICYmIHJlbmRlci4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMikgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCByZWNlaXZlZCBhIGBtZW1vYCBjb21wb25lbnQuIEluc3RlYWQgb2YgZm9yd2FyZFJlZihtZW1vKC4uLikpLCB1c2UgbWVtbyhmb3J3YXJkUmVmKC4uLikpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgd2FzIGdpdmVuICVzLiIsIHJlbmRlciA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiByZW5kZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChyZW5kZXIubGVuZ3RoICE9PSAwICYmIHJlbmRlci5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgYWNjZXB0IGV4YWN0bHkgdHdvIHBhcmFtZXRlcnM6IHByb3BzIGFuZCByZWYuICVzIiwgcmVuZGVyLmxlbmd0aCA9PT0gMSA/ICJEaWQgeW91IGZvcmdldCB0byB1c2UgdGhlIHJlZiBwYXJhbWV0ZXI/IiA6ICJBbnkgYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2lsbCBiZSB1bmRlZmluZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChyZW5kZXIuZGVmYXVsdFByb3BzICE9IG51bGwgfHwgcmVuZGVyLnByb3BUeXBlcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGRvIG5vdCBzdXBwb3J0IHByb3BUeXBlcyBvciBkZWZhdWx0UHJvcHMuIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgYSBSZWFjdCBjb21wb25lbnQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiwKICAgICAgICAgICAgcmVuZGVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duTmFtZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnRUeXBlLCAiZGlzcGxheU5hbWUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAoIXJlbmRlci5uYW1lICYmICFyZW5kZXIuZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyLmRpc3BsYXlOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlOwogICAgICAgIH0KICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICB7CiAgICAgICAgICBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QubW9kdWxlLnJlZmVyZW5jZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUgPT09IFJFQUNUX09GRlNDUkVFTl9UWVBFIHx8IGVuYWJsZVNjb3BlQVBJIHx8IGVuYWJsZUNhY2hlRWxlbWVudCB8fCBlbmFibGVUcmFuc2l0aW9uVHJhY2luZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgfHwgLy8gVGhpcyBuZWVkcyB0byBpbmNsdWRlIGFsbCBwb3NzaWJsZSBtb2R1bGUgcmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICAvLyB0eXBlcyBzdXBwb3J0ZWQgYnkgYW55IEZsaWdodCBjb25maWd1cmF0aW9uIGFueXdoZXJlIHNpbmNlCiAgICAgICAgICAgIC8vIHdlIGRvbid0IGtub3cgd2hpY2ggRmxpZ2h0IGJ1aWxkIHRoaXMgd2lsbCBlbmQgdXAgYmVpbmcgdXNlZAogICAgICAgICAgICAvLyB3aXRoLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFIHx8IHR5cGUuZ2V0TW9kdWxlSWQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lbW84KHR5cGUsIGNvbXBhcmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkpIHsKICAgICAgICAgICAgICBlcnJvcigibWVtbzogVGhlIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBjb21wb25lbnQuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzIiwgdHlwZSA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfTUVNT19UWVBFMiwKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgY29tcGFyZTogY29tcGFyZSA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbXBhcmUKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghdHlwZS5uYW1lICYmICF0eXBlLmRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIHR5cGUuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VDb250ZXh0MTIoQ29udGV4dCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29udGV4dC5fY29udGV4dCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlYWxDb250ZXh0ID0gQ29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgICBpZiAocmVhbENvbnRleHQuQ29uc3VtZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Db25zdW1lcikgaXMgbm90IHN1cHBvcnRlZCwgbWF5IGNhdXNlIGJ1Z3MsIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVhbENvbnRleHQuUHJvdmlkZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Qcm92aWRlcikgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ29udGV4dChDb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlU3RhdGUxNShpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZjE3KGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUVmZmVjdDE2KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VMYXlvdXRFZmZlY3Q5KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNhbGxiYWNrOChjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VNZW1vMTAoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUltcGVyYXRpdmVIYW5kbGUzKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRGVidWdWYWx1ZTIodmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlVHJhbnNpdGlvbigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSWQyKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSWQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlU3luY0V4dGVybmFsU3RvcmUyKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgfQogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2SW5mbwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB3YXJuOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXAKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoZm4sIFtdLCBGYWtlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgRmFrZS5jYWxsKCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgczIgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjMiA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzMiA+PSAxICYmIGMyID49IDAgJiYgc2FtcGxlTGluZXNbczJdICE9PSBjb250cm9sTGluZXNbYzJdKSB7CiAgICAgICAgICAgICAgICBjMi0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgczIgPj0gMSAmJiBjMiA+PSAwOyBzMi0tLCBjMi0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbczJdICE9PSBjb250cm9sTGluZXNbYzJdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzMiAhPT0gMSB8fCBjMiAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMyLS07CiAgICAgICAgICAgICAgICAgICAgICBjMi0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMyIDwgMCB8fCBzYW1wbGVMaW5lc1tzMl0gIT09IGNvbnRyb2xMaW5lc1tjMl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzMl0ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzMiA+PSAxICYmIGMyID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50MikgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudDIucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLnR5cGUsIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoaW5pdChwYXlsb2FkKSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzMyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzMyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIHNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bjsKICAgICAgICB7CiAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCkgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgbmFtZSArICJgLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKSB7CiAgICAgICAgICBpZiAoc291cmNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgdmFyIGxpbmVOdW1iZXIgPSBzb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICIgKyBmaWxlTmFtZSArICI6IiArIGxpbmVOdW1iZXIgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMoZWxlbWVudFByb3BzKSB7CiAgICAgICAgICBpZiAoZWxlbWVudFByb3BzICE9PSBudWxsICYmIGVsZW1lbnRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShlbGVtZW50UHJvcHMuX19zb3VyY2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgaWYgKCFpbmZvKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgIGluZm8gPSAiXG5cbkNoZWNrIHRoZSB0b3AtbGV2ZWwgcmVuZGVyIGNhbGwgdXNpbmcgPCIgKyBwYXJlbnROYW1lICsgIj4uIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQXJyYXkyKG5vZGUpKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTcoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQxNyhub2RlKSkgewogICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICBub2RlLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5vZGUpOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTcoc3RlcC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcFR5cGVzKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsIHx8IHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BUeXBlczsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBOb3RlOiBNZW1vIG9ubHkgY2hlY2tzIG91dGVyIHByb3BzIGhlcmUuCiAgICAgICAgICAgIC8vIElubmVyIHByb3BzIGFyZSBjaGVja2VkIGluIHRoZSByZWNvbmNpbGVyLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciB2YWxpZFR5cGUgPSBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSk7CiAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsICYmIE9iamVjdC5rZXlzKHR5cGUpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSW5mbyA9IGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMocHJvcHMpOwogICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgIGluZm8gKz0gc291cmNlSW5mbzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAibnVsbCI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheTIodHlwZSkpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSB2b2lkIDAgJiYgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSB0eXBlb2YgdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmNyZWF0ZUVsZW1lbnQ6IHR5cGUgaXMgaW52YWxpZCAtLSBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMiLCB0eXBlU3RyaW5nLCBpbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnQgPSBjcmVhdGVFbGVtZW50NDUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsaWRUeXBlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgdmFsaWRhdGVGcmFnbWVudFByb3BzKGVsZW1lbnQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uKHR5cGUpIHsKICAgICAgICAgIHZhciB2YWxpZGF0ZWRGYWN0b3J5ID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uLmJpbmQobnVsbCwgdHlwZSk7CiAgICAgICAgICB2YWxpZGF0ZWRGYWN0b3J5LnR5cGUgPSB0eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5KSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkgPSB0cnVlOwogICAgICAgICAgICAgIHdhcm4zKCJSZWFjdC5jcmVhdGVGYWN0b3J5KCkgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIENvbnNpZGVyIHVzaW5nIEpTWCBvciB1c2UgUmVhY3QuY3JlYXRlRWxlbWVudCgpIGRpcmVjdGx5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHZhbGlkYXRlZEZhY3RvcnksICJ0eXBlIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiRmFjdG9yeS50eXBlIGlzIGRlcHJlY2F0ZWQuIEFjY2VzcyB0aGUgY2xhc3MgZGlyZWN0bHkgYmVmb3JlIHBhc3NpbmcgaXQgdG8gY3JlYXRlRmFjdG9yeS4iKTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAidHlwZSIsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHR5cGUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWxpZGF0ZWRGYWN0b3J5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbihlbGVtZW50LCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gY2xvbmVFbGVtZW50MTAuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGFyZ3VtZW50c1tpXSwgbmV3RWxlbWVudC50eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhbGlkYXRlUHJvcFR5cGVzKG5ld0VsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ld0VsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzY29wZSwgb3B0aW9ucykgewogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSB7fTsKICAgICAgICAgIHZhciBjdXJyZW50VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2NvcGUoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZWRGaWJlcnNDb3VudCA9IGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLnNpemU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlZEZpYmVyc0NvdW50ID4gMTApIHsKICAgICAgICAgICAgICAgICAgd2FybjMoIkRldGVjdGVkIGEgbGFyZ2UgbnVtYmVyIG9mIHVwZGF0ZXMgaW5zaWRlIHN0YXJ0VHJhbnNpdGlvbi4gSWYgdGhpcyBpcyBkdWUgdG8gYSBzdWJzY3JpcHRpb24gcGxlYXNlIHJlLXdyaXRlIGl0IHRvIHVzZSBSZWFjdCBwcm92aWRlZCBob29rcy4gT3RoZXJ3aXNlIGNvbmN1cnJlbnQgbW9kZSBndWFyYW50ZWVzIGFyZSBvZmYgdGhlIHRhYmxlLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID0gZmFsc2U7CiAgICAgICAgdmFyIGVucXVldWVUYXNrSW1wbCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVRhc2sodGFzazIpIHsKICAgICAgICAgIGlmIChlbnF1ZXVlVGFza0ltcGwgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgcmVxdWlyZVN0cmluZyA9ICgicmVxdWlyZSIgKyBNYXRoLnJhbmRvbSgpKS5zbGljZSgwLCA3KTsKICAgICAgICAgICAgICB2YXIgbm9kZVJlcXVpcmUgPSBtb2R1bGUgJiYgbW9kdWxlW3JlcXVpcmVTdHJpbmddOwogICAgICAgICAgICAgIGVucXVldWVUYXNrSW1wbCA9IG5vZGVSZXF1aXJlLmNhbGwobW9kdWxlLCAidGltZXJzIikuc2V0SW1tZWRpYXRlOwogICAgICAgICAgICB9IGNhdGNoIChfZXJyKSB7CiAgICAgICAgICAgICAgZW5xdWV1ZVRhc2tJbXBsID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBoYXZlIGEgTWVzc2FnZUNoYW5uZWwgaW1wbGVtZW50YXRpb24sIHNvIGVucXVldWluZyB0YXNrcyB2aWEgYXdhaXQgYWN0KGFzeW5jICgpID0+IC4uLikgd2lsbCBmYWlsLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZSBhdCBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzIGlmIHlvdSBlbmNvdW50ZXIgdGhpcyB3YXJuaW5nLiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKHZvaWQgMCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVucXVldWVUYXNrSW1wbCh0YXNrMik7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RTY29wZURlcHRoID0gMDsKICAgICAgICB2YXIgZGlkV2Fybk5vQXdhaXRBY3QgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBhY3QoY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByZXZBY3RTY29wZURlcHRoID0gYWN0U2NvcGVEZXB0aDsKICAgICAgICAgICAgYWN0U2NvcGVEZXB0aCsrOwogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldklzQmF0Y2hpbmdMZWdhY3kgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3kgPSB0cnVlOwogICAgICAgICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgaWYgKCFwcmV2SXNCYXRjaGluZ0xlZ2FjeSAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHByZXZJc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgICAgIHZhciB3YXNBd2FpdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlID0gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgIHdhc0F3YWl0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aGVuYWJsZVJlc3VsdC50aGVuKGZ1bmN0aW9uKHJldHVyblZhbHVlMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZTIsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5Ob0F3YWl0QWN0ICYmIHR5cGVvZiBQcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghd2FzQXdhaXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2Fybk5vQXdhaXRBY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBjYWxsZWQgYWN0KGFzeW5jICgpID0+IC4uLikgd2l0aG91dCBhd2FpdC4gVGhpcyBjb3VsZCBsZWFkIHRvIHVuZXhwZWN0ZWQgdGVzdGluZyBiZWhhdmlvdXIsIGludGVybGVhdmluZyBtdWx0aXBsZSBhY3QgY2FsbHMgYW5kIG1peGluZyB0aGVpciBzY29wZXMuIFlvdSBzaG91bGQgLSBhd2FpdCBhY3QoYXN5bmMgKCkgPT4gLi4uKTsiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGhlbmFibGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlID0gcmVzdWx0OwogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdmFyIF9xdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoX3F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUoX3F1ZXVlKTsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlID0gewogICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIF90aGVuYWJsZTIgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmV2QWN0U2NvcGVEZXB0aCAhPT0gYWN0U2NvcGVEZXB0aCAtIDEpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHNlZW0gdG8gaGF2ZSBvdmVybGFwcGluZyBhY3QoKSBjYWxscywgdGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBCZSBzdXJlIHRvIGF3YWl0IHByZXZpb3VzIGFjdCgpIGNhbGxzIGJlZm9yZSBtYWtpbmcgYSBuZXcgb25lLiAiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3RTY29wZURlcHRoID0gcHJldkFjdFNjb3BlRGVwdGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShxdWV1ZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlVGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmx1c2hBY3RRdWV1ZShxdWV1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmx1c2hpbmcpIHsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcXVldWUgPSBxdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUVsZW1lbnQkMSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY2xvbmVFbGVtZW50JDEgPSBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgQ2hpbGRyZW4yID0gewogICAgICAgICAgbWFwOiBtYXBDaGlsZHJlbiwKICAgICAgICAgIGZvckVhY2g6IGZvckVhY2hDaGlsZHJlbiwKICAgICAgICAgIGNvdW50OiBjb3VudENoaWxkcmVuLAogICAgICAgICAgdG9BcnJheTogdG9BcnJheTIsCiAgICAgICAgICBvbmx5OiBvbmx5Q2hpbGQKICAgICAgICB9OwogICAgICAgIGV4cG9ydHMuQ2hpbGRyZW4gPSBDaGlsZHJlbjI7CiAgICAgICAgZXhwb3J0cy5Db21wb25lbnQgPSBDb21wb25lbnQ7CiAgICAgICAgZXhwb3J0cy5GcmFnbWVudCA9IFJFQUNUX0ZSQUdNRU5UX1RZUEU7CiAgICAgICAgZXhwb3J0cy5Qcm9maWxlciA9IFJFQUNUX1BST0ZJTEVSX1RZUEU7CiAgICAgICAgZXhwb3J0cy5QdXJlQ29tcG9uZW50ID0gUHVyZUNvbXBvbmVudDM7CiAgICAgICAgZXhwb3J0cy5TdHJpY3RNb2RlID0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRTsKICAgICAgICBleHBvcnRzLlN1c3BlbnNlID0gUkVBQ1RfU1VTUEVOU0VfVFlQRTsKICAgICAgICBleHBvcnRzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gUmVhY3RTaGFyZWRJbnRlcm5hbHM7CiAgICAgICAgZXhwb3J0cy5hY3QgPSBhY3Q7CiAgICAgICAgZXhwb3J0cy5jbG9uZUVsZW1lbnQgPSBjbG9uZUVsZW1lbnQkMTsKICAgICAgICBleHBvcnRzLmNyZWF0ZUNvbnRleHQgPSBjcmVhdGVDb250ZXh0MTI7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3Rvcnk7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVSZWYgPSBjcmVhdGVSZWY7CiAgICAgICAgZXhwb3J0cy5mb3J3YXJkUmVmID0gZm9yd2FyZFJlZjE3OwogICAgICAgIGV4cG9ydHMuaXNWYWxpZEVsZW1lbnQgPSBpc1ZhbGlkRWxlbWVudDE3OwogICAgICAgIGV4cG9ydHMubGF6eSA9IGxhenk7CiAgICAgICAgZXhwb3J0cy5tZW1vID0gbWVtbzg7CiAgICAgICAgZXhwb3J0cy5zdGFydFRyYW5zaXRpb24gPSBzdGFydFRyYW5zaXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9hY3QgPSBhY3Q7CiAgICAgICAgZXhwb3J0cy51c2VDYWxsYmFjayA9IHVzZUNhbGxiYWNrODsKICAgICAgICBleHBvcnRzLnVzZUNvbnRleHQgPSB1c2VDb250ZXh0MTI7CiAgICAgICAgZXhwb3J0cy51c2VEZWJ1Z1ZhbHVlID0gdXNlRGVidWdWYWx1ZTI7CiAgICAgICAgZXhwb3J0cy51c2VEZWZlcnJlZFZhbHVlID0gdXNlRGVmZXJyZWRWYWx1ZTsKICAgICAgICBleHBvcnRzLnVzZUVmZmVjdCA9IHVzZUVmZmVjdDE2OwogICAgICAgIGV4cG9ydHMudXNlSWQgPSB1c2VJZDI7CiAgICAgICAgZXhwb3J0cy51c2VJbXBlcmF0aXZlSGFuZGxlID0gdXNlSW1wZXJhdGl2ZUhhbmRsZTM7CiAgICAgICAgZXhwb3J0cy51c2VJbnNlcnRpb25FZmZlY3QgPSB1c2VJbnNlcnRpb25FZmZlY3Q7CiAgICAgICAgZXhwb3J0cy51c2VMYXlvdXRFZmZlY3QgPSB1c2VMYXlvdXRFZmZlY3Q5OwogICAgICAgIGV4cG9ydHMudXNlTWVtbyA9IHVzZU1lbW8xMDsKICAgICAgICBleHBvcnRzLnVzZVJlZHVjZXIgPSB1c2VSZWR1Y2VyOwogICAgICAgIGV4cG9ydHMudXNlUmVmID0gdXNlUmVmMTc7CiAgICAgICAgZXhwb3J0cy51c2VTdGF0ZSA9IHVzZVN0YXRlMTU7CiAgICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMjsKICAgICAgICBleHBvcnRzLnVzZVRyYW5zaXRpb24gPSB1c2VUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcwp2YXIgcmVxdWlyZV9yZWFjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9zY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NoZWR1bGVyRGVidWdnaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGluZyA9IGZhbHNlOwogICAgICAgIHZhciBmcmFtZVlpZWxkTXMgPSA1OwogICAgICAgIGZ1bmN0aW9uIHB1c2goaGVhcCwgbm9kZSkgewogICAgICAgICAgdmFyIGluZGV4ID0gaGVhcC5sZW5ndGg7CiAgICAgICAgICBoZWFwLnB1c2gobm9kZSk7CiAgICAgICAgICBzaWZ0VXAoaGVhcCwgbm9kZSwgaW5kZXgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZWVrMyhoZWFwKSB7CiAgICAgICAgICByZXR1cm4gaGVhcC5sZW5ndGggPT09IDAgPyBudWxsIDogaGVhcFswXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wKGhlYXApIHsKICAgICAgICAgIGlmIChoZWFwLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdCA9IGhlYXBbMF07CiAgICAgICAgICB2YXIgbGFzdDIgPSBoZWFwLnBvcCgpOwogICAgICAgICAgaWYgKGxhc3QyICE9PSBmaXJzdCkgewogICAgICAgICAgICBoZWFwWzBdID0gbGFzdDI7CiAgICAgICAgICAgIHNpZnREb3duKGhlYXAsIGxhc3QyLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdFVwKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPiAwKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmRleCA9IGluZGV4IC0gMSA+Pj4gMTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGhlYXBbcGFyZW50SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShwYXJlbnQsIG5vZGUpID4gMCkgewogICAgICAgICAgICAgIGhlYXBbcGFyZW50SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHBhcmVudDsKICAgICAgICAgICAgICBpbmRleCA9IHBhcmVudEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0RG93bihoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgdmFyIGhhbGZMZW5ndGggPSBsZW5ndGggPj4+IDE7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBoYWxmTGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0SW5kZXggPSAoaW5kZXggKyAxKSAqIDIgLSAxOwogICAgICAgICAgICB2YXIgbGVmdCA9IGhlYXBbbGVmdEluZGV4XTsKICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBsZWZ0SW5kZXggKyAxOwogICAgICAgICAgICB2YXIgcmlnaHQgPSBoZWFwW3JpZ2h0SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShsZWZ0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBsZWZ0KSA8IDApIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBsZWZ0OwogICAgICAgICAgICAgICAgaGVhcFtsZWZ0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbGVmdEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEyLCBiKSB7CiAgICAgICAgICB2YXIgZGlmZiA9IGEyLnNvcnRJbmRleCAtIGIuc29ydEluZGV4OwogICAgICAgICAgcmV0dXJuIGRpZmYgIT09IDAgPyBkaWZmIDogYTIuaWQgLSBiLmlkOwogICAgICAgIH0KICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSAxOwogICAgICAgIHZhciBVc2VyQmxvY2tpbmdQcmlvcml0eSA9IDI7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gMzsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSA0OwogICAgICAgIHZhciBJZGxlUHJpb3JpdHkgPSA1OwogICAgICAgIGZ1bmN0aW9uIG1hcmtUYXNrRXJyb3JlZCh0YXNrMiwgbXMpIHsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1BlcmZvcm1hbmNlTm93ID0gdHlwZW9mIHBlcmZvcm1hbmNlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAiZnVuY3Rpb24iOwogICAgICAgIGlmIChoYXNQZXJmb3JtYW5jZU5vdykgewogICAgICAgICAgdmFyIGxvY2FsUGVyZm9ybWFuY2UgPSBwZXJmb3JtYW5jZTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbFBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGxvY2FsRGF0ZTIgPSBEYXRlOwogICAgICAgICAgdmFyIGluaXRpYWxUaW1lID0gbG9jYWxEYXRlMi5ub3coKTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbERhdGUyLm5vdygpIC0gaW5pdGlhbFRpbWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbWF4U2lnbmVkMzFCaXRJbnQgPSAxMDczNzQxODIzOwogICAgICAgIHZhciBJTU1FRElBVEVfUFJJT1JJVFlfVElNRU9VVCA9IC0xOwogICAgICAgIHZhciBVU0VSX0JMT0NLSU5HX1BSSU9SSVRZX1RJTUVPVVQgPSAyNTA7CiAgICAgICAgdmFyIE5PUk1BTF9QUklPUklUWV9USU1FT1VUID0gNWUzOwogICAgICAgIHZhciBMT1dfUFJJT1JJVFlfVElNRU9VVCA9IDFlNDsKICAgICAgICB2YXIgSURMRV9QUklPUklUWV9USU1FT1VUID0gbWF4U2lnbmVkMzFCaXRJbnQ7CiAgICAgICAgdmFyIHRhc2tRdWV1ZSA9IFtdOwogICAgICAgIHZhciB0aW1lclF1ZXVlID0gW107CiAgICAgICAgdmFyIHRhc2tJZENvdW50ZXIgPSAxOwogICAgICAgIHZhciBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgdmFyIGlzUGVyZm9ybWluZ1dvcmsgPSBmYWxzZTsKICAgICAgICB2YXIgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIHZhciBsb2NhbFNldFRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiBudWxsOwogICAgICAgIHZhciBsb2NhbENsZWFyVGltZW91dCA9IHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBjbGVhclRpbWVvdXQgOiBudWxsOwogICAgICAgIHZhciBsb2NhbFNldEltbWVkaWF0ZSA9IHR5cGVvZiBzZXRJbW1lZGlhdGUgIT09ICJ1bmRlZmluZWQiID8gc2V0SW1tZWRpYXRlIDogbnVsbDsKICAgICAgICB2YXIgaXNJbnB1dFBlbmRpbmcgPSB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3Iuc2NoZWR1bGluZyAhPT0gdm9pZCAwICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nICE9PSB2b2lkIDAgPyBuYXZpZ2F0b3Iuc2NoZWR1bGluZy5pc0lucHV0UGVuZGluZy5iaW5kKG5hdmlnYXRvci5zY2hlZHVsaW5nKSA6IG51bGw7CiAgICAgICAgZnVuY3Rpb24gYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAodGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHRpbWVyLmNhbGxiYWNrID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcG9wKHRpbWVyUXVldWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRpbWVyLnN0YXJ0VGltZSA8PSBjdXJyZW50VGltZSkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgICB0aW1lci5zb3J0SW5kZXggPSB0aW1lci5leHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgdGltZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lb3V0KGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQpIHsKICAgICAgICAgICAgaWYgKHBlZWszKHRhc2tRdWV1ZSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBmaXJzdFRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hXb3JrKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIGlmIChpc0hvc3RUaW1lb3V0U2NoZWR1bGVkKSB7CiAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzUGVyZm9ybWluZ1dvcmsgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGluZykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgICAgIG1hcmtUYXNrRXJyb3JlZChjdXJyZW50VGFzaywgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICBjdXJyZW50VGFzay5pc1F1ZXVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gaW5pdGlhbFRpbWUyOwogICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAoY3VycmVudFRhc2sgIT09IG51bGwgJiYgIWVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZykgewogICAgICAgICAgICBpZiAoY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPiBjdXJyZW50VGltZSAmJiAoIWhhc1RpbWVSZW1haW5pbmcgfHwgc2hvdWxkWWllbGRUb0hvc3QoKSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBjdXJyZW50VGFzay5jYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRUYXNrLnByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgdmFyIGRpZFVzZXJDYWxsYmFja1RpbWVvdXQgPSBjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICB2YXIgY29udGludWF0aW9uQ2FsbGJhY2sgPSBjYWxsYmFjayhkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0KTsKICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250aW51YXRpb25DYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBjb250aW51YXRpb25DYWxsYmFjazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrID09PSBwZWVrMyh0YXNrUXVldWUpKSB7CiAgICAgICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AodGFza1F1ZXVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudFRhc2sgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgICBpZiAoZmlyc3RUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3J1bldpdGhQcmlvcml0eShwcmlvcml0eUxldmVsLCBldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfbmV4dChldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHZhciBwcmlvcml0eUxldmVsOwogICAgICAgICAgc3dpdGNoIChjdXJyZW50UHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfd3JhcENhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgcGFyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcGFyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjaywgb3B0aW9ucykgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgIHZhciBzdGFydFRpbWUyOwogICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAib2JqZWN0IiAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiICYmIGRlbGF5ID4gMCkgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZSArIGRlbGF5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRpbWVvdXQ7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElETEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gTE9XX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGltZW91dCA9IE5PUk1BTF9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gc3RhcnRUaW1lMiArIHRpbWVvdXQ7CiAgICAgICAgICB2YXIgbmV3VGFzayA9IHsKICAgICAgICAgICAgaWQ6IHRhc2tJZENvdW50ZXIrKywKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwsCiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lMiwKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgIHNvcnRJbmRleDogLTEKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoc3RhcnRUaW1lMiA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIG5ld1Rhc2suc29ydEluZGV4ID0gc3RhcnRUaW1lMjsKICAgICAgICAgICAgcHVzaCh0aW1lclF1ZXVlLCBuZXdUYXNrKTsKICAgICAgICAgICAgaWYgKHBlZWszKHRhc2tRdWV1ZSkgPT09IG51bGwgJiYgbmV3VGFzayA9PT0gcGVlazModGltZXJRdWV1ZSkpIHsKICAgICAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBzdGFydFRpbWUyIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdUYXNrLnNvcnRJbmRleCA9IGV4cGlyYXRpb25UaW1lOwogICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3VGFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcGF1c2VFeGVjdXRpb24oKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uKCkgewogICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCAmJiAhaXNQZXJmb3JtaW5nV29yaykgewogICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGUoKSB7CiAgICAgICAgICByZXR1cm4gcGVlazModGFza1F1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sodGFzazIpIHsKICAgICAgICAgIHRhc2syLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgfQogICAgICAgIHZhciBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgIHZhciBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgIHZhciB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgdmFyIGZyYW1lSW50ZXJ2YWwgPSBmcmFtZVlpZWxkTXM7CiAgICAgICAgdmFyIHN0YXJ0VGltZSA9IC0xOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFlpZWxkVG9Ib3N0KCkgewogICAgICAgICAgdmFyIHRpbWVFbGFwc2VkID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKSAtIHN0YXJ0VGltZTsKICAgICAgICAgIGlmICh0aW1lRWxhcHNlZCA8IGZyYW1lSW50ZXJ2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RQYWludCgpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VGcmFtZVJhdGUoZnBzKSB7CiAgICAgICAgICBpZiAoZnBzIDwgMCB8fCBmcHMgPiAxMjUpIHsKICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXSgiZm9yY2VGcmFtZVJhdGUgdGFrZXMgYSBwb3NpdGl2ZSBpbnQgYmV0d2VlbiAwIGFuZCAxMjUsIGZvcmNpbmcgZnJhbWUgcmF0ZXMgaGlnaGVyIHRoYW4gMTI1IGZwcyBpcyBub3Qgc3VwcG9ydGVkIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcHMgPiAwKSB7CiAgICAgICAgICAgIGZyYW1lSW50ZXJ2YWwgPSBNYXRoLmZsb29yKDFlMyAvIGZwcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc2NoZWR1bGVkSG9zdENhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgIHN0YXJ0VGltZSA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICB2YXIgaGFzVGltZVJlbWFpbmluZyA9IHRydWU7CiAgICAgICAgICAgIHZhciBoYXNNb3JlV29yayA9IHRydWU7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaGFzTW9yZVdvcmsgPSBzY2hlZHVsZWRIb3N0Q2FsbGJhY2soaGFzVGltZVJlbWFpbmluZywgY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmIChoYXNNb3JlV29yaykgewogICAgICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgIGlmICh0eXBlb2YgbG9jYWxTZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0SW1tZWRpYXRlKHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgIHZhciBwb3J0ID0gY2hhbm5lbC5wb3J0MjsKICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9ydC5wb3N0TWVzc2FnZShudWxsKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0VGltZW91dChwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUsIDApOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICBpZiAoIWlzTWVzc2FnZUxvb3BSdW5uaW5nKSB7CiAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RUaW1lb3V0KGNhbGxiYWNrLCBtcykgewogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IGxvY2FsU2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2soZXhwb3J0cy51bnN0YWJsZV9ub3coKSk7CiAgICAgICAgICB9LCBtcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbmNlbEhvc3RUaW1lb3V0KCkgewogICAgICAgICAgbG9jYWxDbGVhclRpbWVvdXQodGFza1RpbWVvdXRJRCk7CiAgICAgICAgICB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgfQogICAgICAgIHZhciB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSByZXF1ZXN0UGFpbnQ7CiAgICAgICAgdmFyIHVuc3RhYmxlX1Byb2ZpbGluZyA9IG51bGw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JZGxlUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JbW1lZGlhdGVQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfTG93UHJpb3JpdHkgPSBMb3dQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Qcm9maWxpbmcgPSB1bnN0YWJsZV9Qcm9maWxpbmc7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Vc2VyQmxvY2tpbmdQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sgPSB1bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uID0gdW5zdGFibGVfY29udGludWVFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9mb3JjZUZyYW1lUmF0ZSA9IGZvcmNlRnJhbWVSYXRlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwgPSB1bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlID0gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9uZXh0ID0gdW5zdGFibGVfbmV4dDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uID0gdW5zdGFibGVfcGF1c2VFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHkgPSB1bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrID0gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3Nob3VsZFlpZWxkID0gc2hvdWxkWWllbGRUb0hvc3Q7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV93cmFwQ2FsbGJhY2sgPSB1bnN0YWJsZV93cmFwQ2FsbGJhY2s7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdDQ0ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0NDQuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgdmFyIHN1cHByZXNzV2FybmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNldFN1cHByZXNzV2FybmluZyhuZXdTdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3VwcHJlc3NXYXJuaW5nID0gbmV3U3VwcHJlc3NXYXJuaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghc3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJlcnJvciIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0MiwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQyICs9ICIlcyI7CiAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzV2l0aEZvcm1hdCA9IGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXJnc1dpdGhGb3JtYXQudW5zaGlmdCgiV2FybmluZzogIiArIGZvcm1hdDIpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRnVuY3Rpb25Db21wb25lbnQgPSAwOwogICAgICAgIHZhciBDbGFzc0NvbXBvbmVudCA9IDE7CiAgICAgICAgdmFyIEluZGV0ZXJtaW5hdGVDb21wb25lbnQgPSAyOwogICAgICAgIHZhciBIb3N0Um9vdCA9IDM7CiAgICAgICAgdmFyIEhvc3RQb3J0YWwgPSA0OwogICAgICAgIHZhciBIb3N0Q29tcG9uZW50ID0gNTsKICAgICAgICB2YXIgSG9zdFRleHQgPSA2OwogICAgICAgIHZhciBGcmFnbWVudDEwID0gNzsKICAgICAgICB2YXIgTW9kZSA9IDg7CiAgICAgICAgdmFyIENvbnRleHRDb25zdW1lciA9IDk7CiAgICAgICAgdmFyIENvbnRleHRQcm92aWRlciA9IDEwOwogICAgICAgIHZhciBGb3J3YXJkUmVmMiA9IDExOwogICAgICAgIHZhciBQcm9maWxlciA9IDEyOwogICAgICAgIHZhciBTdXNwZW5zZUNvbXBvbmVudCA9IDEzOwogICAgICAgIHZhciBNZW1vQ29tcG9uZW50ID0gMTQ7CiAgICAgICAgdmFyIFNpbXBsZU1lbW9Db21wb25lbnQgPSAxNTsKICAgICAgICB2YXIgTGF6eUNvbXBvbmVudCA9IDE2OwogICAgICAgIHZhciBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQgPSAxNzsKICAgICAgICB2YXIgRGVoeWRyYXRlZEZyYWdtZW50ID0gMTg7CiAgICAgICAgdmFyIFN1c3BlbnNlTGlzdENvbXBvbmVudCA9IDE5OwogICAgICAgIHZhciBTY29wZUNvbXBvbmVudCA9IDIxOwogICAgICAgIHZhciBPZmZzY3JlZW5Db21wb25lbnQgPSAyMjsKICAgICAgICB2YXIgTGVnYWN5SGlkZGVuQ29tcG9uZW50ID0gMjM7CiAgICAgICAgdmFyIENhY2hlQ29tcG9uZW50ID0gMjQ7CiAgICAgICAgdmFyIFRyYWNpbmdNYXJrZXJDb21wb25lbnQgPSAyNTsKICAgICAgICB2YXIgZW5hYmxlQ2xpZW50UmVuZGVyRmFsbGJhY2tPblRleHRNaXNtYXRjaCA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZU5ld1JlY29uY2lsZXIgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayA9IGZhbHNlOwogICAgICAgIHZhciBkaXNhYmxlQ29tbWVudHNBc0RPTUNvbnRhaW5lcnMgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0ID0gZmFsc2U7CiAgICAgICAgdmFyIHdhcm5BYm91dFN0cmluZ1JlZnMgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVTY2hlZHVsaW5nUHJvZmlsZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlclRpbWVyID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlUHJvZmlsZXJDb21taXRIb29rcyA9IHRydWU7CiAgICAgICAgdmFyIGFsbE5hdGl2ZUV2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMgPSB7fTsKICAgICAgICB2YXIgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lcyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpIHsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgZGVwZW5kZW5jaWVzKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQocmVnaXN0cmF0aW9uTmFtZSArICJDYXB0dXJlIiwgZGVwZW5kZW5jaWVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXNbcmVnaXN0cmF0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICBlcnJvcigiRXZlbnRSZWdpc3RyeTogTW9yZSB0aGFuIG9uZSBwbHVnaW4gYXR0ZW1wdGVkIHRvIHB1Ymxpc2ggdGhlIHNhbWUgcmVnaXN0cmF0aW9uIG5hbWUsIGAlc2AuIiwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXNbcmVnaXN0cmF0aW9uTmFtZV0gPSBkZXBlbmRlbmNpZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IHJlZ2lzdHJhdGlvbk5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lc1tsb3dlckNhc2VkTmFtZV0gPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZSA9PT0gIm9uRG91YmxlQ2xpY2siKSB7CiAgICAgICAgICAgICAgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lcy5vbmRibGNsaWNrID0gcmVnaXN0cmF0aW9uTmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYWxsTmF0aXZlRXZlbnRzLmFkZChkZXBlbmRlbmNpZXNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY2FuVXNlRE9NMiA9ICEhKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCAhPT0gInVuZGVmaW5lZCIpOwogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBhdHRyaWJ1dGUgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIGF0dHJpYnV0ZU5hbWUsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wU3RyaW5nQ29lcmNpb24odmFsdWUsIHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgcHJvcCBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgcHJvcE5hbWUsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDU1NQcm9wZXJ0eVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIENTUyBwcm9wZXJ0eSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgcHJvcE5hbWUsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tIdG1sU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgSFRNTCBtYXJrdXAgdXNlcyBhIHZhbHVlIG9mIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkZvcm0gZmllbGQgdmFsdWVzICh2YWx1ZSwgY2hlY2tlZCwgZGVmYXVsdFZhbHVlLCBvciBkZWZhdWx0Q2hlY2tlZCBwcm9wcykgbXVzdCBiZSBzdHJpbmdzLCBub3QgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSRVNFUlZFRCA9IDA7CiAgICAgICAgdmFyIFNUUklORyA9IDE7CiAgICAgICAgdmFyIEJPT0xFQU5JU0hfU1RSSU5HID0gMjsKICAgICAgICB2YXIgQk9PTEVBTiA9IDM7CiAgICAgICAgdmFyIE9WRVJMT0FERURfQk9PTEVBTiA9IDQ7CiAgICAgICAgdmFyIE5VTUVSSUMgPSA1OwogICAgICAgIHZhciBQT1NJVElWRV9OVU1FUklDID0gNjsKICAgICAgICB2YXIgQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiA9ICI6QS1aX2EtelxcdTAwQzAtXFx1MDBENlxcdTAwRDgtXFx1MDBGNlxcdTAwRjgtXFx1MDJGRlxcdTAzNzAtXFx1MDM3RFxcdTAzN0YtXFx1MUZGRlxcdTIwMEMtXFx1MjAwRFxcdTIwNzAtXFx1MjE4RlxcdTJDMDAtXFx1MkZFRlxcdTMwMDEtXFx1RDdGRlxcdUY5MDAtXFx1RkRDRlxcdUZERjAtXFx1RkZGRCI7CiAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX0NIQVIgPSBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSICsgIlxcLS4wLTlcXHUwMEI3XFx1MDMwMC1cXHUwMzZGXFx1MjAzRi1cXHUyMDQwIjsKICAgICAgICB2YXIgVkFMSURfQVRUUklCVVRFX05BTUVfUkVHRVggPSBuZXcgUmVnRXhwKCJeWyIgKyBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSICsgIl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgdmFyIGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGUgPSB7fTsKICAgICAgICB2YXIgdmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgZnVuY3Rpb24gaXNBdHRyaWJ1dGVOYW1lU2FmZShhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGUsIGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZSwgYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKFZBTElEX0FUVFJJQlVURV9OQU1FX1JFR0VYLnRlc3QoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgdmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlW2F0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlW2F0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXR0cmlidXRlIG5hbWU6IGAlc2AiLCBhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkSWdub3JlQXR0cmlidXRlKG5hbWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHByb3BlcnR5SW5mby50eXBlID09PSBSRVNFUlZFRDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmFtZS5sZW5ndGggPiAyICYmIChuYW1lWzBdID09PSAibyIgfHwgbmFtZVswXSA9PT0gIk8iKSAmJiAobmFtZVsxXSA9PT0gIm4iIHx8IG5hbWVbMV0gPT09ICJOIikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsICYmIHByb3BlcnR5SW5mby50eXBlID09PSBSRVNFUlZFRCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOiB7CiAgICAgICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhcHJvcGVydHlJbmZvLmFjY2VwdHNCb29sZWFuczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHByZWZpeDIgPSBuYW1lLnRvTG93ZXJDYXNlKCkuc2xpY2UoMCwgNSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJlZml4MiAhPT0gImRhdGEtIiAmJiBwcmVmaXgyICE9PSAiYXJpYS0iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICBzd2l0Y2ggKHByb3BlcnR5SW5mby50eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSBCT09MRUFOOgogICAgICAgICAgICAgICAgcmV0dXJuICF2YWx1ZTsKICAgICAgICAgICAgICBjYXNlIE9WRVJMT0FERURfQk9PTEVBTjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gZmFsc2U7CiAgICAgICAgICAgICAgY2FzZSBOVU1FUklDOgogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKTsKICAgICAgICAgICAgICBjYXNlIFBPU0lUSVZFX05VTUVSSUM6CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4odmFsdWUpIHx8IHZhbHVlIDwgMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQcm9wZXJ0eUluZm8obmFtZSkgewogICAgICAgICAgcmV0dXJuIHByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkobmFtZSkgPyBwcm9wZXJ0aWVzW25hbWVdIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gUHJvcGVydHlJbmZvUmVjb3JkKG5hbWUsIHR5cGUsIG11c3RVc2VQcm9wZXJ0eSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlTmFtZXNwYWNlLCBzYW5pdGl6ZVVSTDIsIHJlbW92ZUVtcHR5U3RyaW5nKSB7CiAgICAgICAgICB0aGlzLmFjY2VwdHNCb29sZWFucyA9IHR5cGUgPT09IEJPT0xFQU5JU0hfU1RSSU5HIHx8IHR5cGUgPT09IEJPT0xFQU4gfHwgdHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOOwogICAgICAgICAgdGhpcy5hdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZTsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlTmFtZXNwYWNlID0gYXR0cmlidXRlTmFtZXNwYWNlOwogICAgICAgICAgdGhpcy5tdXN0VXNlUHJvcGVydHkgPSBtdXN0VXNlUHJvcGVydHk7CiAgICAgICAgICB0aGlzLnByb3BlcnR5TmFtZSA9IG5hbWU7CiAgICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgICAgdGhpcy5zYW5pdGl6ZVVSTCA9IHNhbml0aXplVVJMMjsKICAgICAgICAgIHRoaXMucmVtb3ZlRW1wdHlTdHJpbmcgPSByZW1vdmVFbXB0eVN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB7fTsKICAgICAgICB2YXIgcmVzZXJ2ZWRQcm9wcyA9IFsKICAgICAgICAgICJjaGlsZHJlbiIsCiAgICAgICAgICAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLAogICAgICAgICAgLy8gVE9ETzogVGhpcyBwcmV2ZW50cyB0aGUgYXNzaWdubWVudCBvZiBkZWZhdWx0VmFsdWUgdG8gcmVndWxhcgogICAgICAgICAgLy8gZWxlbWVudHMgKG5vdCBqdXN0IGlucHV0cykuIE5vdyB0aGF0IFJlYWN0RE9NSW5wdXQgYXNzaWducyB0byB0aGUKICAgICAgICAgIC8vIGRlZmF1bHRWYWx1ZSBwcm9wZXJ0eSAtLSBkbyB3ZSBuZWVkIHRoaXM/CiAgICAgICAgICAiZGVmYXVsdFZhbHVlIiwKICAgICAgICAgICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICAiaW5uZXJIVE1MIiwKICAgICAgICAgICJzdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmciLAogICAgICAgICAgInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICAic3R5bGUiCiAgICAgICAgXTsKICAgICAgICByZXNlcnZlZFByb3BzLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFJFU0VSVkVELAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbWyJhY2NlcHRDaGFyc2V0IiwgImFjY2VwdC1jaGFyc2V0Il0sIFsiY2xhc3NOYW1lIiwgImNsYXNzIl0sIFsiaHRtbEZvciIsICJmb3IiXSwgWyJodHRwRXF1aXYiLCAiaHR0cC1lcXVpdiJdXS5mb3JFYWNoKGZ1bmN0aW9uKF9yZWYyKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IF9yZWYyWzBdLCBhdHRyaWJ1dGVOYW1lID0gX3JlZjJbMV07CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbImNvbnRlbnRFZGl0YWJsZSIsICJkcmFnZ2FibGUiLCAic3BlbGxDaGVjayIsICJ2YWx1ZSJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU5JU0hfU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsiYXV0b1JldmVyc2UiLCAiZXh0ZXJuYWxSZXNvdXJjZXNSZXF1aXJlZCIsICJmb2N1c2FibGUiLCAicHJlc2VydmVBbHBoYSJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU5JU0hfU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiYWxsb3dGdWxsU2NyZWVuIiwKICAgICAgICAgICJhc3luYyIsCiAgICAgICAgICAvLyBOb3RlOiB0aGVyZSBpcyBhIHNwZWNpYWwgY2FzZSB0aGF0IHByZXZlbnRzIGl0IGZyb20gYmVpbmcgd3JpdHRlbiB0byB0aGUgRE9NCiAgICAgICAgICAvLyBvbiB0aGUgY2xpZW50IHNpZGUgYmVjYXVzZSB0aGUgYnJvd3NlcnMgYXJlIGluY29uc2lzdGVudC4gSW5zdGVhZCB3ZSBjYWxsIGZvY3VzKCkuCiAgICAgICAgICAiYXV0b0ZvY3VzIiwKICAgICAgICAgICJhdXRvUGxheSIsCiAgICAgICAgICAiY29udHJvbHMiLAogICAgICAgICAgImRlZmF1bHQiLAogICAgICAgICAgImRlZmVyIiwKICAgICAgICAgICJkaXNhYmxlZCIsCiAgICAgICAgICAiZGlzYWJsZVBpY3R1cmVJblBpY3R1cmUiLAogICAgICAgICAgImRpc2FibGVSZW1vdGVQbGF5YmFjayIsCiAgICAgICAgICAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgImhpZGRlbiIsCiAgICAgICAgICAibG9vcCIsCiAgICAgICAgICAibm9Nb2R1bGUiLAogICAgICAgICAgIm5vVmFsaWRhdGUiLAogICAgICAgICAgIm9wZW4iLAogICAgICAgICAgInBsYXlzSW5saW5lIiwKICAgICAgICAgICJyZWFkT25seSIsCiAgICAgICAgICAicmVxdWlyZWQiLAogICAgICAgICAgInJldmVyc2VkIiwKICAgICAgICAgICJzY29wZWQiLAogICAgICAgICAgInNlYW1sZXNzIiwKICAgICAgICAgIC8vIE1pY3JvZGF0YQogICAgICAgICAgIml0ZW1TY29wZSIKICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU4sCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNoZWNrZWQiLAogICAgICAgICAgLy8gTm90ZTogYG9wdGlvbi5zZWxlY3RlZGAgaXMgbm90IHVwZGF0ZWQgaWYgYHNlbGVjdC5tdWx0aXBsZWAgaXMKICAgICAgICAgIC8vIGRpc2FibGVkIHdpdGggYHJlbW92ZUF0dHJpYnV0ZWAuIFdlIGhhdmUgc3BlY2lhbCBsb2dpYyBmb3IgaGFuZGxpbmcgdGhpcy4KICAgICAgICAgICJtdWx0aXBsZSIsCiAgICAgICAgICAibXV0ZWQiLAogICAgICAgICAgInNlbGVjdGVkIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOLAogICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjYXB0dXJlIiwKICAgICAgICAgICJkb3dubG9hZCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgT1ZFUkxPQURFRF9CT09MRUFOLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY29scyIsCiAgICAgICAgICAicm93cyIsCiAgICAgICAgICAic2l6ZSIsCiAgICAgICAgICAic3BhbiIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgUE9TSVRJVkVfTlVNRVJJQywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJyb3dTcGFuIiwgInN0YXJ0Il0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgTlVNRVJJQywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgQ0FNRUxJWkUgPSAvW1wtXDpdKFthLXpdKS9nOwogICAgICAgIHZhciBjYXBpdGFsaXplID0gZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgIHJldHVybiB0b2tlblsxXS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH07CiAgICAgICAgWwogICAgICAgICAgImFjY2VudC1oZWlnaHQiLAogICAgICAgICAgImFsaWdubWVudC1iYXNlbGluZSIsCiAgICAgICAgICAiYXJhYmljLWZvcm0iLAogICAgICAgICAgImJhc2VsaW5lLXNoaWZ0IiwKICAgICAgICAgICJjYXAtaGVpZ2h0IiwKICAgICAgICAgICJjbGlwLXBhdGgiLAogICAgICAgICAgImNsaXAtcnVsZSIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIiwKICAgICAgICAgICJjb2xvci1wcm9maWxlIiwKICAgICAgICAgICJjb2xvci1yZW5kZXJpbmciLAogICAgICAgICAgImRvbWluYW50LWJhc2VsaW5lIiwKICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCIsCiAgICAgICAgICAiZmlsbC1vcGFjaXR5IiwKICAgICAgICAgICJmaWxsLXJ1bGUiLAogICAgICAgICAgImZsb29kLWNvbG9yIiwKICAgICAgICAgICJmbG9vZC1vcGFjaXR5IiwKICAgICAgICAgICJmb250LWZhbWlseSIsCiAgICAgICAgICAiZm9udC1zaXplIiwKICAgICAgICAgICJmb250LXNpemUtYWRqdXN0IiwKICAgICAgICAgICJmb250LXN0cmV0Y2giLAogICAgICAgICAgImZvbnQtc3R5bGUiLAogICAgICAgICAgImZvbnQtdmFyaWFudCIsCiAgICAgICAgICAiZm9udC13ZWlnaHQiLAogICAgICAgICAgImdseXBoLW5hbWUiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLWhvcml6b250YWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLXZlcnRpY2FsIiwKICAgICAgICAgICJob3Jpei1hZHYteCIsCiAgICAgICAgICAiaG9yaXotb3JpZ2luLXgiLAogICAgICAgICAgImltYWdlLXJlbmRlcmluZyIsCiAgICAgICAgICAibGV0dGVyLXNwYWNpbmciLAogICAgICAgICAgImxpZ2h0aW5nLWNvbG9yIiwKICAgICAgICAgICJtYXJrZXItZW5kIiwKICAgICAgICAgICJtYXJrZXItbWlkIiwKICAgICAgICAgICJtYXJrZXItc3RhcnQiLAogICAgICAgICAgIm92ZXJsaW5lLXBvc2l0aW9uIiwKICAgICAgICAgICJvdmVybGluZS10aGlja25lc3MiLAogICAgICAgICAgInBhaW50LW9yZGVyIiwKICAgICAgICAgICJwYW5vc2UtMSIsCiAgICAgICAgICAicG9pbnRlci1ldmVudHMiLAogICAgICAgICAgInJlbmRlcmluZy1pbnRlbnQiLAogICAgICAgICAgInNoYXBlLXJlbmRlcmluZyIsCiAgICAgICAgICAic3RvcC1jb2xvciIsCiAgICAgICAgICAic3RvcC1vcGFjaXR5IiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXBvc2l0aW9uIiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXRoaWNrbmVzcyIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hhcnJheSIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hvZmZzZXQiLAogICAgICAgICAgInN0cm9rZS1saW5lY2FwIiwKICAgICAgICAgICJzdHJva2UtbGluZWpvaW4iLAogICAgICAgICAgInN0cm9rZS1taXRlcmxpbWl0IiwKICAgICAgICAgICJzdHJva2Utb3BhY2l0eSIsCiAgICAgICAgICAic3Ryb2tlLXdpZHRoIiwKICAgICAgICAgICJ0ZXh0LWFuY2hvciIsCiAgICAgICAgICAidGV4dC1kZWNvcmF0aW9uIiwKICAgICAgICAgICJ0ZXh0LXJlbmRlcmluZyIsCiAgICAgICAgICAidW5kZXJsaW5lLXBvc2l0aW9uIiwKICAgICAgICAgICJ1bmRlcmxpbmUtdGhpY2tuZXNzIiwKICAgICAgICAgICJ1bmljb2RlLWJpZGkiLAogICAgICAgICAgInVuaWNvZGUtcmFuZ2UiLAogICAgICAgICAgInVuaXRzLXBlci1lbSIsCiAgICAgICAgICAidi1hbHBoYWJldGljIiwKICAgICAgICAgICJ2LWhhbmdpbmciLAogICAgICAgICAgInYtaWRlb2dyYXBoaWMiLAogICAgICAgICAgInYtbWF0aGVtYXRpY2FsIiwKICAgICAgICAgICJ2ZWN0b3ItZWZmZWN0IiwKICAgICAgICAgICJ2ZXJ0LWFkdi15IiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi14IiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi15IiwKICAgICAgICAgICJ3b3JkLXNwYWNpbmciLAogICAgICAgICAgIndyaXRpbmctbW9kZSIsCiAgICAgICAgICAieG1sbnM6eGxpbmsiLAogICAgICAgICAgIngtaGVpZ2h0IgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAieGxpbms6YWN0dWF0ZSIsCiAgICAgICAgICAieGxpbms6YXJjcm9sZSIsCiAgICAgICAgICAieGxpbms6cm9sZSIsCiAgICAgICAgICAieGxpbms6c2hvdyIsCiAgICAgICAgICAieGxpbms6dGl0bGUiLAogICAgICAgICAgInhsaW5rOnR5cGUiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAiaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAieG1sOmJhc2UiLAogICAgICAgICAgInhtbDpsYW5nIiwKICAgICAgICAgICJ4bWw6c3BhY2UiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAiaHR0cDovL3d3dy53My5vcmcvWE1MLzE5OTgvbmFtZXNwYWNlIiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsidGFiSW5kZXgiLCAiY3Jvc3NPcmlnaW4iXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbYXR0cmlidXRlTmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHhsaW5rSHJlZiA9ICJ4bGlua0hyZWYiOwogICAgICAgIHByb3BlcnRpZXNbeGxpbmtIcmVmXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAieGxpbmtIcmVmIiwKICAgICAgICAgIFNUUklORywKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAieGxpbms6aHJlZiIsCiAgICAgICAgICAiaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIsCiAgICAgICAgICB0cnVlLAogICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBbInNyYyIsICJocmVmIiwgImFjdGlvbiIsICJmb3JtQWN0aW9uIl0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW2F0dHJpYnV0ZU5hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgaXNKYXZhU2NyaXB0UHJvdG9jb2wgPSAvXltcdTAwMDAtXHUwMDFGIF0qaltcclxuXHRdKmFbXHJcblx0XSp2W1xyXG5cdF0qYVtcclxuXHRdKnNbXHJcblx0XSpjW1xyXG5cdF0qcltcclxuXHRdKmlbXHJcblx0XSpwW1xyXG5cdF0qdFtcclxuXHRdKlw6L2k7CiAgICAgICAgdmFyIGRpZFdhcm4gPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBzYW5pdGl6ZVVSTCh1cmwpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuICYmIGlzSmF2YVNjcmlwdFByb3RvY29sLnRlc3QodXJsKSkgewogICAgICAgICAgICAgIGRpZFdhcm4gPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJBIGZ1dHVyZSB2ZXJzaW9uIG9mIFJlYWN0IHdpbGwgYmxvY2sgamF2YXNjcmlwdDogVVJMcyBhcyBhIHNlY3VyaXR5IHByZWNhdXRpb24uIFVzZSBldmVudCBoYW5kbGVycyBpbnN0ZWFkIGlmIHlvdSBjYW4uIElmIHlvdSBuZWVkIHRvIGdlbmVyYXRlIHVuc2FmZSBIVE1MIHRyeSB1c2luZyBkYW5nZXJvdXNseVNldElubmVySFRNTCBpbnN0ZWFkLiBSZWFjdCB3YXMgcGFzc2VkICVzLiIsIEpTT04uc3RyaW5naWZ5KHVybCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgbmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLm11c3RVc2VQcm9wZXJ0eSkgewogICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eUluZm8ucHJvcGVydHlOYW1lOwogICAgICAgICAgICAgIHJldHVybiBub2RlW3Byb3BlcnR5TmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8uc2FuaXRpemVVUkwpIHsKICAgICAgICAgICAgICAgIHNhbml0aXplVVJMKCIiICsgZXhwZWN0ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlTmFtZSA9IHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lOwogICAgICAgICAgICAgIHZhciBzdHJpbmdWYWx1ZSA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby50eXBlID09PSBPVkVSTE9BREVEX0JPT0xFQU4pIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby50eXBlID09PSBCT09MRUFOKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cmluZ1ZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nVmFsdWUgPT09IG51bGwgPyBleHBlY3RlZCA6IHN0cmluZ1ZhbHVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyaW5nVmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1ZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZvckF0dHJpYnV0ZShub2RlLCBuYW1lLCBleHBlY3RlZCwgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc0F0dHJpYnV0ZU5hbWVTYWZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbm9kZS5oYXNBdHRyaWJ1dGUobmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKGV4cGVjdGVkLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsIG5hbWUsIHZhbHVlLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGdldFByb3BlcnR5SW5mbyhuYW1lKTsKICAgICAgICAgIGlmIChzaG91bGRJZ25vcmVBdHRyaWJ1dGUobmFtZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgdmFsdWUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnIHx8IHByb3BlcnR5SW5mbyA9PT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaXNBdHRyaWJ1dGVOYW1lU2FmZShuYW1lKSkgewogICAgICAgICAgICAgIHZhciBfYXR0cmlidXRlTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShfYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShfYXR0cmlidXRlTmFtZSwgIiIgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtdXN0VXNlUHJvcGVydHkgPSBwcm9wZXJ0eUluZm8ubXVzdFVzZVByb3BlcnR5OwogICAgICAgICAgaWYgKG11c3RVc2VQcm9wZXJ0eSkgewogICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gcHJvcGVydHlJbmZvLnByb3BlcnR5TmFtZTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wZXJ0eUluZm8udHlwZTsKICAgICAgICAgICAgICBub2RlW3Byb3BlcnR5TmFtZV0gPSB0eXBlID09PSBCT09MRUFOID8gZmFsc2UgOiAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBub2RlW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYXR0cmlidXRlTmFtZSA9IHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lc3BhY2UgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZXNwYWNlOwogICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF90eXBlID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVWYWx1ZTsKICAgICAgICAgICAgaWYgKF90eXBlID09PSBCT09MRUFOIHx8IF90eXBlID09PSBPVkVSTE9BREVEX0JPT0xFQU4gJiYgdmFsdWUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBhdHRyaWJ1dGVWYWx1ZSA9ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8uc2FuaXRpemVVUkwpIHsKICAgICAgICAgICAgICAgIHNhbml0aXplVVJMKGF0dHJpYnV0ZVZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXR0cmlidXRlTmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGVOUyhhdHRyaWJ1dGVOYW1lc3BhY2UsIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmVsZW1lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfUE9SVEFMX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wb3J0YWwiKTsKICAgICAgICB2YXIgUkVBQ1RfRlJBR01FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmZyYWdtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdHJpY3RfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9QUk9GSUxFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvZmlsZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPVklERVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb3ZpZGVyIik7CiAgICAgICAgdmFyIFJFQUNUX0NPTlRFWFRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmNvbnRleHQiKTsKICAgICAgICB2YXIgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX1NDT1BFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zY29wZSIpOwogICAgICAgIHZhciBSRUFDVF9ERUJVR19UUkFDSU5HX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmRlYnVnX3RyYWNlX21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5vZmZzY3JlZW4iKTsKICAgICAgICB2YXIgUkVBQ1RfTEVHQUNZX0hJRERFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGVnYWN5X2hpZGRlbiIpOwogICAgICAgIHZhciBSRUFDVF9DQUNIRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY2FjaGUiKTsKICAgICAgICB2YXIgUkVBQ1RfVFJBQ0lOR19NQVJLRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnRyYWNpbmdfbWFya2VyIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGFzc2lnbjIgPSBPYmplY3QuYXNzaWduOwogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2SW5mbwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB3YXJuOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXAKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgdmFyIHByZWZpeDsKICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHgyLnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoZm4sIFtdLCBGYWtlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgRmFrZS5jYWxsKCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgczIgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjMiA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzMiA+PSAxICYmIGMyID49IDAgJiYgc2FtcGxlTGluZXNbczJdICE9PSBjb250cm9sTGluZXNbYzJdKSB7CiAgICAgICAgICAgICAgICBjMi0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgczIgPj0gMSAmJiBjMiA+PSAwOyBzMi0tLCBjMi0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbczJdICE9PSBjb250cm9sTGluZXNbYzJdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzMiAhPT0gMSB8fCBjMiAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMyLS07CiAgICAgICAgICAgICAgICAgICAgICBjMi0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMyIDwgMCB8fCBzYW1wbGVMaW5lc1tzMl0gIT09IGNvbnRyb2xMaW5lc1tjMl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzMl0ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzMiA+PSAxICYmIGMyID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGN0b3IsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShjdG9yLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIG93bmVyID0gZmliZXIuX2RlYnVnT3duZXIgPyBmaWJlci5fZGVidWdPd25lci50eXBlIDogbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBmaWJlci5fZGVidWdTb3VyY2U7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJMYXp5Iik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZS5yZW5kZXIpOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2Qod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGluZm8gKz0gZGVzY3JpYmVGaWJlcihub2RlKTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUpOwogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeDIubWVzc2FnZSArICJcbiIgKyB4Mi5zdGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZSQxKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBvdXRlclR5cGUuZGlzcGxheU5hbWUgfHwgKGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUkMSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWcsIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIkNhY2hlIjsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lJDEocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OgogICAgICAgICAgICAgIHJldHVybiAiRGVoeWRyYXRlZEZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDEwOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcmV0dXJuICJSb290IjsKICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICByZXR1cm4gIlRleHQiOwogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gIk1vZGUiOwogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIk9mZnNjcmVlbiI7CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTY29wZSI7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgICAgY2FzZSBUcmFjaW5nTWFya2VyQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiVHJhY2luZ01hcmtlciI7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgdmFyIGN1cnJlbnQzID0gbnVsbDsKICAgICAgICB2YXIgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG93bmVyID0gY3VycmVudDMuX2RlYnVnT3duZXI7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiB0eXBlb2Ygb3duZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2QoY3VycmVudDMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEN1cnJlbnRGaWJlcigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50MyA9IG51bGw7CiAgICAgICAgICAgIGlzUmVuZGVyaW5nID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRGaWJlcihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IGZpYmVyID09PSBudWxsID8gbnVsbCA6IGdldEN1cnJlbnRGaWJlclN0YWNrSW5EZXY7CiAgICAgICAgICAgIGN1cnJlbnQzID0gZmliZXI7CiAgICAgICAgICAgIGlzUmVuZGVyaW5nID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlcigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1JlbmRlcmluZyhyZW5kZXJpbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSByZW5kZXJpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VG9TdHJpbmdWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgIGNhc2UgInVuZGVmaW5lZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBoYXNSZWFkT25seVZhbHVlID0gewogICAgICAgICAgYnV0dG9uOiB0cnVlLAogICAgICAgICAgY2hlY2tib3g6IHRydWUsCiAgICAgICAgICBpbWFnZTogdHJ1ZSwKICAgICAgICAgIGhpZGRlbjogdHJ1ZSwKICAgICAgICAgIHJhZGlvOiB0cnVlLAogICAgICAgICAgcmVzZXQ6IHRydWUsCiAgICAgICAgICBzdWJtaXQ6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHModGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoaGFzUmVhZE9ubHlWYWx1ZVtwcm9wcy50eXBlXSB8fCBwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5vbklucHV0IHx8IHByb3BzLnJlYWRPbmx5IHx8IHByb3BzLmRpc2FibGVkIHx8IHByb3BzLnZhbHVlID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGB2YWx1ZWAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRWYWx1ZWAuIE90aGVyd2lzZSwgc2V0IGVpdGhlciBgb25DaGFuZ2VgIG9yIGByZWFkT25seWAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEocHJvcHMub25DaGFuZ2UgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMuY2hlY2tlZCA9PSBudWxsKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcHJvdmlkZWQgYSBgY2hlY2tlZGAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRDaGVja2VkYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NoZWNrYWJsZShlbGVtKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW0udHlwZTsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAodHlwZSA9PT0gImNoZWNrYm94IiB8fCB0eXBlID09PSAicmFkaW8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJhY2tlcihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5fdmFsdWVUcmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIG5vZGUuX3ZhbHVlVHJhY2tlciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgdmFyIHZhbHVlID0gIiI7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ2hlY2thYmxlKG5vZGUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbm9kZS5jaGVja2VkID8gInRydWUiIDogImZhbHNlIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhY2tWYWx1ZU9uTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWVGaWVsZCA9IGlzQ2hlY2thYmxlKG5vZGUpID8gImNoZWNrZWQiIDogInZhbHVlIjsKICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihub2RlLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgdmFsdWVGaWVsZCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbihub2RlW3ZhbHVlRmllbGRdKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSAiIiArIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICBpZiAobm9kZS5oYXNPd25Qcm9wZXJ0eSh2YWx1ZUZpZWxkKSB8fCB0eXBlb2YgZGVzY3JpcHRvciA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0b3IuZ2V0ICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBkZXNjcmlwdG9yLnNldCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0OCA9IGRlc2NyaXB0b3IuZ2V0LCBzZXQ0ID0gZGVzY3JpcHRvci5zZXQ7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldDguY2FsbCh0aGlzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgICAgc2V0NC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjcmlwdG9yLmVudW1lcmFibGUKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIHRyYWNrZXIgPSB7CiAgICAgICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wVHJhY2tpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGRldGFjaFRyYWNrZXIobm9kZSk7CiAgICAgICAgICAgICAgZGVsZXRlIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdHJhY2tlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhY2sobm9kZSkgewogICAgICAgICAgaWYgKGdldFRyYWNrZXIobm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gdHJhY2tWYWx1ZU9uTm9kZShub2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVmFsdWVJZkNoYW5nZWQobm9kZSkgewogICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFja2VyID0gZ2V0VHJhY2tlcihub2RlKTsKICAgICAgICAgIGlmICghdHJhY2tlcikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0VmFsdWUgPSB0cmFja2VyLmdldFZhbHVlKCk7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gZ2V0VmFsdWVGcm9tTm9kZShub2RlKTsKICAgICAgICAgIGlmIChuZXh0VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICB0cmFja2VyLnNldFZhbHVlKG5leHRWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50KGRvYykgewogICAgICAgICAgZG9jID0gZG9jIHx8ICh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiID8gZG9jdW1lbnQgOiB2b2lkIDApOwogICAgICAgICAgaWYgKHR5cGVvZiBkb2MgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGRvYy5hY3RpdmVFbGVtZW50IHx8IGRvYy5ib2R5OwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZG9jLmJvZHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkNoZWNrZWREZWZhdWx0Q2hlY2tlZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0NvbnRyb2xsZWQocHJvcHMpIHsKICAgICAgICAgIHZhciB1c2VzQ2hlY2tlZCA9IHByb3BzLnR5cGUgPT09ICJjaGVja2JveCIgfHwgcHJvcHMudHlwZSA9PT0gInJhZGlvIjsKICAgICAgICAgIHJldHVybiB1c2VzQ2hlY2tlZCA/IHByb3BzLmNoZWNrZWQgIT0gbnVsbCA6IHByb3BzLnZhbHVlICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGNoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgIGRlZmF1bHRDaGVja2VkOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGVja2VkOiBjaGVja2VkICE9IG51bGwgPyBjaGVja2VkIDogbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBob3N0UHJvcHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcygiaW5wdXQiLCBwcm9wcyk7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGVja2VkICE9PSB2b2lkIDAgJiYgcHJvcHMuZGVmYXVsdENoZWNrZWQgIT09IHZvaWQgMCAmJiAhZGlkV2FybkNoZWNrZWREZWZhdWx0Q2hlY2tlZCkgewogICAgICAgICAgICAgIGVycm9yKCIlcyBjb250YWlucyBhbiBpbnB1dCBvZiB0eXBlICVzIHdpdGggYm90aCBjaGVja2VkIGFuZCBkZWZhdWx0Q2hlY2tlZCBwcm9wcy4gSW5wdXQgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSBjaGVja2VkIHByb3AsIG9yIHRoZSBkZWZhdWx0Q2hlY2tlZCBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FybkNoZWNrZWREZWZhdWx0Q2hlY2tlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9PSB2b2lkIDAgJiYgcHJvcHMuZGVmYXVsdFZhbHVlICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSkgewogICAgICAgICAgICAgIGVycm9yKCIlcyBjb250YWlucyBhbiBpbnB1dCBvZiB0eXBlICVzIHdpdGggYm90aCB2YWx1ZSBhbmQgZGVmYXVsdFZhbHVlIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiLCBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpIHx8ICJBIGNvbXBvbmVudCIsIHByb3BzLnR5cGUpOwogICAgICAgICAgICAgIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciBkZWZhdWx0VmFsdWUgPSBwcm9wcy5kZWZhdWx0VmFsdWUgPT0gbnVsbCA/ICIiIDogcHJvcHMuZGVmYXVsdFZhbHVlOwogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlID0gewogICAgICAgICAgICBpbml0aWFsQ2hlY2tlZDogcHJvcHMuY2hlY2tlZCAhPSBudWxsID8gcHJvcHMuY2hlY2tlZCA6IHByb3BzLmRlZmF1bHRDaGVja2VkLAogICAgICAgICAgICBpbml0aWFsVmFsdWU6IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUgIT0gbnVsbCA/IHByb3BzLnZhbHVlIDogZGVmYXVsdFZhbHVlKSwKICAgICAgICAgICAgY29udHJvbGxlZDogaXNDb250cm9sbGVkKHByb3BzKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2hlY2tlZChlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGNoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwogICAgICAgICAgaWYgKGNoZWNrZWQgIT0gbnVsbCkgewogICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsICJjaGVja2VkIiwgY2hlY2tlZCwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXcmFwcGVyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb250cm9sbGVkID0gaXNDb250cm9sbGVkKHByb3BzKTsKICAgICAgICAgICAgaWYgKCFub2RlLl93cmFwcGVyU3RhdGUuY29udHJvbGxlZCAmJiBjb250cm9sbGVkICYmICFkaWRXYXJuVW5jb250cm9sbGVkVG9Db250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGFuIHVuY29udHJvbGxlZCBpbnB1dCB0byBiZSBjb250cm9sbGVkLiBUaGlzIGlzIGxpa2VseSBjYXVzZWQgYnkgdGhlIHZhbHVlIGNoYW5naW5nIGZyb20gdW5kZWZpbmVkIHRvIGEgZGVmaW5lZCB2YWx1ZSwgd2hpY2ggc2hvdWxkIG5vdCBoYXBwZW4uIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBjb21wb25lbnQuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIpOwogICAgICAgICAgICAgIGRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlLl93cmFwcGVyU3RhdGUuY29udHJvbGxlZCAmJiAhY29udHJvbGxlZCAmJiAhZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCkgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbXBvbmVudCBpcyBjaGFuZ2luZyBhIGNvbnRyb2xsZWQgaW5wdXQgdG8gYmUgdW5jb250cm9sbGVkLiBUaGlzIGlzIGxpa2VseSBjYXVzZWQgYnkgdGhlIHZhbHVlIGNoYW5naW5nIGZyb20gYSBkZWZpbmVkIHRvIHVuZGVmaW5lZCwgd2hpY2ggc2hvdWxkIG5vdCBoYXBwZW4uIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBjb21wb25lbnQuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIpOwogICAgICAgICAgICAgIGRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAwICYmIG5vZGUudmFsdWUgPT09ICIiIHx8IC8vIFdlIGV4cGxpY2l0bHkgd2FudCB0byBjb2VyY2UgdG8gbnVtYmVyIGhlcmUgaWYgcG9zc2libGUuCiAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lCiAgICAgICAgICAgICAgbm9kZS52YWx1ZSAhPSB2YWx1ZSkgewogICAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS52YWx1ZSAhPT0gdG9TdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiKSB7CiAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKCJ2YWx1ZSIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSkgewogICAgICAgICAgICAgIHNldERlZmF1bHRWYWx1ZShub2RlLCBwcm9wcy50eXBlLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuaGFzT3duUHJvcGVydHkoImRlZmF1bHRWYWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIGdldFRvU3RyaW5nVmFsdWUocHJvcHMuZGVmYXVsdFZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgPT0gbnVsbCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhcHJvcHMuZGVmYXVsdENoZWNrZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlcihlbGVtZW50LCBwcm9wcywgaXNIeWRyYXRpbmcyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJvcHMuaGFzT3duUHJvcGVydHkoInZhbHVlIikgfHwgcHJvcHMuaGFzT3duUHJvcGVydHkoImRlZmF1bHRWYWx1ZSIpKSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gcHJvcHMudHlwZTsKICAgICAgICAgICAgdmFyIGlzQnV0dG9uID0gdHlwZSA9PT0gInN1Ym1pdCIgfHwgdHlwZSA9PT0gInJlc2V0IjsKICAgICAgICAgICAgaWYgKGlzQnV0dG9uICYmIChwcm9wcy52YWx1ZSA9PT0gdm9pZCAwIHx8IHByb3BzLnZhbHVlID09PSBudWxsKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIGlmICghaXNIeWRyYXRpbmcyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGluaXRpYWxWYWx1ZSAhPT0gbm9kZS52YWx1ZSkgewogICAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gaW5pdGlhbFZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gbm9kZS5uYW1lOwogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9ICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gIW5vZGUuZGVmYXVsdENoZWNrZWQ7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhIW5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsQ2hlY2tlZDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lICE9PSAiIikgewogICAgICAgICAgICBub2RlLm5hbWUgPSBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB1cGRhdGVXcmFwcGVyKG5vZGUsIHByb3BzKTsKICAgICAgICAgIHVwZGF0ZU5hbWVkQ291c2lucyhub2RlLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU5hbWVkQ291c2lucyhyb290Tm9kZSwgcHJvcHMpIHsKICAgICAgICAgIHZhciBuYW1lID0gcHJvcHMubmFtZTsKICAgICAgICAgIGlmIChwcm9wcy50eXBlID09PSAicmFkaW8iICYmIG5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcXVlcnlSb290ID0gcm9vdE5vZGU7CiAgICAgICAgICAgIHdoaWxlIChxdWVyeVJvb3QucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIHF1ZXJ5Um9vdCA9IHF1ZXJ5Um9vdC5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKG5hbWUsICJuYW1lIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGdyb3VwID0gcXVlcnlSb290LnF1ZXJ5U2VsZWN0b3JBbGwoImlucHV0W25hbWU9IiArIEpTT04uc3RyaW5naWZ5KCIiICsgbmFtZSkgKyAnXVt0eXBlPSJyYWRpbyJdJyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZ3JvdXAubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgb3RoZXJOb2RlID0gZ3JvdXBbaV07CiAgICAgICAgICAgICAgaWYgKG90aGVyTm9kZSA9PT0gcm9vdE5vZGUgfHwgb3RoZXJOb2RlLmZvcm0gIT09IHJvb3ROb2RlLmZvcm0pIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgb3RoZXJQcm9wcyA9IGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUob3RoZXJOb2RlKTsKICAgICAgICAgICAgICBpZiAoIW90aGVyUHJvcHMpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3RET01JbnB1dDogTWl4aW5nIFJlYWN0IGFuZCBub24tUmVhY3QgcmFkaW8gaW5wdXRzIHdpdGggdGhlIHNhbWUgYG5hbWVgIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZVZhbHVlSWZDaGFuZ2VkKG90aGVyTm9kZSk7CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlcihvdGhlck5vZGUsIG90aGVyUHJvcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldERlZmF1bHRWYWx1ZShub2RlLCB0eXBlLCB2YWx1ZSkgewogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBGb2N1c2VkIG51bWJlciBpbnB1dHMgc3luY2hyb25pemUgb24gYmx1ci4gU2VlIENoYW5nZUV2ZW50UGx1Z2luLmpzCiAgICAgICAgICAgIHR5cGUgIT09ICJudW1iZXIiIHx8IGdldEFjdGl2ZUVsZW1lbnQobm9kZS5vd25lckRvY3VtZW50KSAhPT0gbm9kZQogICAgICAgICAgKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmRlZmF1bHRWYWx1ZSAhPT0gdG9TdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TZWxlY3RlZFNldE9uT3B0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5JbnZhbGlkQ2hpbGQgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRJbm5lckhUTUwgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gIm9iamVjdCIgJiYgcHJvcHMuY2hpbGRyZW4gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0NDQuQ2hpbGRyZW4uZm9yRWFjaChwcm9wcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIGNoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IGluZmVyIHRoZSBvcHRpb24gdmFsdWUgb2YgY29tcGxleCBjaGlsZHJlbi4gUGFzcyBhIGB2YWx1ZWAgcHJvcCBvciB1c2UgYSBwbGFpbiBzdHJpbmcgYXMgY2hpbGRyZW4gdG8gPG9wdGlvbj4uIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuSW52YWxpZElubmVySFRNTCkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJQYXNzIGEgYHZhbHVlYCBwcm9wIGlmIHlvdSBzZXQgZGFuZ2Vyb3VzbHlJbm5lckhUTUwgc28gUmVhY3Qga25vd3Mgd2hpY2ggdmFsdWUgc2hvdWxkIGJlIHNlbGVjdGVkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMuc2VsZWN0ZWQgIT0gbnVsbCAmJiAhZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24pIHsKICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIG9uIDxzZWxlY3Q+IGluc3RlYWQgb2Ygc2V0dGluZyBgc2VsZWN0ZWRgIG9uIDxvcHRpb24+LiIpOwogICAgICAgICAgICAgIGRpZFdhcm5TZWxlY3RlZFNldE9uT3B0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJ2YWx1ZSIsIHRvU3RyaW5nKGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheTIoYTIpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhMik7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVQcm9wTmFtZXMgPSBbInZhbHVlIiwgImRlZmF1bHRWYWx1ZSJdOwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInNlbGVjdCIsIHByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZVByb3BOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHZhbHVlUHJvcE5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm9wTmFtZUlzQXJyYXkgPSBpc0FycmF5Mihwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zMihub2RlLCBtdWx0aXBsZSwgcHJvcFZhbHVlLCBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgIHZhciBvcHRpb25zMiA9IG5vZGUub3B0aW9uczsKICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZXMgPSBwcm9wVmFsdWU7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsZWN0ZWRWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzZWxlY3RlZFZhbHVlWyIkIiArIHNlbGVjdGVkVmFsdWVzW2ldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IG9wdGlvbnMyLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHNlbGVjdGVkVmFsdWUuaGFzT3duUHJvcGVydHkoIiQiICsgb3B0aW9uczJbX2ldLnZhbHVlKTsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2ldLnNlbGVjdGVkICE9PSBzZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzZWxlY3RlZCAmJiBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pXS5kZWZhdWx0U2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zZWxlY3RlZFZhbHVlID0gdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wVmFsdWUpKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRTZWxlY3RlZCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG9wdGlvbnMyLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2kyXS52YWx1ZSA9PT0gX3NlbGVjdGVkVmFsdWUpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBvcHRpb25zMltfaTJdLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgPT09IG51bGwgJiYgIW9wdGlvbnMyW19pMl0uZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZCA9IG9wdGlvbnMyW19pMl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIHdhc011bHRpcGxlOiAhIXByb3BzLm11bHRpcGxlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEpIHsKICAgICAgICAgICAgICBlcnJvcigiU2VsZWN0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIHNlbGVjdCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBub2RlLm11bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMuZGVmYXVsdFZhbHVlLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdFVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB3YXNNdWx0aXBsZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZTsKICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHdhc011bHRpcGxlICE9PSAhIXByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMubXVsdGlwbGUgPyBbXSA6ICIiLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBkYW5nZXJvdXNseVNldElubmVySFRNTGAgZG9lcyBub3QgbWFrZSBzZW5zZSBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCI8dGV4dGFyZWE+IGNhbiBvbmx5IGhhdmUgYXQgbW9zdCBvbmUgY2hpbGQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbml0aWFsVmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShpbml0aWFsVmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMuZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgPT0gbnVsbCAmJiBub2RlLmRlZmF1bHRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyhkZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IG5vZGUudGV4dENvbnRlbnQ7CiAgICAgICAgICBpZiAodGV4dENvbnRlbnQgPT09IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRleHRDb250ZW50ICE9PSAiIiAmJiB0ZXh0Q29udGVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0ZXh0Q29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBIVE1MX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKICAgICAgICB2YXIgTUFUSF9OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCI7CiAgICAgICAgdmFyIFNWR19OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwogICAgICAgIGZ1bmN0aW9uIGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAic3ZnIjoKICAgICAgICAgICAgICByZXR1cm4gU1ZHX05BTUVTUEFDRTsKICAgICAgICAgICAgY2FzZSAibWF0aCI6CiAgICAgICAgICAgICAgcmV0dXJuIE1BVEhfTkFNRVNQQUNFOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBIVE1MX05BTUVTUEFDRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGROYW1lc3BhY2UocGFyZW50TmFtZXNwYWNlLCB0eXBlKSB7CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09IG51bGwgfHwgcGFyZW50TmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICByZXR1cm4gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudE5hbWVzcGFjZSA9PT0gU1ZHX05BTUVTUEFDRSAmJiB0eXBlID09PSAiZm9yZWlnbk9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZU1pY3Jvc29mdFVuc2FmZUxvY2FsRnVuY3Rpb24gPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBpZiAodHlwZW9mIE1TQXBwICE9PSAidW5kZWZpbmVkIiAmJiBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMCwgYXJnMSwgYXJnMiwgYXJnMykgewogICAgICAgICAgICAgIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoYXJnMCwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciByZXVzYWJsZVNWR0NvbnRhaW5lcjsKICAgICAgICB2YXIgc2V0SW5uZXJIVE1MID0gY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbihmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAgICBpZiAobm9kZS5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgaWYgKCEoImlubmVySFRNTCIgaW4gbm9kZSkpIHsKICAgICAgICAgICAgICByZXVzYWJsZVNWR0NvbnRhaW5lciA9IHJldXNhYmxlU1ZHQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIgKyBodG1sLnZhbHVlT2YoKS50b1N0cmluZygpICsgIjwvc3ZnPiI7CiAgICAgICAgICAgICAgdmFyIHN2Z05vZGUgPSByZXVzYWJsZVNWR0NvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQ2hpbGQobm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHN2Z05vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChzdmdOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9KTsKICAgICAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgQ09NTUVOVF9OT0RFID0gODsKICAgICAgICB2YXIgRE9DVU1FTlRfTk9ERSA9IDk7CiAgICAgICAgdmFyIERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgPSAxMTsKICAgICAgICB2YXIgc2V0VGV4dENvbnRlbnQgPSBmdW5jdGlvbihub2RlLCB0ZXh0KSB7CiAgICAgICAgICBpZiAodGV4dCkgewogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgJiYgZmlyc3RDaGlsZCA9PT0gbm9kZS5sYXN0Q2hpbGQgJiYgZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgfTsKICAgICAgICB2YXIgc2hvcnRoYW5kVG9Mb25naGFuZCA9IHsKICAgICAgICAgIGFuaW1hdGlvbjogWyJhbmltYXRpb25EZWxheSIsICJhbmltYXRpb25EaXJlY3Rpb24iLCAiYW5pbWF0aW9uRHVyYXRpb24iLCAiYW5pbWF0aW9uRmlsbE1vZGUiLCAiYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQiLCAiYW5pbWF0aW9uTmFtZSIsICJhbmltYXRpb25QbGF5U3RhdGUiLCAiYW5pbWF0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIGJhY2tncm91bmQ6IFsiYmFja2dyb3VuZEF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZENsaXAiLCAiYmFja2dyb3VuZENvbG9yIiwgImJhY2tncm91bmRJbWFnZSIsICJiYWNrZ3JvdW5kT3JpZ2luIiwgImJhY2tncm91bmRQb3NpdGlvblgiLCAiYmFja2dyb3VuZFBvc2l0aW9uWSIsICJiYWNrZ3JvdW5kUmVwZWF0IiwgImJhY2tncm91bmRTaXplIl0sCiAgICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb246IFsiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIl0sCiAgICAgICAgICBib3JkZXI6IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIiwgImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja0VuZDogWyJib3JkZXJCbG9ja0VuZENvbG9yIiwgImJvcmRlckJsb2NrRW5kU3R5bGUiLCAiYm9yZGVyQmxvY2tFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQmxvY2tTdGFydDogWyJib3JkZXJCbG9ja1N0YXJ0Q29sb3IiLCAiYm9yZGVyQmxvY2tTdGFydFN0eWxlIiwgImJvcmRlckJsb2NrU3RhcnRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQm90dG9tOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckJvdHRvbVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJDb2xvcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJUb3BDb2xvciJdLAogICAgICAgICAgYm9yZGVySW1hZ2U6IFsiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJJbmxpbmVFbmQ6IFsiYm9yZGVySW5saW5lRW5kQ29sb3IiLCAiYm9yZGVySW5saW5lRW5kU3R5bGUiLCAiYm9yZGVySW5saW5lRW5kV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZVN0YXJ0OiBbImJvcmRlcklubGluZVN0YXJ0Q29sb3IiLCAiYm9yZGVySW5saW5lU3RhcnRTdHlsZSIsICJib3JkZXJJbmxpbmVTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJMZWZ0OiBbImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJSYWRpdXM6IFsiYm9yZGVyQm90dG9tTGVmdFJhZGl1cyIsICJib3JkZXJCb3R0b21SaWdodFJhZGl1cyIsICJib3JkZXJUb3BMZWZ0UmFkaXVzIiwgImJvcmRlclRvcFJpZ2h0UmFkaXVzIl0sCiAgICAgICAgICBib3JkZXJSaWdodDogWyJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyU3R5bGU6IFsiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyVG9wU3R5bGUiXSwKICAgICAgICAgIGJvcmRlclRvcDogWyJib3JkZXJUb3BDb2xvciIsICJib3JkZXJUb3BTdHlsZSIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgYm9yZGVyV2lkdGg6IFsiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGNvbHVtblJ1bGU6IFsiY29sdW1uUnVsZUNvbG9yIiwgImNvbHVtblJ1bGVTdHlsZSIsICJjb2x1bW5SdWxlV2lkdGgiXSwKICAgICAgICAgIGNvbHVtbnM6IFsiY29sdW1uQ291bnQiLCAiY29sdW1uV2lkdGgiXSwKICAgICAgICAgIGZsZXg6IFsiZmxleEJhc2lzIiwgImZsZXhHcm93IiwgImZsZXhTaHJpbmsiXSwKICAgICAgICAgIGZsZXhGbG93OiBbImZsZXhEaXJlY3Rpb24iLCAiZmxleFdyYXAiXSwKICAgICAgICAgIGZvbnQ6IFsiZm9udEZhbWlseSIsICJmb250RmVhdHVyZVNldHRpbmdzIiwgImZvbnRLZXJuaW5nIiwgImZvbnRMYW5ndWFnZU92ZXJyaWRlIiwgImZvbnRTaXplIiwgImZvbnRTaXplQWRqdXN0IiwgImZvbnRTdHJldGNoIiwgImZvbnRTdHlsZSIsICJmb250VmFyaWFudCIsICJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIiwgImZvbnRXZWlnaHQiLCAibGluZUhlaWdodCJdLAogICAgICAgICAgZm9udFZhcmlhbnQ6IFsiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiJdLAogICAgICAgICAgZ2FwOiBbImNvbHVtbkdhcCIsICJyb3dHYXAiXSwKICAgICAgICAgIGdyaWQ6IFsiZ3JpZEF1dG9Db2x1bW5zIiwgImdyaWRBdXRvRmxvdyIsICJncmlkQXV0b1Jvd3MiLCAiZ3JpZFRlbXBsYXRlQXJlYXMiLCAiZ3JpZFRlbXBsYXRlQ29sdW1ucyIsICJncmlkVGVtcGxhdGVSb3dzIl0sCiAgICAgICAgICBncmlkQXJlYTogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCIsICJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbjogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbkdhcDogWyJjb2x1bW5HYXAiXSwKICAgICAgICAgIGdyaWRHYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFJvdzogWyJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZFJvd0dhcDogWyJyb3dHYXAiXSwKICAgICAgICAgIGdyaWRUZW1wbGF0ZTogWyJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGxpc3RTdHlsZTogWyJsaXN0U3R5bGVJbWFnZSIsICJsaXN0U3R5bGVQb3NpdGlvbiIsICJsaXN0U3R5bGVUeXBlIl0sCiAgICAgICAgICBtYXJnaW46IFsibWFyZ2luQm90dG9tIiwgIm1hcmdpbkxlZnQiLCAibWFyZ2luUmlnaHQiLCAibWFyZ2luVG9wIl0sCiAgICAgICAgICBtYXJrZXI6IFsibWFya2VyRW5kIiwgIm1hcmtlck1pZCIsICJtYXJrZXJTdGFydCJdLAogICAgICAgICAgbWFzazogWyJtYXNrQ2xpcCIsICJtYXNrQ29tcG9zaXRlIiwgIm1hc2tJbWFnZSIsICJtYXNrTW9kZSIsICJtYXNrT3JpZ2luIiwgIm1hc2tQb3NpdGlvblgiLCAibWFza1Bvc2l0aW9uWSIsICJtYXNrUmVwZWF0IiwgIm1hc2tTaXplIl0sCiAgICAgICAgICBtYXNrUG9zaXRpb246IFsibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIl0sCiAgICAgICAgICBvdXRsaW5lOiBbIm91dGxpbmVDb2xvciIsICJvdXRsaW5lU3R5bGUiLCAib3V0bGluZVdpZHRoIl0sCiAgICAgICAgICBvdmVyZmxvdzogWyJvdmVyZmxvd1giLCAib3ZlcmZsb3dZIl0sCiAgICAgICAgICBwYWRkaW5nOiBbInBhZGRpbmdCb3R0b20iLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiwgInBhZGRpbmdUb3AiXSwKICAgICAgICAgIHBsYWNlQ29udGVudDogWyJhbGlnbkNvbnRlbnQiLCAianVzdGlmeUNvbnRlbnQiXSwKICAgICAgICAgIHBsYWNlSXRlbXM6IFsiYWxpZ25JdGVtcyIsICJqdXN0aWZ5SXRlbXMiXSwKICAgICAgICAgIHBsYWNlU2VsZjogWyJhbGlnblNlbGYiLCAianVzdGlmeVNlbGYiXSwKICAgICAgICAgIHRleHREZWNvcmF0aW9uOiBbInRleHREZWNvcmF0aW9uQ29sb3IiLCAidGV4dERlY29yYXRpb25MaW5lIiwgInRleHREZWNvcmF0aW9uU3R5bGUiXSwKICAgICAgICAgIHRleHRFbXBoYXNpczogWyJ0ZXh0RW1waGFzaXNDb2xvciIsICJ0ZXh0RW1waGFzaXNTdHlsZSJdLAogICAgICAgICAgdHJhbnNpdGlvbjogWyJ0cmFuc2l0aW9uRGVsYXkiLCAidHJhbnNpdGlvbkR1cmF0aW9uIiwgInRyYW5zaXRpb25Qcm9wZXJ0eSIsICJ0cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIHdvcmRXcmFwOiBbIm92ZXJmbG93V3JhcCJdCiAgICAgICAgfTsKICAgICAgICB2YXIgaXNVbml0bGVzc051bWJlciA9IHsKICAgICAgICAgIGFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50OiB0cnVlLAogICAgICAgICAgYXNwZWN0UmF0aW86IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZU91dHNldDogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlU2xpY2U6IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZVdpZHRoOiB0cnVlLAogICAgICAgICAgYm94RmxleDogdHJ1ZSwKICAgICAgICAgIGJveEZsZXhHcm91cDogdHJ1ZSwKICAgICAgICAgIGJveE9yZGluYWxHcm91cDogdHJ1ZSwKICAgICAgICAgIGNvbHVtbkNvdW50OiB0cnVlLAogICAgICAgICAgY29sdW1uczogdHJ1ZSwKICAgICAgICAgIGZsZXg6IHRydWUsCiAgICAgICAgICBmbGV4R3JvdzogdHJ1ZSwKICAgICAgICAgIGZsZXhQb3NpdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhTaHJpbms6IHRydWUsCiAgICAgICAgICBmbGV4TmVnYXRpdmU6IHRydWUsCiAgICAgICAgICBmbGV4T3JkZXI6IHRydWUsCiAgICAgICAgICBncmlkQXJlYTogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3c6IHRydWUsCiAgICAgICAgICBncmlkUm93RW5kOiB0cnVlLAogICAgICAgICAgZ3JpZFJvd1NwYW46IHRydWUsCiAgICAgICAgICBncmlkUm93U3RhcnQ6IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtbkVuZDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW5TcGFuOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblN0YXJ0OiB0cnVlLAogICAgICAgICAgZm9udFdlaWdodDogdHJ1ZSwKICAgICAgICAgIGxpbmVDbGFtcDogdHJ1ZSwKICAgICAgICAgIGxpbmVIZWlnaHQ6IHRydWUsCiAgICAgICAgICBvcGFjaXR5OiB0cnVlLAogICAgICAgICAgb3JkZXI6IHRydWUsCiAgICAgICAgICBvcnBoYW5zOiB0cnVlLAogICAgICAgICAgdGFiU2l6ZTogdHJ1ZSwKICAgICAgICAgIHdpZG93czogdHJ1ZSwKICAgICAgICAgIHpJbmRleDogdHJ1ZSwKICAgICAgICAgIHpvb206IHRydWUsCiAgICAgICAgICAvLyBTVkctcmVsYXRlZCBwcm9wZXJ0aWVzCiAgICAgICAgICBmaWxsT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIGZsb29kT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIHN0b3BPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaG9mZnNldDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU1pdGVybGltaXQ6IHRydWUsCiAgICAgICAgICBzdHJva2VPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlV2lkdGg6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHByZWZpeEtleShwcmVmaXgyLCBrZXkpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXgyICsga2V5LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsga2V5LnN1YnN0cmluZygxKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeGVzMiA9IFsiV2Via2l0IiwgIm1zIiwgIk1veiIsICJPIl07CiAgICAgICAgT2JqZWN0LmtleXMoaXNVbml0bGVzc051bWJlcikuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICBwcmVmaXhlczIuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbjIoewogICAgICAgICAgbWVudWl0ZW06IHRydWUKICAgICAgICB9LCBvbWl0dGVkQ2xvc2VUYWdzKTsKICAgICAgICB2YXIgSFRNTCA9ICJfX2h0bWwiOwogICAgICAgIGZ1bmN0aW9uIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcykgewogICAgICAgICAgaWYgKCFwcm9wcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodm9pZEVsZW1lbnRUYWdzW3RhZ10pIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwgfHwgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0YWcgKyAiIGlzIGEgdm9pZCBlbGVtZW50IHRhZyBhbmQgbXVzdCBuZWl0aGVyIGhhdmUgYGNoaWxkcmVuYCBub3IgdXNlIGBkYW5nZXJvdXNseVNldElubmVySFRNTGAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBzZXQgb25lIG9mIGBjaGlsZHJlbmAgb3IgYHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSAib2JqZWN0IiB8fCAhKEhUTUwgaW4gcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIG11c3QgYmUgaW4gdGhlIGZvcm0gYHtfX2h0bWw6IC4uLn1gLiBQbGVhc2UgdmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rhbmdlcm91c2x5LXNldC1pbm5lci1odG1sIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcHJvcHMuc3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nICYmIHByb3BzLmNvbnRlbnRFZGl0YWJsZSAmJiBwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGBjb250ZW50RWRpdGFibGVgIGFuZCBjb250YWlucyBgY2hpbGRyZW5gIG1hbmFnZWQgYnkgUmVhY3QuIEl0IGlzIG5vdyB5b3VyIHJlc3BvbnNpYmlsaXR5IHRvIGd1YXJhbnRlZSB0aGF0IG5vbmUgb2YgdGhvc2Ugbm9kZXMgYXJlIHVuZXhwZWN0ZWRseSBtb2RpZmllZCBvciBkdXBsaWNhdGVkLiBUaGlzIGlzIHByb2JhYmx5IG5vdCBpbnRlbnRpb25hbC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLnN0eWxlICE9IG51bGwgJiYgdHlwZW9mIHByb3BzLnN0eWxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgc3R5bGVgIHByb3AgZXhwZWN0cyBhIG1hcHBpbmcgZnJvbSBzdHlsZSBwcm9wZXJ0aWVzIHRvIHZhbHVlcywgbm90IGEgc3RyaW5nLiBGb3IgZXhhbXBsZSwgc3R5bGU9e3ttYXJnaW5SaWdodDogc3BhY2luZyArICdlbSd9fSB3aGVuIHVzaW5nIEpTWC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDdXN0b21Db21wb25lbnQodGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIGlmICh0YWdOYW1lLmluZGV4T2YoIi0iKSA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyI7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZ05hbWUpIHsKICAgICAgICAgICAgY2FzZSAiYW5ub3RhdGlvbi14bWwiOgogICAgICAgICAgICBjYXNlICJjb2xvci1wcm9maWxlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXNyYyI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS11cmkiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtZm9ybWF0IjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLW5hbWUiOgogICAgICAgICAgICBjYXNlICJtaXNzaW5nLWdseXBoIjoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwb3NzaWJsZVN0YW5kYXJkTmFtZXMgPSB7CiAgICAgICAgICAvLyBIVE1MCiAgICAgICAgICBhY2NlcHQ6ICJhY2NlcHQiLAogICAgICAgICAgYWNjZXB0Y2hhcnNldDogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgImFjY2VwdC1jaGFyc2V0IjogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgYWNjZXNza2V5OiAiYWNjZXNzS2V5IiwKICAgICAgICAgIGFjdGlvbjogImFjdGlvbiIsCiAgICAgICAgICBhbGxvd2Z1bGxzY3JlZW46ICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgYWx0OiAiYWx0IiwKICAgICAgICAgIGFzOiAiYXMiLAogICAgICAgICAgYXN5bmM6ICJhc3luYyIsCiAgICAgICAgICBhdXRvY2FwaXRhbGl6ZTogImF1dG9DYXBpdGFsaXplIiwKICAgICAgICAgIGF1dG9jb21wbGV0ZTogImF1dG9Db21wbGV0ZSIsCiAgICAgICAgICBhdXRvY29ycmVjdDogImF1dG9Db3JyZWN0IiwKICAgICAgICAgIGF1dG9mb2N1czogImF1dG9Gb2N1cyIsCiAgICAgICAgICBhdXRvcGxheTogImF1dG9QbGF5IiwKICAgICAgICAgIGF1dG9zYXZlOiAiYXV0b1NhdmUiLAogICAgICAgICAgY2FwdHVyZTogImNhcHR1cmUiLAogICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgIGNoYWxsZW5nZTogImNoYWxsZW5nZSIsCiAgICAgICAgICBjaGFyc2V0OiAiY2hhclNldCIsCiAgICAgICAgICBjaGVja2VkOiAiY2hlY2tlZCIsCiAgICAgICAgICBjaGlsZHJlbjogImNoaWxkcmVuIiwKICAgICAgICAgIGNpdGU6ICJjaXRlIiwKICAgICAgICAgIGNsYXNzOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNsYXNzaWQ6ICJjbGFzc0lEIiwKICAgICAgICAgIGNsYXNzbmFtZTogImNsYXNzTmFtZSIsCiAgICAgICAgICBjb2xzOiAiY29scyIsCiAgICAgICAgICBjb2xzcGFuOiAiY29sU3BhbiIsCiAgICAgICAgICBjb250ZW50OiAiY29udGVudCIsCiAgICAgICAgICBjb250ZW50ZWRpdGFibGU6ICJjb250ZW50RWRpdGFibGUiLAogICAgICAgICAgY29udGV4dG1lbnU6ICJjb250ZXh0TWVudSIsCiAgICAgICAgICBjb250cm9sczogImNvbnRyb2xzIiwKICAgICAgICAgIGNvbnRyb2xzbGlzdDogImNvbnRyb2xzTGlzdCIsCiAgICAgICAgICBjb29yZHM6ICJjb29yZHMiLAogICAgICAgICAgY3Jvc3NvcmlnaW46ICJjcm9zc09yaWdpbiIsCiAgICAgICAgICBkYW5nZXJvdXNseXNldGlubmVyaHRtbDogImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIGRhdGE6ICJkYXRhIiwKICAgICAgICAgIGRhdGV0aW1lOiAiZGF0ZVRpbWUiLAogICAgICAgICAgZGVmYXVsdDogImRlZmF1bHQiLAogICAgICAgICAgZGVmYXVsdGNoZWNrZWQ6ICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICBkZWZhdWx0dmFsdWU6ICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgZGVmZXI6ICJkZWZlciIsCiAgICAgICAgICBkaXI6ICJkaXIiLAogICAgICAgICAgZGlzYWJsZWQ6ICJkaXNhYmxlZCIsCiAgICAgICAgICBkaXNhYmxlcGljdHVyZWlucGljdHVyZTogImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgIGRpc2FibGVyZW1vdGVwbGF5YmFjazogImRpc2FibGVSZW1vdGVQbGF5YmFjayIsCiAgICAgICAgICBkb3dubG9hZDogImRvd25sb2FkIiwKICAgICAgICAgIGRyYWdnYWJsZTogImRyYWdnYWJsZSIsCiAgICAgICAgICBlbmN0eXBlOiAiZW5jVHlwZSIsCiAgICAgICAgICBlbnRlcmtleWhpbnQ6ICJlbnRlcktleUhpbnQiLAogICAgICAgICAgZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBmb3JtOiAiZm9ybSIsCiAgICAgICAgICBmb3JtbWV0aG9kOiAiZm9ybU1ldGhvZCIsCiAgICAgICAgICBmb3JtYWN0aW9uOiAiZm9ybUFjdGlvbiIsCiAgICAgICAgICBmb3JtZW5jdHlwZTogImZvcm1FbmNUeXBlIiwKICAgICAgICAgIGZvcm1ub3ZhbGlkYXRlOiAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgZm9ybXRhcmdldDogImZvcm1UYXJnZXQiLAogICAgICAgICAgZnJhbWVib3JkZXI6ICJmcmFtZUJvcmRlciIsCiAgICAgICAgICBoZWFkZXJzOiAiaGVhZGVycyIsCiAgICAgICAgICBoZWlnaHQ6ICJoZWlnaHQiLAogICAgICAgICAgaGlkZGVuOiAiaGlkZGVuIiwKICAgICAgICAgIGhpZ2g6ICJoaWdoIiwKICAgICAgICAgIGhyZWY6ICJocmVmIiwKICAgICAgICAgIGhyZWZsYW5nOiAiaHJlZkxhbmciLAogICAgICAgICAgaHRtbGZvcjogImh0bWxGb3IiLAogICAgICAgICAgaHR0cGVxdWl2OiAiaHR0cEVxdWl2IiwKICAgICAgICAgICJodHRwLWVxdWl2IjogImh0dHBFcXVpdiIsCiAgICAgICAgICBpY29uOiAiaWNvbiIsCiAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgIGltYWdlc2l6ZXM6ICJpbWFnZVNpemVzIiwKICAgICAgICAgIGltYWdlc3Jjc2V0OiAiaW1hZ2VTcmNTZXQiLAogICAgICAgICAgaW5uZXJodG1sOiAiaW5uZXJIVE1MIiwKICAgICAgICAgIGlucHV0bW9kZTogImlucHV0TW9kZSIsCiAgICAgICAgICBpbnRlZ3JpdHk6ICJpbnRlZ3JpdHkiLAogICAgICAgICAgaXM6ICJpcyIsCiAgICAgICAgICBpdGVtaWQ6ICJpdGVtSUQiLAogICAgICAgICAgaXRlbXByb3A6ICJpdGVtUHJvcCIsCiAgICAgICAgICBpdGVtcmVmOiAiaXRlbVJlZiIsCiAgICAgICAgICBpdGVtc2NvcGU6ICJpdGVtU2NvcGUiLAogICAgICAgICAgaXRlbXR5cGU6ICJpdGVtVHlwZSIsCiAgICAgICAgICBrZXlwYXJhbXM6ICJrZXlQYXJhbXMiLAogICAgICAgICAga2V5dHlwZTogImtleVR5cGUiLAogICAgICAgICAga2luZDogImtpbmQiLAogICAgICAgICAgbGFiZWw6ICJsYWJlbCIsCiAgICAgICAgICBsYW5nOiAibGFuZyIsCiAgICAgICAgICBsaXN0OiAibGlzdCIsCiAgICAgICAgICBsb29wOiAibG9vcCIsCiAgICAgICAgICBsb3c6ICJsb3ciLAogICAgICAgICAgbWFuaWZlc3Q6ICJtYW5pZmVzdCIsCiAgICAgICAgICBtYXJnaW53aWR0aDogIm1hcmdpbldpZHRoIiwKICAgICAgICAgIG1hcmdpbmhlaWdodDogIm1hcmdpbkhlaWdodCIsCiAgICAgICAgICBtYXg6ICJtYXgiLAogICAgICAgICAgbWF4bGVuZ3RoOiAibWF4TGVuZ3RoIiwKICAgICAgICAgIG1lZGlhOiAibWVkaWEiLAogICAgICAgICAgbWVkaWFncm91cDogIm1lZGlhR3JvdXAiLAogICAgICAgICAgbWV0aG9kOiAibWV0aG9kIiwKICAgICAgICAgIG1pbjogIm1pbiIsCiAgICAgICAgICBtaW5sZW5ndGg6ICJtaW5MZW5ndGgiLAogICAgICAgICAgbXVsdGlwbGU6ICJtdWx0aXBsZSIsCiAgICAgICAgICBtdXRlZDogIm11dGVkIiwKICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgIG5vbW9kdWxlOiAibm9Nb2R1bGUiLAogICAgICAgICAgbm9uY2U6ICJub25jZSIsCiAgICAgICAgICBub3ZhbGlkYXRlOiAibm9WYWxpZGF0ZSIsCiAgICAgICAgICBvcGVuOiAib3BlbiIsCiAgICAgICAgICBvcHRpbXVtOiAib3B0aW11bSIsCiAgICAgICAgICBwYXR0ZXJuOiAicGF0dGVybiIsCiAgICAgICAgICBwbGFjZWhvbGRlcjogInBsYWNlaG9sZGVyIiwKICAgICAgICAgIHBsYXlzaW5saW5lOiAicGxheXNJbmxpbmUiLAogICAgICAgICAgcG9zdGVyOiAicG9zdGVyIiwKICAgICAgICAgIHByZWxvYWQ6ICJwcmVsb2FkIiwKICAgICAgICAgIHByb2ZpbGU6ICJwcm9maWxlIiwKICAgICAgICAgIHJhZGlvZ3JvdXA6ICJyYWRpb0dyb3VwIiwKICAgICAgICAgIHJlYWRvbmx5OiAicmVhZE9ubHkiLAogICAgICAgICAgcmVmZXJyZXJwb2xpY3k6ICJyZWZlcnJlclBvbGljeSIsCiAgICAgICAgICByZWw6ICJyZWwiLAogICAgICAgICAgcmVxdWlyZWQ6ICJyZXF1aXJlZCIsCiAgICAgICAgICByZXZlcnNlZDogInJldmVyc2VkIiwKICAgICAgICAgIHJvbGU6ICJyb2xlIiwKICAgICAgICAgIHJvd3M6ICJyb3dzIiwKICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgIHNhbmRib3g6ICJzYW5kYm94IiwKICAgICAgICAgIHNjb3BlOiAic2NvcGUiLAogICAgICAgICAgc2NvcGVkOiAic2NvcGVkIiwKICAgICAgICAgIHNjcm9sbGluZzogInNjcm9sbGluZyIsCiAgICAgICAgICBzZWFtbGVzczogInNlYW1sZXNzIiwKICAgICAgICAgIHNlbGVjdGVkOiAic2VsZWN0ZWQiLAogICAgICAgICAgc2hhcGU6ICJzaGFwZSIsCiAgICAgICAgICBzaXplOiAic2l6ZSIsCiAgICAgICAgICBzaXplczogInNpemVzIiwKICAgICAgICAgIHNwYW46ICJzcGFuIiwKICAgICAgICAgIHNwZWxsY2hlY2s6ICJzcGVsbENoZWNrIiwKICAgICAgICAgIHNyYzogInNyYyIsCiAgICAgICAgICBzcmNkb2M6ICJzcmNEb2MiLAogICAgICAgICAgc3JjbGFuZzogInNyY0xhbmciLAogICAgICAgICAgc3Jjc2V0OiAic3JjU2V0IiwKICAgICAgICAgIHN0YXJ0OiAic3RhcnQiLAogICAgICAgICAgc3RlcDogInN0ZXAiLAogICAgICAgICAgc3R5bGU6ICJzdHlsZSIsCiAgICAgICAgICBzdW1tYXJ5OiAic3VtbWFyeSIsCiAgICAgICAgICB0YWJpbmRleDogInRhYkluZGV4IiwKICAgICAgICAgIHRhcmdldDogInRhcmdldCIsCiAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICAgICAgICB2YWx1ZTogInZhbHVlIiwKICAgICAgICAgIHdpZHRoOiAid2lkdGgiLAogICAgICAgICAgd21vZGU6ICJ3bW9kZSIsCiAgICAgICAgICB3cmFwOiAid3JhcCIsCiAgICAgICAgICAvLyBTVkcKICAgICAgICAgIGFib3V0OiAiYWJvdXQiLAogICAgICAgICAgYWNjZW50aGVpZ2h0OiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IjogImFjY2VudEhlaWdodCIsCiAgICAgICAgICBhY2N1bXVsYXRlOiAiYWNjdW11bGF0ZSIsCiAgICAgICAgICBhZGRpdGl2ZTogImFkZGl0aXZlIiwKICAgICAgICAgIGFsaWdubWVudGJhc2VsaW5lOiAiYWxpZ25tZW50QmFzZWxpbmUiLAogICAgICAgICAgImFsaWdubWVudC1iYXNlbGluZSI6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICBhbGxvd3Jlb3JkZXI6ICJhbGxvd1Jlb3JkZXIiLAogICAgICAgICAgYWxwaGFiZXRpYzogImFscGhhYmV0aWMiLAogICAgICAgICAgYW1wbGl0dWRlOiAiYW1wbGl0dWRlIiwKICAgICAgICAgIGFyYWJpY2Zvcm06ICJhcmFiaWNGb3JtIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSI6ICJhcmFiaWNGb3JtIiwKICAgICAgICAgIGFzY2VudDogImFzY2VudCIsCiAgICAgICAgICBhdHRyaWJ1dGVuYW1lOiAiYXR0cmlidXRlTmFtZSIsCiAgICAgICAgICBhdHRyaWJ1dGV0eXBlOiAiYXR0cmlidXRlVHlwZSIsCiAgICAgICAgICBhdXRvcmV2ZXJzZTogImF1dG9SZXZlcnNlIiwKICAgICAgICAgIGF6aW11dGg6ICJhemltdXRoIiwKICAgICAgICAgIGJhc2VmcmVxdWVuY3k6ICJiYXNlRnJlcXVlbmN5IiwKICAgICAgICAgIGJhc2VsaW5lc2hpZnQ6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCI6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgIGJhc2Vwcm9maWxlOiAiYmFzZVByb2ZpbGUiLAogICAgICAgICAgYmJveDogImJib3giLAogICAgICAgICAgYmVnaW46ICJiZWdpbiIsCiAgICAgICAgICBiaWFzOiAiYmlhcyIsCiAgICAgICAgICBieTogImJ5IiwKICAgICAgICAgIGNhbGNtb2RlOiAiY2FsY01vZGUiLAogICAgICAgICAgY2FwaGVpZ2h0OiAiY2FwSGVpZ2h0IiwKICAgICAgICAgICJjYXAtaGVpZ2h0IjogImNhcEhlaWdodCIsCiAgICAgICAgICBjbGlwOiAiY2xpcCIsCiAgICAgICAgICBjbGlwcGF0aDogImNsaXBQYXRoIiwKICAgICAgICAgICJjbGlwLXBhdGgiOiAiY2xpcFBhdGgiLAogICAgICAgICAgY2xpcHBhdGh1bml0czogImNsaXBQYXRoVW5pdHMiLAogICAgICAgICAgY2xpcHJ1bGU6ICJjbGlwUnVsZSIsCiAgICAgICAgICAiY2xpcC1ydWxlIjogImNsaXBSdWxlIiwKICAgICAgICAgIGNvbG9yOiAiY29sb3IiLAogICAgICAgICAgY29sb3JpbnRlcnBvbGF0aW9uOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIjogImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb25maWx0ZXJzOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIjogImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICAgICAgICAgY29sb3Jwcm9maWxlOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgICJjb2xvci1wcm9maWxlIjogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICBjb2xvcnJlbmRlcmluZzogImNvbG9yUmVuZGVyaW5nIiwKICAgICAgICAgICJjb2xvci1yZW5kZXJpbmciOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgY29udGVudHNjcmlwdHR5cGU6ICJjb250ZW50U2NyaXB0VHlwZSIsCiAgICAgICAgICBjb250ZW50c3R5bGV0eXBlOiAiY29udGVudFN0eWxlVHlwZSIsCiAgICAgICAgICBjdXJzb3I6ICJjdXJzb3IiLAogICAgICAgICAgY3g6ICJjeCIsCiAgICAgICAgICBjeTogImN5IiwKICAgICAgICAgIGQ6ICJkIiwKICAgICAgICAgIGRhdGF0eXBlOiAiZGF0YXR5cGUiLAogICAgICAgICAgZGVjZWxlcmF0ZTogImRlY2VsZXJhdGUiLAogICAgICAgICAgZGVzY2VudDogImRlc2NlbnQiLAogICAgICAgICAgZGlmZnVzZWNvbnN0YW50OiAiZGlmZnVzZUNvbnN0YW50IiwKICAgICAgICAgIGRpcmVjdGlvbjogImRpcmVjdGlvbiIsCiAgICAgICAgICBkaXNwbGF5OiAiZGlzcGxheSIsCiAgICAgICAgICBkaXZpc29yOiAiZGl2aXNvciIsCiAgICAgICAgICBkb21pbmFudGJhc2VsaW5lOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICBkdXI6ICJkdXIiLAogICAgICAgICAgZHg6ICJkeCIsCiAgICAgICAgICBkeTogImR5IiwKICAgICAgICAgIGVkZ2Vtb2RlOiAiZWRnZU1vZGUiLAogICAgICAgICAgZWxldmF0aW9uOiAiZWxldmF0aW9uIiwKICAgICAgICAgIGVuYWJsZWJhY2tncm91bmQ6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCI6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgIGVuZDogImVuZCIsCiAgICAgICAgICBleHBvbmVudDogImV4cG9uZW50IiwKICAgICAgICAgIGV4dGVybmFscmVzb3VyY2VzcmVxdWlyZWQ6ICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAgICAgICAgIGZpbGw6ICJmaWxsIiwKICAgICAgICAgIGZpbGxvcGFjaXR5OiAiZmlsbE9wYWNpdHkiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSI6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICBmaWxscnVsZTogImZpbGxSdWxlIiwKICAgICAgICAgICJmaWxsLXJ1bGUiOiAiZmlsbFJ1bGUiLAogICAgICAgICAgZmlsdGVyOiAiZmlsdGVyIiwKICAgICAgICAgIGZpbHRlcnJlczogImZpbHRlclJlcyIsCiAgICAgICAgICBmaWx0ZXJ1bml0czogImZpbHRlclVuaXRzIiwKICAgICAgICAgIGZsb29kb3BhY2l0eTogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSI6ICJmbG9vZE9wYWNpdHkiLAogICAgICAgICAgZmxvb2Rjb2xvcjogImZsb29kQ29sb3IiLAogICAgICAgICAgImZsb29kLWNvbG9yIjogImZsb29kQ29sb3IiLAogICAgICAgICAgZm9jdXNhYmxlOiAiZm9jdXNhYmxlIiwKICAgICAgICAgIGZvbnRmYW1pbHk6ICJmb250RmFtaWx5IiwKICAgICAgICAgICJmb250LWZhbWlseSI6ICJmb250RmFtaWx5IiwKICAgICAgICAgIGZvbnRzaXplOiAiZm9udFNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZSI6ICJmb250U2l6ZSIsCiAgICAgICAgICBmb250c2l6ZWFkanVzdDogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgICJmb250LXNpemUtYWRqdXN0IjogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgIGZvbnRzdHJldGNoOiAiZm9udFN0cmV0Y2giLAogICAgICAgICAgImZvbnQtc3RyZXRjaCI6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICBmb250c3R5bGU6ICJmb250U3R5bGUiLAogICAgICAgICAgImZvbnQtc3R5bGUiOiAiZm9udFN0eWxlIiwKICAgICAgICAgIGZvbnR2YXJpYW50OiAiZm9udFZhcmlhbnQiLAogICAgICAgICAgImZvbnQtdmFyaWFudCI6ICJmb250VmFyaWFudCIsCiAgICAgICAgICBmb250d2VpZ2h0OiAiZm9udFdlaWdodCIsCiAgICAgICAgICAiZm9udC13ZWlnaHQiOiAiZm9udFdlaWdodCIsCiAgICAgICAgICBmb3JtYXQ6ICJmb3JtYXQiLAogICAgICAgICAgZnJvbTogImZyb20iLAogICAgICAgICAgZng6ICJmeCIsCiAgICAgICAgICBmeTogImZ5IiwKICAgICAgICAgIGcxOiAiZzEiLAogICAgICAgICAgZzI6ICJnMiIsCiAgICAgICAgICBnbHlwaG5hbWU6ICJnbHlwaE5hbWUiLAogICAgICAgICAgImdseXBoLW5hbWUiOiAiZ2x5cGhOYW1lIiwKICAgICAgICAgIGdseXBob3JpZW50YXRpb25ob3Jpem9udGFsOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLWhvcml6b250YWwiOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbnZlcnRpY2FsOiAiZ2x5cGhPcmllbnRhdGlvblZlcnRpY2FsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCI6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgZ2x5cGhyZWY6ICJnbHlwaFJlZiIsCiAgICAgICAgICBncmFkaWVudHRyYW5zZm9ybTogImdyYWRpZW50VHJhbnNmb3JtIiwKICAgICAgICAgIGdyYWRpZW50dW5pdHM6ICJncmFkaWVudFVuaXRzIiwKICAgICAgICAgIGhhbmdpbmc6ICJoYW5naW5nIiwKICAgICAgICAgIGhvcml6YWR2eDogImhvcml6QWR2WCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiOiAiaG9yaXpBZHZYIiwKICAgICAgICAgIGhvcml6b3JpZ2lueDogImhvcml6T3JpZ2luWCIsCiAgICAgICAgICAiaG9yaXotb3JpZ2luLXgiOiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgIGlkZW9ncmFwaGljOiAiaWRlb2dyYXBoaWMiLAogICAgICAgICAgaW1hZ2VyZW5kZXJpbmc6ICJpbWFnZVJlbmRlcmluZyIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIjogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgIGluMjogImluMiIsCiAgICAgICAgICBpbjogImluIiwKICAgICAgICAgIGlubGlzdDogImlubGlzdCIsCiAgICAgICAgICBpbnRlcmNlcHQ6ICJpbnRlcmNlcHQiLAogICAgICAgICAgazE6ICJrMSIsCiAgICAgICAgICBrMjogImsyIiwKICAgICAgICAgIGszOiAiazMiLAogICAgICAgICAgazQ6ICJrNCIsCiAgICAgICAgICBrOiAiayIsCiAgICAgICAgICBrZXJuZWxtYXRyaXg6ICJrZXJuZWxNYXRyaXgiLAogICAgICAgICAga2VybmVsdW5pdGxlbmd0aDogImtlcm5lbFVuaXRMZW5ndGgiLAogICAgICAgICAga2VybmluZzogImtlcm5pbmciLAogICAgICAgICAga2V5cG9pbnRzOiAia2V5UG9pbnRzIiwKICAgICAgICAgIGtleXNwbGluZXM6ICJrZXlTcGxpbmVzIiwKICAgICAgICAgIGtleXRpbWVzOiAia2V5VGltZXMiLAogICAgICAgICAgbGVuZ3RoYWRqdXN0OiAibGVuZ3RoQWRqdXN0IiwKICAgICAgICAgIGxldHRlcnNwYWNpbmc6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyI6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgIGxpZ2h0aW5nY29sb3I6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciI6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgIGxpbWl0aW5nY29uZWFuZ2xlOiAibGltaXRpbmdDb25lQW5nbGUiLAogICAgICAgICAgbG9jYWw6ICJsb2NhbCIsCiAgICAgICAgICBtYXJrZXJlbmQ6ICJtYXJrZXJFbmQiLAogICAgICAgICAgIm1hcmtlci1lbmQiOiAibWFya2VyRW5kIiwKICAgICAgICAgIG1hcmtlcmhlaWdodDogIm1hcmtlckhlaWdodCIsCiAgICAgICAgICBtYXJrZXJtaWQ6ICJtYXJrZXJNaWQiLAogICAgICAgICAgIm1hcmtlci1taWQiOiAibWFya2VyTWlkIiwKICAgICAgICAgIG1hcmtlcnN0YXJ0OiAibWFya2VyU3RhcnQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCI6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICBtYXJrZXJ1bml0czogIm1hcmtlclVuaXRzIiwKICAgICAgICAgIG1hcmtlcndpZHRoOiAibWFya2VyV2lkdGgiLAogICAgICAgICAgbWFzazogIm1hc2siLAogICAgICAgICAgbWFza2NvbnRlbnR1bml0czogIm1hc2tDb250ZW50VW5pdHMiLAogICAgICAgICAgbWFza3VuaXRzOiAibWFza1VuaXRzIiwKICAgICAgICAgIG1hdGhlbWF0aWNhbDogIm1hdGhlbWF0aWNhbCIsCiAgICAgICAgICBtb2RlOiAibW9kZSIsCiAgICAgICAgICBudW1vY3RhdmVzOiAibnVtT2N0YXZlcyIsCiAgICAgICAgICBvZmZzZXQ6ICJvZmZzZXQiLAogICAgICAgICAgb3BhY2l0eTogIm9wYWNpdHkiLAogICAgICAgICAgb3BlcmF0b3I6ICJvcGVyYXRvciIsCiAgICAgICAgICBvcmRlcjogIm9yZGVyIiwKICAgICAgICAgIG9yaWVudDogIm9yaWVudCIsCiAgICAgICAgICBvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiwKICAgICAgICAgIG9yaWdpbjogIm9yaWdpbiIsCiAgICAgICAgICBvdmVyZmxvdzogIm92ZXJmbG93IiwKICAgICAgICAgIG92ZXJsaW5lcG9zaXRpb246ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiI6ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIG92ZXJsaW5ldGhpY2tuZXNzOiAib3ZlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyI6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICBwYWludG9yZGVyOiAicGFpbnRPcmRlciIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiOiAicGFpbnRPcmRlciIsCiAgICAgICAgICBwYW5vc2UxOiAicGFub3NlMSIsCiAgICAgICAgICAicGFub3NlLTEiOiAicGFub3NlMSIsCiAgICAgICAgICBwYXRobGVuZ3RoOiAicGF0aExlbmd0aCIsCiAgICAgICAgICBwYXR0ZXJuY29udGVudHVuaXRzOiAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgICAgICAgICBwYXR0ZXJudHJhbnNmb3JtOiAicGF0dGVyblRyYW5zZm9ybSIsCiAgICAgICAgICBwYXR0ZXJudW5pdHM6ICJwYXR0ZXJuVW5pdHMiLAogICAgICAgICAgcG9pbnRlcmV2ZW50czogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIjogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgcG9pbnRzOiAicG9pbnRzIiwKICAgICAgICAgIHBvaW50c2F0eDogInBvaW50c0F0WCIsCiAgICAgICAgICBwb2ludHNhdHk6ICJwb2ludHNBdFkiLAogICAgICAgICAgcG9pbnRzYXR6OiAicG9pbnRzQXRaIiwKICAgICAgICAgIHByZWZpeDogInByZWZpeCIsCiAgICAgICAgICBwcmVzZXJ2ZWFscGhhOiAicHJlc2VydmVBbHBoYSIsCiAgICAgICAgICBwcmVzZXJ2ZWFzcGVjdHJhdGlvOiAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgICAgICAgICBwcmltaXRpdmV1bml0czogInByaW1pdGl2ZVVuaXRzIiwKICAgICAgICAgIHByb3BlcnR5OiAicHJvcGVydHkiLAogICAgICAgICAgcjogInIiLAogICAgICAgICAgcmFkaXVzOiAicmFkaXVzIiwKICAgICAgICAgIHJlZng6ICJyZWZYIiwKICAgICAgICAgIHJlZnk6ICJyZWZZIiwKICAgICAgICAgIHJlbmRlcmluZ2ludGVudDogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCI6ICJyZW5kZXJpbmdJbnRlbnQiLAogICAgICAgICAgcmVwZWF0Y291bnQ6ICJyZXBlYXRDb3VudCIsCiAgICAgICAgICByZXBlYXRkdXI6ICJyZXBlYXREdXIiLAogICAgICAgICAgcmVxdWlyZWRleHRlbnNpb25zOiAicmVxdWlyZWRFeHRlbnNpb25zIiwKICAgICAgICAgIHJlcXVpcmVkZmVhdHVyZXM6ICJyZXF1aXJlZEZlYXR1cmVzIiwKICAgICAgICAgIHJlc291cmNlOiAicmVzb3VyY2UiLAogICAgICAgICAgcmVzdGFydDogInJlc3RhcnQiLAogICAgICAgICAgcmVzdWx0OiAicmVzdWx0IiwKICAgICAgICAgIHJlc3VsdHM6ICJyZXN1bHRzIiwKICAgICAgICAgIHJvdGF0ZTogInJvdGF0ZSIsCiAgICAgICAgICByeDogInJ4IiwKICAgICAgICAgIHJ5OiAicnkiLAogICAgICAgICAgc2NhbGU6ICJzY2FsZSIsCiAgICAgICAgICBzZWN1cml0eTogInNlY3VyaXR5IiwKICAgICAgICAgIHNlZWQ6ICJzZWVkIiwKICAgICAgICAgIHNoYXBlcmVuZGVyaW5nOiAic2hhcGVSZW5kZXJpbmciLAogICAgICAgICAgInNoYXBlLXJlbmRlcmluZyI6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICBzbG9wZTogInNsb3BlIiwKICAgICAgICAgIHNwYWNpbmc6ICJzcGFjaW5nIiwKICAgICAgICAgIHNwZWN1bGFyY29uc3RhbnQ6ICJzcGVjdWxhckNvbnN0YW50IiwKICAgICAgICAgIHNwZWN1bGFyZXhwb25lbnQ6ICJzcGVjdWxhckV4cG9uZW50IiwKICAgICAgICAgIHNwZWVkOiAic3BlZWQiLAogICAgICAgICAgc3ByZWFkbWV0aG9kOiAic3ByZWFkTWV0aG9kIiwKICAgICAgICAgIHN0YXJ0b2Zmc2V0OiAic3RhcnRPZmZzZXQiLAogICAgICAgICAgc3RkZGV2aWF0aW9uOiAic3RkRGV2aWF0aW9uIiwKICAgICAgICAgIHN0ZW1oOiAic3RlbWgiLAogICAgICAgICAgc3RlbXY6ICJzdGVtdiIsCiAgICAgICAgICBzdGl0Y2h0aWxlczogInN0aXRjaFRpbGVzIiwKICAgICAgICAgIHN0b3Bjb2xvcjogInN0b3BDb2xvciIsCiAgICAgICAgICAic3RvcC1jb2xvciI6ICJzdG9wQ29sb3IiLAogICAgICAgICAgc3RvcG9wYWNpdHk6ICJzdG9wT3BhY2l0eSIsCiAgICAgICAgICAic3RvcC1vcGFjaXR5IjogInN0b3BPcGFjaXR5IiwKICAgICAgICAgIHN0cmlrZXRocm91Z2hwb3NpdGlvbjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiI6ICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICAgICAgICAgc3RyaWtldGhyb3VnaHRoaWNrbmVzczogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIjogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgc3RyaW5nOiAic3RyaW5nIiwKICAgICAgICAgIHN0cm9rZTogInN0cm9rZSIsCiAgICAgICAgICBzdHJva2VkYXNoYXJyYXk6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiOiAic3Ryb2tlRGFzaGFycmF5IiwKICAgICAgICAgIHN0cm9rZWRhc2hvZmZzZXQ6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCI6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgIHN0cm9rZWxpbmVjYXA6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCI6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgIHN0cm9rZWxpbmVqb2luOiAic3Ryb2tlTGluZWpvaW4iLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiI6ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICBzdHJva2VtaXRlcmxpbWl0OiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiOiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICBzdHJva2V3aWR0aDogInN0cm9rZVdpZHRoIiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgc3Ryb2tlb3BhY2l0eTogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IjogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgc3VwcHJlc3Njb250ZW50ZWRpdGFibGV3YXJuaW5nOiAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgIHN1cHByZXNzaHlkcmF0aW9ud2FybmluZzogInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICBzdXJmYWNlc2NhbGU6ICJzdXJmYWNlU2NhbGUiLAogICAgICAgICAgc3lzdGVtbGFuZ3VhZ2U6ICJzeXN0ZW1MYW5ndWFnZSIsCiAgICAgICAgICB0YWJsZXZhbHVlczogInRhYmxlVmFsdWVzIiwKICAgICAgICAgIHRhcmdldHg6ICJ0YXJnZXRYIiwKICAgICAgICAgIHRhcmdldHk6ICJ0YXJnZXRZIiwKICAgICAgICAgIHRleHRhbmNob3I6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWFuY2hvciI6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgIHRleHRkZWNvcmF0aW9uOiAidGV4dERlY29yYXRpb24iLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiI6ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICB0ZXh0bGVuZ3RoOiAidGV4dExlbmd0aCIsCiAgICAgICAgICB0ZXh0cmVuZGVyaW5nOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICB0bzogInRvIiwKICAgICAgICAgIHRyYW5zZm9ybTogInRyYW5zZm9ybSIsCiAgICAgICAgICB0eXBlb2Y6ICJ0eXBlb2YiLAogICAgICAgICAgdTE6ICJ1MSIsCiAgICAgICAgICB1MjogInUyIiwKICAgICAgICAgIHVuZGVybGluZXBvc2l0aW9uOiAidW5kZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiI6ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICB1bmRlcmxpbmV0aGlja25lc3M6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHVuaWNvZGU6ICJ1bmljb2RlIiwKICAgICAgICAgIHVuaWNvZGViaWRpOiAidW5pY29kZUJpZGkiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSI6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICB1bmljb2RlcmFuZ2U6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgInVuaWNvZGUtcmFuZ2UiOiAidW5pY29kZVJhbmdlIiwKICAgICAgICAgIHVuaXRzcGVyZW06ICJ1bml0c1BlckVtIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iOiAidW5pdHNQZXJFbSIsCiAgICAgICAgICB1bnNlbGVjdGFibGU6ICJ1bnNlbGVjdGFibGUiLAogICAgICAgICAgdmFscGhhYmV0aWM6ICJ2QWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1hbHBoYWJldGljIjogInZBbHBoYWJldGljIiwKICAgICAgICAgIHZhbHVlczogInZhbHVlcyIsCiAgICAgICAgICB2ZWN0b3JlZmZlY3Q6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiOiAidmVjdG9yRWZmZWN0IiwKICAgICAgICAgIHZlcnNpb246ICJ2ZXJzaW9uIiwKICAgICAgICAgIHZlcnRhZHZ5OiAidmVydEFkdlkiLAogICAgICAgICAgInZlcnQtYWR2LXkiOiAidmVydEFkdlkiLAogICAgICAgICAgdmVydG9yaWdpbng6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCI6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueTogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi15IjogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgIHZoYW5naW5nOiAidkhhbmdpbmciLAogICAgICAgICAgInYtaGFuZ2luZyI6ICJ2SGFuZ2luZyIsCiAgICAgICAgICB2aWRlb2dyYXBoaWM6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgInYtaWRlb2dyYXBoaWMiOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgIHZpZXdib3g6ICJ2aWV3Qm94IiwKICAgICAgICAgIHZpZXd0YXJnZXQ6ICJ2aWV3VGFyZ2V0IiwKICAgICAgICAgIHZpc2liaWxpdHk6ICJ2aXNpYmlsaXR5IiwKICAgICAgICAgIHZtYXRoZW1hdGljYWw6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCI6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgIHZvY2FiOiAidm9jYWIiLAogICAgICAgICAgd2lkdGhzOiAid2lkdGhzIiwKICAgICAgICAgIHdvcmRzcGFjaW5nOiAid29yZFNwYWNpbmciLAogICAgICAgICAgIndvcmQtc3BhY2luZyI6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICB3cml0aW5nbW9kZTogIndyaXRpbmdNb2RlIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgeDE6ICJ4MSIsCiAgICAgICAgICB4MjogIngyIiwKICAgICAgICAgIHg6ICJ4IiwKICAgICAgICAgIHhjaGFubmVsc2VsZWN0b3I6ICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHhoZWlnaHQ6ICJ4SGVpZ2h0IiwKICAgICAgICAgICJ4LWhlaWdodCI6ICJ4SGVpZ2h0IiwKICAgICAgICAgIHhsaW5rYWN0dWF0ZTogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICAieGxpbms6YWN0dWF0ZSI6ICJ4bGlua0FjdHVhdGUiLAogICAgICAgICAgeGxpbmthcmNyb2xlOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIjogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICB4bGlua2hyZWY6ICJ4bGlua0hyZWYiLAogICAgICAgICAgInhsaW5rOmhyZWYiOiAieGxpbmtIcmVmIiwKICAgICAgICAgIHhsaW5rcm9sZTogInhsaW5rUm9sZSIsCiAgICAgICAgICAieGxpbms6cm9sZSI6ICJ4bGlua1JvbGUiLAogICAgICAgICAgeGxpbmtzaG93OiAieGxpbmtTaG93IiwKICAgICAgICAgICJ4bGluazpzaG93IjogInhsaW5rU2hvdyIsCiAgICAgICAgICB4bGlua3RpdGxlOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICAieGxpbms6dGl0bGUiOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICB4bGlua3R5cGU6ICJ4bGlua1R5cGUiLAogICAgICAgICAgInhsaW5rOnR5cGUiOiAieGxpbmtUeXBlIiwKICAgICAgICAgIHhtbGJhc2U6ICJ4bWxCYXNlIiwKICAgICAgICAgICJ4bWw6YmFzZSI6ICJ4bWxCYXNlIiwKICAgICAgICAgIHhtbGxhbmc6ICJ4bWxMYW5nIiwKICAgICAgICAgICJ4bWw6bGFuZyI6ICJ4bWxMYW5nIiwKICAgICAgICAgIHhtbG5zOiAieG1sbnMiLAogICAgICAgICAgInhtbDpzcGFjZSI6ICJ4bWxTcGFjZSIsCiAgICAgICAgICB4bWxuc3hsaW5rOiAieG1sbnNYbGluayIsCiAgICAgICAgICAieG1sbnM6eGxpbmsiOiAieG1sbnNYbGluayIsCiAgICAgICAgICB4bWxzcGFjZTogInhtbFNwYWNlIiwKICAgICAgICAgIHkxOiAieTEiLAogICAgICAgICAgeTI6ICJ5MiIsCiAgICAgICAgICB5OiAieSIsCiAgICAgICAgICB5Y2hhbm5lbHNlbGVjdG9yOiAieUNoYW5uZWxTZWxlY3RvciIsCiAgICAgICAgICB6OiAieiIsCiAgICAgICAgICB6b29tYW5kcGFuOiAiem9vbUFuZFBhbiIKICAgICAgICB9OwogICAgICAgIHZhciBhcmlhUHJvcGVydGllcyA9IHsKICAgICAgICAgICJhcmlhLWN1cnJlbnQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgICJhcmlhLWRldGFpbHMiOiAwLAogICAgICAgICAgImFyaWEtZGlzYWJsZWQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWhpZGRlbiI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaW52YWxpZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEta2V5c2hvcnRjdXRzIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsIjogMCwKICAgICAgICAgICJhcmlhLXJvbGVkZXNjcmlwdGlvbiI6IDAsCiAgICAgICAgICAvLyBXaWRnZXQgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogMCwKICAgICAgICAgICJhcmlhLWNoZWNrZWQiOiAwLAogICAgICAgICAgImFyaWEtZXhwYW5kZWQiOiAwLAogICAgICAgICAgImFyaWEtaGFzcG9wdXAiOiAwLAogICAgICAgICAgImFyaWEtbGV2ZWwiOiAwLAogICAgICAgICAgImFyaWEtbW9kYWwiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlsaW5lIjogMCwKICAgICAgICAgICJhcmlhLW11bHRpc2VsZWN0YWJsZSI6IDAsCiAgICAgICAgICAiYXJpYS1vcmllbnRhdGlvbiI6IDAsCiAgICAgICAgICAiYXJpYS1wbGFjZWhvbGRlciI6IDAsCiAgICAgICAgICAiYXJpYS1wcmVzc2VkIjogMCwKICAgICAgICAgICJhcmlhLXJlYWRvbmx5IjogMCwKICAgICAgICAgICJhcmlhLXJlcXVpcmVkIjogMCwKICAgICAgICAgICJhcmlhLXNlbGVjdGVkIjogMCwKICAgICAgICAgICJhcmlhLXNvcnQiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtYXgiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtaW4iOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVub3ciOiAwLAogICAgICAgICAgImFyaWEtdmFsdWV0ZXh0IjogMCwKICAgICAgICAgIC8vIExpdmUgUmVnaW9uIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWF0b21pYyI6IDAsCiAgICAgICAgICAiYXJpYS1idXN5IjogMCwKICAgICAgICAgICJhcmlhLWxpdmUiOiAwLAogICAgICAgICAgImFyaWEtcmVsZXZhbnQiOiAwLAogICAgICAgICAgLy8gRHJhZy1hbmQtRHJvcCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1kcm9wZWZmZWN0IjogMCwKICAgICAgICAgICJhcmlhLWdyYWJiZWQiOiAwLAogICAgICAgICAgLy8gUmVsYXRpb25zaGlwIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiOiAwLAogICAgICAgICAgImFyaWEtY29sY291bnQiOiAwLAogICAgICAgICAgImFyaWEtY29saW5kZXgiOiAwLAogICAgICAgICAgImFyaWEtY29sc3BhbiI6IDAsCiAgICAgICAgICAiYXJpYS1jb250cm9scyI6IDAsCiAgICAgICAgICAiYXJpYS1kZXNjcmliZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1lcnJvcm1lc3NhZ2UiOiAwLAogICAgICAgICAgImFyaWEtZmxvd3RvIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsbGVkYnkiOiAwLAogICAgICAgICAgImFyaWEtb3ducyI6IDAsCiAgICAgICAgICAiYXJpYS1wb3NpbnNldCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3djb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dzcGFuIjogMCwKICAgICAgICAgICJhcmlhLXNldHNpemUiOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByQVJJQSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciByQVJJQUNhbWVsID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydHkodGFnTmFtZSwgbmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRQcm9wZXJ0aWVzLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBQ2FtZWwudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHZhciBhcmlhTmFtZSA9ICJhcmlhLSIgKyBuYW1lLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3ROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoYXJpYU5hbWUpID8gYXJpYU5hbWUgOiBudWxsOwogICAgICAgICAgICAgIGlmIChjb3JyZWN0TmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBBUklBIGF0dHJpYnV0ZSBgJXNgLiBBUklBIGF0dHJpYnV0ZXMgZm9sbG93IHRoZSBwYXR0ZXJuIGFyaWEtKiBhbmQgbXVzdCBiZSBsb3dlcmNhc2UuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gY29ycmVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIGNvcnJlY3ROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyQVJJQS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBsb3dlckNhc2VkTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5hbWUgIT09IHN0YW5kYXJkTmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkludmFsaWRBUklBUHJvcHModHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGludmFsaWRQcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkodHlwZSwga2V5KTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGludmFsaWRQcm9wcy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1bmtub3duUHJvcFN0cmluZyA9IGludmFsaWRQcm9wcy5tYXAoZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgIHJldHVybiAiYCIgKyBwcm9wICsgImAiOwogICAgICAgICAgICB9KS5qb2luKCIsICIpOwogICAgICAgICAgICBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGFyaWEgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVOdWxsID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICJpbnB1dCIgJiYgdHlwZSAhPT0gInRleHRhcmVhIiAmJiB0eXBlICE9PSAic2VsZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMgIT0gbnVsbCAmJiBwcm9wcy52YWx1ZSA9PT0gbnVsbCAmJiAhZGlkV2FyblZhbHVlTnVsbCkgewogICAgICAgICAgICAgIGRpZFdhcm5WYWx1ZU51bGwgPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSAic2VsZWN0IiAmJiBwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgYXJyYXkgd2hlbiBgbXVsdGlwbGVgIGlzIHNldCB0byBgdHJ1ZWAgdG8gY2xlYXIgdGhlIGNvbXBvbmVudCBvciBgdW5kZWZpbmVkYCBmb3IgdW5jb250cm9sbGVkIGNvbXBvbmVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IHN0cmluZyB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHdhcm5lZFByb3BlcnRpZXMkMSA9IHt9OwogICAgICAgICAgdmFyIEVWRU5UX05BTUVfUkVHRVggPSAvXm9uLi87CiAgICAgICAgICB2YXIgSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYID0gL15vblteQS1aXS87CiAgICAgICAgICB2YXIgckFSSUEkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFyIHJBUklBQ2FtZWwkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSlbQS1aXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKHRhZ05hbWUsIG5hbWUsIHZhbHVlLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMkMSwgbmFtZSkgJiYgd2FybmVkUHJvcGVydGllcyQxW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3VzaW4iIHx8IGxvd2VyQ2FzZWROYW1lID09PSAib25mb2N1c291dCIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgdXNlcyBvbkZvY3VzIGFuZCBvbkJsdXIgaW5zdGVhZCBvZiBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQuIEFsbCBSZWFjdCBldmVudHMgYXJlIG5vcm1hbGl6ZWQgdG8gYnViYmxlLCBzbyBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQgYXJlIG5vdCBuZWVkZWQvc3VwcG9ydGVkIGJ5IFJlYWN0LiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50UmVnaXN0cnkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzMiA9IGV2ZW50UmVnaXN0cnkucmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lczIgPSBldmVudFJlZ2lzdHJ5LnBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXM7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMi5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMltsb3dlckNhc2VkTmFtZV0gOiBudWxsOwogICAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVbmtub3duIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gSXQgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICBpZiAoSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gUmVhY3QgZXZlbnRzIHVzZSB0aGUgY2FtZWxDYXNlIG5hbWluZyBjb252ZW50aW9uLCBmb3IgZXhhbXBsZSBgb25DbGlja2AuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBJDEudGVzdChuYW1lKSB8fCByQVJJQUNhbWVsJDEudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlubmVyaHRtbCIpIHsKICAgICAgICAgICAgICBlcnJvcigiRGlyZWN0bHkgc2V0dGluZyBwcm9wZXJ0eSBgaW5uZXJIVE1MYCBpcyBub3QgcGVybWl0dGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgbG9va3VwIGRvY3VtZW50YXRpb24gb24gYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImFyaWEiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgYXJpYWAgYXR0cmlidXRlIGlzIHJlc2VydmVkIGZvciBmdXR1cmUgdXNlIGluIFJlYWN0LiBQYXNzIGluZGl2aWR1YWwgYGFyaWEtYCBhdHRyaWJ1dGVzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJpcyIgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHZvaWQgMCAmJiB0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGEgYCVzYCBmb3IgYSBzdHJpbmcgYXR0cmlidXRlIGBpc2AuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIHR5cGVvZiB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiBpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgTmFOIGZvciB0aGUgYCVzYCBhdHRyaWJ1dGUuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIG5hbWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGdldFByb3BlcnR5SW5mbyhuYW1lKTsKICAgICAgICAgICAgdmFyIGlzUmVzZXJ2ZWQgPSBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgICBpZiAocG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdOwogICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIERPTSBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZCAmJiBuYW1lICE9PSBsb3dlckNhc2VkTmFtZSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkb2VzIG5vdCByZWNvZ25pemUgdGhlIGAlc2AgcHJvcCBvbiBhIERPTSBlbGVtZW50LiBJZiB5b3UgaW50ZW50aW9uYWxseSB3YW50IGl0IHRvIGFwcGVhciBpbiB0aGUgRE9NIGFzIGEgY3VzdG9tIGF0dHJpYnV0ZSwgc3BlbGwgaXQgYXMgbG93ZXJjYXNlIGAlc2AgaW5zdGVhZC4gSWYgeW91IGFjY2lkZW50YWxseSBwYXNzZWQgaXQgZnJvbSBhIHBhcmVudCBjb21wb25lbnQsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gZWxlbWVudC4iLCBuYW1lLCBsb3dlckNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgJiYgc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzUmVzZXJ2ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gImZhbHNlIiB8fCB2YWx1ZSA9PT0gInRydWUiKSAmJiBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgdGhlIHN0cmluZyBgJXNgIGZvciB0aGUgYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC4gJXMgRGlkIHlvdSBtZWFuICVzPXslc30/IiwgdmFsdWUsIG5hbWUsIHZhbHVlID09PSAiZmFsc2UiID8gIlRoZSBicm93c2VyIHdpbGwgaW50ZXJwcmV0IGl0IGFzIGEgdHJ1dGh5IHZhbHVlLiIgOiAnQWx0aG91Z2ggdGhpcyB3b3JrcywgaXQgd2lsbCBub3Qgd29yayBhcyBleHBlY3RlZCBpZiB5b3UgcGFzcyB0aGUgc3RyaW5nICJmYWxzZSIuJywgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24odHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkkMSh0eXBlLCBrZXksIHByb3BzW2tleV0sIGV2ZW50UmVnaXN0cnkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgdW5rbm93blByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gdW5rbm93blByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmICh1bmtub3duUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWUgZm9yIHByb3AgJXMgb24gPCVzPiB0YWcuIEVpdGhlciByZW1vdmUgaXQgZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCBpdCBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWVzIGZvciBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSB0aGVtIGZyb20gdGhlIGVsZW1lbnQsIG9yIHBhc3MgYSBzdHJpbmcgb3IgbnVtYmVyIHZhbHVlIHRvIGtlZXAgdGhlbSBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuVW5rbm93blByb3BlcnRpZXModHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpOwogICAgICAgIH0KICAgICAgICB2YXIgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgPSAxOwogICAgICAgIHZhciBJU19OT05fREVMRUdBVEVEID0gMSA8PCAxOwogICAgICAgIHZhciBJU19DQVBUVVJFX1BIQVNFID0gMSA8PCAyOwogICAgICAgIHZhciBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUyA9IElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFIHwgSVNfTk9OX0RFTEVHQVRFRCB8IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgdmFyIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0UmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXBsYXlpbmdFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IGV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFJlcGxheWluZ0V2ZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gbm90IGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHJldHVybiBldmVudCA9PT0gY3VycmVudFJlcGxheWluZ0V2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG5hdGl2ZUV2ZW50LnRhcmdldCB8fCBuYXRpdmVFdmVudC5zcmNFbGVtZW50IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICh0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LmNvcnJlc3BvbmRpbmdVc2VFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRhcmdldC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gdGFyZ2V0LnBhcmVudE5vZGUgOiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIHZhciByZXN0b3JlSW1wbCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVUYXJnZXQgPSBudWxsOwogICAgICAgIHZhciByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHRhcmdldCkgewogICAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2UgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKHRhcmdldCk7CiAgICAgICAgICBpZiAoIWludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiByZXN0b3JlSW1wbCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbigpIG5lZWRzIHRvIGJlIGNhbGxlZCB0byBoYW5kbGUgYSB0YXJnZXQgZm9yIGNvbnRyb2xsZWQgZXZlbnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSkgewogICAgICAgICAgICB2YXIgX3Byb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgICByZXN0b3JlSW1wbChpbnRlcm5hbEluc3RhbmNlLnN0YXRlTm9kZSwgaW50ZXJuYWxJbnN0YW5jZS50eXBlLCBfcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24oaW1wbCkgewogICAgICAgICAgcmVzdG9yZUltcGwgPSBpbXBsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCkgewogICAgICAgICAgaWYgKHJlc3RvcmVUYXJnZXQpIHsKICAgICAgICAgICAgaWYgKHJlc3RvcmVRdWV1ZSkgewogICAgICAgICAgICAgIHJlc3RvcmVRdWV1ZS5wdXNoKHRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlID0gW3RhcmdldF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3RvcmVUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5lZWRzU3RhdGVSZXN0b3JlKCkgewogICAgICAgICAgcmV0dXJuIHJlc3RvcmVUYXJnZXQgIT09IG51bGwgfHwgcmVzdG9yZVF1ZXVlICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVJZk5lZWRlZCgpIHsKICAgICAgICAgIGlmICghcmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gcmVzdG9yZVRhcmdldDsKICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXRzID0gcmVzdG9yZVF1ZXVlOwogICAgICAgICAgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgICByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KTsKICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXRzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVkVGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHF1ZXVlZFRhcmdldHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiYXRjaGVkVXBkYXRlc0ltcGwgPSBmdW5jdGlvbihmbiwgYm9va2tlZXBpbmcpIHsKICAgICAgICAgIHJldHVybiBmbihib29ra2VlcGluZyk7CiAgICAgICAgfTsKICAgICAgICB2YXIgZmx1c2hTeW5jSW1wbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgdmFyIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluaXNoRXZlbnRIYW5kbGVyKCkgewogICAgICAgICAgdmFyIGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzID0gbmVlZHNTdGF0ZVJlc3RvcmUoKTsKICAgICAgICAgIGlmIChjb250cm9sbGVkQ29tcG9uZW50c0hhdmVQZW5kaW5nVXBkYXRlcykgewogICAgICAgICAgICBmbHVzaFN5bmNJbXBsKCk7CiAgICAgICAgICAgIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhdGNoZWRVcGRhdGVzKGZuLCBhMiwgYikgewogICAgICAgICAgaWYgKGlzSW5zaWRlRXZlbnRIYW5kbGVyKSB7CiAgICAgICAgICAgIHJldHVybiBmbihhMiwgYik7CiAgICAgICAgICB9CiAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IHRydWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gYmF0Y2hlZFVwZGF0ZXNJbXBsKGZuLCBhMiwgYik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgICAgICBmaW5pc2hFdmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihfYmF0Y2hlZFVwZGF0ZXNJbXBsLCBfZGlzY3JldGVVcGRhdGVzSW1wbCwgX2ZsdXNoU3luY0ltcGwpIHsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzSW1wbCA9IF9iYXRjaGVkVXBkYXRlc0ltcGw7CiAgICAgICAgICBmbHVzaFN5bmNJbXBsID0gX2ZsdXNoU3luY0ltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW50ZXJhY3RpdmUodGFnKSB7CiAgICAgICAgICByZXR1cm4gdGFnID09PSAiYnV0dG9uIiB8fCB0YWcgPT09ICJpbnB1dCIgfHwgdGFnID09PSAic2VsZWN0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KG5hbWUsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgY2FzZSAib25DbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZURvd24iOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93bkNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlTW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcCI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcENhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRW50ZXIiOgogICAgICAgICAgICAgIHJldHVybiAhIShwcm9wcy5kaXNhYmxlZCAmJiBpc0ludGVyYWN0aXZlKHR5cGUpKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChzdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICBpZiAocHJvcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gcHJvcHNbcmVnaXN0cmF0aW9uTmFtZV07CiAgICAgICAgICBpZiAoc2hvdWxkUHJldmVudE1vdXNlRXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgaW5zdC50eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXIyICYmIHR5cGVvZiBsaXN0ZW5lcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBgIiArIHJlZ2lzdHJhdGlvbk5hbWUgKyAiYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAiICsgdHlwZW9mIGxpc3RlbmVyMiArICJgIHR5cGUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdGlvbnMsICJwYXNzaXZlIiwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZChuYW1lLCBmdW5jLCBjb250ZXh0LCBhMiwgYiwgYzIsIGQsIGUsIGYpIHsKICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kOwogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRpc3BhdGNoRXZlbnQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRXZlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZha2VOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicmVhY3QiKTsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCA9IGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja0RldihuYW1lLCBmdW5jLCBjb250ZXh0LCBhMiwgYiwgYzIsIGQsIGUsIGYpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiB8fCBkb2N1bWVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYGRvY3VtZW50YCBnbG9iYWwgd2FzIGRlZmluZWQgd2hlbiBSZWFjdCB3YXMgaW5pdGlhbGl6ZWQsIGJ1dCBpcyBub3QgZGVmaW5lZCBhbnltb3JlLiBUaGlzIGNhbiBoYXBwZW4gaW4gYSB0ZXN0IGVudmlyb25tZW50IGlmIGEgY29tcG9uZW50IHNjaGVkdWxlcyBhbiB1cGRhdGUgZnJvbSBhbiBhc3luY2hyb25vdXMgY2FsbGJhY2ssIGJ1dCB0aGUgdGVzdCBoYXMgYWxyZWFkeSBmaW5pc2hlZCBydW5uaW5nLiBUbyBzb2x2ZSB0aGlzLCB5b3UgY2FuIGVpdGhlciB1bm1vdW50IHRoZSBjb21wb25lbnQgYXQgdGhlIGVuZCBvZiB5b3VyIHRlc3QgKGFuZCBlbnN1cmUgdGhhdCBhbnkgYXN5bmNocm9ub3VzIG9wZXJhdGlvbnMgZ2V0IGNhbmNlbGVkIGluIGBjb21wb25lbnRXaWxsVW5tb3VudGApLCBvciB5b3UgY2FuIGNoYW5nZSB0aGUgdGVzdCBpdHNlbGYgdG8gYmUgYXN5bmNocm9ub3VzLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkV2ZW50Iik7CiAgICAgICAgICAgICAgdmFyIGRpZENhbGwgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgZGlkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIHZhciB3aW5kb3dFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgICAgICB2YXIgd2luZG93RXZlbnREZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih3aW5kb3csICJldmVudCIpOwogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVBZnRlckRpc3BhdGNoKCkgewogICAgICAgICAgICAgICAgZmFrZU5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2syLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5ldmVudCAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93Lmhhc093blByb3BlcnR5KCJldmVudCIpKSB7CiAgICAgICAgICAgICAgICAgIHdpbmRvdy5ldmVudCA9IHdpbmRvd0V2ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwogICAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjazIoKSB7CiAgICAgICAgICAgICAgICBkaWRDYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgICAgICAgIGRpZEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBlcnJvcjI7CiAgICAgICAgICAgICAgdmFyIGRpZFNldEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIGlzQ3Jvc3NPcmlnaW5FcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVdpbmRvd0Vycm9yKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBldmVudC5lcnJvcjsKICAgICAgICAgICAgICAgIGRpZFNldEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChlcnJvcjIgPT09IG51bGwgJiYgZXZlbnQuY29sbm8gPT09IDAgJiYgZXZlbnQubGluZW5vID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGlzQ3Jvc3NPcmlnaW5FcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICBpZiAoZXJyb3IyICE9IG51bGwgJiYgdHlwZW9mIGVycm9yMiA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IyLl9zdXBwcmVzc0xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGlubmVyKSB7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBldnRUeXBlID0gInJlYWN0LSIgKyAobmFtZSA/IG5hbWUgOiAiaW52b2tlZ3VhcmRlZGNhbGxiYWNrIik7CiAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgaGFuZGxlV2luZG93RXJyb3IpOwogICAgICAgICAgICAgIGZha2VOb2RlLmFkZEV2ZW50TGlzdGVuZXIoZXZ0VHlwZSwgY2FsbENhbGxiYWNrMiwgZmFsc2UpOwogICAgICAgICAgICAgIGV2dC5pbml0RXZlbnQoZXZ0VHlwZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICBmYWtlTm9kZS5kaXNwYXRjaEV2ZW50KGV2dCk7CiAgICAgICAgICAgICAgaWYgKHdpbmRvd0V2ZW50RGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdywgImV2ZW50Iiwgd2luZG93RXZlbnREZXNjcmlwdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRpZENhbGwgJiYgZGlkRXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkU2V0RXJyb3IpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKGBBbiBlcnJvciB3YXMgdGhyb3duIGluc2lkZSBvbmUgb2YgeW91ciBjb21wb25lbnRzLCBidXQgUmVhY3QgZG9lc24ndCBrbm93IHdoYXQgaXQgd2FzLiBUaGlzIGlzIGxpa2VseSBkdWUgdG8gYnJvd3NlciBmbGFraW5lc3MuIFJlYWN0IGRvZXMgaXRzIGJlc3QgdG8gcHJlc2VydmUgdGhlICJQYXVzZSBvbiBleGNlcHRpb25zIiBiZWhhdmlvciBvZiB0aGUgRGV2VG9vbHMsIHdoaWNoIHJlcXVpcmVzIHNvbWUgREVWLW1vZGUgb25seSB0cmlja3MuIEl0J3MgcG9zc2libGUgdGhhdCB0aGVzZSBkb24ndCB3b3JrIGluIHlvdXIgYnJvd3Nlci4gVHJ5IHRyaWdnZXJpbmcgdGhlIGVycm9yIGluIHByb2R1Y3Rpb24gbW9kZSwgb3Igc3dpdGNoaW5nIHRvIGEgbW9kZXJuIGJyb3dzZXIuIElmIHlvdSBzdXNwZWN0IHRoYXQgdGhpcyBpcyBhY3R1YWxseSBhbiBpc3N1ZSB3aXRoIFJlYWN0LCBwbGVhc2UgZmlsZSBhbiBpc3N1ZS5gKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDcm9zc09yaWdpbkVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcigiQSBjcm9zcy1vcmlnaW4gZXJyb3Igd2FzIHRocm93bi4gUmVhY3QgZG9lc24ndCBoYXZlIGFjY2VzcyB0byB0aGUgYWN0dWFsIGVycm9yIG9iamVjdCBpbiBkZXZlbG9wbWVudC4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jcm9zc29yaWdpbi1lcnJvciBmb3IgbW9yZSBpbmZvcm1hdGlvbi4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMub25FcnJvcihlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBoYW5kbGVXaW5kb3dFcnJvcik7CiAgICAgICAgICAgICAgaWYgKCFkaWRDYWxsKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGludm9rZUd1YXJkZWRDYWxsYmFja1Byb2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsJDEgPSBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsOwogICAgICAgIHZhciBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBjYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIGhhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciByZXRocm93RXJyb3IgPSBudWxsOwogICAgICAgIHZhciByZXBvcnRlciA9IHsKICAgICAgICAgIG9uRXJyb3I6IGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICBoYXNFcnJvciA9IHRydWU7CiAgICAgICAgICAgIGNhdWdodEVycm9yID0gZXJyb3IyOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEyLCBiLCBjMiwgZCwgZSwgZikgewogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMS5hcHBseShyZXBvcnRlciwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEyLCBiLCBjMiwgZCwgZSwgZikgewogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpIHsKICAgICAgICAgICAgdmFyIGVycm9yMiA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgaWYgKCFoYXNSZXRocm93RXJyb3IpIHsKICAgICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIHJldGhyb3dFcnJvciA9IGVycm9yMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRocm93Q2F1Z2h0RXJyb3IoKSB7CiAgICAgICAgICBpZiAoaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSByZXRocm93RXJyb3I7CiAgICAgICAgICAgIGhhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgICAgICByZXRocm93RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc0NhdWdodEVycm9yKCkgewogICAgICAgICAgcmV0dXJuIGhhc0Vycm9yOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhckNhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjYXVnaHRFcnJvcjsKICAgICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gZXJyb3IyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjbGVhckNhdWdodEVycm9yIHdhcyBjYWxsZWQgYnV0IG5vIGVycm9yIHdhcyBjYXB0dXJlZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0NyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXMzKGtleSkgewogICAgICAgICAgcmV0dXJuIGtleS5fcmVhY3RJbnRlcm5hbHMgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0MyhrZXksIHZhbHVlKSB7CiAgICAgICAgICBrZXkuX3JlYWN0SW50ZXJuYWxzID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBOb0ZsYWdzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBQZXJmb3JtZWRXb3JrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQbGFjZW1lbnQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBVcGRhdGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBDaGlsZERlbGV0aW9uID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgQ29udGVudFJlc2V0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMgogICAgICAgICk7CiAgICAgICAgdmFyIENhbGxiYWNrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBEaWRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIEZvcmNlQ2xpZW50UmVuZGVyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAqLwogICAgICAgICAgMjU2CiAgICAgICAgKTsKICAgICAgICB2YXIgUmVmMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTEyCiAgICAgICAgKTsKICAgICAgICB2YXIgU25hcHNob3QgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgUGFzc2l2ZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyMDQ4CiAgICAgICAgKTsKICAgICAgICB2YXIgSHlkcmF0aW5nID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MDk2CiAgICAgICAgKTsKICAgICAgICB2YXIgVmlzaWJpbGl0eSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4MTkyCiAgICAgICAgKTsKICAgICAgICB2YXIgU3RvcmVDb25zaXN0ZW5jeSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICAxNjM4NAogICAgICAgICk7CiAgICAgICAgdmFyIExpZmVjeWNsZUVmZmVjdE1hc2sgPSBQYXNzaXZlIHwgVXBkYXRlIHwgQ2FsbGJhY2sgfCBSZWYyIHwgU25hcHNob3QgfCBTdG9yZUNvbnNpc3RlbmN5OwogICAgICAgIHZhciBIb3N0RWZmZWN0TWFzayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyNzY3CiAgICAgICAgKTsKICAgICAgICB2YXIgSW5jb21wbGV0ZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2OAogICAgICAgICk7CiAgICAgICAgdmFyIFNob3VsZENhcHR1cmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjU1MzYKICAgICAgICApOwogICAgICAgIHZhciBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlID0gKAogICAgICAgICAgLyogKi8KICAgICAgICAgIDEzMTA3MgogICAgICAgICk7CiAgICAgICAgdmFyIEZvcmtlZCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA0ODU3NgogICAgICAgICk7CiAgICAgICAgdmFyIFJlZlN0YXRpYyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA5NzE1MgogICAgICAgICk7CiAgICAgICAgdmFyIExheW91dFN0YXRpYyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDMwNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmVTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODM4ODYwOAogICAgICAgICk7CiAgICAgICAgdmFyIE1vdW50TGF5b3V0RGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMTY3NzcyMTYKICAgICAgICApOwogICAgICAgIHZhciBNb3VudFBhc3NpdmVEZXYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgQmVmb3JlTXV0YXRpb25NYXNrID0gKAogICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIFVwZGF0ZSBmbGFnIGZyb20gYmVmb3JlIG11dGF0aW9uIHBoYXNlIGJ5IHJlLWxhbmRpbmcgVmlzaWJpbGl0eQogICAgICAgICAgLy8gZmxhZyBsb2dpYyAoc2VlICMyMDA0MykKICAgICAgICAgIFVwZGF0ZSB8IFNuYXBzaG90IHwgMAogICAgICAgICk7CiAgICAgICAgdmFyIE11dGF0aW9uTWFzayA9IFBsYWNlbWVudCB8IFVwZGF0ZSB8IENoaWxkRGVsZXRpb24gfCBDb250ZW50UmVzZXQgfCBSZWYyIHwgSHlkcmF0aW5nIHwgVmlzaWJpbGl0eTsKICAgICAgICB2YXIgTGF5b3V0TWFzayA9IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmMiB8IFZpc2liaWxpdHk7CiAgICAgICAgdmFyIFBhc3NpdmVNYXNrID0gUGFzc2l2ZSB8IENoaWxkRGVsZXRpb247CiAgICAgICAgdmFyIFN0YXRpY01hc2sgPSBMYXlvdXRTdGF0aWMgfCBQYXNzaXZlU3RhdGljIHwgUmVmU3RhdGljOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIGZ1bmN0aW9uIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBmaWJlcjsKICAgICAgICAgIGlmICghZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICAgICAgaWYgKChub2RlLmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBuZWFyZXN0TW91bnRlZCA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChuZXh0Tm9kZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGlsZSAobm9kZS5yZXR1cm4pIHsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgcmV0dXJuIG5lYXJlc3RNb3VudGVkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZVN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBIb3N0Um9vdCA/IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGaWJlck1vdW50ZWQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTW91bnRlZChjb21wb25lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG93bmVyID0gUmVhY3RDdXJyZW50T3duZXIuY3VycmVudDsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIG93bmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXJGaWJlciA9IG93bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmICghaW5zdGFuY2UuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgYWNjZXNzaW5nIGlzTW91bnRlZCBpbnNpZGUgaXRzIHJlbmRlcigpIGZ1bmN0aW9uLiByZW5kZXIoKSBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZS4gSXQgc2hvdWxkIG5ldmVyIGFjY2VzcyBzb21ldGhpbmcgdGhhdCByZXF1aXJlcyBzdGFsZSBkYXRhIGZyb20gdGhlIHByZXZpb3VzIHJlbmRlciwgc3VjaCBhcyByZWZzLiBNb3ZlIHRoaXMgbG9naWMgdG8gY29tcG9uZW50RGlkTW91bnQgYW5kIGNvbXBvbmVudERpZFVwZGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXJGaWJlcikgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGdldDcoY29tcG9uZW50KTsKICAgICAgICAgIGlmICghZmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpID09PSBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXNzZXJ0SXNNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudEZpYmVyVXNpbmdTbG93UGF0aChmaWJlcikgewogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmICghYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGEyID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYTIucmV0dXJuOwogICAgICAgICAgICBpZiAocGFyZW50QSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwYXJlbnRCID0gcGFyZW50QS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChwYXJlbnRCID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRQYXJlbnQgPSBwYXJlbnRBLnJldHVybjsKICAgICAgICAgICAgICBpZiAobmV4dFBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYTIgPSBiID0gbmV4dFBhcmVudDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyZW50QS5jaGlsZCA9PT0gcGFyZW50Qi5jaGlsZCkgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudEEuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT09IGEyKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEyLnJldHVybiAhPT0gYi5yZXR1cm4pIHsKICAgICAgICAgICAgICBhMiA9IHBhcmVudEE7CiAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGRpZEZpbmRDaGlsZCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBfY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQpIHsKICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEyKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEyID0gcGFyZW50QTsKICAgICAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYikgewogICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QTsKICAgICAgICAgICAgICAgICAgYTIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRpZEZpbmRDaGlsZCkgewogICAgICAgICAgICAgICAgX2NoaWxkID0gcGFyZW50Qi5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYTIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEyID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgICBiID0gcGFyZW50QTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkRmluZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgICBhMiA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWRpZEZpbmRDaGlsZCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNoaWxkIHdhcyBub3QgZm91bmQgaW4gZWl0aGVyIHBhcmVudCBzZXQuIFRoaXMgaW5kaWNhdGVzIGEgYnVnIGluIFJlYWN0IHJlbGF0ZWQgdG8gdGhlIHJldHVybiBwb2ludGVyLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEyLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYTIudGFnICE9PSBIb3N0Um9vdCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhMi5zdGF0ZU5vZGUuY3VycmVudCA9PT0gYTIpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvb2sgPSBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgICAgICAgICBpZiAoaG9vay5pc0Rpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFob29rLnN1cHBvcnRzRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayB3aXRoIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgUmVhY3QuIFBsZWFzZSB1cGRhdGUgUmVhY3QgRGV2VG9vbHMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgIGludGVybmFscyA9IGFzc2lnbjIoe30sIGludGVybmFscywgewogICAgICAgICAgICAgICAgZ2V0TGFuZUxhYmVsTWFwLAogICAgICAgICAgICAgICAgaW5qZWN0UHJvZmlsaW5nSG9va3MKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJlcklEID0gaG9vay5pbmplY3QoaW50ZXJuYWxzKTsKICAgICAgICAgICAgaW5qZWN0ZWRIb29rID0gaG9vazsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMuIiwgZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhvb2suY2hlY2tEQ0UpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uU2NoZWR1bGVSb290KHJvb3QzLCBjaGlsZHJlbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25TY2hlZHVsZUZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25TY2hlZHVsZUZpYmVyUm9vdChyZW5kZXJlcklELCByb290MywgY2hpbGRyZW4pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290KHJvb3QzLCBldmVudFByaW9yaXR5KSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgZGlkRXJyb3IgPSAocm9vdDMuY3VycmVudC5mbGFncyAmIERpZENhcHR1cmUpID09PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyKSB7CiAgICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgSWRsZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgc2NoZWR1bGVyUHJpb3JpdHksIGRpZEVycm9yKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCB2b2lkIDAsIGRpZEVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uUG9zdENvbW1pdFJvb3Qocm9vdDMpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Qb3N0Q29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRVbm1vdW50KGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclVubW91bnQocmVuZGVyZXJJRCwgZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhuZXdJc1N0cmljdE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB1bnN0YWJsZV95aWVsZFZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICBzZXRTdXBwcmVzc1dhcm5pbmcobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZShyZW5kZXJlcklELCBuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmplY3RQcm9maWxpbmdIb29rcyhwcm9maWxpbmdIb29rcykgewogICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcyA9IHByb2ZpbGluZ0hvb2tzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMYW5lTGFiZWxNYXAoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxOwogICAgICAgICAgICBmb3IgKHZhciBpbmRleDIgPSAwOyBpbmRleDIgPCBUb3RhbExhbmVzOyBpbmRleDIrKykgewogICAgICAgICAgICAgIHZhciBsYWJlbCA9IGdldExhYmVsRm9yTGFuZShsYW5lKTsKICAgICAgICAgICAgICBtYXAzLnNldChsYW5lLCBsYWJlbCk7CiAgICAgICAgICAgICAgbGFuZSAqPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXAzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0U3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50RXJyb3JlZChmaWJlciwgdGhyb3duVmFsdWUsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRFcnJvcmVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50RXJyb3JlZChmaWJlciwgdGhyb3duVmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZChmaWJlciwgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJZaWVsZGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyWWllbGRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclNjaGVkdWxlZChsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb01vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIENvbmN1cnJlbnRNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUHJvZmlsZU1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBTdHJpY3RMZWdhY3lNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIFN0cmljdEVmZmVjdHNNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIGNsejMyID0gTWF0aC5jbHozMiA/IE1hdGguY2x6MzIgOiBjbHozMkZhbGxiYWNrOwogICAgICAgIHZhciBsb2cyID0gTWF0aC5sb2c7CiAgICAgICAgdmFyIExOMiA9IE1hdGguTE4yOwogICAgICAgIGZ1bmN0aW9uIGNsejMyRmFsbGJhY2soeDIpIHsKICAgICAgICAgIHZhciBhc1VpbnQgPSB4MiA+Pj4gMDsKICAgICAgICAgIGlmIChhc1VpbnQgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIDMyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDMxIC0gKGxvZzIoYXNVaW50KSAvIExOMiB8IDApIHwgMDsKICAgICAgICB9CiAgICAgICAgdmFyIFRvdGFsTGFuZXMgPSAzMTsKICAgICAgICB2YXIgTm9MYW5lcyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBOb0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBTeW5jTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0SHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0TGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQyNDAKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA2NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwMjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyMDQ4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU3ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lOCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgxOTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjM4NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTAgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyNzY4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjU1MzYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjIxNDQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MjQyODgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE1ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDQ4NTc2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA5NzE1MgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMwMDIzNDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDMwNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjc3NzIxNgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjcxMDg4NjQKICAgICAgICApOwogICAgICAgIHZhciBTb21lUmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICB2YXIgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICovCiAgICAgICAgICAxMzQyMTc3MjgKICAgICAgICApOwogICAgICAgIHZhciBOb25JZGxlTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NQogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMjY4NDM1NDU2CiAgICAgICAgKTsKICAgICAgICB2YXIgSWRsZUxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MzY4NzA5MTIKICAgICAgICApOwogICAgICAgIHZhciBPZmZzY3JlZW5MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNzM3NDE4MjQKICAgICAgICApOwogICAgICAgIGZ1bmN0aW9uIGdldExhYmVsRm9yTGFuZShsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChsYW5lICYgU3luY0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlN5bmMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSW5wdXRDb250aW51b3VzSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91cyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0SHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdEh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0TGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiVHJhbnNpdGlvbkh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgUmV0cnlMYW5lcykgewogICAgICAgICAgICAgIHJldHVybiAiUmV0cnkiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiU2VsZWN0aXZlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVIeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIk9mZnNjcmVlbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vVGltZXN0YW1wID0gLTE7CiAgICAgICAgdmFyIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICB2YXIgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykpIHsKICAgICAgICAgICAgY2FzZSBTeW5jTGFuZToKICAgICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgICAgICBjYXNlIERlZmF1bHRIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdExhbmU7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTg6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTA6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTY6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzOwogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICByZXR1cm4gbGFuZXMgJiBSZXRyeUxhbmVzOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlTGFuZTsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5MYW5lOgogICAgICAgICAgICAgIHJldHVybiBPZmZzY3JlZW5MYW5lOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0TGFuZXMocm9vdDMsIHdpcExhbmVzKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHBlbmRpbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBub25JZGxlUGVuZGluZ0xhbmVzID0gcGVuZGluZ0xhbmVzICYgTm9uSWRsZUxhbmVzOwogICAgICAgICAgaWYgKG5vbklkbGVQZW5kaW5nTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIG5vbklkbGVVbmJsb2NrZWRMYW5lcyA9IG5vbklkbGVQZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmIChub25JZGxlVW5ibG9ja2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0TGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhub25JZGxlVW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBub25JZGxlUGluZ2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgICAgICAgaWYgKG5vbklkbGVQaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB1bmJsb2NrZWRMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgICAgaWYgKHVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXModW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChwaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocGluZ2VkTGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3aXBMYW5lcyAhPT0gTm9MYW5lcyAmJiB3aXBMYW5lcyAhPT0gbmV4dExhbmVzICYmIC8vIElmIHdlIGFscmVhZHkgc3VzcGVuZGVkIHdpdGggYSBkZWxheSwgdGhlbiBpbnRlcnJ1cHRpbmcgaXMgZmluZS4gRG9uJ3QKICAgICAgICAgIC8vIGJvdGhlciB3YWl0aW5nIHVudGlsIHRoZSByb290IGlzIGNvbXBsZXRlLgogICAgICAgICAgKHdpcExhbmVzICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBuZXh0TGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgICAgdmFyIHdpcExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKHdpcExhbmVzKTsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIFRlc3RzIHdoZXRoZXIgdGhlIG5leHQgbGFuZSBpcyBlcXVhbCBvciBsb3dlciBwcmlvcml0eSB0aGFuIHRoZSB3aXAKICAgICAgICAgICAgICAvLyBvbmUuIFRoaXMgd29ya3MgYmVjYXVzZSB0aGUgYml0cyBkZWNyZWFzZSBpbiBwcmlvcml0eSBhcyB5b3UgZ28gbGVmdC4KICAgICAgICAgICAgICBuZXh0TGFuZSA+PSB3aXBMYW5lIHx8IC8vIERlZmF1bHQgcHJpb3JpdHkgdXBkYXRlcyBzaG91bGQgbm90IGludGVycnVwdCB0cmFuc2l0aW9uIHVwZGF0ZXMuIFRoZQogICAgICAgICAgICAgIC8vIG9ubHkgZGlmZmVyZW5jZSBiZXR3ZWVuIGRlZmF1bHQgdXBkYXRlcyBhbmQgdHJhbnNpdGlvbiB1cGRhdGVzIGlzIHRoYXQKICAgICAgICAgICAgICAvLyBkZWZhdWx0IHVwZGF0ZXMgZG8gbm90IHN1cHBvcnQgcmVmcmVzaCB0cmFuc2l0aW9ucy4KICAgICAgICAgICAgICBuZXh0TGFuZSA9PT0gRGVmYXVsdExhbmUgJiYgKHdpcExhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHJldHVybiB3aXBMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKChuZXh0TGFuZXMgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0TGFuZXMgfD0gcGVuZGluZ0xhbmVzICYgRGVmYXVsdExhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW50YW5nbGVkTGFuZXMgPSByb290My5lbnRhbmdsZWRMYW5lczsKICAgICAgICAgIGlmIChlbnRhbmdsZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICAgIHZhciBsYW5lcyA9IG5leHRMYW5lcyAmIGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgICAgbmV4dExhbmVzIHw9IGVudGFuZ2xlbWVudHNbaW5kZXgyXTsKICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IGV2ZW50VGltZXNbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKGV2ZW50VGltZSA+IG1vc3RSZWNlbnRFdmVudFRpbWUpIHsKICAgICAgICAgICAgICBtb3N0UmVjZW50RXZlbnRUaW1lID0gZXZlbnRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vc3RSZWNlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSkgewogICAgICAgICAgc3dpdGNoIChsYW5lKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDI1MDsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDVlMzsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXJyb3IoIlNob3VsZCBoYXZlIGZvdW5kIG1hdGNoaW5nIGxhbmVzLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChleHBpcmF0aW9uVGltZSA9PT0gTm9UaW1lc3RhbXApIHsKICAgICAgICAgICAgICBpZiAoKGxhbmUgJiBzdXNwZW5kZWRMYW5lcykgPT09IE5vTGFuZXMgfHwgKGxhbmUgJiBwaW5nZWRMYW5lcykgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gY29tcHV0ZUV4cGlyYXRpb25UaW1lKGxhbmUsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwaXJhdGlvblRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICByb290My5leHBpcmVkTGFuZXMgfD0gbGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZXNUb1JldHJ5U3luY2hyb25vdXNseU9uRXJyb3Iocm9vdDMpIHsKICAgICAgICAgIHZhciBldmVyeXRoaW5nQnV0T2Zmc2NyZWVuID0gcm9vdDMucGVuZGluZ0xhbmVzICYgfk9mZnNjcmVlbkxhbmU7CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gZXZlcnl0aGluZ0J1dE9mZnNjcmVlbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChldmVyeXRoaW5nQnV0T2Zmc2NyZWVuICYgT2Zmc2NyZWVuTGFuZSkgewogICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1N5bmNMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0xhbmUpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc05vbklkbGVXb3JrKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgTm9uSWRsZUxhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFJldHJ5TGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHZhciBVcmdlbnRMYW5lcyA9IFN5bmNMYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRMYW5lOwogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFVyZ2VudExhbmVzKSA9PT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgU3luY0RlZmF1bHRMYW5lcyA9IElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUgfCBJbnB1dENvbnRpbnVvdXNMYW5lIHwgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBTeW5jRGVmYXVsdExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNFeHBpcmVkTGFuZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiByb290My5leHBpcmVkTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RyYW5zaXRpb25MYW5lKGxhbmUpIHsKICAgICAgICAgIHJldHVybiAobGFuZSAmIFRyYW5zaXRpb25MYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCkgewogICAgICAgICAgdmFyIGxhbmUgPSBuZXh0VHJhbnNpdGlvbkxhbmU7CiAgICAgICAgICBuZXh0VHJhbnNpdGlvbkxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRUcmFuc2l0aW9uTGFuZSAmIFRyYW5zaXRpb25MYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lID0gVHJhbnNpdGlvbkxhbmUxOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFJldHJ5TGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFJldHJ5TGFuZTsKICAgICAgICAgIG5leHRSZXRyeUxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRSZXRyeUxhbmUgJiBSZXRyeUxhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0UmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gbGFuZXMgJiAtbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAzMSAtIGNsejMyKGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGFuZVRvSW5kZXgobGFuZSkgewogICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzU29tZUxhbmUoYTIsIGIpIHsKICAgICAgICAgIHJldHVybiAoYTIgJiBiKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdWJzZXRPZkxhbmVzKHNldDQsIHN1YnNldCkgewogICAgICAgICAgcmV0dXJuIChzZXQ0ICYgc3Vic2V0KSA9PT0gc3Vic2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtZXJnZUxhbmVzKGEyLCBiKSB7CiAgICAgICAgICByZXR1cm4gYTIgfCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVMYW5lcyhzZXQ0LCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiBzZXQ0ICYgfnN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0TGFuZXMoYTIsIGIpIHsKICAgICAgICAgIHJldHVybiBhMiAmIGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0xhbmVzKGxhbmUpIHsKICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJQcmlvcml0eUxhbmUoYTIsIGIpIHsKICAgICAgICAgIHJldHVybiBhMiAhPT0gTm9MYW5lICYmIGEyIDwgYiA/IGEyIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTGFuZU1hcChpbml0aWFsKSB7CiAgICAgICAgICB2YXIgbGFuZU1hcCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBUb3RhbExhbmVzOyBpKyspIHsKICAgICAgICAgICAgbGFuZU1hcC5wdXNoKGluaXRpYWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmVNYXA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290VXBkYXRlZChyb290MywgdXBkYXRlTGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgfD0gdXBkYXRlTGFuZTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBJZGxlTGFuZSkgewogICAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleCh1cGRhdGVMYW5lKTsKICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IGV2ZW50VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyB8PSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzICY9IH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzIHw9IHJvb3QzLnN1c3BlbmRlZExhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKSB7CiAgICAgICAgICB2YXIgbm9Mb25nZXJQZW5kaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXMgJiB+cmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLmV4cGlyZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLm11dGFibGVSZWFkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5lbnRhbmdsZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBub0xvbmdlclBlbmRpbmdMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4Ml0gPSBOb0xhbmVzOwogICAgICAgICAgICBldmVudFRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBlbnRhbmdsZWRMYW5lcykgewogICAgICAgICAgdmFyIHJvb3RFbnRhbmdsZWRMYW5lcyA9IHJvb3QzLmVudGFuZ2xlZExhbmVzIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdEVudGFuZ2xlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIElzIHRoaXMgb25lIG9mIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgbGFuZSAmIGVudGFuZ2xlZExhbmVzIHwgLy8gSXMgdGhpcyBsYW5lIHRyYW5zaXRpdmVseSBlbnRhbmdsZWQgd2l0aCB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSAmIGVudGFuZ2xlZExhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSB8PSBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcmVuZGVyTGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBsYW5lOwogICAgICAgICAgc3dpdGNoIChyZW5kZXJMYW5lKSB7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICBsYW5lID0gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICBsYW5lID0gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgbGFuZSA9IFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYW5lID0gTm9MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChsYW5lICYgKHJvb3QzLnN1c3BlbmRlZExhbmVzIHwgcmVuZGVyTGFuZXMyKSkgIT09IE5vTGFuZSkgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICB1cGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKCFpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHJvb3QzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXA7CiAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciB1cGRhdGVycyA9IHBlbmRpbmdVcGRhdGVyc0xhbmVNYXBbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKHVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgfHwgIW1lbW9pemVkVXBkYXRlcnMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyYW5zaXRpb25zRm9yTGFuZXMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRGlzY3JldGVFdmVudFByaW9yaXR5ID0gU3luY0xhbmU7CiAgICAgICAgdmFyIENvbnRpbnVvdXNFdmVudFByaW9yaXR5ID0gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICB2YXIgRGVmYXVsdEV2ZW50UHJpb3JpdHkgPSBEZWZhdWx0TGFuZTsKICAgICAgICB2YXIgSWRsZUV2ZW50UHJpb3JpdHkgPSBJZGxlTGFuZTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShuZXdQcmlvcml0eSkgewogICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gbmV3UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bldpdGhQcmlvcml0eShwcmlvcml0eSwgZm4pIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gY3VycmVudFVwZGF0ZVByaW9yaXR5OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJpb3JpdHk7CiAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJldmlvdXNQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyRXZlbnRQcmlvcml0eShhMiwgYikgewogICAgICAgICAgcmV0dXJuIGEyICE9PSAwICYmIGEyIDwgYiA/IGEyIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbG93ZXJFdmVudFByaW9yaXR5KGEyLCBiKSB7CiAgICAgICAgICByZXR1cm4gYTIgPT09IDAgfHwgYTIgPiBiID8gYTIgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hpZ2hlckV2ZW50UHJpb3JpdHkoYTIsIGIpIHsKICAgICAgICAgIHJldHVybiBhMiAhPT0gMCAmJiBhMiA8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVzVG9FdmVudFByaW9yaXR5KGxhbmVzKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHksIGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc05vbklkbGVXb3JrKGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSb290RGVoeWRyYXRlZChyb290MykgewogICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IHJvb3QzLmN1cnJlbnQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBjdXJyZW50U3RhdGUuaXNEZWh5ZHJhdGVkOwogICAgICAgIH0KICAgICAgICB2YXIgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZm4pIHsKICAgICAgICAgIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uOwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5OwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMTsKICAgICAgICBmdW5jdGlvbiBzZXRHZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkgPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICB2YXIgcXVldWVkRGlzY3JldGVFdmVudHMgPSBbXTsKICAgICAgICB2YXIgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cyA9IFtdOwogICAgICAgIHZhciBkaXNjcmV0ZVJlcGxheWFibGVFdmVudHMgPSBbCiAgICAgICAgICAibW91c2Vkb3duIiwKICAgICAgICAgICJtb3VzZXVwIiwKICAgICAgICAgICJ0b3VjaGNhbmNlbCIsCiAgICAgICAgICAidG91Y2hlbmQiLAogICAgICAgICAgInRvdWNoc3RhcnQiLAogICAgICAgICAgImF1eGNsaWNrIiwKICAgICAgICAgICJkYmxjbGljayIsCiAgICAgICAgICAicG9pbnRlcmNhbmNlbCIsCiAgICAgICAgICAicG9pbnRlcmRvd24iLAogICAgICAgICAgInBvaW50ZXJ1cCIsCiAgICAgICAgICAiZHJhZ2VuZCIsCiAgICAgICAgICAiZHJhZ3N0YXJ0IiwKICAgICAgICAgICJkcm9wIiwKICAgICAgICAgICJjb21wb3NpdGlvbmVuZCIsCiAgICAgICAgICAiY29tcG9zaXRpb25zdGFydCIsCiAgICAgICAgICAia2V5ZG93biIsCiAgICAgICAgICAia2V5cHJlc3MiLAogICAgICAgICAgImtleXVwIiwKICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAidGV4dElucHV0IiwKICAgICAgICAgIC8vIEludGVudGlvbmFsbHkgY2FtZWxDYXNlCiAgICAgICAgICAiY29weSIsCiAgICAgICAgICAiY3V0IiwKICAgICAgICAgICJwYXN0ZSIsCiAgICAgICAgICAiY2xpY2siLAogICAgICAgICAgImNoYW5nZSIsCiAgICAgICAgICAiY29udGV4dG1lbnUiLAogICAgICAgICAgInJlc2V0IiwKICAgICAgICAgICJzdWJtaXQiCiAgICAgICAgXTsKICAgICAgICBmdW5jdGlvbiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZXZlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzLmluZGV4T2YoZXZlbnRUeXBlKSA+IC0xOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJsb2NrZWRPbiwKICAgICAgICAgICAgZG9tRXZlbnROYW1lLAogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzLAogICAgICAgICAgICBuYXRpdmVFdmVudCwKICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVyczogW3RhcmdldENvbnRhaW5lcl0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmRlbGV0ZShwb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5kZWxldGUoX3BvaW50ZXJJZCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChleGlzdGluZ1F1ZXVlZEV2ZW50LCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGV4aXN0aW5nUXVldWVkRXZlbnQgPT09IG51bGwgfHwgZXhpc3RpbmdRdWV1ZWRFdmVudC5uYXRpdmVFdmVudCAhPT0gbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZmliZXIyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHF1ZXVlZEV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgZXhpc3RpbmdRdWV1ZWRFdmVudC5ldmVudFN5c3RlbUZsYWdzIHw9IGV2ZW50U3lzdGVtRmxhZ3M7CiAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVycyA9IGV4aXN0aW5nUXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIGlmICh0YXJnZXRDb250YWluZXIgIT09IG51bGwgJiYgdGFyZ2V0Q29udGFpbmVycy5pbmRleE9mKHRhcmdldENvbnRhaW5lcikgPT09IC0xKSB7CiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnMucHVzaCh0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXN0aW5nUXVldWVkRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSWZDb250aW51b3VzRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOiB7CiAgICAgICAgICAgICAgdmFyIGZvY3VzRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRm9jdXMsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGZvY3VzRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6IHsKICAgICAgICAgICAgICB2YXIgZHJhZ0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRHJhZywgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgZHJhZ0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIG1vdXNlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkTW91c2UsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG1vdXNlRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjogewogICAgICAgICAgICAgIHZhciBwb2ludGVyRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5zZXQocG9pbnRlcklkLCBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZFBvaW50ZXJzLmdldChwb2ludGVySWQpIHx8IG51bGwsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIHBvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIF9wb2ludGVySWQyID0gX3BvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLnNldChfcG9pbnRlcklkMiwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZ2V0KF9wb2ludGVySWQyKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBfcG9pbnRlckV2ZW50KSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShxdWV1ZWRUYXJnZXQudGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocXVldWVkVGFyZ2V0LnByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcXVldWVFeHBsaWNpdEh5ZHJhdGlvblRhcmdldCh0YXJnZXQpIHsKICAgICAgICAgIHZhciB1cGRhdGVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxKCk7CiAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0ID0gewogICAgICAgICAgICBibG9ja2VkT246IG51bGwsCiAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgcHJpb3JpdHk6IHVwZGF0ZVByaW9yaXR5CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkodXBkYXRlUHJpb3JpdHksIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tpXS5wcmlvcml0eSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNwbGljZShpLCAwLCBxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgaWYgKGkgPT09IDApIHsKICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRXZlbnQpIHsKICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBxdWV1ZWRFdmVudC50YXJnZXRDb250YWluZXJzOwogICAgICAgICAgd2hpbGUgKHRhcmdldENvbnRhaW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyc1swXTsKICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KHF1ZXVlZEV2ZW50LmRvbUV2ZW50TmFtZSwgcXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBxdWV1ZWRFdmVudC5uYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gcXVldWVkRXZlbnQubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRDbG9uZSA9IG5ldyBuYXRpdmVFdmVudC5jb25zdHJ1Y3RvcihuYXRpdmVFdmVudC50eXBlLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgICBzZXRSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnRhcmdldC5kaXNwYXRjaEV2ZW50KG5hdGl2ZUV2ZW50Q2xvbmUpOwogICAgICAgICAgICAgICAgcmVzZXRSZXBsYXlpbmdFdmVudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMyA9IGdldEluc3RhbmNlRnJvbU5vZGUobmV4dEJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKF9maWJlcjMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKF9maWJlcjMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnNoaWZ0KCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKHF1ZXVlZEV2ZW50LCBrZXksIG1hcDMpIHsKICAgICAgICAgIGlmIChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSkgewogICAgICAgICAgICBtYXAzLmRlbGV0ZShrZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXBsYXlVbmJsb2NrZWRFdmVudHMoKSB7CiAgICAgICAgICBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRGb2N1cykpIHsKICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWREcmFnKSkgewogICAgICAgICAgICBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRNb3VzZSAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZE1vdXNlKSkgewogICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRQb2ludGVycy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZm9yRWFjaChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50SW5NYXApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQsIHVuYmxvY2tlZCkgewogICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCkgewogICAgICAgICAgICAgIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSB0cnVlOwogICAgICAgICAgICAgIFNjaGVkdWxlci51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrKFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSwgcmVwbGF5VW5ibG9ja2VkRXZlbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeUlmQmxvY2tlZE9uKHVuYmxvY2tlZCkgewogICAgICAgICAgaWYgKHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZERpc2NyZXRlRXZlbnRzWzBdLCB1bmJsb2NrZWQpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gcXVldWVkRGlzY3JldGVFdmVudHNbaV07CiAgICAgICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZEZvY3VzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRGb2N1cywgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWREcmFnICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWREcmFnLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZE1vdXNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRNb3VzZSwgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1bmJsb2NrID0gZnVuY3Rpb24ocXVldWVkRXZlbnQyKSB7CiAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQyLCB1bmJsb2NrZWQpOwogICAgICAgICAgfTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmZvckVhY2godW5ibG9jayk7CiAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbX2ldOwogICAgICAgICAgICBpZiAocXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgbmV4dEV4cGxpY2l0VGFyZ2V0ID0gcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzWzBdOwogICAgICAgICAgICBpZiAobmV4dEV4cGxpY2l0VGFyZ2V0LmJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChuZXh0RXhwbGljaXRUYXJnZXQpOwogICAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMuc2hpZnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIF9lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBzZXRFbmFibGVkKGVuYWJsZWQpIHsKICAgICAgICAgIF9lbmFibGVkID0gISFlbmFibGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0VuYWJsZWQoKSB7CiAgICAgICAgICByZXR1cm4gX2VuYWJsZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgZXZlbnRQcmlvcml0eSA9IGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIHZhciBsaXN0ZW5lcldyYXBwZXI7CiAgICAgICAgICBzd2l0Y2ggKGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hEaXNjcmV0ZUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoQ29udGludW91c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJXcmFwcGVyLmJpbmQobnVsbCwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaERpc2NyZXRlRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAoIV9lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudFdpdGhFbmFibGVDYXB0dXJlUGhhc2VTZWxlY3RpdmVIeWRyYXRpb25XaXRob3V0RGlzY3JldGVFdmVudFJlcGxheShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGJsb2NrZWRPbiA9IGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIGlmIChibG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVJZkNvbnRpbnVvdXNFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgbmF0aXZlRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICBpZiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UgJiYgaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgd2hpbGUgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgcmV0dXJuX3RhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBibG9ja2VkT24pIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICBuYXRpdmVFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgbnVsbCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJldHVybl90YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50VGFyZ2V0ID0gZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpOwogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobmVhcmVzdE1vdW50ZWQgIT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJjbGljayI6CiAgICAgICAgICAgIGNhc2UgImNsb3NlIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJjb3B5IjoKICAgICAgICAgICAgY2FzZSAiY3V0IjoKICAgICAgICAgICAgY2FzZSAiYXV4Y2xpY2siOgogICAgICAgICAgICBjYXNlICJkYmxjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICBjYXNlICJkcmFnc3RhcnQiOgogICAgICAgICAgICBjYXNlICJkcm9wIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJpbnZhbGlkIjoKICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICBjYXNlICJwYXVzZSI6CiAgICAgICAgICAgIGNhc2UgInBsYXkiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICBjYXNlICJyYXRlY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAicmVzZXQiOgogICAgICAgICAgICBjYXNlICJyZXNpemUiOgogICAgICAgICAgICBjYXNlICJzZWVrZWQiOgogICAgICAgICAgICBjYXNlICJzdWJtaXQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICAgIGNhc2UgInZvbHVtZWNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgImNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdGlvbmNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInRleHRJbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImFmdGVyYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWlucHV0IjoKICAgICAgICAgICAgY2FzZSAiYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImZ1bGxzY3JlZW5jaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJmb2N1cyI6CiAgICAgICAgICAgIGNhc2UgImhhc2hjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJwb3BzdGF0ZSI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdHN0YXJ0IjoKICAgICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICBjYXNlICJkcmFnIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJzY3JvbGwiOgogICAgICAgICAgICBjYXNlICJ0b2dnbGUiOgogICAgICAgICAgICBjYXNlICJ0b3VjaG1vdmUiOgogICAgICAgICAgICBjYXNlICJ3aGVlbCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZW50ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZWxlYXZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmVudGVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmxlYXZlIjoKICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIGNhc2UgIm1lc3NhZ2UiOiB7CiAgICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5ID0gZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHNjaGVkdWxlclByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcjIpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcih0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBwYXNzaXZlKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgewogICAgICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMiwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHsKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcm9vdDIgPSBudWxsOwogICAgICAgIHZhciBzdGFydFRleHQgPSBudWxsOwogICAgICAgIHZhciBmYWxsYmFja1RleHQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemUobmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHJvb3QyID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICBzdGFydFRleHQgPSBnZXRUZXh0KCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgICByb290MiA9IG51bGw7CiAgICAgICAgICBzdGFydFRleHQgPSBudWxsOwogICAgICAgICAgZmFsbGJhY2tUZXh0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGF0YSgpIHsKICAgICAgICAgIGlmIChmYWxsYmFja1RleHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrVGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydDsKICAgICAgICAgIHZhciBzdGFydFZhbHVlID0gc3RhcnRUZXh0OwogICAgICAgICAgdmFyIHN0YXJ0TGVuZ3RoID0gc3RhcnRWYWx1ZS5sZW5ndGg7CiAgICAgICAgICB2YXIgZW5kOwogICAgICAgICAgdmFyIGVuZFZhbHVlID0gZ2V0VGV4dCgpOwogICAgICAgICAgdmFyIGVuZExlbmd0aCA9IGVuZFZhbHVlLmxlbmd0aDsKICAgICAgICAgIGZvciAoc3RhcnQgPSAwOyBzdGFydCA8IHN0YXJ0TGVuZ3RoOyBzdGFydCsrKSB7CiAgICAgICAgICAgIGlmIChzdGFydFZhbHVlW3N0YXJ0XSAhPT0gZW5kVmFsdWVbc3RhcnRdKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBtaW5FbmQgPSBzdGFydExlbmd0aCAtIHN0YXJ0OwogICAgICAgICAgZm9yIChlbmQgPSAxOyBlbmQgPD0gbWluRW5kOyBlbmQrKykgewogICAgICAgICAgICBpZiAoc3RhcnRWYWx1ZVtzdGFydExlbmd0aCAtIGVuZF0gIT09IGVuZFZhbHVlW2VuZExlbmd0aCAtIGVuZF0pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHNsaWNlVGFpbCA9IGVuZCA+IDEgPyAxIC0gZW5kIDogdm9pZCAwOwogICAgICAgICAgZmFsbGJhY2tUZXh0ID0gZW5kVmFsdWUuc2xpY2Uoc3RhcnQsIHNsaWNlVGFpbCk7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tUZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUZXh0KCkgewogICAgICAgICAgaWYgKCJ2YWx1ZSIgaW4gcm9vdDIpIHsKICAgICAgICAgICAgcmV0dXJuIHJvb3QyLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3QyLnRleHRDb250ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgY2hhckNvZGU7CiAgICAgICAgICB2YXIga2V5Q29kZSA9IG5hdGl2ZUV2ZW50LmtleUNvZGU7CiAgICAgICAgICBpZiAoImNoYXJDb2RlIiBpbiBuYXRpdmVFdmVudCkgewogICAgICAgICAgICBjaGFyQ29kZSA9IG5hdGl2ZUV2ZW50LmNoYXJDb2RlOwogICAgICAgICAgICBpZiAoY2hhckNvZGUgPT09IDAgJiYga2V5Q29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgICBjaGFyQ29kZSA9IDEzOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGFyQ29kZSA9IGtleUNvZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhckNvZGUgPT09IDEwKSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhckNvZGUgPj0gMzIgfHwgY2hhckNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFyQ29kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZSgpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2UoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEludGVyZmFjZSkgewogICAgICAgICAgZnVuY3Rpb24gU3ludGhldGljQmFzZUV2ZW50KHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgICB0aGlzLl9yZWFjdE5hbWUgPSByZWFjdE5hbWU7CiAgICAgICAgICAgIHRoaXMuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0aGlzLnR5cGUgPSByZWFjdEV2ZW50VHlwZTsKICAgICAgICAgICAgdGhpcy5uYXRpdmVFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgICB0aGlzLmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgICAgICBmb3IgKHZhciBfcHJvcE5hbWUgaW4gSW50ZXJmYWNlKSB7CiAgICAgICAgICAgICAgaWYgKCFJbnRlcmZhY2UuaGFzT3duUHJvcGVydHkoX3Byb3BOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBub3JtYWxpemUyID0gSW50ZXJmYWNlW19wcm9wTmFtZV07CiAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZTIpIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5vcm1hbGl6ZTIobmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzW19wcm9wTmFtZV0gPSBuYXRpdmVFdmVudFtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVmYXVsdFByZXZlbnRlZCA9IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgIT0gbnVsbCA/IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgOiBuYXRpdmVFdmVudC5yZXR1cm5WYWx1ZSA9PT0gZmFsc2U7CiAgICAgICAgICAgIGlmIChkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2lnbjIoU3ludGhldGljQmFzZUV2ZW50LnByb3RvdHlwZSwgewogICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIGlmICghZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlICE9PSAidW5rbm93biIpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LmNhbmNlbEJ1YmJsZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBXZSByZWxlYXNlIGFsbCBkaXNwYXRjaGVkIGBTeW50aGV0aWNFdmVudGBzIGFmdGVyIGVhY2ggZXZlbnQgbG9vcCwgYWRkaW5nCiAgICAgICAgICAgICAqIHRoZW0gYmFjayBpbnRvIHRoZSBwb29sLiBUaGlzIGFsbG93cyBhIHdheSB0byBob2xkIG9udG8gYSByZWZlcmVuY2UgdGhhdAogICAgICAgICAgICAgKiB3b24ndCBiZSBhZGRlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwZXJzaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENoZWNrcyBpZiB0aGlzIGV2ZW50IHNob3VsZCBiZSByZWxlYXNlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBzaG91bGQgbm90IGJlIHJlbGVhc2VkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc1BlcnNpc3RlbnQ6IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBTeW50aGV0aWNCYXNlRXZlbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBFdmVudEludGVyZmFjZSA9IHsKICAgICAgICAgIGV2ZW50UGhhc2U6IDAsCiAgICAgICAgICBidWJibGVzOiAwLAogICAgICAgICAgY2FuY2VsYWJsZTogMCwKICAgICAgICAgIHRpbWVTdGFtcDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRpbWVTdGFtcCB8fCBEYXRlLm5vdygpOwogICAgICAgICAgfSwKICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IDAsCiAgICAgICAgICBpc1RydXN0ZWQ6IDAKICAgICAgICB9OwogICAgICAgIHZhciBTeW50aGV0aWNFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgVUlFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB2aWV3OiAwLAogICAgICAgICAgZGV0YWlsOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1VJRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChVSUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WDsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WTsKICAgICAgICB2YXIgbGFzdE1vdXNlRXZlbnQ7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudCAhPT0gbGFzdE1vdXNlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW1vdmUiKSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IGV2ZW50LnNjcmVlblggLSBsYXN0TW91c2VFdmVudC5zY3JlZW5YOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSBldmVudC5zY3JlZW5ZIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gMDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0TW91c2VFdmVudCA9IGV2ZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTW91c2VFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHNjcmVlblg6IDAsCiAgICAgICAgICBzY3JlZW5ZOiAwLAogICAgICAgICAgY2xpZW50WDogMCwKICAgICAgICAgIGNsaWVudFk6IDAsCiAgICAgICAgICBwYWdlWDogMCwKICAgICAgICAgIHBhZ2VZOiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgIGJ1dHRvbjogMCwKICAgICAgICAgIGJ1dHRvbnM6IDAsCiAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQucmVsYXRlZFRhcmdldCA9PT0gdm9pZCAwKSByZXR1cm4gZXZlbnQuZnJvbUVsZW1lbnQgPT09IGV2ZW50LnNyY0VsZW1lbnQgPyBldmVudC50b0VsZW1lbnQgOiBldmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICB9LAogICAgICAgICAgbW92ZW1lbnRYOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoIm1vdmVtZW50WCIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQubW92ZW1lbnRYOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZU1vdXNlTW92ZW1lbnRQb2x5ZmlsbFN0YXRlKGV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFg7CiAgICAgICAgICB9LAogICAgICAgICAgbW92ZW1lbnRZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoIm1vdmVtZW50WSIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQubW92ZW1lbnRZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsYXN0TW92ZW1lbnRZOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNNb3VzZUV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoTW91c2VFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIERyYWdFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGFUcmFuc2ZlcjogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNEcmFnRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChEcmFnRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBGb2N1c0V2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcmVsYXRlZFRhcmdldDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNGb2N1c0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRm9jdXNFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGFuaW1hdGlvbk5hbWU6IDAsCiAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgIHBzZXVkb0VsZW1lbnQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQW5pbWF0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChBbmltYXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIENsaXBib2FyZEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGNsaXBib2FyZERhdGE6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiY2xpcGJvYXJkRGF0YSIgaW4gZXZlbnQgPyBldmVudC5jbGlwYm9hcmREYXRhIDogd2luZG93LmNsaXBib2FyZERhdGE7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0NsaXBib2FyZEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBDb21wb3NpdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGE6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQ29tcG9zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBTeW50aGV0aWNJbnB1dEV2ZW50ID0gU3ludGhldGljQ29tcG9zaXRpb25FdmVudDsKICAgICAgICB2YXIgbm9ybWFsaXplS2V5ID0gewogICAgICAgICAgRXNjOiAiRXNjYXBlIiwKICAgICAgICAgIFNwYWNlYmFyOiAiICIsCiAgICAgICAgICBMZWZ0OiAiQXJyb3dMZWZ0IiwKICAgICAgICAgIFVwOiAiQXJyb3dVcCIsCiAgICAgICAgICBSaWdodDogIkFycm93UmlnaHQiLAogICAgICAgICAgRG93bjogIkFycm93RG93biIsCiAgICAgICAgICBEZWw6ICJEZWxldGUiLAogICAgICAgICAgV2luOiAiT1MiLAogICAgICAgICAgTWVudTogIkNvbnRleHRNZW51IiwKICAgICAgICAgIEFwcHM6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBTY3JvbGw6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgIE1velByaW50YWJsZUtleTogIlVuaWRlbnRpZmllZCIKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc2xhdGVUb0tleSA9IHsKICAgICAgICAgICI4IjogIkJhY2tzcGFjZSIsCiAgICAgICAgICAiOSI6ICJUYWIiLAogICAgICAgICAgIjEyIjogIkNsZWFyIiwKICAgICAgICAgICIxMyI6ICJFbnRlciIsCiAgICAgICAgICAiMTYiOiAiU2hpZnQiLAogICAgICAgICAgIjE3IjogIkNvbnRyb2wiLAogICAgICAgICAgIjE4IjogIkFsdCIsCiAgICAgICAgICAiMTkiOiAiUGF1c2UiLAogICAgICAgICAgIjIwIjogIkNhcHNMb2NrIiwKICAgICAgICAgICIyNyI6ICJFc2NhcGUiLAogICAgICAgICAgIjMyIjogIiAiLAogICAgICAgICAgIjMzIjogIlBhZ2VVcCIsCiAgICAgICAgICAiMzQiOiAiUGFnZURvd24iLAogICAgICAgICAgIjM1IjogIkVuZCIsCiAgICAgICAgICAiMzYiOiAiSG9tZSIsCiAgICAgICAgICAiMzciOiAiQXJyb3dMZWZ0IiwKICAgICAgICAgICIzOCI6ICJBcnJvd1VwIiwKICAgICAgICAgICIzOSI6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgICI0MCI6ICJBcnJvd0Rvd24iLAogICAgICAgICAgIjQ1IjogIkluc2VydCIsCiAgICAgICAgICAiNDYiOiAiRGVsZXRlIiwKICAgICAgICAgICIxMTIiOiAiRjEiLAogICAgICAgICAgIjExMyI6ICJGMiIsCiAgICAgICAgICAiMTE0IjogIkYzIiwKICAgICAgICAgICIxMTUiOiAiRjQiLAogICAgICAgICAgIjExNiI6ICJGNSIsCiAgICAgICAgICAiMTE3IjogIkY2IiwKICAgICAgICAgICIxMTgiOiAiRjciLAogICAgICAgICAgIjExOSI6ICJGOCIsCiAgICAgICAgICAiMTIwIjogIkY5IiwKICAgICAgICAgICIxMjEiOiAiRjEwIiwKICAgICAgICAgICIxMjIiOiAiRjExIiwKICAgICAgICAgICIxMjMiOiAiRjEyIiwKICAgICAgICAgICIxNDQiOiAiTnVtTG9jayIsCiAgICAgICAgICAiMTQ1IjogIlNjcm9sbExvY2siLAogICAgICAgICAgIjIyNCI6ICJNZXRhIgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRLZXkobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5rZXkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5vcm1hbGl6ZUtleVtuYXRpdmVFdmVudC5rZXldIHx8IG5hdGl2ZUV2ZW50LmtleTsKICAgICAgICAgICAgaWYgKGtleSAhPT0gIlVuaWRlbnRpZmllZCIpIHsKICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlID09PSAxMyA/ICJFbnRlciIgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5ZG93biIgfHwgbmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICByZXR1cm4gdHJhbnNsYXRlVG9LZXlbbmF0aXZlRXZlbnQua2V5Q29kZV0gfHwgIlVuaWRlbnRpZmllZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBtb2RpZmllcktleVRvUHJvcCA9IHsKICAgICAgICAgIEFsdDogImFsdEtleSIsCiAgICAgICAgICBDb250cm9sOiAiY3RybEtleSIsCiAgICAgICAgICBNZXRhOiAibWV0YUtleSIsCiAgICAgICAgICBTaGlmdDogInNoaWZ0S2V5IgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW9kaWZpZXJTdGF0ZUdldHRlcihrZXlBcmcpIHsKICAgICAgICAgIHZhciBzeW50aGV0aWNFdmVudCA9IHRoaXM7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBzeW50aGV0aWNFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKGtleUFyZyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5UHJvcCA9IG1vZGlmaWVyS2V5VG9Qcm9wW2tleUFyZ107CiAgICAgICAgICByZXR1cm4ga2V5UHJvcCA/ICEhbmF0aXZlRXZlbnRba2V5UHJvcF0gOiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRNb2RpZmllclN0YXRlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbW9kaWZpZXJTdGF0ZUdldHRlcjsKICAgICAgICB9CiAgICAgICAgdmFyIEtleWJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBrZXk6IGdldEV2ZW50S2V5LAogICAgICAgICAgY29kZTogMCwKICAgICAgICAgIGxvY2F0aW9uOiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIHJlcGVhdDogMCwKICAgICAgICAgIGxvY2FsZTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgIC8vIExlZ2FjeSBJbnRlcmZhY2UKICAgICAgICAgIGNoYXJDb2RlOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0sCiAgICAgICAgICBrZXlDb2RlOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0sCiAgICAgICAgICB3aGljaDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRDaGFyQ29kZShldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBldmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0tleWJvYXJkRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChLZXlib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgUG9pbnRlckV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgTW91c2VFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcG9pbnRlcklkOiAwLAogICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICBoZWlnaHQ6IDAsCiAgICAgICAgICBwcmVzc3VyZTogMCwKICAgICAgICAgIHRhbmdlbnRpYWxQcmVzc3VyZTogMCwKICAgICAgICAgIHRpbHRYOiAwLAogICAgICAgICAgdGlsdFk6IDAsCiAgICAgICAgICB0d2lzdDogMCwKICAgICAgICAgIHBvaW50ZXJUeXBlOiAwLAogICAgICAgICAgaXNQcmltYXJ5OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1BvaW50ZXJFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFBvaW50ZXJFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRvdWNoRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB0b3VjaGVzOiAwLAogICAgICAgICAgdGFyZ2V0VG91Y2hlczogMCwKICAgICAgICAgIGNoYW5nZWRUb3VjaGVzOiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUb3VjaEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVG91Y2hFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBwcm9wZXJ0eU5hbWU6IDAsCiAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgIHBzZXVkb0VsZW1lbnQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljVHJhbnNpdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVHJhbnNpdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgV2hlZWxFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRlbHRhWDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICJkZWx0YVgiIGluIGV2ZW50ID8gZXZlbnQuZGVsdGFYIDogKAogICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhWGAgZm9yIFdlYmtpdCBhbmQgbm9ybWFsaXplIChyaWdodCBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFYIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWCA6IDAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFZIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWSA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVlgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFZIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWSA6ICgKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhYCBmb3IgSUU8OSBhbmQgbm9ybWFsaXplIChkb3duIGlzIHBvc2l0aXZlKS4KICAgICAgICAgICAgICAgICJ3aGVlbERlbHRhIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhIDogMAogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVo6IDAsCiAgICAgICAgICAvLyBCcm93c2VycyB3aXRob3V0ICJkZWx0YU1vZGUiIGlzIHJlcG9ydGluZyBpbiByYXcgd2hlZWwgZGVsdGEgd2hlcmUgb25lCiAgICAgICAgICAvLyBub3RjaCBvbiB0aGUgc2Nyb2xsIGlzIGFsd2F5cyArLy0gMTIwLCByb3VnaGx5IGVxdWl2YWxlbnQgdG8gcGl4ZWxzLgogICAgICAgICAgLy8gQSBnb29kIGFwcHJveGltYXRpb24gb2YgRE9NX0RFTFRBX0xJTkUgKDEpIGlzIDUlIG9mIHZpZXdwb3J0IHNpemUgb3IKICAgICAgICAgIC8vIH40MCBwaXhlbHMsIGZvciBET01fREVMVEFfU0NSRUVOICgyKSBpdCBpcyA4Ny41JSBvZiB2aWV3cG9ydCBzaXplLgogICAgICAgICAgZGVsdGFNb2RlOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1doZWVsRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChXaGVlbEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRU5EX0tFWUNPREVTID0gWzksIDEzLCAyNywgMzJdOwogICAgICAgIHZhciBTVEFSVF9LRVlDT0RFID0gMjI5OwogICAgICAgIHZhciBjYW5Vc2VDb21wb3NpdGlvbkV2ZW50ID0gY2FuVXNlRE9NMiAmJiAiQ29tcG9zaXRpb25FdmVudCIgaW4gd2luZG93OwogICAgICAgIHZhciBkb2N1bWVudE1vZGUgPSBudWxsOwogICAgICAgIGlmIChjYW5Vc2VET00yICYmICJkb2N1bWVudE1vZGUiIGluIGRvY3VtZW50KSB7CiAgICAgICAgICBkb2N1bWVudE1vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VUZXh0SW5wdXRFdmVudCA9IGNhblVzZURPTTIgJiYgIlRleHRFdmVudCIgaW4gd2luZG93ICYmICFkb2N1bWVudE1vZGU7CiAgICAgICAgdmFyIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhID0gY2FuVXNlRE9NMiAmJiAoIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgfHwgZG9jdW1lbnRNb2RlICYmIGRvY3VtZW50TW9kZSA+IDggJiYgZG9jdW1lbnRNb2RlIDw9IDExKTsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ09ERSA9IDMyOwogICAgICAgIHZhciBTUEFDRUJBUl9DSEFSID0gU3RyaW5nLmZyb21DaGFyQ29kZShTUEFDRUJBUl9DT0RFKTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cygpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25CZWZvcmVJbnB1dCIsIFsiY29tcG9zaXRpb25lbmQiLCAia2V5cHJlc3MiLCAidGV4dElucHV0IiwgInBhc3RlIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uRW5kIiwgWyJjb21wb3NpdGlvbmVuZCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblN0YXJ0IiwgWyJjb21wb3NpdGlvbnN0YXJ0IiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgWyJjb21wb3NpdGlvbnVwZGF0ZSIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NwYWNlS2V5cHJlc3MgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIChuYXRpdmVFdmVudC5jdHJsS2V5IHx8IG5hdGl2ZUV2ZW50LmFsdEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5KSAmJiAvLyBjdHJsS2V5ICYmIGFsdEtleSBpcyBlcXVpdmFsZW50IHRvIEFsdEdyLCBhbmQgaXMgbm90IGEgY29tbWFuZC4KICAgICAgICAgICEobmF0aXZlRXZlbnQuY3RybEtleSAmJiBuYXRpdmVFdmVudC5hbHRLZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25VcGRhdGUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIgJiYgbmF0aXZlRXZlbnQua2V5Q29kZSA9PT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICByZXR1cm4gRU5EX0tFWUNPREVTLmluZGV4T2YobmF0aXZlRXZlbnQua2V5Q29kZSkgIT09IC0xOwogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQua2V5Q29kZSAhPT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGV0YWlsID0gbmF0aXZlRXZlbnQuZGV0YWlsOwogICAgICAgICAgaWYgKHR5cGVvZiBkZXRhaWwgPT09ICJvYmplY3QiICYmICJkYXRhIiBpbiBkZXRhaWwpIHsKICAgICAgICAgICAgcmV0dXJuIGRldGFpbC5kYXRhOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5sb2NhbGUgPT09ICJrbyI7CiAgICAgICAgfQogICAgICAgIHZhciBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlOwogICAgICAgICAgdmFyIGZhbGxiYWNrRGF0YTsKICAgICAgICAgIGlmIChjYW5Vc2VDb21wb3NpdGlvbkV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCFpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudFR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGlmICghaXNDb21wb3NpbmcgJiYgZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvblN0YXJ0IikgewogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvbkVuZCIpIHsKICAgICAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrRGF0YSA9IGdldERhdGEoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgZXZlbnRUeXBlKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljQ29tcG9zaXRpb25FdmVudChldmVudFR5cGUsIGRvbUV2ZW50TmFtZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChmYWxsYmFja0RhdGEpIHsKICAgICAgICAgICAgICBldmVudC5kYXRhID0gZmFsbGJhY2tEYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjdXN0b21EYXRhID0gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1c3RvbURhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjdXN0b21EYXRhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICB2YXIgd2hpY2ggPSBuYXRpdmVFdmVudC53aGljaDsKICAgICAgICAgICAgICBpZiAod2hpY2ggIT09IFNQQUNFQkFSX0NPREUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoYXNTcGFjZUtleXByZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gU1BBQ0VCQVJfQ0hBUjsKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICAgIGlmIChjaGFycyA9PT0gU1BBQ0VCQVJfQ0hBUiAmJiBoYXNTcGFjZUtleXByZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjb21wb3NpdGlvbmVuZCIgfHwgIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgJiYgaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoIWlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmNoYXIgJiYgbmF0aXZlRXZlbnQuY2hhci5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5jaGFyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXRpdmVFdmVudC53aGljaCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShuYXRpdmVFdmVudC53aGljaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSA/IG51bGwgOiBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGNoYXJzOwogICAgICAgICAgaWYgKGNhblVzZVRleHRJbnB1dEV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFjaGFycykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgIm9uQmVmb3JlSW5wdXQiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljSW5wdXRFdmVudCgib25CZWZvcmVJbnB1dCIsICJiZWZvcmVpbnB1dCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBldmVudC5kYXRhID0gY2hhcnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIH0KICAgICAgICB2YXIgc3VwcG9ydGVkSW5wdXRUeXBlcyA9IHsKICAgICAgICAgIGNvbG9yOiB0cnVlLAogICAgICAgICAgZGF0ZTogdHJ1ZSwKICAgICAgICAgIGRhdGV0aW1lOiB0cnVlLAogICAgICAgICAgImRhdGV0aW1lLWxvY2FsIjogdHJ1ZSwKICAgICAgICAgIGVtYWlsOiB0cnVlLAogICAgICAgICAgbW9udGg6IHRydWUsCiAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICAgIHJhbmdlOiB0cnVlLAogICAgICAgICAgc2VhcmNoOiB0cnVlLAogICAgICAgICAgdGVsOiB0cnVlLAogICAgICAgICAgdGV4dDogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRydWUsCiAgICAgICAgICB1cmw6IHRydWUsCiAgICAgICAgICB3ZWVrOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpc1RleHRJbnB1dEVsZW1lbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewogICAgICAgICAgICByZXR1cm4gISFzdXBwb3J0ZWRJbnB1dFR5cGVzW2VsZW0udHlwZV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXZlbnRTdXBwb3J0ZWQoZXZlbnROYW1lU3VmZml4KSB7CiAgICAgICAgICBpZiAoIWNhblVzZURPTTIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TmFtZSA9ICJvbiIgKyBldmVudE5hbWVTdWZmaXg7CiAgICAgICAgICB2YXIgaXNTdXBwb3J0ZWQgPSBldmVudE5hbWUgaW4gZG9jdW1lbnQ7CiAgICAgICAgICBpZiAoIWlzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGV2ZW50TmFtZSwgInJldHVybjsiKTsKICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSB0eXBlb2YgZWxlbWVudFtldmVudE5hbWVdID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlzU3VwcG9ydGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cyQxKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNoYW5nZSIsIFsiY2hhbmdlIiwgImNsaWNrIiwgImZvY3VzaW4iLCAiZm9jdXNvdXQiLCAiaW5wdXQiLCAia2V5ZG93biIsICJrZXl1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgdGFyZ2V0KSB7CiAgICAgICAgICBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKGluc3QsICJvbkNoYW5nZSIpOwogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25DaGFuZ2UiLCAiY2hhbmdlIiwgbnVsbCwgbmF0aXZlRXZlbnQsIHRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYWN0aXZlRWxlbWVudCA9IG51bGw7CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDaGFuZ2VFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSA9PT0gInNlbGVjdCIgfHwgbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSAiZmlsZSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hbnVhbERpc3BhdGNoQ2hhbmdlRXZlbnQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgYWN0aXZlRWxlbWVudEluc3QsIG5hdGl2ZUV2ZW50LCBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkpOwogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMocnVuRXZlbnRJbkJhdGNoLCBkaXNwYXRjaFF1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcnVuRXZlbnRJbkJhdGNoKGRpc3BhdGNoUXVldWUpIHsKICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlKGRpc3BhdGNoUXVldWUsIDApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCkgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpOwogICAgICAgICAgaWYgKHVwZGF0ZVZhbHVlSWZDaGFuZ2VkKHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzSW5wdXRFdmVudFN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIGlmIChjYW5Vc2VET00yKSB7CiAgICAgICAgICBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBpc0V2ZW50U3VwcG9ydGVkKCJpbnB1dCIpICYmICghZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50LmRvY3VtZW50TW9kZSA+IDkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UodGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gdGFyZ2V0OwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgYWN0aXZlRWxlbWVudC5hdHRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKSB7CiAgICAgICAgICBpZiAoIWFjdGl2ZUVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYWN0aXZlRWxlbWVudC5kZXRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVQcm9wZXJ0eUNoYW5nZShuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnByb3BlcnR5TmFtZSAhPT0gInZhbHVlIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KSkgewogICAgICAgICAgICBtYW51YWxEaXNwYXRjaENoYW5nZUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXZlbnRzRm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNpbiIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgICAgc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3Vzb3V0IikgewogICAgICAgICAgICBzdG9wV2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInNlbGVjdGlvbmNoYW5nZSIgfHwgZG9tRXZlbnROYW1lID09PSAia2V5dXAiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleWRvd24iKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQoYWN0aXZlRWxlbWVudEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDbGlja0V2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAiY2hlY2tib3giIHx8IGVsZW0udHlwZSA9PT0gInJhZGlvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNsaWNrIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImlucHV0IiB8fCBkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIobm9kZSkgewogICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5fd3JhcHBlclN0YXRlOwogICAgICAgICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuY29udHJvbGxlZCB8fCBub2RlLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsICJudW1iZXIiLCBub2RlLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICB2YXIgZ2V0VGFyZ2V0SW5zdEZ1bmMsIGhhbmRsZUV2ZW50RnVuYzsKICAgICAgICAgIGlmIChzaG91bGRVc2VDaGFuZ2VFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGlmIChpc0lucHV0RXZlbnRTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JJbnB1dE9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsOwogICAgICAgICAgICAgIGhhbmRsZUV2ZW50RnVuYyA9IGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRVc2VDbGlja0V2ZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvckNsaWNrRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0VGFyZ2V0SW5zdEZ1bmMpIHsKICAgICAgICAgICAgdmFyIGluc3QgPSBnZXRUYXJnZXRJbnN0RnVuYyhkb21FdmVudE5hbWUsIHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhbmRsZUV2ZW50RnVuYykgewogICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXROb2RlLCB0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgaGFuZGxlQ29udHJvbGxlZElucHV0Qmx1cih0YXJnZXROb2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMigpIHsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VFbnRlciIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Nb3VzZUxlYXZlIiwgWyJtb3VzZW91dCIsICJtb3VzZW92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJFbnRlciIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uUG9pbnRlckxlYXZlIiwgWyJwb2ludGVyb3V0IiwgInBvaW50ZXJvdmVyIl0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIGlzT3ZlckV2ZW50ID0gZG9tRXZlbnROYW1lID09PSAibW91c2VvdmVyIiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciI7CiAgICAgICAgICB2YXIgaXNPdXRFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IjsKICAgICAgICAgIGlmIChpc092ZXJFdmVudCAmJiAhaXNSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgdmFyIHJlbGF0ZWQgPSBuYXRpdmVFdmVudC5yZWxhdGVkVGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICBpZiAocmVsYXRlZCkgewogICAgICAgICAgICAgIGlmIChnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShyZWxhdGVkKSB8fCBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChyZWxhdGVkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc091dEV2ZW50ICYmICFpc092ZXJFdmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2luOwogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgd2luID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZG9jID0gbmF0aXZlRXZlbnRUYXJnZXQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKGRvYykgewogICAgICAgICAgICAgIHdpbiA9IGRvYy5kZWZhdWx0VmlldyB8fCBkb2MucGFyZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdpbiA9IHdpbmRvdzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb20yOwogICAgICAgICAgdmFyIHRvMjsKICAgICAgICAgIGlmIChpc091dEV2ZW50KSB7CiAgICAgICAgICAgIHZhciBfcmVsYXRlZCA9IG5hdGl2ZUV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgbmF0aXZlRXZlbnQudG9FbGVtZW50OwogICAgICAgICAgICBmcm9tMiA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRvMiA9IF9yZWxhdGVkID8gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoX3JlbGF0ZWQpIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRvMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodG8yKTsKICAgICAgICAgICAgICBpZiAodG8yICE9PSBuZWFyZXN0TW91bnRlZCB8fCB0bzIudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHRvMi50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICB0bzIgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJvbTIgPSBudWxsOwogICAgICAgICAgICB0bzIgPSB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZyb20yID09PSB0bzIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICB2YXIgbGVhdmVFdmVudFR5cGUgPSAib25Nb3VzZUxlYXZlIjsKICAgICAgICAgIHZhciBlbnRlckV2ZW50VHlwZSA9ICJvbk1vdXNlRW50ZXIiOwogICAgICAgICAgdmFyIGV2ZW50VHlwZVByZWZpeCA9ICJtb3VzZSI7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiKSB7CiAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgbGVhdmVFdmVudFR5cGUgPSAib25Qb2ludGVyTGVhdmUiOwogICAgICAgICAgICBlbnRlckV2ZW50VHlwZSA9ICJvblBvaW50ZXJFbnRlciI7CiAgICAgICAgICAgIGV2ZW50VHlwZVByZWZpeCA9ICJwb2ludGVyIjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tTm9kZSA9IGZyb20yID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKGZyb20yKTsKICAgICAgICAgIHZhciB0b05vZGUgPSB0bzIgPT0gbnVsbCA/IHdpbiA6IGdldE5vZGVGcm9tSW5zdGFuY2UodG8yKTsKICAgICAgICAgIHZhciBsZWF2ZSA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IobGVhdmVFdmVudFR5cGUsIGV2ZW50VHlwZVByZWZpeCArICJsZWF2ZSIsIGZyb20yLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgbGVhdmUudGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICBsZWF2ZS5yZWxhdGVkVGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgdmFyIGVudGVyID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVUYXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG5hdGl2ZVRhcmdldEluc3QgPT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgdmFyIGVudGVyRXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGVudGVyRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAiZW50ZXIiLCB0bzIsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGVudGVyRXZlbnQudGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgICBlbnRlckV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBmcm9tTm9kZTsKICAgICAgICAgICAgZW50ZXIgPSBlbnRlckV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVUd29QaGFzZUxpc3RlbmVycyhkaXNwYXRjaFF1ZXVlLCBsZWF2ZSwgZW50ZXIsIGZyb20yLCB0bzIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICh4MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgICB9CiAgICAgICAgdmFyIG9iamVjdElzID0gdHlwZW9mIE9iamVjdC5pcyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5pcyA6IGlzNDsKICAgICAgICBmdW5jdGlvbiBzaGFsbG93RXF1YWwyKG9iakEsIG9iakIpIHsKICAgICAgICAgIGlmIChvYmplY3RJcyhvYmpBLCBvYmpCKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygb2JqQSAhPT0gIm9iamVjdCIgfHwgb2JqQSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqQiAhPT0gIm9iamVjdCIgfHwgb2JqQiA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhvYmpBKTsKICAgICAgICAgIHZhciBrZXlzQiA9IE9iamVjdC5rZXlzKG9iakIpOwogICAgICAgICAgaWYgKGtleXNBLmxlbmd0aCAhPT0ga2V5c0IubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5c0EubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRLZXkgPSBrZXlzQVtpXTsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iakIsIGN1cnJlbnRLZXkpIHx8ICFvYmplY3RJcyhvYmpBW2N1cnJlbnRLZXldLCBvYmpCW2N1cnJlbnRLZXldKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExlYWZOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlICYmIG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICBub2RlID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNpYmxpbmdOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZvckNoYXJhY3Rlck9mZnNldChyb290Mywgb2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGdldExlYWZOb2RlKHJvb3QzKTsKICAgICAgICAgIHZhciBub2RlU3RhcnQgPSAwOwogICAgICAgICAgdmFyIG5vZGVFbmQgPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIG5vZGVFbmQgPSBub2RlU3RhcnQgKyBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgICAgICBpZiAobm9kZVN0YXJ0IDw9IG9mZnNldCAmJiBub2RlRW5kID49IG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBvZmZzZXQgLSBub2RlU3RhcnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGVTdGFydCA9IG5vZGVFbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IGdldExlYWZOb2RlKGdldFNpYmxpbmdOb2RlKG5vZGUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T2Zmc2V0cyhvdXRlck5vZGUpIHsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gb3V0ZXJOb2RlLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gb3duZXJEb2N1bWVudCAmJiBvd25lckRvY3VtZW50LmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW4uZ2V0U2VsZWN0aW9uICYmIHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uIHx8IHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFuY2hvck5vZGUgPSBzZWxlY3Rpb24uYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0ID0gc2VsZWN0aW9uLmFuY2hvck9mZnNldCwgZm9jdXNOb2RlID0gc2VsZWN0aW9uLmZvY3VzTm9kZSwgZm9jdXNPZmZzZXQgPSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhbmNob3JOb2RlLm5vZGVUeXBlOwogICAgICAgICAgICBmb2N1c05vZGUubm9kZVR5cGU7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9kZXJuT2Zmc2V0c0Zyb21Qb2ludHMob3V0ZXJOb2RlLCBhbmNob3JOb2RlLCBhbmNob3JPZmZzZXQsIGZvY3VzTm9kZSwgZm9jdXNPZmZzZXQpIHsKICAgICAgICAgIHZhciBsZW5ndGggPSAwOwogICAgICAgICAgdmFyIHN0YXJ0ID0gLTE7CiAgICAgICAgICB2YXIgZW5kID0gLTE7CiAgICAgICAgICB2YXIgaW5kZXhXaXRoaW5BbmNob3IgPSAwOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluRm9jdXMgPSAwOwogICAgICAgICAgdmFyIG5vZGUgPSBvdXRlck5vZGU7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICBvdXRlcjogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgdmFyIG5leHQgPSBudWxsOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlID09PSBhbmNob3JOb2RlICYmIChhbmNob3JPZmZzZXQgPT09IDAgfHwgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGggKyBhbmNob3JPZmZzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmb2N1c05vZGUgJiYgKGZvY3VzT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIGVuZCA9IGxlbmd0aCArIGZvY3VzT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBsZW5ndGggKz0gbm9kZS5ub2RlVmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLmZpcnN0Q2hpbGQpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGFuY2hvck5vZGUgJiYgKytpbmRleFdpdGhpbkFuY2hvciA9PT0gYW5jaG9yT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IGxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGZvY3VzTm9kZSAmJiArK2luZGV4V2l0aGluRm9jdXMgPT09IGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgobmV4dCA9IG5vZGUubmV4dFNpYmxpbmcpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGFydCA9PT0gLTEgfHwgZW5kID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICBlbmQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldE9mZnNldHMobm9kZSwgb2Zmc2V0cykgewogICAgICAgICAgdmFyIGRvYyA9IG5vZGUub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgIHZhciB3aW4gPSBkb2MgJiYgZG9jLmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICghd2luLmdldFNlbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IG5vZGUudGV4dENvbnRlbnQubGVuZ3RoOwogICAgICAgICAgdmFyIHN0YXJ0ID0gTWF0aC5taW4ob2Zmc2V0cy5zdGFydCwgbGVuZ3RoKTsKICAgICAgICAgIHZhciBlbmQgPSBvZmZzZXRzLmVuZCA9PT0gdm9pZCAwID8gc3RhcnQgOiBNYXRoLm1pbihvZmZzZXRzLmVuZCwgbGVuZ3RoKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uLmV4dGVuZCAmJiBzdGFydCA+IGVuZCkgewogICAgICAgICAgICB2YXIgdGVtcCA9IGVuZDsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICAgIHN0YXJ0ID0gdGVtcDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgc3RhcnQpOwogICAgICAgICAgdmFyIGVuZE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgZW5kKTsKICAgICAgICAgIGlmIChzdGFydE1hcmtlciAmJiBlbmRNYXJrZXIpIHsKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAxICYmIHNlbGVjdGlvbi5hbmNob3JOb2RlID09PSBzdGFydE1hcmtlci5ub2RlICYmIHNlbGVjdGlvbi5hbmNob3JPZmZzZXQgPT09IHN0YXJ0TWFya2VyLm9mZnNldCAmJiBzZWxlY3Rpb24uZm9jdXNOb2RlID09PSBlbmRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uZm9jdXNPZmZzZXQgPT09IGVuZE1hcmtlci5vZmZzZXQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJhbmdlNCA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICByYW5nZTQuc2V0U3RhcnQoc3RhcnRNYXJrZXIubm9kZSwgc3RhcnRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgICAgICBpZiAoc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2U0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uZXh0ZW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByYW5nZTQuc2V0RW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2U0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RleHROb2RlKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlKSB7CiAgICAgICAgICBpZiAoIW91dGVyTm9kZSB8fCAhaW5uZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlID09PSBpbm5lck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dE5vZGUob3V0ZXJOb2RlKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dE5vZGUoaW5uZXJOb2RlKSkgewogICAgICAgICAgICByZXR1cm4gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlLnBhcmVudE5vZGUpOwogICAgICAgICAgfSBlbHNlIGlmICgiY29udGFpbnMiIGluIG91dGVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gb3V0ZXJOb2RlLmNvbnRhaW5zKGlubmVyTm9kZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG91dGVyTm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgewogICAgICAgICAgICByZXR1cm4gISEob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGlubmVyTm9kZSkgJiAxNik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW5Eb2N1bWVudChub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm93bmVyRG9jdW1lbnQgJiYgY29udGFpbnNOb2RlKG5vZGUub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NhbWVPcmlnaW5GcmFtZShpZnJhbWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgaWZyYW1lLmNvbnRlbnRXaW5kb3cubG9jYXRpb24uaHJlZiA9PT0gInN0cmluZyI7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50RGVlcCgpIHsKICAgICAgICAgIHZhciB3aW4gPSB3aW5kb3c7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGdldEFjdGl2ZUVsZW1lbnQoKTsKICAgICAgICAgIHdoaWxlIChlbGVtZW50IGluc3RhbmNlb2Ygd2luLkhUTUxJRnJhbWVFbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChpc1NhbWVPcmlnaW5GcmFtZShlbGVtZW50KSkgewogICAgICAgICAgICAgIHdpbiA9IGVsZW1lbnQuY29udGVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCh3aW4uZG9jdW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtICYmIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAidGV4dCIgfHwgZWxlbS50eXBlID09PSAic2VhcmNoIiB8fCBlbGVtLnR5cGUgPT09ICJ0ZWwiIHx8IGVsZW0udHlwZSA9PT0gInVybCIgfHwgZWxlbS50eXBlID09PSAicGFzc3dvcmQiKSB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiB8fCBlbGVtLmNvbnRlbnRFZGl0YWJsZSA9PT0gInRydWUiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uSW5mb3JtYXRpb24oKSB7CiAgICAgICAgICB2YXIgZm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZm9jdXNlZEVsZW0sCiAgICAgICAgICAgIHNlbGVjdGlvblJhbmdlOiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMoZm9jdXNlZEVsZW0pID8gZ2V0U2VsZWN0aW9uKGZvY3VzZWRFbGVtKSA6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTZWxlY3Rpb24ocHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbikgewogICAgICAgICAgdmFyIGN1ckZvY3VzZWRFbGVtID0gZ2V0QWN0aXZlRWxlbWVudERlZXAoKTsKICAgICAgICAgIHZhciBwcmlvckZvY3VzZWRFbGVtID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5mb2N1c2VkRWxlbTsKICAgICAgICAgIHZhciBwcmlvclNlbGVjdGlvblJhbmdlID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5zZWxlY3Rpb25SYW5nZTsKICAgICAgICAgIGlmIChjdXJGb2N1c2VkRWxlbSAhPT0gcHJpb3JGb2N1c2VkRWxlbSAmJiBpc0luRG9jdW1lbnQocHJpb3JGb2N1c2VkRWxlbSkpIHsKICAgICAgICAgICAgaWYgKHByaW9yU2VsZWN0aW9uUmFuZ2UgIT09IG51bGwgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKHByaW9yRm9jdXNlZEVsZW0pKSB7CiAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uKHByaW9yRm9jdXNlZEVsZW0sIHByaW9yU2VsZWN0aW9uUmFuZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvcnMgPSBbXTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9yID0gcHJpb3JGb2N1c2VkRWxlbTsKICAgICAgICAgICAgd2hpbGUgKGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIGlmIChhbmNlc3Rvci5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGFuY2VzdG9yLAogICAgICAgICAgICAgICAgICBsZWZ0OiBhbmNlc3Rvci5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgICB0b3A6IGFuY2VzdG9yLnNjcm9sbFRvcAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpb3JGb2N1c2VkRWxlbS5mb2N1cyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByaW9yRm9jdXNlZEVsZW0uZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFuY2VzdG9ycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBpbmZvID0gYW5jZXN0b3JzW2ldOwogICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxMZWZ0ID0gaW5mby5sZWZ0OwogICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxUb3AgPSBpbmZvLnRvcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24oaW5wdXQpIHsKICAgICAgICAgIHZhciBzZWxlY3Rpb247CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICBzZWxlY3Rpb24gPSB7CiAgICAgICAgICAgICAgc3RhcnQ6IGlucHV0LnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIGVuZDogaW5wdXQuc2VsZWN0aW9uRW5kCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxlY3Rpb24gPSBnZXRPZmZzZXRzKGlucHV0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24gfHwgewogICAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgICAgZW5kOiAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRTZWxlY3Rpb24oaW5wdXQsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBzdGFydCA9IG9mZnNldHMuc3RhcnQ7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQ7CiAgICAgICAgICBpZiAoZW5kID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25TdGFydCA9IHN0YXJ0OwogICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25FbmQgPSBNYXRoLm1pbihlbmQsIGlucHV0LnZhbHVlLmxlbmd0aCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRPZmZzZXRzKGlucHV0LCBvZmZzZXRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHNraXBTZWxlY3Rpb25DaGFuZ2VFdmVudCA9IGNhblVzZURPTTIgJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDw9IDExOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uU2VsZWN0IiwgWyJmb2N1c291dCIsICJjb250ZXh0bWVudSIsICJkcmFnZW5kIiwgImZvY3VzaW4iLCAia2V5ZG93biIsICJrZXl1cCIsICJtb3VzZWRvd24iLCAibW91c2V1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICB2YXIgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbiQxKG5vZGUpIHsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIG5vZGUgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBub2RlLnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHdpbiA9IG5vZGUub3duZXJEb2N1bWVudCAmJiBub2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGFuY2hvck5vZGU6IHNlbGVjdGlvbi5hbmNob3JOb2RlLAogICAgICAgICAgICAgIGFuY2hvck9mZnNldDogc2VsZWN0aW9uLmFuY2hvck9mZnNldCwKICAgICAgICAgICAgICBmb2N1c05vZGU6IHNlbGVjdGlvbi5mb2N1c05vZGUsCiAgICAgICAgICAgICAgZm9jdXNPZmZzZXQ6IHNlbGVjdGlvbi5mb2N1c09mZnNldAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldERvY3VtZW50KGV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gZXZlbnRUYXJnZXQud2luZG93ID09PSBldmVudFRhcmdldCA/IGV2ZW50VGFyZ2V0LmRvY3VtZW50IDogZXZlbnRUYXJnZXQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyBldmVudFRhcmdldCA6IGV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGRvYyA9IGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG1vdXNlRG93biB8fCBhY3RpdmVFbGVtZW50JDEgPT0gbnVsbCB8fCBhY3RpdmVFbGVtZW50JDEgIT09IGdldEFjdGl2ZUVsZW1lbnQoZG9jKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGdldFNlbGVjdGlvbiQxKGFjdGl2ZUVsZW1lbnQkMSk7CiAgICAgICAgICBpZiAoIWxhc3RTZWxlY3Rpb24gfHwgIXNoYWxsb3dFcXVhbDIobGFzdFNlbGVjdGlvbiwgY3VycmVudFNlbGVjdGlvbikpIHsKICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoYWN0aXZlRWxlbWVudEluc3QkMSwgIm9uU2VsZWN0Iik7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25TZWxlY3QiLCAic2VsZWN0IiwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBhY3RpdmVFbGVtZW50JDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpIHx8IHRhcmdldE5vZGUuY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IHRhcmdldE5vZGU7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IG51bGw7CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgICBpZiAoc2tpcFNlbGVjdGlvbkNoYW5nZUV2ZW50KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFrZVByZWZpeE1hcChzdHlsZVByb3AsIGV2ZW50TmFtZSkgewogICAgICAgICAgdmFyIHByZWZpeGVzMyA9IHt9OwogICAgICAgICAgcHJlZml4ZXMzW3N0eWxlUHJvcC50b0xvd2VyQ2FzZSgpXSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcHJlZml4ZXMzWyJXZWJraXQiICsgc3R5bGVQcm9wXSA9ICJ3ZWJraXQiICsgZXZlbnROYW1lOwogICAgICAgICAgcHJlZml4ZXMzWyJNb3oiICsgc3R5bGVQcm9wXSA9ICJtb3oiICsgZXZlbnROYW1lOwogICAgICAgICAgcmV0dXJuIHByZWZpeGVzMzsKICAgICAgICB9CiAgICAgICAgdmFyIHZlbmRvclByZWZpeGVzID0gewogICAgICAgICAgYW5pbWF0aW9uZW5kOiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uRW5kIiksCiAgICAgICAgICBhbmltYXRpb25pdGVyYXRpb246IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25JdGVyYXRpb24iKSwKICAgICAgICAgIGFuaW1hdGlvbnN0YXJ0OiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uU3RhcnQiKSwKICAgICAgICAgIHRyYW5zaXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIlRyYW5zaXRpb24iLCAiVHJhbnNpdGlvbkVuZCIpCiAgICAgICAgfTsKICAgICAgICB2YXIgcHJlZml4ZWRFdmVudE5hbWVzID0ge307CiAgICAgICAgdmFyIHN0eWxlID0ge307CiAgICAgICAgaWYgKGNhblVzZURPTTIpIHsKICAgICAgICAgIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iikuc3R5bGU7CiAgICAgICAgICBpZiAoISgiQW5pbWF0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbmVuZC5hbmltYXRpb247CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25pdGVyYXRpb24uYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uc3RhcnQuYW5pbWF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCEoIlRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93KSkgewogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMudHJhbnNpdGlvbmVuZC50cmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZShldmVudE5hbWUpIHsKICAgICAgICAgIGlmIChwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV07CiAgICAgICAgICB9IGVsc2UgaWYgKCF2ZW5kb3JQcmVmaXhlc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgIHJldHVybiBldmVudE5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJlZml4TWFwID0gdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlUHJvcCBpbiBwcmVmaXhNYXApIHsKICAgICAgICAgICAgaWYgKHByZWZpeE1hcC5oYXNPd25Qcm9wZXJ0eShzdHlsZVByb3ApICYmIHN0eWxlUHJvcCBpbiBzdHlsZSkgewogICAgICAgICAgICAgIHJldHVybiBwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXSA9IHByZWZpeE1hcFtzdHlsZVByb3BdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgIH0KICAgICAgICB2YXIgQU5JTUFUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25lbmQiKTsKICAgICAgICB2YXIgQU5JTUFUSU9OX0lURVJBVElPTiA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25pdGVyYXRpb24iKTsKICAgICAgICB2YXIgQU5JTUFUSU9OX1NUQVJUID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbnN0YXJ0Iik7CiAgICAgICAgdmFyIFRSQU5TSVRJT05fRU5EID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoInRyYW5zaXRpb25lbmQiKTsKICAgICAgICB2YXIgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBzaW1wbGVFdmVudFBsdWdpbkV2ZW50cyA9IFsiYWJvcnQiLCAiYXV4Q2xpY2siLCAiY2FuY2VsIiwgImNhblBsYXkiLCAiY2FuUGxheVRocm91Z2giLCAiY2xpY2siLCAiY2xvc2UiLCAiY29udGV4dE1lbnUiLCAiY29weSIsICJjdXQiLCAiZHJhZyIsICJkcmFnRW5kIiwgImRyYWdFbnRlciIsICJkcmFnRXhpdCIsICJkcmFnTGVhdmUiLCAiZHJhZ092ZXIiLCAiZHJhZ1N0YXJ0IiwgImRyb3AiLCAiZHVyYXRpb25DaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAiZ290UG9pbnRlckNhcHR1cmUiLCAiaW5wdXQiLCAiaW52YWxpZCIsICJrZXlEb3duIiwgImtleVByZXNzIiwgImtleVVwIiwgImxvYWQiLCAibG9hZGVkRGF0YSIsICJsb2FkZWRNZXRhZGF0YSIsICJsb2FkU3RhcnQiLCAibG9zdFBvaW50ZXJDYXB0dXJlIiwgIm1vdXNlRG93biIsICJtb3VzZU1vdmUiLCAibW91c2VPdXQiLCAibW91c2VPdmVyIiwgIm1vdXNlVXAiLCAicGFzdGUiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInBvaW50ZXJDYW5jZWwiLCAicG9pbnRlckRvd24iLCAicG9pbnRlck1vdmUiLCAicG9pbnRlck91dCIsICJwb2ludGVyT3ZlciIsICJwb2ludGVyVXAiLCAicHJvZ3Jlc3MiLCAicmF0ZUNoYW5nZSIsICJyZXNldCIsICJyZXNpemUiLCAic2Vla2VkIiwgInNlZWtpbmciLCAic3RhbGxlZCIsICJzdWJtaXQiLCAic3VzcGVuZCIsICJ0aW1lVXBkYXRlIiwgInRvdWNoQ2FuY2VsIiwgInRvdWNoRW5kIiwgInRvdWNoU3RhcnQiLCAidm9sdW1lQ2hhbmdlIiwgInNjcm9sbCIsICJ0b2dnbGUiLCAidG91Y2hNb3ZlIiwgIndhaXRpbmciLCAid2hlZWwiXTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcy5zZXQoZG9tRXZlbnROYW1lLCByZWFjdE5hbWUpOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlYWN0TmFtZSwgW2RvbUV2ZW50TmFtZV0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50cygpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzW2ldOwogICAgICAgICAgICB2YXIgZG9tRXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBjYXBpdGFsaXplZEV2ZW50ID0gZXZlbnROYW1lWzBdLnRvVXBwZXJDYXNlKCkgKyBldmVudE5hbWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoZG9tRXZlbnROYW1lLCAib24iICsgY2FwaXRhbGl6ZWRFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9FTkQsICJvbkFuaW1hdGlvbkVuZCIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fSVRFUkFUSU9OLCAib25BbmltYXRpb25JdGVyYXRpb24iKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX1NUQVJULCAib25BbmltYXRpb25TdGFydCIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZGJsY2xpY2siLCAib25Eb3VibGVDbGljayIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNpbiIsICJvbkZvY3VzIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KCJmb2N1c291dCIsICJvbkJsdXIiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoVFJBTlNJVElPTl9FTkQsICJvblRyYW5zaXRpb25FbmQiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ0KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciByZWFjdE5hbWUgPSB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcy5nZXQoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIGlmIChyZWFjdE5hbWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRXZlbnQ7CiAgICAgICAgICB2YXIgcmVhY3RFdmVudFR5cGUgPSBkb21FdmVudE5hbWU7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgaWYgKGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0tleWJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImZvY3VzIjsKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNGb2N1c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmVhY3RFdmVudFR5cGUgPSAiYmx1ciI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImFmdGVyYmx1ciI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY2xpY2siOgogICAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5idXR0b24gPT09IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImF1eGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZGJsY2xpY2siOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ3N0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRHJhZ0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0b3VjaGNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgY2FzZSAidG91Y2htb3ZlIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVG91Y2hFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fRU5EOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9JVEVSQVRJT046CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX1NUQVJUOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0FuaW1hdGlvbkV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRSQU5TSVRJT05fRU5EOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RyYW5zaXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2Nyb2xsIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNVSUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ3aGVlbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljV2hlZWxFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29weSI6CiAgICAgICAgICAgIGNhc2UgImN1dCI6CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNDbGlwYm9hcmRFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZ290cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJsb3N0cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJ1cCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljUG9pbnRlckV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluQ2FwdHVyZVBoYXNlID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFKSAhPT0gMDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjY3VtdWxhdGVUYXJnZXRPbmx5ID0gIWluQ2FwdHVyZVBoYXNlICYmIC8vIFRPRE86IGlkZWFsbHksIHdlJ2QgZXZlbnR1YWxseSBhZGQgYWxsIGV2ZW50cyBmcm9tCiAgICAgICAgICAgIC8vIG5vbkRlbGVnYXRlZEV2ZW50cyBsaXN0IGluIERPTVBsdWdpbkV2ZW50U3lzdGVtLgogICAgICAgICAgICAvLyBUaGVuIHdlIGNhbiByZW1vdmUgdGhpcyBzcGVjaWFsIGxpc3QuCiAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBicmVha2luZyBjaGFuZ2UgdGhhdCBjYW4gd2FpdCB1bnRpbCBSZWFjdCAxOC4KICAgICAgICAgICAgZG9tRXZlbnROYW1lID09PSAic2Nyb2xsIjsKICAgICAgICAgICAgdmFyIF9saXN0ZW5lcnMgPSBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgcmVhY3ROYW1lLCBuYXRpdmVFdmVudC50eXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHkpOwogICAgICAgICAgICBpZiAoX2xpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9ldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IocmVhY3ROYW1lLCByZWFjdEV2ZW50VHlwZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQ6IF9ldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVyczogX2xpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnRzKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMigpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDEoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQzKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMoKTsKICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdEV2ZW50cyQ0KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBzaG91bGRQcm9jZXNzUG9seWZpbGxQbHVnaW5zID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUykgPT09IDA7CiAgICAgICAgICBpZiAoc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucykgewogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDEoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG1lZGlhRXZlbnRUeXBlcyA9IFsiYWJvcnQiLCAiY2FucGxheSIsICJjYW5wbGF5dGhyb3VnaCIsICJkdXJhdGlvbmNoYW5nZSIsICJlbXB0aWVkIiwgImVuY3J5cHRlZCIsICJlbmRlZCIsICJlcnJvciIsICJsb2FkZWRkYXRhIiwgImxvYWRlZG1ldGFkYXRhIiwgImxvYWRzdGFydCIsICJwYXVzZSIsICJwbGF5IiwgInBsYXlpbmciLCAicHJvZ3Jlc3MiLCAicmF0ZWNoYW5nZSIsICJyZXNpemUiLCAic2Vla2VkIiwgInNlZWtpbmciLCAic3RhbGxlZCIsICJzdXNwZW5kIiwgInRpbWV1cGRhdGUiLCAidm9sdW1lY2hhbmdlIiwgIndhaXRpbmciXTsKICAgICAgICB2YXIgbm9uRGVsZWdhdGVkRXZlbnRzID0gbmV3IFNldChbImNhbmNlbCIsICJjbG9zZSIsICJpbnZhbGlkIiwgImxvYWQiLCAic2Nyb2xsIiwgInRvZ2dsZSJdLmNvbmNhdChtZWRpYUV2ZW50VHlwZXMpKTsKICAgICAgICBmdW5jdGlvbiBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBjdXJyZW50VGFyZ2V0OwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUsIGxpc3RlbmVyMiwgdm9pZCAwLCBldmVudCk7CiAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGRpc3BhdGNoTGlzdGVuZXJzLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHByZXZpb3VzSW5zdGFuY2U7CiAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRpID0gZGlzcGF0Y2hMaXN0ZW5lcnNbaV0sIGluc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkuaW5zdGFuY2UsIGN1cnJlbnRUYXJnZXQgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5jdXJyZW50VGFyZ2V0LCBsaXN0ZW5lcjIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5saXN0ZW5lcjsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IHByZXZpb3VzSW5zdGFuY2UgJiYgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRfaSA9IGRpc3BhdGNoTGlzdGVuZXJzW19pXSwgX2luc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmluc3RhbmNlLCBfY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5jdXJyZW50VGFyZ2V0LCBfbGlzdGVuZXIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgX2xpc3RlbmVyLCBfY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IF9pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaFF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hRdWV1ZSRpID0gZGlzcGF0Y2hRdWV1ZVtpXSwgZXZlbnQgPSBfZGlzcGF0Y2hRdWV1ZSRpLmV2ZW50LCBsaXN0ZW5lcnMgPSBfZGlzcGF0Y2hRdWV1ZSRpLmxpc3RlbmVyczsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGxpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0aHJvd0NhdWdodEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgpIGNhbGwgZm9yICIlcyIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgbGlzdGVuZXJTZXQgPSBnZXRFdmVudExpc3RlbmVyU2V0KHRhcmdldEVsZW1lbnQpOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0S2V5ID0gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgIGlmICghbGlzdGVuZXJTZXQuaGFzKGxpc3RlbmVyU2V0S2V5KSkgewogICAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRFbGVtZW50LCBkb21FdmVudE5hbWUsIElTX05PTl9ERUxFR0FURUQsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICBsaXN0ZW5lclNldC5hZGQobGlzdGVuZXJTZXRLZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgdGFyZ2V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkgJiYgIWlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3QgYSBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCkgY2FsbCBmb3IgIiVzIiBpbiB0aGUgYnViYmxlIHBoYXNlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRTeXN0ZW1GbGFncyA9IDA7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzIHw9IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXQsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciBsaXN0ZW5pbmdNYXJrZXIgPSAiX3JlYWN0TGlzdGVuaW5nIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICBpZiAoIXJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgcm9vdENvbnRhaW5lckVsZW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgIGFsbE5hdGl2ZUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgIT09ICJzZWxlY3Rpb25jaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZmFsc2UsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCB0cnVlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKG93bmVyRG9jdW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIW93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICAgICAgb3duZXJEb2N1bWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoInNlbGVjdGlvbmNoYW5nZSIsIGZhbHNlLCBvd25lckRvY3VtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIGlzRGVmZXJyZWRMaXN0ZW5lckZvckxlZ2FjeUZCU3VwcG9ydCkgewogICAgICAgICAgdmFyIGxpc3RlbmVyMiA9IGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBpc1Bhc3NpdmVMaXN0ZW5lciA9IHZvaWQgMDsKICAgICAgICAgIGlmIChwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCkgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAidG91Y2hzdGFydCIgfHwgZG9tRXZlbnROYW1lID09PSAidG91Y2htb3ZlIiB8fCBkb21FdmVudE5hbWUgPT09ICJ3aGVlbCIpIHsKICAgICAgICAgICAgICBpc1Bhc3NpdmVMaXN0ZW5lciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcjsKICAgICAgICAgIHZhciB1bnN1YnNjcmliZUxpc3RlbmVyOwogICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMiwgaXNQYXNzaXZlTGlzdGVuZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyLCBpc1Bhc3NpdmVMaXN0ZW5lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdyYW5kQ29udGFpbmVyID09PSB0YXJnZXRDb250YWluZXIgfHwgZ3JhbmRDb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBncmFuZENvbnRhaW5lci5wYXJlbnROb2RlID09PSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBhbmNlc3Rvckluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgaWYgKChldmVudFN5c3RlbUZsYWdzICYgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUpID09PSAwICYmIChldmVudFN5c3RlbUZsYWdzICYgSVNfTk9OX0RFTEVHQVRFRCkgPT09IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lck5vZGUgPSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgIG1haW5Mb29wOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5vZGVUYWcgPSBub2RlLnRhZzsKICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0Um9vdCB8fCBub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gbm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGNvbnRhaW5lcjIsIHRhcmdldENvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG5vZGVUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmROb2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGdyYW5kTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kVGFnID0gZ3JhbmROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChncmFuZFRhZyA9PT0gSG9zdFJvb3QgfHwgZ3JhbmRUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kQ29udGFpbmVyID0gZ3JhbmROb2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBncmFuZE5vZGUgPSBncmFuZE5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB3aGlsZSAoY29udGFpbmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudE5vZGUudGFnOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRUYWcgPT09IEhvc3RDb21wb25lbnQgfHwgcGFyZW50VGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGFuY2VzdG9ySW5zdCA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBtYWluTG9vcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyMiA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgYW5jZXN0b3JJbnN0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lcjIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICBsaXN0ZW5lcjogbGlzdGVuZXIyLAogICAgICAgICAgICBjdXJyZW50VGFyZ2V0CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0RmliZXIsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnRUeXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHksIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgIT09IG51bGwgPyByZWFjdE5hbWUgKyAiQ2FwdHVyZSIgOiBudWxsOwogICAgICAgICAgdmFyIHJlYWN0RXZlbnROYW1lID0gaW5DYXB0dXJlUGhhc2UgPyBjYXB0dXJlTmFtZSA6IHJlYWN0TmFtZTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldEZpYmVyOwogICAgICAgICAgdmFyIGxhc3RIb3N0Q29tcG9uZW50ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMiA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UyLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMi50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbGFzdEhvc3RDb21wb25lbnQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHJlYWN0RXZlbnROYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0RXZlbnROYW1lKTsKICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lcjIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lcjIsIGxhc3RIb3N0Q29tcG9uZW50KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhY2N1bXVsYXRlVGFyZ2V0T25seSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUpIHsKICAgICAgICAgIHZhciBjYXB0dXJlTmFtZSA9IHJlYWN0TmFtZSArICJDYXB0dXJlIjsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldEZpYmVyOwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gaW5zdGFuY2UsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTMuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2UzLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRhcmdldCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVOYW1lKTsKICAgICAgICAgICAgICBpZiAoY2FwdHVyZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVhY3ROYW1lKTsKICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgYnViYmxlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnQoaW5zdCkgewogICAgICAgICAgaWYgKGluc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGluc3QgPSBpbnN0LnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKGluc3QgJiYgaW5zdC50YWcgIT09IEhvc3RDb21wb25lbnQpOwogICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TG93ZXN0Q29tbW9uQW5jZXN0b3IoaW5zdEEsIGluc3RCKSB7CiAgICAgICAgICB2YXIgbm9kZUEgPSBpbnN0QTsKICAgICAgICAgIHZhciBub2RlQiA9IGluc3RCOwogICAgICAgICAgdmFyIGRlcHRoQSA9IDA7CiAgICAgICAgICBmb3IgKHZhciB0ZW1wQSA9IG5vZGVBOyB0ZW1wQTsgdGVtcEEgPSBnZXRQYXJlbnQodGVtcEEpKSB7CiAgICAgICAgICAgIGRlcHRoQSsrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoQiA9IDA7CiAgICAgICAgICBmb3IgKHZhciB0ZW1wQiA9IG5vZGVCOyB0ZW1wQjsgdGVtcEIgPSBnZXRQYXJlbnQodGVtcEIpKSB7CiAgICAgICAgICAgIGRlcHRoQisrOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGRlcHRoQSAtIGRlcHRoQiA+IDApIHsKICAgICAgICAgICAgbm9kZUEgPSBnZXRQYXJlbnQobm9kZUEpOwogICAgICAgICAgICBkZXB0aEEtLTsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEIgLSBkZXB0aEEgPiAwKSB7CiAgICAgICAgICAgIG5vZGVCID0gZ2V0UGFyZW50KG5vZGVCKTsKICAgICAgICAgICAgZGVwdGhCLS07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVwdGggPSBkZXB0aEE7CiAgICAgICAgICB3aGlsZSAoZGVwdGgtLSkgewogICAgICAgICAgICBpZiAobm9kZUEgPT09IG5vZGVCIHx8IG5vZGVCICE9PSBudWxsICYmIG5vZGVBID09PSBub2RlQi5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZUE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZUEgPSBnZXRQYXJlbnQobm9kZUEpOwogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBldmVudCwgdGFyZ2V0LCBjb21tb24sIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IGV2ZW50Ll9yZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXQ7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlID09PSBjb21tb24pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGluc3RhbmNlLCBhbHRlcm5hdGUgPSBfaW5zdGFuY2U0LmFsdGVybmF0ZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlNC5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTQudGFnOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRhcmdldCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgICAgIHZhciBjYXB0dXJlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnVuc2hpZnQoY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgY2FwdHVyZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgICAgIHZhciBidWJibGVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIGlmIChidWJibGVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlVHdvUGhhc2VMaXN0ZW5lcnMoZGlzcGF0Y2hRdWV1ZSwgbGVhdmVFdmVudCwgZW50ZXJFdmVudCwgZnJvbTIsIHRvMikgewogICAgICAgICAgdmFyIGNvbW1vbiA9IGZyb20yICYmIHRvMiA/IGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGZyb20yLCB0bzIpIDogbnVsbDsKICAgICAgICAgIGlmIChmcm9tMiAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGZyb20yLCBjb21tb24sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0bzIgIT09IG51bGwgJiYgZW50ZXJFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGVudGVyRXZlbnQsIHRvMiwgY29tbW9uLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBjYXB0dXJlKSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lICsgIl9fIiArIChjYXB0dXJlID8gImNhcHR1cmUiIDogImJ1YmJsZSIpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgPSAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiOwogICAgICAgIHZhciBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgPSAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIjsKICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgQVVUT0ZPQ1VTID0gImF1dG9Gb2N1cyI7CiAgICAgICAgdmFyIENISUxEUkVOID0gImNoaWxkcmVuIjsKICAgICAgICB2YXIgU1RZTEUgPSAic3R5bGUiOwogICAgICAgIHZhciBIVE1MJDEgPSAiX19odG1sIjsKICAgICAgICB2YXIgd2FybmVkVW5rbm93blRhZ3M7CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQ7CiAgICAgICAgdmFyIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZTsKICAgICAgICB2YXIgd2FybkZvckV4dHJhQXR0cmlidXRlczsKICAgICAgICB2YXIgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyOwogICAgICAgIHZhciBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nOwogICAgICAgIHZhciBub3JtYWxpemVIVE1MOwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzID0gewogICAgICAgICAgICAvLyBUaGVyZSBhcmUgd29ya2luZyBwb2x5ZmlsbHMgZm9yIDxkaWFsb2c+LiBMZXQgcGVvcGxlIHVzZSBpdC4KICAgICAgICAgICAgZGlhbG9nOiB0cnVlLAogICAgICAgICAgICAvLyBFbGVjdHJvbiBzaGlwcyBhIGN1c3RvbSA8d2Vidmlldz4gdGFnIHRvIGRpc3BsYXkgZXh0ZXJuYWwgd2ViIGNvbnRlbnQgaW4KICAgICAgICAgICAgLy8gYW4gaXNvbGF0ZWQgZnJhbWUgYW5kIHByb2Nlc3MuCiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGlzIG5vdCBwcmVzZW50IGluIG5vbiBFbGVjdHJvbiBlbnZpcm9ubWVudHMgc3VjaCBhcyBKU0RvbSB3aGljaAogICAgICAgICAgICAvLyBpcyBvZnRlbiB1c2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgogICAgICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZWxlY3Ryb25qcy5vcmcvZG9jcy9hcGkvd2Vidmlldy10YWcKICAgICAgICAgICAgd2VidmlldzogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQgPSBmdW5jdGlvbih0eXBlLCBwcm9wcykgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXModHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCB7CiAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcgPSBjYW5Vc2VET00yICYmICFkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UgPSBmdW5jdGlvbihwcm9wTmFtZSwgc2VydmVyVmFsdWUsIGNsaWVudFZhbHVlKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKGNsaWVudFZhbHVlKTsKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJWYWx1ZSk7CiAgICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVmFsdWUgPT09IG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJQcm9wIGAlc2AgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAlcyBDbGllbnQ6ICVzIiwgcHJvcE5hbWUsIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSksIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMgPSBmdW5jdGlvbihhdHRyaWJ1dGVOYW1lcykgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgYXR0cmlidXRlTmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgbmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVycm9yKCJFeHRyYSBhdHRyaWJ1dGVzIGZyb20gdGhlIHNlcnZlcjogJXMiLCBuYW1lcyk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24ocmVnaXN0cmF0aW9uTmFtZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcjIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYGZhbHNlYC5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCVzYCB0eXBlLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHR5cGVvZiBsaXN0ZW5lcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgbm9ybWFsaXplSFRNTCA9IGZ1bmN0aW9uKHBhcmVudCwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGVzdEVsZW1lbnQgPSBwYXJlbnQubmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSA/IHBhcmVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQocGFyZW50LnRhZ05hbWUpIDogcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKHBhcmVudC5uYW1lc3BhY2VVUkksIHBhcmVudC50YWdOYW1lKTsKICAgICAgICAgICAgdGVzdEVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgcmV0dXJuIHRlc3RFbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBOT1JNQUxJWkVfTkVXTElORVNfUkVHRVggPSAvXHJcbj8vZzsKICAgICAgICB2YXIgTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYID0gL1x1MDAwMHxcdUZGRkQvZzsKICAgICAgICBmdW5jdGlvbiBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUobWFya3VwKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKG1hcmt1cCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWFya3VwU3RyaW5nID0gdHlwZW9mIG1hcmt1cCA9PT0gInN0cmluZyIgPyBtYXJrdXAgOiAiIiArIG1hcmt1cDsKICAgICAgICAgIHJldHVybiBtYXJrdXBTdHJpbmcucmVwbGFjZShOT1JNQUxJWkVfTkVXTElORVNfUkVHRVgsICJcbiIpLnJlcGxhY2UoTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYLCAiIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChzZXJ2ZXJUZXh0LCBjbGllbnRUZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VGV4dCk7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoc2VydmVyVGV4dCk7CiAgICAgICAgICBpZiAobm9ybWFsaXplZFNlcnZlclRleHQgPT09IG5vcm1hbGl6ZWRDbGllbnRUZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignVGV4dCBjb250ZW50IGRpZCBub3QgbWF0Y2guIFNlcnZlcjogIiVzIiBDbGllbnQ6ICIlcyInLCBub3JtYWxpemVkU2VydmVyVGV4dCwgbm9ybWFsaXplZENsaWVudFRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgJiYgZW5hYmxlQ2xpZW50UmVuZGVyRmFsbGJhY2tPblRleHRNaXNtYXRjaCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRleHQgY29udGVudCBkb2VzIG5vdCBtYXRjaCBzZXJ2ZXItcmVuZGVyZWQgSFRNTC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vb3A0KCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChub2RlKSB7CiAgICAgICAgICBub2RlLm9uY2xpY2sgPSBub29wNDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgbmV4dFByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JTdHlsZXMoZG9tRWxlbWVudCwgbmV4dFByb3ApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuU2V0VGV4dENvbnRlbnQgPSB0YWcgIT09ICJ0ZXh0YXJlYSIgfHwgbmV4dFByb3AgIT09ICIiOwogICAgICAgICAgICAgICAgaWYgKGNhblNldFRleHRDb250ZW50KSB7CiAgICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVwZGF0ZVBheWxvYWQubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgdmFyIHByb3BLZXkgPSB1cGRhdGVQYXlsb2FkW2ldOwogICAgICAgICAgICB2YXIgcHJvcFZhbHVlID0gdXBkYXRlUGF5bG9hZFtpICsgMV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBwcm9wVmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50NDUodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50LCBwYXJlbnROYW1lc3BhY2UpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZzsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgIHZhciBkb21FbGVtZW50OwogICAgICAgICAgdmFyIG5hbWVzcGFjZVVSSSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIG5hbWVzcGFjZVVSSSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIHR5cGUgIT09IHR5cGUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIjwlcyAvPiBpcyB1c2luZyBpbmNvcnJlY3QgY2FzaW5nLiBVc2UgUGFzY2FsQ2FzZSBmb3IgUmVhY3QgY29tcG9uZW50cywgb3IgbG93ZXJjYXNlIGZvciBIVE1MIGVsZW1lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gInNjcmlwdCIpIHsKICAgICAgICAgICAgICB2YXIgZGl2ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxzY3JpcHQ+PFwvc2NyaXB0PiI7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBkaXYuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gZGl2LnJlbW92ZUNoaWxkKGZpcnN0Q2hpbGQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUsIHsKICAgICAgICAgICAgICAgIGlzOiBwcm9wcy5pcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IGRvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgICBpZiAocHJvcHMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5tdWx0aXBsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLnNpemUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5zaXplID0gcHJvcHMuc2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUkksIHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGRvbUVsZW1lbnQpID09PSAiW29iamVjdCBIVE1MVW5rbm93bkVsZW1lbnRdIiAmJiAhaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRVbmtub3duVGFncywgdHlwZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzW3R5cGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgdGFnIDwlcz4gaXMgdW5yZWNvZ25pemVkIGluIHRoaXMgYnJvd3Nlci4gSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIFJlYWN0IGNvbXBvbmVudCwgc3RhcnQgaXRzIG5hbWUgd2l0aCBhbiB1cHBlcmNhc2UgbGV0dGVyLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRvbUVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KS5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjYW5jZWwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjbG9zZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic291cmNlIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcHJvcHMpOwogICAgICAgICAgc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgcHJvcHMsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyKGRvbUVsZW1lbnQsIHJhd1Byb3BzLCBmYWxzZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIHZhciBsYXN0UHJvcHM7CiAgICAgICAgICB2YXIgbmV4dFByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBsYXN0UmF3UHJvcHM7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gbmV4dFJhd1Byb3BzOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgbGFzdFByb3BzLm9uQ2xpY2sgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG5leHRQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgbmV4dFByb3BzKTsKICAgICAgICAgIHZhciBwcm9wS2V5OwogICAgICAgICAgdmFyIHN0eWxlTmFtZTsKICAgICAgICAgIHZhciBzdHlsZVVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgZm9yIChwcm9wS2V5IGluIGxhc3RQcm9wcykgewogICAgICAgICAgICBpZiAobmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8ICFsYXN0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgbGFzdFByb3BzW3Byb3BLZXldID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB2YXIgbGFzdFN0eWxlID0gbGFzdFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RTdHlsZSkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RTdHlsZS5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgfHwgcHJvcEtleSA9PT0gQ0hJTERSRU4pIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yIChwcm9wS2V5IGluIG5leHRQcm9wcykgewogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIHZhciBsYXN0UHJvcCA9IGxhc3RQcm9wcyAhPSBudWxsID8gbGFzdFByb3BzW3Byb3BLZXldIDogdm9pZCAwOwogICAgICAgICAgICBpZiAoIW5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBuZXh0UHJvcCA9PT0gbGFzdFByb3AgfHwgbmV4dFByb3AgPT0gbnVsbCAmJiBsYXN0UHJvcCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUobmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFByb3ApIHsKICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmICghbmV4dFByb3AgfHwgIW5leHRQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSAmJiBsYXN0UHJvcFtzdHlsZU5hbWVdICE9PSBuZXh0UHJvcFtzdHlsZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9IG5leHRQcm9wW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQucHVzaChwcm9wS2V5LCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0gbmV4dFByb3A7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIHZhciBsYXN0SHRtbCA9IGxhc3RQcm9wID8gbGFzdFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RIdG1sICE9PSBuZXh0SHRtbCkgewogICAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCAmJiBsYXN0UHJvcCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0eWxlVXBkYXRlcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFByb3BzW1NUWUxFXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKFNUWUxFLCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdGFnLCBsYXN0UmF3UHJvcHMsIG5leHRSYXdQcm9wcykgewogICAgICAgICAgaWYgKHRhZyA9PT0gImlucHV0IiAmJiBuZXh0UmF3UHJvcHMudHlwZSA9PT0gInJhZGlvIiAmJiBuZXh0UmF3UHJvcHMubmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB1cGRhdGVET01Qcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHdhc0N1c3RvbUNvbXBvbmVudFRhZywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RVcGRhdGVXcmFwcGVyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IHByb3BOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICghcG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcGFyZW50TmFtZXNwYWNlLCByb290Q29udGFpbmVyRWxlbWVudCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIGV4dHJhQXR0cmlidXRlTmFtZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KG1lZGlhRXZlbnRUeXBlc1tpXSwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInRvZ2dsZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHZhbGlkYXRlUHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBkb21FbGVtZW50LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlc1tfaV0ubmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICAgICAgY2FzZSAidmFsdWUiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNoZWNrZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInNlbGVjdGVkIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmFkZChhdHRyaWJ1dGVzW19pXS5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gcmF3UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFyYXdQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IHJhd1Byb3BzW3Byb3BLZXldOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09IG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sIG5leHRQcm9wXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGlmIChkb21FbGVtZW50LnRleHRDb250ZW50ICE9PSAiIiArIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sICIiICsgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRXYXJuRGV2ICYmIHRydWUgJiYgLy8gQ29udmluY2UgRmxvdyB3ZSd2ZSBjYWxjdWxhdGVkIGl0IChpdCdzIERFVi1vbmx5IGluIHRoaXMgbWV0aG9kLikKICAgICAgICAgICAgdHlwZW9mIGlzQ3VzdG9tQ29tcG9uZW50VGFnID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICB2YXIgc2VydmVyVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPyBudWxsIDogZ2V0UHJvcGVydHlJbmZvKHByb3BLZXkpOwogICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gPT09IHRydWUpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgfHwgLy8gQ29udHJvbGxlZCBhdHRyaWJ1dGVzIGFyZSBub3QgdmFsaWRhdGVkCiAgICAgICAgICAgICAgLy8gVE9ETzogT25seSBpZ25vcmUgdGhlbSBvbiBjb250cm9sbGVkIHRhZ3MuCiAgICAgICAgICAgICAgcHJvcEtleSA9PT0gInZhbHVlIiB8fCBwcm9wS2V5ID09PSAiY2hlY2tlZCIgfHwgcHJvcEtleSA9PT0gInNlbGVjdGVkIikgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VydmVySFRNTCA9IGRvbUVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkSFRNTCA9IG5vcm1hbGl6ZUhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRIVE1MICE9PSBzZXJ2ZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlckhUTUwsIGV4cGVjdGVkSFRNTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgIGlmIChjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nKSB7CiAgICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZFN0eWxlID0gY3JlYXRlRGFuZ2Vyb3VzU3RyaW5nRm9yU3R5bGVzKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBkb21FbGVtZW50LmdldEF0dHJpYnV0ZSgic3R5bGUiKTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkU3R5bGUgIT09IHNlcnZlclZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBleHBlY3RlZFN0eWxlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgJiYgIWVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkSWdub3JlQXR0cmlidXRlKHByb3BLZXksIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpICYmICFzaG91bGRSZW1vdmVBdHRyaWJ1dGUocHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgaWYgKG93bk5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICBvd25OYW1lc3BhY2UgPSBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodGFnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG51bGwgJiYgc3RhbmRhcmROYW1lICE9PSBwcm9wS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUoc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvckF0dHJpYnV0ZShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZG9udFdhcm5DdXN0b21FbGVtZW50ID0gZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydDsKICAgICAgICAgICAgICAgIGlmICghZG9udFdhcm5DdXN0b21FbGVtZW50ICYmIG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSAmJiAhaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkV2FybkRldikgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgLSBTaG91bGQgYmUgaW5mZXJyZWQgYXMgbm90IHVuZGVmaW5lZC4KICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuc2l6ZSA+IDAgJiYgcmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzKGV4dHJhQXR0cmlidXRlTmFtZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIHRydWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmF3UHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFRleHQodGV4dE5vZGUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHZhciBpc0RpZmZlcmVudCA9IHRleHROb2RlLm5vZGVWYWx1ZSAhPT0gdGV4dDsKICAgICAgICAgIHJldHVybiBpc0RpZmZlcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnROb2RlLCBjaGlsZCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRGlkIG5vdCBleHBlY3Qgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIDwlcz4gaW4gPCVzPi4iLCBjaGlsZC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIHRoZSB0ZXh0IG5vZGUgIiVzIiBpbiA8JXM+LicsIGNoaWxkLm5vZGVWYWx1ZSwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHRhZywgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyA8JXM+IGluIDwlcz4uIiwgdGFnLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Tm9kZSwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodGV4dCA9PT0gIiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0V4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyB0ZXh0IG5vZGUgZm9yICIlcyIgaW4gPCVzPi4nLCB0ZXh0LCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMoZG9tRWxlbWVudCwgdGFnLCBwcm9wcykgewogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHNwZWNpYWxUYWdzID0gWyJhZGRyZXNzIiwgImFwcGxldCIsICJhcmVhIiwgImFydGljbGUiLCAiYXNpZGUiLCAiYmFzZSIsICJiYXNlZm9udCIsICJiZ3NvdW5kIiwgImJsb2NrcXVvdGUiLCAiYm9keSIsICJiciIsICJidXR0b24iLCAiY2FwdGlvbiIsICJjZW50ZXIiLCAiY29sIiwgImNvbGdyb3VwIiwgImRkIiwgImRldGFpbHMiLCAiZGlyIiwgImRpdiIsICJkbCIsICJkdCIsICJlbWJlZCIsICJmaWVsZHNldCIsICJmaWdjYXB0aW9uIiwgImZpZ3VyZSIsICJmb290ZXIiLCAiZm9ybSIsICJmcmFtZSIsICJmcmFtZXNldCIsICJoMSIsICJoMiIsICJoMyIsICJoNCIsICJoNSIsICJoNiIsICJoZWFkIiwgImhlYWRlciIsICJoZ3JvdXAiLCAiaHIiLCAiaHRtbCIsICJpZnJhbWUiLCAiaW1nIiwgImlucHV0IiwgImlzaW5kZXgiLCAibGkiLCAibGluayIsICJsaXN0aW5nIiwgIm1haW4iLCAibWFycXVlZSIsICJtZW51IiwgIm1lbnVpdGVtIiwgIm1ldGEiLCAibmF2IiwgIm5vZW1iZWQiLCAibm9mcmFtZXMiLCAibm9zY3JpcHQiLCAib2JqZWN0IiwgIm9sIiwgInAiLCAicGFyYW0iLCAicGxhaW50ZXh0IiwgInByZSIsICJzY3JpcHQiLCAic2VjdGlvbiIsICJzZWxlY3QiLCAic291cmNlIiwgInN0eWxlIiwgInN1bW1hcnkiLCAidGFibGUiLCAidGJvZHkiLCAidGQiLCAidGVtcGxhdGUiLCAidGV4dGFyZWEiLCAidGZvb3QiLCAidGgiLCAidGhlYWQiLCAidGl0bGUiLCAidHIiLCAidHJhY2siLCAidWwiLCAid2JyIiwgInhtcCJdOwogICAgICAgICAgdmFyIGluU2NvcGVUYWdzID0gWwogICAgICAgICAgICAiYXBwbGV0IiwKICAgICAgICAgICAgImNhcHRpb24iLAogICAgICAgICAgICAiaHRtbCIsCiAgICAgICAgICAgICJ0YWJsZSIsCiAgICAgICAgICAgICJ0ZCIsCiAgICAgICAgICAgICJ0aCIsCiAgICAgICAgICAgICJtYXJxdWVlIiwKICAgICAgICAgICAgIm9iamVjdCIsCiAgICAgICAgICAgICJ0ZW1wbGF0ZSIsCiAgICAgICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3N5bnRheC5odG1sI2h0bWwtaW50ZWdyYXRpb24tcG9pbnQKICAgICAgICAgICAgLy8gVE9ETzogRGlzdGluZ3Vpc2ggYnkgbmFtZXNwYWNlIGhlcmUgLS0gZm9yIDx0aXRsZT4sIGluY2x1ZGluZyBpdCBoZXJlCiAgICAgICAgICAgIC8vIGVycnMgb24gdGhlIHNpZGUgb2YgZmV3ZXIgd2FybmluZ3MKICAgICAgICAgICAgImZvcmVpZ25PYmplY3QiLAogICAgICAgICAgICAiZGVzYyIsCiAgICAgICAgICAgICJ0aXRsZSIKICAgICAgICAgIF07CiAgICAgICAgICB2YXIgYnV0dG9uU2NvcGVUYWdzID0gaW5TY29wZVRhZ3MuY29uY2F0KFsiYnV0dG9uIl0pOwogICAgICAgICAgdmFyIGltcGxpZWRFbmRUYWdzID0gWyJkZCIsICJkdCIsICJsaSIsICJvcHRpb24iLCAib3B0Z3JvdXAiLCAicCIsICJycCIsICJydCJdOwogICAgICAgICAgdmFyIGVtcHR5QW5jZXN0b3JJbmZvID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgICBmb3JtVGFnOiBudWxsLAogICAgICAgICAgICBhVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgYnV0dG9uVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgbm9iclRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIHBUYWdJbkJ1dHRvblNjb3BlOiBudWxsLAogICAgICAgICAgICBsaXN0SXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsLAogICAgICAgICAgICBkbEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZWRBbmNlc3RvckluZm8gPSBmdW5jdGlvbihvbGRJbmZvLCB0YWcpIHsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IGFzc2lnbjIoe30sIG9sZEluZm8gfHwgZW1wdHlBbmNlc3RvckluZm8pOwogICAgICAgICAgICB2YXIgaW5mbyA9IHsKICAgICAgICAgICAgICB0YWcKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGluU2NvcGVUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChidXR0b25TY29wZVRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSkgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNwZWNpYWxUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEgJiYgdGFnICE9PSAiYWRkcmVzcyIgJiYgdGFnICE9PSAiZGl2IiAmJiB0YWcgIT09ICJwIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFuY2VzdG9ySW5mby5jdXJyZW50ID0gaW5mbzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gImZvcm0iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmZvcm1UYWcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJhIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImJ1dHRvbiIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gIm5vYnIiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAicCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJsaSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZyA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImRkIiB8fCB0YWcgPT09ICJkdCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm87CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGlzVGFnVmFsaWRXaXRoUGFyZW50ID0gZnVuY3Rpb24odGFnLCBwYXJlbnRUYWcpIHsKICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRUYWcpIHsKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAib3B0Z3JvdXAiIHx8IHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICBjYXNlICJvcHRncm91cCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAib3B0aW9uIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAidHIiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRoIiB8fCB0YWcgPT09ICJ0ZCIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICBjYXNlICJ0aGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAidGZvb3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRyIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiY29sZ3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImNvbCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjYXB0aW9uIiB8fCB0YWcgPT09ICJjb2xncm91cCIgfHwgdGFnID09PSAidGJvZHkiIHx8IHRhZyA9PT0gInRmb290IiB8fCB0YWcgPT09ICJ0aGVhZCIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImhlYWQiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImJhc2UiIHx8IHRhZyA9PT0gImJhc2Vmb250IiB8fCB0YWcgPT09ICJiZ3NvdW5kIiB8fCB0YWcgPT09ICJsaW5rIiB8fCB0YWcgPT09ICJtZXRhIiB8fCB0YWcgPT09ICJ0aXRsZSIgfHwgdGFnID09PSAibm9zY3JpcHQiIHx8IHRhZyA9PT0gIm5vZnJhbWVzIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiaHRtbCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaGVhZCIgfHwgdGFnID09PSAiYm9keSIgfHwgdGFnID09PSAiZnJhbWVzZXQiOwogICAgICAgICAgICAgIGNhc2UgImZyYW1lc2V0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJmcmFtZSI7CiAgICAgICAgICAgICAgY2FzZSAiI2RvY3VtZW50IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJodG1sIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgY2FzZSAiaDMiOgogICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgY2FzZSAiaDYiOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyAhPT0gImgxIiAmJiBwYXJlbnRUYWcgIT09ICJoMiIgJiYgcGFyZW50VGFnICE9PSAiaDMiICYmIHBhcmVudFRhZyAhPT0gImg0IiAmJiBwYXJlbnRUYWcgIT09ICJoNSIgJiYgcGFyZW50VGFnICE9PSAiaDYiOwogICAgICAgICAgICAgIGNhc2UgInJwIjoKICAgICAgICAgICAgICBjYXNlICJydCI6CiAgICAgICAgICAgICAgICByZXR1cm4gaW1wbGllZEVuZFRhZ3MuaW5kZXhPZihwYXJlbnRUYWcpID09PSAtMTsKICAgICAgICAgICAgICBjYXNlICJib2R5IjoKICAgICAgICAgICAgICBjYXNlICJjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJjb2wiOgogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWUiOgogICAgICAgICAgICAgIGNhc2UgImhlYWQiOgogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICBjYXNlICJ0ZCI6CiAgICAgICAgICAgICAgY2FzZSAidGZvb3QiOgogICAgICAgICAgICAgIGNhc2UgInRoIjoKICAgICAgICAgICAgICBjYXNlICJ0aGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAidHIiOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyA9PSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBmaW5kSW52YWxpZEFuY2VzdG9yRm9yVGFnID0gZnVuY3Rpb24odGFnLCBhbmNlc3RvckluZm8pIHsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJhZGRyZXNzIjoKICAgICAgICAgICAgICBjYXNlICJhcnRpY2xlIjoKICAgICAgICAgICAgICBjYXNlICJhc2lkZSI6CiAgICAgICAgICAgICAgY2FzZSAiYmxvY2txdW90ZSI6CiAgICAgICAgICAgICAgY2FzZSAiY2VudGVyIjoKICAgICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGNhc2UgImRpciI6CiAgICAgICAgICAgICAgY2FzZSAiZGl2IjoKICAgICAgICAgICAgICBjYXNlICJkbCI6CiAgICAgICAgICAgICAgY2FzZSAiZmllbGRzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZpZ2NhcHRpb24iOgogICAgICAgICAgICAgIGNhc2UgImZpZ3VyZSI6CiAgICAgICAgICAgICAgY2FzZSAiZm9vdGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkZXIiOgogICAgICAgICAgICAgIGNhc2UgImhncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAibWFpbiI6CiAgICAgICAgICAgICAgY2FzZSAibWVudSI6CiAgICAgICAgICAgICAgY2FzZSAibmF2IjoKICAgICAgICAgICAgICBjYXNlICJvbCI6CiAgICAgICAgICAgICAgY2FzZSAicCI6CiAgICAgICAgICAgICAgY2FzZSAic2VjdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAic3VtbWFyeSI6CiAgICAgICAgICAgICAgY2FzZSAidWwiOgogICAgICAgICAgICAgIGNhc2UgInByZSI6CiAgICAgICAgICAgICAgY2FzZSAibGlzdGluZyI6CiAgICAgICAgICAgICAgY2FzZSAidGFibGUiOgogICAgICAgICAgICAgIGNhc2UgImhyIjoKICAgICAgICAgICAgICBjYXNlICJ4bXAiOgogICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgY2FzZSAiaDMiOgogICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgY2FzZSAiaDYiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZTsKICAgICAgICAgICAgICBjYXNlICJmb3JtIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uZm9ybVRhZyB8fCBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAibGkiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgIGNhc2UgImRkIjoKICAgICAgICAgICAgICBjYXNlICJkdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgIGNhc2UgImJ1dHRvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiYSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgIm5vYnIiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGlkV2FybiQxID0ge307CiAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcgPSBmdW5jdGlvbihjaGlsZFRhZywgY2hpbGRUZXh0LCBhbmNlc3RvckluZm8pIHsKICAgICAgICAgICAgYW5jZXN0b3JJbmZvID0gYW5jZXN0b3JJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvOwogICAgICAgICAgICB2YXIgcGFyZW50SW5mbyA9IGFuY2VzdG9ySW5mby5jdXJyZW50OwogICAgICAgICAgICB2YXIgcGFyZW50VGFnID0gcGFyZW50SW5mbyAmJiBwYXJlbnRJbmZvLnRhZzsKICAgICAgICAgICAgaWYgKGNoaWxkVGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkVGFnICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3Rpbmc6IHdoZW4gY2hpbGRUZXh0IGlzIHBhc3NlZCwgY2hpbGRUYWcgc2hvdWxkIGJlIG51bGwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGRUYWcgPSAiI3RleHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50ID0gaXNUYWdWYWxpZFdpdGhQYXJlbnQoY2hpbGRUYWcsIHBhcmVudFRhZykgPyBudWxsIDogcGFyZW50SW5mbzsKICAgICAgICAgICAgdmFyIGludmFsaWRBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgPyBudWxsIDogZmluZEludmFsaWRBbmNlc3RvckZvclRhZyhjaGlsZFRhZywgYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGludmFsaWRQYXJlbnRPckFuY2VzdG9yID0gaW52YWxpZFBhcmVudCB8fCBpbnZhbGlkQW5jZXN0b3I7CiAgICAgICAgICAgIGlmICghaW52YWxpZFBhcmVudE9yQW5jZXN0b3IpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2VzdG9yVGFnID0gaW52YWxpZFBhcmVudE9yQW5jZXN0b3IudGFnOwogICAgICAgICAgICB2YXIgd2FybktleSA9ICEhaW52YWxpZFBhcmVudCArICJ8IiArIGNoaWxkVGFnICsgInwiICsgYW5jZXN0b3JUYWc7CiAgICAgICAgICAgIGlmIChkaWRXYXJuJDFbd2FybktleV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybiQxW3dhcm5LZXldID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHRhZ0Rpc3BsYXlOYW1lID0gY2hpbGRUYWc7CiAgICAgICAgICAgIHZhciB3aGl0ZXNwYWNlSW5mbyA9ICIiOwogICAgICAgICAgICBpZiAoY2hpbGRUYWcgPT09ICIjdGV4dCIpIHsKICAgICAgICAgICAgICBpZiAoL1xTLy50ZXN0KGNoaWxkVGV4dCkpIHsKICAgICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIlRleHQgbm9kZXMiOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJXaGl0ZXNwYWNlIHRleHQgbm9kZXMiOwogICAgICAgICAgICAgICAgd2hpdGVzcGFjZUluZm8gPSAiIE1ha2Ugc3VyZSB5b3UgZG9uJ3QgaGF2ZSBhbnkgZXh0cmEgd2hpdGVzcGFjZSBiZXR3ZWVuIHRhZ3Mgb24gZWFjaCBsaW5lIG9mIHlvdXIgc291cmNlIGNvZGUuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiPCIgKyBjaGlsZFRhZyArICI+IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW52YWxpZFBhcmVudCkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKGFuY2VzdG9yVGFnID09PSAidGFibGUiICYmIGNoaWxkVGFnID09PSAidHIiKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICIgQWRkIGEgPHRib2R5PiwgPHRoZWFkPiBvciA8dGZvb3Q+IHRvIHlvdXIgY29kZSB0byBtYXRjaCB0aGUgRE9NIHRyZWUgZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGNoaWxkIG9mIDwlcz4uJXMlcyIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZywgd2hpdGVzcGFjZUluZm8sIGluZm8pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGRlc2NlbmRhbnQgb2YgPCVzPi4iLCB0YWdEaXNwbGF5TmFtZSwgYW5jZXN0b3JUYWcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMSA9ICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciOwogICAgICAgIHZhciBTVVNQRU5TRV9TVEFSVF9EQVRBID0gIiQiOwogICAgICAgIHZhciBTVVNQRU5TRV9FTkRfREFUQSA9ICIvJCI7CiAgICAgICAgdmFyIFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSA9ICIkPyI7CiAgICAgICAgdmFyIFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgPSAiJCEiOwogICAgICAgIHZhciBTVFlMRSQxID0gInN0eWxlIjsKICAgICAgICB2YXIgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgdmFyIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRleHQocm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgdHlwZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2U7CiAgICAgICAgICB2YXIgbm9kZVR5cGUgPSByb290Q29udGFpbmVySW5zdGFuY2Uubm9kZVR5cGU7CiAgICAgICAgICBzd2l0Y2ggKG5vZGVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfTk9ERToKICAgICAgICAgICAgY2FzZSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFOiB7CiAgICAgICAgICAgICAgdHlwZSA9IG5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gIiNkb2N1bWVudCIgOiAiI2ZyYWdtZW50IjsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSByb290Q29udGFpbmVySW5zdGFuY2UuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IHJvb3QzID8gcm9vdDMubmFtZXNwYWNlVVJJIDogZ2V0Q2hpbGROYW1lc3BhY2UobnVsbCwgIiIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyByb290Q29udGFpbmVySW5zdGFuY2UucGFyZW50Tm9kZSA6IHJvb3RDb250YWluZXJJbnN0YW5jZTsKICAgICAgICAgICAgICB2YXIgb3duTmFtZXNwYWNlID0gY29udGFpbmVyMi5uYW1lc3BhY2VVUkkgfHwgbnVsbDsKICAgICAgICAgICAgICB0eXBlID0gY29udGFpbmVyMi50YWdOYW1lOwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKG93bk5hbWVzcGFjZSwgdHlwZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkYXRlZFRhZyA9IHR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8obnVsbCwgdmFsaWRhdGVkVGFnKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENoaWxkSG9zdENvbnRleHQocGFyZW50SG9zdENvbnRleHQsIHR5cGUsIHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50SG9zdENvbnRleHREZXYgPSBwYXJlbnRIb3N0Q29udGV4dDsKICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKHBhcmVudEhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZSwgdHlwZSk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKHBhcmVudEhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRm9yQ29tbWl0KGNvbnRhaW5lckluZm8pIHsKICAgICAgICAgIGV2ZW50c0VuYWJsZWQgPSBpc0VuYWJsZWQoKTsKICAgICAgICAgIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gZ2V0U2VsZWN0aW9uSW5mb3JtYXRpb24oKTsKICAgICAgICAgIHZhciBhY3RpdmVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBzZXRFbmFibGVkKGZhbHNlKTsKICAgICAgICAgIHJldHVybiBhY3RpdmVJbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRBZnRlckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICByZXN0b3JlU2VsZWN0aW9uKHNlbGVjdGlvbkluZm9ybWF0aW9uKTsKICAgICAgICAgIHNldEVuYWJsZWQoZXZlbnRzRW5hYmxlZCk7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gbnVsbDsKICAgICAgICAgIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2UodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHZhciBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcodHlwZSwgbnVsbCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIiArIHByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBvd25BbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHN0cmluZywgb3duQW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJlbnROYW1lc3BhY2UgPSBob3N0Q29udGV4dERldi5uYW1lc3BhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZG9tRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQ0NSh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBwYXJlbnROYW1lc3BhY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgZG9tRWxlbWVudCk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRJbml0aWFsQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGRvbUVsZW1lbnQsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXR1cm4gISFwcm9wcy5hdXRvRm9jdXM7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiAhPT0gdHlwZW9mIG9sZFByb3BzLmNoaWxkcmVuICYmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiB0eXBlID09PSAidGV4dGFyZWEiIHx8IHR5cGUgPT09ICJub3NjcmlwdCIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiIHx8IHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCA9PT0gIm9iamVjdCIgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09IG51bGwgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwuX19odG1sICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHRJbnN0YW5jZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgdGV4dCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0Tm9kZSk7CiAgICAgICAgICByZXR1cm4gdGV4dE5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCkgewogICAgICAgICAgdmFyIGN1cnJlbnRFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgIGlmIChjdXJyZW50RXZlbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRQcmlvcml0eShjdXJyZW50RXZlbnQudHlwZSk7CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgdmFyIGNhbmNlbFRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBub1RpbWVvdXQgPSAtMTsKICAgICAgICB2YXIgbG9jYWxQcm9taXNlID0gdHlwZW9mIFByb21pc2UgPT09ICJmdW5jdGlvbiIgPyBQcm9taXNlIDogdm9pZCAwOwogICAgICAgIHZhciBzY2hlZHVsZU1pY3JvdGFzayA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gImZ1bmN0aW9uIiA/IHF1ZXVlTWljcm90YXNrIDogdHlwZW9mIGxvY2FsUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIgPyBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIGxvY2FsUHJvbWlzZS5yZXNvbHZlKG51bGwpLnRoZW4oY2FsbGJhY2spLmNhdGNoKGhhbmRsZUVycm9ySW5OZXh0VGljayk7CiAgICAgICAgfSA6IHNjaGVkdWxlVGltZW91dDsKICAgICAgICBmdW5jdGlvbiBoYW5kbGVFcnJvckluTmV4dFRpY2soZXJyb3IyKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TW91bnQoZG9tRWxlbWVudCwgdHlwZSwgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuYXV0b0ZvY3VzKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAiaW1nIjogewogICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5zcmMpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQuc3JjID0gbmV3UHJvcHMuc3JjOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCkgewogICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IG5ld1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWN0Um9vdENvbnRhaW5lciA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIGlmICgocmVhY3RSb290Q29udGFpbmVyID09PSBudWxsIHx8IHJlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwKSAmJiBwYXJlbnROb2RlLm9uY2xpY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQocGFyZW50Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnRJbnN0YW5jZSwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0SW5Db250YWluZXJCZWZvcmUoY29udGFpbmVyMiwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGQpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnkocGFyZW50SW5zdGFuY2UsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZTsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbmV4dE5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChuZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMi5wYXJlbnROb2RlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIyLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZTIgPSBpbnN0YW5jZS5zdHlsZTsKICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGUyLnNldFByb3BlcnR5ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eSgiZGlzcGxheSIsICJub25lIiwgImltcG9ydGFudCIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGUyLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlKSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZUluc3RhbmNlKGluc3RhbmNlLCBwcm9wcykgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZVByb3AgPSBwcm9wc1tTVFlMRSQxXTsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gc3R5bGVQcm9wICE9PSB2b2lkIDAgJiYgc3R5bGVQcm9wICE9PSBudWxsICYmIHN0eWxlUHJvcC5oYXNPd25Qcm9wZXJ0eSgiZGlzcGxheSIpID8gc3R5bGVQcm9wLmRpc3BsYXkgOiBudWxsOwogICAgICAgICAgaW5zdGFuY2Uuc3R5bGUuZGlzcGxheSA9IGRhbmdlcm91c1N0eWxlVmFsdWUoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5oaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi50ZXh0Q29udGVudCA9ICIiOwogICAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gRUxFTUVOVF9OT0RFIHx8IHR5cGUudG9Mb3dlckNhc2UoKSAhPT0gaW5zdGFuY2Uubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShpbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgaWYgKHRleHQgPT09ICIiIHx8IGluc3RhbmNlLm5vZGVUeXBlICE9PSBURVhUX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBkYXRhc2V0ID0gaW5zdGFuY2UubmV4dFNpYmxpbmcgJiYgaW5zdGFuY2UubmV4dFNpYmxpbmcuZGF0YXNldDsKICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgICAgZGlnZXN0ID0gZGF0YXNldC5kZ3N0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGRhdGFzZXQubXNnOwogICAgICAgICAgICAgIHN0YWNrID0gZGF0YXNldC5zdGNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgICBkaWdlc3QsCiAgICAgICAgICAgICAgc3RhY2sKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoaW5zdGFuY2UsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RSZXRyeSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZShub2RlKSB7CiAgICAgICAgICBmb3IgKDsgbm9kZSAhPSBudWxsOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgbm9kZURhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShpbnN0YW5jZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudENvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBpbnN0YW5jZSk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGluc3RhbmNlLCBwcm9wcyk7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhpbnN0YW5jZSwgdHlwZSwgcHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRleHRJbnN0YW5jZSk7CiAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHJldHVybiBkaWZmSHlkcmF0ZWRUZXh0KHRleHRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZS5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhub2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHRhcmdldEluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3RhbmNlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50VHlwZSAhPT0gImhlYWQiICYmIHBhcmVudFR5cGUgIT09ICJib2R5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICBpZiAocGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQodGV4dEluc3RhbmNlLm5vZGVWYWx1ZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50SW5zdGFuY2UsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3JIeWRyYXRpbmdDb250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgaHlkcmF0aW9uLiBUaGUgc2VydmVyIEhUTUwgd2FzIHJlcGxhY2VkIHdpdGggY2xpZW50IGNvbnRlbnQgaW4gPCVzPi4iLCBwYXJlbnRDb250YWluZXIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVQb3J0YWxNb3VudChwb3J0YWxJbnN0YW5jZSkgewogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocG9ydGFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICB2YXIgcmFuZG9tS2V5ID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2VLZXkgPSAiX19yZWFjdEZpYmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsUHJvcHNLZXkgPSAiX19yZWFjdFByb3BzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXkgPSAiX19yZWFjdENvbnRhaW5lciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXkgPSAiX19yZWFjdEV2ZW50cyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleSA9ICJfX3JlYWN0TGlzdGVuZXJzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5ID0gIl9fcmVhY3RIYW5kbGVzJCIgKyByYW5kb21LZXk7CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRGVsZXRlZEluc3RhbmNlKG5vZGUpIHsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxQcm9wc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXNTZXRLZXldOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVjYWNoZUZpYmVyTm9kZShob3N0SW5zdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XSA9IGhvc3RJbnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29udGFpbmVyQXNSb290KGhvc3RSb290LCBub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gaG9zdFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVubWFya0NvbnRhaW5lckFzUm9vdChub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250YWluZXJNYXJrZWRBc1Jvb3Qobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0Tm9kZSkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSB0YXJnZXROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHdoaWxlIChwYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRhcmdldEluc3QgPSBwYXJlbnROb2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldIHx8IHBhcmVudE5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHRhcmdldEluc3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0LmNoaWxkICE9PSBudWxsIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXROb2RlKTsKICAgICAgICAgICAgICAgIHdoaWxlIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRTdXNwZW5zZUluc3QgPSBzdXNwZW5zZUluc3RhbmNlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0U3VzcGVuc2VJbnN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFN1c3BlbnNlSW5zdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgaW5zdCA9IG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gfHwgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQgfHwgaW5zdC50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZ2V0Tm9kZUZyb21JbnN0YW5jZTogSW52YWxpZCBhcmd1bWVudC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZVtpbnRlcm5hbFByb3BzS2V5XSB8fCBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKG5vZGUsIHByb3BzKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsUHJvcHNLZXldID0gcHJvcHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TGlzdGVuZXJTZXQobm9kZSkgewogICAgICAgICAgdmFyIGVsZW1lbnRMaXN0ZW5lclNldCA9IG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGlmIChlbGVtZW50TGlzdGVuZXJTZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRMaXN0ZW5lclNldDsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXM0ID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXM0KHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZVN0YWNrID0gW107CiAgICAgICAgdmFyIGZpYmVyU3RhY2s7CiAgICAgICAgewogICAgICAgICAgZmliZXJTdGFjayA9IFtdOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVDdXJzb3IoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjdXJyZW50OiBkZWZhdWx0VmFsdWUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChjdXJzb3IsIGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIgIT09IGZpYmVyU3RhY2tbaW5kZXhdKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgRmliZXIgcG9wcGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlU3RhY2tbaW5kZXhdOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRleC0tOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUsIGZpYmVyKSB7CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBjdXJzb3IuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHQ7CiAgICAgICAgewogICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBlbXB0eUNvbnRleHRPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgfQogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICB2YXIgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihmYWxzZSk7CiAgICAgICAgdmFyIHByZXZpb3VzQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICBmdW5jdGlvbiBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkUHVzaE93bkNvbnRleHRJZlByb3ZpZGVyICYmIGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBtYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPSB1bm1hc2tlZENvbnRleHQ7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gdHlwZS5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlmICghY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICBjb250ZXh0W2tleV0gPSB1bm1hc2tlZENvbnRleHRba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDb250ZXh0Q2hhbmdlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250ZXh0UHJvdmlkZXIodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICByZXR1cm4gY2hpbGRDb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY2hpbGRDb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIsIGNvbnRleHQsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBjb250ZXh0IGZvdW5kIG9uIHN0YWNrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIHR5cGUsIHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNoaWxkQ29udGV4dFR5cGVzIGlzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8gZ2V0Q2hpbGRDb250ZXh0KCkgbWV0aG9kIG9uIHRoZSBpbnN0YW5jZS4gWW91IGNhbiBlaXRoZXIgZGVmaW5lIGdldENoaWxkQ29udGV4dCgpIG9uICVzIG9yIHJlbW92ZSBjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0ID0gaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KCk7CiAgICAgICAgICAgIGZvciAodmFyIGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgaWYgKCEoY29udGV4dEtleSBpbiBjaGlsZENvbnRleHRUeXBlcykpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKSArICcuZ2V0Q2hpbGRDb250ZXh0KCk6IGtleSAiJyArIGNvbnRleHRLZXkgKyAnIiBpcyBub3QgZGVmaW5lZCBpbiBjaGlsZENvbnRleHRUeXBlcy4nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNoaWxkQ29udGV4dFR5cGVzLCBjaGlsZENvbnRleHQsICJjaGlsZCBjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzc2lnbjIoe30sIHBhcmVudENvbnRleHQsIGNoaWxkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHZhciBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0IHx8IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgcHJldmlvdXNDb250ZXh0ID0gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgdHlwZSwgZGlkQ2hhbmdlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYW4gaW5zdGFuY2UgYnkgdGhpcyBwb2ludC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkQ2hhbmdlKSB7CiAgICAgICAgICAgICAgdmFyIG1lcmdlZENvbnRleHQgPSBwcm9jZXNzQ2hpbGRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdHlwZSwgcHJldmlvdXNDb250ZXh0KTsKICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IG1lcmdlZENvbnRleHQ7CiAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVyZ2VkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmliZXJNb3VudGVkKGZpYmVyKSB8fCBmaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBzdWJ0cmVlIHBhcmVudCB0byBiZSBhIG1vdW50ZWQgY2xhc3MgY29tcG9uZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuY29udGV4dDsKICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IG5vZGUudHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRm91bmQgdW5leHBlY3RlZCBkZXRhY2hlZCBzdWJ0cmVlIHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIExlZ2FjeVJvb3QgPSAwOwogICAgICAgIHZhciBDb25jdXJyZW50Um9vdCA9IDE7CiAgICAgICAgdmFyIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgdmFyIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgIHZhciBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChzeW5jUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgc3luY1F1ZXVlID0gW2NhbGxiYWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN5bmNRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IHRydWU7CiAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKSB7CiAgICAgICAgICBpZiAoaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmNDYWxsYmFja3MoKSB7CiAgICAgICAgICBpZiAoIWlzRmx1c2hpbmdTeW5jUXVldWUgJiYgc3luY1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSB0cnVlOwogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZVByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGlzU3luYyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gc3luY1F1ZXVlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHF1ZXVlW2ldOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKGlzU3luYyk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IHN5bmNRdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2soSW1tZWRpYXRlUHJpb3JpdHksIGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1VwZGF0ZVByaW9yaXR5KTsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgZm9ya1N0YWNrID0gW107CiAgICAgICAgdmFyIGZvcmtTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUZvcmtQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVGb3JrQ291bnQgPSAwOwogICAgICAgIHZhciBpZFN0YWNrID0gW107CiAgICAgICAgdmFyIGlkU3RhY2tJbmRleCA9IDA7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBudWxsOwogICAgICAgIHZhciB0cmVlQ29udGV4dElkID0gMTsKICAgICAgICB2YXIgdHJlZUNvbnRleHRPdmVyZmxvdyA9ICIiOwogICAgICAgIGZ1bmN0aW9uIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9ya2VkKSAhPT0gTm9GbGFnczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rm9ya3NBdExldmVsKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICByZXR1cm4gdHJlZUZvcmtDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJlZUlkKCkgewogICAgICAgICAgdmFyIG92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIHZhciBpZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBpZCA9IGlkV2l0aExlYWRpbmdCaXQgJiB+Z2V0TGVhZGluZ0JpdChpZFdpdGhMZWFkaW5nQml0KTsKICAgICAgICAgIHJldHVybiBpZC50b1N0cmluZygzMikgKyBvdmVyZmxvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVGb3JrKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya0NvdW50OwogICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtQcm92aWRlcjsKICAgICAgICAgIHRyZWVGb3JrUHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB0cmVlRm9ya0NvdW50ID0gdG90YWxDaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIHRvdGFsQ2hpbGRyZW4sIGluZGV4MikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdmFyIGJhc2VJZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBiYXNlT3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGJhc2VMZW5ndGggPSBnZXRCaXRMZW5ndGgoYmFzZUlkV2l0aExlYWRpbmdCaXQpIC0gMTsKICAgICAgICAgIHZhciBiYXNlSWQgPSBiYXNlSWRXaXRoTGVhZGluZ0JpdCAmIH4oMSA8PCBiYXNlTGVuZ3RoKTsKICAgICAgICAgIHZhciBzbG90ID0gaW5kZXgyICsgMTsKICAgICAgICAgIHZhciBsZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyBiYXNlTGVuZ3RoOwogICAgICAgICAgaWYgKGxlbmd0aCA+IDMwKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZk92ZXJmbG93Qml0cyA9IGJhc2VMZW5ndGggLSBiYXNlTGVuZ3RoICUgNTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93Qml0cyA9ICgxIDw8IG51bWJlck9mT3ZlcmZsb3dCaXRzKSAtIDE7CiAgICAgICAgICAgIHZhciBuZXdPdmVyZmxvdyA9IChiYXNlSWQgJiBuZXdPdmVyZmxvd0JpdHMpLnRvU3RyaW5nKDMyKTsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VJZCA9IGJhc2VJZCA+PiBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VMZW5ndGggPSBiYXNlTGVuZ3RoIC0gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgIHZhciByZXN0T2ZMZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgcmVzdE9mTmV3Qml0cyA9IHNsb3QgPDwgcmVzdE9mQmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIGlkID0gcmVzdE9mTmV3Qml0cyB8IHJlc3RPZkJhc2VJZDsKICAgICAgICAgICAgdmFyIG92ZXJmbG93ID0gbmV3T3ZlcmZsb3cgKyBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IHJlc3RPZkxlbmd0aCB8IGlkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gb3ZlcmZsb3c7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV3Qml0cyA9IHNsb3QgPDwgYmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIF9pZCA9IG5ld0JpdHMgfCBiYXNlSWQ7CiAgICAgICAgICAgIHZhciBfb3ZlcmZsb3cgPSBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IGxlbmd0aCB8IF9pZDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IF9vdmVyZmxvdzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IDE7CiAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSAwOwogICAgICAgICAgICBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MsIHNsb3RJbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEJpdExlbmd0aChudW1iZXI0KSB7CiAgICAgICAgICByZXR1cm4gMzIgLSBjbHozMihudW1iZXI0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZGluZ0JpdChpZCkgewogICAgICAgICAgcmV0dXJuIDEgPDwgZ2V0Qml0TGVuZ3RoKGlkKSAtIDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUZvcmtQcm92aWRlcikgewogICAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gZm9ya1N0YWNrWy0tZm9ya1N0YWNrSW5kZXhdOwogICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAodHJlZUNvbnRleHRQcm92aWRlciAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGlkOiB0cmVlQ29udGV4dElkLAogICAgICAgICAgICAgIG92ZXJmbG93OiB0cmVlQ29udGV4dE92ZXJmbG93CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN1c3BlbmRlZFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuZGVkQ29udGV4dCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dElkID0gc3VzcGVuZGVkQ29udGV4dC5pZDsKICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBzdXNwZW5kZWRDb250ZXh0Lm92ZXJmbG93OwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmTm90SHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gYmUgaHlkcmF0aW5nLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgIHZhciBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB2YXIgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB2YXIgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuSWZIeWRyYXRpbmcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGluZykgewogICAgICAgICAgICAgIGVycm9yKCJXZSBzaG91bGQgbm90IGJlIGh5ZHJhdGluZyBoZXJlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhIGJ1Zy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVySHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudEluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIsIHN1c3BlbnNlSW5zdGFuY2UsIHRyZWVDb250ZXh0KSB7CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dChmaWJlciwgdHJlZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnR5cGUsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHMsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjaGlsZFRvRGVsZXRlXTsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRPckVycm9yREVWKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgIF9wcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBfaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIF90ZXh0LAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfcGFyZW50SW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoX3BhcmVudEluc3RhbmNlICE9PSBudWxsKSBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wczIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdHlwZTIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dDIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3RleHQyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICBmaWJlci5mbGFncyA9IGZpYmVyLmZsYWdzICYgfkh5ZHJhdGluZyB8IFBsYWNlbWVudDsKICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjYW5IeWRyYXRlSW5zdGFuY2UobmV4dEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHRleHRJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IHN1c3BlbnNlSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIHRyZWVDb250ZXh0OiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpLAogICAgICAgICAgICAgICAgICByZXRyeUxhbmU6IE9mZnNjcmVlbkxhbmUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFN0YXRlID0gc3VzcGVuc2VTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkRnJhZ21lbnQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICBmaWJlci5jaGlsZCA9IGRlaHlkcmF0ZWRGcmFnbWVudDsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmIChmaWJlci5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSHlkcmF0aW9uIGZhaWxlZCBiZWNhdXNlIHRoZSBpbml0aWFsIFVJIGRvZXMgbm90IG1hdGNoIHdoYXQgd2FzIHJlbmRlcmVkIG9uIHRoZSBzZXJ2ZXIuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEF0dGVtcHRlZEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgaWYgKCF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgcHJldkh5ZHJhdGlvblBhcmVudEZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlIHx8ICF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciwgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoZmliZXIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRXYXJuSWZNaXNtYXRjaERldiA9ICFkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCBmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBmaWJlciwgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYpOwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gZmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkQ29udGFpbmVyVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUyID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlMgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2tpcFBhc3REZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHBhcmVudC50YWcgIT09IEhvc3RSb290ICYmIHBhcmVudC50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IHBhcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlciAhPT0gaHlkcmF0aW9uUGFyZW50RmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBIb3N0Um9vdCAmJiAoZmliZXIudGFnICE9PSBIb3N0Q29tcG9uZW50IHx8IHNob3VsZERlbGV0ZVVuaHlkcmF0ZWRUYWlsSW5zdGFuY2VzKGZpYmVyLnR5cGUpICYmICFzaG91bGRTZXRUZXh0Q29udGVudChmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzKSkpIHsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICAgIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpOwogICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvblBhcmVudEZpYmVyID8gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpYmVyLnN0YXRlTm9kZSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmcgJiYgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVW5oeWRyYXRlZFRhaWxOb2RlcyhmaWJlcikgewogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoaHlkcmF0aW9uRXJyb3JzKTsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNIeWRyYXRpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSHlkcmF0aW9uRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgTm9UcmFuc2l0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMS50cmFuc2l0aW9uOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MgPSB7CiAgICAgICAgICByZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5nczogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfSwKICAgICAgICAgIHJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBmbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNjYXJkUGVuZGluZ1dhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBmaW5kU3RyaWN0Um9vdCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBtYXliZVN0cmljdFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXliZVN0cmljdFJvb3QgPSBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heWJlU3RyaWN0Um9vdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc2V0VG9Tb3J0ZWRTdHJpbmcgPSBmdW5jdGlvbihzZXQ0KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBzZXQ0LmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheS5zb3J0KCkuam9pbigiLCAiKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIC8vIERvbid0IHdhcm4gYWJvdXQgcmVhY3QtbGlmZWN5Y2xlcy1jb21wYXQgcG9seWZpbGxlZCBjb21wb25lbnRzLgogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIHNvcnRlZE5hbWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMiA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczMgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxNb3VudCBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxNb3VudCB0byBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNCA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuKiBSZW5hbWUgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXM0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczUgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4zKCJjb21wb25lbnRXaWxsVXBkYXRlIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxVcGRhdGUgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBzdHJpY3RSb290ID0gZmluZFN0cmljdFJvb3QoZmliZXIpOwogICAgICAgICAgICBpZiAoc3RyaWN0Um9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgU3RyaWN0TW9kZSBjb21wb25lbnQgaW4gYSBzdHJpY3QgbW9kZSB0cmVlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdhcm5pbmdzRm9yUm9vdCA9IHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5nZXQoc3RyaWN0Um9vdCk7CiAgICAgICAgICAgIGlmIChmaWJlci50eXBlLmNvbnRleHRUeXBlcyAhPSBudWxsIHx8IGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzRm9yUm9vdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QgPSBbXTsKICAgICAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5zZXQoc3RyaWN0Um9vdCwgd2FybmluZ3NGb3JSb290KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290LnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZm9yRWFjaChmdW5jdGlvbihmaWJlckFycmF5LCBzdHJpY3RSb290KSB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmaXJzdEZpYmVyID0gZmliZXJBcnJheVswXTsKICAgICAgICAgICAgICB2YXIgdW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGZpYmVyQXJyYXkuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKHVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpcnN0RmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkxlZ2FjeSBjb250ZXh0IEFQSSBoYXMgYmVlbiBkZXRlY3RlZCB3aXRoaW4gYSBzdHJpY3QtbW9kZSB0cmVlLlxuXG5UaGUgb2xkIEFQSSB3aWxsIGJlIHN1cHBvcnRlZCBpbiBhbGwgMTYueCByZWxlYXNlcywgYnV0IGFwcGxpY2F0aW9ucyB1c2luZyBpdCBzaG91bGQgbWlncmF0ZSB0byB0aGUgbmV3IHZlcnNpb24uXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlc1xuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5kaXNjYXJkUGVuZGluZ1dhcm5pbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdlbmVyYXRvcnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZzsKICAgICAgICB2YXIgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nOwogICAgICAgIHZhciB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgICBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmcgPSB7fTsKICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIGlmIChjaGlsZCA9PT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2hpbGQuX3N0b3JlIHx8IGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgfHwgY2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZC5fc3RvcmUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdCBDb21wb25lbnQgaW4gd2FybkZvck1pc3NpbmdLZXkgc2hvdWxkIGhhdmUgYSBfc3RvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZWFjdENsYXNzKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLnByb3RvdHlwZSAmJiB0eXBlLnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50KSB7CiAgICAgICAgICB2YXIgbWl4ZWRSZWYgPSBlbGVtZW50LnJlZjsKICAgICAgICAgIGlmIChtaXhlZFJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKChyZXR1cm5GaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSB8fCB3YXJuQWJvdXRTdHJpbmdSZWZzKSAmJiAvLyBXZSB3YXJuIGluIFJlYWN0RWxlbWVudC5qcyBpZiBvd25lciBhbmQgc2VsZiBhcmUgZXF1YWwgZm9yIHN0cmluZyByZWZzCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSB0aGVzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24KICAgICAgICAgICAgICAvLyB1c2luZyBhIGNvZGVtb2QuIFRoZXJlZm9yZSwgd2UgZG9uJ3QgaGF2ZSB0byB3YXJuIGFib3V0IHN0cmluZyByZWZzIGFnYWluLgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fc2VsZiAmJiBlbGVtZW50Ll9vd25lci5zdGF0ZU5vZGUgIT09IGVsZW1lbnQuX3NlbGYpICYmIC8vIFdpbGwgYWxyZWFkeSB0aHJvdyB3aXRoICJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzIgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgJiYgLy8gV2lsbCBhbHJlYWR5IHdhcm4gd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcyIKICAgICAgICAgICAgICAhKHR5cGVvZiBlbGVtZW50LnR5cGUgPT09ICJmdW5jdGlvbiIgJiYgIWlzUmVhY3RDbGFzcyhlbGVtZW50LnR5cGUpKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoc29tZVN0cmluZ1JlZikgYnV0IG5vIG93bmVyIHdhcyBzZXQiCiAgICAgICAgICAgICAgZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBtaXhlZFJlZik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0OwogICAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICAgIGlmIChvd25lckZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5zdCA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWluc3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBvd25lciBmb3Igc3RyaW5nIHJlZiAiICsgbWl4ZWRSZWYgKyAiLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRJbnN0ID0gaW5zdDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbihtaXhlZFJlZiwgInJlZiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQucmVmICE9PSBudWxsICYmIHR5cGVvZiBjdXJyZW50NC5yZWYgPT09ICJmdW5jdGlvbiIgJiYgY3VycmVudDQucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ0LnJlZjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IHJlc29sdmVkSW5zdC5yZWZzOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZWZzW3N0cmluZ1JlZl07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWZzW3N0cmluZ1JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJlZi5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgICAgICAgIHJldHVybiByZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaXhlZFJlZiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVmIHRvIGJlIGEgZnVuY3Rpb24sIGEgc3RyaW5nLCBhbiBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlUmVmKCksIG9yIG51bGwuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoIiArIG1peGVkUmVmICsgIikgYnV0IG5vIG93bmVyIHdhcyBzZXQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1heSBiZSBhZGRpbmcgYSByZWYgdG8gYSBmdW5jdGlvbiBjb21wb25lbnRcbjIuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgY29tcG9uZW50IHRoYXQgd2FzIG5vdCBjcmVhdGVkIGluc2lkZSBhIGNvbXBvbmVudCdzIHJlbmRlciBtZXRob2RcbjMuIFlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBsb2FkZWRcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVmcy1tdXN0LWhhdmUtb3duZXIgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICAgICAgIHZhciBjaGlsZFN0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChuZXdDaGlsZCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZFN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKG5ld0NoaWxkKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRTdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9ucyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQuIFRoaXMgbWF5IGhhcHBlbiBpZiB5b3UgcmV0dXJuIGEgQ29tcG9uZW50IGluc3RlYWQgb2YgPENvbXBvbmVudCAvPiBmcm9tIHJlbmRlci4gT3IgbWF5YmUgeW91IG1lYW50IHRvIGNhbGwgdGhpcyBmdW5jdGlvbiByYXRoZXIgdGhhbiByZXR1cm4gaXQuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVMYXp5KGxhenlUeXBlKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlUeXBlLl9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5VHlwZS5faW5pdDsKICAgICAgICAgIHJldHVybiBpbml0KHBheWxvYWQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDaGlsZFJlY29uY2lsZXIoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpIHsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZFRvRGVsZXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIGNoaWxkVG9EZWxldGUgPSBjaGlsZFRvRGVsZXRlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChleGlzdGluZ0NoaWxkLmtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLnNldChleGlzdGluZ0NoaWxkLmluZGV4LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZCA9IGV4aXN0aW5nQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUZpYmVyKGZpYmVyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoZmliZXIsIHBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIGNsb25lLmluZGV4ID0gMDsKICAgICAgICAgICAgY2xvbmUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gRm9ya2VkOwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gbmV3RmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkSW5kZXggPSBjdXJyZW50NC5pbmRleDsKICAgICAgICAgICAgICBpZiAob2xkSW5kZXggPCBsYXN0UGxhY2VkSW5kZXgpIHsKICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlU2luZ2xlQ2hpbGQobmV3RmliZXIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdGaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50NCwgdGV4dENvbnRlbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudDQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gSG9zdFBvcnRhbCB8fCBjdXJyZW50NC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyAhPT0gcG9ydGFsLmNvbnRhaW5lckluZm8gfHwgY3VycmVudDQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uICE9PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQ0LCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZnJhZ21lbnQsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gRnJhZ21lbnQxMCkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZnJhZ21lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIGZyYWdtZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQoIiIgKyBuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgbnVsbCwgbmV3Q2hpbGQpOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQyID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkMi5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQzID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBudWxsKTsKICAgICAgICAgICAgICAgIF9jcmVhdGVkMy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG9sZEZpYmVyICE9PSBudWxsID8gb2xkRmliZXIua2V5IDogbnVsbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBvbGRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdDaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBtYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBtYXRjaGVkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyMiwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyMyA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIzLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkICE9PSAib2JqZWN0IiB8fCBjaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleShjaGlsZCwgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgICB2YXIga2V5ID0gY2hpbGQua2V5OwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoa25vd25LZXlzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAga25vd25LZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFrbm93bktleXMuaGFzKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IoIkVuY291bnRlcmVkIHR3byBjaGlsZHJlbiB3aXRoIHRoZSBzYW1lIGtleSwgYCVzYC4gS2V5cyBzaG91bGQgYmUgdW5pcXVlIHNvIHRoYXQgY29tcG9uZW50cyBtYWludGFpbiB0aGVpciBpZGVudGl0eSBhY3Jvc3MgdXBkYXRlcy4gTm9uLXVuaXF1ZSBrZXlzIG1heSBjYXVzZSBjaGlsZHJlbiB0byBiZSBkdXBsaWNhdGVkIGFuZC9vciBvbWl0dGVkIFx1MjAxNCB0aGUgYmVoYXZpb3IgaXMgdW5zdXBwb3J0ZWQgYW5kIGNvdWxkIGNoYW5nZSBpbiBhIGZ1dHVyZSB2ZXJzaW9uLiIsIGtleSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gY2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gY2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRLZXkoaW5pdChwYXlsb2FkKSwga25vd25LZXlzLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuLCBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3Q2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld0lkeCA9PT0gbmV3Q2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlciA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7IG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMiA9IHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMi5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmRlbGV0ZShfbmV3RmliZXIyLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IF9uZXdGaWJlcjIua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkMik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MyID0gbmV3SWR4OwogICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZHJlbkl0ZXJhYmxlLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gb2JqZWN0IGlzIG5vdCBhbiBpdGVyYWJsZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgLy8gJEZsb3dGaXhNZSBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCB0b1N0cmluZ1RhZwogICAgICAgICAgICAgIG5ld0NoaWxkcmVuSXRlcmFibGVbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gIkdlbmVyYXRvciIpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0R2VuZXJhdG9ycykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgR2VuZXJhdG9ycyBhcyBjaGlsZHJlbiBpcyB1bnN1cHBvcnRlZCBhbmQgd2lsbCBsaWtlbHkgeWllbGQgdW5leHBlY3RlZCByZXN1bHRzIGJlY2F1c2UgZW51bWVyYXRpbmcgYSBnZW5lcmF0b3IgbXV0YXRlcyBpdC4gWW91IG1heSBjb252ZXJ0IGl0IHRvIGFuIGFycmF5IHdpdGggYEFycmF5LmZyb20oKWAgb3IgdGhlIGBbLi4uc3ByZWFkXWAgb3BlcmF0b3IgYmVmb3JlIHJlbmRlcmluZy4gS2VlcCBpbiBtaW5kIHlvdSBtaWdodCBuZWVkIHRvIHBvbHlmaWxsIHRoZXNlIGZlYXR1cmVzIGZvciBvbGRlciBicm93c2Vycy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW5JdGVyYWJsZS5lbnRyaWVzID09PSBpdGVyYXRvckZuKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1hcHMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgX25ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICAgIGlmIChfbmV3Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIHZhciBrbm93bktleXMgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIF9zdGVwID0gX25ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgICAgIGZvciAoOyAhX3N0ZXAuZG9uZTsgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IF9zdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gaXRlcmFibGUgb2JqZWN0IHByb3ZpZGVkIG5vIGl0ZXJhdG9yLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHRpbmdGaXJzdENoaWxkID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzTmV3RmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIGxhc3RQbGFjZWRJbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBuZXdJZHggPSAwOwogICAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCk7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0ZXAuZG9uZSkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMyA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyMywgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXI0ID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXI0LmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjQua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyNC5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjQsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczQgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCB0ZXh0Q29udGVudCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRGaXJzdENoaWxkICE9PSBudWxsICYmIGN1cnJlbnRGaXJzdENoaWxkLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEZyYWdtZW50MTApIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICAgICAgaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGNoaWxkLCBlbGVtZW50KSB8fCAvLyBMYXp5IHR5cGVzIHNob3VsZCByZWNvbmNpbGUgdGhlaXIgcmVzb2x2ZWQgdHlwZS4KICAgICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBkbyB0aGlzIGFmdGVyIHRoZSBIb3QgUmVsb2FkaW5nIGNoZWNrIGFib3ZlLAogICAgICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAgICAgLy8gaXQgZG9lc24ndCByZXN1c3BlbmQuIFNvIHdlIGNhbid0IGxldCB0aGUgY2FsbCBiZWxvdyBzdXNwZW5kLgogICAgICAgICAgICAgICAgICB0eXBlb2YgZWxlbWVudFR5cGUgPT09ICJvYmplY3QiICYmIGVsZW1lbnRUeXBlICE9PSBudWxsICYmIGVsZW1lbnRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgJiYgcmVzb2x2ZUxhenkoZWxlbWVudFR5cGUpID09PSBjaGlsZC50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICAgIHZhciBfZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY2hpbGQsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBfZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50LnR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQ0ID0gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgX2NyZWF0ZWQ0LnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGVsZW1lbnQpOwogICAgICAgICAgICAgIF9jcmVhdGVkNC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBwb3J0YWwsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBwb3J0YWwua2V5OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQudGFnID09PSBIb3N0UG9ydGFsICYmIGNoaWxkLnN0YXRlTm9kZS5jb250YWluZXJJbmZvID09PSBwb3J0YWwuY29udGFpbmVySW5mbyAmJiBjaGlsZC5zdGF0ZU5vZGUuaW1wbGVtZW50YXRpb24gPT09IHBvcnRhbC5pbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZEZpYmVyczIocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGlzVW5rZXllZFRvcExldmVsRnJhZ21lbnQgPSB0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsICYmIG5ld0NoaWxkLnR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgJiYgbmV3Q2hpbGQua2V5ID09PSBudWxsOwogICAgICAgICAgICBpZiAoaXNVbmtleWVkVG9wTGV2ZWxGcmFnbWVudCkgewogICAgICAgICAgICAgIG5ld0NoaWxkID0gbmV3Q2hpbGQucHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsYWNlU2luZ2xlQ2hpbGQocmVjb25jaWxlU2luZ2xlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsYWNlU2luZ2xlQ2hpbGQocmVjb25jaWxlU2luZ2xlUG9ydGFsKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkRmliZXJzMihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuQXJyYXkocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkl0ZXJhdG9yKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsICIiICsgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkRmliZXJzMjsKICAgICAgICB9CiAgICAgICAgdmFyIHJlY29uY2lsZUNoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKHRydWUpOwogICAgICAgIHZhciBtb3VudENoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKGZhbHNlKTsKICAgICAgICBmdW5jdGlvbiBjbG9uZUNoaWxkRmliZXJzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgIT09IGN1cnJlbnQ0LmNoaWxkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVzdW1pbmcgd29yayBub3QgeWV0IGltcGxlbWVudGVkLiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudENoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG5ld0NoaWxkOwogICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZC5zaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnRDaGlsZC5zaWJsaW5nOwogICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnNpYmxpbmcgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIGN1cnJlbnRDaGlsZC5wZW5kaW5nUHJvcHMpOwogICAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB9CiAgICAgICAgICBuZXdDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRXb3JrSW5Qcm9ncmVzcyhjaGlsZCwgbGFuZXMpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZUN1cnNvciA9IGNyZWF0ZUN1cnNvcihudWxsKTsKICAgICAgICB2YXIgcmVuZGVyZXJTaWdpbDsKICAgICAgICB7CiAgICAgICAgICByZW5kZXJlclNpZ2lsID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgdmFyIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKSB7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hQcm92aWRlcihwcm92aWRlckZpYmVyLCBjb250ZXh0LCBuZXh0VmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcHVzaCh2YWx1ZUN1cnNvciwgY29udGV4dC5fY3VycmVudFZhbHVlLCBwcm92aWRlckZpYmVyKTsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gbmV4dFZhbHVlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gdm9pZCAwICYmIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gbnVsbCAmJiBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IHJlbmRlcmVyU2lnaWwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJEZXRlY3RlZCBtdWx0aXBsZSByZW5kZXJlcnMgY29uY3VycmVudGx5IHJlbmRlcmluZyB0aGUgc2FtZSBjb250ZXh0IHByb3ZpZGVyLiBUaGlzIGlzIGN1cnJlbnRseSB1bnN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyID0gcmVuZGVyZXJTaWdpbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BQcm92aWRlcihjb250ZXh0LCBwcm92aWRlckZpYmVyKSB7CiAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gdmFsdWVDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHBvcCh2YWx1ZUN1cnNvciwgcHJvdmlkZXJGaWJlcik7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChwYXJlbnQsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHBhcmVudDsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBub2RlLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgbm9kZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhub2RlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhbHRlcm5hdGUgIT09IG51bGwgJiYgIWlzU3Vic2V0T2ZMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobm9kZSAhPT0gcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByb3BhZ2F0aW9uIHJvb3Qgd2hlbiBzY2hlZHVsaW5nIGNvbnRleHQgd29yay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2VfZWFnZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgZmliZXIucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXh0RmliZXIgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBsaXN0ID0gZmliZXIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICBpZiAobGlzdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIHZhciBkZXBlbmRlbmN5ID0gbGlzdC5maXJzdENvbnRleHQ7CiAgICAgICAgICAgICAgd2hpbGUgKGRlcGVuZGVuY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChkZXBlbmRlbmN5LmNvbnRleHQgPT09IGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgc2hhcmVkUXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKGZpYmVyLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgbGlzdC5sYW5lcyA9IG1lcmdlTGFuZXMobGlzdC5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXBlbmRlbmN5ID0gZGVwZW5kZW5jeS5uZXh0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLnR5cGUgPT09IHdvcmtJblByb2dyZXNzMi50eXBlID8gbnVsbCA6IGZpYmVyLmNoaWxkOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpYmVyLnRhZyA9PT0gRGVoeWRyYXRlZEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudFN1c3BlbnNlID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBqdXN0IGNhbWUgZnJvbSBhIHBhcmVudCBzbyB3ZSBtdXN0IGhhdmUgaGFkIGEgcGFyZW50LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZS5sYW5lcyA9IG1lcmdlTGFuZXMocGFyZW50U3VzcGVuc2UubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9hbHRlcm5hdGUgPSBwYXJlbnRTdXNwZW5zZS5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKF9hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIF9hbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKF9hbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50U3VzcGVuc2UsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXh0RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgd2hpbGUgKG5leHRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5leHRGaWJlciA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBuZXh0RmliZXIuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gc2libGluZzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBuZXh0RmliZXIucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlciA9IG5leHRGaWJlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB2YXIgZGVwZW5kZW5jaWVzID0gd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llczsKICAgICAgICAgIGlmIChkZXBlbmRlbmNpZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBmaXJzdENvbnRleHQgPSBkZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgIGlmIChmaXJzdENvbnRleHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKGRlcGVuZGVuY2llcy5sYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYWRDb250ZXh0KGNvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYpIHsKICAgICAgICAgICAgICBlcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgIGlmIChsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPT09IGNvbnRleHQpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY29udGV4dEl0ZW0gPSB7CiAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICBtZW1vaXplZFZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChsYXN0Q29udGV4dERlcGVuZGVuY3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGNvbnRleHRJdGVtOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyLmRlcGVuZGVuY2llcyA9IHsKICAgICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjb250ZXh0SXRlbQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbGFzdENvbnRleHREZXBlbmRlbmN5Lm5leHQgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgY29uY3VycmVudFF1ZXVlcyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSkgewogICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcyA9IFtxdWV1ZV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzLnB1c2gocXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCkgewogICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb25jdXJyZW50UXVldWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gY29uY3VycmVudFF1ZXVlc1tpXTsKICAgICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkVXBkYXRlID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZFVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIGZpcnN0SW50ZXJsZWF2ZWRVcGRhdGUgPSBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgIHZhciBsYXN0UGVuZGluZ1VwZGF0ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAobGFzdFBlbmRpbmdVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0UGVuZGluZ1VwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICAgIGxhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBmaXJzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgICAgICBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBsYXN0SW50ZXJsZWF2ZWRVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlQW5kRWFnZXJseUJhaWxvdXQoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSkgewogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVuc2FmZV9tYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdCA9IG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290OwogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KHNvdXJjZUZpYmVyLCBsYW5lKSB7CiAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoc291cmNlRmliZXIubGFuZXMsIGxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlID09PSBudWxsICYmIChzb3VyY2VGaWJlci5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZSA9IHNvdXJjZUZpYmVyOwogICAgICAgICAgdmFyIHBhcmVudCA9IHNvdXJjZUZpYmVyLnJldHVybjsKICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcGFyZW50LmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKHBhcmVudC5jaGlsZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgYWx0ZXJuYXRlID0gcGFyZW50LmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKChwYXJlbnQuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHZhciByb290MyA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFVwZGF0ZVN0YXRlID0gMDsKICAgICAgICB2YXIgUmVwbGFjZVN0YXRlID0gMTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGUgPSAyOwogICAgICAgIHZhciBDYXB0dXJlVXBkYXRlID0gMzsKICAgICAgICB2YXIgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZTsKICAgICAgICB2YXIgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemVVcGRhdGVRdWV1ZShmaWJlcikgewogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBiYXNlU3RhdGU6IGZpYmVyLm1lbW9pemVkU3RhdGUsCiAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG51bGwsCiAgICAgICAgICAgIHNoYXJlZDogewogICAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWZmZWN0czogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5maXJzdEJhc2VVcGRhdGUsCiAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSwKICAgICAgICAgICAgICBzaGFyZWQ6IGN1cnJlbnRRdWV1ZS5zaGFyZWQsCiAgICAgICAgICAgICAgZWZmZWN0czogY3VycmVudFF1ZXVlLmVmZmVjdHMKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY2xvbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGV2ZW50VGltZSwKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgdGFnOiBVcGRhdGVTdGF0ZSwKICAgICAgICAgICAgcGF5bG9hZDogbnVsbCwKICAgICAgICAgICAgY2FsbGJhY2s6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID09PSBzaGFyZWRRdWV1ZSAmJiAhZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSkgewogICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgKHNldFN0YXRlLCByZXBsYWNlU3RhdGUsIG9yIGZvcmNlVXBkYXRlKSB3YXMgc2NoZWR1bGVkIGZyb20gaW5zaWRlIGFuIHVwZGF0ZSBmdW5jdGlvbi4gVXBkYXRlIGZ1bmN0aW9ucyBzaG91bGQgYmUgcHVyZSwgd2l0aCB6ZXJvIHNpZGUtZWZmZWN0cy4gQ29uc2lkZXIgdXNpbmcgY29tcG9uZW50RGlkVXBkYXRlIG9yIGEgY2FsbGJhY2suIik7CiAgICAgICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoKSkgewogICAgICAgICAgICB2YXIgcGVuZGluZyA9IHNoYXJlZFF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNoYXJlZFF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgICAgIHJldHVybiB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGVucXVldWVDb25jdXJyZW50Q2xhc3NVcGRhdGUoZmliZXIsIHNoYXJlZFF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBzaGFyZWRRdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgc2hhcmVkUXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGNhcHR1cmVkVXBkYXRlKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgICB2YXIgbmV3Rmlyc3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdMYXN0ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgIGlmIChmaXJzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZS5ldmVudFRpbWUsCiAgICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlLmxhbmUsCiAgICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgICAgIG5ld0xhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZSA9IHsKICAgICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbmV3Rmlyc3QsCiAgICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogbmV3TGFzdCwKICAgICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBxdWV1ZTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUubmV4dCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMsIGluc3RhbmNlKSB7CiAgICAgICAgICBzd2l0Y2ggKHVwZGF0ZS50YWcpIHsKICAgICAgICAgICAgY2FzZSBSZXBsYWNlU3RhdGU6IHsKICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dFN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGF5bG9hZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENhcHR1cmVVcGRhdGU6IHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBVcGRhdGVTdGF0ZTogewogICAgICAgICAgICAgIHZhciBfcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBfcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBfcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBfcGF5bG9hZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFzc2lnbjIoe30sIHByZXZTdGF0ZSwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcmNlVXBkYXRlOiB7CiAgICAgICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIHByb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGxhc3RQZW5kaW5nVXBkYXRlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICB2YXIgZmlyc3RQZW5kaW5nVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IG51bGw7CiAgICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICB2YXIgY3VycmVudExhc3RCYXNlVXBkYXRlID0gY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgIT09IGxhc3RCYXNlVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudExhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50TGFzdEJhc2VVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBxdWV1ZS5iYXNlU3RhdGU7CiAgICAgICAgICAgIHZhciBuZXdMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3Rmlyc3RCYXNlVXBkYXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0xhc3RCYXNlVXBkYXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gdXBkYXRlLmxhbmU7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUV2ZW50VGltZSA9IHVwZGF0ZS5ldmVudFRpbWU7CiAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMocmVuZGVyTGFuZXMyLCB1cGRhdGVMYW5lKSkgewogICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlTGFuZSwKICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdGaXJzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZSA9IGNsb25lOwogICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3TGFuZXMgPSBtZXJnZUxhbmVzKG5ld0xhbmVzLCB1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGVFdmVudFRpbWUsCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gVXNpbmcgTm9MYW5lIHdvcmtzIGJlY2F1c2UgMCBpcyBhIHN1YnNldCBvZiBhbGwgYml0bWFza3MsIHNvCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG5ldmVyIGJlIHNraXBwZWQgYnkgdGhlIGNoZWNrIGFib3ZlLgogICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IF9jbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgbmV3U3RhdGUsIHByb3BzLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSB1cGRhdGUuY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgLy8gSWYgdGhlIHVwZGF0ZSB3YXMgYWxyZWFkeSBjb21taXR0ZWQsIHdlIHNob3VsZCBub3QgcXVldWUgaXRzCiAgICAgICAgICAgICAgICAvLyBjYWxsYmFjayBhZ2Fpbi4KICAgICAgICAgICAgICAgIHVwZGF0ZS5sYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENhbGxiYWNrOwogICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0cyA9IHF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcXVldWUuZWZmZWN0cyA9IFt1cGRhdGVdOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh1cGRhdGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgIGlmICh1cGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZC5wZW5kaW5nOwogICAgICAgICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBfbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgICAgICAgIHZhciBfZmlyc3RQZW5kaW5nVXBkYXRlID0gX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICAgIF9sYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdXBkYXRlID0gX2ZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKHRydWUpOwogICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5iYXNlU3RhdGUgPSBuZXdCYXNlU3RhdGU7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IG5ld0ZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLnNoYXJlZC5pbnRlcmxlYXZlZDsKICAgICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIGludGVybGVhdmVkLmxhbmUpOwogICAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICAgIH0gd2hpbGUgKGludGVybGVhdmVkICE9PSBsYXN0SW50ZXJsZWF2ZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpcnN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhuZXdMYW5lcyk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG5ld0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGFyZ3VtZW50IHBhc3NlZCBhcyBjYWxsYmFjay4gRXhwZWN0ZWQgYSBmdW5jdGlvbi4gSW5zdGVhZCAiICsgKCJyZWNlaXZlZDogIiArIGNhbGxiYWNrKSk7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjay5jYWxsKGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpIHsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaGFzRm9yY2VVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgZmluaXNoZWRRdWV1ZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBlZmZlY3RzID0gZmluaXNoZWRRdWV1ZS5lZmZlY3RzOwogICAgICAgICAgZmluaXNoZWRRdWV1ZS5lZmZlY3RzID0gbnVsbDsKICAgICAgICAgIGlmIChlZmZlY3RzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWZmZWN0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBlZmZlY3RzW2ldOwogICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGVmZmVjdC5jYWxsYmFjazsKICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVmZmVjdC5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICBjYWxsQ2FsbGJhY2soY2FsbGJhY2ssIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5PX0NPTlRFWFQgPSB7fTsKICAgICAgICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yJDEgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIHZhciByb290SW5zdGFuY2VTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICBmdW5jdGlvbiByZXF1aXJlZENvbnRleHQoYzIpIHsKICAgICAgICAgIGlmIChjMiA9PT0gTk9fQ09OVEVYVCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGhvc3QgY29udGV4dCB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250YWluZXIoKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIHJvb3RJbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250YWluZXIoZmliZXIsIG5leHRSb290SW5zdGFuY2UpIHsKICAgICAgICAgIHB1c2gocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIG5leHRSb290SW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBOT19DT05URVhULCBmaWJlcik7CiAgICAgICAgICB2YXIgbmV4dFJvb3RDb250ZXh0ID0gZ2V0Um9vdEhvc3RDb250ZXh0KG5leHRSb290SW5zdGFuY2UpOwogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Um9vdENvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRhaW5lcihmaWJlcikgewogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwb3AoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgIHBvcChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0Q29udGV4dCgpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvciQxLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgdmFyIHJvb3RJbnN0YW5jZSA9IHJlcXVpcmVkQ29udGV4dChyb290SW5zdGFuY2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvciQxLmN1cnJlbnQpOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZ2V0Q2hpbGRIb3N0Q29udGV4dChjb250ZXh0LCBmaWJlci50eXBlKTsKICAgICAgICAgIGlmIChjb250ZXh0ID09PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IkMSwgbmV4dENvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIGlmIChjb250ZXh0RmliZXJTdGFja0N1cnNvci5jdXJyZW50ICE9PSBmaWJlcikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgRGVmYXVsdFN1c3BlbnNlQ29udGV4dCA9IDA7CiAgICAgICAgdmFyIFN1YnRyZWVTdXNwZW5zZUNvbnRleHRNYXNrID0gMTsKICAgICAgICB2YXIgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0ID0gMTsKICAgICAgICB2YXIgRm9yY2VTdXNwZW5zZUZhbGxiYWNrID0gMjsKICAgICAgICB2YXIgc3VzcGVuc2VTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihEZWZhdWx0U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICBmdW5jdGlvbiBoYXNTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgZmxhZykgewogICAgICAgICAgcmV0dXJuIChwYXJlbnRDb250ZXh0ICYgZmxhZykgIT09IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0ICYgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgc2hhbGxvd0NvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0ICYgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgfCBzaGFsbG93Q29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkU3VidHJlZVN1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzdWJ0cmVlQ29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgfCBzdWJ0cmVlQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFN1c3BlbnNlQ29udGV4dChmaWJlciwgbmV3Q29udGV4dCkgewogICAgICAgICAgcHVzaChzdXNwZW5zZVN0YWNrQ3Vyc29yLCBuZXdDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFN1c3BlbnNlQ29udGV4dChmaWJlcikgewogICAgICAgICAgcG9wKHN1c3BlbnNlU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKHdvcmtJblByb2dyZXNzMiwgaGFzSW52aXNpYmxlUGFyZW50KSB7CiAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEZpcnN0U3VzcGVuZGVkKHJvdykgewogICAgICAgICAgdmFyIG5vZGUgPSByb3c7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGRlaHlkcmF0ZWQgPSBzdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKGRlaHlkcmF0ZWQgPT09IG51bGwgfHwgaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhkZWh5ZHJhdGVkKSB8fCBpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhkZWh5ZHJhdGVkKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlTGlzdENvbXBvbmVudCAmJiAvLyByZXZlYWxPcmRlciB1bmRlZmluZWQgY2FuJ3QgYmUgdHJ1c3RlZCBiZWNhdXNlIGl0IGRvbid0CiAgICAgICAgICAgIC8vIGtlZXAgdHJhY2sgb2Ygd2hldGhlciBpdCBzdXNwZW5kZWQgb3Igbm90LgogICAgICAgICAgICBub2RlLm1lbW9pemVkUHJvcHMucmV2ZWFsT3JkZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKG5vZGUuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHJvdykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHJvdykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIE5vRmxhZ3MkMSA9ICgKICAgICAgICAgIC8qICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBIYXNFZmZlY3QgPSAoCiAgICAgICAgICAvKiAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIEluc2VydGlvbiA9ICgKICAgICAgICAgIC8qICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIExheW91dCA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUGFzc2l2ZSQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzU291cmNlcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlID0gd29ya0luUHJvZ3Jlc3NTb3VyY2VzW2ldOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbXV0YWJsZVNvdXJjZS5fd29ya0luUHJvZ3Jlc3NWZXJzaW9uUHJpbWFyeSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzU291cmNlcy5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpIHsKICAgICAgICAgIHZhciBnZXRWZXJzaW9uID0gbXV0YWJsZVNvdXJjZS5fZ2V0VmVyc2lvbjsKICAgICAgICAgIHZhciB2ZXJzaW9uMiA9IGdldFZlcnNpb24obXV0YWJsZVNvdXJjZS5fc291cmNlKTsKICAgICAgICAgIGlmIChyb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID09IG51bGwpIHsKICAgICAgICAgICAgcm9vdDMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YSA9IFttdXRhYmxlU291cmNlLCB2ZXJzaW9uMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhLnB1c2gobXV0YWJsZVNvdXJjZSwgdmVyc2lvbjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlciwgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIHZhciByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgdmFyIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICB2YXIgZ2xvYmFsQ2xpZW50SWRDb3VudGVyID0gMDsKICAgICAgICB2YXIgUkVfUkVOREVSX0xJTUlUID0gMjU7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICB2YXIgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICB2YXIgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICB2YXIgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBtb3VudEhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgPT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNEZXYgPSBbaG9va05hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGhvb2tUeXBlc0Rldi5wdXNoKGhvb2tOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb29rVHlwZXNEZXYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob29rTmFtZSA9IGN1cnJlbnRIb29rTmFtZUluRGV2OwogICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYrKzsKICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2W2hvb2tUeXBlc1VwZGF0ZUluZGV4RGV2XSAhPT0gaG9va05hbWUpIHsKICAgICAgICAgICAgICAgIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGhvb2tOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGVwcyAhPT0gdm9pZCAwICYmIGRlcHMgIT09IG51bGwgJiYgIWlzQXJyYXkyKGRlcHMpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIHJlY2VpdmVkIGEgZmluYWwgYXJndW1lbnQgdGhhdCBpcyBub3QgYW4gYXJyYXkgKGluc3RlYWQsIHJlY2VpdmVkIGAlc2ApLiBXaGVuIHNwZWNpZmllZCwgdGhlIGZpbmFsIGFyZ3VtZW50IG11c3QgYmUgYW4gYXJyYXkuIiwgY3VycmVudEhvb2tOYW1lSW5EZXYsIHR5cGVvZiBkZXBzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25Ib29rTWlzbWF0Y2hJbkRldihjdXJyZW50SG9va05hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEpOwogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciB0YWJsZSA9ICIiOwogICAgICAgICAgICAgICAgdmFyIHNlY29uZENvbHVtblN0YXJ0ID0gMzA7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBob29rVHlwZXNVcGRhdGVJbmRleERldjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvbGRIb29rTmFtZSA9IGhvb2tUeXBlc0RldltpXTsKICAgICAgICAgICAgICAgICAgdmFyIG5ld0hvb2tOYW1lID0gaSA9PT0gaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPyBjdXJyZW50SG9va05hbWUgOiBvbGRIb29rTmFtZTsKICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IGkgKyAxICsgIi4gIiArIG9sZEhvb2tOYW1lOwogICAgICAgICAgICAgICAgICB3aGlsZSAocm93Lmxlbmd0aCA8IHNlY29uZENvbHVtblN0YXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgcm93ICs9ICIgIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByb3cgKz0gbmV3SG9va05hbWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICB0YWJsZSArPSByb3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaGFzIGRldGVjdGVkIGEgY2hhbmdlIGluIHRoZSBvcmRlciBvZiBIb29rcyBjYWxsZWQgYnkgJXMuIFRoaXMgd2lsbCBsZWFkIHRvIGJ1Z3MgYW5kIGVycm9ycyBpZiBub3QgZml4ZWQuIEZvciBtb3JlIGluZm9ybWF0aW9uLCByZWFkIHRoZSBSdWxlcyBvZiBIb29rczogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3J1bGVzLW9mLWhvb2tzXG5cbiAgIFByZXZpb3VzIHJlbmRlciAgICAgICAgICAgIE5leHQgcmVuZGVyXG4gICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiVzICAgXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXG4iLCBjb21wb25lbnROYW1lLCB0YWJsZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93SW52YWxpZEhvb2tFcnJvcigpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBob29rIGNhbGwuIEhvb2tzIGNhbiBvbmx5IGJlIGNhbGxlZCBpbnNpZGUgb2YgdGhlIGJvZHkgb2YgYSBmdW5jdGlvbiBjb21wb25lbnQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1pZ2h0IGhhdmUgbWlzbWF0Y2hpbmcgdmVyc2lvbnMgb2YgUmVhY3QgYW5kIHRoZSByZW5kZXJlciAoc3VjaCBhcyBSZWFjdCBET00pXG4yLiBZb3UgbWlnaHQgYmUgYnJlYWtpbmcgdGhlIFJ1bGVzIG9mIEhvb2tzXG4zLiBZb3UgbWlnaHQgaGF2ZSBtb3JlIHRoYW4gb25lIGNvcHkgb2YgUmVhY3QgaW4gdGhlIHNhbWUgYXBwXG5TZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2ludmFsaWQtaG9vay1jYWxsIGZvciB0aXBzIGFib3V0IGhvdyB0byBkZWJ1ZyBhbmQgZml4IHRoaXMgcHJvYmxlbS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcmV2RGVwcyA9PT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIHJlY2VpdmVkIGEgZmluYWwgYXJndW1lbnQgZHVyaW5nIHRoaXMgcmVuZGVyLCBidXQgbm90IGR1cmluZyB0aGUgcHJldmlvdXMgcmVuZGVyLiBFdmVuIHRob3VnaCB0aGUgZmluYWwgYXJndW1lbnQgaXMgb3B0aW9uYWwsIGl0cyB0eXBlIGNhbm5vdCBjaGFuZ2UgYmV0d2VlbiByZW5kZXJzLiIsIGN1cnJlbnRIb29rTmFtZUluRGV2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcy5sZW5ndGggIT09IHByZXZEZXBzLmxlbmd0aCkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgZmluYWwgYXJndW1lbnQgcGFzc2VkIHRvICVzIGNoYW5nZWQgc2l6ZSBiZXR3ZWVuIHJlbmRlcnMuIFRoZSBvcmRlciBhbmQgc2l6ZSBvZiB0aGlzIGFycmF5IG11c3QgcmVtYWluIGNvbnN0YW50LlxuXG5QcmV2aW91czogJXNcbkluY29taW5nOiAlcyIsIGN1cnJlbnRIb29rTmFtZUluRGV2LCAiWyIgKyBwcmV2RGVwcy5qb2luKCIsICIpICsgIl0iLCAiWyIgKyBuZXh0RGVwcy5qb2luKCIsICIpICsgIl0iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmV2RGVwcy5sZW5ndGggJiYgaSA8IG5leHREZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChvYmplY3RJcyhuZXh0RGVwc1tpXSwgcHJldkRlcHNbaV0pKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBzZWNvbmRBcmcsIG5leHRSZW5kZXJMYW5lcykgewogICAgICAgICAgcmVuZGVyTGFuZXMgPSBuZXh0UmVuZGVyTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgewogICAgICAgICAgICBob29rVHlwZXNEZXYgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Ll9kZWJ1Z0hvb2tUeXBlcyA6IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPbk1vdW50V2l0aEhvb2tUeXBlc0luREVWOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICBpZiAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZlJlUmVuZGVycyA9IDA7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgICAgICAgaWYgKG51bWJlck9mUmVSZW5kZXJzID49IFJFX1JFTkRFUl9MSU1JVCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUb28gbWFueSByZS1yZW5kZXJzLiBSZWFjdCBsaW1pdHMgdGhlIG51bWJlciBvZiByZW5kZXJzIHRvIHByZXZlbnQgYW4gaW5maW5pdGUgbG9vcC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbnVtYmVyT2ZSZVJlbmRlcnMgKz0gMTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIGNoaWxkcmVuID0gQ29tcG9uZW50KHByb3BzLCBzZWNvbmRBcmcpOwogICAgICAgICAgICB9IHdoaWxlIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MpOwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdIb29rVHlwZXMgPSBob29rVHlwZXNEZXY7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlkUmVuZGVyVG9vRmV3SG9va3MgPSBjdXJyZW50SG9vayAhPT0gbnVsbCAmJiBjdXJyZW50SG9vay5uZXh0ICE9PSBudWxsOwogICAgICAgICAgcmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgICBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiAoY3VycmVudDQuZmxhZ3MgJiBTdGF0aWNNYXNrKSAhPT0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFN0YXRpY01hc2spICYmIC8vIERpc2FibGUgdGhpcyB3YXJuaW5nIGluIGxlZ2FjeSBtb2RlLCBiZWNhdXNlIGxlZ2FjeSBTdXNwZW5zZSBpcyB3ZWlyZAogICAgICAgICAgICAvLyBhbmQgY3JlYXRlcyBmYWxzZSBwb3NpdGl2ZXMuIFRvIG1ha2UgdGhpcyB3b3JrIGluIGxlZ2FjeSBtb2RlLCB3ZSdkCiAgICAgICAgICAgIC8vIG5lZWQgdG8gbWFyayBmaWJlcnMgdGhhdCBjb21taXQgaW4gYW4gaW5jb21wbGV0ZSBzdGF0ZSwgc29tZWhvdy4gRm9yCiAgICAgICAgICAgIC8vIG5vdyBJJ2xsIGRpc2FibGUgdGhlIHdhcm5pbmcgdGhhdCBtb3N0IG9mIHRoZSBidWdzIHRoYXQgd291bGQgdHJpZ2dlcgogICAgICAgICAgICAvLyBpdCBhcmUgZWl0aGVyIGV4Y2x1c2l2ZSB0byBjb25jdXJyZW50IG1vZGUgb3IgZXhpc3QgaW4gYm90aC4KICAgICAgICAgICAgKGN1cnJlbnQ0Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogRXhwZWN0ZWQgc3RhdGljIGZsYWcgd2FzIG1pc3NpbmcuIFBsZWFzZSBub3RpZnkgdGhlIFJlYWN0IHRlYW0uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIGlmIChkaWRSZW5kZXJUb29GZXdIb29rcykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlbmRlcmVkIGZld2VyIGhvb2tzIHRoYW4gZXhwZWN0ZWQuIFRoaXMgbWF5IGJlIGNhdXNlZCBieSBhbiBhY2NpZGVudGFsIGVhcmx5IHJldHVybiBzdGF0ZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRGlkUmVuZGVySWRIb29rKCkgewogICAgICAgICAgdmFyIGRpZFJlbmRlcklkSG9vayA9IGxvY2FsSWRDb3VudGVyICE9PSAwOwogICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgcmV0dXJuIGRpZFJlbmRlcklkSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFpbG91dEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGxhbmVzKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfihNb3VudFBhc3NpdmVEZXYgfCBNb3VudExheW91dERldiB8IFBhc3NpdmUgfCBVcGRhdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH4oUGFzc2l2ZSB8IFVwZGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50NC5sYW5lcyA9IHJlbW92ZUxhbmVzKGN1cnJlbnQ0LmxhbmVzLCBsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0SG9va3NBZnRlclRocm93KCkgewogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICBpZiAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSkgewogICAgICAgICAgICB2YXIgaG9vayA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgd2hpbGUgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhvb2sgPSBob29rLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgICBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9IG51bGw7CiAgICAgICAgICAgIGlzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2UgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpIHsKICAgICAgICAgIHZhciBob29rID0gewogICAgICAgICAgICBtZW1vaXplZFN0YXRlOiBudWxsLAogICAgICAgICAgICBiYXNlU3RhdGU6IG51bGwsCiAgICAgICAgICAgIGJhc2VRdWV1ZTogbnVsbCwKICAgICAgICAgICAgcXVldWU6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZSA9IHdvcmtJblByb2dyZXNzSG9vayA9IGhvb2s7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dCA9IGhvb2s7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKSB7CiAgICAgICAgICB2YXIgbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnRIb29rLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXh0V29ya0luUHJvZ3Jlc3NIb29rICE9PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG5leHRXb3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dDsKICAgICAgICAgICAgY3VycmVudEhvb2sgPSBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobmV4dEN1cnJlbnRIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZW5kZXJlZCBtb3JlIGhvb2tzIHRoYW4gZHVyaW5nIHRoZSBwcmV2aW91cyByZW5kZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudEhvb2sgPSBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICAgIHZhciBuZXdIb29rID0gewogICAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGUsCiAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50SG9vay5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgYmFzZVF1ZXVlOiBjdXJyZW50SG9vay5iYXNlUXVldWUsCiAgICAgICAgICAgICAgcXVldWU6IGN1cnJlbnRIb29rLnF1ZXVlLAogICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZSA9IHdvcmtJblByb2dyZXNzSG9vayA9IG5ld0hvb2s7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQgPSBuZXdIb29rOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbkNvbXBvbmVudFVwZGF0ZVF1ZXVlKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbGFzdEVmZmVjdDogbnVsbCwKICAgICAgICAgICAgc3RvcmVzOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXNpY1N0YXRlUmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIGFjdGlvbiA9PT0gImZ1bmN0aW9uIiA/IGFjdGlvbihzdGF0ZSkgOiBhY3Rpb247CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50UmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaW5pdGlhbFN0YXRlMTM7CiAgICAgICAgICBpZiAoaW5pdCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZTEzID0gaW5pdChpbml0aWFsQXJnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZTEzID0gaW5pdGlhbEFyZzsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGhvb2suYmFzZVN0YXRlID0gaW5pdGlhbFN0YXRlMTM7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IHJlZHVjZXIsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFN0YXRlOiBpbml0aWFsU3RhdGUxMwogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoID0gZGlzcGF0Y2hSZWR1Y2VyQWN0aW9uLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY3VycmVudEhvb2s7CiAgICAgICAgICB2YXIgYmFzZVF1ZXVlID0gY3VycmVudDQuYmFzZVF1ZXVlOwogICAgICAgICAgdmFyIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChiYXNlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgYmFzZUZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmdGaXJzdCA9IHBlbmRpbmdRdWV1ZS5uZXh0OwogICAgICAgICAgICAgIGJhc2VRdWV1ZS5uZXh0ID0gcGVuZGluZ0ZpcnN0OwogICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZS5uZXh0ID0gYmFzZUZpcnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQuYmFzZVF1ZXVlICE9PSBiYXNlUXVldWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBlcnJvcjogRXhwZWN0ZWQgd29yay1pbi1wcm9ncmVzcyBxdWV1ZSB0byBiZSBhIGNsb25lLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50NC5iYXNlUXVldWUgPSBiYXNlUXVldWUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJhc2VRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3QgPSBiYXNlUXVldWUubmV4dDsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY3VycmVudDQuYmFzZVN0YXRlOwogICAgICAgICAgICB2YXIgbmV3QmFzZVN0YXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUxhc3QgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3Q7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgdXBkYXRlTGFuZSA9IHVwZGF0ZS5sYW5lOwogICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHJlbmRlckxhbmVzLCB1cGRhdGVMYW5lKSkgewogICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZS5hY3Rpb24sCiAgICAgICAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IHVwZGF0ZS5oYXNFYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUZpcnN0ID0gbmV3QmFzZVF1ZXVlTGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QgPSBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QgPSBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBfY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlLmhhc0VhZ2VyU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSB1cGRhdGUuZWFnZXJTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB1cGRhdGUuYWN0aW9uOwogICAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHJlZHVjZXIobmV3U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwgJiYgdXBkYXRlICE9PSBmaXJzdCk7CiAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gbmV3QmFzZVF1ZXVlRmlyc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3QmFzZVN0YXRlOwogICAgICAgICAgICBob29rLmJhc2VRdWV1ZSA9IG5ld0Jhc2VRdWV1ZUxhc3Q7CiAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZExhbmUgPSBpbnRlcmxlYXZlZC5sYW5lOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGludGVybGVhdmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhpbnRlcmxlYXZlZExhbmUpOwogICAgICAgICAgICAgIGludGVybGVhdmVkID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGJhc2VRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaDsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2g7CiAgICAgICAgICB2YXIgbGFzdFJlbmRlclBoYXNlVXBkYXRlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChsYXN0UmVuZGVyUGhhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgIHZhciBmaXJzdFJlbmRlclBoYXNlVXBkYXRlID0gbGFzdFJlbmRlclBoYXNlVXBkYXRlLm5leHQ7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdFJlbmRlclBoYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHVwZGF0ZS5hY3Rpb247CiAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IGZpcnN0UmVuZGVyUGhhc2VVcGRhdGUpOwogICAgICAgICAgICBpZiAoIW9iamVjdElzKG5ld1N0YXRlLCBob29rLm1lbW9pemVkU3RhdGUpKSB7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtuZXdTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudE11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dFNuYXBzaG90OwogICAgICAgICAgdmFyIGlzSHlkcmF0aW5nMiA9IGdldElzSHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcyKSB7CiAgICAgICAgICAgIGlmIChnZXRTZXJ2ZXJTbmFwc2hvdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIGdldFNlcnZlclNuYXBzaG90LCB3aGljaCBpcyByZXF1aXJlZCBmb3Igc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQuIFdpbGwgcmV2ZXJ0IHRvIGNsaWVudCByZW5kZXJpbmcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gZ2V0U2VydmVyU25hcHNob3QoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0U25hcHNob3QgIT09IGdldFNlcnZlclNuYXBzaG90KCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U2VydmVyU25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICB2YXIgY2FjaGVkU25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBhIHdvcmstaW4tcHJvZ3Jlc3Mgcm9vdC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgcmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgIHZhciBpbnN0ID0gewogICAgICAgICAgICB2YWx1ZTogbmV4dFNuYXBzaG90LAogICAgICAgICAgICBnZXRTbmFwc2hvdAogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBpbnN0OwogICAgICAgICAgbW91bnRFZmZlY3Qoc3Vic2NyaWJlVG9TdG9yZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpLCBbc3Vic2NyaWJlXSk7CiAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICByZXR1cm4gbmV4dFNuYXBzaG90OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgIHZhciBjYWNoZWRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldlNuYXBzaG90ID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHNuYXBzaG90Q2hhbmdlZCA9ICFvYmplY3RJcyhwcmV2U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICBpZiAoc25hcHNob3RDaGFuZ2VkKSB7CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gaG9vay5xdWV1ZTsKICAgICAgICAgIHVwZGF0ZUVmZmVjdChzdWJzY3JpYmVUb1N0b3JlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIHN1YnNjcmliZSksIFtzdWJzY3JpYmVdKTsKICAgICAgICAgIGlmIChpbnN0LmdldFNuYXBzaG90ICE9PSBnZXRTbmFwc2hvdCB8fCBzbmFwc2hvdENoYW5nZWQgfHwgLy8gQ2hlY2sgaWYgdGhlIHN1c2JjcmliZSBmdW5jdGlvbiBjaGFuZ2VkLiBXZSBjYW4gc2F2ZSBzb21lIG1lbW9yeSBieQogICAgICAgICAgLy8gY2hlY2tpbmcgd2hldGhlciB3ZSBzY2hlZHVsZWQgYSBzdWJzY3JpcHRpb24gZWZmZWN0IGFib3ZlLgogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzSG9vay5tZW1vaXplZFN0YXRlLnRhZyAmIEhhc0VmZmVjdCkgewogICAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgICBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IFBhc3NpdmUkMSwgdXBkYXRlU3RvcmVJbnN0YW5jZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSwgdm9pZCAwLCBudWxsKTsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIHJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV4dFNuYXBzaG90OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgcmVuZGVyZWRTbmFwc2hvdCkgewogICAgICAgICAgZmliZXIuZmxhZ3MgfD0gU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICAgIHZhciBjaGVjayA9IHsKICAgICAgICAgICAgZ2V0U25hcHNob3QsCiAgICAgICAgICAgIHZhbHVlOiByZW5kZXJlZFNuYXBzaG90CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZSA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXMgPSBbY2hlY2tdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHN0b3JlcyA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlczsKICAgICAgICAgICAgaWYgKHN0b3JlcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlcyA9IFtjaGVja107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RvcmVzLnB1c2goY2hlY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0b3JlSW5zdGFuY2UoZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpIHsKICAgICAgICAgIGluc3QudmFsdWUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICBpbnN0LmdldFNuYXBzaG90ID0gZ2V0U25hcHNob3Q7CiAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdWJzY3JpYmVUb1N0b3JlKGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHZhciBoYW5kbGVTdG9yZUNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICAgIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gc3Vic2NyaWJlKGhhbmRsZVN0b3JlQ2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSB7CiAgICAgICAgICB2YXIgbGF0ZXN0R2V0U25hcHNob3QgPSBpbnN0LmdldFNuYXBzaG90OwogICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGluc3QudmFsdWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbGF0ZXN0R2V0U25hcHNob3QoKTsKICAgICAgICAgICAgcmV0dXJuICFvYmplY3RJcyhwcmV2VmFsdWUsIG5leHRWYWx1ZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcikgewogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaWYgKHR5cGVvZiBpbml0aWFsU3RhdGUxMyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbml0aWFsU3RhdGUxMyA9IGluaXRpYWxTdGF0ZTEzKCk7CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBob29rLmJhc2VTdGF0ZSA9IGluaXRpYWxTdGF0ZTEzOwogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgIGRpc3BhdGNoOiBudWxsLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRSZWR1Y2VyOiBiYXNpY1N0YXRlUmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZTEzCiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2ggPSBkaXNwYXRjaFNldFN0YXRlLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKGJhc2ljU3RhdGVSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJTdGF0ZShpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hFZmZlY3QodGFnLCBjcmVhdGUsIGRlc3Ryb3ksIGRlcHMpIHsKICAgICAgICAgIHZhciBlZmZlY3QgPSB7CiAgICAgICAgICAgIHRhZywKICAgICAgICAgICAgY3JlYXRlLAogICAgICAgICAgICBkZXN0cm95LAogICAgICAgICAgICBkZXBzLAogICAgICAgICAgICAvLyBDaXJjdWxhcgogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZSA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3Q7CiAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdCA9IGVmZmVjdC5uZXh0ID0gZWZmZWN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICBsYXN0RWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgICAgZWZmZWN0Lm5leHQgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWZmZWN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9yZWYyID0gewogICAgICAgICAgICAgIGN1cnJlbnQ6IGluaXRpYWxWYWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBfcmVmMjsKICAgICAgICAgICAgcmV0dXJuIF9yZWYyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgcmV0dXJuIGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIGhvb2tGbGFncywgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgaG9va0ZsYWdzLCBjcmVhdGUsIHZvaWQgMCwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIGhvb2tGbGFncywgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcHJldkVmZmVjdCA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGRlc3Ryb3kgPSBwcmV2RWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZFZmZlY3QuZGVwczsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoaG9va0ZsYWdzLCBjcmVhdGUsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgaG9va0ZsYWdzLCBjcmVhdGUsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoTW91bnRQYXNzaXZlRGV2IHwgUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoUGFzc2l2ZSwgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgSW5zZXJ0aW9uLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdChjcmVhdGUsIHJlZikgewogICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHJlZkNhbGxiYWNrID0gcmVmOwogICAgICAgICAgICB2YXIgX2luc3QgPSBjcmVhdGUoKTsKICAgICAgICAgICAgcmVmQ2FsbGJhY2soX2luc3QpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmVmQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKHJlZiAhPT0gbnVsbCAmJiByZWYgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gcmVmOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFyZWZPYmplY3QuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBmaXJzdCBhcmd1bWVudCB0byBlaXRoZXIgYmUgYSByZWYgY2FsbGJhY2sgb3IgUmVhY3QuY3JlYXRlUmVmKCkgb2JqZWN0LiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCAiYW4gb2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKHJlZk9iamVjdCkuam9pbigiLCAiKSArICJ9Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfaW5zdDIgPSBjcmVhdGUoKTsKICAgICAgICAgICAgcmVmT2JqZWN0LmN1cnJlbnQgPSBfaW5zdDI7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjcmVhdGUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIHNlY29uZCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIGhhbmRsZS4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY3JlYXRlICE9PSBudWxsID8gdHlwZW9mIGNyZWF0ZSA6ICJudWxsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlZmZlY3REZXBzID0gZGVwcyAhPT0gbnVsbCAmJiBkZXBzICE9PSB2b2lkIDAgPyBkZXBzLmNvbmNhdChbcmVmXSkgOiBudWxsOwogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBMYXlvdXQsIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QuYmluZChudWxsLCBjcmVhdGUsIHJlZiksIGVmZmVjdERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlYnVnVmFsdWUodmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgfQogICAgICAgIHZhciB1cGRhdGVEZWJ1Z1ZhbHVlID0gbW91bnREZWJ1Z1ZhbHVlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW2NhbGxiYWNrLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2U3RhdGVbMV07CiAgICAgICAgICAgICAgaWYgKGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlWzBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW2NhbGxiYWNrLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TWVtbyhuZXh0Q3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbmV4dENyZWF0ZSgpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW25leHRWYWx1ZSwgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIG5leHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByZXNvbHZlZEN1cnJlbnRIb29rID0gY3VycmVudEhvb2s7CiAgICAgICAgICB2YXIgcHJldlZhbHVlID0gcmVzb2x2ZWRDdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBzaG91bGREZWZlclZhbHVlID0gIWluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKHJlbmRlckxhbmVzKTsKICAgICAgICAgIGlmIChzaG91bGREZWZlclZhbHVlKSB7CiAgICAgICAgICAgIGlmICghb2JqZWN0SXModmFsdWUsIHByZXZWYWx1ZSkpIHsKICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRMYW5lID0gY2xhaW1OZXh0VHJhbnNpdGlvbkxhbmUoKTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCBkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoZGVmZXJyZWRMYW5lKTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByZXZWYWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChob29rLmJhc2VTdGF0ZSkgewogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFRyYW5zaXRpb24oc2V0UGVuZGluZywgY2FsbGJhY2ssIG9wdGlvbnMyKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGhpZ2hlckV2ZW50UHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSwgQ29udGludW91c0V2ZW50UHJpb3JpdHkpKTsKICAgICAgICAgIHNldFBlbmRpbmcodHJ1ZSk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSB7fTsKICAgICAgICAgIHZhciBjdXJyZW50VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldFBlbmRpbmcoZmFsc2UpOwogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZWRGaWJlcnNDb3VudCA9IGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLnNpemU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlZEZpYmVyc0NvdW50ID4gMTApIHsKICAgICAgICAgICAgICAgICAgd2FybjMoIkRldGVjdGVkIGEgbGFyZ2UgbnVtYmVyIG9mIHVwZGF0ZXMgaW5zaWRlIHN0YXJ0VHJhbnNpdGlvbi4gSWYgdGhpcyBpcyBkdWUgdG8gYSBzdWJzY3JpcHRpb24gcGxlYXNlIHJlLXdyaXRlIGl0IHRvIHVzZSBSZWFjdCBwcm92aWRlZCBob29rcy4gT3RoZXJ3aXNlIGNvbmN1cnJlbnQgbW9kZSBndWFyYW50ZWVzIGFyZSBvZmYgdGhlIHRhYmxlLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF9tb3VudFN0YXRlID0gbW91bnRTdGF0ZShmYWxzZSksIGlzUGVuZGluZyA9IF9tb3VudFN0YXRlWzBdLCBzZXRQZW5kaW5nID0gX21vdW50U3RhdGVbMV07CiAgICAgICAgICB2YXIgc3RhcnQgPSBzdGFydFRyYW5zaXRpb24uYmluZChudWxsLCBzZXRQZW5kaW5nKTsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHN0YXJ0OwogICAgICAgICAgcmV0dXJuIFtpc1BlbmRpbmcsIHN0YXJ0XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVHJhbnNpdGlvbigpIHsKICAgICAgICAgIHZhciBfdXBkYXRlU3RhdGUgPSB1cGRhdGVTdGF0ZSgpLCBpc1BlbmRpbmcgPSBfdXBkYXRlU3RhdGVbMF07CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHN0YXJ0ID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIFtpc1BlbmRpbmcsIHN0YXJ0XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF9yZXJlbmRlclN0YXRlID0gcmVyZW5kZXJTdGF0ZSgpLCBpc1BlbmRpbmcgPSBfcmVyZW5kZXJTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICB2YXIgaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldElzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2VJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGlzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SWQoKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gcm9vdDMuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgIHZhciBpZDsKICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgIHZhciB0cmVlSWQgPSBnZXRUcmVlSWQoKTsKICAgICAgICAgICAgaWQgPSAiOiIgKyBpZGVudGlmaWVyUHJlZml4ICsgIlIiICsgdHJlZUlkOwogICAgICAgICAgICB2YXIgbG9jYWxJZCA9IGxvY2FsSWRDb3VudGVyKys7CiAgICAgICAgICAgIGlmIChsb2NhbElkID4gMCkgewogICAgICAgICAgICAgIGlkICs9ICJIIiArIGxvY2FsSWQudG9TdHJpbmcoMzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlkICs9ICI6IjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBnbG9iYWxDbGllbnRJZCA9IGdsb2JhbENsaWVudElkQ291bnRlcisrOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiciIgKyBnbG9iYWxDbGllbnRJZC50b1N0cmluZygzMikgKyAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBpZDsKICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSWQoKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIGlkID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaFJlZHVjZXJBY3Rpb24oZmliZXIsIHF1ZXVlLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbM10gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiU3RhdGUgdXBkYXRlcyBmcm9tIHRoZSB1c2VTdGF0ZSgpIGFuZCB1c2VSZWR1Y2VyKCkgSG9va3MgZG9uJ3Qgc3VwcG9ydCB0aGUgc2Vjb25kIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIHRoZSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGxhbmUsCiAgICAgICAgICAgIGFjdGlvbiwKICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogZmFsc2UsCiAgICAgICAgICAgIGVhZ2VyU3RhdGU6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoaXNSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikpIHsKICAgICAgICAgICAgZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoU2V0U3RhdGUoZmliZXIsIHF1ZXVlLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbM10gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiU3RhdGUgdXBkYXRlcyBmcm9tIHRoZSB1c2VTdGF0ZSgpIGFuZCB1c2VSZWR1Y2VyKCkgSG9va3MgZG9uJ3Qgc3VwcG9ydCB0aGUgc2Vjb25kIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIHRoZSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGxhbmUsCiAgICAgICAgICAgIGFjdGlvbiwKICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogZmFsc2UsCiAgICAgICAgICAgIGVhZ2VyU3RhdGU6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoaXNSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikpIHsKICAgICAgICAgICAgZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGZpYmVyLmxhbmVzID09PSBOb0xhbmVzICYmIChhbHRlcm5hdGUgPT09IG51bGwgfHwgYWx0ZXJuYXRlLmxhbmVzID09PSBOb0xhbmVzKSkgewogICAgICAgICAgICAgIHZhciBsYXN0UmVuZGVyZWRSZWR1Y2VyID0gcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlcjsKICAgICAgICAgICAgICBpZiAobGFzdFJlbmRlcmVkUmVkdWNlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlOwogICAgICAgICAgICAgICAgICB2YXIgZWFnZXJTdGF0ZSA9IGxhc3RSZW5kZXJlZFJlZHVjZXIoY3VycmVudFN0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgICAgICB1cGRhdGUuaGFzRWFnZXJTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5lYWdlclN0YXRlID0gZWFnZXJTdGF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKG9iamVjdElzKGVhZ2VyU3RhdGUsIGN1cnJlbnRTdGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGVBbmRFYWdlcmx5QmFpbG91dChmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25VcGRhdGUocm9vdDMsIHF1ZXVlLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbWFya1VwZGF0ZUluRGV2VG9vbHMoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgcmV0dXJuIGZpYmVyID09PSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVSZW5kZXJQaGFzZVVwZGF0ZShxdWV1ZSwgdXBkYXRlKSB7CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgIHZhciBwZW5kaW5nID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpIHsKICAgICAgICAgIGlmIChpc1RyYW5zaXRpb25MYW5lKGxhbmUpKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZUxhbmVzID0gcXVldWUubGFuZXM7CiAgICAgICAgICAgIHF1ZXVlTGFuZXMgPSBpbnRlcnNlY3RMYW5lcyhxdWV1ZUxhbmVzLCByb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgICAgICB2YXIgbmV3UXVldWVMYW5lcyA9IG1lcmdlTGFuZXMocXVldWVMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIHF1ZXVlLmxhbmVzID0gbmV3UXVldWVMYW5lczsKICAgICAgICAgICAgbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIG5ld1F1ZXVlTGFuZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSwgYWN0aW9uKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBDb250ZXh0T25seURpc3BhdGNoZXIgPSB7CiAgICAgICAgICByZWFkQ29udGV4dCwKICAgICAgICAgIHVzZUNhbGxiYWNrOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VDb250ZXh0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VNZW1vOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VSZWR1Y2VyOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VSZWY6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN0YXRlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VUcmFuc2l0aW9uOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSWQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgIH07CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFViA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdmFyIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5JbnZhbGlkSG9va0FjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlcnJvcigiRG8gbm90IGNhbGwgSG9va3MgaW5zaWRlIHVzZUVmZmVjdCguLi4pLCB1c2VNZW1vKC4uLiksIG9yIG90aGVyIGJ1aWx0LWluIEhvb2tzLiBZb3UgY2FuIG9ubHkgY2FsbCBIb29rcyBhdCB0aGUgdG9wIGxldmVsIG9mIHlvdXIgUmVhY3QgZnVuY3Rpb24uIEZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3J1bGVzLW9mLWhvb2tzIik7CiAgICAgICAgICB9OwogICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcygpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcygpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBub3ckMSA9IFNjaGVkdWxlci51bnN0YWJsZV9ub3c7CiAgICAgICAgdmFyIGNvbW1pdFRpbWUgPSAwOwogICAgICAgIHZhciBsYXlvdXRFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgcHJvZmlsZXJTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgIHZhciBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBmYWxzZTsKICAgICAgICB2YXIgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRVcGRhdGVJc05lc3RlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXROZXN0ZWRVcGRhdGVGbGFnKCkgewogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN5bmNOZXN0ZWRVcGRhdGVGbGFnKCkgewogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQ7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21taXRUaW1lKCkgewogICAgICAgICAgcmV0dXJuIGNvbW1pdFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZENvbW1pdFRpbWUoKSB7CiAgICAgICAgICBjb21taXRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRQcm9maWxlclRpbWVyKGZpYmVyKSB7CiAgICAgICAgICBwcm9maWxlclN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgICBpZiAoZmliZXIuYWN0dWFsU3RhcnRUaW1lIDwgMCkgewogICAgICAgICAgICBmaWJlci5hY3R1YWxTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZyhmaWJlcikgewogICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSAtMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShmaWJlciwgb3ZlcnJpZGVCYXNlVGltZSkgewogICAgICAgICAgaWYgKHByb2ZpbGVyU3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHByb2ZpbGVyU3RhcnRUaW1lOwogICAgICAgICAgICBmaWJlci5hY3R1YWxEdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgaWYgKG92ZXJyaWRlQmFzZVRpbWUpIHsKICAgICAgICAgICAgICBmaWJlci5zZWxmQmFzZUR1cmF0aW9uID0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSAtMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIGlmIChsYXlvdXRFZmZlY3RTdGFydFRpbWUgPj0gMCkgewogICAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBub3ckMSgpIC0gbGF5b3V0RWZmZWN0U3RhcnRUaW1lOwogICAgICAgICAgICBsYXlvdXRFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICByb290My5lZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaWJlcikgewogICAgICAgICAgaWYgKHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPj0gMCkgewogICAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBub3ckMSgpIC0gcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJvb3QzLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAocGFyZW50U3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKSB7CiAgICAgICAgICBsYXlvdXRFZmZlY3RTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpIHsKICAgICAgICAgIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICBmaWJlci5hY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlRGVmYXVsdFByb3BzMihDb21wb25lbnQsIGJhc2VQcm9wcykgewogICAgICAgICAgaWYgKENvbXBvbmVudCAmJiBDb21wb25lbnQuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbjIoe30sIGJhc2VQcm9wcyk7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSBDb21wb25lbnQuZGVmYXVsdFByb3BzOwogICAgICAgICAgICBmb3IgKHZhciBwcm9wTmFtZSBpbiBkZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcm9wczsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBiYXNlUHJvcHM7CiAgICAgICAgfQogICAgICAgIHZhciBmYWtlSW50ZXJuYWxJbnN0YW5jZSA9IHt9OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIHdhcm5PblVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uSW52YWxpZENhbGxiYWNrOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgdmFyIGRpZFdhcm5PbkludmFsaWRDYWxsYmFjayA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2sgPSBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09IG51bGwgfHwgdHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBrZXkgPSBjYWxsZXJOYW1lICsgIl8iICsgY2FsbGJhY2s7CiAgICAgICAgICAgIGlmICghZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrLmhhcyhrZXkpKSB7CiAgICAgICAgICAgICAgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrLmFkZChrZXkpOwogICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxlck5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5PblVuZGVmaW5lZERlcml2ZWRTdGF0ZSA9IGZ1bmN0aW9uKHR5cGUsIHBhcnRpYWxTdGF0ZSkgewogICAgICAgICAgICBpZiAocGFydGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZS5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZS5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCk6IEEgdmFsaWQgc3RhdGUgb2JqZWN0IChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGZha2VJbnRlcm5hbEluc3RhbmNlLCAiX3Byb2Nlc3NDaGlsZENvbnRleHQiLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJfcHJvY2Vzc0NoaWxkQ29udGV4dCBpcyBub3QgYXZhaWxhYmxlIGluIFJlYWN0IDE2Ky4gVGhpcyBsaWtlbHkgbWVhbnMgeW91IGhhdmUgbXVsdGlwbGUgY29waWVzIG9mIFJlYWN0IGFuZCBhcmUgYXR0ZW1wdGluZyB0byBuZXN0IGEgUmVhY3QgMTUgdHJlZSBpbnNpZGUgYSBSZWFjdCAxNiB0cmVlIHVzaW5nIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyLCB3aGljaCBpc24ndCBzdXBwb3J0ZWQuIFRyeSB0byBtYWtlIHN1cmUgeW91IGhhdmUgb25seSBvbmUgY29weSBvZiBSZWFjdCAoYW5kIGlkZWFsbHksIHN3aXRjaCB0byBSZWFjdERPTS5jcmVhdGVQb3J0YWwpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5mcmVlemUoZmFrZUludGVybmFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV4dFByb3BzKSB7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcGFydGlhbFN0YXRlID0gZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKG5leHRQcm9wcywgcHJldlN0YXRlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5PblVuZGVmaW5lZERlcml2ZWRTdGF0ZShjdG9yLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1lbW9pemVkU3RhdGUgPSBwYXJ0aWFsU3RhdGUgPT09IG51bGwgfHwgcGFydGlhbFN0YXRlID09PSB2b2lkIDAgPyBwcmV2U3RhdGUgOiBhc3NpZ24yKHt9LCBwcmV2U3RhdGUsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgdXBkYXRlUXVldWUuYmFzZVN0YXRlID0gbWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNsYXNzQ29tcG9uZW50VXBkYXRlciA9IHsKICAgICAgICAgIGlzTW91bnRlZCwKICAgICAgICAgIGVucXVldWVTZXRTdGF0ZTogZnVuY3Rpb24oaW5zdCwgcGF5bG9hZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NyhpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24oaW5zdCwgcGF5bG9hZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NyhpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnRhZyA9IFJlcGxhY2VTdGF0ZTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInJlcGxhY2VTdGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGVucXVldWVGb3JjZVVwZGF0ZTogZnVuY3Rpb24oaW5zdCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NyhpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgImZvcmNlVXBkYXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCkgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuc2hvdWxkQ29tcG9uZW50VXBkYXRlKCk6IFJldHVybmVkIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIGEgYm9vbGVhbiB2YWx1ZS4gTWFrZSBzdXJlIHRvIHJldHVybiB0cnVlIG9yIGZhbHNlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3Rvci5wcm90b3R5cGUgJiYgY3Rvci5wcm90b3R5cGUuaXNQdXJlUmVhY3RDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuICFzaGFsbG93RXF1YWwyKG9sZFByb3BzLCBuZXdQcm9wcykgfHwgIXNoYWxsb3dFcXVhbDIob2xkU3RhdGUsIG5ld1N0YXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcykgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIHZhciByZW5kZXJQcmVzZW50ID0gaW5zdGFuY2UucmVuZGVyOwogICAgICAgICAgICBpZiAoIXJlbmRlclByZXNlbnQpIHsKICAgICAgICAgICAgICBpZiAoY3Rvci5wcm90b3R5cGUgJiYgdHlwZW9mIGN0b3IucHJvdG90eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IE5vIGByZW5kZXJgIG1ldGhvZCBmb3VuZCBvbiB0aGUgcmV0dXJuZWQgY29tcG9uZW50IGluc3RhbmNlOiBkaWQgeW91IGFjY2lkZW50YWxseSByZXR1cm4gYW4gb2JqZWN0IGZyb20gdGhlIGNvbnN0cnVjdG9yPyIsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IHlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gZGVmaW5lIGByZW5kZXJgLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UuZ2V0SW5pdGlhbFN0YXRlICYmICFpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUuaXNSZWFjdENsYXNzQXBwcm92ZWQgJiYgIWluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldEluaXRpYWxTdGF0ZSB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIERpZCB5b3UgbWVhbiB0byBkZWZpbmUgYSBzdGF0ZSBwcm9wZXJ0eSBpbnN0ZWFkPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXREZWZhdWx0UHJvcHMgJiYgIWluc3RhbmNlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgd2FzIGRlZmluZWQgb24gJXMsIGEgcGxhaW4gSmF2YVNjcmlwdCBjbGFzcy4gVGhpcyBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgY2xhc3NlcyBjcmVhdGVkIHVzaW5nIFJlYWN0LmNyZWF0ZUNsYXNzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGRlZmF1bHRQcm9wcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBlcnJvcigicHJvcFR5cGVzIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIHByb3BUeXBlcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZSkgewogICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZSB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBjb250ZXh0VHlwZSBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY3Rvci5jaGlsZENvbnRleHRUeXBlcyAmJiAhZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxLmhhcyhjdG9yKSAmJiAvLyBTdHJpY3QgTW9kZSBoYXMgaXRzIG93biB3YXJuaW5nIGZvciBsZWdhY3kgY29udGV4dCwgc28gd2UgY2FuIHNraXAKICAgICAgICAgICAgICAvLyB0aGlzIG9uZS4KICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIHVzZXMgdGhlIGxlZ2FjeSBjaGlsZENvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgaW5zdGVhZFxuXG4uTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlcyAmJiAhZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxLmhhcyhjdG9yKSAmJiAvLyBTdHJpY3QgTW9kZSBoYXMgaXRzIG93biB3YXJuaW5nIGZvciBsZWdhY3kgY29udGV4dCwgc28gd2UgY2FuIHNraXAKICAgICAgICAgICAgICAvLyB0aGlzIG9uZS4KICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIHVzZXMgdGhlIGxlZ2FjeSBjb250ZXh0VHlwZXMgQVBJIHdoaWNoIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBVc2UgUmVhY3QuY3JlYXRlQ29udGV4dCgpIHdpdGggc3RhdGljIGNvbnRleHRUeXBlIGluc3RlYWQuXG5cbkxlYXJuIG1vcmUgYWJvdXQgdGhpcyB3YXJuaW5nIGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9sZWdhY3ktY29udGV4dCIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiY29udGV4dFR5cGVzIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3Rvci5jb250ZXh0VHlwZSAmJiBjdG9yLmNvbnRleHRUeXBlcyAmJiAhZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgZGVjbGFyZXMgYm90aCBjb250ZXh0VHlwZXMgYW5kIGNvbnRleHRUeXBlIHN0YXRpYyBwcm9wZXJ0aWVzLiBUaGUgbGVnYWN5IGNvbnRleHRUeXBlcyBwcm9wZXJ0eSB3aWxsIGJlIGlnbm9yZWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50U2hvdWxkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50U2hvdWxkVXBkYXRlKCkuIERpZCB5b3UgbWVhbiBzaG91bGRDb21wb25lbnRVcGRhdGUoKT8gVGhlIG5hbWUgaXMgcGhyYXNlZCBhcyBhIHF1ZXN0aW9uIGJlY2F1c2UgdGhlIGZ1bmN0aW9uIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHZhbHVlLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiBjdG9yLnByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCAmJiB0eXBlb2YgaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpLiBzaG91bGRDb21wb25lbnRVcGRhdGUgc2hvdWxkIG5vdCBiZSB1c2VkIHdoZW4gZXh0ZW5kaW5nIFJlYWN0LlB1cmVDb21wb25lbnQuIFBsZWFzZSBleHRlbmQgUmVhY3QuQ29tcG9uZW50IGlmIHNob3VsZENvbXBvbmVudFVwZGF0ZSBpcyB1c2VkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQSBwdXJlIGNvbXBvbmVudCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFVubW91bnQoKS4gQnV0IHRoZXJlIGlzIG5vIHN1Y2ggbGlmZWN5Y2xlIG1ldGhvZC4gRGlkIHlvdSBtZWFuIGNvbXBvbmVudFdpbGxVbm1vdW50KCk/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnREaWRSZWNlaXZlUHJvcHMoKS4gQnV0IHRoZXJlIGlzIG5vIHN1Y2ggbGlmZWN5Y2xlIG1ldGhvZC4gSWYgeW91IG1lYW50IHRvIHVwZGF0ZSB0aGUgc3RhdGUgaW4gcmVzcG9uc2UgdG8gY2hhbmdpbmcgcHJvcHMsIHVzZSBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCkuIElmIHlvdSBtZWFudCB0byBmZXRjaCBkYXRhIG9yIHJ1biBzaWRlLWVmZmVjdHMgb3IgbXV0YXRpb25zIGFmdGVyIFJlYWN0IGhhcyB1cGRhdGVkIHRoZSBVSSwgdXNlIGNvbXBvbmVudERpZFVwZGF0ZSgpLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMoKS4gRGlkIHlvdSBtZWFuIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMoKS4gRGlkIHlvdSBtZWFuIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc011dGF0ZWRQcm9wcyA9IGluc3RhbmNlLnByb3BzICE9PSBuZXdQcm9wczsKICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSB2b2lkIDAgJiYgaGFzTXV0YXRlZFByb3BzKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IFdoZW4gY2FsbGluZyBzdXBlcigpIGluIGAlc2AsIG1ha2Ugc3VyZSB0byBwYXNzIHVwIHRoZSBzYW1lIHByb3BzIHRoYXQgeW91ciBjb21wb25lbnQncyBjb25zdHJ1Y3RvciB3YXMgcGFzc2VkLiIsIG5hbWUsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiU2V0dGluZyBkZWZhdWx0UHJvcHMgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWZpbmUgZGVmYXVsdFByb3BzIGFzIGEgc3RhdGljIHByb3BlcnR5IG9uICVzLiIsIG5hbWUsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSAhPT0gImZ1bmN0aW9uIiAmJiAhZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldFNuYXBzaG90QmVmb3JlVXBkYXRlV2l0aG91dERpZFVwZGF0ZS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIHNob3VsZCBiZSB1c2VkIHdpdGggY29tcG9uZW50RGlkVXBkYXRlKCkuIFRoaXMgY29tcG9uZW50IGRlZmluZXMgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBvbmx5LiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcygpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoKSBpcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGEgc3RhdGljIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgaXMgZGVmaW5lZCBhcyBhIHN0YXRpYyBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhbiBpbnN0YW5jZSBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9zdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICBpZiAoX3N0YXRlICYmICh0eXBlb2YgX3N0YXRlICE9PSAib2JqZWN0IiB8fCBpc0FycmF5Mihfc3RhdGUpKSkgewogICAgICAgICAgICAgIGVycm9yKCIlcy5zdGF0ZTogbXVzdCBiZSBzZXQgdG8gYW4gb2JqZWN0IG9yIG51bGwiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgY3Rvci5jaGlsZENvbnRleHRUeXBlcyAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuZ2V0Q2hpbGRDb250ZXh0KCk6IGNoaWxkQ29udGV4dFR5cGVzIG11c3QgYmUgZGVmaW5lZCBpbiBvcmRlciB0byB1c2UgZ2V0Q2hpbGRDb250ZXh0KCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZXIgPSBjbGFzc0NvbXBvbmVudFVwZGF0ZXI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gaW5zdGFuY2U7CiAgICAgICAgICBzZXQzKGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgewogICAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RJbnRlcm5hbEluc3RhbmNlID0gZmFrZUludGVybmFsSW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBwcm9wcykgewogICAgICAgICAgdmFyIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgdmFyIGNvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoImNvbnRleHRUeXBlIiBpbiBjdG9yKSB7CiAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSAoCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBudWxsIGZvciBjb25kaXRpb25hbCBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgY29udGV4dFR5cGUgPT09IG51bGwgfHwgY29udGV4dFR5cGUgIT09IHZvaWQgMCAmJiBjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFICYmIGNvbnRleHRUeXBlLl9jb250ZXh0ID09PSB2b2lkIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCAmJiAhZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9ICIiOwogICAgICAgICAgICAgICAgaWYgKGNvbnRleHRUeXBlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byB1bmRlZmluZWQuIFRoaXMgY2FuIGJlIGNhdXNlZCBieSBhIHR5cG8gb3IgYnkgbWl4aW5nIHVwIG5hbWVkIGFuZCBkZWZhdWx0IGltcG9ydHMuIFRoaXMgY2FuIGFsc28gaGFwcGVuIGR1ZSB0byBhIGNpcmN1bGFyIGRlcGVuZGVuY3ksIHNvIHRyeSBtb3ZpbmcgdGhlIGNyZWF0ZUNvbnRleHQoKSBjYWxsIHRvIGEgc2VwYXJhdGUgZmlsZS4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dFR5cGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYSAiICsgdHlwZW9mIGNvbnRleHRUeXBlICsgIi4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Qcm92aWRlciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLl9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuQ29uc3VtZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY29udGV4dFR5cGUpLmpvaW4oIiwgIikgKyAifS4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlZmluZXMgYW4gaW52YWxpZCBjb250ZXh0VHlwZS4gY29udGV4dFR5cGUgc2hvdWxkIHBvaW50IHRvIHRoZSBDb250ZXh0IG9iamVjdCByZXR1cm5lZCBieSBSZWFjdC5jcmVhdGVDb250ZXh0KCkuJXMiLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIsIGFkZGVuZHVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IGN0b3IuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGNvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgICAgY29udGV4dCA9IGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID8gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgOiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGUgIT09IG51bGwgJiYgaW5zdGFuY2Uuc3RhdGUgIT09IHZvaWQgMCA/IGluc3RhbmNlLnN0YXRlIDogbnVsbDsKICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBzdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCJgJXNgIHVzZXMgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYnV0IGl0cyBpbml0aWFsIHN0YXRlIGlzICVzLiBUaGlzIGlzIG5vdCByZWNvbW1lbmRlZC4gSW5zdGVhZCwgZGVmaW5lIHRoZSBpbml0aWFsIHN0YXRlIGJ5IGFzc2lnbmluZyBhbiBvYmplY3QgdG8gYHRoaXMuc3RhdGVgIGluIHRoZSBjb25zdHJ1Y3RvciBvZiBgJXNgLiBUaGlzIGVuc3VyZXMgdGhhdCBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBhcmd1bWVudHMgaGF2ZSBhIGNvbnNpc3RlbnQgc2hhcGUuIiwgY29tcG9uZW50TmFtZSwgaW5zdGFuY2Uuc3RhdGUgPT09IG51bGwgPyAibnVsbCIgOiAidW5kZWZpbmVkIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbE1vdW50TmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxVcGRhdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gImNvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJjb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICB2YXIgbmV3QXBpTmFtZSA9IHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiA/ICJnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSIgOiAiZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuaGFzKF9jb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlLmFkZChfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbnNhZmUgbGVnYWN5IGxpZmVjeWNsZXMgd2lsbCBub3QgYmUgY2FsbGVkIGZvciBjb21wb25lbnRzIHVzaW5nIG5ldyBjb21wb25lbnQgQVBJcy5cblxuJXMgdXNlcyAlcyBidXQgYWxzbyBjb250YWlucyB0aGUgZm9sbG93aW5nIGxlZ2FjeSBsaWZlY3ljbGVzOiVzJXMlc1xuXG5UaGUgYWJvdmUgbGlmZWN5Y2xlcyBzaG91bGQgYmUgcmVtb3ZlZC4gTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTpcbmh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMiLCBfY29tcG9uZW50TmFtZSwgbmV3QXBpTmFtZSwgZm91bmRXaWxsTW91bnROYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsTW91bnROYW1lIDogIiIsIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lIDogIiIsIGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxVcGRhdGVOYW1lIDogIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzTGVnYWN5Q29udGV4dENvbnN1bWVyKSB7CiAgICAgICAgICAgIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU3RhdGUgIT09IGluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbE1vdW50KCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IG9sZFN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gdGhpcy5zdGF0ZSBpcyBkZXByZWNhdGVkIChleGNlcHQgaW5zaWRlIGEgY29tcG9uZW50J3MgY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5yZWZzID0ge307CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBJdCBpcyBub3QgcmVjb21tZW5kZWQgdG8gYXNzaWduIHByb3BzIGRpcmVjdGx5IHRvIHN0YXRlIGJlY2F1c2UgdXBkYXRlcyB0byBwcm9wcyB3b24ndCBiZSByZWZsZWN0ZWQgaW4gc3RhdGUuIEluIG1vc3QgY2FzZXMsIGl0IGlzIGJldHRlciB0byB1c2UgcHJvcHMgZGlyZWN0bHkuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3Mod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgIT09ICJmdW5jdGlvbiIgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG9sZFByb3BzOwogICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MyID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3MyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID8gdW5yZXNvbHZlZE9sZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHVucmVzb2x2ZWRPbGRQcm9wcyk7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG9sZFByb3BzOwogICAgICAgICAgdmFyIHVucmVzb2x2ZWROZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgb2xkQ29udGV4dCA9IGluc3RhbmNlLmNvbnRleHQ7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV4dFVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBuZXh0Q29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBuZXh0VW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wczsKICAgICAgICAgIHZhciBoYXNOZXdMaWZlY3ljbGVzID0gdHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gdW5yZXNvbHZlZE5ld1Byb3BzIHx8IG9sZENvbnRleHQgIT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVzZXRIYXNGb3JjZVVwZGF0ZUJlZm9yZVByb2Nlc3NpbmcoKTsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIG5ld1N0YXRlID0gaW5zdGFuY2Uuc3RhdGUgPSBvbGRTdGF0ZTsKICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzID09PSB1bnJlc29sdmVkTmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgJiYgIWVuYWJsZUxhenlDb250ZXh0UHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB8fCBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCkgfHwgLy8gVE9ETzogSW4gc29tZSBjYXNlcywgd2UnbGwgZW5kIHVwIGNoZWNraW5nIGlmIGNvbnRleHQgaGFzIGNoYW5nZWQgdHdpY2UsCiAgICAgICAgICAvLyBib3RoIGJlZm9yZSBhbmQgYWZ0ZXIgYHNob3VsZENvbXBvbmVudFVwZGF0ZWAgaGFzIGJlZW4gY2FsbGVkLiBOb3QgaWRlYWwsCiAgICAgICAgICAvLyBidXQgSSdtIGxvYXRoIHRvIHJlZmFjdG9yIHRoaXMgZnVuY3Rpb24uIFRoaXMgb25seSBoYXBwZW5zIGZvciBtZW1vaXplZAogICAgICAgICAgLy8gY29tcG9uZW50cyBzbyBpdCdzIG5vdCB0aGF0IGNvbW1vbi4KICAgICAgICAgIGVuYWJsZUxhenlDb250ZXh0UHJvcGFnYXRpb247CiAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2UpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2UsCiAgICAgICAgICAgIHN0YWNrOiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2Qoc291cmNlKSwKICAgICAgICAgICAgZGlnZXN0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDYXB0dXJlZFZhbHVlKHZhbHVlLCBkaWdlc3QsIHN0YWNrKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgc291cmNlOiBudWxsLAogICAgICAgICAgICBzdGFjazogc3RhY2sgIT0gbnVsbCA/IHN0YWNrIDogbnVsbCwKICAgICAgICAgICAgZGlnZXN0OiBkaWdlc3QgIT0gbnVsbCA/IGRpZ2VzdCA6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbG9nQ2FwdHVyZWRFcnJvcihib3VuZGFyeSwgZXJyb3JJbmZvKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbG9nRXJyb3IgPSBzaG93RXJyb3JEaWFsb2coYm91bmRhcnksIGVycm9ySW5mbyk7CiAgICAgICAgICAgIGlmIChsb2dFcnJvciA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVycm9yMiA9IGVycm9ySW5mby52YWx1ZTsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICB2YXIgc291cmNlID0gZXJyb3JJbmZvLnNvdXJjZTsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBlcnJvckluZm8uc3RhY2s7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudFN0YWNrID0gc3RhY2sgIT09IG51bGwgPyBzdGFjayA6ICIiOwogICAgICAgICAgICAgIGlmIChlcnJvcjIgIT0gbnVsbCAmJiBlcnJvcjIuX3N1cHByZXNzTG9nZ2luZykgewogICAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IHNvdXJjZSA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoc291cmNlKSA6IG51bGw7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWVNZXNzYWdlID0gY29tcG9uZW50TmFtZSA/ICJUaGUgYWJvdmUgZXJyb3Igb2NjdXJyZWQgaW4gdGhlIDwiICsgY29tcG9uZW50TmFtZSArICI+IGNvbXBvbmVudDoiIDogIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiBvbmUgb2YgeW91ciBSZWFjdCBjb21wb25lbnRzOiI7CiAgICAgICAgICAgICAgdmFyIGVycm9yQm91bmRhcnlNZXNzYWdlOwogICAgICAgICAgICAgIGlmIChib3VuZGFyeS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TWVzc2FnZSA9ICJDb25zaWRlciBhZGRpbmcgYW4gZXJyb3IgYm91bmRhcnkgdG8geW91ciB0cmVlIHRvIGN1c3RvbWl6ZSBlcnJvciBoYW5kbGluZyBiZWhhdmlvci5cblZpc2l0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9lcnJvci1ib3VuZGFyaWVzIHRvIGxlYXJuIG1vcmUgYWJvdXQgZXJyb3IgYm91bmRhcmllcy4iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGJvdW5kYXJ5KSB8fCAiQW5vbnltb3VzIjsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIlJlYWN0IHdpbGwgdHJ5IHRvIHJlY3JlYXRlIHRoaXMgY29tcG9uZW50IHRyZWUgZnJvbSBzY3JhdGNoICIgKyAoInVzaW5nIHRoZSBlcnJvciBib3VuZGFyeSB5b3UgcHJvdmlkZWQsICIgKyBlcnJvckJvdW5kYXJ5TmFtZSArICIuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21iaW5lZE1lc3NhZ2UgPSBjb21wb25lbnROYW1lTWVzc2FnZSArICJcbiIgKyBjb21wb25lbnRTdGFjayArICJcblxuIiArICgiIiArIGVycm9yQm91bmRhcnlNZXNzYWdlKTsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGNvbWJpbmVkTWVzc2FnZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAkMSA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290RXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gewogICAgICAgICAgICBlbGVtZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVycm9yMiA9IGVycm9ySW5mby52YWx1ZTsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvblVuY2F1Z2h0RXJyb3IoZXJyb3IyKTsKICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKGZpYmVyLCBlcnJvckluZm8sIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLnRhZyA9IENhcHR1cmVVcGRhdGU7CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID0gZmliZXIudHlwZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3I7CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGVycm9ySW5mby52YWx1ZTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKGVycm9yJDEpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxvZ0NhcHR1cmVkRXJyb3IoZmliZXIsIGVycm9ySW5mbyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdCA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChpbnN0ICE9PSBudWxsICYmIHR5cGVvZiBpbnN0LmNvbXBvbmVudERpZENhdGNoID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uIGNhbGxiYWNrKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgbWFya0xlZ2FjeUVycm9yQm91bmRhcnlBc0ZhaWxlZCh0aGlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yJDEyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB0aGlzLmNvbXBvbmVudERpZENhdGNoKGVycm9yJDEyLCB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRTdGFjazogc3RhY2sgIT09IG51bGwgPyBzdGFjayA6ICIiCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKGZpYmVyLmxhbmVzLCBTeW5jTGFuZSkpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEVycm9yIGJvdW5kYXJpZXMgc2hvdWxkIGltcGxlbWVudCBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoKS4gSW4gdGhhdCBtZXRob2QsIHJldHVybiBhIHN0YXRlIHVwZGF0ZSB0byBkaXNwbGF5IGFuIGVycm9yIG1lc3NhZ2Ugb3IgZmFsbGJhY2sgVUkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaFBpbmdMaXN0ZW5lcihyb290Mywgd2FrZWFibGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlOwogICAgICAgICAgdmFyIHRocmVhZElEczsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCQxKCk7CiAgICAgICAgICAgIHRocmVhZElEcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJlYWRJRHMgPSBwaW5nQ2FjaGUuZ2V0KHdha2VhYmxlKTsKICAgICAgICAgICAgaWYgKHRocmVhZElEcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICBwaW5nQ2FjaGUuc2V0KHdha2VhYmxlLCB0aHJlYWRJRHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXRocmVhZElEcy5oYXMobGFuZXMpKSB7CiAgICAgICAgICAgIHRocmVhZElEcy5hZGQobGFuZXMpOwogICAgICAgICAgICB2YXIgcGluZyA9IHBpbmdTdXNwZW5kZWRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdha2VhYmxlLCBsYW5lcyk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FrZWFibGUudGhlbihwaW5nLCBwaW5nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgd2FrZWFibGVzID0gc3VzcGVuc2VCb3VuZGFyeS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh3YWtlYWJsZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdXBkYXRlUXVldWUuYWRkKHdha2VhYmxlKTsKICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS51cGRhdGVRdWV1ZSA9IHVwZGF0ZVF1ZXVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2FrZWFibGVzLmFkZCh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0U3VzcGVuZGVkQ29tcG9uZW50KHNvdXJjZUZpYmVyLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHZhciB0YWcgPSBzb3VyY2VGaWJlci50YWc7CiAgICAgICAgICBpZiAoKHNvdXJjZUZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiAodGFnID09PSBGdW5jdGlvbkNvbXBvbmVudCB8fCB0YWcgPT09IEZvcndhcmRSZWYyIHx8IHRhZyA9PT0gU2ltcGxlTWVtb0NvbXBvbmVudCkpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRTb3VyY2UgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50U291cmNlKSB7CiAgICAgICAgICAgICAgc291cmNlRmliZXIudXBkYXRlUXVldWUgPSBjdXJyZW50U291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50U291cmNlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBjdXJyZW50U291cmNlLmxhbmVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0U3VzcGVuc2VCb3VuZGFyeVRvQ2FwdHVyZShyZXR1cm5GaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSByZXR1cm5GaWJlcjsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCAmJiBzaG91bGRDYXB0dXJlU3VzcGVuc2Uobm9kZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlIChub2RlICE9PSBudWxsKTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKSB7CiAgICAgICAgICBpZiAoKHN1c3BlbnNlQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5ID09PSByZXR1cm5GaWJlcikgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgfD0gRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyAmPSB+KExpZmVjeWNsZUVmZmVjdE1hc2sgfCBJbmNvbXBsZXRlKTsKICAgICAgICAgICAgICBpZiAoc291cmNlRmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTb3VyY2VGaWJlciA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U291cmNlRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc291cmNlRmliZXIudGFnID0gSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgICAgICAgIGVucXVldWVVcGRhdGUoc291cmNlRmliZXIsIHVwZGF0ZSwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoc291cmNlRmliZXIubGFuZXMsIFN5bmNMYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3VzcGVuc2VCb3VuZGFyeTsKICAgICAgICAgIH0KICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkubGFuZXMgPSByb290UmVuZGVyTGFuZXM7CiAgICAgICAgICByZXR1cm4gc3VzcGVuc2VCb3VuZGFyeTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dFeGNlcHRpb24ocm9vdDMsIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgdmFsdWUsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgfD0gSW5jb21wbGV0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHZhbHVlLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHdha2VhYmxlID0gdmFsdWU7CiAgICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ29tcG9uZW50KHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIHNvdXJjZUZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgbWFya0RpZFRocm93V2hpbGVIeWRyYXRpbmdERVYoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN1c3BlbnNlQm91bmRhcnkgPSBnZXROZWFyZXN0U3VzcGVuc2VCb3VuZGFyeVRvQ2FwdHVyZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyAmPSB+Rm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgICBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghaW5jbHVkZXNTeW5jTGFuZShyb290UmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgICBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgdW5jYXVnaHRTdXNwZW5zZUVycm9yID0gbmV3IEVycm9yKCJBIGNvbXBvbmVudCBzdXNwZW5kZWQgd2hpbGUgcmVzcG9uZGluZyB0byBzeW5jaHJvbm91cyBpbnB1dC4gVGhpcyB3aWxsIGNhdXNlIHRoZSBVSSB0byBiZSByZXBsYWNlZCB3aXRoIGEgbG9hZGluZyBpbmRpY2F0b3IuIFRvIGZpeCwgdXBkYXRlcyB0aGF0IHN1c3BlbmQgc2hvdWxkIGJlIHdyYXBwZWQgd2l0aCBzdGFydFRyYW5zaXRpb24uIik7CiAgICAgICAgICAgICAgdmFsdWUgPSB1bmNhdWdodFN1c3BlbnNlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIHNvdXJjZUZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgdmFyIF9zdXNwZW5zZUJvdW5kYXJ5ID0gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIGlmIChfc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKChfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyAmIFNob3VsZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIF9zdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKF9zdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgcXVldWVIeWRyYXRpb25FcnJvcihjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcih2YWx1ZSwgc291cmNlRmliZXIpKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKTsKICAgICAgICAgIHJlbmRlckRpZEVycm9yKHZhbHVlKTsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzczIgPSByZXR1cm5GaWJlcjsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIF9lcnJvckluZm8gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIGxhbmUpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVJvb3RFcnJvclVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF9lcnJvckluZm8sIGxhbmUpOwogICAgICAgICAgICAgICAgZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgdXBkYXRlKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHZhciBlcnJvckluZm8gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHZhciBjdG9yID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncyAmJiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iIHx8IGluc3RhbmNlICE9PSBudWxsICYmIHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkpKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICAgICAgICB2YXIgX2xhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcywgX2xhbmUpOwogICAgICAgICAgICAgICAgICB2YXIgX3VwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBlcnJvckluZm8sIF9sYW5lKTsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgX3VwZGF0ZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiA9IHdvcmtJblByb2dyZXNzMi5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlICh3b3JrSW5Qcm9ncmVzczIgIT09IG51bGwpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5kZWRDYWNoZSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgdmFyIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0QmFkQ2xhc3M7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dENvbnRleHRUeXBlT25GdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRSZXZlYWxPcmRlcjsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VGFpbE9wdGlvbnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0QmFkQ2xhc3MgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlT25GdW5jdGlvbkNvbXBvbmVudCA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudCA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzID0gZmFsc2U7CiAgICAgICAgICBkaWRXYXJuQWJvdXRSZXZlYWxPcmRlciA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnMgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50NC5jaGlsZCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JjZVVubW91bnRDdXJyZW50QW5kUmVjb25jaWxlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZvcndhcmRSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByZW5kZXIyID0gQ29tcG9uZW50LnJlbmRlcjsKICAgICAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlcjIsIG5leHRQcm9wcywgcmVmLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlcjIsIG5leHRQcm9wcywgcmVmLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiAhZGlkUmVjZWl2ZVVwZGF0ZSkgewogICAgICAgICAgICBiYWlsb3V0SG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGhhc0lkKSB7CiAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBDb21wb25lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGlzU2ltcGxlRnVuY3Rpb25Db21wb25lbnQodHlwZSkgJiYgQ29tcG9uZW50LmNvbXBhcmUgPT09IG51bGwgJiYgLy8gU2ltcGxlTWVtb0NvbXBvbmVudCBjb2RlcGF0aCBkb2Vzbid0IHJlc29sdmUgb3V0ZXIgcHJvcHMgZWl0aGVyLgogICAgICAgICAgICBDb21wb25lbnQuZGVmYXVsdFByb3BzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRUeXBlID0gdHlwZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBTaW1wbGVNZW1vQ29tcG9uZW50OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZXNvbHZlZFR5cGUsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChDb21wb25lbnQuZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IFN1cHBvcnQgZm9yIGRlZmF1bHRQcm9wcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSBtZW1vIGNvbXBvbmVudHMgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVXNlIEphdmFTY3JpcHQgZGVmYXVsdCBwYXJhbWV0ZXJzIGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGQgPSBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMoQ29tcG9uZW50LnR5cGUsIG51bGwsIG5leHRQcm9wcywgd29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2hpbGQucmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjaGlsZDsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgX3R5cGUgPSBDb21wb25lbnQudHlwZTsKICAgICAgICAgICAgdmFyIF9pbm5lclByb3BUeXBlcyA9IF90eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgaWYgKF9pbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgX2lubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShfdHlwZSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudENoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB2YXIgaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ID0gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCkgewogICAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudENoaWxkLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIHZhciBjb21wYXJlID0gQ29tcG9uZW50LmNvbXBhcmU7CiAgICAgICAgICAgIGNvbXBhcmUgPSBjb21wYXJlICE9PSBudWxsID8gY29tcGFyZSA6IHNoYWxsb3dFcXVhbDI7CiAgICAgICAgICAgIGlmIChjb21wYXJlKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50NC5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgbmV4dFByb3BzKTsKICAgICAgICAgIG5ld0NoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIG91dGVyTWVtb1R5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgaWYgKG91dGVyTWVtb1R5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBvdXRlck1lbW9UeXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBvdXRlck1lbW9UeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IG91dGVyTWVtb1R5cGUgJiYgb3V0ZXJNZW1vVHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIChTaW1wbGVNZW1vQ29tcG9uZW50IGhhcyBubyBkZWZhdWx0UHJvcHMpCiAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShvdXRlck1lbW9UeXBlKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICBpZiAoc2hhbGxvd0VxdWFsMihwcmV2UHJvcHMsIG5leHRQcm9wcykgJiYgY3VycmVudDQucmVmID09PSB3b3JrSW5Qcm9ncmVzczIucmVmICYmIC8vIFByZXZlbnQgYmFpbG91dCBpZiB0aGUgaW1wbGVtZW50YXRpb24gY2hhbmdlZCBkdWUgdG8gaG90IHJlbG9hZC4KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPT09IGN1cnJlbnQ0LnR5cGUpIHsKICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcyA9IG5leHRQcm9wcyA9IHByZXZQcm9wczsKICAgICAgICAgICAgICBpZiAoIWNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBjdXJyZW50NC5sYW5lczsKICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgoY3VycmVudDQuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgOiBudWxsOwogICAgICAgICAgaWYgKG5leHRQcm9wcy5tb2RlID09PSAiaGlkZGVuIiB8fCBlbmFibGVMZWdhY3lIaWRkZW4pIHsKICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHsKICAgICAgICAgICAgICAgIGJhc2VMYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGNhY2hlUG9vbDogbnVsbCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5leHRTdGF0ZTsKICAgICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgT2Zmc2NyZWVuTGFuZSkpIHsKICAgICAgICAgICAgICB2YXIgc3Bhd25lZENhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5leHRCYXNlTGFuZXM7CiAgICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHByZXZCYXNlTGFuZXMgPSBwcmV2U3RhdGUuYmFzZUxhbmVzOwogICAgICAgICAgICAgICAgbmV4dEJhc2VMYW5lcyA9IG1lcmdlTGFuZXMocHJldkJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dEJhc2VMYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBsYW5lVG9MYW5lcyhPZmZzY3JlZW5MYW5lKTsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZSA9IHsKICAgICAgICAgICAgICAgIGJhc2VMYW5lczogbmV4dEJhc2VMYW5lcywKICAgICAgICAgICAgICAgIGNhY2hlUG9vbDogc3Bhd25lZENhY2hlUG9vbCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IF9uZXh0U3RhdGU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCBuZXh0QmFzZUxhbmVzKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZTIgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlMjsKICAgICAgICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzMiA9IHByZXZTdGF0ZSAhPT0gbnVsbCA/IHByZXZTdGF0ZS5iYXNlTGFuZXMgOiByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgc3VidHJlZVJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfc3VidHJlZVJlbmRlckxhbmVzOwogICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgX3N1YnRyZWVSZW5kZXJMYW5lcyA9IG1lcmdlTGFuZXMocHJldlN0YXRlLmJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgX3N1YnRyZWVSZW5kZXJMYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCBfc3VidHJlZVJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyYWdtZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNb2RlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVQcm9maWxlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgJiYgcmVmICE9PSBudWxsIHx8IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0LnJlZiAhPT0gcmVmKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWYyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZlN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hvdWxkRXJyb3Iod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIGNhc2UgZmFsc2U6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciB0ZW1wSW5zdGFuY2UgPSBuZXcgY3Rvcih3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcywgX2luc3RhbmNlLmNvbnRleHQpOwogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gdGVtcEluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICAgICAgX2luc3RhbmNlLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKF9pbnN0YW5jZSwgc3RhdGUsIG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgdHJ1ZTogewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gbmV3IEVycm9yKCJTaW11bGF0ZWQgZXJyb3IgY29taW5nIGZyb20gRGV2VG9vbHMiKTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgd29ya0luUHJvZ3Jlc3MyKSwgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGU7CiAgICAgICAgICBpZiAoaW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VW5pdE9mV29yayA9IGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgJiYgaW5zdC5wcm9wcyAhPT0gbmV4dFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSXQgbG9va3MgbGlrZSAlcyBpcyByZWFzc2lnbmluZyBpdHMgb3duIGB0aGlzLnByb3BzYCB3aGlsZSByZW5kZXJpbmcuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgY2FuIGxlYWQgdG8gY29uZnVzaW5nIGJ1Z3MuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJhIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRVbml0T2ZXb3JrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBtYXJrUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGRpZENhcHR1cmVFcnJvciA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmICghc2hvdWxkVXBkYXRlICYmICFkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgaWYgKGRpZENhcHR1cmVFcnJvciAmJiB0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAocm9vdDMucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLnBlbmRpbmdDb250ZXh0LCByb290My5wZW5kaW5nQ29udGV4dCAhPT0gcm9vdDMuY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QzLmNvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLmNvbnRleHQsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBjdXJyZW50IGZpYmVyLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcHJldkNoaWxkcmVuID0gcHJldlN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV4dFByb3BzLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGlmIChwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgIHZhciBvdmVycmlkZVN0YXRlID0gewogICAgICAgICAgICAgIGVsZW1lbnQ6IG5leHRDaGlsZHJlbiwKICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGNhY2hlOiBuZXh0U3RhdGUuY2FjaGUsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbmV4dFN0YXRlLnBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXMsCiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG5leHRTdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcuIEJlY2F1c2UgdGhlIGVycm9yIGhhcHBlbmVkIG91dHNpZGUgb2YgYSBTdXNwZW5zZSBib3VuZGFyeSwgdGhlIGVudGlyZSByb290IHdpbGwgc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0Q2hpbGRyZW4gIT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHZhciBfcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhpcyByb290IHJlY2VpdmVkIGFuIGVhcmx5IHVwZGF0ZSwgYmVmb3JlIGFueXRoaW5nIHdhcyBhYmxlIGh5ZHJhdGUuIFN3aXRjaGVkIHRoZSBlbnRpcmUgcm9vdCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgX3JlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVudGVySHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgIHZhciBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICAgIG5vZGUuZmxhZ3MgPSBub2RlLmZsYWdzICYgflBsYWNlbWVudCB8IEh5ZHJhdGluZzsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIGlmIChuZXh0Q2hpbGRyZW4gPT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiBudWxsOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBpc0RpcmVjdFRleHRDaGlsZCA9IHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIG5leHRQcm9wcyk7CiAgICAgICAgICBpZiAoaXNEaXJlY3RUZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAocHJldlByb3BzICE9PSBudWxsICYmIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByZXZQcm9wcykpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENvbnRlbnRSZXNldDsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0VGV4dChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExhenlDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IGVsZW1lbnRUeXBlOwogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgdmFyIENvbXBvbmVudCA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFRhZyA9IHdvcmtJblByb2dyZXNzMi50YWcgPSByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpOwogICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzMihDb21wb25lbnQsIHByb3BzKTsKICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgIHN3aXRjaCAocmVzb2x2ZWRUYWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcoQ29tcG9uZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcoQ29tcG9uZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVGb3J3YXJkUmVmKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIGZvciBvdXRlciBvbmx5CiAgICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVNZW1vQ29tcG9uZW50KAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgIENvbXBvbmVudCwKICAgICAgICAgICAgICAgIHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudC50eXBlLCByZXNvbHZlZFByb3BzKSwKICAgICAgICAgICAgICAgIC8vIFRoZSBpbm5lciB0eXBlIGNhbiBoYXZlIGRlZmF1bHRzIHRvbwogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoaW50ID0gIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQgIT09IG51bGwgJiYgdHlwZW9mIENvbXBvbmVudCA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICBoaW50ID0gIiBEaWQgeW91IHdyYXAgYSBjb21wb25lbnQgaW4gUmVhY3QubGF6eSgpIG1vcmUgdGhhbiBvbmNlPyI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQuIFJlY2VpdmVkIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvOiAiICsgQ29tcG9uZW50ICsgIi4gIiArICgiTGF6eSBlbGVtZW50IHR5cGUgbXVzdCByZXNvbHZlIHRvIGEgY2xhc3Mgb3IgZnVuY3Rpb24uIiArIGhpbnQpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgIHZhciBoYXNDb250ZXh0OwogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcyk7CiAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBjb250ZXh0OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudC5wcm90b3R5cGUgJiYgdHlwZW9mIENvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRCYWRDbGFzc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gaGF2ZSBhIHJlbmRlciBtZXRob2QsIGJ1dCBkb2Vzbid0IGV4dGVuZCBSZWFjdC5Db21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IHRvIGNhdXNlIGVycm9ycy4gQ2hhbmdlICVzIHRvIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgdmFsdWUgPSByZW5kZXJXaXRoSG9va3MobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIFJ1biB0aGVzZSBjaGVja3MgaW4gcHJvZHVjdGlvbiBvbmx5IGlmIHRoZSBmbGFnIGlzIG9mZi4KICAgICAgICAgICAgLy8gRXZlbnR1YWxseSB3ZSdsbCBkZWxldGUgdGhpcyBicmFuY2ggYWx0b2dldGhlci4KICAgICAgICAgICAgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDAKICAgICAgICAgICkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMiA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gdmFsdWUuc3RhdGUgIT09IG51bGwgJiYgdmFsdWUuc3RhdGUgIT09IHZvaWQgMCA/IHZhbHVlLnN0YXRlIDogbnVsbDsKICAgICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHZhbHVlKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IEZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4obnVsbCwgd29ya0luUHJvZ3Jlc3MyLCB2YWx1ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQpIHsKICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmNoaWxkQ29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogY2hpbGRDb250ZXh0VHlwZXMgY2Fubm90IGJlIGRlZmluZWQgb24gYSBmdW5jdGlvbiBjb21wb25lbnQuIiwgQ29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpOwogICAgICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gb3duZXJOYW1lIHx8ICIiOwogICAgICAgICAgICAgIHZhciBkZWJ1Z1NvdXJjZSA9IHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgaWYgKGRlYnVnU291cmNlKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nS2V5ID0gZGVidWdTb3VyY2UuZmlsZU5hbWUgKyAiOiIgKyBkZWJ1Z1NvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmc1t3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBiZSBnaXZlbiByZWZzLiBBdHRlbXB0cyB0byBhY2Nlc3MgdGhpcyByZWYgd2lsbCBmYWlsLiBEaWQgeW91IG1lYW4gdG8gdXNlIFJlYWN0LmZvcndhcmRSZWYoKT8lcyIsIGluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IFN1cHBvcnQgZm9yIGRlZmF1bHRQcm9wcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSBmdW5jdGlvbiBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTMgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIiwgX2NvbXBvbmVudE5hbWUzKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWU0ID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBjb250ZXh0VHlwZS4iLCBfY29tcG9uZW50TmFtZTQpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgU1VTUEVOREVEX01BUktFUiA9IHsKICAgICAgICAgIGRlaHlkcmF0ZWQ6IG51bGwsCiAgICAgICAgICB0cmVlQ29udGV4dDogbnVsbCwKICAgICAgICAgIHJldHJ5TGFuZTogTm9MYW5lCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgY2FjaGVQb29sOiBnZXRTdXNwZW5kZWRDYWNoZSgpLAogICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShwcmV2T2Zmc2NyZWVuU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IG1lcmdlTGFuZXMocHJldk9mZnNjcmVlblN0YXRlLmJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKSwKICAgICAgICAgICAgY2FjaGVQb29sLAogICAgICAgICAgICB0cmFuc2l0aW9uczogcHJldk9mZnNjcmVlblN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiByZW1vdmVMYW5lcyhjdXJyZW50NC5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkU3VzcGVuZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvd0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkU3VzcGVuZCA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChkaWRTdXNwZW5kIHx8IHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50NCkpIHsKICAgICAgICAgICAgc2hvd0ZhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH5EaWRDYXB0dXJlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBkZWh5ZHJhdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBmYWxsYmFja0ZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZGVoeWRyYXRlZCA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChfZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIF9kZWh5ZHJhdGVkLCBwcmV2U3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgX25leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuLCBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdGF0ZSA9IGN1cnJlbnQ0LmNoaWxkLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5tZW1vaXplZFN0YXRlID0gcHJldk9mZnNjcmVlblN0YXRlID09PSBudWxsID8gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgOiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLmNoaWxkTGFuZXMgPSBnZXRSZW1haW5pbmdXb3JrSW5QcmltYXJ5VHJlZShjdXJyZW50NCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4yID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzID0gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4yLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gX3ByaW1hcnlDaGlsZEZyYWdtZW50MzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIG1vZGUpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfQogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihvZmZzY3JlZW5Qcm9wcywgbW9kZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKG9mZnNjcmVlblByb3BzLCBtb2RlLCBOb0xhbmVzLCBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50NCwgb2Zmc2NyZWVuUHJvcHMpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50NCwgb2Zmc2NyZWVuUHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IFtjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50XTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHZhciBjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmc7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBJbiBsZWdhY3kgbW9kZSwgd2UgY29tbWl0IHRoZSBwcmltYXJ5IHRyZWUgYXMgaWYgaXQgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgIC8vIGNvbXBsZXRlZCwgZXZlbiB0aG91Z2ggaXQncyBpbiBhbiBpbmNvbnNpc3RlbnQgc3RhdGUuCiAgICAgICAgICAgIChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gTWFrZSBzdXJlIHdlJ3JlIG9uIHRoZSBzZWNvbmQgcGFzcywgaS5lLiB0aGUgcHJpbWFyeSBjaGlsZCBmcmFnbWVudCB3YXMKICAgICAgICAgICAgLy8gYWxyZWFkeSBjbG9uZWQuIEluIGxlZ2FjeSBtb2RlLCB0aGUgb25seSBjYXNlIHdoZXJlIHRoaXMgaXNuJ3QgdHJ1ZSBpcwogICAgICAgICAgICAvLyB3aGVuIERldlRvb2xzIGZvcmNlcyB1cyB0byBkaXNwbGF5IGEgZmFsbGJhY2s7IHdlIHNraXAgdGhlIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAvLyBwYXNzIGVudGlyZWx5IGFuZCBnbyBzdHJhaWdodCB0byByZW5kZXJpbmcgdGhlIGZhbGxiYWNrLiAoSW4gQ29uY3VycmVudAogICAgICAgICAgICAvLyBNb2RlLCBTdXNwZW5zZUxpc3QgY2FuIGFsc28gdHJpZ2dlciB0aGlzIHNjZW5hcmlvLCBidXQgdGhpcyBpcyBhIGxlZ2FjeS0KICAgICAgICAgICAgLy8gb25seSBjb2RlcGF0aC4pCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50CiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgcHJpbWFyeUNoaWxkUHJvcHMpOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50LCBmYWxsYmFja0NoaWxkcmVuKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICBpZiAocmVjb3ZlcmFibGVFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50NC5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyTW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIGZpYmVyTW9kZSk7CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgZmliZXJNb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50NC5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaHlkcmF0ZSBTdXNwZW5zZSBpbiBsZWdhY3kgbW9kZS4gU3dpdGNoIGZyb20gUmVhY3RET00uaHlkcmF0ZShlbGVtZW50LCBjb250YWluZXIpIHRvIFJlYWN0RE9NQ2xpZW50Lmh5ZHJhdGVSb290KGNvbnRhaW5lciwgPEFwcCAvPikucmVuZGVyKGVsZW1lbnQpIG9yIHJlbW92ZSB0aGUgU3VzcGVuc2UgY29tcG9uZW50cyBmcm9tIHRoZSBzZXJ2ZXIgcmVuZGVyZWQgY29tcG9uZW50cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhTeW5jTGFuZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKERlZmF1bHRIeWRyYXRpb25MYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKCFkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgIHdhcm5JZkh5ZHJhdGluZygpOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoCiAgICAgICAgICAgICAgICBjdXJyZW50NCwKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgIHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgICAgIC8vIFRPRE86IFdoZW4gd2UgZGVsZXRlIGxlZ2FjeSBtb2RlLCB3ZSBzaG91bGQgbWFrZSB0aGlzIGVycm9yIGFyZ3VtZW50CiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCDigJQgZXZlcnkgY29uY3VycmVudCBtb2RlIHBhdGggdGhhdCBjYXVzZXMgaHlkcmF0aW9uIHRvCiAgICAgICAgICAgICAgICAvLyBkZS1vcHQgdG8gY2xpZW50IHJlbmRlcmluZyBzaG91bGQgaGF2ZSBhbiBlcnJvciBtZXNzYWdlLgogICAgICAgICAgICAgICAgbnVsbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCwgbWVzc2FnZSwgc3RhY2s7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIF9nZXRTdXNwZW5zZUluc3RhbmNlRiA9IGdldFN1c3BlbnNlSW5zdGFuY2VGYWxsYmFja0Vycm9yRGV0YWlscyhzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5kaWdlc3Q7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICBzdGFjayA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5zdGFjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICBpZiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIlRoZSBzZXJ2ZXIgY291bGQgbm90IGZpbmlzaCB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LCBsaWtlbHkgZHVlIHRvIGFuIGVycm9yIGR1cmluZyBzZXJ2ZXIgcmVuZGVyaW5nLiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUoZXJyb3IyLCBkaWdlc3QsIHN0YWNrKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBjYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzQ29udGV4dENoYW5nZWQyID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIGN1cnJlbnQ0LmNoaWxkTGFuZXMpOwogICAgICAgICAgICBpZiAoZGlkUmVjZWl2ZVVwZGF0ZSB8fCBoYXNDb250ZXh0Q2hhbmdlZDIpIHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lID0gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBOb0xhbmUgJiYgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lOwogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShjdXJyZW50NCwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudDQsIGF0dGVtcHRIeWRyYXRpb25BdExhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhpcyBTdXNwZW5zZSBib3VuZGFyeSByZWNlaXZlZCBhbiB1cGRhdGUgYmVmb3JlIGl0IGZpbmlzaGVkIGh5ZHJhdGluZy4gVGhpcyBjYXVzZWQgdGhlIGJvdW5kYXJ5IHRvIHN3aXRjaCB0byBjbGllbnQgcmVuZGVyaW5nLiBUaGUgdXN1YWwgd2F5IHRvIGZpeCB0aGlzIGlzIHRvIHdyYXAgdGhlIG9yaWdpbmFsIHVwZGF0ZSBpbiBzdGFydFRyYW5zaXRpb24uIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeS5iaW5kKG51bGwsIGN1cnJlbnQ0KTsKICAgICAgICAgICAgICByZWdpc3RlclN1c3BlbnNlSW5zdGFuY2VSZXRyeShzdXNwZW5zZUluc3RhbmNlLCByZXRyeSk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZS50cmVlQ29udGV4dCk7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZTIgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZyB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZTIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50NCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0Lm1lbW9pemVkU3RhdGUgPSBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIoZmliZXIsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGZpcnN0Q2hpbGQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaXJzdENoaWxkOwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUxpc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZExhc3RDb250ZW50Um93KGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIHZhciByb3cgPSBmaXJzdENoaWxkOwogICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdyA9IHJvdzsKICAgICAgICAgICAgfQogICAgICAgICAgICByb3cgPSByb3cuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXN0Q29udGVudFJvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmV2ZWFsT3JkZXIgIT09IHZvaWQgMCAmJiByZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJ0b2dldGhlciIgJiYgIWRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXZlYWxPcmRlciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBVc2UgbG93ZXJjYXNlICIlcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZCI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBSZWFjdCB1c2VzIHRoZSAtcyBzdWZmaXggaW4gdGhlIHNwZWxsaW5nLiBVc2UgIiVzcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSBzdXBwb3J0ZWQgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignJXMgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0pIHsKICAgICAgICAgICAgICBpZiAodGFpbE1vZGUgIT09ICJjb2xsYXBzZWQiICYmIHRhaWxNb2RlICE9PSAiaGlkZGVuIikgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgdGFpbCBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gImNvbGxhcHNlZCIgb3IgImhpZGRlbiI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmV2ZWFsT3JkZXIgIT09ICJmb3J3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJiYWNrd2FyZHMiKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJzxTdXNwZW5zZUxpc3QgdGFpbD0iJXMiIC8+IGlzIG9ubHkgdmFsaWQgaWYgcmV2ZWFsT3JkZXIgaXMgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIi4gRGlkIHlvdSBtZWFuIHRvIHNwZWNpZnkgcmV2ZWFsT3JkZXI9ImZvcndhcmRzIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRTbG90LCBpbmRleDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzQW5BcnJheSA9IGlzQXJyYXkyKGNoaWxkU2xvdCk7CiAgICAgICAgICAgIHZhciBpc0l0ZXJhYmxlID0gIWlzQW5BcnJheSAmJiB0eXBlb2YgZ2V0SXRlcmF0b3JGbihjaGlsZFNsb3QpID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgICBpZiAoaXNBbkFycmF5IHx8IGlzSXRlcmFibGUpIHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IGlzQW5BcnJheSA/ICJhcnJheSIgOiAiaXRlcmFibGUiOwogICAgICAgICAgICAgIGVycm9yKCJBIG5lc3RlZCAlcyB3YXMgcGFzc2VkIHRvIHJvdyAjJXMgaW4gPFN1c3BlbnNlTGlzdCAvPi4gV3JhcCBpdCBpbiBhbiBhZGRpdGlvbmFsIFN1c3BlbnNlTGlzdCB0byBjb25maWd1cmUgaXRzIHJldmVhbE9yZGVyOiA8U3VzcGVuc2VMaXN0IHJldmVhbE9yZGVyPS4uLj4gLi4uIDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPnslc308L1N1c3BlbnNlTGlzdD4gLi4uIDwvU3VzcGVuc2VMaXN0PiIsIHR5cGUsIGluZGV4MiwgdHlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTdXNwZW5zZUxpc3RDaGlsZHJlbihjaGlsZHJlbiwgcmV2ZWFsT3JkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChyZXZlYWxPcmRlciA9PT0gImZvcndhcmRzIiB8fCByZXZlYWxPcmRlciA9PT0gImJhY2t3YXJkcyIpICYmIGNoaWxkcmVuICE9PSB2b2lkIDAgJiYgY2hpbGRyZW4gIT09IG51bGwgJiYgY2hpbGRyZW4gIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRyZW5baV0sIGkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihjaGlsZHJlbik7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuSXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwoY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5JdGVyYXRvcikgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGVwID0gY2hpbGRyZW5JdGVyYXRvci5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgc3RlcCA9IGNoaWxkcmVuSXRlcmF0b3IubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoc3RlcC52YWx1ZSwgX2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIF9pKys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBlcnJvcignQSBzaW5nbGUgcm93IHdhcyBwYXNzZWQgdG8gYSA8U3VzcGVuc2VMaXN0IHJldmVhbE9yZGVyPSIlcyIgLz4uIFRoaXMgaXMgbm90IHVzZWZ1bCBzaW5jZSBpdCBuZWVkcyBtdWx0aXBsZSByb3dzLiBEaWQgeW91IG1lYW4gdG8gcGFzcyBtdWx0aXBsZSBjaGlsZHJlbiBvciBhbiBhcnJheT8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGlzQmFja3dhcmRzLCB0YWlsLCBsYXN0Q29udGVudFJvdywgdGFpbE1vZGUpIHsKICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gewogICAgICAgICAgICAgIGlzQmFja3dhcmRzLAogICAgICAgICAgICAgIHJlbmRlcmluZzogbnVsbCwKICAgICAgICAgICAgICByZW5kZXJpbmdTdGFydFRpbWU6IDAsCiAgICAgICAgICAgICAgbGFzdDogbGFzdENvbnRlbnRSb3csCiAgICAgICAgICAgICAgdGFpbCwKICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVuZGVyU3RhdGUuaXNCYWNrd2FyZHMgPSBpc0JhY2t3YXJkczsKICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbnVsbDsKICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID0gMDsKICAgICAgICAgICAgcmVuZGVyU3RhdGUubGFzdCA9IGxhc3RDb250ZW50Um93OwogICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gdGFpbDsKICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbE1vZGUgPSB0YWlsTW9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcmV2ZWFsT3JkZXIgPSBuZXh0UHJvcHMucmV2ZWFsT3JkZXI7CiAgICAgICAgICB2YXIgdGFpbE1vZGUgPSBuZXh0UHJvcHMudGFpbDsKICAgICAgICAgIHZhciBuZXdDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhbGlkYXRlUmV2ZWFsT3JkZXIocmV2ZWFsT3JkZXIpOwogICAgICAgICAgdmFsaWRhdGVUYWlsT3B0aW9ucyh0YWlsTW9kZSwgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgdmFsaWRhdGVTdXNwZW5zZUxpc3RDaGlsZHJlbihuZXdDaGlsZHJlbiwgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgdmFyIHNob3VsZEZvcmNlRmFsbGJhY2sgPSBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgaWYgKHNob3VsZEZvcmNlRmFsbGJhY2spIHsKICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRCZWZvcmUgPSBjdXJyZW50NCAhPT0gbnVsbCAmJiAoY3VycmVudDQuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRCZWZvcmUpIHsKICAgICAgICAgICAgICBwcm9wYWdhdGVTdXNwZW5zZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIpIHsKICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkcyI6IHsKICAgICAgICAgICAgICAgIHZhciBsYXN0Q29udGVudFJvdyA9IGZpbmRMYXN0Q29udGVudFJvdyh3b3JrSW5Qcm9ncmVzczIuY2hpbGQpOwogICAgICAgICAgICAgICAgdmFyIHRhaWw7CiAgICAgICAgICAgICAgICBpZiAobGFzdENvbnRlbnRSb3cgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGFpbCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRhaWwgPSBsYXN0Q29udGVudFJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdy5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgdGFpbCwKICAgICAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3csCiAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkcyI6IHsKICAgICAgICAgICAgICAgIHZhciBfdGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgcm93ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByb3c7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG5leHRSb3cgPSByb3cuc2libGluZzsKICAgICAgICAgICAgICAgICAgcm93LnNpYmxpbmcgPSBfdGFpbDsKICAgICAgICAgICAgICAgICAgX3RhaWwgPSByb3c7CiAgICAgICAgICAgICAgICAgIHJvdyA9IG5leHRSb3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgX3RhaWwsCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSAidG9nZXRoZXIiOiB7CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIHRhaWwKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgLy8gbGFzdAogICAgICAgICAgICAgICAgICB2b2lkIDAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUG9ydGFsQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0UHJvdmlkZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcHJvdmlkZXJUeXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHByb3ZpZGVyVHlwZS5fY29udGV4dDsKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IG5ld1Byb3BzLnZhbHVlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoISgidmFsdWUiIGluIG5ld1Byb3BzKSkgewogICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIpIHsKICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgYHZhbHVlYCBwcm9wIGlzIHJlcXVpcmVkIGZvciB0aGUgYDxDb250ZXh0LlByb3ZpZGVyPmAuIERpZCB5b3UgbWlzc3BlbGwgaXQgb3IgZm9yZ2V0IHRvIHBhc3MgaXQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm92aWRlclByb3BUeXBlcyA9IHdvcmtJblByb2dyZXNzMi50eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgaWYgKHByb3ZpZGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvdmlkZXJQcm9wVHlwZXMsIG5ld1Byb3BzLCAicHJvcCIsICJDb250ZXh0LlByb3ZpZGVyIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHB1c2hQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIG5ld1ZhbHVlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG9sZFZhbHVlID0gb2xkUHJvcHMudmFsdWU7CiAgICAgICAgICAgICAgaWYgKG9iamVjdElzKG9sZFZhbHVlLCBuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRQcm9wcy5jaGlsZHJlbiA9PT0gbmV3UHJvcHMuY2hpbGRyZW4gJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJvcGFnYXRlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBuZXdQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRleHRDb25zdW1lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjb250ZXh0Ll9jb250ZXh0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAoY29udGV4dCAhPT0gY29udGV4dC5Db25zdW1lcikgewogICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlcmluZyA8Q29udGV4dD4gZGlyZWN0bHkgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byByZW5kZXIgPENvbnRleHQuQ29uc3VtZXI+IGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0Ll9jb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHJlbmRlcjIgPSBuZXdQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZW5kZXIyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29udGV4dCBjb25zdW1lciB3YXMgcmVuZGVyZWQgd2l0aCBtdWx0aXBsZSBjaGlsZHJlbiwgb3IgYSBjaGlsZCB0aGF0IGlzbid0IGEgZnVuY3Rpb24uIEEgY29udGV4dCBjb25zdW1lciBleHBlY3RzIGEgc2luZ2xlIGNoaWxkIHRoYXQgaXMgYSBmdW5jdGlvbi4gSWYgeW91IGRpZCBwYXNzIGEgZnVuY3Rpb24sIG1ha2Ugc3VyZSB0aGVyZSBpcyBubyB0cmFpbGluZyBvciBsZWFkaW5nIHdoaXRlc3BhY2UgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDaGlsZHJlbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgbmV3Q2hpbGRyZW4gPSByZW5kZXIyKG5ld1ZhbHVlKTsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCkgewogICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGN1cnJlbnQ0LmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBjdXJyZW50NC5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcykpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjbG9uZUNoaWxkRmliZXJzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVtb3VudEZpYmVyKGN1cnJlbnQ0LCBvbGRXb3JrSW5Qcm9ncmVzcywgbmV3V29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gb2xkV29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBzd2FwIHRoZSByb290IGZpYmVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQ0LmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIG9sZFdvcmtJblByb2dyZXNzLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLmluZGV4ID0gb2xkV29ya0luUHJvZ3Jlc3MuaW5kZXg7CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnNpYmxpbmcgPSBvbGRXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZXR1cm4gPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnJlZiA9IG9sZFdvcmtJblByb2dyZXNzLnJlZjsKICAgICAgICAgICAgaWYgKG9sZFdvcmtJblByb2dyZXNzID09PSByZXR1cm5GaWJlci5jaGlsZCkgewogICAgICAgICAgICAgIHJldHVybkZpYmVyLmNoaWxkID0gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHByZXZTaWJsaW5nID0gcmV0dXJuRmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKHByZXZTaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHBhcmVudCB0byBoYXZlIGEgY2hpbGQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChwcmV2U2libGluZy5zaWJsaW5nICE9PSBvbGRXb3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgcHJldlNpYmxpbmcgPSBwcmV2U2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKHByZXZTaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCB0aGUgcHJldmlvdXMgc2libGluZy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldlNpYmxpbmcuc2libGluZyA9IG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY3VycmVudDRdOwogICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY3VycmVudDQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgcmV0dXJuIG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgdXBkYXRlTGFuZXMgPSBjdXJyZW50NC5sYW5lczsKICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHVwZGF0ZUxhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0RWFybHlCYWlsb3V0SWZOb1NjaGVkdWxlZFVwZGF0ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHB1c2hIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOiB7CiAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMudmFsdWU7CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICBwdXNoUHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCBuZXdWYWx1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgaGFzQ2hpbGRXb3JrID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChoYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICAgIHN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkTGFuZXMgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzOwogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCBwcmltYXJ5Q2hpbGRMYW5lcykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gKGN1cnJlbnQ0LmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgICAgdmFyIF9oYXNDaGlsZFdvcmsgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kQmVmb3JlKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJlZ2luV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5fZGVidWdOZWVkc1JlbW91bnQgJiYgY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVtb3VudEZpYmVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyh3b3JrSW5Qcm9ncmVzczIudHlwZSwgd29ya0luUHJvZ3Jlc3MyLmtleSwgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcywgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z093bmVyIHx8IG51bGwsIHdvcmtJblByb2dyZXNzMi5tb2RlLCB3b3JrSW5Qcm9ncmVzczIubGFuZXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgaGFzQ29udGV4dENoYW5nZWQoKSB8fCAvLyBGb3JjZSBhIHJlLXJlbmRlciBpZiB0aGUgaW1wbGVtZW50YXRpb24gY2hhbmdlZCBkdWUgdG8gaG90IHJlbG9hZDoKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IGN1cnJlbnQ0LnR5cGUpIHsKICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ID0gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQgJiYgLy8gSWYgdGhpcyBpcyB0aGUgc2Vjb25kIHBhc3Mgb2YgYW4gZXJyb3Igb3Igc3VzcGVuc2UgYm91bmRhcnksIHRoZXJlCiAgICAgICAgICAgICAgLy8gbWF5IG5vdCBiZSB3b3JrIHNjaGVkdWxlZCBvbiBgY3VycmVudGAsIHNvIHdlIGNoZWNrIGZvciB0aGlzIGZsYWcuCiAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm4gYXR0ZW1wdEVhcmx5QmFpbG91dElmTm9TY2hlZHVsZWRVcGRhdGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChjdXJyZW50NC5mbGFncyAmIEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2UpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBpc0ZvcmtlZENoaWxkKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICB2YXIgc2xvdEluZGV4ID0gd29ya0luUHJvZ3Jlc3MyLmluZGV4OwogICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gZ2V0Rm9ya3NBdExldmVsKCk7CiAgICAgICAgICAgICAgcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MsIHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5kZXRlcm1pbmF0ZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIudHlwZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF6eUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBlbGVtZW50VHlwZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciB1bnJlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciByZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBDb21wb25lbnQgPyB1bnJlc29sdmVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihDb21wb25lbnQsIHVucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50ID8gX3VucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKF9Db21wb25lbnQsIF91bnJlc29sdmVkUHJvcHMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfQ29tcG9uZW50LCBfcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0Um9vdChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdFRleHQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6IHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzMiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzMiA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gdHlwZSA/IF91bnJlc29sdmVkUHJvcHMyIDogcmVzb2x2ZURlZmF1bHRQcm9wczIodHlwZSwgX3VucmVzb2x2ZWRQcm9wczIpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIF9yZXNvbHZlZFByb3BzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZyYWdtZW50MTA6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgTW9kZToKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQcm9maWxlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzMyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKF90eXBlMiwgX3VucmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IF90eXBlMi5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlMikKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKF90eXBlMi50eXBlLCBfcmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF90eXBlMiwgX3Jlc29sdmVkUHJvcHMzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50MiA/IF91bnJlc29sdmVkUHJvcHM0IDogcmVzb2x2ZURlZmF1bHRQcm9wczIoX0NvbXBvbmVudDIsIF91bnJlc29sdmVkUHJvcHM0KTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX0NvbXBvbmVudDIsIF9yZXNvbHZlZFByb3BzNCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biB1bml0IG9mIHdvcmsgdGFnICgiICsgd29ya0luUHJvZ3Jlc3MyLnRhZyArICIpLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZjI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWZTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhcHBlbmRBbGxDaGlsZHJlbjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbnRhaW5lcjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbXBvbmVudCQxOwogICAgICAgIHZhciB1cGRhdGVIb3N0VGV4dCQxOwogICAgICAgIHsKICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuID0gZnVuY3Rpb24ocGFyZW50LCB3b3JrSW5Qcm9ncmVzczIsIG5lZWRzVmlzaWJpbGl0eVRvZ2dsZSwgaXNIaWRkZW4pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudCwgbm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaWYgKG9sZFByb3BzID09PSBuZXdQcm9wcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBwcmVwYXJlVXBkYXRlKGluc3RhbmNlLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgY3VycmVudEhvc3RDb250ZXh0KTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgICBpZiAob2xkVGV4dCAhPT0gbmV3VGV4dCkgewogICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBoYXNSZW5kZXJlZEFUYWlsRmFsbGJhY2spIHsKICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAocmVuZGVyU3RhdGUudGFpbE1vZGUpIHsKICAgICAgICAgICAgY2FzZSAiaGlkZGVuIjogewogICAgICAgICAgICAgIHZhciB0YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIGxhc3RUYWlsTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgd2hpbGUgKHRhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZSA9IHRhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFpbE5vZGUgPSB0YWlsTm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJjb2xsYXBzZWQiOiB7CiAgICAgICAgICAgICAgdmFyIF90YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIF9sYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlIChfdGFpbE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChfdGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIF9sYXN0VGFpbE5vZGUgPSBfdGFpbE5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfdGFpbE5vZGUgPSBfdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKF9sYXN0VGFpbE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrICYmIHJlbmRlclN0YXRlLnRhaWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBidWJibGVQcm9wZXJ0aWVzKGNvbXBsZXRlZFdvcmspIHsKICAgICAgICAgIHZhciBkaWRCYWlsb3V0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGUgIT09IG51bGwgJiYgY29tcGxldGVkV29yay5hbHRlcm5hdGUuY2hpbGQgPT09IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIGlmICghZGlkQmFpbG91dCkgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgdHJlZUJhc2VEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhjaGlsZC5sYW5lcywgY2hpbGQuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IGNoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIGFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdHJlZUJhc2VEdXJhdGlvbiArPSBjaGlsZC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uID0gYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay50cmVlQmFzZUR1cmF0aW9uID0gdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZC5sYW5lcywgX2NoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuc3VidHJlZUZsYWdzOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIF9jaGlsZC5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuc3VidHJlZUZsYWdzIHw9IHN1YnRyZWVGbGFnczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgX3RyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIF9jaGlsZDIgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZDIubGFuZXMsIF9jaGlsZDIuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDIuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIF90cmVlQmFzZUR1cmF0aW9uICs9IF9jaGlsZDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIF9jaGlsZDIgPSBfY2hpbGQyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IF90cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY2hpbGQzID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQzLmxhbmVzLCBfY2hpbGQzLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQzLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfY2hpbGQzLnJldHVybiA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgICAgICBfY2hpbGQzID0gX2NoaWxkMy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgICBjb21wbGV0ZWRXb3JrLmNoaWxkTGFuZXMgPSBuZXdDaGlsZExhbmVzOwogICAgICAgICAgcmV0dXJuIGRpZEJhaWxvdXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlRGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dFN0YXRlKSB7CiAgICAgICAgICBpZiAoaGFzVW5oeWRyYXRlZFRhaWxOb2RlcygpICYmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyIHwgSW5jb21wbGV0ZSB8IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsICYmIG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICghd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQSBkZWh5ZHJhdGVkIHN1c3BlbnNlIGNvbXBvbmVudCB3YXMgY29tcGxldGVkIHdpdGhvdXQgYSBoeWRyYXRlZCBub2RlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpc1RpbWVkT3V0U3VzcGVuc2UgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChpc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoX2lzVGltZWRPdXRTdXNwZW5zZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9wcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gX3ByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQxMDoKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciBmaWJlclJvb3QgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBpZiAoZmliZXJSb290LnBlbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBmaWJlclJvb3QuY29udGV4dCA9IGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dDsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHdhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmICh3YXNIeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgY2xpZW50IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICFwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkIHx8IC8vIENoZWNrIGlmIHdlIHJldmVydGVkIHRvIGNsaWVudCByZW5kZXJpbmcgKGUuZy4gZHVlIHRvIGFuIGVycm9yKQogICAgICAgICAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSAhPT0gTm9GbGFncwogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NC5yZWYgIT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghbmV3UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SG9zdENvbnRleHQgPSBnZXRIb3N0Q29udGV4dCgpOwogICAgICAgICAgICAgICAgdmFyIF93YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjcmVhdGVJbnN0YW5jZSh0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuKGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGluc3RhbmNlLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBuZXdQcm9wczsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgJiYgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld1RleHQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBtdXN0IGhhdmUgbmV3IHByb3BzIGZvciBuZXcgbW91bnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3Jvb3RDb250YWluZXJJbnN0YW5jZSA9IGdldFJvb3RIb3N0Q29udGFpbmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgX2N1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkMiA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkMikgewogICAgICAgICAgICAgICAgICBpZiAocHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGNyZWF0ZVRleHRJbnN0YW5jZShuZXdUZXh0LCBfcm9vdENvbnRhaW5lckluc3RhbmNlLCBfY3VycmVudEhvc3RDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoID0gY29tcGxldGVEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0U3RhdGUpOwogICAgICAgICAgICAgICAgaWYgKCFmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHREaWRUaW1lb3V0ID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBwcmV2RGlkVGltZW91dCA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0ICE9PSBwcmV2RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfb2Zmc2NyZWVuRmliZXIyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuRmliZXIyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBoYXNJbnZpc2libGVDaGlsZENvbnRleHQgPSBjdXJyZW50NCA9PT0gbnVsbCAmJiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMudW5zdGFibGVfYXZvaWRUaGlzRmFsbGJhY2sgIT09IHRydWUgfHwgIWVuYWJsZVN1c3BlbnNlQXZvaWRUaGlzRmFsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIGlmIChoYXNJbnZpc2libGVDaGlsZENvbnRleHQgfHwgaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHdha2VhYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwcmVwYXJlUG9ydGFsTW91bnQod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKF9Db21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQWxyZWFkeSA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRUYWlsID0gcmVuZGVyU3RhdGUucmVuZGVyaW5nOwogICAgICAgICAgICAgIGlmIChyZW5kZXJlZFRhaWwgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbm5vdEJlU3VzcGVuZGVkID0gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgJiYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKTsKICAgICAgICAgICAgICAgICAgaWYgKCFjYW5ub3RCZVN1c3BlbmRlZCkgewogICAgICAgICAgICAgICAgICAgIHZhciByb3cgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyb3cpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHN1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RoZW5hYmxlcyA9IHN1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG5ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgICAgICAgICByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCAmJiBub3coKSA+IGdldFJlbmRlclRhcmdldFRpbWUoKSkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgX3N1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyZW5kZXJlZFRhaWwpOwogICAgICAgICAgICAgICAgICBpZiAoX3N1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX25ld1RoZW5hYmxlcyA9IF9zdXNwZW5kZWQudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9uZXdUaGVuYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IF9uZXdUaGVuYWJsZXM7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsID09PSBudWxsICYmIHJlbmRlclN0YXRlLnRhaWxNb2RlID09PSAiaGlkZGVuIiAmJiAhcmVuZGVyZWRUYWlsLmFsdGVybmF0ZSAmJiAhZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgICAgIC8vIFRoZSB0aW1lIGl0IHRvb2sgdG8gcmVuZGVyIGxhc3Qgcm93IGlzIGdyZWF0ZXIgdGhhbiB0aGUgcmVtYWluaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gdGltZSB3ZSBoYXZlIHRvIHJlbmRlci4gU28gcmVuZGVyaW5nIG9uZSBtb3JlIHJvdyB3b3VsZCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICAvLyBleGNlZWQgaXQuCiAgICAgICAgICAgICAgICAgICAgbm93KCkgKiAyIC0gcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpICYmIHJlbmRlckxhbmVzMiAhPT0gT2Zmc2NyZWVuTGFuZQogICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gU29tZVJldHJ5TGFuZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLmlzQmFja3dhcmRzKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlcmVkVGFpbC5zaWJsaW5nID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gcmVuZGVyU3RhdGUubGFzdDsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzU2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzU2libGluZy5zaWJsaW5nID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG5leHQgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbmV4dDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBuZXh0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPSBub3coKTsKICAgICAgICAgICAgICAgIG5leHQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHZhciBuZXh0SXNIaWRkZW4gPSBfbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIF9wcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIHByZXZJc0hpZGRlbiA9IF9wcmV2U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocHJldklzSGlkZGVuICE9PSBuZXh0SXNIaWRkZW4gJiYgLy8gTGVnYWN5SGlkZGVuIGRvZXNuJ3QgZG8gYW55IGhpZGluZyDigJQgaXQgb25seSBwcmUtcmVuZGVycy4KICAgICAgICAgICAgICAgICFlbmFibGVMZWdhY3lIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghbmV4dElzSGlkZGVuIHx8ICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHN1YnRyZWVSZW5kZXJMYW5lcywgT2Zmc2NyZWVuTGFuZSkpIHsKICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgJiAoUGxhY2VtZW50IHwgVXBkYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICB2YXIgX2ZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmICgoX2ZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgIT09IE5vRmxhZ3MgJiYgKF9mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaHJldyBpbiBuZXdseSBtb3VudGVkIGRlaHlkcmF0ZWQgY29tcG9uZW50LiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfZmxhZ3MyID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChfZmxhZ3MyICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gX2ZsYWdzMiAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50NCwgaW50ZXJydXB0ZWRXb3JrLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKGludGVycnVwdGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHRUeXBlcyA9IGludGVycnVwdGVkV29yay50eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICAgIGlmIChjaGlsZENvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjaGlsZENvbnRleHRUeXBlcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBpbnRlcnJ1cHRlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGludGVycnVwdGVkV29yay50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyhpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha1NldCA9IHR5cGVvZiBXZWFrU2V0ID09PSAiZnVuY3Rpb24iID8gV2Vha1NldCA6IFNldDsKICAgICAgICB2YXIgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIgPSBmdW5jdGlvbihjdXJyZW50NCwgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50NC5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQsIGN1cnJlbnQ0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxVbm1vdW50V2l0aFRpbWVyKGN1cnJlbnQ0LCBpbnN0YW5jZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUF0dGFjaFJlZihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGN1cnJlbnQ0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgcmVmID0gY3VycmVudDQucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciByZXRWYWw7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyICYmIGVuYWJsZVByb2ZpbGVyQ29tbWl0SG9va3MgJiYgY3VycmVudDQubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldFZhbCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZXR1cm4gdmFsdWUgZnJvbSBhIGNhbGxiYWNrIHJlZiBpbiAlcy4gQSBjYWxsYmFjayByZWYgc2hvdWxkIG5vdCByZXR1cm4gYSBmdW5jdGlvbi4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnQ0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsRGVzdHJveShjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZm9jdXNlZEluc3RhbmNlSGFuZGxlID0gbnVsbDsKICAgICAgICB2YXIgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaXJzdENoaWxkKSB7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBwcmVwYXJlRm9yQ29tbWl0KHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfYmVnaW4oKTsKICAgICAgICAgIHZhciBzaG91bGRGaXJlID0gc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyOwogICAgICAgICAgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHNob3VsZEZpcmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIEJlZm9yZU11dGF0aW9uTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKChmbGFncyAmIFNuYXBzaG90KSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgc25hcHNob3QgPSBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZShmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgPT09IGZpbmlzaGVkV29yay50eXBlID8gcHJldlByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoZmluaXNoZWRXb3JrLnR5cGUsIHByZXZQcm9wcyksIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlkV2FyblNldCA9IGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChzbmFwc2hvdCA9PT0gdm9pZCAwICYmICFkaWRXYXJuU2V0LmhhcyhmaW5pc2hlZFdvcmsudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5TZXQuYWRkKGZpbmlzaGVkV29yay50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpOiBBIHNuYXBzaG90IHZhbHVlIChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUgPSBzbmFwc2hvdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChmbGFncywgZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjcmVhdGUgPSBlZmZlY3QuY3JlYXRlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IGNyZWF0ZSgpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCAmJiB0eXBlb2YgZGVzdHJveSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVmZmVjdC50YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQgbnVsbC4gSWYgeW91ciBlZmZlY3QgZG9lcyBub3QgcmVxdWlyZSBjbGVhbiB1cCwgcmV0dXJuIHVuZGVmaW5lZCAob3Igbm90aGluZykuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZXN0cm95LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIlxuXG5JdCBsb29rcyBsaWtlIHlvdSB3cm90ZSAiICsgaG9va05hbWUgKyAiKGFzeW5jICgpID0+IC4uLikgb3IgcmV0dXJuZWQgYSBQcm9taXNlLiBJbnN0ZWFkLCB3cml0ZSB0aGUgYXN5bmMgZnVuY3Rpb24gaW5zaWRlIHlvdXIgZWZmZWN0IGFuZCBjYWxsIGl0IGltbWVkaWF0ZWx5OlxuXG4iICsgaG9va05hbWUgKyAiKCgpID0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKCkge1xuICAgIC8vIFlvdSBjYW4gYXdhaXQgaGVyZVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTXlBUEkuZ2V0RGF0YShzb21lSWQpO1xuICAgIC8vIC4uLlxuICB9XG4gIGZldGNoRGF0YSgpO1xufSwgW3NvbWVJZF0pOyAvLyBPciBbXSBpZiBlZmZlY3QgZG9lc24ndCBuZWVkIHByb3BzIG9yIHN0YXRlXG5cbkxlYXJuIG1vcmUgYWJvdXQgZGF0YSBmZXRjaGluZyB3aXRoIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaG9va3MtZGF0YS1mZXRjaGluZyI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQ6ICIgKyBkZXN0cm95OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgbXVzdCBub3QgcmV0dXJuIGFueXRoaW5nIGJlc2lkZXMgYSBmdW5jdGlvbiwgd2hpY2ggaXMgdXNlZCBmb3IgY2xlYW4tdXAuJXMiLCBob29rTmFtZSwgYWRkZW5kdW0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGlkID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLmlkLCBvblBvc3RDb21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUub25Qb3N0Q29tbWl0OwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGUgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUG9zdENvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUG9zdENvbW1pdChpZCwgcGhhc2UsIHBhc3NpdmVFZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIoZmluaXNoZWRSb290LCBjdXJyZW50NCwgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoZmluaXNoZWRXb3JrLnR5cGUsIGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgY29tcG9uZW50RGlkVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIHVwZGF0ZSBxdWV1ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCB1cGRhdGVRdWV1ZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAoX3VwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsuY2hpbGQudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnN0YW5jZSA9IGdldFB1YmxpY0luc3RhbmNlKGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnN0YW5jZSA9IGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIF91cGRhdGVRdWV1ZSwgX2luc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UyID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCAmJiBmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaW5pc2hlZFdvcmsudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIGNvbW1pdE1vdW50KF9pbnN0YW5jZTIsIHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjogewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplMiA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLCBvbkNvbW1pdCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZTIub25Db21taXQsIG9uUmVuZGVyID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vblJlbmRlcjsKICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdER1cmF0aW9uID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgdmFyIGNvbW1pdFRpbWUyID0gZ2V0Q29tbWl0VGltZSgpOwogICAgICAgICAgICAgICAgICB2YXIgcGhhc2UgPSBjdXJyZW50NCA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25SZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBvblJlbmRlcihmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcy5pZCwgcGhhc2UsIGZpbmlzaGVkV29yay5hY3R1YWxEdXJhdGlvbiwgZmluaXNoZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24sIGZpbmlzaGVkV29yay5hY3R1YWxTdGFydFRpbWUsIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvbkNvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgb25Db21taXQoZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMuaWQsIHBoYXNlLCBlZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbnF1ZXVlUGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgb3V0ZXI6IHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gKz0gZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIobm9kZSkgewogICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24obm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChub2RlLCBub2RlLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzYWZlbHlBdHRhY2hSZWYobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4oZmluaXNoZWRXb3JrLCBpc0hpZGRlbikgewogICAgICAgICAgdmFyIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBub2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgaGlkZUluc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdW5oaWRlSW5zdGFuY2Uobm9kZS5zdGF0ZU5vZGUsIG5vZGUubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlVGV4dEluc3RhbmNlKF9pbnN0YW5jZTMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMywgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKG5vZGUudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgfHwgbm9kZS50YWcgPT09IExlZ2FjeUhpZGRlbkNvbXBvbmVudCkgJiYgbm9kZS5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIG5vZGUgIT09IGZpbmlzaGVkV29yaykgOwogICAgICAgICAgICAgIGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbm9kZSkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgcmVmID0gZmluaXNoZWRXb3JrLnJlZjsKICAgICAgICAgIGlmIChyZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGluc3RhbmNlVG9Vc2U7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIGluc3RhbmNlVG9Vc2UgPSBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghcmVmLmhhc093blByb3BlcnR5KCJjdXJyZW50IikpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmVmIG9iamVjdCBwcm92aWRlZCBmb3IgJXMuIFVzZSBlaXRoZXIgYSByZWYtc2V0dGVyIGZ1bmN0aW9uIG9yIFJlYWN0LmNyZWF0ZVJlZigpLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hGaWJlck11dGF0aW9uKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUucmV0dXJuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZpYmVyLnJldHVybiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhhbHRlcm5hdGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZXRhY2hEZWxldGVkSW5zdGFuY2UoaG9zdEluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFBhcmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaXNIb3N0UGFyZW50KHBhcmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgYSBob3N0IHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgfHwgZmliZXIudGFnID09PSBIb3N0UG9ydGFsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0U2libGluZyhmaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgIHNpYmxpbmdzOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IGlzSG9zdFBhcmVudChub2RlLnJldHVybikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAobm9kZS50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgbm9kZS50YWcgIT09IEhvc3RUZXh0ICYmIG5vZGUudGFnICE9PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5mbGFncyAmIFBsYWNlbWVudCkgewogICAgICAgICAgICAgICAgY29udGludWUgc2libGluZ3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkID09PSBudWxsIHx8IG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKG5vZGUuZmxhZ3MgJiBQbGFjZW1lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGdldEhvc3RQYXJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAocGFyZW50RmliZXIuZmxhZ3MgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQocGFyZW50KTsKICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyLmZsYWdzICY9IH5Db250ZW50UmVzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBiZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShmaW5pc2hlZFdvcmssIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB2YXIgX3BhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgIHZhciBfYmVmb3JlID0gZ2V0SG9zdFNpYmxpbmcoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGZpbmlzaGVkV29yaywgX2JlZm9yZSwgX3BhcmVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9zdCBwYXJlbnQgZmliZXIuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihwYXJlbnQsIHN0YXRlTm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlKHBhcmVudCwgc3RhdGVOb2RlLCBiZWZvcmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFwcGVuZENoaWxkKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUoY2hpbGQsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICB2YXIgc2libGluZyA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgd2hpbGUgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaG9zdFBhcmVudCA9IG51bGw7CiAgICAgICAgdmFyIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIGZpbmRQYXJlbnQ6IHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudC50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9zdFBhcmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIocm9vdDMsIHJldHVybkZpYmVyLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkZXRhY2hGaWJlck11dGF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgY2hpbGQpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpIHsKICAgICAgICAgIG9uQ29tbWl0VW5tb3VudChkZWxldGVkRmliZXIpOwogICAgICAgICAgc3dpdGNoIChkZWxldGVkRmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIHByZXZIb3N0UGFyZW50SXNDb250YWluZXIgPSBob3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50SXNDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZEZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2hpbGQoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGhvc3RQYXJlbnQsIGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZIb3N0UGFyZW50ID0gaG9zdFBhcmVudDsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBkZWxldGVkRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gX3ByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gX3ByZXZIb3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZGVsZXRlZEZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfZWZmZWN0ID0gZWZmZWN0LCBkZXN0cm95ID0gX2VmZmVjdC5kZXN0cm95LCB0YWcgPSBfZWZmZWN0LnRhZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCh0YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRGaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBSZW1vdmUgdGhpcyBkZWFkIGZsYWcKICAgICAgICAgICAgICAgIGRlbGV0ZWRGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gfHwgZGVsZXRlZEZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0U3VzcGVuc2VDYWxsYmFjayhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobmV3U3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBwcmV2U3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZSA9IG5ldyBQb3NzaWJseVdlYWtTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZXMuZm9yRWFjaChmdW5jdGlvbih3YWtlYWJsZSkgewogICAgICAgICAgICAgIHZhciByZXRyeSA9IHJlc29sdmVSZXRyeVdha2VhYmxlLmJpbmQobnVsbCwgZmluaXNoZWRXb3JrLCB3YWtlYWJsZSk7CiAgICAgICAgICAgICAgaWYgKCFyZXRyeUNhY2hlLmhhcyh3YWtlYWJsZSkpIHsKICAgICAgICAgICAgICAgIHJldHJ5Q2FjaGUuYWRkKHdha2VhYmxlKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluUHJvZ3Jlc3NMYW5lcyAhPT0gbnVsbCAmJiBpblByb2dyZXNzUm9vdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhpblByb2dyZXNzUm9vdCwgaW5Qcm9ncmVzc0xhbmVzKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkV4cGVjdGVkIGZpbmlzaGVkIHJvb3QgYW5kIGxhbmVzIHRvIGJlIHNldC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdha2VhYmxlLnRoZW4ocmV0cnksIHJldHJ5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IGNvbW1pdHRlZExhbmVzOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmssIHJvb3QzKTsKICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcGFyZW50RmliZXIuZGVsZXRpb25zOwogICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlbGV0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHMocm9vdDMsIHBhcmVudEZpYmVyLCBjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGNoaWxkVG9EZWxldGUsIHBhcmVudEZpYmVyLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZEZWJ1Z0ZpYmVyID0gZ2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICBpZiAocGFyZW50RmliZXIuc3VidHJlZUZsYWdzICYgTXV0YXRpb25NYXNrKSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudEZpYmVyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoY2hpbGQpOwogICAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoY2hpbGQsIHJvb3QzKTsKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihwcmV2RGVidWdGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChJbnNlcnRpb24gfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50NCwgY3VycmVudDQucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50NCwgY3VycmVudDQucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChfaW5zdGFuY2U0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiBuZXdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZShfaW5zdGFuY2U0LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHNob3VsZCBoYXZlIGEgdGV4dCBub2RlIGluaXRpYWxpemVkLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciB0ZXh0SW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG5ld1RleHQ7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0VGV4dFVwZGF0ZSh0ZXh0SW5zdGFuY2UsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlJvb3RTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZSb290U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21taXRIeWRyYXRlZENvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuRmliZXIgPSBmaW5pc2hlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKG9mZnNjcmVlbkZpYmVyLmZsYWdzICYgVmlzaWJpbGl0eSkgewogICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkluc3RhbmNlID0gb2Zmc2NyZWVuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gb2Zmc2NyZWVuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IG5ld1N0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBpc0hpZGRlbjsKICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICB2YXIgd2FzSGlkZGVuID0gb2Zmc2NyZWVuRmliZXIuYWx0ZXJuYXRlICE9PSBudWxsICYmIG9mZnNjcmVlbkZpYmVyLmFsdGVybmF0ZS5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoIXdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0U3VzcGVuc2VDYWxsYmFjayhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF93YXNIaWRkZW4gPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLm1vZGUgJiBDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiB8fCBfd2FzSGlkZGVuOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVmlzaWJpbGl0eSkgewogICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5JbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgX25ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgX2lzSGlkZGVuID0gX25ld1N0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkJvdW5kYXJ5ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgICAgX29mZnNjcmVlbkluc3RhbmNlLmlzSGlkZGVuID0gX2lzSGlkZGVuOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoX2lzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFfd2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9mZnNjcmVlbkJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQm91bmRhcnk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5DaGlsZCA9IG9mZnNjcmVlbkJvdW5kYXJ5LmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAob2Zmc2NyZWVuQ2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQ2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihvZmZzY3JlZW5DaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2NyZWVuQ2hpbGQgPSBvZmZzY3JlZW5DaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGhpZGVPclVuaGlkZUFsbENoaWxkcmVuKG9mZnNjcmVlbkJvdW5kYXJ5LCBfaXNIaWRkZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKGZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5pc2hlZFdvcmsuZmxhZ3MgJj0gflBsYWNlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmbGFncyAmIEh5ZHJhdGluZykgewogICAgICAgICAgICBmaW5pc2hlZFdvcmsuZmxhZ3MgJj0gfkh5ZHJhdGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gY29tbWl0dGVkTGFuZXM7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oZmluaXNoZWRXb3JrLCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gKHN1YnRyZWVSb290Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCAmJiBpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBpc0hpZGRlbiB8fCBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgaWYgKG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbikgewogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIHZhciB3YXNIaWRkZW4gPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSB3YXNIaWRkZW4gfHwgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgaWYgKG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gJiYgIXByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGNoaWxkOwogICAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKAogICAgICAgICAgICAgICAgICAgIGNoaWxkLAogICAgICAgICAgICAgICAgICAgIC8vIE5ldyByb290OyBidWJibGUgYmFjayB1cCB0byBoZXJlIGFuZCBzdG9wLgogICAgICAgICAgICAgICAgICAgIHJvb3QzLAogICAgICAgICAgICAgICAgICAgIGNvbW1pdHRlZExhbmVzCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmICgoZmliZXIuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RPbkZpYmVyKHJvb3QzLCBjdXJyZW50NCwgZmliZXIsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc2FwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRPbkZpYmVyKHJvb3QzLCBmaWJlciwgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhmaXJzdENoaWxkKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfYmVnaW4oKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKChuZXh0RWZmZWN0LmZsYWdzICYgQ2hpbGREZWxldGlvbikgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gZmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaWJlclRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXJUb0RlbGV0ZTsKICAgICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihmaWJlclRvRGVsZXRlLCBmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZENoaWxkID0gcHJldmlvdXNGaWJlci5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGV0YWNoZWRDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNGaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZFNpYmxpbmcgPSBkZXRhY2hlZENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQgPSBkZXRhY2hlZFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChkZXRhY2hlZENoaWxkICE9PSBudWxsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIFBhc3NpdmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfYmVnaW4oZGVsZXRlZFN1YnRyZWVSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihmaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9jb21wbGV0ZShkZWxldGVkU3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfY29tcGxldGUoZGVsZXRlZFN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZmliZXIgPT09IGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHJldHVybkZpYmVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgc3dpdGNoIChjdXJyZW50NC50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0Lm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdE1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0VW5tb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBDT01QT05FTlRfVFlQRSA9IDA7CiAgICAgICAgdmFyIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IDE7CiAgICAgICAgdmFyIFJPTEVfVFlQRSA9IDI7CiAgICAgICAgdmFyIFRFU1RfTkFNRV9UWVBFID0gMzsKICAgICAgICB2YXIgVEVYVF9UWVBFID0gNDsKICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wuZm9yKSB7CiAgICAgICAgICB2YXIgc3ltYm9sRm9yID0gU3ltYm9sLmZvcjsKICAgICAgICAgIENPTVBPTkVOVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5jb21wb25lbnQiKTsKICAgICAgICAgIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IuaGFzX3BzZXVkb19jbGFzcyIpOwogICAgICAgICAgUk9MRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5yb2xlIik7CiAgICAgICAgICBURVNUX05BTUVfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IudGVzdF9pZCIpOwogICAgICAgICAgVEVYVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXh0Iik7CiAgICAgICAgfQogICAgICAgIHZhciBjb21taXRIb29rcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdCQxKCkgewogICAgICAgICAgewogICAgICAgICAgICBjb21taXRIb29rcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbW1pdEhvb2spIHsKICAgICAgICAgICAgICByZXR1cm4gY29tbWl0SG9vaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEFjdFF1ZXVlID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgZnVuY3Rpb24gaXNMZWdhY3lBY3RFbnZpcm9ubWVudChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHZhciBqZXN0SXNEZWZpbmVkID0gdHlwZW9mIGplc3QgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICByZXR1cm4gamVzdElzRGVmaW5lZCAmJiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgIT09IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCA9ICgKICAgICAgICAgICAgICAvLyAkRmxvd0V4cGVjdGVkRXJyb3Ig4oCTIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCBnbG9iYWwKICAgICAgICAgICAgICB0eXBlb2YgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UICE9PSAidW5kZWZpbmVkIiA/IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCA6IHZvaWQgMAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIWlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBjdXJyZW50IHRlc3RpbmcgZW52aXJvbm1lbnQgaXMgbm90IGNvbmZpZ3VyZWQgdG8gc3VwcG9ydCBhY3QoLi4uKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjZWlsID0gTWF0aC5jZWlsOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRPd25lciQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZywgUmVhY3RDdXJyZW50QWN0UXVldWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIHZhciBOb0NvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEJhdGNoZWRDb250ZXh0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFJlbmRlckNvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIENvbW1pdENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFJvb3RJblByb2dyZXNzID0gMDsKICAgICAgICB2YXIgUm9vdEZhdGFsRXJyb3JlZCA9IDE7CiAgICAgICAgdmFyIFJvb3RFcnJvcmVkID0gMjsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZCA9IDM7CiAgICAgICAgdmFyIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgPSA0OwogICAgICAgIHZhciBSb290Q29tcGxldGVkID0gNTsKICAgICAgICB2YXIgUm9vdERpZE5vdENvbXBsZXRlID0gNjsKICAgICAgICB2YXIgZXhlY3V0aW9uQ29udGV4dCA9IE5vQ29udGV4dDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOb0xhbmVzKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gMDsKICAgICAgICB2YXIgRkFMTEJBQ0tfVEhST1RUTEVfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBJbmZpbml0eTsKICAgICAgICB2YXIgUkVOREVSX1RJTUVPVVRfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVuZGVyVGltZXIoKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lID0gbm93KCkgKyBSRU5ERVJfVElNRU9VVF9NUzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgdmFyIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICB2YXIgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cyA9IFtdOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICB2YXIgTkVTVEVEX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgIHZhciByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFdvcmtJblByb2dyZXNzUm9vdCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RFdmVudFRpbWUoKSB7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub3coKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUaW1lICE9PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICByZXR1cm4gY3VycmVudEV2ZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRFdmVudFRpbWUgPSBub3coKTsKICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcikgewogICAgICAgICAgdmFyIG1vZGUgPSBmaWJlci5tb2RlOwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgfSBlbHNlIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQgJiYgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc1RyYW5zaXRpb24gPSByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSAhPT0gTm9UcmFuc2l0aW9uOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbikgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgICAgaWYgKCF0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5hZGQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBpZiAodXBkYXRlTGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TGFuZSA9IGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCk7CiAgICAgICAgICByZXR1cm4gZXZlbnRMYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UmV0cnlMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2xhaW1OZXh0UmV0cnlMYW5lKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QpIHsKICAgICAgICAgICAgICBlcnJvcigidXNlSW5zZXJ0aW9uRWZmZWN0IG11c3Qgbm90IHNjaGVkdWxlIHVwZGF0ZXMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9MYW5lcyAmJiByb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgaWYgKGxhbmUgPT09IFN5bmNMYW5lICYmIGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIFRyZWF0IGBhY3RgIGFzIGlmIGl0J3MgaW5zaWRlIGBiYXRjaGVkVXBkYXRlc2AsIGV2ZW4gaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICAgICFSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSByb290My5jdXJyZW50OwogICAgICAgICAgY3VycmVudDQubGFuZXMgPSBsYW5lOwogICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBvdXRkYXRlZCBkZWZlclJlbmRlclBoYXNlVXBkYXRlVG9OZXh0QmF0Y2ggZXhwZXJpbWVudC4gV2UKICAgICAgICAgICAgLy8gZGVjaWRlZCBub3QgdG8gZW5hYmxlIGl0LgogICAgICAgICAgICAoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrTm9kZSA9IHJvb3QzLmNhbGxiYWNrTm9kZTsKICAgICAgICAgIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tQcmlvcml0eSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgPSByb290My5jYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9PT0gbmV3Q2FsbGJhY2tQcmlvcml0eSAmJiAvLyBTcGVjaWFsIGNhc2UgcmVsYXRlZCB0byBgYWN0YC4gSWYgdGhlIGN1cnJlbnRseSBzY2hlZHVsZWQgdGFzayBpcyBhCiAgICAgICAgICAvLyBTY2hlZHVsZXIgdGFzaywgcmF0aGVyIHRoYW4gYW4gYGFjdGAgdGFzaywgY2FuY2VsIGl0IGFuZCByZS1zY2hlZHVsZWQKICAgICAgICAgIC8vIG9uIHRoZSBgYWN0YCBxdWV1ZS4KICAgICAgICAgICEoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsICYmIGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlID09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ICE9PSBTeW5jTGFuZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNjaGVkdWxlZCBjYWxsYmFjayB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgY2FuY2VsQ2FsbGJhY2skMShleGlzdGluZ0NhbGxiYWNrTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgICAgaWYgKG5ld0NhbGxiYWNrUHJpb3JpdHkgPT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgIGlmIChyb290My50YWcgPT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2socGVyZm9ybVN5bmNXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQucHVzaChmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZU1pY3JvdGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eUxldmVsOwogICAgICAgICAgICBzd2l0Y2ggKGxhbmVzVG9FdmVudFByaW9yaXR5KG5leHRMYW5lcykpIHsKICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gc2NoZWR1bGVDYWxsYmFjayQxKHNjaGVkdWxlclByaW9yaXR5TGV2ZWwsIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gbmV3Q2FsbGJhY2tQcmlvcml0eTsKICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG5ld0NhbGxiYWNrTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290KHJvb3QzLCBkaWRUaW1lb3V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgdmFyIGRpZEZsdXNoUGFzc2l2ZUVmZmVjdHMgPSBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICBpZiAoZGlkRmx1c2hQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICBpZiAocm9vdDMuY2FsbGJhY2tOb2RlICE9PSBvcmlnaW5hbENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFRpbWVTbGljZSA9ICFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpICYmICFpbmNsdWRlc0V4cGlyZWRMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWRpZFRpbWVvdXQ7CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHNob3VsZFRpbWVTbGljZSA/IHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgOiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpOwogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgIT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbGFuZXMgPSBlcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgICAgdGhyb3cgZmF0YWxFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZW5kZXJXYXNDb25jdXJyZW50ID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJXYXNDb25jdXJyZW50ICYmICFpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSkgewogICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9lcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgICAgIGlmIChfZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgbGFuZXMgPSBfZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgX2Vycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICAgICAgdGhyb3cgX2ZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICAgICAgZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgPT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3QuYmluZChudWxsLCByb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcykgewogICAgICAgICAgdmFyIGVycm9yc0Zyb21GaXJzdEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzOwogICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgcm9vdFdvcmtJblByb2dyZXNzLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3JIeWRyYXRpbmdDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ID0gd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdDsKICAgICAgICAgICAgaWYgKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWVSZWNvdmVyYWJsZUVycm9ycyhlcnJvcnNGcm9tU2Vjb25kQXR0ZW1wdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGl0U3RhdHVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9yczMpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IGVycm9yczM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycy5wdXNoLmFwcGx5KHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCBlcnJvcnMzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZXhpdFN0YXR1cykgewogICAgICAgICAgICBjYXNlIFJvb3RJblByb2dyZXNzOgogICAgICAgICAgICBjYXNlIFJvb3RGYXRhbEVycm9yZWQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RFcnJvcmVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZDogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgJiYgLy8gZG8gbm90IGRlbGF5IGlmIHdlJ3JlIGluc2lkZSBhbiBhY3QoKSBzY29wZQogICAgICAgICAgICAgICFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1zVW50aWxUaW1lb3V0ID0gZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSArIEZBTExCQUNLX1RIUk9UVExFX01TIC0gbm93KCk7CiAgICAgICAgICAgICAgICBpZiAobXNVbnRpbFRpbWVvdXQgPiAxMCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV4dExhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhzdXNwZW5kZWRMYW5lcywgbGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIG1zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk6IHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkpIHsKICAgICAgICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZU1zID0gbW9zdFJlY2VudEV2ZW50VGltZTsKICAgICAgICAgICAgICAgIHZhciB0aW1lRWxhcHNlZE1zID0gbm93KCkgLSBldmVudFRpbWVNczsKICAgICAgICAgICAgICAgIHZhciBfbXNVbnRpbFRpbWVvdXQgPSBqbmQodGltZUVsYXBzZWRNcykgLSB0aW1lRWxhcHNlZE1zOwogICAgICAgICAgICAgICAgaWYgKF9tc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIF9tc1VudGlsVGltZW91dCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290Q29tcGxldGVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcm9vdCBleGl0IHN0YXR1cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSkgewogICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IG5vZGUudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hlY2tzID0gdXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgICAgaWYgKGNoZWNrcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoZWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGVjayA9IGNoZWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0U25hcHNob3QgPSBjaGVjay5nZXRTbmFwc2hvdDsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRWYWx1ZSA9IGNoZWNrLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKGdldFNuYXBzaG90KCksIHJlbmRlcmVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKG5vZGUuc3VidHJlZUZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyk7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtU3luY1dvcmtPblJvb3Qocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3luY05lc3RlZFVwZGF0ZUZsYWcoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgbm90IGFscmVhZHkgYmUgd29ya2luZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUobGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgIGlmIChlcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBmYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3REaWROb3RDb21wbGV0ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaW5pc2hlZFdvcmsgPSByb290My5jdXJyZW50LmFsdGVybmF0ZTsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUm9vdChyb290MywgbGFuZXMpIHsKICAgICAgICAgIGlmIChsYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbWVyZ2VMYW5lcyhsYW5lcywgU3luY0xhbmUpKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMkMShmbiwgYTIpIHsKICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IEJhdGNoZWRDb250ZXh0OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGZuKGEyKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAvLyBUcmVhdCBgYWN0YCBhcyBpZiBpdCdzIGluc2lkZSBgYmF0Y2hlZFVwZGF0ZXNgLCBldmVuIGluIGxlZ2FjeSBtb2RlLgogICAgICAgICAgICAhUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5KSB7CiAgICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNjcmV0ZVVwZGF0ZXMoZm4sIGEyLCBiLCBjMiwgZCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICByZXR1cm4gZm4oYTIsIGIsIGMyLCBkKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jKGZuKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwgJiYgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMudGFnID09PSBMZWdhY3lSb290ICYmIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5UmVuZGVyaW5nKCkgewogICAgICAgICAgcmV0dXJuIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFJlbmRlckxhbmVzKGZpYmVyLCBsYW5lcykgewogICAgICAgICAgcHVzaChzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IsIHN1YnRyZWVSZW5kZXJMYW5lcywgZmliZXIpOwogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhzdWJ0cmVlUmVuZGVyTGFuZXMsIGxhbmVzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUmVuZGVyTGFuZXMoZmliZXIpIHsKICAgICAgICAgIHN1YnRyZWVSZW5kZXJMYW5lcyA9IHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gcm9vdDMudGltZW91dEhhbmRsZTsKICAgICAgICAgIGlmICh0aW1lb3V0SGFuZGxlICE9PSBub1RpbWVvdXQpIHsKICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgICAgY2FuY2VsVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJydXB0ZWRXb3JrID0gd29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAoaW50ZXJydXB0ZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gaW50ZXJydXB0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgaW50ZXJydXB0ZWRXb3JrID0gaW50ZXJydXB0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICB2YXIgcm9vdFdvcmtJblByb2dyZXNzID0gY3JlYXRlV29ya0luUHJvZ3Jlc3Mocm9vdDMuY3VycmVudCwgbnVsbCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzID0gd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgICBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmRpc2NhcmRQZW5kaW5nV2FybmluZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9yKHJvb3QzLCB0aHJvd25WYWx1ZSkgewogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgICAgICByZXNldEhvb2tzQWZ0ZXJUaHJvdygpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoZXJyb3JlZFdvcmsgPT09IG51bGwgfHwgZXJyb3JlZFdvcmsucmV0dXJuID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEZhdGFsRXJyb3JlZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSB0aHJvd25WYWx1ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZXJyb3JlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGVycm9yZWRXb3JrLCB0cnVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgICAgIGlmICh0aHJvd25WYWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdGhyb3duVmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB0aHJvd25WYWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGVycm9yZWRXb3JrLCB3YWtlYWJsZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudEVycm9yZWQoZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93RXhjZXB0aW9uKHJvb3QzLCBlcnJvcmVkV29yay5yZXR1cm4sIGVycm9yZWRXb3JrLCB0aHJvd25WYWx1ZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGNvbXBsZXRlVW5pdE9mV29yayhlcnJvcmVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKHlldEFub3RoZXJUaHJvd25WYWx1ZSkgewogICAgICAgICAgICAgIHRocm93blZhbHVlID0geWV0QW5vdGhlclRocm93blZhbHVlOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyA9PT0gZXJyb3JlZFdvcmsgJiYgZXJyb3JlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yZWRXb3JrID0gZXJyb3JlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBlcnJvcmVkV29yazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQ7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChwcmV2RGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BEaXNwYXRjaGVyKHByZXZEaXNwYXRjaGVyKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0VGltZU9mRmFsbGJhY2soKSB7CiAgICAgICAgICBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gbm93KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobGFuZSkgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gbWVyZ2VMYW5lcyhsYW5lLCB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290U3VzcGVuZGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzIHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSBudWxsICYmIChpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcykgfHwgaW5jbHVkZXNOb25JZGxlV29yayh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcykpKSB7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEod29ya0luUHJvZ3Jlc3NSb290LCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgIT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RFcnJvcmVkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycy5wdXNoKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckhhc05vdFN1c3BlbmRlZFlldCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BTeW5jKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCBhbiBpbmNvbXBsZXRlIHJvb3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wU3luYygpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gUmVuZGVyQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IHB1c2hEaXNwYXRjaGVyKCk7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSByb290MyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgICAgaWYgKG1lbW9pemVkVXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IGdldFRyYW5zaXRpb25zRm9yTGFuZXMoKTsKICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BDb25jdXJyZW50KCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wQ29uY3VycmVudCgpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCAmJiAhc2hvdWxkWWllbGQoKSkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHVuaXRPZldvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHVuaXRPZldvcmspOwogICAgICAgICAgdmFyIG5leHQ7CiAgICAgICAgICBpZiAoKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKHVuaXRPZldvcmssIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIHVuaXRPZldvcmsubWVtb2l6ZWRQcm9wcyA9IHVuaXRPZldvcmsucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKG5leHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjb21wbGV0ZWRXb3JrID0gdW5pdE9mV29yazsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGNvbXBsZXRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsuZmxhZ3MgJiBJbmNvbXBsZXRlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgbmV4dCA9IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIoY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgaWYgKG5leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0ID0gdW53aW5kV29yayhjdXJyZW50NCwgY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKF9uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfbmV4dC5mbGFncyAmPSBIb3N0RWZmZWN0TWFzazsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gX25leHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoY29tcGxldGVkV29yaywgZmFsc2UpOwogICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RGlkTm90Q29tcGxldGU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSBjb21wbGV0ZWRXb3JrLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHNpYmxpbmdGaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yayA9IHJldHVybkZpYmVyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICB9IHdoaWxlIChjb21wbGV0ZWRXb3JrICE9PSBudWxsKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdENvbXBsZXRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCByZW5kZXJQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0gd2hpbGUgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsKTsKICAgICAgICAgIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmZpbmlzaGVkV29yazsKICAgICAgICAgIHZhciBsYW5lcyA9IHJvb3QzLmZpbmlzaGVkTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicm9vdC5maW5pc2hlZExhbmVzIHNob3VsZCBub3QgYmUgZW1wdHkgZHVyaW5nIGEgY29tbWl0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gcm9vdDMuY3VycmVudCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjb21taXQgdGhlIHNhbWUgdHJlZSBhcyBiZWZvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZW1haW5pbmdMYW5lcyA9IG1lcmdlTGFuZXMoZmluaXNoZWRXb3JrLmxhbmVzLCBmaW5pc2hlZFdvcmsuY2hpbGRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdEZpbmlzaGVkKHJvb3QzLCByZW1haW5pbmdMYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyB8fCAoZmluaXNoZWRXb3JrLmZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9ucyA9IHRyYW5zaXRpb25zOwogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2skMShOb3JtYWxQcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1YnRyZWVIYXNFZmZlY3RzID0gKGZpbmlzaGVkV29yay5zdWJ0cmVlRmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICB2YXIgcm9vdEhhc0VmZmVjdCA9IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoc3VidHJlZUhhc0VmZmVjdHMgfHwgcm9vdEhhc0VmZmVjdCkgewogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIyID0gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVjb3JkQ29tbWl0VGltZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIHJlc2V0QWZ0ZXJDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxdWVzdFBhaW50KCk7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzID0gcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICBpZiAocm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSByb290MzsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBsYW5lczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZW1haW5pbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChyZW1haW5pbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcm9vdERpZEhhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihyb290My5jdXJyZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG9uQ29tbWl0Um9vdChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCByZW5kZXJQcmlvcml0eUxldmVsKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcm9vdDMubWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ29tbWl0Um9vdCQxKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gcm9vdDMub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY292ZXJhYmxlRXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSByZWNvdmVyYWJsZUVycm9yc1tpXTsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSByZWNvdmVyYWJsZUVycm9yLnN0YWNrOwogICAgICAgICAgICAgIHZhciBkaWdlc3QgPSByZWNvdmVyYWJsZUVycm9yLmRpZ2VzdDsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IocmVjb3ZlcmFibGVFcnJvci52YWx1ZSwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2ssCiAgICAgICAgICAgICAgICBkaWdlc3QKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IkMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzLCBTeW5jTGFuZSkgJiYgcm9vdDMudGFnICE9PSBMZWdhY3lSb290KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVtYWluaW5nTGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gcm9vdFdpdGhOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gcm9vdDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHJlbmRlclByaW9yaXR5ID0gbGFuZXNUb0V2ZW50UHJpb3JpdHkocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMpOwogICAgICAgICAgICB2YXIgcHJpb3JpdHkgPSBsb3dlckV2ZW50UHJpb3JpdHkoRGVmYXVsdEV2ZW50UHJpb3JpdHksIHJlbmRlclByaW9yaXR5KTsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByaW9yaXR5KTsKICAgICAgICAgICAgICByZXR1cm4gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMucHVzaChmaWJlcik7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHNJbXBsKCkgewogICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFuc2l0aW9ucyA9IHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnM7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIHZhciByb290MyA9IHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXM7CiAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZsdXNoIHBhc3NpdmUgZWZmZWN0cyB3aGlsZSBhbHJlYWR5IHJlbmRlcmluZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzKHJvb3QzLCByb290My5jdXJyZW50LCBsYW5lcywgdHJhbnNpdGlvbnMpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvZmlsZXJFZmZlY3RzID0gcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHM7CiAgICAgICAgICAgIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZmlsZXJFZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlciA9IHByb2ZpbGVyRWZmZWN0c1tpXTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKHJvb3QzLCBfZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25Qb3N0Q29tbWl0Um9vdChyb290Myk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSByb290My5jdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkICE9PSBudWxsICYmIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkLmhhcyhpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQoaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9PT0gbnVsbCkgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtpbnN0YW5jZV0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuYWRkKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvVGhyb3dVbmNhdWdodEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKCFoYXNVbmNhdWdodEVycm9yKSB7CiAgICAgICAgICAgIGhhc1VuY2F1Z2h0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBvblVuY2F1Z2h0RXJyb3IgPSBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3I7CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qocm9vdEZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IyKSB7CiAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IyLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHJvb3RGaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKHJvb3RGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3Ioc291cmNlRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yJDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVwb3J0VW5jYXVnaHRFcnJvckluREVWKGVycm9yJDEpOwogICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qoc291cmNlRmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIgPSBuZWFyZXN0TW91bnRlZEFuY2VzdG9yOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3QoZmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBjdG9yID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogQXR0ZW1wdGVkIHRvIGNhcHR1cmUgYSBjb21taXQgcGhhc2UgZXJyb3IgaW5zaWRlIGEgZGV0YWNoZWQgdHJlZS4gVGhpcyBpbmRpY2F0ZXMgYSBidWcgaW4gUmVhY3QuIExpa2VseSBjYXVzZXMgaW5jbHVkZSBkZWxldGluZyB0aGUgc2FtZSBmaWJlciBtb3JlIHRoYW4gb25jZSwgY29tbWl0dGluZyBhbiBhbHJlYWR5LWZpbmlzaGVkIHRyZWUsIG9yIGFuIGluY29uc2lzdGVudCByZXR1cm4gcG9pbnRlci5cblxuRXJyb3IgbWVzc2FnZTpcblxuJXMiLCBlcnJvciQxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGluZ1N1c3BlbmRlZFJvb3Qocm9vdDMsIHdha2VhYmxlLCBwaW5nZWRMYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgIHdhcm5JZlN1c3BlbnNlUmVzb2x1dGlvbk5vdFdyYXBwZWRXaXRoQWN0REVWKHJvb3QzKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgPT09IHJvb3QzICYmIGlzU3Vic2V0T2ZMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcywgcGluZ2VkTGFuZXMpKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5IHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgJiYgaW5jbHVkZXNPbmx5UmV0cmllcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcykgJiYgbm93KCkgLSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lIDwgRkFMTEJBQ0tfVEhST1RUTEVfTVMpIHsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzLCBwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgaWYgKHJldHJ5TGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHJlcXVlc3RSZXRyeUxhbmUoYm91bmRhcnlGaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCByZXRyeUxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShib3VuZGFyeUZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBOb0xhbmU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlUmV0cnlXYWtlYWJsZShib3VuZGFyeUZpYmVyLCB3YWtlYWJsZSkgewogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZXRyeUNhY2hlOwogICAgICAgICAgc3dpdGNoIChib3VuZGFyeUZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0cnlMYW5lID0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaW5nZWQgdW5rbm93biBzdXNwZW5zZSBib3VuZGFyeSB0eXBlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0cnlDYWNoZS5kZWxldGUod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpuZCh0aW1lRWxhcHNlZCkgewogICAgICAgICAgcmV0dXJuIHRpbWVFbGFwc2VkIDwgMTIwID8gMTIwIDogdGltZUVsYXBzZWQgPCA0ODAgPyA0ODAgOiB0aW1lRWxhcHNlZCA8IDEwODAgPyAxMDgwIDogdGltZUVsYXBzZWQgPCAxOTIwID8gMTkyMCA6IHRpbWVFbGFwc2VkIDwgM2UzID8gM2UzIDogdGltZUVsYXBzZWQgPCA0MzIwID8gNDMyMCA6IGNlaWwodGltZUVsYXBzZWQgLyAxOTYwKSAqIDE5NjA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yTmVzdGVkVXBkYXRlcygpIHsKICAgICAgICAgIGlmIChuZXN0ZWRVcGRhdGVDb3VudCA+IE5FU1RFRF9VUERBVEVfTElNSVQpIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCByZXBlYXRlZGx5IGNhbGxzIHNldFN0YXRlIGluc2lkZSBjb21wb25lbnRXaWxsVXBkYXRlIG9yIGNvbXBvbmVudERpZFVwZGF0ZS4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgbmVzdGVkIHVwZGF0ZXMgdG8gcHJldmVudCBpbmZpbml0ZSBsb29wcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA+IE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgICAgZXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCBjYWxscyBzZXRTdGF0ZSBpbnNpZGUgdXNlRWZmZWN0LCBidXQgdXNlRWZmZWN0IGVpdGhlciBkb2Vzbid0IGhhdmUgYSBkZXBlbmRlbmN5IGFycmF5LCBvciBvbmUgb2YgdGhlIGRlcGVuZGVuY2llcyBjaGFuZ2VzIG9uIGV2ZXJ5IHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFJlbmRlclBoYXNlU3RyaWN0TW9kZVdhcm5pbmdzSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmcoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKGZpYmVyLCBoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYpOwogICAgICAgICAgICBpZiAoaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50UGFzc2l2ZURldiwgaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlRWZmZWN0c0luRGV2KGZpcnN0Q2hpbGQsIGZpYmVyRmxhZ3MsIGludm9rZUVmZmVjdEZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBzdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmltYXJ5U3VidHJlZUZsYWcgPSBjdXJyZW50NC5zdWJ0cmVlRmxhZ3MgJiBmaWJlckZsYWdzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gc3VidHJlZVJvb3QgJiYgY3VycmVudDQuY2hpbGQgIT09IG51bGwgJiYgcHJpbWFyeVN1YnRyZWVGbGFnICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50NCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgZmliZXJGbGFncykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgaW52b2tlRWZmZWN0Rm4oY3VycmVudDQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDQgPSBjdXJyZW50NC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDQgPSBzdWJ0cmVlUm9vdCA9IGN1cnJlbnQ0LnJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWc7CiAgICAgICAgICAgIGlmICh0YWcgIT09IEluZGV0ZXJtaW5hdGVDb21wb25lbnQgJiYgdGFnICE9PSBIb3N0Um9vdCAmJiB0YWcgIT09IENsYXNzQ29tcG9uZW50ICYmIHRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgdGFnICE9PSBGb3J3YXJkUmVmMiAmJiB0YWcgIT09IE1lbW9Db21wb25lbnQgJiYgdGFnICE9PSBTaW1wbGVNZW1vQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlJlYWN0Q29tcG9uZW50IjsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtjb21wb25lbnROYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGVycm9yKCJDYW4ndCBwZXJmb3JtIGEgUmVhY3Qgc3RhdGUgdXBkYXRlIG9uIGEgY29tcG9uZW50IHRoYXQgaGFzbid0IG1vdW50ZWQgeWV0LiBUaGlzIGluZGljYXRlcyB0aGF0IHlvdSBoYXZlIGEgc2lkZS1lZmZlY3QgaW4geW91ciByZW5kZXIgZnVuY3Rpb24gdGhhdCBhc3luY2hyb25vdXNseSBsYXRlciBjYWxscyB0cmllcyB0byB1cGRhdGUgdGhlIGNvbXBvbmVudC4gTW92ZSB0aGlzIHdvcmsgdG8gdXNlRWZmZWN0IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiZWdpbldvcmskMTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZHVtbXlGaWJlciA9IG51bGw7CiAgICAgICAgICBiZWdpbldvcmskMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcykgewogICAgICAgICAgICB2YXIgb3JpZ2luYWxXb3JrSW5Qcm9ncmVzc0NvcHkgPSBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVihkdW1teUZpYmVyLCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gYmVnaW5Xb3JrKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKG9yaWdpbmFsRXJyb3IpIHsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHx8IG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIHR5cGVvZiBvcmlnaW5hbEVycm9yLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQ0LCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih1bml0T2ZXb3JrLCBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSk7CiAgICAgICAgICAgICAgaWYgKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIodW5pdE9mV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBiZWdpbldvcmssIG51bGwsIGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGhhc0NhdWdodEVycm9yKCkpIHsKICAgICAgICAgICAgICAgIHZhciByZXBsYXlFcnJvciA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVwbGF5RXJyb3IgPT09ICJvYmplY3QiICYmIHJlcGxheUVycm9yICE9PSBudWxsICYmIHJlcGxheUVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgIW9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZykgewogICAgICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiAhZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUgPSB3b3JrSW5Qcm9ncmVzcyAmJiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgIHZhciBkZWR1cGVLZXkgPSByZW5kZXJpbmdDb21wb25lbnROYW1lOwogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5oYXMoZGVkdXBlS2V5KSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5hZGQoZGVkdXBlS2V5KTsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0U3RhdGVDb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGEgY29tcG9uZW50IChgJXNgKSB3aGlsZSByZW5kZXJpbmcgYSBkaWZmZXJlbnQgY29tcG9uZW50IChgJXNgKS4gVG8gbG9jYXRlIHRoZSBiYWQgc2V0U3RhdGUoKSBjYWxsIGluc2lkZSBgJXNgLCBmb2xsb3cgdGhlIHN0YWNrIHRyYWNlIGFzIGRlc2NyaWJlZCBpbiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc2V0c3RhdGUtaW4tcmVuZGVyIiwgc2V0U3RhdGVDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlcikgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGR1cmluZyBhbiBleGlzdGluZyBzdGF0ZSB0cmFuc2l0aW9uIChzdWNoIGFzIHdpdGhpbiBgcmVuZGVyYCkuIFJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiIpOwogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihzY2hlZHVsaW5nRmliZXIpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290Mywgc2NoZWR1bGluZ0ZpYmVyLCBsYW5lcyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZha2VBY3RDYWxsYmFja05vZGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrJDEocHJpb3JpdHlMZXZlbCwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjdFF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50OwogICAgICAgICAgICBpZiAoYWN0UXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhY3RRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgICByZXR1cm4gZmFrZUFjdENhbGxiYWNrTm9kZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuY2VsQ2FsbGJhY2skMShjYWxsYmFja05vZGUpIHsKICAgICAgICAgIGlmIChjYWxsYmFja05vZGUgPT09IGZha2VBY3RDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNhbmNlbENhbGxiYWNrKGNhbGxiYWNrTm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpIHsKICAgICAgICAgIHJldHVybiBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghaXNMZWdhY3lBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgZmliZXIudGFnICE9PSBGb3J3YXJkUmVmMiAmJiBmaWJlci50YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDM7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIHRvICVzIGluc2lkZSBhIHRlc3Qgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCBjYXVzZXMgUmVhY3Qgc3RhdGUgdXBkYXRlcyBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaXJlIGV2ZW50cyB0aGF0IHVwZGF0ZSBzdGF0ZSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0IiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyAhPT0gTGVnYWN5Um9vdCAmJiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJBIHN1c3BlbmRlZCByZXNvdXJjZSBmaW5pc2hlZCBsb2FkaW5nIGluc2lkZSBhIHRlc3QsIGJ1dCB0aGUgZXZlbnQgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCByZXNvbHZlcyBzdXNwZW5kZWQgZGF0YSBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaW5pc2ggbG9hZGluZyBzdXNwZW5kZWQgZGF0YSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGlzUnVubmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QgPSBpc1J1bm5pbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZXNvbHZlRmFtaWx5ID0gbnVsbDsKICAgICAgICB2YXIgZmFpbGVkQm91bmRhcmllcyA9IG51bGw7CiAgICAgICAgdmFyIHNldFJlZnJlc2hIYW5kbGVyID0gZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgICAgewogICAgICAgICAgICByZXNvbHZlRmFtaWx5ID0gaGFuZGxlcjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkodHlwZSk7CiAgICAgICAgICAgIGlmIChmYW1pbHkgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGUgIT09IG51bGwgJiYgdHlwZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB0eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZW5kZXIgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgICAgaWYgKHR5cGUucmVuZGVyICE9PSBjdXJyZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzeW50aGV0aWNUeXBlID0gewogICAgICAgICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiwKICAgICAgICAgICAgICAgICAgICByZW5kZXI6IGN1cnJlbnRSZW5kZXIKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUuZGlzcGxheU5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHN5bnRoZXRpY1R5cGUuZGlzcGxheU5hbWUgPSB0eXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBzeW50aGV0aWNUeXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhmaWJlciwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldlR5cGUgPSBmaWJlci5lbGVtZW50VHlwZTsKICAgICAgICAgICAgdmFyIG5leHRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICB2YXIgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSBmYWxzZTsKICAgICAgICAgICAgdmFyICQkdHlwZW9mTmV4dFR5cGUgPSB0eXBlb2YgbmV4dFR5cGUgPT09ICJvYmplY3QiICYmIG5leHRUeXBlICE9PSBudWxsID8gbmV4dFR5cGUuJCR0eXBlb2YgOiBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6IHsKICAgICAgICAgICAgICAgIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX01FTU9fVFlQRTIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzQ29tcGFyZUZhbWlsaWVzKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZGYW1pbHkgPSByZXNvbHZlRmFtaWx5KHByZXZUeXBlKTsKICAgICAgICAgICAgICBpZiAocHJldkZhbWlseSAhPT0gdm9pZCAwICYmIHByZXZGYW1pbHkgPT09IHJlc29sdmVGYW1pbHkobmV4dFR5cGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIFdlYWtTZXQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFpbGVkQm91bmRhcmllcy5hZGQoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIHVwZGF0ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhbGVGYW1pbGllcyA9IHVwZGF0ZS5zdGFsZUZhbWlsaWVzLCB1cGRhdGVkRmFtaWxpZXMgPSB1cGRhdGUudXBkYXRlZEZhbWlsaWVzOwogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUm9vdCA9IGZ1bmN0aW9uKHJvb3QzLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyb290My5jb250ZXh0ICE9PSBlbXB0eUNvbnRleHRPYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGZpYmVyLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZSwgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlc29sdmVGYW1pbHkgdG8gYmUgc2V0IGR1cmluZyBob3QgcmVsb2FkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZWVkc1JlbmRlciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkoY2FuZGlkYXRlVHlwZSk7CiAgICAgICAgICAgICAgaWYgKGZhbWlseSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhbGVGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1cGRhdGVkRmFtaWxpZXMuaGFzKGZhbWlseSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBmaWJlci5fZGVidWdOZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQgfHwgbmVlZHNSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgX3Jvb3QgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAoX3Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihfcm9vdCwgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCAmJiAhbmVlZHNSZW1vdW50KSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShjaGlsZCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoc2libGluZywgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIGZhbWlsaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHR5cGVzID0gbmV3IFNldChmYW1pbGllcy5tYXAoZnVuY3Rpb24oZmFtaWx5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIHJldHVybiBob3N0SW5zdGFuY2VzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGZpYmVyLCB0eXBlcywgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRpZE1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVzLmhhcyhjYW5kaWRhdGVUeXBlKSkgewogICAgICAgICAgICAgICAgZGlkTWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkTWF0Y2gpIHsKICAgICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShjaGlsZCwgdHlwZXMsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShzaWJsaW5nLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgaWYgKGZvdW5kSG9zdEluc3RhbmNlcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gcmVhY2ggcm9vdCBmaXJzdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDaGlsZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmFsc2U7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBmb3VuZEhvc3RJbnN0YW5jZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm91bmRIb3N0SW5zdGFuY2VzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNCYWRNYXBQb2x5ZmlsbDsKICAgICAgICB7CiAgICAgICAgICBoYXNCYWRNYXBQb2x5ZmlsbCA9IGZhbHNlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5vbkV4dGVuc2libGVPYmplY3QgPSBPYmplY3QucHJldmVudEV4dGVuc2lvbnMoe30pOwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbW25vbkV4dGVuc2libGVPYmplY3QsIG51bGxdXSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtub25FeHRlbnNpYmxlT2JqZWN0XSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgICB0aGlzLmVsZW1lbnRUeXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMudHlwZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnN0YXRlTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnJldHVybiA9IG51bGw7CiAgICAgICAgICB0aGlzLmNoaWxkID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2libGluZyA9IG51bGw7CiAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgIHRoaXMucmVmID0gbnVsbDsKICAgICAgICAgIHRoaXMucGVuZGluZ1Byb3BzID0gcGVuZGluZ1Byb3BzOwogICAgICAgICAgdGhpcy5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgIHRoaXMudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgdGhpcy5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgIHRoaXMubW9kZSA9IG1vZGU7CiAgICAgICAgICB0aGlzLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgIHRoaXMubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHRoaXMuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnU291cmNlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdPd25lciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnTmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnSG9va1R5cGVzID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNCYWRNYXBQb2x5ZmlsbCAmJiB0eXBlb2YgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjcmVhdGVGaWJlciA9IGZ1bmN0aW9uKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHJldHVybiBuZXcgRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiAmJiAhc2hvdWxkQ29uc3RydWN0JDEodHlwZSkgJiYgdHlwZS5kZWZhdWx0UHJvcHMgPT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUxhenlDb21wb25lbnRUYWcoQ29tcG9uZW50KSB7CiAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSA/IENsYXNzQ29tcG9uZW50IDogRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKENvbXBvbmVudCAhPT0gdm9pZCAwICYmIENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgJCR0eXBlb2YgPSBDb21wb25lbnQuJCR0eXBlb2Y7CiAgICAgICAgICAgIGlmICgkJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIpIHsKICAgICAgICAgICAgICByZXR1cm4gRm9yd2FyZFJlZjI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50NCwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gY3VycmVudDQuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMiA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSBjcmVhdGVGaWJlcihjdXJyZW50NC50YWcsIHBlbmRpbmdQcm9wcywgY3VycmVudDQua2V5LCBjdXJyZW50NC5tb2RlKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID0gY3VycmVudDQuZWxlbWVudFR5cGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDQudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGN1cnJlbnQ0LnN0YXRlTm9kZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2UgPSBjdXJyZW50NC5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z093bmVyID0gY3VycmVudDQuX2RlYnVnT3duZXI7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGN1cnJlbnQ0Ll9kZWJ1Z0hvb2tUeXBlczsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gY3VycmVudDQ7CiAgICAgICAgICAgIGN1cnJlbnQ0LmFsdGVybmF0ZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDQudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGN1cnJlbnQ0LmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDQuY2hpbGRMYW5lczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICBsYW5lczogY3VycmVudERlcGVuZGVuY2llcy5sYW5lcywKICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zaWJsaW5nID0gY3VycmVudDQuc2libGluZzsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5pbmRleCA9IGN1cnJlbnQ0LmluZGV4OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnJlZiA9IGN1cnJlbnQ0LnJlZjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50NC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdOZWVkc1JlbW91bnQgPSBjdXJyZW50NC5fZGVidWdOZWVkc1JlbW91bnQ7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IFN0YXRpY01hc2sgfCBQbGFjZW1lbnQ7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDQuY2hpbGRMYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB2YXIgY3VycmVudERlcGVuZGVuY2llcyA9IGN1cnJlbnQ0LmRlcGVuZGVuY2llczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY3VycmVudERlcGVuZGVuY2llcy5maXJzdENvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudDQuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUpIHsKICAgICAgICAgIHZhciBtb2RlOwogICAgICAgICAgaWYgKHRhZyA9PT0gQ29uY3VycmVudFJvb3QpIHsKICAgICAgICAgICAgbW9kZSA9IENvbmN1cnJlbnRNb2RlOwogICAgICAgICAgICBpZiAoaXNTdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RMZWdhY3lNb2RlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtb2RlID0gTm9Nb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIG1vZGUgfD0gUHJvZmlsZU1vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXIoSG9zdFJvb3QsIG51bGwsIG51bGwsIG1vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIGZpYmVyVGFnID0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFR5cGUgPSB0eXBlOwogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSkgewogICAgICAgICAgICAgIGZpYmVyVGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZmliZXJUYWcgPSBIb3N0Q29tcG9uZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0VGFnOiBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQocGVuZGluZ1Byb3BzLmNoaWxkcmVuLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgICBmaWJlclRhZyA9IE1vZGU7CiAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdEVmZmVjdHNNb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVByb2ZpbGVyKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9PRkZTQ1JFRU5fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xFR0FDWV9ISURERU5fVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NDT1BFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DQUNIRV9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfVFJBQ0lOR19NQVJLRVJfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFOgogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IENvbnRleHRQcm92aWRlcjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dENvbnN1bWVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IEZvcndhcmRSZWYyOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTGF6eUNvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBvd25lciA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXIpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQ6IGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSAiICsgKCJidXQgZ290OiAiICsgKHR5cGUgPT0gbnVsbCA/IHR5cGUgOiB0eXBlb2YgdHlwZSkgKyAiLiIgKyBpbmZvKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihmaWJlclRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSB0eXBlOwogICAgICAgICAgZmliZXIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBvd25lciA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBlbGVtZW50LnByb3BzOwogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHR5cGUsIGtleSwgcGVuZGluZ1Byb3BzLCBvd25lciwgbW9kZSwgbGFuZXMpOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnRzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihGcmFnbWVudDEwLCBlbGVtZW50cywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVByb2ZpbGVyKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHBlbmRpbmdQcm9wcy5pZCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBlcnJvcignUHJvZmlsZXIgbXVzdCBzcGVjaWZ5IGFuICJpZCIgb2YgdHlwZSBgc3RyaW5nYCBhcyBhIHByb3AuIFJlY2VpdmVkIHRoZSB0eXBlIGAlc2AgaW5zdGVhZC4nLCB0eXBlb2YgcGVuZGluZ1Byb3BzLmlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoUHJvZmlsZXIsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlIHwgUHJvZmlsZU1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9QUk9GSUxFUl9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICAgIGVmZmVjdER1cmF0aW9uOiAwLAogICAgICAgICAgICAgIHBhc3NpdmVFZmZlY3REdXJhdGlvbjogMAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZShwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFN1c3BlbnNlQ29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZUxpc3QocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihTdXNwZW5zZUxpc3RDb21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoT2Zmc2NyZWVuQ29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX09GRlNDUkVFTl9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRJbnN0YW5jZSA9IHsKICAgICAgICAgICAgaXNIaWRkZW46IGZhbHNlCiAgICAgICAgICB9OwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gcHJpbWFyeUNoaWxkSW5zdGFuY2U7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVRleHQoY29udGVudCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RUZXh0LCBjb250ZW50LCBudWxsLCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoSG9zdENvbXBvbmVudCwgbnVsbCwgbnVsbCwgTm9Nb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gIkRFTEVURUQiOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoZGVoeWRyYXRlZE5vZGUpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKERlaHlkcmF0ZWRGcmFnbWVudCwgbnVsbCwgbnVsbCwgTm9Nb2RlKTsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGRlaHlkcmF0ZWROb2RlOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIHBlbmRpbmdQcm9wcyA9IHBvcnRhbC5jaGlsZHJlbiAhPT0gbnVsbCA/IHBvcnRhbC5jaGlsZHJlbiA6IFtdOwogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoSG9zdFBvcnRhbCwgcGVuZGluZ1Byb3BzLCBwb3J0YWwua2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB7CiAgICAgICAgICAgIGNvbnRhaW5lckluZm86IHBvcnRhbC5jb250YWluZXJJbmZvLAogICAgICAgICAgICBwZW5kaW5nQ2hpbGRyZW46IG51bGwsCiAgICAgICAgICAgIC8vIFVzZWQgYnkgcGVyc2lzdGVudCB1cGRhdGVzCiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBwb3J0YWwuaW1wbGVtZW50YXRpb24KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKHRhcmdldCwgc291cmNlKSB7CiAgICAgICAgICBpZiAodGFyZ2V0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRhcmdldCA9IGNyZWF0ZUZpYmVyKEluZGV0ZXJtaW5hdGVDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQudGFnID0gc291cmNlLnRhZzsKICAgICAgICAgIHRhcmdldC5rZXkgPSBzb3VyY2Uua2V5OwogICAgICAgICAgdGFyZ2V0LmVsZW1lbnRUeXBlID0gc291cmNlLmVsZW1lbnRUeXBlOwogICAgICAgICAgdGFyZ2V0LnR5cGUgPSBzb3VyY2UudHlwZTsKICAgICAgICAgIHRhcmdldC5zdGF0ZU5vZGUgPSBzb3VyY2Uuc3RhdGVOb2RlOwogICAgICAgICAgdGFyZ2V0LnJldHVybiA9IHNvdXJjZS5yZXR1cm47CiAgICAgICAgICB0YXJnZXQuY2hpbGQgPSBzb3VyY2UuY2hpbGQ7CiAgICAgICAgICB0YXJnZXQuc2libGluZyA9IHNvdXJjZS5zaWJsaW5nOwogICAgICAgICAgdGFyZ2V0LmluZGV4ID0gc291cmNlLmluZGV4OwogICAgICAgICAgdGFyZ2V0LnJlZiA9IHNvdXJjZS5yZWY7CiAgICAgICAgICB0YXJnZXQucGVuZGluZ1Byb3BzID0gc291cmNlLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHRhcmdldC5tZW1vaXplZFByb3BzID0gc291cmNlLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB0YXJnZXQudXBkYXRlUXVldWUgPSBzb3VyY2UudXBkYXRlUXVldWU7CiAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRTdGF0ZSA9IHNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdGFyZ2V0LmRlcGVuZGVuY2llcyA9IHNvdXJjZS5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB0YXJnZXQubW9kZSA9IHNvdXJjZS5tb2RlOwogICAgICAgICAgdGFyZ2V0LmZsYWdzID0gc291cmNlLmZsYWdzOwogICAgICAgICAgdGFyZ2V0LnN1YnRyZWVGbGFncyA9IHNvdXJjZS5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB0YXJnZXQuZGVsZXRpb25zID0gc291cmNlLmRlbGV0aW9uczsKICAgICAgICAgIHRhcmdldC5sYW5lcyA9IHNvdXJjZS5sYW5lczsKICAgICAgICAgIHRhcmdldC5jaGlsZExhbmVzID0gc291cmNlLmNoaWxkTGFuZXM7CiAgICAgICAgICB0YXJnZXQuYWx0ZXJuYXRlID0gc291cmNlLmFsdGVybmF0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbER1cmF0aW9uID0gc291cmNlLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICB0YXJnZXQuYWN0dWFsU3RhcnRUaW1lID0gc291cmNlLmFjdHVhbFN0YXJ0VGltZTsKICAgICAgICAgICAgdGFyZ2V0LnNlbGZCYXNlRHVyYXRpb24gPSBzb3VyY2Uuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgdGFyZ2V0LnRyZWVCYXNlRHVyYXRpb24gPSBzb3VyY2UudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldC5fZGVidWdTb3VyY2UgPSBzb3VyY2UuX2RlYnVnU291cmNlOwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z093bmVyID0gc291cmNlLl9kZWJ1Z093bmVyOwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z05lZWRzUmVtb3VudCA9IHNvdXJjZS5fZGVidWdOZWVkc1JlbW91bnQ7CiAgICAgICAgICB0YXJnZXQuX2RlYnVnSG9va1R5cGVzID0gc291cmNlLl9kZWJ1Z0hvb2tUeXBlczsKICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIEZpYmVyUm9vdE5vZGUoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICB0aGlzLnRhZyA9IHRhZzsKICAgICAgICAgIHRoaXMuY29udGFpbmVySW5mbyA9IGNvbnRhaW5lckluZm87CiAgICAgICAgICB0aGlzLnBlbmRpbmdDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgdGhpcy5waW5nQ2FjaGUgPSBudWxsOwogICAgICAgICAgdGhpcy5maW5pc2hlZFdvcmsgPSBudWxsOwogICAgICAgICAgdGhpcy50aW1lb3V0SGFuZGxlID0gbm9UaW1lb3V0OwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHRoaXMucGVuZGluZ0NvbnRleHQgPSBudWxsOwogICAgICAgICAgdGhpcy5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgdGhpcy5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgdGhpcy5ldmVudFRpbWVzID0gY3JlYXRlTGFuZU1hcChOb0xhbmVzKTsKICAgICAgICAgIHRoaXMuZXhwaXJhdGlvblRpbWVzID0gY3JlYXRlTGFuZU1hcChOb1RpbWVzdGFtcCk7CiAgICAgICAgICB0aGlzLnBlbmRpbmdMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5leHBpcmVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5tdXRhYmxlUmVhZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZmluaXNoZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmVudGFuZ2xlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZW50YW5nbGVtZW50cyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICB0aGlzLmlkZW50aWZpZXJQcmVmaXggPSBpZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdGhpcy5vblJlY292ZXJhYmxlRXJyb3IgPSBvblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubWVtb2l6ZWRVcGRhdGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gdGhpcy5wZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBUb3RhbExhbmVzOyBfaSsrKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcC5wdXNoKC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBDb25jdXJyZW50Um9vdDoKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlUm9vdCgpIiA6ICJjcmVhdGVSb290KCkiOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBMZWdhY3lSb290OgogICAgICAgICAgICAgICAgdGhpcy5fZGVidWdSb290VHlwZSA9IGh5ZHJhdGUyID8gImh5ZHJhdGUoKSIgOiAicmVuZGVyKCkiOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGluaXRpYWxDaGlsZHJlbiwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIHJvb3QzID0gbmV3IEZpYmVyUm9vdE5vZGUoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIHZhciB1bmluaXRpYWxpemVkRmliZXIgPSBjcmVhdGVIb3N0Um9vdEZpYmVyKHRhZywgaXNTdHJpY3RNb2RlKTsKICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSB1bmluaXRpYWxpemVkRmliZXI7CiAgICAgICAgICB1bmluaXRpYWxpemVkRmliZXIuc3RhdGVOb2RlID0gcm9vdDM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfaW5pdGlhbFN0YXRlID0gewogICAgICAgICAgICAgIGVsZW1lbnQ6IGluaXRpYWxDaGlsZHJlbiwKICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGh5ZHJhdGUyLAogICAgICAgICAgICAgIGNhY2hlOiBudWxsLAogICAgICAgICAgICAgIC8vIG5vdCBlbmFibGVkIHlldAogICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsLAogICAgICAgICAgICAgIHBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXM6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLm1lbW9pemVkU3RhdGUgPSBfaW5pdGlhbFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHVuaW5pdGlhbGl6ZWRGaWJlcik7CiAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFZlcnNpb24gPSAiMTguMy4xIjsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVQb3J0YWwzKGNoaWxkcmVuLCBjb250YWluZXJJbmZvLCBpbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzNdIDogbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihrZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3cgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IFBvcnRhbAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfUE9SVEFMX1RZUEUsCiAgICAgICAgICAgIGtleToga2V5ID09IG51bGwgPyBudWxsIDogIiIgKyBrZXksCiAgICAgICAgICAgIGNoaWxkcmVuLAogICAgICAgICAgICBjb250YWluZXJJbmZvLAogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgaWYgKCFwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGdldDcocGFyZW50Q29tcG9uZW50KTsKICAgICAgICAgIHZhciBwYXJlbnRDb250ZXh0ID0gZmluZEN1cnJlbnRVbm1hc2tlZENvbnRleHQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIENvbXBvbmVudCwgcGFyZW50Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlV2l0aFdhcm5pbmcoY29tcG9uZW50LCBtZXRob2ROYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDcoY29tcG9uZW50KTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbXBvbmVudC5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGNvbXBvbmVudCkuam9pbigiLCIpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudCBhcHBlYXJzIHRvIG5vdCBiZSBhIFJlYWN0Q29tcG9uZW50LiBLZXlzOiAiICsga2V5cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9zdEZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZVtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNGaWJlciA9IGN1cnJlbnQzOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGhvc3RGaWJlcik7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggaXMgaW5zaWRlIFN0cmljdE1vZGUuIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggcmVuZGVycyBTdHJpY3RNb2RlIGNoaWxkcmVuLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldmlvdXNGaWJlcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaW5pdGlhbENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgY2FsbGJhY2ssIGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gdHJ1ZTsKICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgcm9vdDMuY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKG51bGwpOwogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gcm9vdDMuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQ0KTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwgPyBjYWxsYmFjayA6IG51bGw7CiAgICAgICAgICBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQ0LCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgY29udGFpbmVyMiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBvblNjaGVkdWxlUm9vdChjb250YWluZXIyLCBlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50JDEgPSBjb250YWluZXIyLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50JDEpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuY29udGV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb250YWluZXIyLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wZW5kaW5nQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiBjdXJyZW50MyAhPT0gbnVsbCAmJiAhZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcykgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJSZW5kZXIgbWV0aG9kcyBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZTsgdHJpZ2dlcmluZyBuZXN0ZWQgY29tcG9uZW50IHVwZGF0ZXMgZnJvbSByZW5kZXIgaXMgbm90IGFsbG93ZWQuIElmIG5lY2Vzc2FyeSwgdHJpZ2dlciBuZXN0ZWQgdXBkYXRlcyBpbiBjb21wb25lbnREaWRVcGRhdGUuXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mICVzLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudDMpIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gewogICAgICAgICAgICBlbGVtZW50CiAgICAgICAgICB9OwogICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayA9PT0gdm9pZCAwID8gbnVsbCA6IGNhbGxiYWNrOwogICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGJhY2spOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoY3VycmVudCQxLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudCQxLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBjdXJyZW50JDEsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFB1YmxpY1Jvb3RJbnN0YW5jZShjb250YWluZXIyKSB7CiAgICAgICAgICB2YXIgY29udGFpbmVyRmliZXIgPSBjb250YWluZXIyLmN1cnJlbnQ7CiAgICAgICAgICBpZiAoIWNvbnRhaW5lckZpYmVyLmNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChjb250YWluZXJGaWJlci5jaGlsZC50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBnZXRQdWJsaWNJbnN0YW5jZShjb250YWluZXJGaWJlci5jaGlsZC5zdGF0ZU5vZGUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBjb250YWluZXJGaWJlci5jaGlsZC5zdGF0ZU5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgdmFyIGxhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKTsKICAgICAgICAgICAgICAgIGZsdXNoUm9vdChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3Q0ID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICBpZiAocm9vdDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3Q0LCBmaWJlciwgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IFN5bmNMYW5lOwogICAgICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSA9IGhpZ2hlclByaW9yaXR5TGFuZShzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSwgcmV0cnlMYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoZmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSkgewogICAgICAgICAgICBtYXJrUmV0cnlMYW5lSW1wbChhbHRlcm5hdGUsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uJDEoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gU2VsZWN0aXZlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5JDEoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhmaWJlcikgewogICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhmaWJlcik7CiAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhvc3RGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgfQogICAgICAgIHZhciBzaG91bGRFcnJvckltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRFcnJvcihmaWJlcikgewogICAgICAgICAgcmV0dXJuIHNob3VsZEVycm9ySW1wbChmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBzaG91bGRTdXNwZW5kSW1wbCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRTdXNwZW5kKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gc2hvdWxkU3VzcGVuZEltcGwoZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGUgPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZUhvb2tTdGF0ZURlbGV0ZVBhdGggPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGggPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZVByb3BzID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGggPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIHNjaGVkdWxlVXBkYXRlID0gbnVsbDsKICAgICAgICB2YXIgc2V0RXJyb3JIYW5kbGVyID0gbnVsbDsKICAgICAgICB2YXIgc2V0U3VzcGVuc2VIYW5kbGVyID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgY29weVdpdGhEZWxldGVJbXBsID0gZnVuY3Rpb24ob2JqLCBwYXRoMiwgaW5kZXgyKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoMltpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkyKG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbjIoe30sIG9iaik7CiAgICAgICAgICAgIGlmIChpbmRleDIgKyAxID09PSBwYXRoMi5sZW5ndGgpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheTIodXBkYXRlZCkpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZWQuc3BsaWNlKGtleSwgMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB1cGRhdGVkW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZWRba2V5XSA9IGNvcHlXaXRoRGVsZXRlSW1wbChvYmpba2V5XSwgcGF0aDIsIGluZGV4MiArIDEpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhEZWxldGUgPSBmdW5jdGlvbihvYmosIHBhdGgyKSB7CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aERlbGV0ZUltcGwob2JqLCBwYXRoMiwgMCk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoUmVuYW1lSW1wbCA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCwgaW5kZXgyKSB7CiAgICAgICAgICAgIHZhciBvbGRLZXkgPSBvbGRQYXRoW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheTIob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduMih7fSwgb2JqKTsKICAgICAgICAgICAgaWYgKGluZGV4MiArIDEgPT09IG9sZFBhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0tleSA9IG5ld1BhdGhbaW5kZXgyXTsKICAgICAgICAgICAgICB1cGRhdGVkW25ld0tleV0gPSB1cGRhdGVkW29sZEtleV07CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkLnNwbGljZShvbGRLZXksIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtvbGRLZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGVkW29sZEtleV0gPSBjb3B5V2l0aFJlbmFtZUltcGwoCiAgICAgICAgICAgICAgICAvLyAkRmxvd0ZpeE1lIG51bWJlciBvciBzdHJpbmcgaXMgZmluZSBoZXJlCiAgICAgICAgICAgICAgICBvYmpbb2xkS2V5XSwKICAgICAgICAgICAgICAgIG9sZFBhdGgsCiAgICAgICAgICAgICAgICBuZXdQYXRoLAogICAgICAgICAgICAgICAgaW5kZXgyICsgMQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoUmVuYW1lID0gZnVuY3Rpb24ob2JqLCBvbGRQYXRoLCBuZXdQYXRoKSB7CiAgICAgICAgICAgIGlmIChvbGRQYXRoLmxlbmd0aCAhPT0gbmV3UGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB3YXJuMygiY29weVdpdGhSZW5hbWUoKSBleHBlY3RzIHBhdGhzIG9mIHRoZSBzYW1lIGxlbmd0aCIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld1BhdGgubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUGF0aFtpXSAhPT0gbmV3UGF0aFtpXSkgewogICAgICAgICAgICAgICAgICB3YXJuMygiY29weVdpdGhSZW5hbWUoKSBleHBlY3RzIHBhdGhzIHRvIGJlIHRoZSBzYW1lIGV4Y2VwdCBmb3IgdGhlIGRlZXBlc3Qga2V5Iik7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoUmVuYW1lSW1wbChvYmosIG9sZFBhdGgsIG5ld1BhdGgsIDApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFNldEltcGwgPSBmdW5jdGlvbihvYmosIHBhdGgyLCBpbmRleDIsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpbmRleDIgPj0gcGF0aDIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoMltpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkyKG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbjIoe30sIG9iaik7CiAgICAgICAgICAgIHVwZGF0ZWRba2V5XSA9IGNvcHlXaXRoU2V0SW1wbChvYmpba2V5XSwgcGF0aDIsIGluZGV4MiArIDEsIHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoU2V0ID0gZnVuY3Rpb24ob2JqLCBwYXRoMiwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoU2V0SW1wbChvYmosIHBhdGgyLCAwLCB2YWx1ZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZpbmRIb29rID0gZnVuY3Rpb24oZmliZXIsIGlkKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50SG9vazIgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudEhvb2syICE9PSBudWxsICYmIGlkID4gMCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rMiA9IGN1cnJlbnRIb29rMi5uZXh0OwogICAgICAgICAgICAgIGlkLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRIb29rMjsKICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgcGF0aDIsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gZmluZEhvb2soZmliZXIsIGlkKTsKICAgICAgICAgICAgaWYgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aFNldChob29rLm1lbW9pemVkU3RhdGUsIHBhdGgyLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduMih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgcGF0aDIpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoRGVsZXRlKGhvb2subWVtb2l6ZWRTdGF0ZSwgcGF0aDIpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbjIoe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGggPSBmdW5jdGlvbihmaWJlciwgaWQsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoUmVuYW1lKGhvb2subWVtb2l6ZWRTdGF0ZSwgb2xkUGF0aCwgbmV3UGF0aCk7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduMih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlUHJvcHMgPSBmdW5jdGlvbihmaWJlciwgcGF0aDIsIHZhbHVlKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoU2V0KGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgyLCB2YWx1ZSk7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGggPSBmdW5jdGlvbihmaWJlciwgcGF0aDIpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhEZWxldGUoZmliZXIubWVtb2l6ZWRQcm9wcywgcGF0aDIpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoID0gZnVuY3Rpb24oZmliZXIsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhSZW5hbWUoZmliZXIubWVtb2l6ZWRQcm9wcywgb2xkUGF0aCwgbmV3UGF0aCk7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgc2NoZWR1bGVVcGRhdGUgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHNldEVycm9ySGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZEVycm9ySW1wbCkgewogICAgICAgICAgICBzaG91bGRFcnJvckltcGwgPSBuZXdTaG91bGRFcnJvckltcGw7CiAgICAgICAgICB9OwogICAgICAgICAgc2V0U3VzcGVuc2VIYW5kbGVyID0gZnVuY3Rpb24obmV3U2hvdWxkU3VzcGVuZEltcGwpIHsKICAgICAgICAgICAgc2hvdWxkU3VzcGVuZEltcGwgPSBuZXdTaG91bGRTdXNwZW5kSW1wbDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbXB0eUZpbmRGaWJlckJ5SG9zdEluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyRm9yRGV2VG9vbHMoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudDM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluamVjdEludG9EZXZUb29scyhkZXZUb29sc0NvbmZpZykgewogICAgICAgICAgdmFyIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlID0gZGV2VG9vbHNDb25maWcuZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U7CiAgICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgICAgcmV0dXJuIGluamVjdEludGVybmFscyh7CiAgICAgICAgICAgIGJ1bmRsZVR5cGU6IGRldlRvb2xzQ29uZmlnLmJ1bmRsZVR5cGUsCiAgICAgICAgICAgIHZlcnNpb246IGRldlRvb2xzQ29uZmlnLnZlcnNpb24sCiAgICAgICAgICAgIHJlbmRlcmVyUGFja2FnZU5hbWU6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyUGFja2FnZU5hbWUsCiAgICAgICAgICAgIHJlbmRlcmVyQ29uZmlnOiBkZXZUb29sc0NvbmZpZy5yZW5kZXJlckNvbmZpZywKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGUsCiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzLAogICAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGgsCiAgICAgICAgICAgIHNldEVycm9ySGFuZGxlciwKICAgICAgICAgICAgc2V0U3VzcGVuc2VIYW5kbGVyLAogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZSwKICAgICAgICAgICAgY3VycmVudERpc3BhdGNoZXJSZWY6IFJlYWN0Q3VycmVudERpc3BhdGNoZXIyLAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlQnlGaWJlciwKICAgICAgICAgICAgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U6IGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlIHx8IGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UsCiAgICAgICAgICAgIC8vIFJlYWN0IFJlZnJlc2gKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoLAogICAgICAgICAgICBzY2hlZHVsZVJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUm9vdCwKICAgICAgICAgICAgc2V0UmVmcmVzaEhhbmRsZXIsCiAgICAgICAgICAgIC8vIEVuYWJsZXMgRGV2VG9vbHMgdG8gYXBwZW5kIG93bmVyIHN0YWNrcyB0byBlcnJvciBtZXNzYWdlcyBpbiBERVYgbW9kZS4KICAgICAgICAgICAgZ2V0Q3VycmVudEZpYmVyOiBnZXRDdXJyZW50RmliZXJGb3JEZXZUb29scywKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBkZXRlY3QgcmVjb25jaWxlciB2ZXJzaW9uIHJhdGhlciB0aGFuIHJlbmRlcmVyIHZlcnNpb24KICAgICAgICAgICAgLy8gd2hpY2ggbWF5IG5vdCBtYXRjaCBmb3IgdGhpcmQgcGFydHkgcmVuZGVyZXJzLgogICAgICAgICAgICByZWNvbmNpbGVyVmVyc2lvbjogUmVhY3RWZXJzaW9uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdmFyIGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3IgPSB0eXBlb2YgcmVwb3J0RXJyb3IgPT09ICJmdW5jdGlvbiIgPyAoCiAgICAgICAgICAvLyBJbiBtb2Rlcm4gYnJvd3NlcnMsIHJlcG9ydEVycm9yIHdpbGwgZGlzcGF0Y2ggYW4gZXJyb3IgZXZlbnQsCiAgICAgICAgICAvLyBlbXVsYXRpbmcgYW4gdW5jYXVnaHQgSmF2YVNjcmlwdCBlcnJvci4KICAgICAgICAgIHJlcG9ydEVycm9yCiAgICAgICAgKSA6IGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gUmVhY3RET01Sb290KGludGVybmFsUm9vdCkgewogICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gaW50ZXJuYWxSb290OwogICAgICAgIH0KICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnJlbmRlciA9IFJlYWN0RE9NUm9vdC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciByb290MyA9IHRoaXMuX2ludGVybmFsUm9vdDsKICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB1cGRhdGUgYW4gdW5tb3VudGVkIHJvb3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBkb2VzIG5vdCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gYSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRDb250YWluZXIoYXJndW1lbnRzWzFdKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgY29udGFpbmVyIHRvIHRoZSBzZWNvbmQgYXJndW1lbnQgb2Ygcm9vdC5yZW5kZXIoLi4uKS4gWW91IGRvbid0IG5lZWQgdG8gcGFzcyBpdCBhZ2FpbiBzaW5jZSB5b3UgYWxyZWFkeSBwYXNzZWQgaXQgdG8gY3JlYXRlIHRoZSByb290LiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBzZWNvbmQgYXJndW1lbnQgdG8gcm9vdC5yZW5kZXIoLi4uKSBidXQgaXQgb25seSBhY2NlcHRzIG9uZSBhcmd1bWVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGUgcm9vdCBjb250YWluZXIgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBSZWFjdC4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGNhdXNlIGVycm9ycy4gSW5zdGVhZCwgY2FsbCByb290LnVubW91bnQoKSB0byBlbXB0eSBhIHJvb3QncyBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB1cGRhdGVDb250YWluZXIoY2hpbGRyZW4sIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICB9OwogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5tb3VudCA9IFJlYWN0RE9NUm9vdC5wcm90b3R5cGUudW5tb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50KC4uLik6IGRvZXMgbm90IHN1cHBvcnQgYSBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IHRoaXMuX2ludGVybmFsUm9vdDsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJBdHRlbXB0ZWQgdG8gc3luY2hyb25vdXNseSB1bm1vdW50IGEgcm9vdCB3aGlsZSBSZWFjdCB3YXMgYWxyZWFkeSByZW5kZXJpbmcuIFJlYWN0IGNhbm5vdCBmaW5pc2ggdW5tb3VudGluZyB0aGUgcm9vdCB1bnRpbCB0aGUgY3VycmVudCByZW5kZXIgaGFzIGNvbXBsZXRlZCwgd2hpY2ggbWF5IGxlYWQgdG8gYSByYWNlIGNvbmRpdGlvbi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihudWxsLCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB1bm1hcmtDb250YWluZXJBc1Jvb3QoY29udGFpbmVyMik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290Mihjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY3JlYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHZhciBpc1N0cmljdE1vZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9ICIiOwogICAgICAgICAgdmFyIG9uUmVjb3ZlcmFibGVFcnJvciA9IGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkNhbGxiYWNrcyA9IG51bGw7CiAgICAgICAgICBpZiAob3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyLmh5ZHJhdGUpIHsKICAgICAgICAgICAgICAgIHdhcm4zKCJoeWRyYXRlIHRocm91Z2ggY3JlYXRlUm9vdCBpcyBkZXByZWNhdGVkLiBVc2UgUmVhY3RET01DbGllbnQuaHlkcmF0ZVJvb3QoY29udGFpbmVyLCA8QXBwIC8+KSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMyID09PSAib2JqZWN0IiAmJiBvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMi4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgSlNYIGVsZW1lbnQgdG8gY3JlYXRlUm9vdC4gWW91IHByb2JhYmx5IG1lYW50IHRvIGNhbGwgcm9vdC5yZW5kZXIgaW5zdGVhZC4gRXhhbXBsZSB1c2FnZTpcblxuICBsZXQgcm9vdCA9IGNyZWF0ZVJvb3QoZG9tQ29udGFpbmVyKTtcbiAgcm9vdC5yZW5kZXIoPEFwcCAvPik7Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi51bnN0YWJsZV9zdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgaXNTdHJpY3RNb2RlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIuaWRlbnRpZmllclByZWZpeCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWRlbnRpZmllclByZWZpeCA9IG9wdGlvbnMyLmlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgb25SZWNvdmVyYWJsZUVycm9yID0gb3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cmFuc2l0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIudHJhbnNpdGlvbkNhbGxiYWNrczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBudWxsLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KHJvb3QzLmN1cnJlbnQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgIHJldHVybiBuZXcgUmVhY3RET01Sb290KHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gUmVhY3RET01IeWRyYXRpb25Sb290KGludGVybmFsUm9vdCkgewogICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gaW50ZXJuYWxSb290OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUh5ZHJhdGlvbih0YXJnZXQpIHsKICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgcXVldWVFeHBsaWNpdEh5ZHJhdGlvblRhcmdldCh0YXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnVuc3RhYmxlX3NjaGVkdWxlSHlkcmF0aW9uID0gc2NoZWR1bGVIeWRyYXRpb247CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBvcHRpb25zMikgewogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiaHlkcmF0ZVJvb3QoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbml0aWFsQ2hpbGRyZW4gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGVycm9yKCJNdXN0IHByb3ZpZGUgaW5pdGlhbCBjaGlsZHJlbiBhcyBzZWNvbmQgYXJndW1lbnQgdG8gaHlkcmF0ZVJvb3QuIEV4YW1wbGUgdXNhZ2U6IGh5ZHJhdGVSb290KGRvbUNvbnRhaW5lciwgPEFwcCAvPikiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGh5ZHJhdGlvbkNhbGxiYWNrcyA9IG9wdGlvbnMyICE9IG51bGwgPyBvcHRpb25zMiA6IG51bGw7CiAgICAgICAgICB2YXIgbXV0YWJsZVNvdXJjZXMgPSBvcHRpb25zMiAhPSBudWxsICYmIG9wdGlvbnMyLmh5ZHJhdGVkU291cmNlcyB8fCBudWxsOwogICAgICAgICAgdmFyIGlzU3RyaWN0TW9kZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gIiI7CiAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIGlmIChvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChvcHRpb25zMi51bnN0YWJsZV9zdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgaXNTdHJpY3RNb2RlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIuaWRlbnRpZmllclByZWZpeCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWRlbnRpZmllclByZWZpeCA9IG9wdGlvbnMyLmlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgb25SZWNvdmVyYWJsZUVycm9yID0gb3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVIeWRyYXRpb25Db250YWluZXIoaW5pdGlhbENoaWxkcmVuLCBudWxsLCBjb250YWluZXIyLCBDb25jdXJyZW50Um9vdCwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KHJvb3QzLmN1cnJlbnQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMoY29udGFpbmVyMik7CiAgICAgICAgICBpZiAobXV0YWJsZVNvdXJjZXMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtdXRhYmxlU291cmNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlID0gbXV0YWJsZVNvdXJjZXNbaV07CiAgICAgICAgICAgICAgcmVnaXN0ZXJNdXRhYmxlU291cmNlRm9ySHlkcmF0aW9uKHJvb3QzLCBtdXRhYmxlU291cmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTUh5ZHJhdGlvblJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyKG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8ICFkaXNhYmxlQ29tbWVudHNBc0RPTUNvbnRhaW5lcnMpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZENvbnRhaW5lckxlZ2FjeShub2RlKSB7CiAgICAgICAgICByZXR1cm4gISEobm9kZSAmJiAobm9kZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfRlJBR01FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgJiYgbm9kZS5ub2RlVmFsdWUgPT09ICIgcmVhY3QtbW91bnQtcG9pbnQtdW5zdGFibGUgIikpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSAmJiBjb250YWluZXIyLnRhZ05hbWUgJiYgY29udGFpbmVyMi50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJCT0RZIikgewogICAgICAgICAgICAgIGVycm9yKCJjcmVhdGVSb290KCk6IENyZWF0aW5nIHJvb3RzIGRpcmVjdGx5IHdpdGggZG9jdW1lbnQuYm9keSBpcyBkaXNjb3VyYWdlZCwgc2luY2UgaXRzIGNoaWxkcmVuIGFyZSBvZnRlbiBtYW5pcHVsYXRlZCBieSB0aGlyZC1wYXJ0eSBzY3JpcHRzIGFuZCBicm93c2VyIGV4dGVuc2lvbnMuIFRoaXMgbWF5IGxlYWQgdG8gc3VidGxlIHJlY29uY2lsaWF0aW9uIGlzc3Vlcy4gVHJ5IHVzaW5nIGEgY29udGFpbmVyIGVsZW1lbnQgY3JlYXRlZCBmb3IgeW91ciBhcHAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET00ucmVuZGVyKCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkgb24gYSBjb250YWluZXIgdGhhdCBoYXMgYWxyZWFkeSBiZWVuIHBhc3NlZCB0byBjcmVhdGVSb290KCkgYmVmb3JlLiBJbnN0ZWFkLCBjYWxsIHJvb3QucmVuZGVyKCkgb24gdGhlIGV4aXN0aW5nIHJvb3QgaW5zdGVhZCBpZiB5b3Ugd2FudCB0byB1cGRhdGUgaXQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciQzID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgdmFyIHRvcExldmVsVXBkYXRlV2FybmluZ3M7CiAgICAgICAgewogICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyA9IGZ1bmN0aW9uKGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciAmJiBjb250YWluZXIyLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UucGFyZW50Tm9kZSAhPT0gY29udGFpbmVyMikgewogICAgICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IEl0IGxvb2tzIGxpa2UgdGhlIFJlYWN0LXJlbmRlcmVkIGNvbnRlbnQgb2YgdGhpcyBjb250YWluZXIgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBSZWFjdC4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGNhdXNlIGVycm9ycy4gSW5zdGVhZCwgY2FsbCBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlIHRvIGVtcHR5IGEgY29udGFpbmVyLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaXNSb290UmVuZGVyZWRCeVNvbWVSZWFjdCA9ICEhY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICB2YXIgaGFzTm9uUm9vdFJlYWN0Q2hpbGQgPSAhIShyb290RWwgJiYgZ2V0SW5zdGFuY2VGcm9tTm9kZShyb290RWwpKTsKICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkICYmICFpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0KSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBSZXBsYWNpbmcgUmVhY3QtcmVuZGVyZWQgY2hpbGRyZW4gd2l0aCBhIG5ldyByb290IGNvbXBvbmVudC4gSWYgeW91IGludGVuZGVkIHRvIHVwZGF0ZSB0aGUgY2hpbGRyZW4gb2YgdGhpcyBub2RlLCB5b3Ugc2hvdWxkIGluc3RlYWQgaGF2ZSB0aGUgZXhpc3RpbmcgY2hpbGRyZW4gdXBkYXRlIHRoZWlyIHN0YXRlIGFuZCByZW5kZXIgdGhlIG5ldyBjb21wb25lbnRzIGluc3RlYWQgb2YgY2FsbGluZyBSZWFjdERPTS5yZW5kZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSAmJiBjb250YWluZXIyLnRhZ05hbWUgJiYgY29udGFpbmVyMi50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJCT0RZIikgewogICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoKTogUmVuZGVyaW5nIGNvbXBvbmVudHMgZGlyZWN0bHkgaW50byBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgcmVuZGVyaW5nIGludG8gYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmICghY29udGFpbmVyMikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBjb250YWluZXIyLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBjb250YWluZXIyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vb3BPblJlY292ZXJhYmxlRXJyb3IoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeUNyZWF0ZVJvb3RGcm9tRE9NQ29udGFpbmVyKGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaywgaXNIeWRyYXRpb25Db250YWluZXIpIHsKICAgICAgICAgIGlmIChpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICAgICAgICAgIG9yaWdpbmFsQ2FsbGJhY2suY2FsbChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVIeWRyYXRpb25Db250YWluZXIoCiAgICAgICAgICAgICAgaW5pdGlhbENoaWxkcmVuLAogICAgICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gcm9vdDM7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciByb290Q29udGFpbmVyRWxlbWVudCA9IGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IGNvbnRhaW5lcjIucGFyZW50Tm9kZSA6IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgZmx1c2hTeW5jKCk7CiAgICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByb290U2libGluZzsKICAgICAgICAgICAgd2hpbGUgKHJvb3RTaWJsaW5nID0gY29udGFpbmVyMi5sYXN0Q2hpbGQpIHsKICAgICAgICAgICAgICBjb250YWluZXIyLnJlbW92ZUNoaWxkKHJvb3RTaWJsaW5nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9vcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShfcm9vdCk7CiAgICAgICAgICAgICAgICBfb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfcm9vdCA9IGNyZWF0ZUNvbnRhaW5lcigKICAgICAgICAgICAgICBjb250YWluZXIyLAogICAgICAgICAgICAgIExlZ2FjeVJvb3QsCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBoeWRyYXRpb25DYWxsYmFja3MKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBpc1N0cmljdE1vZGUKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLAogICAgICAgICAgICAgICIiLAogICAgICAgICAgICAgIC8vIGlkZW50aWZpZXJQcmVmaXgKICAgICAgICAgICAgICBub29wT25SZWNvdmVyYWJsZUVycm9yCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9IF9yb290OwogICAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KF9yb290LmN1cnJlbnQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgICB2YXIgX3Jvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMoX3Jvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIF9yb290LCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBfcm9vdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsICYmIHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxlck5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGNoaWxkcmVuLCBjb250YWluZXIyLCBmb3JjZUh5ZHJhdGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRvcExldmVsVXBkYXRlV2FybmluZ3MoY29udGFpbmVyMik7CiAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayQxKGNhbGxiYWNrID09PSB2b2lkIDAgPyBudWxsIDogY2FsbGJhY2ssICJyZW5kZXIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZVJvb3QgPSBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICB2YXIgcm9vdDM7CiAgICAgICAgICBpZiAoIW1heWJlUm9vdCkgewogICAgICAgICAgICByb290MyA9IGxlZ2FjeUNyZWF0ZVJvb3RGcm9tRE9NQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBmb3JjZUh5ZHJhdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMgPSBtYXliZVJvb3Q7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihjaGlsZHJlbiwgcm9vdDMsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGZpbmRET01Ob2RlKGNvbXBvbmVudE9yRWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZpbmRET01Ob2RlKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZERPTU5vZGUgPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJmaW5kRE9NTm9kZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gSW5zdGVhZCwgYWRkIGEgcmVmIGRpcmVjdGx5IHRvIHRoZSBlbGVtZW50IHlvdSB3YW50IHRvIHJlZmVyZW5jZS4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtZmluZC1ub2RlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG93bmVyID0gUmVhY3RDdXJyZW50T3duZXIkMy5jdXJyZW50OwogICAgICAgICAgICBpZiAob3duZXIgIT09IG51bGwgJiYgb3duZXIuc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHdhcm5lZEFib3V0UmVmc0luUmVuZGVyID0gb3duZXIuc3RhdGVOb2RlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlcjsKICAgICAgICAgICAgICBpZiAoIXdhcm5lZEFib3V0UmVmc0luUmVuZGVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgYWNjZXNzaW5nIGZpbmRET01Ob2RlIGluc2lkZSBpdHMgcmVuZGVyKCkuIHJlbmRlcigpIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiBJdCBzaG91bGQgbmV2ZXIgYWNjZXNzIHNvbWV0aGluZyB0aGF0IHJlcXVpcmVzIHN0YWxlIGRhdGEgZnJvbSB0aGUgcHJldmlvdXMgcmVuZGVyLCBzdWNoIGFzIHJlZnMuIE1vdmUgdGhpcyBsb2dpYyB0byBjb21wb25lbnREaWRNb3VudCBhbmQgY29tcG9uZW50RGlkVXBkYXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG93bmVyLnR5cGUpIHx8ICJBIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbXBvbmVudE9yRWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbXBvbmVudE9yRWxlbWVudC5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wb25lbnRPckVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmaW5kSG9zdEluc3RhbmNlV2l0aFdhcm5pbmcoY29tcG9uZW50T3JFbGVtZW50LCAiZmluZERPTU5vZGUiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZShlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00uaHlkcmF0ZSBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGluIFJlYWN0IDE4LiBVc2UgaHlkcmF0ZVJvb3QgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgbmV3IEFQSSwgeW91ciBhcHAgd2lsbCBiZWhhdmUgYXMgaWYgaXQncyBydW5uaW5nIFJlYWN0IDE3LiBMZWFybiBtb3JlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3dpdGNoLXRvLWNyZWF0ZXJvb3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSAmJiBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMDsKICAgICAgICAgICAgaWYgKGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00uaHlkcmF0ZSgpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCBoeWRyYXRlUm9vdChjb250YWluZXIsIGVsZW1lbnQpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgZWxlbWVudCwgY29udGFpbmVyMiwgdHJ1ZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXIoZWxlbWVudCwgY29udGFpbmVyMiwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnJlbmRlciBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGluIFJlYWN0IDE4LiBVc2UgY3JlYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5yZW5kZXIoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgcm9vdC5yZW5kZXIoZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcigpIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIENvbnNpZGVyIHVzaW5nIGEgcG9ydGFsIGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIGNyZWF0ZVJvb3QgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJlbnRDb21wb25lbnQgPT0gbnVsbCB8fCAhaGFzMyhwYXJlbnRDb21wb25lbnQpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigicGFyZW50Q29tcG9uZW50IG11c3QgYmUgYSB2YWxpZCBSZWFjdCBDb21wb25lbnQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdW5tb3VudENvbXBvbmVudEF0Tm9kZShjb250YWluZXIyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUgPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBTd2l0Y2ggdG8gdGhlIGNyZWF0ZVJvb3QgQVBJLiBMZWFybiBtb3JlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3dpdGNoLXRvLWNyZWF0ZXJvb3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgcm9vdC51bm1vdW50KCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkQnlEaWZmZXJlbnRSZWFjdCA9IHJvb3RFbCAmJiAhZ2V0SW5zdGFuY2VGcm9tTm9kZShyb290RWwpOwogICAgICAgICAgICAgIGlmIChyZW5kZXJlZEJ5RGlmZmVyZW50UmVhY3QpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKCk6IFRoZSBub2RlIHlvdSdyZSBhdHRlbXB0aW5nIHRvIHVubW91bnQgd2FzIHJlbmRlcmVkIGJ5IGFub3RoZXIgY29weSBvZiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIG51bGwsIGNvbnRhaW5lcjIsIGZhbHNlLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9IG51bGw7CiAgICAgICAgICAgICAgICB1bm1hcmtDb250YWluZXJBc1Jvb3QoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgX3Jvb3RFbCA9IGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKTsKICAgICAgICAgICAgICB2YXIgaGFzTm9uUm9vdFJlYWN0Q2hpbGQgPSAhIShfcm9vdEVsICYmIGdldEluc3RhbmNlRnJvbU5vZGUoX3Jvb3RFbCkpOwogICAgICAgICAgICAgIHZhciBpc0NvbnRhaW5lclJlYWN0Um9vdCA9IGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSAmJiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIucGFyZW50Tm9kZSkgJiYgISFjb250YWluZXIyLnBhcmVudE5vZGUuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKCk6IFRoZSBub2RlIHlvdSdyZSBhdHRlbXB0aW5nIHRvIHVubW91bnQgd2FzIHJlbmRlcmVkIGJ5IFJlYWN0IGFuZCBpcyBub3QgYSB0b3AtbGV2ZWwgY29udGFpbmVyLiAlcyIsIGlzQ29udGFpbmVyUmVhY3RSb290ID8gIllvdSBtYXkgaGF2ZSBhY2NpZGVudGFsbHkgcGFzc2VkIGluIGEgUmVhY3Qgcm9vdCBub2RlIGluc3RlYWQgb2YgaXRzIGNvbnRhaW5lci4iIDogIkluc3RlYWQsIGhhdmUgdGhlIHBhcmVudCBjb21wb25lbnQgdXBkYXRlIGl0cyBzdGF0ZSBhbmQgcmVyZW5kZXIgaW4gb3JkZXIgdG8gcmVtb3ZlIHRoaXMgY29tcG9uZW50LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldEF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24kMSk7CiAgICAgICAgc2V0QXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24kMSk7CiAgICAgICAgc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKTsKICAgICAgICBzZXRHZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KTsKICAgICAgICBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShydW5XaXRoUHJpb3JpdHkpOwogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2YgTWFwICE9PSAiZnVuY3Rpb24iIHx8IC8vICRGbG93SXNzdWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgTWFwIGhhcyBubyBwcm90b3R5cGUKICAgICAgICAgIE1hcC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgTWFwLnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBTZXQgIT09ICJmdW5jdGlvbiIgfHwgLy8gJEZsb3dJc3N1ZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBTZXQgaGFzIG5vIHByb3RvdHlwZQogICAgICAgICAgU2V0LnByb3RvdHlwZSA9PSBudWxsIHx8IHR5cGVvZiBTZXQucHJvdG90eXBlLmNsZWFyICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBTZXQucHJvdG90eXBlLmZvckVhY2ggIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGRlcGVuZHMgb24gTWFwIGFuZCBTZXQgYnVpbHQtaW4gdHlwZXMuIE1ha2Ugc3VyZSB0aGF0IHlvdSBsb2FkIGEgcG9seWZpbGwgaW4gb2xkZXIgYnJvd3NlcnMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1wb2x5ZmlsbHMiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2V0UmVzdG9yZUltcGxlbWVudGF0aW9uKHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMyk7CiAgICAgICAgc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihiYXRjaGVkVXBkYXRlcyQxLCBkaXNjcmV0ZVVwZGF0ZXMsIGZsdXNoU3luYyk7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9ydGFsJDEoY2hpbGRyZW4sIGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHZhciBrZXkgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IG51bGw7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVBvcnRhbDMoY2hpbGRyZW4sIGNvbnRhaW5lcjIsIG51bGwsIGtleSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIEludGVybmFscyA9IHsKICAgICAgICAgIHVzaW5nQ2xpZW50RW50cnlQb2ludDogZmFsc2UsCiAgICAgICAgICAvLyBLZWVwIGluIHN5bmMgd2l0aCBSZWFjdFRlc3RVdGlscy5qcy4KICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgZm9yIGJldHRlciBtaW5pZmljYXRpb24uCiAgICAgICAgICBFdmVudHM6IFtnZXRJbnN0YW5jZUZyb21Ob2RlLCBnZXROb2RlRnJvbUluc3RhbmNlLCBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlLCBlbnF1ZXVlU3RhdGVSZXN0b3JlLCByZXN0b3JlU3RhdGVJZk5lZWRlZCwgYmF0Y2hlZFVwZGF0ZXMkMV0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QkMShjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIUludGVybmFscy51c2luZ0NsaWVudEVudHJ5UG9pbnQgJiYgdHJ1ZSkgewogICAgICAgICAgICAgIGVycm9yKCdZb3UgYXJlIGltcG9ydGluZyBjcmVhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QkMShjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGh5ZHJhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGh5ZHJhdGVSb290KGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMkMShmbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiZmx1c2hTeW5jIHdhcyBjYWxsZWQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiBSZWFjdCBjYW5ub3QgZmx1c2ggd2hlbiBSZWFjdCBpcyBhbHJlYWR5IHJlbmRlcmluZy4gQ29uc2lkZXIgbW92aW5nIHRoaXMgY2FsbCB0byBhIHNjaGVkdWxlciB0YXNrIG9yIG1pY3JvIHRhc2suIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbHVzaFN5bmMoZm4pOwogICAgICAgIH0KICAgICAgICB2YXIgZm91bmREZXZUb29scyA9IGluamVjdEludG9EZXZUb29scyh7CiAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUsCiAgICAgICAgICBidW5kbGVUeXBlOiAxLAogICAgICAgICAgdmVyc2lvbjogUmVhY3RWZXJzaW9uLAogICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogInJlYWN0LWRvbSIKICAgICAgICB9KTsKICAgICAgICB7CiAgICAgICAgICBpZiAoIWZvdW5kRGV2VG9vbHMgJiYgY2FuVXNlRE9NMiAmJiB3aW5kb3cudG9wID09PSB3aW5kb3cuc2VsZikgewogICAgICAgICAgICBpZiAobmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSA+IC0xICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRWRnZSIpID09PSAtMSB8fCBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSA+IC0xKSB7CiAgICAgICAgICAgICAgdmFyIHByb3RvY29sID0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sOwogICAgICAgICAgICAgIGlmICgvXihodHRwcz98ZmlsZSk6JC8udGVzdChwcm90b2NvbCkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbygiJWNEb3dubG9hZCB0aGUgUmVhY3QgRGV2VG9vbHMgZm9yIGEgYmV0dGVyIGRldmVsb3BtZW50IGV4cGVyaWVuY2U6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIgKyAocHJvdG9jb2wgPT09ICJmaWxlOiIgPyAiXG5Zb3UgbWlnaHQgbmVlZCB0byB1c2UgYSBsb2NhbCBIVFRQIHNlcnZlciAoaW5zdGVhZCBvZiBmaWxlOi8vKTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzLWZhcSIgOiAiIiksICJmb250LXdlaWdodDpib2xkIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cG9ydHMuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQgPSBJbnRlcm5hbHM7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVQb3J0YWwgPSBjcmVhdGVQb3J0YWwkMTsKICAgICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBjcmVhdGVSb290JDE7CiAgICAgICAgZXhwb3J0cy5maW5kRE9NTm9kZSA9IGZpbmRET01Ob2RlOwogICAgICAgIGV4cG9ydHMuZmx1c2hTeW5jID0gZmx1c2hTeW5jJDE7CiAgICAgICAgZXhwb3J0cy5oeWRyYXRlID0gaHlkcmF0ZTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gaHlkcmF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLnJlbmRlciA9IHJlbmRlcjsKICAgICAgICBleHBvcnRzLnVubW91bnRDb21wb25lbnRBdE5vZGUgPSB1bm1vdW50Q29tcG9uZW50QXROb2RlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfYmF0Y2hlZFVwZGF0ZXMgPSBiYXRjaGVkVXBkYXRlcyQxOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIgPSByZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcjsKICAgICAgICBleHBvcnRzLnZlcnNpb24gPSBSZWFjdFZlcnNpb247CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QtZG9tL2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0X2RvbSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QtZG9tL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBjaGVja0RDRSgpOwogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfcmVhY3RfZG9tX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2xpZW50LmpzCnZhciByZXF1aXJlX2NsaWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QtZG9tL2NsaWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIG0gPSByZXF1aXJlX3JlYWN0X2RvbSgpOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IG0uY3JlYXRlUm9vdDsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IG0uaHlkcmF0ZVJvb3Q7CiAgICB9IGVsc2UgewogICAgICBpID0gbS5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gZnVuY3Rpb24oYzIsIG8pIHsKICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtLmNyZWF0ZVJvb3QoYzIsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IGZ1bmN0aW9uKGMyLCBoLCBvKSB7CiAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gbS5oeWRyYXRlUm9vdChjMiwgaCwgbyk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgdmFyIGk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvX2ludGVybmFsL2lzVW5zYWZlUHJvcGVydHkuanMKdmFyIHJlcXVpcmVfaXNVbnNhZmVQcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L19pbnRlcm5hbC9pc1Vuc2FmZVByb3BlcnR5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzVW5zYWZlUHJvcGVydHkoa2V5KSB7CiAgICAgIHJldHVybiBrZXkgPT09ICJfX3Byb3RvX18iOwogICAgfQogICAgZXhwb3J0cy5pc1Vuc2FmZVByb3BlcnR5ID0gaXNVbnNhZmVQcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcwp2YXIgcmVxdWlyZV9pc0RlZXBLZXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc0RlZXBLZXkoa2V5KSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIGtleSkgewogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4ga2V5LmluY2x1ZGVzKCIuIikgfHwga2V5LmluY2x1ZGVzKCJbIikgfHwga2V5LmluY2x1ZGVzKCJdIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmlzRGVlcEtleSA9IGlzRGVlcEtleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RvS2V5LmpzCnZhciByZXF1aXJlX3RvS2V5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0tleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b0tleSh2YWx1ZSkgewogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdmFsdWUgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChPYmplY3QuaXModmFsdWU/LnZhbHVlT2Y/LigpLCAtMCkpIHsKICAgICAgICByZXR1cm4gIi0wIjsKICAgICAgfQogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9LZXkgPSB0b0tleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1N0cmluZy5qcwp2YXIgcmVxdWlyZV90b1N0cmluZyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvU3RyaW5nLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHJldHVybiB2YWx1ZS5tYXAodG9TdHJpbmcpLmpvaW4oIiwiKTsKICAgICAgfQogICAgICBjb25zdCByZXN1bHQgPSBTdHJpbmcodmFsdWUpOwogICAgICBpZiAocmVzdWx0ID09PSAiMCIgJiYgT2JqZWN0LmlzKE51bWJlcih2YWx1ZSksIC0wKSkgewogICAgICAgIHJldHVybiAiLTAiOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnRvU3RyaW5nID0gdG9TdHJpbmc7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9QYXRoLmpzCnZhciByZXF1aXJlX3RvUGF0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvUGF0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgdG9TdHJpbmcgPSByZXF1aXJlX3RvU3RyaW5nKCk7CiAgICB2YXIgdG9LZXkgPSByZXF1aXJlX3RvS2V5KCk7CiAgICBmdW5jdGlvbiB0b1BhdGgoZGVlcEtleSkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShkZWVwS2V5KSkgewogICAgICAgIHJldHVybiBkZWVwS2V5Lm1hcCh0b0tleS50b0tleSk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkZWVwS2V5ID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiBbZGVlcEtleV07CiAgICAgIH0KICAgICAgZGVlcEtleSA9IHRvU3RyaW5nLnRvU3RyaW5nKGRlZXBLZXkpOwogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgbGVuZ3RoID0gZGVlcEtleS5sZW5ndGg7CiAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGxldCBrZXkgPSAiIjsKICAgICAgbGV0IHF1b3RlQ2hhciA9ICIiOwogICAgICBsZXQgYnJhY2tldCA9IGZhbHNlOwogICAgICBpZiAoZGVlcEtleS5jaGFyQ29kZUF0KDApID09PSA0NikgewogICAgICAgIHJlc3VsdC5wdXNoKCIiKTsKICAgICAgICBpbmRleCsrOwogICAgICB9CiAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGNvbnN0IGNoYXIgPSBkZWVwS2V5W2luZGV4XTsKICAgICAgICBpZiAocXVvdGVDaGFyKSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gIlxcIiAmJiBpbmRleCArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAga2V5ICs9IGRlZXBLZXlbaW5kZXhdOwogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSBxdW90ZUNoYXIpIHsKICAgICAgICAgICAgcXVvdGVDaGFyID0gIiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXkgKz0gY2hhcjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGJyYWNrZXQpIHsKICAgICAgICAgIGlmIChjaGFyID09PSAnIicgfHwgY2hhciA9PT0gIiciKSB7CiAgICAgICAgICAgIHF1b3RlQ2hhciA9IGNoYXI7CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICJdIikgewogICAgICAgICAgICBicmFja2V0ID0gZmFsc2U7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjaGFyID09PSAiWyIpIHsKICAgICAgICAgICAgYnJhY2tldCA9IHRydWU7CiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICIuIikgewogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4Kys7CiAgICAgIH0KICAgICAgaWYgKGtleSkgewogICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMudG9QYXRoID0gdG9QYXRoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvZ2V0LmpzCnZhciByZXF1aXJlX2dldCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvZ2V0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1Vuc2FmZVByb3BlcnR5ID0gcmVxdWlyZV9pc1Vuc2FmZVByb3BlcnR5KCk7CiAgICB2YXIgaXNEZWVwS2V5ID0gcmVxdWlyZV9pc0RlZXBLZXkoKTsKICAgIHZhciB0b0tleSA9IHJlcXVpcmVfdG9LZXkoKTsKICAgIHZhciB0b1BhdGggPSByZXF1aXJlX3RvUGF0aCgpOwogICAgZnVuY3Rpb24gZ2V0NyhvYmplY3QsIHBhdGgyLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKG9iamVjdCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiBwYXRoMikgewogICAgICAgIGNhc2UgInN0cmluZyI6IHsKICAgICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChpc0RlZXBLZXkuaXNEZWVwS2V5KHBhdGgyKSkgewogICAgICAgICAgICAgIHJldHVybiBnZXQ3KG9iamVjdCwgdG9QYXRoLnRvUGF0aChwYXRoMiksIGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICBjYXNlICJzeW1ib2wiOiB7CiAgICAgICAgICBpZiAodHlwZW9mIHBhdGgyID09PSAibnVtYmVyIikgewogICAgICAgICAgICBwYXRoMiA9IHRvS2V5LnRvS2V5KHBhdGgyKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG9iamVjdFtwYXRoMl07CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGgyKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0V2l0aFBhdGgob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChPYmplY3QuaXMocGF0aDI/LnZhbHVlT2YoKSwgLTApKSB7CiAgICAgICAgICAgIHBhdGgyID0gIi0wIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhdGgyID0gU3RyaW5nKHBhdGgyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0V2l0aFBhdGgob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmIChwYXRoMi5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICAgIGxldCBjdXJyZW50MyA9IG9iamVjdDsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHBhdGgyLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIGlmIChjdXJyZW50MyA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoaXNVbnNhZmVQcm9wZXJ0eS5pc1Vuc2FmZVByb3BlcnR5KHBhdGgyW2luZGV4XSkpIHsKICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQzID0gY3VycmVudDNbcGF0aDJbaW5kZXhdXTsKICAgICAgfQogICAgICBpZiAoY3VycmVudDMgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGN1cnJlbnQzOwogICAgfQogICAgZXhwb3J0cy5nZXQgPSBnZXQ3OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvZ2V0LmpzCnZhciByZXF1aXJlX2dldDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2dldC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfZ2V0KCkuZ2V0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L3VuaXFCeS5qcwp2YXIgcmVxdWlyZV91bmlxQnkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS91bmlxQnkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdW5pcUJ5MihhcnIsIG1hcHBlcikgewogICAgICBjb25zdCBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpdGVtID0gYXJyW2ldOwogICAgICAgIGNvbnN0IGtleSA9IG1hcHBlcihpdGVtKTsKICAgICAgICBpZiAoIW1hcDMuaGFzKGtleSkpIHsKICAgICAgICAgIG1hcDMuc2V0KGtleSwgaXRlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKG1hcDMudmFsdWVzKCkpOwogICAgfQogICAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnkyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2Z1bmN0aW9uL2lkZW50aXR5LmpzCnZhciByZXF1aXJlX2lkZW50aXR5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vaWRlbnRpdHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaWRlbnRpdHk0KHgyKSB7CiAgICAgIHJldHVybiB4MjsKICAgIH0KICAgIGV4cG9ydHMuaWRlbnRpdHkgPSBpZGVudGl0eTQ7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzTGVuZ3RoLmpzCnZhciByZXF1aXJlX2lzTGVuZ3RoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzTGVuZ3RoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzTGVuZ3RoKHZhbHVlKSB7CiAgICAgIHJldHVybiBOdW1iZXIuaXNTYWZlSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gMDsKICAgIH0KICAgIGV4cG9ydHMuaXNMZW5ndGggPSBpc0xlbmd0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlLmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNMZW5ndGggPSByZXF1aXJlX2lzTGVuZ3RoKCk7CiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIgJiYgaXNMZW5ndGguaXNMZW5ndGgodmFsdWUubGVuZ3RoKTsKICAgIH0KICAgIGV4cG9ydHMuaXNBcnJheUxpa2UgPSBpc0FycmF5TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0TGlrZS5qcwp2YXIgcmVxdWlyZV9pc09iamVjdExpa2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc09iamVjdExpa2UodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGw7CiAgICB9CiAgICBleHBvcnRzLmlzT2JqZWN0TGlrZSA9IGlzT2JqZWN0TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlT2JqZWN0LmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlT2JqZWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZU9iamVjdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNBcnJheUxpa2UgPSByZXF1aXJlX2lzQXJyYXlMaWtlKCk7CiAgICB2YXIgaXNPYmplY3RMaWtlID0gcmVxdWlyZV9pc09iamVjdExpa2UoKTsKICAgIGZ1bmN0aW9uIGlzQXJyYXlMaWtlT2JqZWN0KHZhbHVlKSB7CiAgICAgIHJldHVybiBpc09iamVjdExpa2UuaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBpc0FycmF5TGlrZS5pc0FycmF5TGlrZSh2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlMaWtlT2JqZWN0ID0gaXNBcnJheUxpa2VPYmplY3Q7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9wcm9wZXJ0eS5qcwp2YXIgcmVxdWlyZV9wcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvcHJvcGVydHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldDcgPSByZXF1aXJlX2dldCgpOwogICAgZnVuY3Rpb24gcHJvcGVydHkocGF0aDIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiBnZXQ3LmdldChvYmplY3QsIHBhdGgyKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMucHJvcGVydHkgPSBwcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0LmpzCnZhciByZXF1aXJlX2lzT2JqZWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKICAgIH0KICAgIGV4cG9ydHMuaXNPYmplY3QgPSBpc09iamVjdDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNQcmltaXRpdmUuanMKdmFyIHJlcXVpcmVfaXNQcmltaXRpdmUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNQcmltaXRpdmUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNQcmltaXRpdmUodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiI7CiAgICB9CiAgICBleHBvcnRzLmlzUHJpbWl0aXZlID0gaXNQcmltaXRpdmU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvZXEuanMKdmFyIHJlcXVpcmVfZXEgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9lcS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBlcSh2YWx1ZSwgb3RoZXIpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBvdGhlciB8fCBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihvdGhlcik7CiAgICB9CiAgICBleHBvcnRzLmVxID0gZXE7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc01hdGNoV2l0aC5qcwp2YXIgcmVxdWlyZV9pc01hdGNoV2l0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaFdpdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzT2JqZWN0ID0gcmVxdWlyZV9pc09iamVjdCgpOwogICAgdmFyIGlzUHJpbWl0aXZlID0gcmVxdWlyZV9pc1ByaW1pdGl2ZSgpOwogICAgdmFyIGVxID0gcmVxdWlyZV9lcSgpOwogICAgZnVuY3Rpb24gaXNNYXRjaFdpdGgodGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUpIHsKICAgICAgaWYgKHR5cGVvZiBjb21wYXJlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoKHRhcmdldCwgc291cmNlLCAoKSA9PiB2b2lkIDApOwogICAgICB9CiAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKHRhcmdldCwgc291cmNlLCBmdW5jdGlvbiBkb2VzTWF0Y2gob2JqVmFsdWUsIHNyY1ZhbHVlLCBrZXksIG9iamVjdCwgc291cmNlMiwgc3RhY2spIHsKICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZShvYmpWYWx1ZSwgc3JjVmFsdWUsIGtleSwgb2JqZWN0LCBzb3VyY2UyLCBzdGFjayk7CiAgICAgICAgaWYgKGlzRXF1YWwgIT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIEJvb2xlYW4oaXNFcXVhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKG9ialZhbHVlLCBzcmNWYWx1ZSwgZG9lc01hdGNoLCBzdGFjayk7CiAgICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogICAgfQogICAgZnVuY3Rpb24gaXNNYXRjaFdpdGhJbnRlcm5hbCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZSA9PT0gdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2Ygc291cmNlKSB7CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgcmV0dXJuIGlzT2JqZWN0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgICAgICBjb25zdCBzb3VyY2VLZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgICAgIGlmIChzb3VyY2VLZXlzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoSW50ZXJuYWwodGFyZ2V0LCB7IC4uLnNvdXJjZSB9LCBjb21wYXJlLCBzdGFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXEuZXEodGFyZ2V0LCBzb3VyY2UpOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICBpZiAoIWlzT2JqZWN0LmlzT2JqZWN0KHRhcmdldCkpIHsKICAgICAgICAgICAgcmV0dXJuIGVxLmVxKHRhcmdldCwgc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gc291cmNlID09PSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNPYmplY3RNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc291cmNlKSkgewogICAgICAgIHJldHVybiBpc0FycmF5TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgTWFwKSB7CiAgICAgICAgcmV0dXJuIGlzTWFwTWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgU2V0KSB7CiAgICAgICAgcmV0dXJuIGlzU2V0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgaWYgKHRhcmdldCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGtleXMubGVuZ3RoID09PSAwOwogICAgICB9CiAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChzdGFjaz8uaGFzKHNvdXJjZSkpIHsKICAgICAgICByZXR1cm4gc3RhY2suZ2V0KHNvdXJjZSkgPT09IHRhcmdldDsKICAgICAgfQogICAgICBzdGFjaz8uc2V0KHNvdXJjZSwgdGFyZ2V0KTsKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgICBpZiAoIWlzUHJpbWl0aXZlLmlzUHJpbWl0aXZlKHRhcmdldCkgJiYgIShrZXkgaW4gdGFyZ2V0KSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlW2tleV0gPT09IHZvaWQgMCAmJiB0YXJnZXRba2V5XSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzb3VyY2Vba2V5XSA9PT0gbnVsbCAmJiB0YXJnZXRba2V5XSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRba2V5XSwgc291cmNlW2tleV0sIGtleSwgdGFyZ2V0LCBzb3VyY2UsIHN0YWNrKTsKICAgICAgICAgIGlmICghaXNFcXVhbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHN0YWNrPy5kZWxldGUoc291cmNlKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNNYXBNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZS5zaXplID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKCEodGFyZ2V0IGluc3RhbmNlb2YgTWFwKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IFtrZXksIHNvdXJjZVZhbHVlXSBvZiBzb3VyY2UuZW50cmllcygpKSB7CiAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSB0YXJnZXQuZ2V0KGtleSk7CiAgICAgICAgY29uc3QgaXNFcXVhbCA9IGNvbXBhcmUodGFyZ2V0VmFsdWUsIHNvdXJjZVZhbHVlLCBrZXksIHRhcmdldCwgc291cmNlLCBzdGFjayk7CiAgICAgICAgaWYgKGlzRXF1YWwgPT09IGZhbHNlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZnVuY3Rpb24gaXNBcnJheU1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0YXJnZXQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGNvbnN0IGNvdW50ZWRJbmRleCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qgc291cmNlSXRlbSA9IHNvdXJjZVtpXTsKICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRhcmdldC5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKGNvdW50ZWRJbmRleC5oYXMoaikpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGFyZ2V0W2pdOwogICAgICAgICAgbGV0IG1hdGNoZXMyID0gZmFsc2U7CiAgICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRJdGVtLCBzb3VyY2VJdGVtLCBpLCB0YXJnZXQsIHNvdXJjZSwgc3RhY2spOwogICAgICAgICAgaWYgKGlzRXF1YWwpIHsKICAgICAgICAgICAgbWF0Y2hlczIgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1hdGNoZXMyKSB7CiAgICAgICAgICAgIGNvdW50ZWRJbmRleC5hZGQoaik7CiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBpc1NldE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLnNpemUgPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoISh0YXJnZXQgaW5zdGFuY2VvZiBTZXQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBpc0FycmF5TWF0Y2goWy4uLnRhcmdldF0sIFsuLi5zb3VyY2VdLCBjb21wYXJlLCBzdGFjayk7CiAgICB9CiAgICBleHBvcnRzLmlzTWF0Y2hXaXRoID0gaXNNYXRjaFdpdGg7CiAgICBleHBvcnRzLmlzU2V0TWF0Y2ggPSBpc1NldE1hdGNoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaC5qcwp2YXIgcmVxdWlyZV9pc01hdGNoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc01hdGNoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc01hdGNoV2l0aCA9IHJlcXVpcmVfaXNNYXRjaFdpdGgoKTsKICAgIGZ1bmN0aW9uIGlzTWF0Y2godGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoLmlzTWF0Y2hXaXRoKHRhcmdldCwgc291cmNlLCAoKSA9PiB2b2lkIDApOwogICAgfQogICAgZXhwb3J0cy5pc01hdGNoID0gaXNNYXRjaDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFN5bWJvbHMuanMKdmFyIHJlcXVpcmVfZ2V0U3ltYm9scyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0U3ltYm9scy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRTeW1ib2xzKG9iamVjdCkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmplY3QpLmZpbHRlcigoc3ltYm9sKSA9PiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqZWN0LCBzeW1ib2wpKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0U3ltYm9scyA9IGdldFN5bWJvbHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9nZXRUYWcuanMKdmFyIHJlcXVpcmVfZ2V0VGFnID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9nZXRUYWcuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZ2V0VGFnKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB2b2lkIDAgPyAiW29iamVjdCBVbmRlZmluZWRdIiA6ICJbb2JqZWN0IE51bGxdIjsKICAgICAgfQogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0VGFnID0gZ2V0VGFnOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdGFncy5qcwp2YXIgcmVxdWlyZV90YWdzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90YWdzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciByZWdleHBUYWcgPSAiW29iamVjdCBSZWdFeHBdIjsKICAgIHZhciBzdHJpbmdUYWcgPSAiW29iamVjdCBTdHJpbmddIjsKICAgIHZhciBudW1iZXJUYWcgPSAiW29iamVjdCBOdW1iZXJdIjsKICAgIHZhciBib29sZWFuVGFnID0gIltvYmplY3QgQm9vbGVhbl0iOwogICAgdmFyIGFyZ3VtZW50c1RhZyA9ICJbb2JqZWN0IEFyZ3VtZW50c10iOwogICAgdmFyIHN5bWJvbFRhZyA9ICJbb2JqZWN0IFN5bWJvbF0iOwogICAgdmFyIGRhdGVUYWcgPSAiW29iamVjdCBEYXRlXSI7CiAgICB2YXIgbWFwVGFnID0gIltvYmplY3QgTWFwXSI7CiAgICB2YXIgc2V0VGFnID0gIltvYmplY3QgU2V0XSI7CiAgICB2YXIgYXJyYXlUYWcgPSAiW29iamVjdCBBcnJheV0iOwogICAgdmFyIGZ1bmN0aW9uVGFnID0gIltvYmplY3QgRnVuY3Rpb25dIjsKICAgIHZhciBhcnJheUJ1ZmZlclRhZyA9ICJbb2JqZWN0IEFycmF5QnVmZmVyXSI7CiAgICB2YXIgb2JqZWN0VGFnID0gIltvYmplY3QgT2JqZWN0XSI7CiAgICB2YXIgZXJyb3JUYWcgPSAiW29iamVjdCBFcnJvcl0iOwogICAgdmFyIGRhdGFWaWV3VGFnID0gIltvYmplY3QgRGF0YVZpZXddIjsKICAgIHZhciB1aW50OEFycmF5VGFnID0gIltvYmplY3QgVWludDhBcnJheV0iOwogICAgdmFyIHVpbnQ4Q2xhbXBlZEFycmF5VGFnID0gIltvYmplY3QgVWludDhDbGFtcGVkQXJyYXldIjsKICAgIHZhciB1aW50MTZBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQxNkFycmF5XSI7CiAgICB2YXIgdWludDMyQXJyYXlUYWcgPSAiW29iamVjdCBVaW50MzJBcnJheV0iOwogICAgdmFyIGJpZ1VpbnQ2NEFycmF5VGFnID0gIltvYmplY3QgQmlnVWludDY0QXJyYXldIjsKICAgIHZhciBpbnQ4QXJyYXlUYWcgPSAiW29iamVjdCBJbnQ4QXJyYXldIjsKICAgIHZhciBpbnQxNkFycmF5VGFnID0gIltvYmplY3QgSW50MTZBcnJheV0iOwogICAgdmFyIGludDMyQXJyYXlUYWcgPSAiW29iamVjdCBJbnQzMkFycmF5XSI7CiAgICB2YXIgYmlnSW50NjRBcnJheVRhZyA9ICJbb2JqZWN0IEJpZ0ludDY0QXJyYXldIjsKICAgIHZhciBmbG9hdDMyQXJyYXlUYWcgPSAiW29iamVjdCBGbG9hdDMyQXJyYXldIjsKICAgIHZhciBmbG9hdDY0QXJyYXlUYWcgPSAiW29iamVjdCBGbG9hdDY0QXJyYXldIjsKICAgIGV4cG9ydHMuYXJndW1lbnRzVGFnID0gYXJndW1lbnRzVGFnOwogICAgZXhwb3J0cy5hcnJheUJ1ZmZlclRhZyA9IGFycmF5QnVmZmVyVGFnOwogICAgZXhwb3J0cy5hcnJheVRhZyA9IGFycmF5VGFnOwogICAgZXhwb3J0cy5iaWdJbnQ2NEFycmF5VGFnID0gYmlnSW50NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuYmlnVWludDY0QXJyYXlUYWcgPSBiaWdVaW50NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuYm9vbGVhblRhZyA9IGJvb2xlYW5UYWc7CiAgICBleHBvcnRzLmRhdGFWaWV3VGFnID0gZGF0YVZpZXdUYWc7CiAgICBleHBvcnRzLmRhdGVUYWcgPSBkYXRlVGFnOwogICAgZXhwb3J0cy5lcnJvclRhZyA9IGVycm9yVGFnOwogICAgZXhwb3J0cy5mbG9hdDMyQXJyYXlUYWcgPSBmbG9hdDMyQXJyYXlUYWc7CiAgICBleHBvcnRzLmZsb2F0NjRBcnJheVRhZyA9IGZsb2F0NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuZnVuY3Rpb25UYWcgPSBmdW5jdGlvblRhZzsKICAgIGV4cG9ydHMuaW50MTZBcnJheVRhZyA9IGludDE2QXJyYXlUYWc7CiAgICBleHBvcnRzLmludDMyQXJyYXlUYWcgPSBpbnQzMkFycmF5VGFnOwogICAgZXhwb3J0cy5pbnQ4QXJyYXlUYWcgPSBpbnQ4QXJyYXlUYWc7CiAgICBleHBvcnRzLm1hcFRhZyA9IG1hcFRhZzsKICAgIGV4cG9ydHMubnVtYmVyVGFnID0gbnVtYmVyVGFnOwogICAgZXhwb3J0cy5vYmplY3RUYWcgPSBvYmplY3RUYWc7CiAgICBleHBvcnRzLnJlZ2V4cFRhZyA9IHJlZ2V4cFRhZzsKICAgIGV4cG9ydHMuc2V0VGFnID0gc2V0VGFnOwogICAgZXhwb3J0cy5zdHJpbmdUYWcgPSBzdHJpbmdUYWc7CiAgICBleHBvcnRzLnN5bWJvbFRhZyA9IHN5bWJvbFRhZzsKICAgIGV4cG9ydHMudWludDE2QXJyYXlUYWcgPSB1aW50MTZBcnJheVRhZzsKICAgIGV4cG9ydHMudWludDMyQXJyYXlUYWcgPSB1aW50MzJBcnJheVRhZzsKICAgIGV4cG9ydHMudWludDhBcnJheVRhZyA9IHVpbnQ4QXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQ4Q2xhbXBlZEFycmF5VGFnID0gdWludDhDbGFtcGVkQXJyYXlUYWc7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzVHlwZWRBcnJheS5qcwp2YXIgcmVxdWlyZV9pc1R5cGVkQXJyYXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNUeXBlZEFycmF5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzVHlwZWRBcnJheSh4MikgewogICAgICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwogICAgfQogICAgZXhwb3J0cy5pc1R5cGVkQXJyYXkgPSBpc1R5cGVkQXJyYXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3Qvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwV2l0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBnZXRTeW1ib2xzID0gcmVxdWlyZV9nZXRTeW1ib2xzKCk7CiAgICB2YXIgZ2V0VGFnID0gcmVxdWlyZV9nZXRUYWcoKTsKICAgIHZhciB0YWdzID0gcmVxdWlyZV90YWdzKCk7CiAgICB2YXIgaXNQcmltaXRpdmUgPSByZXF1aXJlX2lzUHJpbWl0aXZlKCk7CiAgICB2YXIgaXNUeXBlZEFycmF5ID0gcmVxdWlyZV9pc1R5cGVkQXJyYXkoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGgob2JqLCBjbG9uZVZhbHVlKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoSW1wbChvYmosIHZvaWQgMCwgb2JqLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBjbG9uZVZhbHVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlVG9DbG9uZSwga2V5VG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2sgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBjbG9uZVZhbHVlID0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGNsb25lZCA9IGNsb25lVmFsdWU/Lih2YWx1ZVRvQ2xvbmUsIGtleVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrKTsKICAgICAgaWYgKGNsb25lZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIGNsb25lZDsKICAgICAgfQogICAgICBpZiAoaXNQcmltaXRpdmUuaXNQcmltaXRpdmUodmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmU7CiAgICAgIH0KICAgICAgaWYgKHN0YWNrLmhhcyh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgcmV0dXJuIHN0YWNrLmdldCh2YWx1ZVRvQ2xvbmUpOwogICAgICB9CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkodmFsdWVUb0Nsb25lLmxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlVG9DbG9uZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lW2ldLCBpLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGlmIChPYmplY3QuaGFzT3duKHZhbHVlVG9DbG9uZSwgImluZGV4IikpIHsKICAgICAgICAgIHJlc3VsdC5pbmRleCA9IHZhbHVlVG9DbG9uZS5pbmRleDsKICAgICAgICB9CiAgICAgICAgaWYgKE9iamVjdC5oYXNPd24odmFsdWVUb0Nsb25lLCAiaW5wdXQiKSkgewogICAgICAgICAgcmVzdWx0LmlucHV0ID0gdmFsdWVUb0Nsb25lLmlucHV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlVG9DbG9uZS5nZXRUaW1lKCkpOwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgUmVnRXhwKHZhbHVlVG9DbG9uZS5zb3VyY2UsIHZhbHVlVG9DbG9uZS5mbGFncyk7CiAgICAgICAgcmVzdWx0Lmxhc3RJbmRleCA9IHZhbHVlVG9DbG9uZS5sYXN0SW5kZXg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgTWFwKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHZhbHVlVG9DbG9uZSkgewogICAgICAgICAgcmVzdWx0LnNldChrZXksIGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlLCBrZXksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIFNldCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlVG9DbG9uZSkgewogICAgICAgICAgcmVzdWx0LmFkZChjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZSwgdm9pZCAwLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgQnVmZmVyICE9PSAidW5kZWZpbmVkIiAmJiBCdWZmZXIuaXNCdWZmZXIodmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmUuc3ViYXJyYXkoKTsKICAgICAgfQogICAgICBpZiAoaXNUeXBlZEFycmF5LmlzVHlwZWRBcnJheSh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IChPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWVUb0Nsb25lKSkuY29uc3RydWN0b3IodmFsdWVUb0Nsb25lLmxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlVG9DbG9uZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lW2ldLCBpLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8IHR5cGVvZiBTaGFyZWRBcnJheUJ1ZmZlciAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU2hhcmVkQXJyYXlCdWZmZXIpIHsKICAgICAgICByZXR1cm4gdmFsdWVUb0Nsb25lLnNsaWNlKDApOwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBEYXRhVmlldykgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBEYXRhVmlldyh2YWx1ZVRvQ2xvbmUuYnVmZmVyLnNsaWNlKDApLCB2YWx1ZVRvQ2xvbmUuYnl0ZU9mZnNldCwgdmFsdWVUb0Nsb25lLmJ5dGVMZW5ndGgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgRmlsZSAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRmlsZSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBGaWxlKFt2YWx1ZVRvQ2xvbmVdLCB2YWx1ZVRvQ2xvbmUubmFtZSwgewogICAgICAgICAgdHlwZTogdmFsdWVUb0Nsb25lLnR5cGUKICAgICAgICB9KTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIEJsb2IgIT09ICJ1bmRlZmluZWQiICYmIHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEJsb2IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQmxvYihbdmFsdWVUb0Nsb25lXSwgeyB0eXBlOiB2YWx1ZVRvQ2xvbmUudHlwZSB9KTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgdmFsdWVUb0Nsb25lLmNvbnN0cnVjdG9yKCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICByZXN1bHQubWVzc2FnZSA9IHZhbHVlVG9DbG9uZS5tZXNzYWdlOwogICAgICAgIHJlc3VsdC5uYW1lID0gdmFsdWVUb0Nsb25lLm5hbWU7CiAgICAgICAgcmVzdWx0LnN0YWNrID0gdmFsdWVUb0Nsb25lLnN0YWNrOwogICAgICAgIHJlc3VsdC5jYXVzZSA9IHZhbHVlVG9DbG9uZS5jYXVzZTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEJvb2xlYW4pIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQm9vbGVhbih2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgTnVtYmVyKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IE51bWJlcih2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU3RyaW5nKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFN0cmluZyh2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlVG9DbG9uZSA9PT0gIm9iamVjdCIgJiYgaXNDbG9uZWFibGVPYmplY3QodmFsdWVUb0Nsb25lKSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbHVlVG9DbG9uZSkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmU7CiAgICB9CiAgICBmdW5jdGlvbiBjb3B5UHJvcGVydGllcyh0YXJnZXQsIHNvdXJjZSwgb2JqZWN0VG9DbG9uZSA9IHRhcmdldCwgc3RhY2ssIGNsb25lVmFsdWUpIHsKICAgICAgY29uc3Qga2V5cyA9IFsuLi5PYmplY3Qua2V5cyhzb3VyY2UpLCAuLi5nZXRTeW1ib2xzLmdldFN5bWJvbHMoc291cmNlKV07CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpOwogICAgICAgIGlmIChkZXNjcmlwdG9yID09IG51bGwgfHwgZGVzY3JpcHRvci53cml0YWJsZSkgewogICAgICAgICAgdGFyZ2V0W2tleV0gPSBjbG9uZURlZXBXaXRoSW1wbChzb3VyY2Vba2V5XSwga2V5LCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc0Nsb25lYWJsZU9iamVjdChvYmplY3QpIHsKICAgICAgc3dpdGNoIChnZXRUYWcuZ2V0VGFnKG9iamVjdCkpIHsKICAgICAgICBjYXNlIHRhZ3MuYXJndW1lbnRzVGFnOgogICAgICAgIGNhc2UgdGFncy5hcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuYXJyYXlCdWZmZXJUYWc6CiAgICAgICAgY2FzZSB0YWdzLmRhdGFWaWV3VGFnOgogICAgICAgIGNhc2UgdGFncy5ib29sZWFuVGFnOgogICAgICAgIGNhc2UgdGFncy5kYXRlVGFnOgogICAgICAgIGNhc2UgdGFncy5mbG9hdDMyQXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmZsb2F0NjRBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuaW50OEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQxNkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQzMkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5tYXBUYWc6CiAgICAgICAgY2FzZSB0YWdzLm51bWJlclRhZzoKICAgICAgICBjYXNlIHRhZ3Mub2JqZWN0VGFnOgogICAgICAgIGNhc2UgdGFncy5yZWdleHBUYWc6CiAgICAgICAgY2FzZSB0YWdzLnNldFRhZzoKICAgICAgICBjYXNlIHRhZ3Muc3RyaW5nVGFnOgogICAgICAgIGNhc2UgdGFncy5zeW1ib2xUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQ4QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQ4Q2xhbXBlZEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy51aW50MTZBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDMyQXJyYXlUYWc6IHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcFdpdGggPSBjbG9uZURlZXBXaXRoOwogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoSW1wbCA9IGNsb25lRGVlcFdpdGhJbXBsOwogICAgZXhwb3J0cy5jb3B5UHJvcGVydGllcyA9IGNvcHlQcm9wZXJ0aWVzOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXAuanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3Qvb2JqZWN0L2Nsb25lRGVlcC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY2xvbmVEZWVwV2l0aCA9IHJlcXVpcmVfY2xvbmVEZWVwV2l0aCgpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwKG9iaikgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aC5jbG9uZURlZXBXaXRoSW1wbChvYmosIHZvaWQgMCwgb2JqLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCB2b2lkIDApOwogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXAgPSBjbG9uZURlZXA7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzLmpzCnZhciByZXF1aXJlX21hdGNoZXMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTWF0Y2ggPSByZXF1aXJlX2lzTWF0Y2goKTsKICAgIHZhciBjbG9uZURlZXAgPSByZXF1aXJlX2Nsb25lRGVlcCgpOwogICAgZnVuY3Rpb24gbWF0Y2hlczIoc291cmNlKSB7CiAgICAgIHNvdXJjZSA9IGNsb25lRGVlcC5jbG9uZURlZXAoc291cmNlKTsKICAgICAgcmV0dXJuICh0YXJnZXQpID0+IHsKICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHRhcmdldCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlcyA9IG1hdGNoZXMyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXBXaXRoMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY2xvbmVEZWVwV2l0aCQxID0gcmVxdWlyZV9jbG9uZURlZXBXaXRoKCk7CiAgICB2YXIgdGFncyA9IHJlcXVpcmVfdGFncygpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwV2l0aChvYmosIGN1c3RvbWl6ZXIpIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGgkMS5jbG9uZURlZXBXaXRoKG9iaiwgKHZhbHVlLCBrZXksIG9iamVjdCwgc3RhY2spID0+IHsKICAgICAgICBjb25zdCBjbG9uZWQgPSBjdXN0b21pemVyPy4odmFsdWUsIGtleSwgb2JqZWN0LCBzdGFjayk7CiAgICAgICAgaWYgKGNsb25lZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gY2xvbmVkOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpIHsKICAgICAgICAgIGNhc2UgdGFncy5udW1iZXJUYWc6CiAgICAgICAgICBjYXNlIHRhZ3Muc3RyaW5nVGFnOgogICAgICAgICAgY2FzZSB0YWdzLmJvb2xlYW5UYWc6IHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IG9iai5jb25zdHJ1Y3RvcihvYmo/LnZhbHVlT2YoKSk7CiAgICAgICAgICAgIGNsb25lRGVlcFdpdGgkMS5jb3B5UHJvcGVydGllcyhyZXN1bHQsIG9iaik7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIHRhZ3MuYXJndW1lbnRzVGFnOiB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgICAgICAgICBjbG9uZURlZXBXaXRoJDEuY29weVByb3BlcnRpZXMocmVzdWx0LCBvYmopOwogICAgICAgICAgICByZXN1bHQubGVuZ3RoID0gb2JqLmxlbmd0aDsKICAgICAgICAgICAgcmVzdWx0W1N5bWJvbC5pdGVyYXRvcl0gPSBvYmpbU3ltYm9sLml0ZXJhdG9yXTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoID0gY2xvbmVEZWVwV2l0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXAyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9jbG9uZURlZXAuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGNsb25lRGVlcFdpdGggPSByZXF1aXJlX2Nsb25lRGVlcFdpdGgyKCk7CiAgICBmdW5jdGlvbiBjbG9uZURlZXAob2JqKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoLmNsb25lRGVlcFdpdGgob2JqKTsKICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwID0gY2xvbmVEZWVwOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJbmRleC5qcwp2YXIgcmVxdWlyZV9pc0luZGV4ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0luZGV4LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBJU19VTlNJR05FRF9JTlRFR0VSID0gL14oPzowfFsxLTldXGQqKSQvOwogICAgZnVuY3Rpb24gaXNJbmRleCh2YWx1ZSwgbGVuZ3RoID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJudW1iZXIiOiB7CiAgICAgICAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gMCAmJiB2YWx1ZSA8IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4gSVNfVU5TSUdORURfSU5URUdFUi50ZXN0KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXNJbmRleCA9IGlzSW5kZXg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FyZ3VtZW50cy5qcwp2YXIgcmVxdWlyZV9pc0FyZ3VtZW50cyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcmd1bWVudHMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldFRhZyA9IHJlcXVpcmVfZ2V0VGFnKCk7CiAgICBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiBnZXRUYWcuZ2V0VGFnKHZhbHVlKSA9PT0gIltvYmplY3QgQXJndW1lbnRzXSI7CiAgICB9CiAgICBleHBvcnRzLmlzQXJndW1lbnRzID0gaXNBcmd1bWVudHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9oYXMuanMKdmFyIHJlcXVpcmVfaGFzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9oYXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzRGVlcEtleSA9IHJlcXVpcmVfaXNEZWVwS2V5KCk7CiAgICB2YXIgaXNJbmRleCA9IHJlcXVpcmVfaXNJbmRleCgpOwogICAgdmFyIGlzQXJndW1lbnRzID0gcmVxdWlyZV9pc0FyZ3VtZW50cygpOwogICAgdmFyIHRvUGF0aCA9IHJlcXVpcmVfdG9QYXRoKCk7CiAgICBmdW5jdGlvbiBoYXMzKG9iamVjdCwgcGF0aDIpIHsKICAgICAgbGV0IHJlc29sdmVkUGF0aDsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGF0aDIpKSB7CiAgICAgICAgcmVzb2x2ZWRQYXRoID0gcGF0aDI7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhdGgyID09PSAic3RyaW5nIiAmJiBpc0RlZXBLZXkuaXNEZWVwS2V5KHBhdGgyKSAmJiBvYmplY3Q/LltwYXRoMl0gPT0gbnVsbCkgewogICAgICAgIHJlc29sdmVkUGF0aCA9IHRvUGF0aC50b1BhdGgocGF0aDIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc29sdmVkUGF0aCA9IFtwYXRoMl07CiAgICAgIH0KICAgICAgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbGV0IGN1cnJlbnQzID0gb2JqZWN0OwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc29sdmVkUGF0aC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IHJlc29sdmVkUGF0aFtpXTsKICAgICAgICBpZiAoY3VycmVudDMgPT0gbnVsbCB8fCAhT2JqZWN0Lmhhc093bihjdXJyZW50Mywga2V5KSkgewogICAgICAgICAgY29uc3QgaXNTcGFyc2VJbmRleCA9IChBcnJheS5pc0FycmF5KGN1cnJlbnQzKSB8fCBpc0FyZ3VtZW50cy5pc0FyZ3VtZW50cyhjdXJyZW50MykpICYmIGlzSW5kZXguaXNJbmRleChrZXkpICYmIGtleSA8IGN1cnJlbnQzLmxlbmd0aDsKICAgICAgICAgIGlmICghaXNTcGFyc2VJbmRleCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQzID0gY3VycmVudDNba2V5XTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGV4cG9ydHMuaGFzID0gaGFzMzsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcwp2YXIgcmVxdWlyZV9tYXRjaGVzUHJvcGVydHkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNNYXRjaCA9IHJlcXVpcmVfaXNNYXRjaCgpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgdmFyIGNsb25lRGVlcCA9IHJlcXVpcmVfY2xvbmVEZWVwMigpOwogICAgdmFyIGdldDcgPSByZXF1aXJlX2dldCgpOwogICAgdmFyIGhhczMgPSByZXF1aXJlX2hhcygpOwogICAgZnVuY3Rpb24gbWF0Y2hlc1Byb3BlcnR5KHByb3BlcnR5LCBzb3VyY2UpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgcHJvcGVydHkpIHsKICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICBpZiAoT2JqZWN0LmlzKHByb3BlcnR5Py52YWx1ZU9mKCksIC0wKSkgewogICAgICAgICAgICBwcm9wZXJ0eSA9ICItMCI7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcHJvcGVydHkgPSB0b0tleS50b0tleShwcm9wZXJ0eSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgc291cmNlID0gY2xvbmVEZWVwLmNsb25lRGVlcChzb3VyY2UpOwogICAgICByZXR1cm4gZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gZ2V0Ny5nZXQodGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gaGFzMy5oYXModGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2UgPT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHJlc3VsdCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlc1Byb3BlcnR5ID0gbWF0Y2hlc1Byb3BlcnR5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL2l0ZXJhdGVlLmpzCnZhciByZXF1aXJlX2l0ZXJhdGVlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvaXRlcmF0ZWUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlkZW50aXR5NCA9IHJlcXVpcmVfaWRlbnRpdHkoKTsKICAgIHZhciBwcm9wZXJ0eSA9IHJlcXVpcmVfcHJvcGVydHkoKTsKICAgIHZhciBtYXRjaGVzMiA9IHJlcXVpcmVfbWF0Y2hlcygpOwogICAgdmFyIG1hdGNoZXNQcm9wZXJ0eSA9IHJlcXVpcmVfbWF0Y2hlc1Byb3BlcnR5KCk7CiAgICBmdW5jdGlvbiBpdGVyYXRlZSh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiBpZGVudGl0eTQuaWRlbnRpdHk7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICByZXR1cm4gbWF0Y2hlc1Byb3BlcnR5Lm1hdGNoZXNQcm9wZXJ0eSh2YWx1ZVswXSwgdmFsdWVbMV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoZXMyLm1hdGNoZXModmFsdWUpOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcmV0dXJuIHByb3BlcnR5LnByb3BlcnR5KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXRlcmF0ZWUgPSBpdGVyYXRlZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvdW5pcUJ5LmpzCnZhciByZXF1aXJlX3VuaXFCeTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvdW5pcUJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciB1bmlxQnkkMSA9IHJlcXVpcmVfdW5pcUJ5KCk7CiAgICB2YXIgaWRlbnRpdHk0ID0gcmVxdWlyZV9pZGVudGl0eSgpOwogICAgdmFyIGlzQXJyYXlMaWtlT2JqZWN0ID0gcmVxdWlyZV9pc0FycmF5TGlrZU9iamVjdCgpOwogICAgdmFyIGl0ZXJhdGVlID0gcmVxdWlyZV9pdGVyYXRlZSgpOwogICAgZnVuY3Rpb24gdW5pcUJ5MihhcnJheSwgaXRlcmF0ZWUkMSA9IGlkZW50aXR5NC5pZGVudGl0eSkgewogICAgICBpZiAoIWlzQXJyYXlMaWtlT2JqZWN0LmlzQXJyYXlMaWtlT2JqZWN0KGFycmF5KSkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICByZXR1cm4gdW5pcUJ5JDEudW5pcUJ5KEFycmF5LmZyb20oYXJyYXkpLCBpdGVyYXRlZS5pdGVyYXRlZShpdGVyYXRlZSQxKSk7CiAgICB9CiAgICBleHBvcnRzLnVuaXFCeSA9IHVuaXFCeTI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC91bmlxQnkuanMKdmFyIHJlcXVpcmVfdW5pcUJ5MyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdW5pcUJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV91bmlxQnkyKCkudW5pcUJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfc2hpbV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIChmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKDAgIT09IHgyIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlJDIoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCkgewogICAgICAgIGRpZFdhcm5PbGQxOEFscGhhIHx8IHZvaWQgMCA9PT0gUmVhY3Q0NC5zdGFydFRyYW5zaXRpb24gfHwgKGRpZFdhcm5PbGQxOEFscGhhID0gdHJ1ZSwgY29uc29sZS5lcnJvcigKICAgICAgICAgICJZb3UgYXJlIHVzaW5nIGFuIG91dGRhdGVkLCBwcmUtcmVsZWFzZSBhbHBoYSBvZiBSZWFjdCAxOCB0aGF0IGRvZXMgbm90IHN1cHBvcnQgdXNlU3luY0V4dGVybmFsU3RvcmUuIFRoZSB1c2Utc3luYy1leHRlcm5hbC1zdG9yZSBzaGltIHdpbGwgbm90IHdvcmsgY29ycmVjdGx5LiBVcGdyYWRlIHRvIGEgbmV3ZXIgcHJlLXJlbGVhc2UuIgogICAgICAgICkpOwogICAgICAgIHZhciB2YWx1ZSA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGNhY2hlZFZhbHVlID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgIG9iamVjdElzKHZhbHVlLCBjYWNoZWRWYWx1ZSkgfHwgKGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIKICAgICAgICAgICksIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGNhY2hlZFZhbHVlID0gdXNlU3RhdGUxNSh7CiAgICAgICAgICBpbnN0OiB7IHZhbHVlLCBnZXRTbmFwc2hvdCB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIGluc3QgPSBjYWNoZWRWYWx1ZVswXS5pbnN0LCBmb3JjZVVwZGF0ZSA9IGNhY2hlZFZhbHVlWzFdOwogICAgICAgIHVzZUxheW91dEVmZmVjdDkoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBpbnN0LmdldFNuYXBzaG90ID0gZ2V0U25hcHNob3Q7CiAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgfSwKICAgICAgICAgIFtzdWJzY3JpYmUsIHZhbHVlLCBnZXRTbmFwc2hvdF0KICAgICAgICApOwogICAgICAgIHVzZUVmZmVjdDE2KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgICByZXR1cm4gc3Vic2NyaWJlKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBbc3Vic2NyaWJlXQogICAgICAgICk7CiAgICAgICAgdXNlRGVidWdWYWx1ZTIodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpIHsKICAgICAgICB2YXIgbGF0ZXN0R2V0U25hcHNob3QgPSBpbnN0LmdldFNuYXBzaG90OwogICAgICAgIGluc3QgPSBpbnN0LnZhbHVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbGF0ZXN0R2V0U25hcHNob3QoKTsKICAgICAgICAgIHJldHVybiAhb2JqZWN0SXMoaW5zdCwgbmV4dFZhbHVlKTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlJDEoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCkgewogICAgICAgIHJldHVybiBnZXRTbmFwc2hvdCgpOwogICAgICB9CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQoRXJyb3IoKSk7CiAgICAgIHZhciBSZWFjdDQ0ID0gcmVxdWlyZV9yZWFjdCgpLCBvYmplY3RJcyA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBPYmplY3QuaXMgPyBPYmplY3QuaXMgOiBpczQsIHVzZVN0YXRlMTUgPSBSZWFjdDQ0LnVzZVN0YXRlLCB1c2VFZmZlY3QxNiA9IFJlYWN0NDQudXNlRWZmZWN0LCB1c2VMYXlvdXRFZmZlY3Q5ID0gUmVhY3Q0NC51c2VMYXlvdXRFZmZlY3QsIHVzZURlYnVnVmFsdWUyID0gUmVhY3Q0NC51c2VEZWJ1Z1ZhbHVlLCBkaWRXYXJuT2xkMThBbHBoYSA9IGZhbHNlLCBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IGZhbHNlLCBzaGltID0gInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cgfHwgInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQgfHwgInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA/IHVzZVN5bmNFeHRlcm5hbFN0b3JlJDEgOiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQyOwogICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlID0gdm9pZCAwICE9PSBSZWFjdDQ0LnVzZVN5bmNFeHRlcm5hbFN0b3JlID8gUmVhY3Q0NC51c2VTeW5jRXh0ZXJuYWxTdG9yZSA6IHNoaW07CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKEVycm9yKCkpOwogICAgfSkoKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vaW5kZXguanMKdmFyIHJlcXVpcmVfc2hpbSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvc2hpbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3NoaW1fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3Rvcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0vd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoMCAhPT0geDIgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgIH0KICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChFcnJvcigpKTsKICAgICAgdmFyIFJlYWN0NDQgPSByZXF1aXJlX3JlYWN0KCksIHNoaW0gPSByZXF1aXJlX3NoaW0oKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIgPSBzaGltLnVzZVN5bmNFeHRlcm5hbFN0b3JlLCB1c2VSZWYxNyA9IFJlYWN0NDQudXNlUmVmLCB1c2VFZmZlY3QxNiA9IFJlYWN0NDQudXNlRWZmZWN0LCB1c2VNZW1vMTAgPSBSZWFjdDQ0LnVzZU1lbW8sIHVzZURlYnVnVmFsdWUyID0gUmVhY3Q0NC51c2VEZWJ1Z1ZhbHVlOwogICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlV2l0aFNlbGVjdG9yID0gZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsKSB7CiAgICAgICAgdmFyIGluc3RSZWYgPSB1c2VSZWYxNyhudWxsKTsKICAgICAgICBpZiAobnVsbCA9PT0gaW5zdFJlZi5jdXJyZW50KSB7CiAgICAgICAgICB2YXIgaW5zdCA9IHsgaGFzVmFsdWU6IGZhbHNlLCB2YWx1ZTogbnVsbCB9OwogICAgICAgICAgaW5zdFJlZi5jdXJyZW50ID0gaW5zdDsKICAgICAgICB9IGVsc2UgaW5zdCA9IGluc3RSZWYuY3VycmVudDsKICAgICAgICBpbnN0UmVmID0gdXNlTWVtbzEwKAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIG1lbW9pemVkU2VsZWN0b3IobmV4dFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgaWYgKCFoYXNNZW1vKSB7CiAgICAgICAgICAgICAgICBoYXNNZW1vID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgICBuZXh0U25hcHNob3QgPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gaXNFcXVhbCAmJiBpbnN0Lmhhc1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U2VsZWN0aW9uID0gaW5zdC52YWx1ZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzRXF1YWwoY3VycmVudFNlbGVjdGlvbiwgbmV4dFNuYXBzaG90KSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50U2VsZWN0aW9uID0gbWVtb2l6ZWRTZWxlY3Rpb247CiAgICAgICAgICAgICAgaWYgKG9iamVjdElzKG1lbW9pemVkU25hcHNob3QsIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICB2YXIgbmV4dFNlbGVjdGlvbiA9IHNlbGVjdG9yKG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gaXNFcXVhbCAmJiBpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTZWxlY3Rpb24pKQogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3QsIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBuZXh0U2VsZWN0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNNZW1vID0gZmFsc2UsIG1lbW9pemVkU25hcHNob3QsIG1lbW9pemVkU2VsZWN0aW9uLCBtYXliZUdldFNlcnZlclNuYXBzaG90ID0gdm9pZCAwID09PSBnZXRTZXJ2ZXJTbmFwc2hvdCA/IG51bGwgOiBnZXRTZXJ2ZXJTbmFwc2hvdDsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKGdldFNuYXBzaG90KCkpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbnVsbCA9PT0gbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA/IHZvaWQgMCA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0b3IobWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIF07CiAgICAgICAgICB9LAogICAgICAgICAgW2dldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWxdCiAgICAgICAgKTsKICAgICAgICB2YXIgdmFsdWUgPSB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIoc3Vic2NyaWJlLCBpbnN0UmVmWzBdLCBpbnN0UmVmWzFdKTsKICAgICAgICB1c2VFZmZlY3QxNigKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnN0Lmhhc1ZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgaW5zdC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgfSwKICAgICAgICAgIFt2YWx1ZV0KICAgICAgICApOwogICAgICAgIHVzZURlYnVnVmFsdWUyKHZhbHVlKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH07CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKEVycm9yKCkpOwogICAgfSkoKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vd2l0aC1zZWxlY3Rvci5qcwp2YXIgcmVxdWlyZV93aXRoX3NlbGVjdG9yID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL3dpdGgtc2VsZWN0b3IuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV93aXRoX3NlbGVjdG9yX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9jb21wYXJlVmFsdWVzLmpzCnZhciByZXF1aXJlX2NvbXBhcmVWYWx1ZXMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2NvbXBhcmVWYWx1ZXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZ2V0UHJpb3JpdHkoYTIpIHsKICAgICAgaWYgKHR5cGVvZiBhMiA9PT0gInN5bWJvbCIpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBpZiAoYTIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gMjsKICAgICAgfQogICAgICBpZiAoYTIgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiAzOwogICAgICB9CiAgICAgIGlmIChhMiAhPT0gYTIpIHsKICAgICAgICByZXR1cm4gNDsKICAgICAgfQogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHZhciBjb21wYXJlVmFsdWVzID0gKGEyLCBiLCBvcmRlcikgPT4gewogICAgICBpZiAoYTIgIT09IGIpIHsKICAgICAgICBjb25zdCBhUHJpb3JpdHkgPSBnZXRQcmlvcml0eShhMik7CiAgICAgICAgY29uc3QgYlByaW9yaXR5ID0gZ2V0UHJpb3JpdHkoYik7CiAgICAgICAgaWYgKGFQcmlvcml0eSA9PT0gYlByaW9yaXR5ICYmIGFQcmlvcml0eSA9PT0gMCkgewogICAgICAgICAgaWYgKGEyIDwgYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IDEgOiAtMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhMiA+IGIpIHsKICAgICAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyAtMSA6IDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvcmRlciA9PT0gImRlc2MiID8gYlByaW9yaXR5IC0gYVByaW9yaXR5IDogYVByaW9yaXR5IC0gYlByaW9yaXR5OwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfTsKICAgIGV4cG9ydHMuY29tcGFyZVZhbHVlcyA9IGNvbXBhcmVWYWx1ZXM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc1N5bWJvbC5qcwp2YXIgcmVxdWlyZV9pc1N5bWJvbCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNTeW1ib2wuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNTeW1ib2wodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gInN5bWJvbCIgfHwgdmFsdWUgaW5zdGFuY2VvZiBTeW1ib2w7CiAgICB9CiAgICBleHBvcnRzLmlzU3ltYm9sID0gaXNTeW1ib2w7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0tleS5qcwp2YXIgcmVxdWlyZV9pc0tleSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNLZXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzU3ltYm9sID0gcmVxdWlyZV9pc1N5bWJvbCgpOwogICAgdmFyIHJlZ2V4SXNEZWVwUHJvcCA9IC9cLnxcWyg/OlteW1xdXSp8KFsiJ10pKD86KD8hXDEpW15cXF18XFwuKSo/XDEpXF0vOwogICAgdmFyIHJlZ2V4SXNQbGFpblByb3AgPSAvXlx3KiQvOwogICAgZnVuY3Rpb24gaXNLZXkodmFsdWUsIG9iamVjdCkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT0gbnVsbCB8fCBpc1N5bWJvbC5pc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAocmVnZXhJc1BsYWluUHJvcC50ZXN0KHZhbHVlKSB8fCAhcmVnZXhJc0RlZXBQcm9wLnRlc3QodmFsdWUpKSB8fCBvYmplY3QgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duKG9iamVjdCwgdmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5pc0tleSA9IGlzS2V5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9vcmRlckJ5LmpzCnZhciByZXF1aXJlX29yZGVyQnkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvb3JkZXJCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY29tcGFyZVZhbHVlcyA9IHJlcXVpcmVfY29tcGFyZVZhbHVlcygpOwogICAgdmFyIGlzS2V5ID0gcmVxdWlyZV9pc0tleSgpOwogICAgdmFyIHRvUGF0aCA9IHJlcXVpcmVfdG9QYXRoKCk7CiAgICBmdW5jdGlvbiBvcmRlckJ5KGNvbGxlY3Rpb24sIGNyaXRlcmlhLCBvcmRlcnMsIGd1YXJkKSB7CiAgICAgIGlmIChjb2xsZWN0aW9uID09IG51bGwpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgb3JkZXJzID0gZ3VhcmQgPyB2b2lkIDAgOiBvcmRlcnM7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIGNvbGxlY3Rpb24gPSBPYmplY3QudmFsdWVzKGNvbGxlY3Rpb24pOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShjcml0ZXJpYSkpIHsKICAgICAgICBjcml0ZXJpYSA9IGNyaXRlcmlhID09IG51bGwgPyBbbnVsbF0gOiBbY3JpdGVyaWFdOwogICAgICB9CiAgICAgIGlmIChjcml0ZXJpYS5sZW5ndGggPT09IDApIHsKICAgICAgICBjcml0ZXJpYSA9IFtudWxsXTsKICAgICAgfQogICAgICBpZiAoIUFycmF5LmlzQXJyYXkob3JkZXJzKSkgewogICAgICAgIG9yZGVycyA9IG9yZGVycyA9PSBudWxsID8gW10gOiBbb3JkZXJzXTsKICAgICAgfQogICAgICBvcmRlcnMgPSBvcmRlcnMubWFwKChvcmRlcikgPT4gU3RyaW5nKG9yZGVyKSk7CiAgICAgIGNvbnN0IGdldFZhbHVlQnlOZXN0ZWRQYXRoID0gKG9iamVjdCwgcGF0aDIpID0+IHsKICAgICAgICBsZXQgdGFyZ2V0ID0gb2JqZWN0OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aDIubGVuZ3RoICYmIHRhcmdldCAhPSBudWxsOyArK2kpIHsKICAgICAgICAgIHRhcmdldCA9IHRhcmdldFtwYXRoMltpXV07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH07CiAgICAgIGNvbnN0IGdldFZhbHVlQnlDcml0ZXJpb24gPSAoY3JpdGVyaW9uLCBvYmplY3QpID0+IHsKICAgICAgICBpZiAob2JqZWN0ID09IG51bGwgfHwgY3JpdGVyaW9uID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY3JpdGVyaW9uID09PSAib2JqZWN0IiAmJiAia2V5IiBpbiBjcml0ZXJpb24pIHsKICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duKG9iamVjdCwgY3JpdGVyaW9uLmtleSkpIHsKICAgICAgICAgICAgcmV0dXJuIG9iamVjdFtjcml0ZXJpb24ua2V5XTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRWYWx1ZUJ5TmVzdGVkUGF0aChvYmplY3QsIGNyaXRlcmlvbi5wYXRoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjcml0ZXJpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHJldHVybiBjcml0ZXJpb24ob2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSkgewogICAgICAgICAgcmV0dXJuIGdldFZhbHVlQnlOZXN0ZWRQYXRoKG9iamVjdCwgY3JpdGVyaW9uKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0W2NyaXRlcmlvbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH07CiAgICAgIGNvbnN0IHByZXBhcmVkQ3JpdGVyaWEgPSBjcml0ZXJpYS5tYXAoKGNyaXRlcmlvbikgPT4gewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNyaXRlcmlvbikgJiYgY3JpdGVyaW9uLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgY3JpdGVyaW9uID0gY3JpdGVyaW9uWzBdOwogICAgICAgIH0KICAgICAgICBpZiAoY3JpdGVyaW9uID09IG51bGwgfHwgdHlwZW9mIGNyaXRlcmlvbiA9PT0gImZ1bmN0aW9uIiB8fCBBcnJheS5pc0FycmF5KGNyaXRlcmlvbikgfHwgaXNLZXkuaXNLZXkoY3JpdGVyaW9uKSkgewogICAgICAgICAgcmV0dXJuIGNyaXRlcmlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsga2V5OiBjcml0ZXJpb24sIHBhdGg6IHRvUGF0aC50b1BhdGgoY3JpdGVyaW9uKSB9OwogICAgICB9KTsKICAgICAgY29uc3QgcHJlcGFyZWRDb2xsZWN0aW9uID0gY29sbGVjdGlvbi5tYXAoKGl0ZW0pID0+ICh7CiAgICAgICAgb3JpZ2luYWw6IGl0ZW0sCiAgICAgICAgY3JpdGVyaWE6IHByZXBhcmVkQ3JpdGVyaWEubWFwKChjcml0ZXJpb24pID0+IGdldFZhbHVlQnlDcml0ZXJpb24oY3JpdGVyaW9uLCBpdGVtKSkKICAgICAgfSkpOwogICAgICByZXR1cm4gcHJlcGFyZWRDb2xsZWN0aW9uLnNsaWNlKCkuc29ydCgoYTIsIGIpID0+IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByZXBhcmVkQ3JpdGVyaWEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGNvbXBhcmVkUmVzdWx0ID0gY29tcGFyZVZhbHVlcy5jb21wYXJlVmFsdWVzKGEyLmNyaXRlcmlhW2ldLCBiLmNyaXRlcmlhW2ldLCBvcmRlcnNbaV0pOwogICAgICAgICAgaWYgKGNvbXBhcmVkUmVzdWx0ICE9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wYXJlZFJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0pLm1hcCgoaXRlbSkgPT4gaXRlbS5vcmlnaW5hbCk7CiAgICB9CiAgICBleHBvcnRzLm9yZGVyQnkgPSBvcmRlckJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2ZsYXR0ZW4uanMKdmFyIHJlcXVpcmVfZmxhdHRlbiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2ZsYXR0ZW4uanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZmxhdHRlbihhcnIsIGRlcHRoID0gMSkgewogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgZmxvb3JlZERlcHRoID0gTWF0aC5mbG9vcihkZXB0aCk7CiAgICAgIGNvbnN0IHJlY3Vyc2l2ZSA9IChhcnIyLCBjdXJyZW50RGVwdGgpID0+IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycjIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBhcnIyW2ldOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgJiYgY3VycmVudERlcHRoIDwgZmxvb3JlZERlcHRoKSB7CiAgICAgICAgICAgIHJlY3Vyc2l2ZShpdGVtLCBjdXJyZW50RGVwdGggKyAxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmVjdXJzaXZlKGFyciwgMCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmZsYXR0ZW4gPSBmbGF0dGVuOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJdGVyYXRlZUNhbGwuanMKdmFyIHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzSXRlcmF0ZWVDYWxsLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc0luZGV4ID0gcmVxdWlyZV9pc0luZGV4KCk7CiAgICB2YXIgaXNBcnJheUxpa2UgPSByZXF1aXJlX2lzQXJyYXlMaWtlKCk7CiAgICB2YXIgaXNPYmplY3QgPSByZXF1aXJlX2lzT2JqZWN0KCk7CiAgICB2YXIgZXEgPSByZXF1aXJlX2VxKCk7CiAgICBmdW5jdGlvbiBpc0l0ZXJhdGVlQ2FsbCh2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICBpZiAoIWlzT2JqZWN0LmlzT2JqZWN0KG9iamVjdCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gIm51bWJlciIgJiYgaXNBcnJheUxpa2UuaXNBcnJheUxpa2Uob2JqZWN0KSAmJiBpc0luZGV4LmlzSW5kZXgoaW5kZXgpICYmIGluZGV4IDwgb2JqZWN0Lmxlbmd0aCB8fCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICYmIGluZGV4IGluIG9iamVjdCkgewogICAgICAgIHJldHVybiBlcS5lcShvYmplY3RbaW5kZXhdLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0l0ZXJhdGVlQ2FsbCA9IGlzSXRlcmF0ZWVDYWxsOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9zb3J0QnkuanMKdmFyIHJlcXVpcmVfc29ydEJ5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3NvcnRCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgb3JkZXJCeSA9IHJlcXVpcmVfb3JkZXJCeSgpOwogICAgdmFyIGZsYXR0ZW4gPSByZXF1aXJlX2ZsYXR0ZW4oKTsKICAgIHZhciBpc0l0ZXJhdGVlQ2FsbCA9IHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwoKTsKICAgIGZ1bmN0aW9uIHNvcnRCeTUoY29sbGVjdGlvbiwgLi4uY3JpdGVyaWEpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gY3JpdGVyaWEubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMSAmJiBpc0l0ZXJhdGVlQ2FsbC5pc0l0ZXJhdGVlQ2FsbChjb2xsZWN0aW9uLCBjcml0ZXJpYVswXSwgY3JpdGVyaWFbMV0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbXTsKICAgICAgfSBlbHNlIGlmIChsZW5ndGggPiAyICYmIGlzSXRlcmF0ZWVDYWxsLmlzSXRlcmF0ZWVDYWxsKGNyaXRlcmlhWzBdLCBjcml0ZXJpYVsxXSwgY3JpdGVyaWFbMl0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbY3JpdGVyaWFbMF1dOwogICAgICB9CiAgICAgIHJldHVybiBvcmRlckJ5Lm9yZGVyQnkoY29sbGVjdGlvbiwgZmxhdHRlbi5mbGF0dGVuKGNyaXRlcmlhKSwgWyJhc2MiXSk7CiAgICB9CiAgICBleHBvcnRzLnNvcnRCeSA9IHNvcnRCeTU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9zb3J0QnkuanMKdmFyIHJlcXVpcmVfc29ydEJ5MiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvc29ydEJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9zb3J0QnkoKS5zb3J0Qnk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vZGVib3VuY2UuanMKdmFyIHJlcXVpcmVfZGVib3VuY2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9mdW5jdGlvbi9kZWJvdW5jZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCBkZWJvdW5jZU1zLCB7IHNpZ25hbCwgZWRnZXMgfSA9IHt9KSB7CiAgICAgIGxldCBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgbGV0IHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgY29uc3QgbGVhZGluZyA9IGVkZ2VzICE9IG51bGwgJiYgZWRnZXMuaW5jbHVkZXMoImxlYWRpbmciKTsKICAgICAgY29uc3QgdHJhaWxpbmcgPSBlZGdlcyA9PSBudWxsIHx8IGVkZ2VzLmluY2x1ZGVzKCJ0cmFpbGluZyIpOwogICAgICBjb25zdCBpbnZva2UgPSAoKSA9PiB7CiAgICAgICAgaWYgKHBlbmRpbmdBcmdzICE9PSBudWxsKSB7CiAgICAgICAgICBmdW5jLmFwcGx5KHBlbmRpbmdUaGlzLCBwZW5kaW5nQXJncyk7CiAgICAgICAgICBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgICAgIHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IG9uVGltZXJFbmQgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRyYWlsaW5nKSB7CiAgICAgICAgICBpbnZva2UoKTsKICAgICAgICB9CiAgICAgICAgY2FuY2VsKCk7CiAgICAgIH07CiAgICAgIGxldCB0aW1lb3V0SWQgPSBudWxsOwogICAgICBjb25zdCBzY2hlZHVsZSA9ICgpID0+IHsKICAgICAgICBpZiAodGltZW91dElkICE9IG51bGwpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgIH0KICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgICBvblRpbWVyRW5kKCk7CiAgICAgICAgfSwgZGVib3VuY2VNcyk7CiAgICAgIH07CiAgICAgIGNvbnN0IGNhbmNlbFRpbWVyID0gKCkgPT4gewogICAgICAgIGlmICh0aW1lb3V0SWQgIT09IG51bGwpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IGNhbmNlbCA9ICgpID0+IHsKICAgICAgICBjYW5jZWxUaW1lcigpOwogICAgICAgIHBlbmRpbmdUaGlzID0gdm9pZCAwOwogICAgICAgIHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgfTsKICAgICAgY29uc3QgZmx1c2ggPSAoKSA9PiB7CiAgICAgICAgaW52b2tlKCk7CiAgICAgIH07CiAgICAgIGNvbnN0IGRlYm91bmNlZCA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICBpZiAoc2lnbmFsPy5hYm9ydGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHBlbmRpbmdUaGlzID0gdGhpczsKICAgICAgICBwZW5kaW5nQXJncyA9IGFyZ3M7CiAgICAgICAgY29uc3QgaXNGaXJzdENhbGwgPSB0aW1lb3V0SWQgPT0gbnVsbDsKICAgICAgICBzY2hlZHVsZSgpOwogICAgICAgIGlmIChsZWFkaW5nICYmIGlzRmlyc3RDYWxsKSB7CiAgICAgICAgICBpbnZva2UoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGRlYm91bmNlZC5zY2hlZHVsZSA9IHNjaGVkdWxlOwogICAgICBkZWJvdW5jZWQuY2FuY2VsID0gY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgc2lnbmFsPy5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsIGNhbmNlbCwgeyBvbmNlOiB0cnVlIH0pOwogICAgICByZXR1cm4gZGVib3VuY2VkOwogICAgfQogICAgZXhwb3J0cy5kZWJvdW5jZSA9IGRlYm91bmNlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9mdW5jdGlvbi9kZWJvdW5jZS5qcwp2YXIgcmVxdWlyZV9kZWJvdW5jZTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vZGVib3VuY2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlJDEgPSByZXF1aXJlX2RlYm91bmNlKCk7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCBkZWJvdW5jZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gIm9iamVjdCIpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgY29uc3QgeyBsZWFkaW5nID0gZmFsc2UsIHRyYWlsaW5nID0gdHJ1ZSwgbWF4V2FpdCB9ID0gb3B0aW9uczsKICAgICAgY29uc3QgZWRnZXMgPSBBcnJheSgyKTsKICAgICAgaWYgKGxlYWRpbmcpIHsKICAgICAgICBlZGdlc1swXSA9ICJsZWFkaW5nIjsKICAgICAgfQogICAgICBpZiAodHJhaWxpbmcpIHsKICAgICAgICBlZGdlc1sxXSA9ICJ0cmFpbGluZyI7CiAgICAgIH0KICAgICAgbGV0IHJlc3VsdCA9IHZvaWQgMDsKICAgICAgbGV0IHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIGNvbnN0IF9kZWJvdW5jZWQgPSBkZWJvdW5jZSQxLmRlYm91bmNlKGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIH0sIGRlYm91bmNlTXMsIHsgZWRnZXMgfSk7CiAgICAgIGNvbnN0IGRlYm91bmNlZCA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICBpZiAobWF4V2FpdCAhPSBudWxsKSB7CiAgICAgICAgICBpZiAocGVuZGluZ0F0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHBlbmRpbmdBdCA+PSBtYXhXYWl0KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuY2FuY2VsKCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuc2NoZWR1bGUoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgX2RlYm91bmNlZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBjb25zdCBmbHVzaCA9ICgpID0+IHsKICAgICAgICBfZGVib3VuY2VkLmZsdXNoKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZGVib3VuY2VkLmNhbmNlbCA9IF9kZWJvdW5jZWQuY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vdGhyb3R0bGUuanMKdmFyIHJlcXVpcmVfdGhyb3R0bGUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vdGhyb3R0bGUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlID0gcmVxdWlyZV9kZWJvdW5jZTIoKTsKICAgIGZ1bmN0aW9uIHRocm90dGxlMihmdW5jLCB0aHJvdHRsZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGNvbnN0IHsgbGVhZGluZyA9IHRydWUsIHRyYWlsaW5nID0gdHJ1ZSB9ID0gb3B0aW9uczsKICAgICAgcmV0dXJuIGRlYm91bmNlLmRlYm91bmNlKGZ1bmMsIHRocm90dGxlTXMsIHsKICAgICAgICBsZWFkaW5nLAogICAgICAgIG1heFdhaXQ6IHRocm90dGxlTXMsCiAgICAgICAgdHJhaWxpbmcKICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLnRocm90dGxlID0gdGhyb3R0bGUyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdGhyb3R0bGUuanMKdmFyIHJlcXVpcmVfdGhyb3R0bGUyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC90aHJvdHRsZS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfdGhyb3R0bGUoKS50aHJvdHRsZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b051bWJlci5qcwp2YXIgcmVxdWlyZV90b051bWJlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvTnVtYmVyLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1N5bWJvbCA9IHJlcXVpcmVfaXNTeW1ib2woKTsKICAgIGZ1bmN0aW9uIHRvTnVtYmVyKHZhbHVlKSB7CiAgICAgIGlmIChpc1N5bWJvbC5pc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gTmFOOwogICAgICB9CiAgICAgIHJldHVybiBOdW1iZXIodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b051bWJlciA9IHRvTnVtYmVyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvRmluaXRlLmpzCnZhciByZXF1aXJlX3RvRmluaXRlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9GaW5pdGUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIHRvTnVtYmVyID0gcmVxdWlyZV90b051bWJlcigpOwogICAgZnVuY3Rpb24gdG9GaW5pdGUodmFsdWUpIHsKICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gMCA/IHZhbHVlIDogMDsKICAgICAgfQogICAgICB2YWx1ZSA9IHRvTnVtYmVyLnRvTnVtYmVyKHZhbHVlKTsKICAgICAgaWYgKHZhbHVlID09PSBJbmZpbml0eSB8fCB2YWx1ZSA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgY29uc3Qgc2lnbjIgPSB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgICAgcmV0dXJuIHNpZ24yICogTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlID8gdmFsdWUgOiAwOwogICAgfQogICAgZXhwb3J0cy50b0Zpbml0ZSA9IHRvRmluaXRlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9tYXRoL3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L21hdGgvcmFuZ2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzSXRlcmF0ZWVDYWxsID0gcmVxdWlyZV9pc0l0ZXJhdGVlQ2FsbCgpOwogICAgdmFyIHRvRmluaXRlID0gcmVxdWlyZV90b0Zpbml0ZSgpOwogICAgZnVuY3Rpb24gcmFuZ2U0KHN0YXJ0LCBlbmQsIHN0ZXApIHsKICAgICAgaWYgKHN0ZXAgJiYgdHlwZW9mIHN0ZXAgIT09ICJudW1iZXIiICYmIGlzSXRlcmF0ZWVDYWxsLmlzSXRlcmF0ZWVDYWxsKHN0YXJ0LCBlbmQsIHN0ZXApKSB7CiAgICAgICAgZW5kID0gc3RlcCA9IHZvaWQgMDsKICAgICAgfQogICAgICBzdGFydCA9IHRvRmluaXRlLnRvRmluaXRlKHN0YXJ0KTsKICAgICAgaWYgKGVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIGVuZCA9IHRvRmluaXRlLnRvRmluaXRlKGVuZCk7CiAgICAgIH0KICAgICAgc3RlcCA9IHN0ZXAgPT09IHZvaWQgMCA/IHN0YXJ0IDwgZW5kID8gMSA6IC0xIDogdG9GaW5pdGUudG9GaW5pdGUoc3RlcCk7CiAgICAgIGNvbnN0IGxlbmd0aCA9IE1hdGgubWF4KE1hdGguY2VpbCgoZW5kIC0gc3RhcnQpIC8gKHN0ZXAgfHwgMSkpLCAwKTsKICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgKz0gc3RlcDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5yYW5nZSA9IHJhbmdlNDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvcmFuZ2UuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JhbmdlKCkucmFuZ2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9kZWNpbWFsLmpzLWxpZ2h0L2RlY2ltYWwuanMKdmFyIHJlcXVpcmVfZGVjaW1hbCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIChmdW5jdGlvbihnbG9iYWxTY29wZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBNQVhfRElHSVRTID0gMWU5LCBEZWNpbWFsMyA9IHsKICAgICAgICAvLyBUaGVzZSB2YWx1ZXMgbXVzdCBiZSBpbnRlZ2VycyB3aXRoaW4gdGhlIHN0YXRlZCByYW5nZXMgKGluY2x1c2l2ZSkuCiAgICAgICAgLy8gTW9zdCBvZiB0aGVzZSB2YWx1ZXMgY2FuIGJlIGNoYW5nZWQgZHVyaW5nIHJ1bi10aW1lIHVzaW5nIGBEZWNpbWFsLmNvbmZpZ2AuCiAgICAgICAgLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIHNpZ25pZmljYW50IGRpZ2l0cyBvZiB0aGUgcmVzdWx0IG9mIGEgY2FsY3VsYXRpb24gb3IgYmFzZSBjb252ZXJzaW9uLgogICAgICAgIC8vIEUuZy4gYERlY2ltYWwuY29uZmlnKHsgcHJlY2lzaW9uOiAyMCB9KTtgCiAgICAgICAgcHJlY2lzaW9uOiAyMCwKICAgICAgICAvLyAxIHRvIE1BWF9ESUdJVFMKICAgICAgICAvLyBUaGUgcm91bmRpbmcgbW9kZSB1c2VkIGJ5IGRlZmF1bHQgYnkgYHRvSW50ZWdlcmAsIGB0b0RlY2ltYWxQbGFjZXNgLCBgdG9FeHBvbmVudGlhbGAsCiAgICAgICAgLy8gYHRvRml4ZWRgLCBgdG9QcmVjaXNpb25gIGFuZCBgdG9TaWduaWZpY2FudERpZ2l0c2AuCiAgICAgICAgLy8KICAgICAgICAvLyBST1VORF9VUCAgICAgICAgIDAgQXdheSBmcm9tIHplcm8uCiAgICAgICAgLy8gUk9VTkRfRE9XTiAgICAgICAxIFRvd2FyZHMgemVyby4KICAgICAgICAvLyBST1VORF9DRUlMICAgICAgIDIgVG93YXJkcyArSW5maW5pdHkuCiAgICAgICAgLy8gUk9VTkRfRkxPT1IgICAgICAzIFRvd2FyZHMgLUluZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0hBTEZfVVAgICAgNCBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdXAuCiAgICAgICAgLy8gUk9VTkRfSEFMRl9ET1dOICA1IFRvd2FyZHMgbmVhcmVzdCBuZWlnaGJvdXIuIElmIGVxdWlkaXN0YW50LCBkb3duLgogICAgICAgIC8vIFJPVU5EX0hBTEZfRVZFTiAgNiBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdG93YXJkcyBldmVuIG5laWdoYm91ci4KICAgICAgICAvLyBST1VORF9IQUxGX0NFSUwgIDcgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgK0luZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0hBTEZfRkxPT1IgOCBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdG93YXJkcyAtSW5maW5pdHkuCiAgICAgICAgLy8KICAgICAgICAvLyBFLmcuCiAgICAgICAgLy8gYERlY2ltYWwucm91bmRpbmcgPSA0O2AKICAgICAgICAvLyBgRGVjaW1hbC5yb3VuZGluZyA9IERlY2ltYWwuUk9VTkRfSEFMRl9VUDtgCiAgICAgICAgcm91bmRpbmc6IDQsCiAgICAgICAgLy8gMCB0byA4CiAgICAgICAgLy8gVGhlIGV4cG9uZW50IHZhbHVlIGF0IGFuZCBiZW5lYXRoIHdoaWNoIGB0b1N0cmluZ2AgcmV0dXJucyBleHBvbmVudGlhbCBub3RhdGlvbi4KICAgICAgICAvLyBKYXZhU2NyaXB0IG51bWJlcnM6IC03CiAgICAgICAgdG9FeHBOZWc6IC03LAogICAgICAgIC8vIDAgdG8gLU1BWF9FCiAgICAgICAgLy8gVGhlIGV4cG9uZW50IHZhbHVlIGF0IGFuZCBhYm92ZSB3aGljaCBgdG9TdHJpbmdgIHJldHVybnMgZXhwb25lbnRpYWwgbm90YXRpb24uCiAgICAgICAgLy8gSmF2YVNjcmlwdCBudW1iZXJzOiAyMQogICAgICAgIHRvRXhwUG9zOiAyMSwKICAgICAgICAvLyAwIHRvIE1BWF9FCiAgICAgICAgLy8gVGhlIG5hdHVyYWwgbG9nYXJpdGhtIG9mIDEwLgogICAgICAgIC8vIDExNSBkaWdpdHMKICAgICAgICBMTjEwOiAiMi4zMDI1ODUwOTI5OTQwNDU2ODQwMTc5OTE0NTQ2ODQzNjQyMDc2MDExMDE0ODg2Mjg3NzI5NzYwMzMzMjc5MDA5Njc1NzI2MDk2NzczNTI0ODAyMzU5OTcyMDUwODk1OTgyOTgzNDE5Njc3ODQwNDIyODYiCiAgICAgIH0sIGV4dGVybmFsID0gdHJ1ZSwgZGVjaW1hbEVycm9yID0gIltEZWNpbWFsRXJyb3JdICIsIGludmFsaWRBcmd1bWVudCA9IGRlY2ltYWxFcnJvciArICJJbnZhbGlkIGFyZ3VtZW50OiAiLCBleHBvbmVudE91dE9mUmFuZ2UgPSBkZWNpbWFsRXJyb3IgKyAiRXhwb25lbnQgb3V0IG9mIHJhbmdlOiAiLCBtYXRoZmxvb3IgPSBNYXRoLmZsb29yLCBtYXRocG93ID0gTWF0aC5wb3csIGlzRGVjaW1hbCA9IC9eKFxkKyhcLlxkKik/fFwuXGQrKShlWystXT9cZCspPyQvaSwgT05FLCBCQVNFID0gMWU3LCBMT0dfQkFTRSA9IDcsIE1BWF9TQUZFX0lOVEVHRVIgPSA5MDA3MTk5MjU0NzQwOTkxLCBNQVhfRSA9IG1hdGhmbG9vcihNQVhfU0FGRV9JTlRFR0VSIC8gTE9HX0JBU0UpLCBQID0ge307CiAgICAgIFAuYWJzb2x1dGVWYWx1ZSA9IFAuYWJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcyk7CiAgICAgICAgaWYgKHgyLnMpIHgyLnMgPSAxOwogICAgICAgIHJldHVybiB4MjsKICAgICAgfTsKICAgICAgUC5jb21wYXJlZFRvID0gUC5jbXAgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBpLCBqLCB4ZEwsIHlkTCwgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICBpZiAoeDIucyAhPT0geTIucykgcmV0dXJuIHgyLnMgfHwgLXkyLnM7CiAgICAgICAgaWYgKHgyLmUgIT09IHkyLmUpIHJldHVybiB4Mi5lID4geTIuZSBeIHgyLnMgPCAwID8gMSA6IC0xOwogICAgICAgIHhkTCA9IHgyLmQubGVuZ3RoOwogICAgICAgIHlkTCA9IHkyLmQubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDAsIGogPSB4ZEwgPCB5ZEwgPyB4ZEwgOiB5ZEw7IGkgPCBqOyArK2kpIHsKICAgICAgICAgIGlmICh4Mi5kW2ldICE9PSB5Mi5kW2ldKSByZXR1cm4geDIuZFtpXSA+IHkyLmRbaV0gXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHhkTCA9PT0geWRMID8gMCA6IHhkTCA+IHlkTCBeIHgyLnMgPCAwID8gMSA6IC0xOwogICAgICB9OwogICAgICBQLmRlY2ltYWxQbGFjZXMgPSBQLmRwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgdyA9IHgyLmQubGVuZ3RoIC0gMSwgZHAgPSAodyAtIHgyLmUpICogTE9HX0JBU0U7CiAgICAgICAgdyA9IHgyLmRbd107CiAgICAgICAgaWYgKHcpIGZvciAoOyB3ICUgMTAgPT0gMDsgdyAvPSAxMCkgZHAtLTsKICAgICAgICByZXR1cm4gZHAgPCAwID8gMCA6IGRwOwogICAgICB9OwogICAgICBQLmRpdmlkZWRCeSA9IFAuZGl2ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gZGl2aWRlKHRoaXMsIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHkyKSk7CiAgICAgIH07CiAgICAgIFAuZGl2aWRlZFRvSW50ZWdlckJ5ID0gUC5pZGl2ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgcmV0dXJuIHJvdW5kKGRpdmlkZSh4MiwgbmV3IEN0b3IoeTIpLCAwLCAxKSwgQ3Rvci5wcmVjaXNpb24pOwogICAgICB9OwogICAgICBQLmVxdWFscyA9IFAuZXEgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiAhdGhpcy5jbXAoeTIpOwogICAgICB9OwogICAgICBQLmV4cG9uZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldEJhc2UxMEV4cG9uZW50KHRoaXMpOwogICAgICB9OwogICAgICBQLmdyZWF0ZXJUaGFuID0gUC5ndCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA+IDA7CiAgICAgIH07CiAgICAgIFAuZ3JlYXRlclRoYW5PckVxdWFsVG8gPSBQLmd0ZSA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA+PSAwOwogICAgICB9OwogICAgICBQLmlzSW50ZWdlciA9IFAuaXNpbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5lID4gdGhpcy5kLmxlbmd0aCAtIDI7CiAgICAgIH07CiAgICAgIFAuaXNOZWdhdGl2ZSA9IFAuaXNuZWcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zIDwgMDsKICAgICAgfTsKICAgICAgUC5pc1Bvc2l0aXZlID0gUC5pc3BvcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnMgPiAwOwogICAgICB9OwogICAgICBQLmlzWmVybyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnMgPT09IDA7CiAgICAgIH07CiAgICAgIFAubGVzc1RoYW4gPSBQLmx0ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gdGhpcy5jbXAoeTIpIDwgMDsKICAgICAgfTsKICAgICAgUC5sZXNzVGhhbk9yRXF1YWxUbyA9IFAubHRlID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gdGhpcy5jbXAoeTIpIDwgMTsKICAgICAgfTsKICAgICAgUC5sb2dhcml0aG0gPSBQLmxvZyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICB2YXIgcjIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uLCB3cHIgPSBwciArIDU7CiAgICAgICAgaWYgKGJhc2UgPT09IHZvaWQgMCkgewogICAgICAgICAgYmFzZSA9IG5ldyBDdG9yKDEwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzZSA9IG5ldyBDdG9yKGJhc2UpOwogICAgICAgICAgaWYgKGJhc2UucyA8IDEgfHwgYmFzZS5lcShPTkUpKSB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTmFOIik7CiAgICAgICAgfQogICAgICAgIGlmICh4Mi5zIDwgMSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgKHgyLnMgPyAiTmFOIiA6ICItSW5maW5pdHkiKSk7CiAgICAgICAgaWYgKHgyLmVxKE9ORSkpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHIyID0gZGl2aWRlKGxuKHgyLCB3cHIpLCBsbihiYXNlLCB3cHIpLCB3cHIpOwogICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICByZXR1cm4gcm91bmQocjIsIHByKTsKICAgICAgfTsKICAgICAgUC5taW51cyA9IFAuc3ViID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICByZXR1cm4geDIucyA9PSB5Mi5zID8gc3VidHJhY3QoeDIsIHkyKSA6IGFkZCh4MiwgKHkyLnMgPSAteTIucywgeTIpKTsKICAgICAgfTsKICAgICAgUC5tb2R1bG8gPSBQLm1vZCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHEsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIHkyID0gbmV3IEN0b3IoeTIpOwogICAgICAgIGlmICgheTIucykgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIGlmICgheDIucykgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKHgyKSwgcHIpOwogICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgcSA9IGRpdmlkZSh4MiwgeTIsIDAsIDEpLnRpbWVzKHkyKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHgyLm1pbnVzKHEpOwogICAgICB9OwogICAgICBQLm5hdHVyYWxFeHBvbmVudGlhbCA9IFAuZXhwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGV4cCh0aGlzKTsKICAgICAgfTsKICAgICAgUC5uYXR1cmFsTG9nYXJpdGhtID0gUC5sbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBsbih0aGlzKTsKICAgICAgfTsKICAgICAgUC5uZWdhdGVkID0gUC5uZWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgeDIgPSBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzKTsKICAgICAgICB4Mi5zID0gLXgyLnMgfHwgMDsKICAgICAgICByZXR1cm4geDI7CiAgICAgIH07CiAgICAgIFAucGx1cyA9IFAuYWRkID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICByZXR1cm4geDIucyA9PSB5Mi5zID8gYWRkKHgyLCB5MikgOiBzdWJ0cmFjdCh4MiwgKHkyLnMgPSAteTIucywgeTIpKTsKICAgICAgfTsKICAgICAgUC5wcmVjaXNpb24gPSBQLnNkID0gZnVuY3Rpb24oeikgewogICAgICAgIHZhciBlLCBzZCwgdywgeDIgPSB0aGlzOwogICAgICAgIGlmICh6ICE9PSB2b2lkIDAgJiYgeiAhPT0gISF6ICYmIHogIT09IDEgJiYgeiAhPT0gMCkgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgeik7CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKSArIDE7CiAgICAgICAgdyA9IHgyLmQubGVuZ3RoIC0gMTsKICAgICAgICBzZCA9IHcgKiBMT0dfQkFTRSArIDE7CiAgICAgICAgdyA9IHgyLmRbd107CiAgICAgICAgaWYgKHcpIHsKICAgICAgICAgIGZvciAoOyB3ICUgMTAgPT0gMDsgdyAvPSAxMCkgc2QtLTsKICAgICAgICAgIGZvciAodyA9IHgyLmRbMF07IHcgPj0gMTA7IHcgLz0gMTApIHNkKys7CiAgICAgICAgfQogICAgICAgIHJldHVybiB6ICYmIGUgPiBzZCA/IGUgOiBzZDsKICAgICAgfTsKICAgICAgUC5zcXVhcmVSb290ID0gUC5zcXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGUsIG4sIHByLCByMiwgczIsIHQsIHdwciwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHgyLnMgPCAxKSB7CiAgICAgICAgICBpZiAoIXgyLnMpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICAgIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICB9CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHMyID0gTWF0aC5zcXJ0KCt4Mik7CiAgICAgICAgaWYgKHMyID09IDAgfHwgczIgPT0gMSAvIDApIHsKICAgICAgICAgIG4gPSBkaWdpdHNUb1N0cmluZyh4Mi5kKTsKICAgICAgICAgIGlmICgobi5sZW5ndGggKyBlKSAlIDIgPT0gMCkgbiArPSAiMCI7CiAgICAgICAgICBzMiA9IE1hdGguc3FydChuKTsKICAgICAgICAgIGUgPSBtYXRoZmxvb3IoKGUgKyAxKSAvIDIpIC0gKGUgPCAwIHx8IGUgJSAyKTsKICAgICAgICAgIGlmIChzMiA9PSAxIC8gMCkgewogICAgICAgICAgICBuID0gIjVlIiArIGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuID0gczIudG9FeHBvbmVudGlhbCgpOwogICAgICAgICAgICBuID0gbi5zbGljZSgwLCBuLmluZGV4T2YoImUiKSArIDEpICsgZTsKICAgICAgICAgIH0KICAgICAgICAgIHIyID0gbmV3IEN0b3Iobik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHIyID0gbmV3IEN0b3IoczIudG9TdHJpbmcoKSk7CiAgICAgICAgfQogICAgICAgIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgczIgPSB3cHIgPSBwciArIDM7CiAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICB0ID0gcjI7CiAgICAgICAgICByMiA9IHQucGx1cyhkaXZpZGUoeDIsIHQsIHdwciArIDIpKS50aW1lcygwLjUpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gKG4gPSBkaWdpdHNUb1N0cmluZyhyMi5kKSkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICBuID0gbi5zbGljZSh3cHIgLSAzLCB3cHIgKyAxKTsKICAgICAgICAgICAgaWYgKHMyID09IHdwciAmJiBuID09ICI0OTk5IikgewogICAgICAgICAgICAgIHJvdW5kKHQsIHByICsgMSwgMCk7CiAgICAgICAgICAgICAgaWYgKHQudGltZXModCkuZXEoeDIpKSB7CiAgICAgICAgICAgICAgICByMiA9IHQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobiAhPSAiOTk5OSIpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cHIgKz0gNDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiByb3VuZChyMiwgcHIpOwogICAgICB9OwogICAgICBQLnRpbWVzID0gUC5tdWwgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBjYXJyeSwgZSwgaSwgazIsIHIyLCByTCwgdCwgeGRMLCB5ZEwsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCB4ZCA9IHgyLmQsIHlkID0gKHkyID0gbmV3IEN0b3IoeTIpKS5kOwogICAgICAgIGlmICgheDIucyB8fCAheTIucykgcmV0dXJuIG5ldyBDdG9yKDApOwogICAgICAgIHkyLnMgKj0geDIuczsKICAgICAgICBlID0geDIuZSArIHkyLmU7CiAgICAgICAgeGRMID0geGQubGVuZ3RoOwogICAgICAgIHlkTCA9IHlkLmxlbmd0aDsKICAgICAgICBpZiAoeGRMIDwgeWRMKSB7CiAgICAgICAgICByMiA9IHhkOwogICAgICAgICAgeGQgPSB5ZDsKICAgICAgICAgIHlkID0gcjI7CiAgICAgICAgICByTCA9IHhkTDsKICAgICAgICAgIHhkTCA9IHlkTDsKICAgICAgICAgIHlkTCA9IHJMOwogICAgICAgIH0KICAgICAgICByMiA9IFtdOwogICAgICAgIHJMID0geGRMICsgeWRMOwogICAgICAgIGZvciAoaSA9IHJMOyBpLS07ICkgcjIucHVzaCgwKTsKICAgICAgICBmb3IgKGkgPSB5ZEw7IC0taSA+PSAwOyApIHsKICAgICAgICAgIGNhcnJ5ID0gMDsKICAgICAgICAgIGZvciAoazIgPSB4ZEwgKyBpOyBrMiA+IGk7ICkgewogICAgICAgICAgICB0ID0gcjJbazJdICsgeWRbaV0gKiB4ZFtrMiAtIGkgLSAxXSArIGNhcnJ5OwogICAgICAgICAgICByMltrMi0tXSA9IHQgJSBCQVNFIHwgMDsKICAgICAgICAgICAgY2FycnkgPSB0IC8gQkFTRSB8IDA7CiAgICAgICAgICB9CiAgICAgICAgICByMltrMl0gPSAocjJbazJdICsgY2FycnkpICUgQkFTRSB8IDA7CiAgICAgICAgfQogICAgICAgIGZvciAoOyAhcjJbLS1yTF07ICkgcjIucG9wKCk7CiAgICAgICAgaWYgKGNhcnJ5KSArK2U7CiAgICAgICAgZWxzZSByMi5zaGlmdCgpOwogICAgICAgIHkyLmQgPSByMjsKICAgICAgICB5Mi5lID0gZTsKICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgQ3Rvci5wcmVjaXNpb24pIDogeTI7CiAgICAgIH07CiAgICAgIFAudG9EZWNpbWFsUGxhY2VzID0gUC50b2RwID0gZnVuY3Rpb24oZHAsIHJtKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHgyID0gbmV3IEN0b3IoeDIpOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSByZXR1cm4geDI7CiAgICAgICAgY2hlY2tJbnQzMihkcCwgMCwgTUFYX0RJR0lUUyk7CiAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgIHJldHVybiByb3VuZCh4MiwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBybSk7CiAgICAgIH07CiAgICAgIFAudG9FeHBvbmVudGlhbCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciBzdHIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBzdHIgPSB0b1N0cmluZyh4MiwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgICB4MiA9IHJvdW5kKG5ldyBDdG9yKHgyKSwgZHAgKyAxLCBybSk7CiAgICAgICAgICBzdHIgPSB0b1N0cmluZyh4MiwgdHJ1ZSwgZHAgKyAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgUC50b0ZpeGVkID0gZnVuY3Rpb24oZHAsIHJtKSB7CiAgICAgICAgdmFyIHN0ciwgeTIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSByZXR1cm4gdG9TdHJpbmcoeDIpOwogICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICB5MiA9IHJvdW5kKG5ldyBDdG9yKHgyKSwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBybSk7CiAgICAgICAgc3RyID0gdG9TdHJpbmcoeTIuYWJzKCksIGZhbHNlLCBkcCArIGdldEJhc2UxMEV4cG9uZW50KHkyKSArIDEpOwogICAgICAgIHJldHVybiB4Mi5pc25lZygpICYmICF4Mi5pc1plcm8oKSA/ICItIiArIHN0ciA6IHN0cjsKICAgICAgfTsKICAgICAgUC50b0ludGVnZXIgPSBQLnRvaW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIGdldEJhc2UxMEV4cG9uZW50KHgyKSArIDEsIEN0b3Iucm91bmRpbmcpOwogICAgICB9OwogICAgICBQLnRvTnVtYmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICt0aGlzOwogICAgICB9OwogICAgICBQLnRvUG93ZXIgPSBQLnBvdyA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIGUsIGsyLCBwciwgcjIsIHNpZ24yLCB5SXNJbnQsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBndWFyZCA9IDEyLCB5biA9ICsoeTIgPSBuZXcgQ3Rvcih5MikpOwogICAgICAgIGlmICgheTIucykgcmV0dXJuIG5ldyBDdG9yKE9ORSk7CiAgICAgICAgeDIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgaWYgKCF4Mi5zKSB7CiAgICAgICAgICBpZiAoeTIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJJbmZpbml0eSIpOwogICAgICAgICAgcmV0dXJuIHgyOwogICAgICAgIH0KICAgICAgICBpZiAoeDIuZXEoT05FKSkgcmV0dXJuIHgyOwogICAgICAgIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKHkyLmVxKE9ORSkpIHJldHVybiByb3VuZCh4MiwgcHIpOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIGsyID0geTIuZC5sZW5ndGggLSAxOwogICAgICAgIHlJc0ludCA9IGUgPj0gazI7CiAgICAgICAgc2lnbjIgPSB4Mi5zOwogICAgICAgIGlmICgheUlzSW50KSB7CiAgICAgICAgICBpZiAoc2lnbjIgPCAwKSB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTmFOIik7CiAgICAgICAgfSBlbHNlIGlmICgoazIgPSB5biA8IDAgPyAteW4gOiB5bikgPD0gTUFYX1NBRkVfSU5URUdFUikgewogICAgICAgICAgcjIgPSBuZXcgQ3RvcihPTkUpOwogICAgICAgICAgZSA9IE1hdGguY2VpbChwciAvIExPR19CQVNFICsgNCk7CiAgICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgIGlmIChrMiAlIDIpIHsKICAgICAgICAgICAgICByMiA9IHIyLnRpbWVzKHgyKTsKICAgICAgICAgICAgICB0cnVuY2F0ZShyMi5kLCBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBrMiA9IG1hdGhmbG9vcihrMiAvIDIpOwogICAgICAgICAgICBpZiAoazIgPT09IDApIGJyZWFrOwogICAgICAgICAgICB4MiA9IHgyLnRpbWVzKHgyKTsKICAgICAgICAgICAgdHJ1bmNhdGUoeDIuZCwgZSk7CiAgICAgICAgICB9CiAgICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICByZXR1cm4geTIucyA8IDAgPyBuZXcgQ3RvcihPTkUpLmRpdihyMikgOiByb3VuZChyMiwgcHIpOwogICAgICAgIH0KICAgICAgICBzaWduMiA9IHNpZ24yIDwgMCAmJiB5Mi5kW01hdGgubWF4KGUsIGsyKV0gJiAxID8gLTEgOiAxOwogICAgICAgIHgyLnMgPSAxOwogICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgcjIgPSB5Mi50aW1lcyhsbih4MiwgcHIgKyBndWFyZCkpOwogICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICByMiA9IGV4cChyMik7CiAgICAgICAgcjIucyA9IHNpZ24yOwogICAgICAgIHJldHVybiByMjsKICAgICAgfTsKICAgICAgUC50b1ByZWNpc2lvbiA9IGZ1bmN0aW9uKHNkLCBybSkgewogICAgICAgIHZhciBlLCBzdHIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChzZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIGUgPD0gQ3Rvci50b0V4cE5lZyB8fCBlID49IEN0b3IudG9FeHBQb3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja0ludDMyKHNkLCAxLCBNQVhfRElHSVRTKTsKICAgICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgICAgeDIgPSByb3VuZChuZXcgQ3Rvcih4MiksIHNkLCBybSk7CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHNkIDw9IGUgfHwgZSA8PSBDdG9yLnRvRXhwTmVnLCBzZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9TaWduaWZpY2FudERpZ2l0cyA9IFAudG9zZCA9IGZ1bmN0aW9uKHNkLCBybSkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoc2QgPT09IHZvaWQgMCkgewogICAgICAgICAgc2QgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICAgIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2tJbnQzMihzZCwgMSwgTUFYX0RJR0lUUyk7CiAgICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKHgyKSwgc2QsIHJtKTsKICAgICAgfTsKICAgICAgUC50b1N0cmluZyA9IFAudmFsdWVPZiA9IFAudmFsID0gUC50b0pTT04gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nKHgyLCBlIDw9IEN0b3IudG9FeHBOZWcgfHwgZSA+PSBDdG9yLnRvRXhwUG9zKTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gYWRkKHgyLCB5MikgewogICAgICAgIHZhciBjYXJyeSwgZCwgZSwgaSwgazIsIGxlbiwgeGQsIHlkLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSB7CiAgICAgICAgICBpZiAoIXkyLnMpIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGsyID0geDIuZTsKICAgICAgICBlID0geTIuZTsKICAgICAgICB4ZCA9IHhkLnNsaWNlKCk7CiAgICAgICAgaSA9IGsyIC0gZTsKICAgICAgICBpZiAoaSkgewogICAgICAgICAgaWYgKGkgPCAwKSB7CiAgICAgICAgICAgIGQgPSB4ZDsKICAgICAgICAgICAgaSA9IC1pOwogICAgICAgICAgICBsZW4gPSB5ZC5sZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkID0geWQ7CiAgICAgICAgICAgIGUgPSBrMjsKICAgICAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgazIgPSBNYXRoLmNlaWwocHIgLyBMT0dfQkFTRSk7CiAgICAgICAgICBsZW4gPSBrMiA+IGxlbiA/IGsyICsgMSA6IGxlbiArIDE7CiAgICAgICAgICBpZiAoaSA+IGxlbikgewogICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBkLmxlbmd0aCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICAgIGZvciAoOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBpID0geWQubGVuZ3RoOwogICAgICAgIGlmIChsZW4gLSBpIDwgMCkgewogICAgICAgICAgaSA9IGxlbjsKICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgIHlkID0geGQ7CiAgICAgICAgICB4ZCA9IGQ7CiAgICAgICAgfQogICAgICAgIGZvciAoY2FycnkgPSAwOyBpOyApIHsKICAgICAgICAgIGNhcnJ5ID0gKHhkWy0taV0gPSB4ZFtpXSArIHlkW2ldICsgY2FycnkpIC8gQkFTRSB8IDA7CiAgICAgICAgICB4ZFtpXSAlPSBCQVNFOwogICAgICAgIH0KICAgICAgICBpZiAoY2FycnkpIHsKICAgICAgICAgIHhkLnVuc2hpZnQoY2FycnkpOwogICAgICAgICAgKytlOwogICAgICAgIH0KICAgICAgICBmb3IgKGxlbiA9IHhkLmxlbmd0aDsgeGRbLS1sZW5dID09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgeTIuZCA9IHhkOwogICAgICAgIHkyLmUgPSBlOwogICAgICAgIHJldHVybiBleHRlcm5hbCA/IHJvdW5kKHkyLCBwcikgOiB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0ludDMyKGksIG1pbjIsIG1heDIpIHsKICAgICAgICBpZiAoaSAhPT0gfn5pIHx8IGkgPCBtaW4yIHx8IGkgPiBtYXgyKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyBpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZGlnaXRzVG9TdHJpbmcoZCkgewogICAgICAgIHZhciBpLCBrMiwgd3MsIGluZGV4T2ZMYXN0V29yZCA9IGQubGVuZ3RoIC0gMSwgc3RyID0gIiIsIHcgPSBkWzBdOwogICAgICAgIGlmIChpbmRleE9mTGFzdFdvcmQgPiAwKSB7CiAgICAgICAgICBzdHIgKz0gdzsKICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBpbmRleE9mTGFzdFdvcmQ7IGkrKykgewogICAgICAgICAgICB3cyA9IGRbaV0gKyAiIjsKICAgICAgICAgICAgazIgPSBMT0dfQkFTRSAtIHdzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGsyKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrMik7CiAgICAgICAgICAgIHN0ciArPSB3czsKICAgICAgICAgIH0KICAgICAgICAgIHcgPSBkW2ldOwogICAgICAgICAgd3MgPSB3ICsgIiI7CiAgICAgICAgICBrMiA9IExPR19CQVNFIC0gd3MubGVuZ3RoOwogICAgICAgICAgaWYgKGsyKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrMik7CiAgICAgICAgfSBlbHNlIGlmICh3ID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gIjAiOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgdyAlIDEwID09PSAwOyApIHcgLz0gMTA7CiAgICAgICAgcmV0dXJuIHN0ciArIHc7CiAgICAgIH0KICAgICAgdmFyIGRpdmlkZSA9IC8qIEBfX1BVUkVfXyAqLyBmdW5jdGlvbigpIHsKICAgICAgICBmdW5jdGlvbiBtdWx0aXBseUludGVnZXIoeDIsIGsyKSB7CiAgICAgICAgICB2YXIgdGVtcCwgY2FycnkgPSAwLCBpID0geDIubGVuZ3RoOwogICAgICAgICAgZm9yICh4MiA9IHgyLnNsaWNlKCk7IGktLTsgKSB7CiAgICAgICAgICAgIHRlbXAgPSB4MltpXSAqIGsyICsgY2Fycnk7CiAgICAgICAgICAgIHgyW2ldID0gdGVtcCAlIEJBU0UgfCAwOwogICAgICAgICAgICBjYXJyeSA9IHRlbXAgLyBCQVNFIHwgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYXJyeSkgeDIudW5zaGlmdChjYXJyeSk7CiAgICAgICAgICByZXR1cm4geDI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUoYTIsIGIsIGFMLCBiTCkgewogICAgICAgICAgdmFyIGksIHIyOwogICAgICAgICAgaWYgKGFMICE9IGJMKSB7CiAgICAgICAgICAgIHIyID0gYUwgPiBiTCA/IDEgOiAtMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAoaSA9IHIyID0gMDsgaSA8IGFMOyBpKyspIHsKICAgICAgICAgICAgICBpZiAoYTJbaV0gIT0gYltpXSkgewogICAgICAgICAgICAgICAgcjIgPSBhMltpXSA+IGJbaV0gPyAxIDogLTE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3VidHJhY3QyKGEyLCBiLCBhTCkgewogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGFMLS07ICkgewogICAgICAgICAgICBhMlthTF0gLT0gaTsKICAgICAgICAgICAgaSA9IGEyW2FMXSA8IGJbYUxdID8gMSA6IDA7CiAgICAgICAgICAgIGEyW2FMXSA9IGkgKiBCQVNFICsgYTJbYUxdIC0gYlthTF07CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKDsgIWEyWzBdICYmIGEyLmxlbmd0aCA+IDE7ICkgYTIuc2hpZnQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHgyLCB5MiwgcHIsIGRwKSB7CiAgICAgICAgICB2YXIgY21wLCBlLCBpLCBrMiwgcHJvZCwgcHJvZEwsIHEsIHFkLCByZW0sIHJlbUwsIHJlbTAsIHNkLCB0LCB4aSwgeEwsIHlkMCwgeUwsIHl6LCBDdG9yID0geDIuY29uc3RydWN0b3IsIHNpZ24yID0geDIucyA9PSB5Mi5zID8gMSA6IC0xLCB4ZCA9IHgyLmQsIHlkID0geTIuZDsKICAgICAgICAgIGlmICgheDIucykgcmV0dXJuIG5ldyBDdG9yKHgyKTsKICAgICAgICAgIGlmICgheTIucykgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIkRpdmlzaW9uIGJ5IHplcm8iKTsKICAgICAgICAgIGUgPSB4Mi5lIC0geTIuZTsKICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgeEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBxID0gbmV3IEN0b3Ioc2lnbjIpOwogICAgICAgICAgcWQgPSBxLmQgPSBbXTsKICAgICAgICAgIGZvciAoaSA9IDA7IHlkW2ldID09ICh4ZFtpXSB8fCAwKTsgKSArK2k7CiAgICAgICAgICBpZiAoeWRbaV0gPiAoeGRbaV0gfHwgMCkpIC0tZTsKICAgICAgICAgIGlmIChwciA9PSBudWxsKSB7CiAgICAgICAgICAgIHNkID0gcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICAgIH0gZWxzZSBpZiAoZHApIHsKICAgICAgICAgICAgc2QgPSBwciArIChnZXRCYXNlMTBFeHBvbmVudCh4MikgLSBnZXRCYXNlMTBFeHBvbmVudCh5MikpICsgMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNkID0gcHI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2QgPCAwKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgICBzZCA9IHNkIC8gTE9HX0JBU0UgKyAyIHwgMDsKICAgICAgICAgIGkgPSAwOwogICAgICAgICAgaWYgKHlMID09IDEpIHsKICAgICAgICAgICAgazIgPSAwOwogICAgICAgICAgICB5ZCA9IHlkWzBdOwogICAgICAgICAgICBzZCsrOwogICAgICAgICAgICBmb3IgKDsgKGkgPCB4TCB8fCBrMikgJiYgc2QtLTsgaSsrKSB7CiAgICAgICAgICAgICAgdCA9IGsyICogQkFTRSArICh4ZFtpXSB8fCAwKTsKICAgICAgICAgICAgICBxZFtpXSA9IHQgLyB5ZCB8IDA7CiAgICAgICAgICAgICAgazIgPSB0ICUgeWQgfCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrMiA9IEJBU0UgLyAoeWRbMF0gKyAxKSB8IDA7CiAgICAgICAgICAgIGlmIChrMiA+IDEpIHsKICAgICAgICAgICAgICB5ZCA9IG11bHRpcGx5SW50ZWdlcih5ZCwgazIpOwogICAgICAgICAgICAgIHhkID0gbXVsdGlwbHlJbnRlZ2VyKHhkLCBrMik7CiAgICAgICAgICAgICAgeUwgPSB5ZC5sZW5ndGg7CiAgICAgICAgICAgICAgeEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeGkgPSB5TDsKICAgICAgICAgICAgcmVtID0geGQuc2xpY2UoMCwgeUwpOwogICAgICAgICAgICByZW1MID0gcmVtLmxlbmd0aDsKICAgICAgICAgICAgZm9yICg7IHJlbUwgPCB5TDsgKSByZW1bcmVtTCsrXSA9IDA7CiAgICAgICAgICAgIHl6ID0geWQuc2xpY2UoKTsKICAgICAgICAgICAgeXoudW5zaGlmdCgwKTsKICAgICAgICAgICAgeWQwID0geWRbMF07CiAgICAgICAgICAgIGlmICh5ZFsxXSA+PSBCQVNFIC8gMikgKyt5ZDA7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBrMiA9IDA7CiAgICAgICAgICAgICAgY21wID0gY29tcGFyZSh5ZCwgcmVtLCB5TCwgcmVtTCk7CiAgICAgICAgICAgICAgaWYgKGNtcCA8IDApIHsKICAgICAgICAgICAgICAgIHJlbTAgPSByZW1bMF07CiAgICAgICAgICAgICAgICBpZiAoeUwgIT0gcmVtTCkgcmVtMCA9IHJlbTAgKiBCQVNFICsgKHJlbVsxXSB8fCAwKTsKICAgICAgICAgICAgICAgIGsyID0gcmVtMCAvIHlkMCB8IDA7CiAgICAgICAgICAgICAgICBpZiAoazIgPiAxKSB7CiAgICAgICAgICAgICAgICAgIGlmIChrMiA+PSBCQVNFKSBrMiA9IEJBU0UgLSAxOwogICAgICAgICAgICAgICAgICBwcm9kID0gbXVsdGlwbHlJbnRlZ2VyKHlkLCBrMik7CiAgICAgICAgICAgICAgICAgIHByb2RMID0gcHJvZC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHByb2QsIHJlbSwgcHJvZEwsIHJlbUwpOwogICAgICAgICAgICAgICAgICBpZiAoY21wID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBrMi0tOwogICAgICAgICAgICAgICAgICAgIHN1YnRyYWN0Mihwcm9kLCB5TCA8IHByb2RMID8geXogOiB5ZCwgcHJvZEwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoazIgPT0gMCkgY21wID0gazIgPSAxOwogICAgICAgICAgICAgICAgICBwcm9kID0geWQuc2xpY2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByb2RMID0gcHJvZC5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAocHJvZEwgPCByZW1MKSBwcm9kLnVuc2hpZnQoMCk7CiAgICAgICAgICAgICAgICBzdWJ0cmFjdDIocmVtLCBwcm9kLCByZW1MKTsKICAgICAgICAgICAgICAgIGlmIChjbXAgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGNtcCA9IGNvbXBhcmUoeWQsIHJlbSwgeUwsIHJlbUwpOwogICAgICAgICAgICAgICAgICBpZiAoY21wIDwgMSkgewogICAgICAgICAgICAgICAgICAgIGsyKys7CiAgICAgICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgeUwgPCByZW1MID8geXogOiB5ZCwgcmVtTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoY21wID09PSAwKSB7CiAgICAgICAgICAgICAgICBrMisrOwogICAgICAgICAgICAgICAgcmVtID0gWzBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxZFtpKytdID0gazI7CiAgICAgICAgICAgICAgaWYgKGNtcCAmJiByZW1bMF0pIHsKICAgICAgICAgICAgICAgIHJlbVtyZW1MKytdID0geGRbeGldIHx8IDA7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlbSA9IFt4ZFt4aV1dOwogICAgICAgICAgICAgICAgcmVtTCA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlICgoeGkrKyA8IHhMIHx8IHJlbVswXSAhPT0gdm9pZCAwKSAmJiBzZC0tKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcWRbMF0pIHFkLnNoaWZ0KCk7CiAgICAgICAgICBxLmUgPSBlOwogICAgICAgICAgcmV0dXJuIHJvdW5kKHEsIGRwID8gcHIgKyBnZXRCYXNlMTBFeHBvbmVudChxKSArIDEgOiBwcik7CiAgICAgICAgfTsKICAgICAgfSgpOwogICAgICBmdW5jdGlvbiBleHAoeDIsIHNkKSB7CiAgICAgICAgdmFyIGRlbm9taW5hdG9yLCBndWFyZCwgcG93Miwgc3VtLCB0LCB3cHIsIGkgPSAwLCBrMiA9IDAsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoZ2V0QmFzZTEwRXhwb25lbnQoeDIpID4gMTYpIHRocm93IEVycm9yKGV4cG9uZW50T3V0T2ZSYW5nZSArIGdldEJhc2UxMEV4cG9uZW50KHgyKSk7CiAgICAgICAgaWYgKCF4Mi5zKSByZXR1cm4gbmV3IEN0b3IoT05FKTsKICAgICAgICBpZiAoc2QgPT0gbnVsbCkgewogICAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICAgIHdwciA9IHByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3cHIgPSBzZDsKICAgICAgICB9CiAgICAgICAgdCA9IG5ldyBDdG9yKDAuMDMxMjUpOwogICAgICAgIHdoaWxlICh4Mi5hYnMoKS5ndGUoMC4xKSkgewogICAgICAgICAgeDIgPSB4Mi50aW1lcyh0KTsKICAgICAgICAgIGsyICs9IDU7CiAgICAgICAgfQogICAgICAgIGd1YXJkID0gTWF0aC5sb2cobWF0aHBvdygyLCBrMikpIC8gTWF0aC5MTjEwICogMiArIDUgfCAwOwogICAgICAgIHdwciArPSBndWFyZDsKICAgICAgICBkZW5vbWluYXRvciA9IHBvdzIgPSBzdW0gPSBuZXcgQ3RvcihPTkUpOwogICAgICAgIEN0b3IucHJlY2lzaW9uID0gd3ByOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgcG93MiA9IHJvdW5kKHBvdzIudGltZXMoeDIpLCB3cHIpOwogICAgICAgICAgZGVub21pbmF0b3IgPSBkZW5vbWluYXRvci50aW1lcygrK2kpOwogICAgICAgICAgdCA9IHN1bS5wbHVzKGRpdmlkZShwb3cyLCBkZW5vbWluYXRvciwgd3ByKSk7CiAgICAgICAgICBpZiAoZGlnaXRzVG9TdHJpbmcodC5kKS5zbGljZSgwLCB3cHIpID09PSBkaWdpdHNUb1N0cmluZyhzdW0uZCkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICB3aGlsZSAoazItLSkgc3VtID0gcm91bmQoc3VtLnRpbWVzKHN1bSksIHdwcik7CiAgICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICAgIHJldHVybiBzZCA9PSBudWxsID8gKGV4dGVybmFsID0gdHJ1ZSwgcm91bmQoc3VtLCBwcikpIDogc3VtOwogICAgICAgICAgfQogICAgICAgICAgc3VtID0gdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0QmFzZTEwRXhwb25lbnQoeDIpIHsKICAgICAgICB2YXIgZSA9IHgyLmUgKiBMT0dfQkFTRSwgdyA9IHgyLmRbMF07CiAgICAgICAgZm9yICg7IHcgPj0gMTA7IHcgLz0gMTApIGUrKzsKICAgICAgICByZXR1cm4gZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRMbjEwKEN0b3IsIHNkLCBwcikgewogICAgICAgIGlmIChzZCA+IEN0b3IuTE4xMC5zZCgpKSB7CiAgICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICBpZiAocHIpIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTE4xMCBwcmVjaXNpb24gbGltaXQgZXhjZWVkZWQiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKEN0b3IuTE4xMCksIHNkKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRaZXJvU3RyaW5nKGsyKSB7CiAgICAgICAgdmFyIHpzID0gIiI7CiAgICAgICAgZm9yICg7IGsyLS07ICkgenMgKz0gIjAiOwogICAgICAgIHJldHVybiB6czsKICAgICAgfQogICAgICBmdW5jdGlvbiBsbih5Miwgc2QpIHsKICAgICAgICB2YXIgYzIsIGMwLCBkZW5vbWluYXRvciwgZSwgbnVtZXJhdG9yLCBzdW0sIHQsIHdwciwgeDIsIG4gPSAxLCBndWFyZCA9IDEwLCB4MyA9IHkyLCB4ZCA9IHgzLmQsIEN0b3IgPSB4My5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoeDMucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4My5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4My5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgaWYgKHNkID09IG51bGwpIHsKICAgICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgICB3cHIgPSBwcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd3ByID0gc2Q7CiAgICAgICAgfQogICAgICAgIGlmICh4My5lcSgxMCkpIHsKICAgICAgICAgIGlmIChzZCA9PSBudWxsKSBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICByZXR1cm4gZ2V0TG4xMChDdG9yLCB3cHIpOwogICAgICAgIH0KICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgQ3Rvci5wcmVjaXNpb24gPSB3cHI7CiAgICAgICAgYzIgPSBkaWdpdHNUb1N0cmluZyh4ZCk7CiAgICAgICAgYzAgPSBjMi5jaGFyQXQoMCk7CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgzKTsKICAgICAgICBpZiAoTWF0aC5hYnMoZSkgPCAxNWUxNCkgewogICAgICAgICAgd2hpbGUgKGMwIDwgNyAmJiBjMCAhPSAxIHx8IGMwID09IDEgJiYgYzIuY2hhckF0KDEpID4gMykgewogICAgICAgICAgICB4MyA9IHgzLnRpbWVzKHkyKTsKICAgICAgICAgICAgYzIgPSBkaWdpdHNUb1N0cmluZyh4My5kKTsKICAgICAgICAgICAgYzAgPSBjMi5jaGFyQXQoMCk7CiAgICAgICAgICAgIG4rKzsKICAgICAgICAgIH0KICAgICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4Myk7CiAgICAgICAgICBpZiAoYzAgPiAxKSB7CiAgICAgICAgICAgIHgzID0gbmV3IEN0b3IoIjAuIiArIGMyKTsKICAgICAgICAgICAgZSsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeDMgPSBuZXcgQ3RvcihjMCArICIuIiArIGMyLnNsaWNlKDEpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdCA9IGdldExuMTAoQ3Rvciwgd3ByICsgMiwgcHIpLnRpbWVzKGUgKyAiIik7CiAgICAgICAgICB4MyA9IGxuKG5ldyBDdG9yKGMwICsgIi4iICsgYzIuc2xpY2UoMSkpLCB3cHIgLSBndWFyZCkucGx1cyh0KTsKICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICByZXR1cm4gc2QgPT0gbnVsbCA/IChleHRlcm5hbCA9IHRydWUsIHJvdW5kKHgzLCBwcikpIDogeDM7CiAgICAgICAgfQogICAgICAgIHN1bSA9IG51bWVyYXRvciA9IHgzID0gZGl2aWRlKHgzLm1pbnVzKE9ORSksIHgzLnBsdXMoT05FKSwgd3ByKTsKICAgICAgICB4MiA9IHJvdW5kKHgzLnRpbWVzKHgzKSwgd3ByKTsKICAgICAgICBkZW5vbWluYXRvciA9IDM7CiAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICBudW1lcmF0b3IgPSByb3VuZChudW1lcmF0b3IudGltZXMoeDIpLCB3cHIpOwogICAgICAgICAgdCA9IHN1bS5wbHVzKGRpdmlkZShudW1lcmF0b3IsIG5ldyBDdG9yKGRlbm9taW5hdG9yKSwgd3ByKSk7CiAgICAgICAgICBpZiAoZGlnaXRzVG9TdHJpbmcodC5kKS5zbGljZSgwLCB3cHIpID09PSBkaWdpdHNUb1N0cmluZyhzdW0uZCkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICBzdW0gPSBzdW0udGltZXMoMik7CiAgICAgICAgICAgIGlmIChlICE9PSAwKSBzdW0gPSBzdW0ucGx1cyhnZXRMbjEwKEN0b3IsIHdwciArIDIsIHByKS50aW1lcyhlICsgIiIpKTsKICAgICAgICAgICAgc3VtID0gZGl2aWRlKHN1bSwgbmV3IEN0b3IobiksIHdwcik7CiAgICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICAgIHJldHVybiBzZCA9PSBudWxsID8gKGV4dGVybmFsID0gdHJ1ZSwgcm91bmQoc3VtLCBwcikpIDogc3VtOwogICAgICAgICAgfQogICAgICAgICAgc3VtID0gdDsKICAgICAgICAgIGRlbm9taW5hdG9yICs9IDI7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRGVjaW1hbCh4Miwgc3RyKSB7CiAgICAgICAgdmFyIGUsIGksIGxlbjsKICAgICAgICBpZiAoKGUgPSBzdHIuaW5kZXhPZigiLiIpKSA+IC0xKSBzdHIgPSBzdHIucmVwbGFjZSgiLiIsICIiKTsKICAgICAgICBpZiAoKGkgPSBzdHIuc2VhcmNoKC9lL2kpKSA+IDApIHsKICAgICAgICAgIGlmIChlIDwgMCkgZSA9IGk7CiAgICAgICAgICBlICs9ICtzdHIuc2xpY2UoaSArIDEpOwogICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygwLCBpKTsKICAgICAgICB9IGVsc2UgaWYgKGUgPCAwKSB7CiAgICAgICAgICBlID0gc3RyLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgc3RyLmNoYXJDb2RlQXQoaSkgPT09IDQ4OyApICsraTsKICAgICAgICBmb3IgKGxlbiA9IHN0ci5sZW5ndGg7IHN0ci5jaGFyQ29kZUF0KGxlbiAtIDEpID09PSA0ODsgKSAtLWxlbjsKICAgICAgICBzdHIgPSBzdHIuc2xpY2UoaSwgbGVuKTsKICAgICAgICBpZiAoc3RyKSB7CiAgICAgICAgICBsZW4gLT0gaTsKICAgICAgICAgIGUgPSBlIC0gaSAtIDE7CiAgICAgICAgICB4Mi5lID0gbWF0aGZsb29yKGUgLyBMT0dfQkFTRSk7CiAgICAgICAgICB4Mi5kID0gW107CiAgICAgICAgICBpID0gKGUgKyAxKSAlIExPR19CQVNFOwogICAgICAgICAgaWYgKGUgPCAwKSBpICs9IExPR19CQVNFOwogICAgICAgICAgaWYgKGkgPCBsZW4pIHsKICAgICAgICAgICAgaWYgKGkpIHgyLmQucHVzaCgrc3RyLnNsaWNlKDAsIGkpKTsKICAgICAgICAgICAgZm9yIChsZW4gLT0gTE9HX0JBU0U7IGkgPCBsZW47ICkgeDIuZC5wdXNoKCtzdHIuc2xpY2UoaSwgaSArPSBMT0dfQkFTRSkpOwogICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoaSk7CiAgICAgICAgICAgIGkgPSBMT0dfQkFTRSAtIHN0ci5sZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpIC09IGxlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoOyBpLS07ICkgc3RyICs9ICIwIjsKICAgICAgICAgIHgyLmQucHVzaCgrc3RyKTsKICAgICAgICAgIGlmIChleHRlcm5hbCAmJiAoeDIuZSA+IE1BWF9FIHx8IHgyLmUgPCAtTUFYX0UpKSB0aHJvdyBFcnJvcihleHBvbmVudE91dE9mUmFuZ2UgKyBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeDIucyA9IDA7CiAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgIHgyLmQgPSBbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiB4MjsKICAgICAgfQogICAgICBmdW5jdGlvbiByb3VuZCh4Miwgc2QsIHJtKSB7CiAgICAgICAgdmFyIGksIGosIGsyLCBuLCByZCwgZG9Sb3VuZCwgdywgeGRpLCB4ZCA9IHgyLmQ7CiAgICAgICAgZm9yIChuID0gMSwgazIgPSB4ZFswXTsgazIgPj0gMTA7IGsyIC89IDEwKSBuKys7CiAgICAgICAgaSA9IHNkIC0gbjsKICAgICAgICBpZiAoaSA8IDApIHsKICAgICAgICAgIGkgKz0gTE9HX0JBU0U7CiAgICAgICAgICBqID0gc2Q7CiAgICAgICAgICB3ID0geGRbeGRpID0gMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHhkaSA9IE1hdGguY2VpbCgoaSArIDEpIC8gTE9HX0JBU0UpOwogICAgICAgICAgazIgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBpZiAoeGRpID49IGsyKSByZXR1cm4geDI7CiAgICAgICAgICB3ID0gazIgPSB4ZFt4ZGldOwogICAgICAgICAgZm9yIChuID0gMTsgazIgPj0gMTA7IGsyIC89IDEwKSBuKys7CiAgICAgICAgICBpICU9IExPR19CQVNFOwogICAgICAgICAgaiA9IGkgLSBMT0dfQkFTRSArIG47CiAgICAgICAgfQogICAgICAgIGlmIChybSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBrMiA9IG1hdGhwb3coMTAsIG4gLSBqIC0gMSk7CiAgICAgICAgICByZCA9IHcgLyBrMiAlIDEwIHwgMDsKICAgICAgICAgIGRvUm91bmQgPSBzZCA8IDAgfHwgeGRbeGRpICsgMV0gIT09IHZvaWQgMCB8fCB3ICUgazI7CiAgICAgICAgICBkb1JvdW5kID0gcm0gPCA0ID8gKHJkIHx8IGRvUm91bmQpICYmIChybSA9PSAwIHx8IHJtID09ICh4Mi5zIDwgMCA/IDMgOiAyKSkgOiByZCA+IDUgfHwgcmQgPT0gNSAmJiAocm0gPT0gNCB8fCBkb1JvdW5kIHx8IHJtID09IDYgJiYgLy8gQ2hlY2sgd2hldGhlciB0aGUgZGlnaXQgdG8gdGhlIGxlZnQgb2YgdGhlIHJvdW5kaW5nIGRpZ2l0IGlzIG9kZC4KICAgICAgICAgIChpID4gMCA/IGogPiAwID8gdyAvIG1hdGhwb3coMTAsIG4gLSBqKSA6IDAgOiB4ZFt4ZGkgLSAxXSkgJSAxMCAmIDEgfHwgcm0gPT0gKHgyLnMgPCAwID8gOCA6IDcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNkIDwgMSB8fCAheGRbMF0pIHsKICAgICAgICAgIGlmIChkb1JvdW5kKSB7CiAgICAgICAgICAgIGsyID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICBzZCA9IHNkIC0gazIgLSAxOwogICAgICAgICAgICB4ZFswXSA9IG1hdGhwb3coMTAsIChMT0dfQkFTRSAtIHNkICUgTE9HX0JBU0UpICUgTE9HX0JBU0UpOwogICAgICAgICAgICB4Mi5lID0gbWF0aGZsb29yKC1zZCAvIExPR19CQVNFKSB8fCAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeGQubGVuZ3RoID0gMTsKICAgICAgICAgICAgeGRbMF0gPSB4Mi5lID0geDIucyA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4geDI7CiAgICAgICAgfQogICAgICAgIGlmIChpID09IDApIHsKICAgICAgICAgIHhkLmxlbmd0aCA9IHhkaTsKICAgICAgICAgIGsyID0gMTsKICAgICAgICAgIHhkaS0tOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB4ZC5sZW5ndGggPSB4ZGkgKyAxOwogICAgICAgICAgazIgPSBtYXRocG93KDEwLCBMT0dfQkFTRSAtIGkpOwogICAgICAgICAgeGRbeGRpXSA9IGogPiAwID8gKHcgLyBtYXRocG93KDEwLCBuIC0gaikgJSBtYXRocG93KDEwLCBqKSB8IDApICogazIgOiAwOwogICAgICAgIH0KICAgICAgICBpZiAoZG9Sb3VuZCkgewogICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgIGlmICh4ZGkgPT0gMCkgewogICAgICAgICAgICAgIGlmICgoeGRbMF0gKz0gazIpID09IEJBU0UpIHsKICAgICAgICAgICAgICAgIHhkWzBdID0gMTsKICAgICAgICAgICAgICAgICsreDIuZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgeGRbeGRpXSArPSBrMjsKICAgICAgICAgICAgICBpZiAoeGRbeGRpXSAhPSBCQVNFKSBicmVhazsKICAgICAgICAgICAgICB4ZFt4ZGktLV0gPSAwOwogICAgICAgICAgICAgIGsyID0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSB4ZC5sZW5ndGg7IHhkWy0taV0gPT09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgaWYgKGV4dGVybmFsICYmICh4Mi5lID4gTUFYX0UgfHwgeDIuZSA8IC1NQVhfRSkpIHsKICAgICAgICAgIHRocm93IEVycm9yKGV4cG9uZW50T3V0T2ZSYW5nZSArIGdldEJhc2UxMEV4cG9uZW50KHgyKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB4MjsKICAgICAgfQogICAgICBmdW5jdGlvbiBzdWJ0cmFjdCh4MiwgeTIpIHsKICAgICAgICB2YXIgZCwgZSwgaSwgaiwgazIsIGxlbiwgeGQsIHhlLCB4TFR5LCB5ZCwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIGlmICgheDIucyB8fCAheTIucykgewogICAgICAgICAgaWYgKHkyLnMpIHkyLnMgPSAteTIuczsKICAgICAgICAgIGVsc2UgeTIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgICAgfQogICAgICAgIHhkID0geDIuZDsKICAgICAgICB5ZCA9IHkyLmQ7CiAgICAgICAgZSA9IHkyLmU7CiAgICAgICAgeGUgPSB4Mi5lOwogICAgICAgIHhkID0geGQuc2xpY2UoKTsKICAgICAgICBrMiA9IHhlIC0gZTsKICAgICAgICBpZiAoazIpIHsKICAgICAgICAgIHhMVHkgPSBrMiA8IDA7CiAgICAgICAgICBpZiAoeExUeSkgewogICAgICAgICAgICBkID0geGQ7CiAgICAgICAgICAgIGsyID0gLWsyOwogICAgICAgICAgICBsZW4gPSB5ZC5sZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkID0geWQ7CiAgICAgICAgICAgIGUgPSB4ZTsKICAgICAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgaSA9IE1hdGgubWF4KE1hdGguY2VpbChwciAvIExPR19CQVNFKSwgbGVuKSArIDI7CiAgICAgICAgICBpZiAoazIgPiBpKSB7CiAgICAgICAgICAgIGsyID0gaTsKICAgICAgICAgICAgZC5sZW5ndGggPSAxOwogICAgICAgICAgfQogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgICBmb3IgKGkgPSBrMjsgaS0tOyApIGQucHVzaCgwKTsKICAgICAgICAgIGQucmV2ZXJzZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpID0geGQubGVuZ3RoOwogICAgICAgICAgbGVuID0geWQubGVuZ3RoOwogICAgICAgICAgeExUeSA9IGkgPCBsZW47CiAgICAgICAgICBpZiAoeExUeSkgbGVuID0gaTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZiAoeGRbaV0gIT0geWRbaV0pIHsKICAgICAgICAgICAgICB4TFR5ID0geGRbaV0gPCB5ZFtpXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgazIgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoeExUeSkgewogICAgICAgICAgZCA9IHhkOwogICAgICAgICAgeGQgPSB5ZDsKICAgICAgICAgIHlkID0gZDsKICAgICAgICAgIHkyLnMgPSAteTIuczsKICAgICAgICB9CiAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IHlkLmxlbmd0aCAtIGxlbjsgaSA+IDA7IC0taSkgeGRbbGVuKytdID0gMDsKICAgICAgICBmb3IgKGkgPSB5ZC5sZW5ndGg7IGkgPiBrMjsgKSB7CiAgICAgICAgICBpZiAoeGRbLS1pXSA8IHlkW2ldKSB7CiAgICAgICAgICAgIGZvciAoaiA9IGk7IGogJiYgeGRbLS1qXSA9PT0gMDsgKSB4ZFtqXSA9IEJBU0UgLSAxOwogICAgICAgICAgICAtLXhkW2pdOwogICAgICAgICAgICB4ZFtpXSArPSBCQVNFOwogICAgICAgICAgfQogICAgICAgICAgeGRbaV0gLT0geWRbaV07CiAgICAgICAgfQogICAgICAgIGZvciAoOyB4ZFstLWxlbl0gPT09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgZm9yICg7IHhkWzBdID09PSAwOyB4ZC5zaGlmdCgpKSAtLWU7CiAgICAgICAgaWYgKCF4ZFswXSkgcmV0dXJuIG5ldyBDdG9yKDApOwogICAgICAgIHkyLmQgPSB4ZDsKICAgICAgICB5Mi5lID0gZTsKICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdG9TdHJpbmcoeDIsIGlzRXhwLCBzZCkgewogICAgICAgIHZhciBrMiwgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKSwgc3RyID0gZGlnaXRzVG9TdHJpbmcoeDIuZCksIGxlbiA9IHN0ci5sZW5ndGg7CiAgICAgICAgaWYgKGlzRXhwKSB7CiAgICAgICAgICBpZiAoc2QgJiYgKGsyID0gc2QgLSBsZW4pID4gMCkgewogICAgICAgICAgICBzdHIgPSBzdHIuY2hhckF0KDApICsgIi4iICsgc3RyLnNsaWNlKDEpICsgZ2V0WmVyb1N0cmluZyhrMik7CiAgICAgICAgICB9IGVsc2UgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKTsKICAgICAgICAgIH0KICAgICAgICAgIHN0ciA9IHN0ciArIChlIDwgMCA/ICJlIiA6ICJlKyIpICsgZTsKICAgICAgICB9IGVsc2UgaWYgKGUgPCAwKSB7CiAgICAgICAgICBzdHIgPSAiMC4iICsgZ2V0WmVyb1N0cmluZygtZSAtIDEpICsgc3RyOwogICAgICAgICAgaWYgKHNkICYmIChrMiA9IHNkIC0gbGVuKSA+IDApIHN0ciArPSBnZXRaZXJvU3RyaW5nKGsyKTsKICAgICAgICB9IGVsc2UgaWYgKGUgPj0gbGVuKSB7CiAgICAgICAgICBzdHIgKz0gZ2V0WmVyb1N0cmluZyhlICsgMSAtIGxlbik7CiAgICAgICAgICBpZiAoc2QgJiYgKGsyID0gc2QgLSBlIC0gMSkgPiAwKSBzdHIgPSBzdHIgKyAiLiIgKyBnZXRaZXJvU3RyaW5nKGsyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKChrMiA9IGUgKyAxKSA8IGxlbikgc3RyID0gc3RyLnNsaWNlKDAsIGsyKSArICIuIiArIHN0ci5zbGljZShrMik7CiAgICAgICAgICBpZiAoc2QgJiYgKGsyID0gc2QgLSBsZW4pID4gMCkgewogICAgICAgICAgICBpZiAoZSArIDEgPT09IGxlbikgc3RyICs9ICIuIjsKICAgICAgICAgICAgc3RyICs9IGdldFplcm9TdHJpbmcoazIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4geDIucyA8IDAgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdHJ1bmNhdGUoYXJyLCBsZW4pIHsKICAgICAgICBpZiAoYXJyLmxlbmd0aCA+IGxlbikgewogICAgICAgICAgYXJyLmxlbmd0aCA9IGxlbjsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjbG9uZShvYmopIHsKICAgICAgICB2YXIgaSwgcCwgcHM7CiAgICAgICAgZnVuY3Rpb24gRGVjaW1hbDQodmFsdWUpIHsKICAgICAgICAgIHZhciB4MiA9IHRoaXM7CiAgICAgICAgICBpZiAoISh4MiBpbnN0YW5jZW9mIERlY2ltYWw0KSkgcmV0dXJuIG5ldyBEZWNpbWFsNCh2YWx1ZSk7CiAgICAgICAgICB4Mi5jb25zdHJ1Y3RvciA9IERlY2ltYWw0OwogICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGVjaW1hbDQpIHsKICAgICAgICAgICAgeDIucyA9IHZhbHVlLnM7CiAgICAgICAgICAgIHgyLmUgPSB2YWx1ZS5lOwogICAgICAgICAgICB4Mi5kID0gKHZhbHVlID0gdmFsdWUuZCkgPyB2YWx1ZS5zbGljZSgpIDogdmFsdWU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAqIDAgIT09IDApIHsKICAgICAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID4gMCkgewogICAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIDwgMCkgewogICAgICAgICAgICAgIHZhbHVlID0gLXZhbHVlOwogICAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB4Mi5zID0gMDsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPT09IH5+dmFsdWUgJiYgdmFsdWUgPCAxZTcpIHsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gW3ZhbHVlXTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhcnNlRGVjaW1hbCh4MiwgdmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlLmNoYXJDb2RlQXQoMCkgPT09IDQ1KSB7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGVjaW1hbC50ZXN0KHZhbHVlKSkgcGFyc2VEZWNpbWFsKHgyLCB2YWx1ZSk7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQucHJvdG90eXBlID0gUDsKICAgICAgICBEZWNpbWFsNC5ST1VORF9VUCA9IDA7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRE9XTiA9IDE7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfQ0VJTCA9IDI7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRkxPT1IgPSAzOwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfVVAgPSA0OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRE9XTiA9IDU7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9FVkVOID0gNjsKICAgICAgICBEZWNpbWFsNC5ST1VORF9IQUxGX0NFSUwgPSA3OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRkxPT1IgPSA4OwogICAgICAgIERlY2ltYWw0LmNsb25lID0gY2xvbmU7CiAgICAgICAgRGVjaW1hbDQuY29uZmlnID0gRGVjaW1hbDQuc2V0ID0gY29uZmlnOwogICAgICAgIGlmIChvYmogPT09IHZvaWQgMCkgb2JqID0ge307CiAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgcHMgPSBbInByZWNpc2lvbiIsICJyb3VuZGluZyIsICJ0b0V4cE5lZyIsICJ0b0V4cFBvcyIsICJMTjEwIl07CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyApIGlmICghb2JqLmhhc093blByb3BlcnR5KHAgPSBwc1tpKytdKSkgb2JqW3BdID0gdGhpc1twXTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQuY29uZmlnKG9iaik7CiAgICAgICAgcmV0dXJuIERlY2ltYWw0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbmZpZyhvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgewogICAgICAgICAgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk9iamVjdCBleHBlY3RlZCIpOwogICAgICAgIH0KICAgICAgICB2YXIgaSwgcCwgdiwgcHMgPSBbCiAgICAgICAgICAicHJlY2lzaW9uIiwKICAgICAgICAgIDEsCiAgICAgICAgICBNQVhfRElHSVRTLAogICAgICAgICAgInJvdW5kaW5nIiwKICAgICAgICAgIDAsCiAgICAgICAgICA4LAogICAgICAgICAgInRvRXhwTmVnIiwKICAgICAgICAgIC0xIC8gMCwKICAgICAgICAgIDAsCiAgICAgICAgICAidG9FeHBQb3MiLAogICAgICAgICAgMCwKICAgICAgICAgIDEgLyAwCiAgICAgICAgXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGlmICgodiA9IG9ialtwID0gcHNbaV1dKSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChtYXRoZmxvb3IodikgPT09IHYgJiYgdiA+PSBwc1tpICsgMV0gJiYgdiA8PSBwc1tpICsgMl0pIHRoaXNbcF0gPSB2OwogICAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgodiA9IG9ialtwID0gIkxOMTAiXSkgIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHYgPT0gTWF0aC5MTjEwKSB0aGlzW3BdID0gbmV3IHRoaXModik7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIERlY2ltYWwzID0gY2xvbmUoRGVjaW1hbDMpOwogICAgICBEZWNpbWFsM1siZGVmYXVsdCJdID0gRGVjaW1hbDMuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICBPTkUgPSBuZXcgRGVjaW1hbDMoMSk7CiAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZShmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBEZWNpbWFsMzsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBEZWNpbWFsMzsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIWdsb2JhbFNjb3BlKSB7CiAgICAgICAgICBnbG9iYWxTY29wZSA9IHR5cGVvZiBzZWxmICE9ICJ1bmRlZmluZWQiICYmIHNlbGYgJiYgc2VsZi5zZWxmID09IHNlbGYgPyBzZWxmIDogRnVuY3Rpb24oInJldHVybiB0aGlzIikoKTsKICAgICAgICB9CiAgICAgICAgZ2xvYmFsU2NvcGUuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICB9CiAgICB9KShleHBvcnRzKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXguanMKdmFyIHJlcXVpcmVfZXZlbnRlbWl0dGVyMyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgaGFzMyA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgcHJlZml4ID0gIn4iOwogICAgZnVuY3Rpb24gRXZlbnRzKCkgewogICAgfQogICAgaWYgKE9iamVjdC5jcmVhdGUpIHsKICAgICAgRXZlbnRzLnByb3RvdHlwZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBpZiAoIW5ldyBFdmVudHMoKS5fX3Byb3RvX18pIHByZWZpeCA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gRUUoZm4sIGNvbnRleHQsIG9uY2UpIHsKICAgICAgdGhpcy5mbiA9IGZuOwogICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICB0aGlzLm9uY2UgPSBvbmNlIHx8IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gYWRkTGlzdGVuZXIyKGVtaXR0ZXIsIGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIGxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICB9CiAgICAgIHZhciBsaXN0ZW5lcjIgPSBuZXcgRUUoZm4sIGNvbnRleHQgfHwgZW1pdHRlciwgb25jZSksIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0pIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gbGlzdGVuZXIyLCBlbWl0dGVyLl9ldmVudHNDb3VudCsrOwogICAgICBlbHNlIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0uZm4pIGVtaXR0ZXIuX2V2ZW50c1tldnRdLnB1c2gobGlzdGVuZXIyKTsKICAgICAgZWxzZSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IFtlbWl0dGVyLl9ldmVudHNbZXZ0XSwgbGlzdGVuZXIyXTsKICAgICAgcmV0dXJuIGVtaXR0ZXI7CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckV2ZW50KGVtaXR0ZXIsIGV2dCkgewogICAgICBpZiAoLS1lbWl0dGVyLl9ldmVudHNDb3VudCA9PT0gMCkgZW1pdHRlci5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICBlbHNlIGRlbGV0ZSBlbWl0dGVyLl9ldmVudHNbZXZ0XTsKICAgIH0KICAgIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcjIoKSB7CiAgICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTsKICAgICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwOwogICAgfQogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZXZlbnROYW1lcyA9IGZ1bmN0aW9uIGV2ZW50TmFtZXMoKSB7CiAgICAgIHZhciBuYW1lcyA9IFtdLCBldmVudHMsIG5hbWU7CiAgICAgIGlmICh0aGlzLl9ldmVudHNDb3VudCA9PT0gMCkgcmV0dXJuIG5hbWVzOwogICAgICBmb3IgKG5hbWUgaW4gZXZlbnRzID0gdGhpcy5fZXZlbnRzKSB7CiAgICAgICAgaWYgKGhhczMuY2FsbChldmVudHMsIG5hbWUpKSBuYW1lcy5wdXNoKHByZWZpeCA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lKTsKICAgICAgfQogICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgICAgIHJldHVybiBuYW1lcy5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhldmVudHMpKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBoYW5kbGVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAoIWhhbmRsZXJzKSByZXR1cm4gW107CiAgICAgIGlmIChoYW5kbGVycy5mbikgcmV0dXJuIFtoYW5kbGVycy5mbl07CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaGFuZGxlcnMubGVuZ3RoLCBlZSA9IG5ldyBBcnJheShsKTsgaSA8IGw7IGkrKykgewogICAgICAgIGVlW2ldID0gaGFuZGxlcnNbaV0uZm47CiAgICAgIH0KICAgICAgcmV0dXJuIGVlOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XTsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybiAwOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSByZXR1cm4gMTsKICAgICAgcmV0dXJuIGxpc3RlbmVycy5sZW5ndGg7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIGExLCBhMiwgYTMsIGE0LCBhNSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF0sIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MsIGk7CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHsKICAgICAgICBpZiAobGlzdGVuZXJzLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVycy5mbiwgdm9pZCAwLCB0cnVlKTsKICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQpLCB0cnVlOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExKSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIpLCB0cnVlOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMpLCB0cnVlOwogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0KSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCwgYTUpLCB0cnVlOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgICBsaXN0ZW5lcnMuZm4uYXBwbHkobGlzdGVuZXJzLmNvbnRleHQsIGFyZ3MpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoLCBqOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vbmNlKSB0aGlzLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcnNbaV0uZm4sIHZvaWQgMCwgdHJ1ZSk7CiAgICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMiwgYTMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICghYXJncykgZm9yIChqID0gMSwgYXJncyA9IG5ldyBBcnJheShsZW4gLSAxKTsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW2ogLSAxXSA9IGFyZ3VtZW50c1tqXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmFwcGx5KGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub24gPSBmdW5jdGlvbiBvbihldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIGZhbHNlKTsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gb25jZShldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIHRydWUpOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIyKGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghZm4pIHsKICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSB7CiAgICAgICAgaWYgKGxpc3RlbmVycy5mbiA9PT0gZm4gJiYgKCFvbmNlIHx8IGxpc3RlbmVycy5vbmNlKSAmJiAoIWNvbnRleHQgfHwgbGlzdGVuZXJzLmNvbnRleHQgPT09IGNvbnRleHQpKSB7CiAgICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudHMgPSBbXSwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldLmZuICE9PSBmbiB8fCBvbmNlICYmICFsaXN0ZW5lcnNbaV0ub25jZSB8fCBjb250ZXh0ICYmIGxpc3RlbmVyc1tpXS5jb250ZXh0ICE9PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGV2ZW50cy5wdXNoKGxpc3RlbmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudHMubGVuZ3RoKSB0aGlzLl9ldmVudHNbZXZ0XSA9IGV2ZW50cy5sZW5ndGggPT09IDEgPyBldmVudHNbMF0gOiBldmVudHM7CiAgICAgICAgZWxzZSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQ7CiAgICAgIGlmIChldmVudCkgewogICAgICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgICAgaWYgKHRoaXMuX2V2ZW50c1tldnRdKSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vZmYgPSBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub247CiAgICBFdmVudEVtaXR0ZXIyLnByZWZpeGVkID0gcHJlZml4OwogICAgRXZlbnRFbWl0dGVyMi5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXIyOwogICAgaWYgKCJ1bmRlZmluZWQiICE9PSB0eXBlb2YgbW9kdWxlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyMjsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS9sYXN0LmpzCnZhciByZXF1aXJlX2xhc3QgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS9sYXN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGxhc3QyKGFycikgewogICAgICByZXR1cm4gYXJyW2Fyci5sZW5ndGggLSAxXTsKICAgIH0KICAgIGV4cG9ydHMubGFzdCA9IGxhc3QyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9BcnJheS5qcwp2YXIgcmVxdWlyZV90b0FycmF5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0FycmF5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHRvQXJyYXkyKHZhbHVlKSB7CiAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlIDogQXJyYXkuZnJvbSh2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLnRvQXJyYXkgPSB0b0FycmF5MjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvbGFzdC5qcwp2YXIgcmVxdWlyZV9sYXN0MiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9sYXN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBsYXN0JDEgPSByZXF1aXJlX2xhc3QoKTsKICAgIHZhciB0b0FycmF5MiA9IHJlcXVpcmVfdG9BcnJheSgpOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyYXkpIHsKICAgICAgaWYgKCFpc0FycmF5TGlrZS5pc0FycmF5TGlrZShhcnJheSkpIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJldHVybiBsYXN0JDEubGFzdCh0b0FycmF5Mi50b0FycmF5KGFycmF5KSk7CiAgICB9CiAgICBleHBvcnRzLmxhc3QgPSBsYXN0MjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2xhc3QuanMKdmFyIHJlcXVpcmVfbGFzdDMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2xhc3QuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX2xhc3QyKCkubGFzdDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0LWlzL2Nqcy9yZWFjdC1pcy5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9pc19kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QtaXMvY2pzL3JlYWN0LWlzLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICAoZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIHR5cGVPZihvYmplY3QpIHsKICAgICAgICBpZiAoIm9iamVjdCIgPT09IHR5cGVvZiBvYmplY3QgJiYgbnVsbCAhPT0gb2JqZWN0KSB7CiAgICAgICAgICB2YXIgJCR0eXBlb2YgPSBvYmplY3QuJCR0eXBlb2Y7CiAgICAgICAgICBzd2l0Y2ggKCQkdHlwZW9mKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgIHN3aXRjaCAob2JqZWN0ID0gb2JqZWN0LnR5cGUsIG9iamVjdCkgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1ZJRVdfVFJBTlNJVElPTl9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgc3dpdGNoIChvYmplY3QgPSBvYmplY3QgJiYgb2JqZWN0LiQkdHlwZW9mLCBvYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05TVU1FUl9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICQkdHlwZW9mOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAkJHR5cGVvZjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnRyYW5zaXRpb25hbC5lbGVtZW50IiksIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIiksIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpLCBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKSwgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIiksIFJFQUNUX0NPTlNVTUVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb25zdW1lciIpLCBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0IiksIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKSwgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIiksIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKSwgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKSwgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpLCBSRUFDVF9WSUVXX1RSQU5TSVRJT05fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnZpZXdfdHJhbnNpdGlvbiIpLCBSRUFDVF9DTElFTlRfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QuY2xpZW50LnJlZmVyZW5jZSIpOwogICAgICBleHBvcnRzLkNvbnRleHRDb25zdW1lciA9IFJFQUNUX0NPTlNVTUVSX1RZUEU7CiAgICAgIGV4cG9ydHMuQ29udGV4dFByb3ZpZGVyID0gUkVBQ1RfQ09OVEVYVF9UWVBFOwogICAgICBleHBvcnRzLkVsZW1lbnQgPSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgIGV4cG9ydHMuRm9yd2FyZFJlZiA9IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOwogICAgICBleHBvcnRzLkZyYWdtZW50ID0gUkVBQ1RfRlJBR01FTlRfVFlQRTsKICAgICAgZXhwb3J0cy5MYXp5ID0gUkVBQ1RfTEFaWV9UWVBFOwogICAgICBleHBvcnRzLk1lbW8gPSBSRUFDVF9NRU1PX1RZUEUyOwogICAgICBleHBvcnRzLlBvcnRhbCA9IFJFQUNUX1BPUlRBTF9UWVBFOwogICAgICBleHBvcnRzLlByb2ZpbGVyID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgZXhwb3J0cy5TdHJpY3RNb2RlID0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRTsKICAgICAgZXhwb3J0cy5TdXNwZW5zZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgIGV4cG9ydHMuU3VzcGVuc2VMaXN0ID0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOwogICAgICBleHBvcnRzLmlzQ29udGV4dENvbnN1bWVyID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVPZihvYmplY3QpID09PSBSRUFDVF9DT05TVU1FUl9UWVBFOwogICAgICB9OwogICAgICBleHBvcnRzLmlzQ29udGV4dFByb3ZpZGVyID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVPZihvYmplY3QpID09PSBSRUFDVF9DT05URVhUX1RZUEU7CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaXNFbGVtZW50ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuICJvYmplY3QiID09PSB0eXBlb2Ygb2JqZWN0ICYmIG51bGwgIT09IG9iamVjdCAmJiBvYmplY3QuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRTsKICAgICAgfTsKICAgICAgZXhwb3J0cy5pc0ZvcndhcmRSZWYgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gdHlwZU9mKG9iamVjdCkgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOwogICAgICB9OwogICAgICBleHBvcnRzLmlzRnJhZ21lbnQgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gdHlwZU9mKG9iamVjdCkgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEU7CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaXNMYXp5ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVPZihvYmplY3QpID09PSBSRUFDVF9MQVpZX1RZUEU7CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaXNNZW1vID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVPZihvYmplY3QpID09PSBSRUFDVF9NRU1PX1RZUEUyOwogICAgICB9OwogICAgICBleHBvcnRzLmlzUG9ydGFsID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVPZihvYmplY3QpID09PSBSRUFDVF9QT1JUQUxfVFlQRTsKICAgICAgfTsKICAgICAgZXhwb3J0cy5pc1Byb2ZpbGVyID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVPZihvYmplY3QpID09PSBSRUFDVF9QUk9GSUxFUl9UWVBFOwogICAgICB9OwogICAgICBleHBvcnRzLmlzU3RyaWN0TW9kZSA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiB0eXBlT2Yob2JqZWN0KSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRTsKICAgICAgfTsKICAgICAgZXhwb3J0cy5pc1N1c3BlbnNlID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVPZihvYmplY3QpID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICB9OwogICAgICBleHBvcnRzLmlzU3VzcGVuc2VMaXN0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVPZihvYmplY3QpID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU7CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaXNWYWxpZEVsZW1lbnRUeXBlID0gZnVuY3Rpb24odHlwZSkgewogICAgICAgIHJldHVybiAic3RyaW5nIiA9PT0gdHlwZW9mIHR5cGUgfHwgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIHR5cGUgfHwgdHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9QUk9GSUxFUl9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgIm9iamVjdCIgPT09IHR5cGVvZiB0eXBlICYmIG51bGwgIT09IHR5cGUgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05TVU1FUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NMSUVOVF9SRUZFUkVOQ0UgfHwgdm9pZCAwICE9PSB0eXBlLmdldE1vZHVsZUlkKSA/IHRydWUgOiBmYWxzZTsKICAgICAgfTsKICAgICAgZXhwb3J0cy50eXBlT2YgPSB0eXBlT2Y7CiAgICB9KSgpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QtaXMvaW5kZXguanMKdmFyIHJlcXVpcmVfcmVhY3RfaXMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWlzL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfcmVhY3RfaXNfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzUGxhaW5PYmplY3QuanMKdmFyIHJlcXVpcmVfaXNQbGFpbk9iamVjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNQbGFpbk9iamVjdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0NShvYmplY3QpIHsKICAgICAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICJvYmplY3QiKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmIChvYmplY3QgPT0gbnVsbCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCkgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iamVjdCkgIT09ICJbb2JqZWN0IE9iamVjdF0iKSB7CiAgICAgICAgY29uc3QgdGFnID0gb2JqZWN0W1N5bWJvbC50b1N0cmluZ1RhZ107CiAgICAgICAgaWYgKHRhZyA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlzVGFnUmVhZG9ubHkgPSAhT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIFN5bWJvbC50b1N0cmluZ1RhZyk/LndyaXRhYmxlOwogICAgICAgIGlmIChpc1RhZ1JlYWRvbmx5KSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmplY3QudG9TdHJpbmcoKSA9PT0gYFtvYmplY3QgJHt0YWd9XWA7CiAgICAgIH0KICAgICAgbGV0IHByb3RvMiA9IG9iamVjdDsKICAgICAgd2hpbGUgKE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90bzIpICE9PSBudWxsKSB7CiAgICAgICAgcHJvdG8yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvMik7CiAgICAgIH0KICAgICAgcmV0dXJuIE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpID09PSBwcm90bzI7CiAgICB9CiAgICBleHBvcnRzLmlzUGxhaW5PYmplY3QgPSBpc1BsYWluT2JqZWN0NTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2lzUGxhaW5PYmplY3QuanMKdmFyIHJlcXVpcmVfaXNQbGFpbk9iamVjdDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2lzUGxhaW5PYmplY3QuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX2lzUGxhaW5PYmplY3QoKS5pc1BsYWluT2JqZWN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXdpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfd2l0aF9zZWxlY3Rvcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXdpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIChmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKDAgIT09IHgyIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICB9CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQoRXJyb3IoKSk7CiAgICAgIHZhciBSZWFjdDQ0ID0gcmVxdWlyZV9yZWFjdCgpLCBvYmplY3RJcyA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBPYmplY3QuaXMgPyBPYmplY3QuaXMgOiBpczQsIHVzZVN5bmNFeHRlcm5hbFN0b3JlMiA9IFJlYWN0NDQudXNlU3luY0V4dGVybmFsU3RvcmUsIHVzZVJlZjE3ID0gUmVhY3Q0NC51c2VSZWYsIHVzZUVmZmVjdDE2ID0gUmVhY3Q0NC51c2VFZmZlY3QsIHVzZU1lbW8xMCA9IFJlYWN0NDQudXNlTWVtbywgdXNlRGVidWdWYWx1ZTIgPSBSZWFjdDQ0LnVzZURlYnVnVmFsdWU7CiAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IgPSBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWwpIHsKICAgICAgICB2YXIgaW5zdFJlZiA9IHVzZVJlZjE3KG51bGwpOwogICAgICAgIGlmIChudWxsID09PSBpbnN0UmVmLmN1cnJlbnQpIHsKICAgICAgICAgIHZhciBpbnN0ID0geyBoYXNWYWx1ZTogZmFsc2UsIHZhbHVlOiBudWxsIH07CiAgICAgICAgICBpbnN0UmVmLmN1cnJlbnQgPSBpbnN0OwogICAgICAgIH0gZWxzZSBpbnN0ID0gaW5zdFJlZi5jdXJyZW50OwogICAgICAgIGluc3RSZWYgPSB1c2VNZW1vMTAoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZnVuY3Rpb24gbWVtb2l6ZWRTZWxlY3RvcihuZXh0U25hcHNob3QpIHsKICAgICAgICAgICAgICBpZiAoIWhhc01lbW8pIHsKICAgICAgICAgICAgICAgIGhhc01lbW8gPSB0cnVlOwogICAgICAgICAgICAgICAgbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IHNlbGVjdG9yKG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGluc3QuaGFzVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTZWxlY3Rpb24gPSBpbnN0LnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAoaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRTZWxlY3Rpb24gPSBtZW1vaXplZFNlbGVjdGlvbjsKICAgICAgICAgICAgICBpZiAob2JqZWN0SXMobWVtb2l6ZWRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KSkKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIHZhciBuZXh0U2VsZWN0aW9uID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGlzRXF1YWwoY3VycmVudFNlbGVjdGlvbiwgbmV4dFNlbGVjdGlvbikpCiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdCwgY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTZWxlY3Rpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc01lbW8gPSBmYWxzZSwgbWVtb2l6ZWRTbmFwc2hvdCwgbWVtb2l6ZWRTZWxlY3Rpb24sIG1heWJlR2V0U2VydmVyU25hcHNob3QgPSB2b2lkIDAgPT09IGdldFNlcnZlclNuYXBzaG90ID8gbnVsbCA6IGdldFNlcnZlclNuYXBzaG90OwogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0b3IoZ2V0U25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBudWxsID09PSBtYXliZUdldFNlcnZlclNuYXBzaG90ID8gdm9pZCAwIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihtYXliZUdldFNlcnZlclNuYXBzaG90KCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgXTsKICAgICAgICAgIH0sCiAgICAgICAgICBbZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90LCBzZWxlY3RvciwgaXNFcXVhbF0KICAgICAgICApOwogICAgICAgIHZhciB2YWx1ZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMihzdWJzY3JpYmUsIGluc3RSZWZbMF0sIGluc3RSZWZbMV0pOwogICAgICAgIHVzZUVmZmVjdDE2KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGluc3QuaGFzVmFsdWUgPSB0cnVlOwogICAgICAgICAgICBpbnN0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9LAogICAgICAgICAgW3ZhbHVlXQogICAgICAgICk7CiAgICAgICAgdXNlRGVidWdWYWx1ZTIodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfTsKICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AoRXJyb3IoKSk7CiAgICB9KSgpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcwp2YXIgcmVxdWlyZV93aXRoX3NlbGVjdG9yMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9qc3hfcnVudGltZV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBSZWFjdDQ0ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgPSBTeW1ib2wuaXRlcmF0b3I7CiAgICAgICAgdmFyIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiOwogICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgaWYgKG1heWJlSXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIG1heWJlSXRlcmFibGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgaWYgKHR5cGVvZiBtYXliZUl0ZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0NDQuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjb3BlQVBJID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUNhY2hlRWxlbWVudCA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVUcmFuc2l0aW9uVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlRGVidWdUcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0U7CiAgICAgICAgewogICAgICAgICAgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm1vZHVsZS5yZWZlcmVuY2UiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9QUk9GSUxFUl9UWVBFIHx8IGVuYWJsZURlYnVnVHJhY2luZyB8fCB0eXBlID09PSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbiB8fCB0eXBlID09PSBSRUFDVF9PRkZTQ1JFRU5fVFlQRSB8fCBlbmFibGVTY29wZUFQSSB8fCBlbmFibGVDYWNoZUVsZW1lbnQgfHwgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkxvZwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBpbmZvOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkVycm9yCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwRW5kCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoIDwgMCkgewogICAgICAgICAgICAgIGVycm9yKCJkaXNhYmxlZERlcHRoIGZlbGwgYmVsb3cgemVyby4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uY2FsbChGYWtlLnByb3RvdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMyID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYzIgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAoczIgPj0gMSAmJiBjMiA+PSAwICYmIHNhbXBsZUxpbmVzW3MyXSAhPT0gY29udHJvbExpbmVzW2MyXSkgewogICAgICAgICAgICAgICAgYzItLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMyID49IDEgJiYgYzIgPj0gMDsgczItLSwgYzItLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3MyXSAhPT0gY29udHJvbExpbmVzW2MyXSkgewogICAgICAgICAgICAgICAgICBpZiAoczIgIT09IDEgfHwgYzIgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzMi0tOwogICAgICAgICAgICAgICAgICAgICAgYzItLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjMiA8IDAgfHwgc2FtcGxlTGluZXNbczJdICE9PSBjb250cm9sTGluZXNbYzJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbczJdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoczIgPj0gMSAmJiBjMiA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLnR5cGUsIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoaW5pdChwYXlsb2FkKSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMzID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXMzKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheTIoYTIpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgICByZWY6IHRydWUsCiAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duOwogICAgICAgIHZhciBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bjsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgInJlZiIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5yZWYgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgImtleSIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgc2VsZjIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC5zdGF0ZU5vZGUgIT09IHNlbGYyKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVGhpcyBjYXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbi4gV2UgYXNrIHlvdSB0byBtYW51YWxseSBmaXggdGhpcyBjYXNlIGJ5IHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKSwgY29uZmlnLnJlZik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGBrZXlgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJrZXkiLCB7CiAgICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXksCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ1JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYHJlZmAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ1JlZiwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbih0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYyCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zb3VyY2UiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNvdXJjZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24ganN4REVWKHR5cGUsIGNvbmZpZywgbWF5YmVLZXksIHNvdXJjZSwgc2VsZjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgICB2YXIgcHJvcHMgPSB7fTsKICAgICAgICAgICAgdmFyIGtleSA9IG51bGw7CiAgICAgICAgICAgIHZhciByZWYgPSBudWxsOwogICAgICAgICAgICBpZiAobWF5YmVLZXkgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWF5YmVLZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIG1heWJlS2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnLCBzZWxmMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQsIHByb3BzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50MTcob2JqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE93bmVyID0gIiI7CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQpIHsKICAgICAgICAgICAgICBjaGlsZE93bmVyID0gIiBJdCB3YXMgcGFzc2VkIGEgY2hpbGQgZnJvbSAiICsgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGVsZW1lbnQuX293bmVyLnR5cGUpICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNBcnJheTIobm9kZSkpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNyhjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShjaGlsZCwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRFbGVtZW50MTcobm9kZSkpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICAgIG5vZGUuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obm9kZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChub2RlKTsKICAgICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNyhzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShzdGVwLnZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIE5vdGU6IE1lbW8gb25seSBjaGVja3Mgb3V0ZXIgcHJvcHMgaGVyZS4KICAgICAgICAgICAgLy8gSW5uZXIgcHJvcHMgYXJlIGNoZWNrZWQgaW4gdGhlIHJlY29uY2lsZXIuCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEtleVNwcmVhZCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIGlzU3RhdGljQ2hpbGRyZW4sIHNvdXJjZSwgc2VsZjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgICAgaWYgKCF2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKTsKICAgICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgICAgaW5mbyArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgdHlwZVN0cmluZzsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJudWxsIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkyKHR5cGUpKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiPCIgKyAoZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IHR5cGUgaXMgaW52YWxpZCAtLSBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMiLCB0eXBlU3RyaW5nLCBpbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGpzeERFVih0eXBlLCBwcm9wcywga2V5LCBzb3VyY2UsIHNlbGYyKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RhdGljQ2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuW2ldLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiBTdGF0aWMgY2hpbGRyZW4gc2hvdWxkIGFsd2F5cyBiZSBhbiBhcnJheS4gWW91IGFyZSBsaWtlbHkgZXhwbGljaXRseSBjYWxsaW5nIFJlYWN0LmpzeHMgb3IgUmVhY3QuanN4REVWLiBVc2UgdGhlIEJhYmVsIHRyYW5zZm9ybSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhjaGlsZHJlbiwgdHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChwcm9wcywgImtleSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcHMpLmZpbHRlcihmdW5jdGlvbihrMikgewogICAgICAgICAgICAgICAgICByZXR1cm4gazIgIT09ICJrZXkiOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7a2V5OiBzb21lS2V5LCAiICsga2V5cy5qb2luKCI6IC4uLiwgIikgKyAiOiAuLi59IiA6ICJ7a2V5OiBzb21lS2V5fSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0pIHsKICAgICAgICAgICAgICAgICAgdmFyIGFmdGVyRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7IiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie30iOwogICAgICAgICAgICAgICAgICBlcnJvcignQSBwcm9wcyBvYmplY3QgY29udGFpbmluZyBhICJrZXkiIHByb3AgaXMgYmVpbmcgc3ByZWFkIGludG8gSlNYOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIHsuLi5wcm9wc30gLz5cblJlYWN0IGtleXMgbXVzdCBiZSBwYXNzZWQgZGlyZWN0bHkgdG8gSlNYIHdpdGhvdXQgdXNpbmcgc3ByZWFkOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIGtleT17c29tZUtleX0gey4uLnByb3BzfSAvPicsIGJlZm9yZUV4YW1wbGUsIGNvbXBvbmVudE5hbWUsIGFmdGVyRXhhbXBsZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb25TdGF0aWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYyh0eXBlLCBwcm9wcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBqc3hXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywga2V5LCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBqc3gzID0ganN4V2l0aFZhbGlkYXRpb25EeW5hbWljOwogICAgICAgIHZhciBqc3hzMyA9IGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljOwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuanN4ID0ganN4MzsKICAgICAgICBleHBvcnRzLmpzeHMgPSBqc3hzMzsKICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzCnZhciByZXF1aXJlX2pzeF9ydW50aW1lID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9qc3gtcnVudGltZS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIHNyYy9tYWluLnRzeAp2YXIgaW1wb3J0X3JlYWN0NTggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CnZhciBpbXBvcnRfY2xpZW50ID0gX190b0VTTShyZXF1aXJlX2NsaWVudCgpLCAxKTsKCi8vIHNyYy9Qb3J0Zm9saW9TaW11bGF0b3IudHN4CnZhciBpbXBvcnRfcmVhY3Q1NyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vc2hhcmVkL3NyYy91dGlscy5qcwp2YXIgdG9LZWJhYkNhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgIiQxLSQyIikudG9Mb3dlckNhc2UoKTsKdmFyIHRvQ2FtZWxDYXNlID0gKHN0cmluZykgPT4gc3RyaW5nLnJlcGxhY2UoCiAgL14oW0EtWl0pfFtccy1fXSsoXHcpL2csCiAgKG1hdGNoLCBwMSwgcDIpID0+IHAyID8gcDIudG9VcHBlckNhc2UoKSA6IHAxLnRvTG93ZXJDYXNlKCkKKTsKdmFyIHRvUGFzY2FsQ2FzZSA9IChzdHJpbmcpID0+IHsKICBjb25zdCBjYW1lbENhc2UgPSB0b0NhbWVsQ2FzZShzdHJpbmcpOwogIHJldHVybiBjYW1lbENhc2UuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjYW1lbENhc2Uuc2xpY2UoMSk7Cn07CnZhciBtZXJnZUNsYXNzZXMgPSAoLi4uY2xhc3NlcykgPT4gY2xhc3Nlcy5maWx0ZXIoKGNsYXNzTmFtZSwgaW5kZXgsIGFycmF5KSA9PiB7CiAgcmV0dXJuIEJvb2xlYW4oY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUudHJpbSgpICE9PSAiIiAmJiBhcnJheS5pbmRleE9mKGNsYXNzTmFtZSkgPT09IGluZGV4Owp9KS5qb2luKCIgIikudHJpbSgpOwp2YXIgaGFzQTExeVByb3AgPSAocHJvcHMpID0+IHsKICBmb3IgKGNvbnN0IHByb3AgaW4gcHJvcHMpIHsKICAgIGlmIChwcm9wLnN0YXJ0c1dpdGgoImFyaWEtIikgfHwgcHJvcCA9PT0gInJvbGUiIHx8IHByb3AgPT09ICJ0aXRsZSIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzCnZhciBpbXBvcnRfcmVhY3QgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2RlZmF1bHRBdHRyaWJ1dGVzLmpzCnZhciBkZWZhdWx0QXR0cmlidXRlcyA9IHsKICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwKICB3aWR0aDogMjQsCiAgaGVpZ2h0OiAyNCwKICB2aWV3Qm94OiAiMCAwIDI0IDI0IiwKICBmaWxsOiAibm9uZSIsCiAgc3Ryb2tlOiAiY3VycmVudENvbG9yIiwKICBzdHJva2VXaWR0aDogMiwKICBzdHJva2VMaW5lY2FwOiAicm91bmQiLAogIHN0cm9rZUxpbmVqb2luOiAicm91bmQiCn07CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanMKdmFyIEljb24gPSAoMCwgaW1wb3J0X3JlYWN0LmZvcndhcmRSZWYpKAogICh7CiAgICBjb2xvcjogY29sb3IyID0gImN1cnJlbnRDb2xvciIsCiAgICBzaXplID0gMjQsCiAgICBzdHJva2VXaWR0aCA9IDIsCiAgICBhYnNvbHV0ZVN0cm9rZVdpZHRoLAogICAgY2xhc3NOYW1lID0gIiIsCiAgICBjaGlsZHJlbiwKICAgIGljb25Ob2RlLAogICAgLi4ucmVzdAogIH0sIHJlZikgPT4gKDAsIGltcG9ydF9yZWFjdC5jcmVhdGVFbGVtZW50KSgKICAgICJzdmciLAogICAgewogICAgICByZWYsCiAgICAgIC4uLmRlZmF1bHRBdHRyaWJ1dGVzLAogICAgICB3aWR0aDogc2l6ZSwKICAgICAgaGVpZ2h0OiBzaXplLAogICAgICBzdHJva2U6IGNvbG9yMiwKICAgICAgc3Ryb2tlV2lkdGg6IGFic29sdXRlU3Ryb2tlV2lkdGggPyBOdW1iZXIoc3Ryb2tlV2lkdGgpICogMjQgLyBOdW1iZXIoc2l6ZSkgOiBzdHJva2VXaWR0aCwKICAgICAgY2xhc3NOYW1lOiBtZXJnZUNsYXNzZXMoImx1Y2lkZSIsIGNsYXNzTmFtZSksCiAgICAgIC4uLiFjaGlsZHJlbiAmJiAhaGFzQTExeVByb3AocmVzdCkgJiYgeyAiYXJpYS1oaWRkZW4iOiAidHJ1ZSIgfSwKICAgICAgLi4ucmVzdAogICAgfSwKICAgIFsKICAgICAgLi4uaWNvbk5vZGUubWFwKChbdGFnLCBhdHRyc10pID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkodGFnLCBhdHRycykpLAogICAgICAuLi5BcnJheS5pc0FycmF5KGNoaWxkcmVuKSA/IGNoaWxkcmVuIDogW2NoaWxkcmVuXQogICAgXQogICkKKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgY3JlYXRlTHVjaWRlSWNvbiA9IChpY29uTmFtZSwgaWNvbk5vZGUpID0+IHsKICBjb25zdCBDb21wb25lbnQgPSAoMCwgaW1wb3J0X3JlYWN0Mi5mb3J3YXJkUmVmKSgKICAgICh7IGNsYXNzTmFtZSwgLi4ucHJvcHMgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0Mi5jcmVhdGVFbGVtZW50KShJY29uLCB7CiAgICAgIHJlZiwKICAgICAgaWNvbk5vZGUsCiAgICAgIGNsYXNzTmFtZTogbWVyZ2VDbGFzc2VzKAogICAgICAgIGBsdWNpZGUtJHt0b0tlYmFiQ2FzZSh0b1Bhc2NhbENhc2UoaWNvbk5hbWUpKX1gLAogICAgICAgIGBsdWNpZGUtJHtpY29uTmFtZX1gLAogICAgICAgIGNsYXNzTmFtZQogICAgICApLAogICAgICAuLi5wcm9wcwogICAgfSkKICApOwogIENvbXBvbmVudC5kaXNwbGF5TmFtZSA9IHRvUGFzY2FsQ2FzZShpY29uTmFtZSk7CiAgcmV0dXJuIENvbXBvbmVudDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctcmlnaHQuanMKdmFyIF9faWNvbk5vZGUgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIm0xMiA1IDcgNy03IDciLCBrZXk6ICJ4cXV6NGMiIH1dCl07CnZhciBBcnJvd1JpZ2h0ID0gY3JlYXRlTHVjaWRlSWNvbigiYXJyb3ctcmlnaHQiLCBfX2ljb25Ob2RlKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanMKdmFyIF9faWNvbk5vZGUyID0gW1sicGF0aCIsIHsgZDogIk0yMCA2IDkgMTdsLTUtNSIsIGtleTogIjFnbWYyYyIgfV1dOwp2YXIgQ2hlY2sgPSBjcmVhdGVMdWNpZGVJY29uKCJjaGVjayIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi1kb3duLmpzCnZhciBfX2ljb25Ob2RlMyA9IFtbInBhdGgiLCB7IGQ6ICJtNiA5IDYgNiA2LTYiLCBrZXk6ICJxcnVuc2wiIH1dXTsKdmFyIENoZXZyb25Eb3duID0gY3JlYXRlTHVjaWRlSWNvbigiY2hldnJvbi1kb3duIiwgX19pY29uTm9kZTMpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaXJjbGUtcXVlc3Rpb24tbWFyay5qcwp2YXIgX19pY29uTm9kZTQgPSBbCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTIiLCBjeTogIjEyIiwgcjogIjEwIiwga2V5OiAiMW1nbGF5IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNOS4wOSA5YTMgMyAwIDAgMSA1LjgzIDFjMCAyLTMgMy0zIDMiLCBrZXk6ICIxdTc3M3MiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiAxN2guMDEiLCBrZXk6ICJwMzJwMDUiIH1dCl07CnZhciBDaXJjbGVRdWVzdGlvbk1hcmsgPSBjcmVhdGVMdWNpZGVJY29uKCJjaXJjbGUtcXVlc3Rpb24tbWFyayIsIF9faWNvbk5vZGU0KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanMKdmFyIF9faWNvbk5vZGU1ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yIDkuNWE1LjUgNS41IDAgMCAxIDkuNTkxLTMuNjc2LjU2LjU2IDAgMCAwIC44MTggMEE1LjQ5IDUuNDkgMCAwIDEgMjIgOS41YzAgMi4yOS0xLjUgNC0zIDUuNWwtNS40OTIgNS4zMTNhMiAyIDAgMCAxLTMgLjAxOUw1IDE1Yy0xLjUtMS41LTMtMy4yLTMtNS41IiwKICAgICAga2V5OiAibXZyMWEwIgogICAgfQogIF0KXTsKdmFyIEhlYXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigiaGVhcnQiLCBfX2ljb25Ob2RlNSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2luZm8uanMKdmFyIF9faWNvbk5vZGU2ID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjEyIiwgY3k6ICIxMiIsIHI6ICIxMCIsIGtleTogIjFtZ2xheSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDE2di00Iiwga2V5OiAiMWR0aWZ1IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTIgOGguMDEiLCBrZXk6ICJlOWJvaTMiIH1dCl07CnZhciBJbmZvID0gY3JlYXRlTHVjaWRlSWNvbigiaW5mbyIsIF9faWNvbk5vZGU2KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9hZGVyLmpzCnZhciBfX2ljb25Ob2RlNyA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTIgMnY0Iiwga2V5OiAiMzQyN2ljIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtMTYuMiA3LjggMi45LTIuOSIsIGtleTogInI3MDBhbyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTE4IDEyaDQiLCBrZXk6ICJ3ajl5a2giIH1dLAogIFsicGF0aCIsIHsgZDogIm0xNi4yIDE2LjIgMi45IDIuOSIsIGtleTogIjFieGc1dCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDE4djQiLCBrZXk6ICJqYWRtdnoiIH1dLAogIFsicGF0aCIsIHsgZDogIm00LjkgMTkuMSAyLjktMi45Iiwga2V5OiAiYndpeDlxIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMiAxMmg0Iiwga2V5OiAiajA5c2lpIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtNC45IDQuOSAyLjkgMi45Iiwga2V5OiAiZ2l5dWZyIiB9XQpdOwp2YXIgTG9hZGVyID0gY3JlYXRlTHVjaWRlSWNvbigibG9hZGVyIiwgX19pY29uTm9kZTcpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tYWlsLmpzCnZhciBfX2ljb25Ob2RlOCA9IFsKICBbInBhdGgiLCB7IGQ6ICJtMjIgNy04Ljk5MSA1LjcyN2EyIDIgMCAwIDEtMi4wMDkgMEwyIDciLCBrZXk6ICIxMzJxN3EiIH1dLAogIFsicmVjdCIsIHsgeDogIjIiLCB5OiAiNCIsIHdpZHRoOiAiMjAiLCBoZWlnaHQ6ICIxNiIsIHJ4OiAiMiIsIGtleTogIml6eGxhbyIgfV0KXTsKdmFyIE1haWwgPSBjcmVhdGVMdWNpZGVJY29uKCJtYWlsIiwgX19pY29uTm9kZTgpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tZXNzYWdlLXNxdWFyZS5qcwp2YXIgX19pY29uTm9kZTkgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIyIDE3YTIgMiAwIDAgMS0yIDJINi44MjhhMiAyIDAgMCAwLTEuNDE0LjU4NmwtMi4yMDIgMi4yMDJBLjcxLjcxIDAgMCAxIDIgMjEuMjg2VjVhMiAyIDAgMCAxIDItMmgxNmEyIDIgMCAwIDEgMiAyeiIsCiAgICAgIGtleTogIjE4ODg3cCIKICAgIH0KICBdCl07CnZhciBNZXNzYWdlU3F1YXJlID0gY3JlYXRlTHVjaWRlSWNvbigibWVzc2FnZS1zcXVhcmUiLCBfX2ljb25Ob2RlOSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21pbnVzLmpzCnZhciBfX2ljb25Ob2RlMTAgPSBbWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dXTsKdmFyIE1pbnVzID0gY3JlYXRlTHVjaWRlSWNvbigibWludXMiLCBfX2ljb25Ob2RlMTApOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wbGF5LmpzCnZhciBfX2ljb25Ob2RlMTEgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTUgNWEyIDIgMCAwIDEgMy4wMDgtMS43MjhsMTEuOTk3IDYuOTk4YTIgMiAwIDAgMSAuMDAzIDMuNDU4bC0xMiA3QTIgMiAwIDAgMSA1IDE5eiIsCiAgICAgIGtleTogIjEwaWtmMSIKICAgIH0KICBdCl07CnZhciBQbGF5ID0gY3JlYXRlTHVjaWRlSWNvbigicGxheSIsIF9faWNvbk5vZGUxMSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsdXMuanMKdmFyIF9faWNvbk5vZGUxMiA9IFsKICBbInBhdGgiLCB7IGQ6ICJNNSAxMmgxNCIsIGtleTogIjFheXMwaCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDV2MTQiLCBrZXk6ICJzNjk5bGUiIH1dCl07CnZhciBQbHVzID0gY3JlYXRlTHVjaWRlSWNvbigicGx1cyIsIF9faWNvbk5vZGUxMik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3ByaW50ZXIuanMKdmFyIF9faWNvbk5vZGUxMyA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNNiAxOEg0YTIgMiAwIDAgMS0yLTJ2LTVhMiAyIDAgMCAxIDItMmgxNmEyIDIgMCAwIDEgMiAydjVhMiAyIDAgMCAxLTIgMmgtMiIsCiAgICAgIGtleTogIjE0M3d5ZCIKICAgIH0KICBdLAogIFsicGF0aCIsIHsgZDogIk02IDlWM2ExIDEgMCAwIDEgMS0xaDEwYTEgMSAwIDAgMSAxIDF2NiIsIGtleTogIjFpdG5lNyIgfV0sCiAgWyJyZWN0IiwgeyB4OiAiNiIsIHk6ICIxNCIsIHdpZHRoOiAiMTIiLCBoZWlnaHQ6ICI4Iiwgcng6ICIxIiwga2V5OiAiMXVlMHRnIiB9XQpdOwp2YXIgUHJpbnRlciA9IGNyZWF0ZUx1Y2lkZUljb24oInByaW50ZXIiLCBfX2ljb25Ob2RlMTMpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yb3RhdGUtY2N3LmpzCnZhciBfX2ljb25Ob2RlMTQgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTMgMTJhOSA5IDAgMSAwIDktOSA5Ljc1IDkuNzUgMCAwIDAtNi43NCAyLjc0TDMgOCIsIGtleTogIjEzNTdlMyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgM3Y1aDUiLCBrZXk6ICIxeGhxOGEiIH1dCl07CnZhciBSb3RhdGVDY3cgPSBjcmVhdGVMdWNpZGVJY29uKCJyb3RhdGUtY2N3IiwgX19pY29uTm9kZTE0KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdGFyZ2V0LmpzCnZhciBfX2ljb25Ob2RlMTUgPSBbCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTIiLCBjeTogIjEyIiwgcjogIjEwIiwga2V5OiAiMW1nbGF5IiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICIxMiIsIGN5OiAiMTIiLCByOiAiNiIsIGtleTogIjF2bGZyaCIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTIiLCBjeTogIjEyIiwgcjogIjIiLCBrZXk6ICIxYzlwNzgiIH1dCl07CnZhciBUYXJnZXQgPSBjcmVhdGVMdWNpZGVJY29uKCJ0YXJnZXQiLCBfX2ljb25Ob2RlMTUpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmVuZGluZy11cC5qcwp2YXIgX19pY29uTm9kZTE2ID0gWwogIFsicGF0aCIsIHsgZDogIk0xNiA3aDZ2NiIsIGtleTogImJveDU1bCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTIyIDctOC41IDguNS01LTVMMiAxNyIsIGtleTogIjF0MW03OSIgfV0KXTsKdmFyIFRyZW5kaW5nVXAgPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmVuZGluZy11cCIsIF9faWNvbk5vZGUxNik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3guanMKdmFyIF9faWNvbk5vZGUxNyA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTggNiA2IDE4Iiwga2V5OiAiMWJsNWY4IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtNiA2IDEyIDEyIiwga2V5OiAiZDhiazZ2IiB9XQpdOwp2YXIgWCA9IGNyZWF0ZUx1Y2lkZUljb24oIngiLCBfX2ljb25Ob2RlMTcpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvU3VyZmFjZS5qcwp2YXIgUmVhY3QgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL2Nsc3gvZGlzdC9jbHN4Lm1qcwpmdW5jdGlvbiByKGUpIHsKICB2YXIgdCwgZiwgbiA9ICIiOwogIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgZSB8fCAibnVtYmVyIiA9PSB0eXBlb2YgZSkgbiArPSBlOwogIGVsc2UgaWYgKCJvYmplY3QiID09IHR5cGVvZiBlKSBpZiAoQXJyYXkuaXNBcnJheShlKSkgewogICAgdmFyIG8gPSBlLmxlbmd0aDsKICAgIGZvciAodCA9IDA7IHQgPCBvOyB0KyspIGVbdF0gJiYgKGYgPSByKGVbdF0pKSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IGYpOwogIH0gZWxzZSBmb3IgKGYgaW4gZSkgZVtmXSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IGYpOwogIHJldHVybiBuOwp9CmZ1bmN0aW9uIGNsc3goKSB7CiAgZm9yICh2YXIgZSwgdCwgZiA9IDAsIG4gPSAiIiwgbyA9IGFyZ3VtZW50cy5sZW5ndGg7IGYgPCBvOyBmKyspIChlID0gYXJndW1lbnRzW2ZdKSAmJiAodCA9IHIoZSkpICYmIChuICYmIChuICs9ICIgIiksIG4gKz0gdCk7CiAgcmV0dXJuIG47Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zdmdQcm9wZXJ0aWVzQW5kRXZlbnRzLmpzCnZhciBpbXBvcnRfcmVhY3Q0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2V4Y2x1ZGVFdmVudFByb3BzLmpzCnZhciBFdmVudEtleXMgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgIm9uQ29weSIsICJvbkNvcHlDYXB0dXJlIiwgIm9uQ3V0IiwgIm9uQ3V0Q2FwdHVyZSIsICJvblBhc3RlIiwgIm9uUGFzdGVDYXB0dXJlIiwgIm9uQ29tcG9zaXRpb25FbmQiLCAib25Db21wb3NpdGlvbkVuZENhcHR1cmUiLCAib25Db21wb3NpdGlvblN0YXJ0IiwgIm9uQ29tcG9zaXRpb25TdGFydENhcHR1cmUiLCAib25Db21wb3NpdGlvblVwZGF0ZSIsICJvbkNvbXBvc2l0aW9uVXBkYXRlQ2FwdHVyZSIsICJvbkZvY3VzIiwgIm9uRm9jdXNDYXB0dXJlIiwgIm9uQmx1ciIsICJvbkJsdXJDYXB0dXJlIiwgIm9uQ2hhbmdlIiwgIm9uQ2hhbmdlQ2FwdHVyZSIsICJvbkJlZm9yZUlucHV0IiwgIm9uQmVmb3JlSW5wdXRDYXB0dXJlIiwgIm9uSW5wdXQiLCAib25JbnB1dENhcHR1cmUiLCAib25SZXNldCIsICJvblJlc2V0Q2FwdHVyZSIsICJvblN1Ym1pdCIsICJvblN1Ym1pdENhcHR1cmUiLCAib25JbnZhbGlkIiwgIm9uSW52YWxpZENhcHR1cmUiLCAib25Mb2FkIiwgIm9uTG9hZENhcHR1cmUiLCAib25FcnJvciIsICJvbkVycm9yQ2FwdHVyZSIsICJvbktleURvd24iLCAib25LZXlEb3duQ2FwdHVyZSIsICJvbktleVByZXNzIiwgIm9uS2V5UHJlc3NDYXB0dXJlIiwgIm9uS2V5VXAiLCAib25LZXlVcENhcHR1cmUiLCAib25BYm9ydCIsICJvbkFib3J0Q2FwdHVyZSIsICJvbkNhblBsYXkiLCAib25DYW5QbGF5Q2FwdHVyZSIsICJvbkNhblBsYXlUaHJvdWdoIiwgIm9uQ2FuUGxheVRocm91Z2hDYXB0dXJlIiwgIm9uRHVyYXRpb25DaGFuZ2UiLCAib25EdXJhdGlvbkNoYW5nZUNhcHR1cmUiLCAib25FbXB0aWVkIiwgIm9uRW1wdGllZENhcHR1cmUiLCAib25FbmNyeXB0ZWQiLCAib25FbmNyeXB0ZWRDYXB0dXJlIiwgIm9uRW5kZWQiLCAib25FbmRlZENhcHR1cmUiLCAib25Mb2FkZWREYXRhIiwgIm9uTG9hZGVkRGF0YUNhcHR1cmUiLCAib25Mb2FkZWRNZXRhZGF0YSIsICJvbkxvYWRlZE1ldGFkYXRhQ2FwdHVyZSIsICJvbkxvYWRTdGFydCIsICJvbkxvYWRTdGFydENhcHR1cmUiLCAib25QYXVzZSIsICJvblBhdXNlQ2FwdHVyZSIsICJvblBsYXkiLCAib25QbGF5Q2FwdHVyZSIsICJvblBsYXlpbmciLCAib25QbGF5aW5nQ2FwdHVyZSIsICJvblByb2dyZXNzIiwgIm9uUHJvZ3Jlc3NDYXB0dXJlIiwgIm9uUmF0ZUNoYW5nZSIsICJvblJhdGVDaGFuZ2VDYXB0dXJlIiwgIm9uU2Vla2VkIiwgIm9uU2Vla2VkQ2FwdHVyZSIsICJvblNlZWtpbmciLCAib25TZWVraW5nQ2FwdHVyZSIsICJvblN0YWxsZWQiLCAib25TdGFsbGVkQ2FwdHVyZSIsICJvblN1c3BlbmQiLCAib25TdXNwZW5kQ2FwdHVyZSIsICJvblRpbWVVcGRhdGUiLCAib25UaW1lVXBkYXRlQ2FwdHVyZSIsICJvblZvbHVtZUNoYW5nZSIsICJvblZvbHVtZUNoYW5nZUNhcHR1cmUiLCAib25XYWl0aW5nIiwgIm9uV2FpdGluZ0NhcHR1cmUiLCAib25BdXhDbGljayIsICJvbkF1eENsaWNrQ2FwdHVyZSIsICJvbkNsaWNrIiwgIm9uQ2xpY2tDYXB0dXJlIiwgIm9uQ29udGV4dE1lbnUiLCAib25Db250ZXh0TWVudUNhcHR1cmUiLCAib25Eb3VibGVDbGljayIsICJvbkRvdWJsZUNsaWNrQ2FwdHVyZSIsICJvbkRyYWciLCAib25EcmFnQ2FwdHVyZSIsICJvbkRyYWdFbmQiLCAib25EcmFnRW5kQ2FwdHVyZSIsICJvbkRyYWdFbnRlciIsICJvbkRyYWdFbnRlckNhcHR1cmUiLCAib25EcmFnRXhpdCIsICJvbkRyYWdFeGl0Q2FwdHVyZSIsICJvbkRyYWdMZWF2ZSIsICJvbkRyYWdMZWF2ZUNhcHR1cmUiLCAib25EcmFnT3ZlciIsICJvbkRyYWdPdmVyQ2FwdHVyZSIsICJvbkRyYWdTdGFydCIsICJvbkRyYWdTdGFydENhcHR1cmUiLCAib25Ecm9wIiwgIm9uRHJvcENhcHR1cmUiLCAib25Nb3VzZURvd24iLCAib25Nb3VzZURvd25DYXB0dXJlIiwgIm9uTW91c2VFbnRlciIsICJvbk1vdXNlTGVhdmUiLCAib25Nb3VzZU1vdmUiLCAib25Nb3VzZU1vdmVDYXB0dXJlIiwgIm9uTW91c2VPdXQiLCAib25Nb3VzZU91dENhcHR1cmUiLCAib25Nb3VzZU92ZXIiLCAib25Nb3VzZU92ZXJDYXB0dXJlIiwgIm9uTW91c2VVcCIsICJvbk1vdXNlVXBDYXB0dXJlIiwgIm9uU2VsZWN0IiwgIm9uU2VsZWN0Q2FwdHVyZSIsICJvblRvdWNoQ2FuY2VsIiwgIm9uVG91Y2hDYW5jZWxDYXB0dXJlIiwgIm9uVG91Y2hFbmQiLCAib25Ub3VjaEVuZENhcHR1cmUiLCAib25Ub3VjaE1vdmUiLCAib25Ub3VjaE1vdmVDYXB0dXJlIiwgIm9uVG91Y2hTdGFydCIsICJvblRvdWNoU3RhcnRDYXB0dXJlIiwgIm9uUG9pbnRlckRvd24iLCAib25Qb2ludGVyRG93bkNhcHR1cmUiLCAib25Qb2ludGVyTW92ZSIsICJvblBvaW50ZXJNb3ZlQ2FwdHVyZSIsICJvblBvaW50ZXJVcCIsICJvblBvaW50ZXJVcENhcHR1cmUiLCAib25Qb2ludGVyQ2FuY2VsIiwgIm9uUG9pbnRlckNhbmNlbENhcHR1cmUiLCAib25Qb2ludGVyRW50ZXIiLCAib25Qb2ludGVyRW50ZXJDYXB0dXJlIiwgIm9uUG9pbnRlckxlYXZlIiwgIm9uUG9pbnRlckxlYXZlQ2FwdHVyZSIsICJvblBvaW50ZXJPdmVyIiwgIm9uUG9pbnRlck92ZXJDYXB0dXJlIiwgIm9uUG9pbnRlck91dCIsICJvblBvaW50ZXJPdXRDYXB0dXJlIiwgIm9uR290UG9pbnRlckNhcHR1cmUiLCAib25Hb3RQb2ludGVyQ2FwdHVyZUNhcHR1cmUiLCAib25Mb3N0UG9pbnRlckNhcHR1cmUiLCAib25Mb3N0UG9pbnRlckNhcHR1cmVDYXB0dXJlIiwgIm9uU2Nyb2xsIiwgIm9uU2Nyb2xsQ2FwdHVyZSIsICJvbldoZWVsIiwgIm9uV2hlZWxDYXB0dXJlIiwgIm9uQW5pbWF0aW9uU3RhcnQiLCAib25BbmltYXRpb25TdGFydENhcHR1cmUiLCAib25BbmltYXRpb25FbmQiLCAib25BbmltYXRpb25FbmRDYXB0dXJlIiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uIiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uQ2FwdHVyZSIsICJvblRyYW5zaXRpb25FbmQiLCAib25UcmFuc2l0aW9uRW5kQ2FwdHVyZSJdOwpmdW5jdGlvbiBpc0V2ZW50S2V5KGtleSkgewogIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgYWxsb3dlZEV2ZW50S2V5cyA9IEV2ZW50S2V5czsKICByZXR1cm4gYWxsb3dlZEV2ZW50S2V5cy5pbmNsdWRlcyhrZXkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc05vRXZlbnRzLmpzCnZhciBpbXBvcnRfcmVhY3QzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgU1ZHRWxlbWVudFByb3BLZXlzID0gWwogICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLAogICJhcmlhLWF0b21pYyIsCiAgImFyaWEtYXV0b2NvbXBsZXRlIiwKICAiYXJpYS1idXN5IiwKICAiYXJpYS1jaGVja2VkIiwKICAiYXJpYS1jb2xjb3VudCIsCiAgImFyaWEtY29saW5kZXgiLAogICJhcmlhLWNvbHNwYW4iLAogICJhcmlhLWNvbnRyb2xzIiwKICAiYXJpYS1jdXJyZW50IiwKICAiYXJpYS1kZXNjcmliZWRieSIsCiAgImFyaWEtZGV0YWlscyIsCiAgImFyaWEtZGlzYWJsZWQiLAogICJhcmlhLWVycm9ybWVzc2FnZSIsCiAgImFyaWEtZXhwYW5kZWQiLAogICJhcmlhLWZsb3d0byIsCiAgImFyaWEtaGFzcG9wdXAiLAogICJhcmlhLWhpZGRlbiIsCiAgImFyaWEtaW52YWxpZCIsCiAgImFyaWEta2V5c2hvcnRjdXRzIiwKICAiYXJpYS1sYWJlbCIsCiAgImFyaWEtbGFiZWxsZWRieSIsCiAgImFyaWEtbGV2ZWwiLAogICJhcmlhLWxpdmUiLAogICJhcmlhLW1vZGFsIiwKICAiYXJpYS1tdWx0aWxpbmUiLAogICJhcmlhLW11bHRpc2VsZWN0YWJsZSIsCiAgImFyaWEtb3JpZW50YXRpb24iLAogICJhcmlhLW93bnMiLAogICJhcmlhLXBsYWNlaG9sZGVyIiwKICAiYXJpYS1wb3NpbnNldCIsCiAgImFyaWEtcHJlc3NlZCIsCiAgImFyaWEtcmVhZG9ubHkiLAogICJhcmlhLXJlbGV2YW50IiwKICAiYXJpYS1yZXF1aXJlZCIsCiAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIiwKICAiYXJpYS1yb3djb3VudCIsCiAgImFyaWEtcm93aW5kZXgiLAogICJhcmlhLXJvd3NwYW4iLAogICJhcmlhLXNlbGVjdGVkIiwKICAiYXJpYS1zZXRzaXplIiwKICAiYXJpYS1zb3J0IiwKICAiYXJpYS12YWx1ZW1heCIsCiAgImFyaWEtdmFsdWVtaW4iLAogICJhcmlhLXZhbHVlbm93IiwKICAiYXJpYS12YWx1ZXRleHQiLAogICJjbGFzc05hbWUiLAogICJjb2xvciIsCiAgImhlaWdodCIsCiAgImlkIiwKICAibGFuZyIsCiAgIm1heCIsCiAgIm1lZGlhIiwKICAibWV0aG9kIiwKICAibWluIiwKICAibmFtZSIsCiAgInN0eWxlIiwKICAvKgogICAqIHJlbW92ZWQgJ3R5cGUnIFNWR0VsZW1lbnRQcm9wS2V5IGJlY2F1c2Ugd2UgZG8gbm90IGN1cnJlbnRseSB1c2UgYW55IFNWRyBlbGVtZW50cwogICAqIHRoYXQgY2FuIHVzZSBpdCwgYW5kIGl0IGNvbmZsaWN0cyB3aXRoIHRoZSByZWNoYXJ0cyBwcm9wICd0eXBlJwogICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9wdWxsLzMzMjcKICAgKiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9TVkcvQXR0cmlidXRlL3R5cGUKICAgKi8KICAvLyAndHlwZScsCiAgInRhcmdldCIsCiAgIndpZHRoIiwKICAicm9sZSIsCiAgInRhYkluZGV4IiwKICAiYWNjZW50SGVpZ2h0IiwKICAiYWNjdW11bGF0ZSIsCiAgImFkZGl0aXZlIiwKICAiYWxpZ25tZW50QmFzZWxpbmUiLAogICJhbGxvd1Jlb3JkZXIiLAogICJhbHBoYWJldGljIiwKICAiYW1wbGl0dWRlIiwKICAiYXJhYmljRm9ybSIsCiAgImFzY2VudCIsCiAgImF0dHJpYnV0ZU5hbWUiLAogICJhdHRyaWJ1dGVUeXBlIiwKICAiYXV0b1JldmVyc2UiLAogICJhemltdXRoIiwKICAiYmFzZUZyZXF1ZW5jeSIsCiAgImJhc2VsaW5lU2hpZnQiLAogICJiYXNlUHJvZmlsZSIsCiAgImJib3giLAogICJiZWdpbiIsCiAgImJpYXMiLAogICJieSIsCiAgImNhbGNNb2RlIiwKICAiY2FwSGVpZ2h0IiwKICAiY2xpcCIsCiAgImNsaXBQYXRoIiwKICAiY2xpcFBhdGhVbml0cyIsCiAgImNsaXBSdWxlIiwKICAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgImNvbG9yUHJvZmlsZSIsCiAgImNvbG9yUmVuZGVyaW5nIiwKICAiY29udGVudFNjcmlwdFR5cGUiLAogICJjb250ZW50U3R5bGVUeXBlIiwKICAiY3Vyc29yIiwKICAiY3giLAogICJjeSIsCiAgImQiLAogICJkZWNlbGVyYXRlIiwKICAiZGVzY2VudCIsCiAgImRpZmZ1c2VDb25zdGFudCIsCiAgImRpcmVjdGlvbiIsCiAgImRpc3BsYXkiLAogICJkaXZpc29yIiwKICAiZG9taW5hbnRCYXNlbGluZSIsCiAgImR1ciIsCiAgImR4IiwKICAiZHkiLAogICJlZGdlTW9kZSIsCiAgImVsZXZhdGlvbiIsCiAgImVuYWJsZUJhY2tncm91bmQiLAogICJlbmQiLAogICJleHBvbmVudCIsCiAgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLAogICJmaWxsIiwKICAiZmlsbE9wYWNpdHkiLAogICJmaWxsUnVsZSIsCiAgImZpbHRlciIsCiAgImZpbHRlclJlcyIsCiAgImZpbHRlclVuaXRzIiwKICAiZmxvb2RDb2xvciIsCiAgImZsb29kT3BhY2l0eSIsCiAgImZvY3VzYWJsZSIsCiAgImZvbnRGYW1pbHkiLAogICJmb250U2l6ZSIsCiAgImZvbnRTaXplQWRqdXN0IiwKICAiZm9udFN0cmV0Y2giLAogICJmb250U3R5bGUiLAogICJmb250VmFyaWFudCIsCiAgImZvbnRXZWlnaHQiLAogICJmb3JtYXQiLAogICJmcm9tIiwKICAiZngiLAogICJmeSIsCiAgImcxIiwKICAiZzIiLAogICJnbHlwaE5hbWUiLAogICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgImdseXBoUmVmIiwKICAiZ3JhZGllbnRUcmFuc2Zvcm0iLAogICJncmFkaWVudFVuaXRzIiwKICAiaGFuZ2luZyIsCiAgImhvcml6QWR2WCIsCiAgImhvcml6T3JpZ2luWCIsCiAgImhyZWYiLAogICJpZGVvZ3JhcGhpYyIsCiAgImltYWdlUmVuZGVyaW5nIiwKICAiaW4yIiwKICAiaW4iLAogICJpbnRlcmNlcHQiLAogICJrMSIsCiAgImsyIiwKICAiazMiLAogICJrNCIsCiAgImsiLAogICJrZXJuZWxNYXRyaXgiLAogICJrZXJuZWxVbml0TGVuZ3RoIiwKICAia2VybmluZyIsCiAgImtleVBvaW50cyIsCiAgImtleVNwbGluZXMiLAogICJrZXlUaW1lcyIsCiAgImxlbmd0aEFkanVzdCIsCiAgImxldHRlclNwYWNpbmciLAogICJsaWdodGluZ0NvbG9yIiwKICAibGltaXRpbmdDb25lQW5nbGUiLAogICJsb2NhbCIsCiAgIm1hcmtlckVuZCIsCiAgIm1hcmtlckhlaWdodCIsCiAgIm1hcmtlck1pZCIsCiAgIm1hcmtlclN0YXJ0IiwKICAibWFya2VyVW5pdHMiLAogICJtYXJrZXJXaWR0aCIsCiAgIm1hc2siLAogICJtYXNrQ29udGVudFVuaXRzIiwKICAibWFza1VuaXRzIiwKICAibWF0aGVtYXRpY2FsIiwKICAibW9kZSIsCiAgIm51bU9jdGF2ZXMiLAogICJvZmZzZXQiLAogICJvcGFjaXR5IiwKICAib3BlcmF0b3IiLAogICJvcmRlciIsCiAgIm9yaWVudCIsCiAgIm9yaWVudGF0aW9uIiwKICAib3JpZ2luIiwKICAib3ZlcmZsb3ciLAogICJvdmVybGluZVBvc2l0aW9uIiwKICAib3ZlcmxpbmVUaGlja25lc3MiLAogICJwYWludE9yZGVyIiwKICAicGFub3NlMSIsCiAgInBhdGhMZW5ndGgiLAogICJwYXR0ZXJuQ29udGVudFVuaXRzIiwKICAicGF0dGVyblRyYW5zZm9ybSIsCiAgInBhdHRlcm5Vbml0cyIsCiAgInBvaW50ZXJFdmVudHMiLAogICJwb2ludHNBdFgiLAogICJwb2ludHNBdFkiLAogICJwb2ludHNBdFoiLAogICJwcmVzZXJ2ZUFscGhhIiwKICAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgInByaW1pdGl2ZVVuaXRzIiwKICAiciIsCiAgInJhZGl1cyIsCiAgInJlZlgiLAogICJyZWZZIiwKICAicmVuZGVyaW5nSW50ZW50IiwKICAicmVwZWF0Q291bnQiLAogICJyZXBlYXREdXIiLAogICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICJyZXF1aXJlZEZlYXR1cmVzIiwKICAicmVzdGFydCIsCiAgInJlc3VsdCIsCiAgInJvdGF0ZSIsCiAgInJ4IiwKICAicnkiLAogICJzZWVkIiwKICAic2hhcGVSZW5kZXJpbmciLAogICJzbG9wZSIsCiAgInNwYWNpbmciLAogICJzcGVjdWxhckNvbnN0YW50IiwKICAic3BlY3VsYXJFeHBvbmVudCIsCiAgInNwZWVkIiwKICAic3ByZWFkTWV0aG9kIiwKICAic3RhcnRPZmZzZXQiLAogICJzdGREZXZpYXRpb24iLAogICJzdGVtaCIsCiAgInN0ZW12IiwKICAic3RpdGNoVGlsZXMiLAogICJzdG9wQ29sb3IiLAogICJzdG9wT3BhY2l0eSIsCiAgInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICJzdHJpbmciLAogICJzdHJva2UiLAogICJzdHJva2VEYXNoYXJyYXkiLAogICJzdHJva2VEYXNob2Zmc2V0IiwKICAic3Ryb2tlTGluZWNhcCIsCiAgInN0cm9rZUxpbmVqb2luIiwKICAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgInN0cm9rZU9wYWNpdHkiLAogICJzdHJva2VXaWR0aCIsCiAgInN1cmZhY2VTY2FsZSIsCiAgInN5c3RlbUxhbmd1YWdlIiwKICAidGFibGVWYWx1ZXMiLAogICJ0YXJnZXRYIiwKICAidGFyZ2V0WSIsCiAgInRleHRBbmNob3IiLAogICJ0ZXh0RGVjb3JhdGlvbiIsCiAgInRleHRMZW5ndGgiLAogICJ0ZXh0UmVuZGVyaW5nIiwKICAidG8iLAogICJ0cmFuc2Zvcm0iLAogICJ1MSIsCiAgInUyIiwKICAidW5kZXJsaW5lUG9zaXRpb24iLAogICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICJ1bmljb2RlIiwKICAidW5pY29kZUJpZGkiLAogICJ1bmljb2RlUmFuZ2UiLAogICJ1bml0c1BlckVtIiwKICAidkFscGhhYmV0aWMiLAogICJ2YWx1ZXMiLAogICJ2ZWN0b3JFZmZlY3QiLAogICJ2ZXJzaW9uIiwKICAidmVydEFkdlkiLAogICJ2ZXJ0T3JpZ2luWCIsCiAgInZlcnRPcmlnaW5ZIiwKICAidkhhbmdpbmciLAogICJ2SWRlb2dyYXBoaWMiLAogICJ2aWV3VGFyZ2V0IiwKICAidmlzaWJpbGl0eSIsCiAgInZNYXRoZW1hdGljYWwiLAogICJ3aWR0aHMiLAogICJ3b3JkU3BhY2luZyIsCiAgIndyaXRpbmdNb2RlIiwKICAieDEiLAogICJ4MiIsCiAgIngiLAogICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAieEhlaWdodCIsCiAgInhsaW5rQWN0dWF0ZSIsCiAgInhsaW5rQXJjcm9sZSIsCiAgInhsaW5rSHJlZiIsCiAgInhsaW5rUm9sZSIsCiAgInhsaW5rU2hvdyIsCiAgInhsaW5rVGl0bGUiLAogICJ4bGlua1R5cGUiLAogICJ4bWxCYXNlIiwKICAieG1sTGFuZyIsCiAgInhtbG5zIiwKICAieG1sbnNYbGluayIsCiAgInhtbFNwYWNlIiwKICAieTEiLAogICJ5MiIsCiAgInkiLAogICJ5Q2hhbm5lbFNlbGVjdG9yIiwKICAieiIsCiAgInpvb21BbmRQYW4iLAogICJyZWYiLAogICJrZXkiLAogICJhbmdsZSIKXTsKdmFyIFNWR0VsZW1lbnRQcm9wS2V5U2V0ID0gbmV3IFNldChTVkdFbGVtZW50UHJvcEtleXMpOwpmdW5jdGlvbiBpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgewogIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gU1ZHRWxlbWVudFByb3BLZXlTZXQuaGFzKGtleSk7Cn0KZnVuY3Rpb24gaXNEYXRhQXR0cmlidXRlKGtleSkgewogIHJldHVybiB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiAmJiBrZXkuc3RhcnRzV2l0aCgiZGF0YS0iKTsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMob2JqKSB7CiAgaWYgKHR5cGVvZiBvYmogIT09ICJvYmplY3QiIHx8IG9iaiA9PT0gbnVsbCkgewogICAgcmV0dXJuIHt9OwogIH0KICB2YXIgcmVzdWx0ID0ge307CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsKICAgICAgaWYgKGlzU3ZnRWxlbWVudFByb3BLZXkoa2V5KSB8fCBpc0RhdGFBdHRyaWJ1dGUoa2V5KSkgewogICAgICAgIHJlc3VsdFtrZXldID0gb2JqW2tleV07CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihpbnB1dCkgewogIGlmIChpbnB1dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0My5pc1ZhbGlkRWxlbWVudCkoaW5wdXQpICYmIHR5cGVvZiBpbnB1dC5wcm9wcyA9PT0gIm9iamVjdCIgJiYgaW5wdXQucHJvcHMgIT09IG51bGwpIHsKICAgIHZhciBwID0gaW5wdXQucHJvcHM7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc05vRXZlbnRzKHApOwogIH0KICBpZiAodHlwZW9mIGlucHV0ID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShpbnB1dCkpIHsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoaW5wdXQpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3N2Z1Byb3BlcnRpZXNBbmRFdmVudHMuanMKZnVuY3Rpb24gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvYmopIHsKICB2YXIgcmVzdWx0ID0ge307CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsKICAgICAgaWYgKGlzU3ZnRWxlbWVudFByb3BLZXkoa2V5KSB8fCBpc0RhdGFBdHRyaWJ1dGUoa2V5KSB8fCBpc0V2ZW50S2V5KGtleSkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IG9ialtrZXldOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gc3ZnUHJvcGVydGllc0FuZEV2ZW50c0Zyb21Vbmtub3duKGlucHV0KSB7CiAgaWYgKGlucHV0ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0LmlzVmFsaWRFbGVtZW50KShpbnB1dCkpIHsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKGlucHV0LnByb3BzKTsKICB9CiAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gIm9iamVjdCIgJiYgIUFycmF5LmlzQXJyYXkoaW5wdXQpKSB7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhpbnB1dCk7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9TdXJmYWNlLmpzCnZhciBfZXhjbHVkZWQgPSBbImNoaWxkcmVuIiwgIndpZHRoIiwgImhlaWdodCIsICJ2aWV3Qm94IiwgImNsYXNzTmFtZSIsICJzdHlsZSIsICJ0aXRsZSIsICJkZXNjIl07CmZ1bmN0aW9uIF9leHRlbmRzKCkgewogIHJldHVybiBfZXh0ZW5kcyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIFN1cmZhY2UgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHZpZXdCb3gsCiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIHRpdGxlLAogICAgZGVzYwogIH0gPSBwcm9wcywgb3RoZXJzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKHByb3BzLCBfZXhjbHVkZWQpOwogIHZhciBzdmdWaWV3ID0gdmlld0JveCB8fCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHg6IDAsCiAgICB5OiAwCiAgfTsKICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLXN1cmZhY2UiLCBjbGFzc05hbWUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QuY3JlYXRlRWxlbWVudCgic3ZnIiwgX2V4dGVuZHMoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMob3RoZXJzKSwgewogICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHlsZSwKICAgIHZpZXdCb3g6ICIiLmNvbmNhdChzdmdWaWV3LngsICIgIikuY29uY2F0KHN2Z1ZpZXcueSwgIiAiKS5jb25jYXQoc3ZnVmlldy53aWR0aCwgIiAiKS5jb25jYXQoc3ZnVmlldy5oZWlnaHQpLAogICAgcmVmCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdC5jcmVhdGVFbGVtZW50KCJ0aXRsZSIsIG51bGwsIHRpdGxlKSwgLyogQF9fUFVSRV9fICovIFJlYWN0LmNyZWF0ZUVsZW1lbnQoImRlc2MiLCBudWxsLCBkZXNjKSwgY2hpbGRyZW4pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL0xheWVyLmpzCnZhciBSZWFjdDIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQyID0gWyJjaGlsZHJlbiIsICJjbGFzc05hbWUiXTsKZnVuY3Rpb24gX2V4dGVuZHMyKCkgewogIHJldHVybiBfZXh0ZW5kczIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMyKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgTGF5ZXIgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyLmZvcndhcmRSZWYoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczIocHJvcHMsIF9leGNsdWRlZDIpOwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtbGF5ZXIiLCBjbGFzc05hbWUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyLmNyZWF0ZUVsZW1lbnQoImciLCBfZXh0ZW5kczIoewogICAgY2xhc3NOYW1lOiBsYXllckNsYXNzCiAgfSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvdGhlcnMpLCB7CiAgICByZWYKICB9KSwgY2hpbGRyZW4pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9sZWdlbmRQb3J0YWxDb250ZXh0LmpzCnZhciBpbXBvcnRfcmVhY3Q2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgTGVnZW5kUG9ydGFsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0Ni5jcmVhdGVDb250ZXh0KShudWxsKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvU3ltYm9scy5qcwp2YXIgUmVhY3QzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jb25zdGFudC5qcwpmdW5jdGlvbiBjb25zdGFudF9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbnN0YW50KCkgewogICAgcmV0dXJuIHgyOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvbWF0aC5qcwp2YXIgY29zID0gTWF0aC5jb3M7CnZhciBzaW4gPSBNYXRoLnNpbjsKdmFyIHNxcnQgPSBNYXRoLnNxcnQ7CnZhciBwaSA9IE1hdGguUEk7CnZhciBoYWxmUGkgPSBwaSAvIDI7CnZhciB0YXUgPSAyICogcGk7CgovLyBub2RlX21vZHVsZXMvZDMtcGF0aC9zcmMvcGF0aC5qcwp2YXIgcGkyID0gTWF0aC5QSTsKdmFyIHRhdTIgPSAyICogcGkyOwp2YXIgZXBzaWxvbiA9IDFlLTY7CnZhciB0YXVFcHNpbG9uID0gdGF1MiAtIGVwc2lsb247CmZ1bmN0aW9uIGFwcGVuZChzdHJpbmdzKSB7CiAgdGhpcy5fICs9IHN0cmluZ3NbMF07CiAgZm9yIChsZXQgaSA9IDEsIG4gPSBzdHJpbmdzLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgdGhpcy5fICs9IGFyZ3VtZW50c1tpXSArIHN0cmluZ3NbaV07CiAgfQp9CmZ1bmN0aW9uIGFwcGVuZFJvdW5kKGRpZ2l0cykgewogIGxldCBkID0gTWF0aC5mbG9vcihkaWdpdHMpOwogIGlmICghKGQgPj0gMCkpIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBkaWdpdHM6ICR7ZGlnaXRzfWApOwogIGlmIChkID4gMTUpIHJldHVybiBhcHBlbmQ7CiAgY29uc3QgazIgPSAxMCAqKiBkOwogIHJldHVybiBmdW5jdGlvbihzdHJpbmdzKSB7CiAgICB0aGlzLl8gKz0gc3RyaW5nc1swXTsKICAgIGZvciAobGV0IGkgPSAxLCBuID0gc3RyaW5ncy5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgICAgdGhpcy5fICs9IE1hdGgucm91bmQoYXJndW1lbnRzW2ldICogazIpIC8gazIgKyBzdHJpbmdzW2ldOwogICAgfQogIH07Cn0KdmFyIFBhdGggPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoZGlnaXRzKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3kwID0gLy8gc3RhcnQgb2YgY3VycmVudCBzdWJwYXRoCiAgICB0aGlzLl94MSA9IHRoaXMuX3kxID0gbnVsbDsKICAgIHRoaXMuXyA9ICIiOwogICAgdGhpcy5fYXBwZW5kID0gZGlnaXRzID09IG51bGwgPyBhcHBlbmQgOiBhcHBlbmRSb3VuZChkaWdpdHMpOwogIH0KICBtb3ZlVG8oeDIsIHkyKSB7CiAgICB0aGlzLl9hcHBlbmRgTSR7dGhpcy5feDAgPSB0aGlzLl94MSA9ICt4Mn0sJHt0aGlzLl95MCA9IHRoaXMuX3kxID0gK3kyfWA7CiAgfQogIGNsb3NlUGF0aCgpIHsKICAgIGlmICh0aGlzLl94MSAhPT0gbnVsbCkgewogICAgICB0aGlzLl94MSA9IHRoaXMuX3gwLCB0aGlzLl95MSA9IHRoaXMuX3kwOwogICAgICB0aGlzLl9hcHBlbmRgWmA7CiAgICB9CiAgfQogIGxpbmVUbyh4MiwgeTIpIHsKICAgIHRoaXMuX2FwcGVuZGBMJHt0aGlzLl94MSA9ICt4Mn0sJHt0aGlzLl95MSA9ICt5Mn1gOwogIH0KICBxdWFkcmF0aWNDdXJ2ZVRvKHgxLCB5MSwgeDIsIHkyKSB7CiAgICB0aGlzLl9hcHBlbmRgUSR7K3gxfSwkeyt5MX0sJHt0aGlzLl94MSA9ICt4Mn0sJHt0aGlzLl95MSA9ICt5Mn1gOwogIH0KICBiZXppZXJDdXJ2ZVRvKHgxLCB5MSwgeDIsIHkyLCB4MywgeTMpIHsKICAgIHRoaXMuX2FwcGVuZGBDJHsreDF9LCR7K3kxfSwkeyt4Mn0sJHsreTJ9LCR7dGhpcy5feDEgPSAreDN9LCR7dGhpcy5feTEgPSAreTN9YDsKICB9CiAgYXJjVG8oeDEsIHkxLCB4MiwgeTIsIHIyKSB7CiAgICB4MSA9ICt4MSwgeTEgPSAreTEsIHgyID0gK3gyLCB5MiA9ICt5MiwgcjIgPSArcjI7CiAgICBpZiAocjIgPCAwKSB0aHJvdyBuZXcgRXJyb3IoYG5lZ2F0aXZlIHJhZGl1czogJHtyMn1gKTsKICAgIGxldCB4MCA9IHRoaXMuX3gxLCB5MCA9IHRoaXMuX3kxLCB4MjEgPSB4MiAtIHgxLCB5MjEgPSB5MiAtIHkxLCB4MDEgPSB4MCAtIHgxLCB5MDEgPSB5MCAtIHkxLCBsMDFfMiA9IHgwMSAqIHgwMSArIHkwMSAqIHkwMTsKICAgIGlmICh0aGlzLl94MSA9PT0gbnVsbCkgewogICAgICB0aGlzLl9hcHBlbmRgTSR7dGhpcy5feDEgPSB4MX0sJHt0aGlzLl95MSA9IHkxfWA7CiAgICB9IGVsc2UgaWYgKCEobDAxXzIgPiBlcHNpbG9uKSkgOwogICAgZWxzZSBpZiAoIShNYXRoLmFicyh5MDEgKiB4MjEgLSB5MjEgKiB4MDEpID4gZXBzaWxvbikgfHwgIXIyKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBMJHt0aGlzLl94MSA9IHgxfSwke3RoaXMuX3kxID0geTF9YDsKICAgIH0gZWxzZSB7CiAgICAgIGxldCB4MjAgPSB4MiAtIHgwLCB5MjAgPSB5MiAtIHkwLCBsMjFfMiA9IHgyMSAqIHgyMSArIHkyMSAqIHkyMSwgbDIwXzIgPSB4MjAgKiB4MjAgKyB5MjAgKiB5MjAsIGwyMSA9IE1hdGguc3FydChsMjFfMiksIGwwMSA9IE1hdGguc3FydChsMDFfMiksIGwgPSByMiAqIE1hdGgudGFuKChwaTIgLSBNYXRoLmFjb3MoKGwyMV8yICsgbDAxXzIgLSBsMjBfMikgLyAoMiAqIGwyMSAqIGwwMSkpKSAvIDIpLCB0MDEgPSBsIC8gbDAxLCB0MjEgPSBsIC8gbDIxOwogICAgICBpZiAoTWF0aC5hYnModDAxIC0gMSkgPiBlcHNpbG9uKSB7CiAgICAgICAgdGhpcy5fYXBwZW5kYEwke3gxICsgdDAxICogeDAxfSwke3kxICsgdDAxICogeTAxfWA7CiAgICAgIH0KICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLDAsJHsrKHkwMSAqIHgyMCA+IHgwMSAqIHkyMCl9LCR7dGhpcy5feDEgPSB4MSArIHQyMSAqIHgyMX0sJHt0aGlzLl95MSA9IHkxICsgdDIxICogeTIxfWA7CiAgICB9CiAgfQogIGFyYyh4MiwgeTIsIHIyLCBhMCwgYTEsIGNjdykgewogICAgeDIgPSAreDIsIHkyID0gK3kyLCByMiA9ICtyMiwgY2N3ID0gISFjY3c7CiAgICBpZiAocjIgPCAwKSB0aHJvdyBuZXcgRXJyb3IoYG5lZ2F0aXZlIHJhZGl1czogJHtyMn1gKTsKICAgIGxldCBkeCA9IHIyICogTWF0aC5jb3MoYTApLCBkeSA9IHIyICogTWF0aC5zaW4oYTApLCB4MCA9IHgyICsgZHgsIHkwID0geTIgKyBkeSwgY3cgPSAxIF4gY2N3LCBkYSA9IGNjdyA/IGEwIC0gYTEgOiBhMSAtIGEwOwogICAgaWYgKHRoaXMuX3gxID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBNJHt4MH0sJHt5MH1gOwogICAgfSBlbHNlIGlmIChNYXRoLmFicyh0aGlzLl94MSAtIHgwKSA+IGVwc2lsb24gfHwgTWF0aC5hYnModGhpcy5feTEgLSB5MCkgPiBlcHNpbG9uKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBMJHt4MH0sJHt5MH1gOwogICAgfQogICAgaWYgKCFyMikgcmV0dXJuOwogICAgaWYgKGRhIDwgMCkgZGEgPSBkYSAlIHRhdTIgKyB0YXUyOwogICAgaWYgKGRhID4gdGF1RXBzaWxvbikgewogICAgICB0aGlzLl9hcHBlbmRgQSR7cjJ9LCR7cjJ9LDAsMSwke2N3fSwke3gyIC0gZHh9LCR7eTIgLSBkeX1BJHtyMn0sJHtyMn0sMCwxLCR7Y3d9LCR7dGhpcy5feDEgPSB4MH0sJHt0aGlzLl95MSA9IHkwfWA7CiAgICB9IGVsc2UgaWYgKGRhID4gZXBzaWxvbikgewogICAgICB0aGlzLl9hcHBlbmRgQSR7cjJ9LCR7cjJ9LDAsJHsrKGRhID49IHBpMil9LCR7Y3d9LCR7dGhpcy5feDEgPSB4MiArIHIyICogTWF0aC5jb3MoYTEpfSwke3RoaXMuX3kxID0geTIgKyByMiAqIE1hdGguc2luKGExKX1gOwogICAgfQogIH0KICByZWN0KHgyLCB5MiwgdywgaCkgewogICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gwID0gdGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTAgPSB0aGlzLl95MSA9ICt5Mn1oJHt3ID0gK3d9diR7K2h9aCR7LXd9WmA7CiAgfQogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuXzsKICB9Cn07CmZ1bmN0aW9uIHBhdGgoKSB7CiAgcmV0dXJuIG5ldyBQYXRoKCk7Cn0KcGF0aC5wcm90b3R5cGUgPSBQYXRoLnByb3RvdHlwZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvcGF0aC5qcwpmdW5jdGlvbiB3aXRoUGF0aChzaGFwZSkgewogIGxldCBkaWdpdHMgPSAzOwogIHNoYXBlLmRpZ2l0cyA9IGZ1bmN0aW9uKF8pIHsKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGRpZ2l0czsKICAgIGlmIChfID09IG51bGwpIHsKICAgICAgZGlnaXRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGQgPSBNYXRoLmZsb29yKF8pOwogICAgICBpZiAoIShkID49IDApKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcihgaW52YWxpZCBkaWdpdHM6ICR7X31gKTsKICAgICAgZGlnaXRzID0gZDsKICAgIH0KICAgIHJldHVybiBzaGFwZTsKICB9OwogIHJldHVybiAoKSA9PiBuZXcgUGF0aChkaWdpdHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2FycmF5LmpzCnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKZnVuY3Rpb24gYXJyYXlfZGVmYXVsdCh4MikgewogIHJldHVybiB0eXBlb2YgeDIgPT09ICJvYmplY3QiICYmICJsZW5ndGgiIGluIHgyID8geDIgOiBBcnJheS5mcm9tKHgyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9saW5lYXIuanMKZnVuY3Rpb24gTGluZWFyKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpMaW5lYXIucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQp9OwpmdW5jdGlvbiBsaW5lYXJfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBMaW5lYXIoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvcG9pbnQuanMKZnVuY3Rpb24geChwKSB7CiAgcmV0dXJuIHBbMF07Cn0KZnVuY3Rpb24geShwKSB7CiAgcmV0dXJuIHBbMV07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvbGluZS5qcwpmdW5jdGlvbiBsaW5lX2RlZmF1bHQoeDIsIHkyKSB7CiAgdmFyIGRlZmluZWQyID0gY29uc3RhbnRfZGVmYXVsdCh0cnVlKSwgY29udGV4dCA9IG51bGwsIGN1cnZlID0gbGluZWFyX2RlZmF1bHQsIG91dHB1dCA9IG51bGwsIHBhdGgyID0gd2l0aFBhdGgobGluZSk7CiAgeDIgPSB0eXBlb2YgeDIgPT09ICJmdW5jdGlvbiIgPyB4MiA6IHgyID09PSB2b2lkIDAgPyB4IDogY29uc3RhbnRfZGVmYXVsdCh4Mik7CiAgeTIgPSB0eXBlb2YgeTIgPT09ICJmdW5jdGlvbiIgPyB5MiA6IHkyID09PSB2b2lkIDAgPyB5IDogY29uc3RhbnRfZGVmYXVsdCh5Mik7CiAgZnVuY3Rpb24gbGluZShkYXRhKSB7CiAgICB2YXIgaSwgbiA9IChkYXRhID0gYXJyYXlfZGVmYXVsdChkYXRhKSkubGVuZ3RoLCBkLCBkZWZpbmVkMCA9IGZhbHNlLCBidWZmZXI7CiAgICBpZiAoY29udGV4dCA9PSBudWxsKSBvdXRwdXQgPSBjdXJ2ZShidWZmZXIgPSBwYXRoMigpKTsKICAgIGZvciAoaSA9IDA7IGkgPD0gbjsgKytpKSB7CiAgICAgIGlmICghKGkgPCBuICYmIGRlZmluZWQyKGQgPSBkYXRhW2ldLCBpLCBkYXRhKSkgPT09IGRlZmluZWQwKSB7CiAgICAgICAgaWYgKGRlZmluZWQwID0gIWRlZmluZWQwKSBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgZWxzZSBvdXRwdXQubGluZUVuZCgpOwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkMCkgb3V0cHV0LnBvaW50KCt4MihkLCBpLCBkYXRhKSwgK3kyKGQsIGksIGRhdGEpKTsKICAgIH0KICAgIGlmIChidWZmZXIpIHJldHVybiBvdXRwdXQgPSBudWxsLCBidWZmZXIgKyAiIiB8fCBudWxsOwogIH0KICBsaW5lLnggPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBsaW5lKSA6IHgyOwogIH07CiAgbGluZS55ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeTIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgbGluZSkgOiB5MjsKICB9OwogIGxpbmUuZGVmaW5lZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRlZmluZWQyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCghIV8pLCBsaW5lKSA6IGRlZmluZWQyOwogIH07CiAgbGluZS5jdXJ2ZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGN1cnZlID0gXywgY29udGV4dCAhPSBudWxsICYmIChvdXRwdXQgPSBjdXJ2ZShjb250ZXh0KSksIGxpbmUpIDogY3VydmU7CiAgfTsKICBsaW5lLmNvbnRleHQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChfID09IG51bGwgPyBjb250ZXh0ID0gb3V0cHV0ID0gbnVsbCA6IG91dHB1dCA9IGN1cnZlKGNvbnRleHQgPSBfKSwgbGluZSkgOiBjb250ZXh0OwogIH07CiAgcmV0dXJuIGxpbmU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvYXJlYS5qcwpmdW5jdGlvbiBhcmVhX2RlZmF1bHQoeDAsIHkwLCB5MSkgewogIHZhciB4MSA9IG51bGwsIGRlZmluZWQyID0gY29uc3RhbnRfZGVmYXVsdCh0cnVlKSwgY29udGV4dCA9IG51bGwsIGN1cnZlID0gbGluZWFyX2RlZmF1bHQsIG91dHB1dCA9IG51bGwsIHBhdGgyID0gd2l0aFBhdGgoYXJlYSk7CiAgeDAgPSB0eXBlb2YgeDAgPT09ICJmdW5jdGlvbiIgPyB4MCA6IHgwID09PSB2b2lkIDAgPyB4IDogY29uc3RhbnRfZGVmYXVsdCgreDApOwogIHkwID0gdHlwZW9mIHkwID09PSAiZnVuY3Rpb24iID8geTAgOiB5MCA9PT0gdm9pZCAwID8gY29uc3RhbnRfZGVmYXVsdCgwKSA6IGNvbnN0YW50X2RlZmF1bHQoK3kwKTsKICB5MSA9IHR5cGVvZiB5MSA9PT0gImZ1bmN0aW9uIiA/IHkxIDogeTEgPT09IHZvaWQgMCA/IHkgOiBjb25zdGFudF9kZWZhdWx0KCt5MSk7CiAgZnVuY3Rpb24gYXJlYShkYXRhKSB7CiAgICB2YXIgaSwgaiwgazIsIG4gPSAoZGF0YSA9IGFycmF5X2RlZmF1bHQoZGF0YSkpLmxlbmd0aCwgZCwgZGVmaW5lZDAgPSBmYWxzZSwgYnVmZmVyLCB4MHogPSBuZXcgQXJyYXkobiksIHkweiA9IG5ldyBBcnJheShuKTsKICAgIGlmIChjb250ZXh0ID09IG51bGwpIG91dHB1dCA9IGN1cnZlKGJ1ZmZlciA9IHBhdGgyKCkpOwogICAgZm9yIChpID0gMDsgaSA8PSBuOyArK2kpIHsKICAgICAgaWYgKCEoaSA8IG4gJiYgZGVmaW5lZDIoZCA9IGRhdGFbaV0sIGksIGRhdGEpKSA9PT0gZGVmaW5lZDApIHsKICAgICAgICBpZiAoZGVmaW5lZDAgPSAhZGVmaW5lZDApIHsKICAgICAgICAgIGogPSBpOwogICAgICAgICAgb3V0cHV0LmFyZWFTdGFydCgpOwogICAgICAgICAgb3V0cHV0LmxpbmVTdGFydCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvdXRwdXQubGluZUVuZCgpOwogICAgICAgICAgb3V0cHV0LmxpbmVTdGFydCgpOwogICAgICAgICAgZm9yIChrMiA9IGkgLSAxOyBrMiA+PSBqOyAtLWsyKSB7CiAgICAgICAgICAgIG91dHB1dC5wb2ludCh4MHpbazJdLCB5MHpbazJdKTsKICAgICAgICAgIH0KICAgICAgICAgIG91dHB1dC5saW5lRW5kKCk7CiAgICAgICAgICBvdXRwdXQuYXJlYUVuZCgpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZGVmaW5lZDApIHsKICAgICAgICB4MHpbaV0gPSAreDAoZCwgaSwgZGF0YSksIHkweltpXSA9ICt5MChkLCBpLCBkYXRhKTsKICAgICAgICBvdXRwdXQucG9pbnQoeDEgPyAreDEoZCwgaSwgZGF0YSkgOiB4MHpbaV0sIHkxID8gK3kxKGQsIGksIGRhdGEpIDogeTB6W2ldKTsKICAgICAgfQogICAgfQogICAgaWYgKGJ1ZmZlcikgcmV0dXJuIG91dHB1dCA9IG51bGwsIGJ1ZmZlciArICIiIHx8IG51bGw7CiAgfQogIGZ1bmN0aW9uIGFyZWFsaW5lKCkgewogICAgcmV0dXJuIGxpbmVfZGVmYXVsdCgpLmRlZmluZWQoZGVmaW5lZDIpLmN1cnZlKGN1cnZlKS5jb250ZXh0KGNvbnRleHQpOwogIH0KICBhcmVhLnggPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCB4MSA9IG51bGwsIGFyZWEpIDogeDA7CiAgfTsKICBhcmVhLngwID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB4MDsKICB9OwogIGFyZWEueDEgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MSA9IF8gPT0gbnVsbCA/IG51bGwgOiB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB4MTsKICB9OwogIGFyZWEueSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkwID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIHkxID0gbnVsbCwgYXJlYSkgOiB5MDsKICB9OwogIGFyZWEueTAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHkwOwogIH07CiAgYXJlYS55MSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkxID0gXyA9PSBudWxsID8gbnVsbCA6IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHkxOwogIH07CiAgYXJlYS5saW5lWDAgPSBhcmVhLmxpbmVZMCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MCkueSh5MCk7CiAgfTsKICBhcmVhLmxpbmVZMSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MCkueSh5MSk7CiAgfTsKICBhcmVhLmxpbmVYMSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MSkueSh5MCk7CiAgfTsKICBhcmVhLmRlZmluZWQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkZWZpbmVkMiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoISFfKSwgYXJlYSkgOiBkZWZpbmVkMjsKICB9OwogIGFyZWEuY3VydmUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjdXJ2ZSA9IF8sIGNvbnRleHQgIT0gbnVsbCAmJiAob3V0cHV0ID0gY3VydmUoY29udGV4dCkpLCBhcmVhKSA6IGN1cnZlOwogIH07CiAgYXJlYS5jb250ZXh0ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoXyA9PSBudWxsID8gY29udGV4dCA9IG91dHB1dCA9IG51bGwgOiBvdXRwdXQgPSBjdXJ2ZShjb250ZXh0ID0gXyksIGFyZWEpIDogY29udGV4dDsKICB9OwogIHJldHVybiBhcmVhOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2J1bXAuanMKdmFyIEJ1bXAgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29udGV4dCwgeDIpIHsKICAgIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0OwogICAgdGhpcy5feCA9IHgyOwogIH0KICBhcmVhU3RhcnQoKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9CiAgYXJlYUVuZCgpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfQogIGxpbmVTdGFydCgpIHsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9CiAgbGluZUVuZCgpIHsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfQogIHBvaW50KHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6IHsKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgaWYgKHRoaXMuX2xpbmUpIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgZWxzZSB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICBpZiAodGhpcy5feCkgdGhpcy5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHRoaXMuX3gwID0gKHRoaXMuX3gwICsgeDIpIC8gMiwgdGhpcy5feTAsIHRoaXMuX3gwLCB5MiwgeDIsIHkyKTsKICAgICAgICBlbHNlIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh0aGlzLl94MCwgdGhpcy5feTAgPSAodGhpcy5feTAgKyB5MikgLyAyLCB4MiwgdGhpcy5feTAsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3gwID0geDIsIHRoaXMuX3kwID0geTI7CiAgfQp9OwpmdW5jdGlvbiBidW1wWChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCdW1wKGNvbnRleHQsIHRydWUpOwp9CmZ1bmN0aW9uIGJ1bXBZKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJ1bXAoY29udGV4dCwgZmFsc2UpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3N5bWJvbC9jaXJjbGUuanMKdmFyIGNpcmNsZV9kZWZhdWx0ID0gewogIGRyYXcoY29udGV4dCwgc2l6ZSkgewogICAgY29uc3QgcjIgPSBzcXJ0KHNpemUgLyBwaSk7CiAgICBjb250ZXh0Lm1vdmVUbyhyMiwgMCk7CiAgICBjb250ZXh0LmFyYygwLCAwLCByMiwgMCwgdGF1KTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3N5bWJvbC9jcm9zcy5qcwp2YXIgY3Jvc3NfZGVmYXVsdCA9IHsKICBkcmF3KGNvbnRleHQsIHNpemUpIHsKICAgIGNvbnN0IHIyID0gc3FydChzaXplIC8gNSkgLyAyOwogICAgY29udGV4dC5tb3ZlVG8oLTMgKiByMiwgLXIyKTsKICAgIGNvbnRleHQubGluZVRvKC1yMiwgLXIyKTsKICAgIGNvbnRleHQubGluZVRvKC1yMiwgLTMgKiByMik7CiAgICBjb250ZXh0LmxpbmVUbyhyMiwgLTMgKiByMik7CiAgICBjb250ZXh0LmxpbmVUbyhyMiwgLXIyKTsKICAgIGNvbnRleHQubGluZVRvKDMgKiByMiwgLXIyKTsKICAgIGNvbnRleHQubGluZVRvKDMgKiByMiwgcjIpOwogICAgY29udGV4dC5saW5lVG8ocjIsIHIyKTsKICAgIGNvbnRleHQubGluZVRvKHIyLCAzICogcjIpOwogICAgY29udGV4dC5saW5lVG8oLXIyLCAzICogcjIpOwogICAgY29udGV4dC5saW5lVG8oLXIyLCByMik7CiAgICBjb250ZXh0LmxpbmVUbygtMyAqIHIyLCByMik7CiAgICBjb250ZXh0LmNsb3NlUGF0aCgpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvc3ltYm9sL2RpYW1vbmQuanMKdmFyIHRhbjMwID0gc3FydCgxIC8gMyk7CnZhciB0YW4zMF8yID0gdGFuMzAgKiAyOwp2YXIgZGlhbW9uZF9kZWZhdWx0ID0gewogIGRyYXcoY29udGV4dCwgc2l6ZSkgewogICAgY29uc3QgeTIgPSBzcXJ0KHNpemUgLyB0YW4zMF8yKTsKICAgIGNvbnN0IHgyID0geTIgKiB0YW4zMDsKICAgIGNvbnRleHQubW92ZVRvKDAsIC15Mik7CiAgICBjb250ZXh0LmxpbmVUbyh4MiwgMCk7CiAgICBjb250ZXh0LmxpbmVUbygwLCB5Mik7CiAgICBjb250ZXh0LmxpbmVUbygteDIsIDApOwogICAgY29udGV4dC5jbG9zZVBhdGgoKTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3N5bWJvbC9zcXVhcmUuanMKdmFyIHNxdWFyZV9kZWZhdWx0ID0gewogIGRyYXcoY29udGV4dCwgc2l6ZSkgewogICAgY29uc3QgdyA9IHNxcnQoc2l6ZSk7CiAgICBjb25zdCB4MiA9IC13IC8gMjsKICAgIGNvbnRleHQucmVjdCh4MiwgeDIsIHcsIHcpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvc3ltYm9sL3N0YXIuanMKdmFyIGthID0gMC44OTA4MTMwOTE1MjkyODUyOwp2YXIga3IgPSBzaW4ocGkgLyAxMCkgLyBzaW4oNyAqIHBpIC8gMTApOwp2YXIga3ggPSBzaW4odGF1IC8gMTApICoga3I7CnZhciBreSA9IC1jb3ModGF1IC8gMTApICoga3I7CnZhciBzdGFyX2RlZmF1bHQgPSB7CiAgZHJhdyhjb250ZXh0LCBzaXplKSB7CiAgICBjb25zdCByMiA9IHNxcnQoc2l6ZSAqIGthKTsKICAgIGNvbnN0IHgyID0ga3ggKiByMjsKICAgIGNvbnN0IHkyID0ga3kgKiByMjsKICAgIGNvbnRleHQubW92ZVRvKDAsIC1yMik7CiAgICBjb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCA1OyArK2kpIHsKICAgICAgY29uc3QgYTIgPSB0YXUgKiBpIC8gNTsKICAgICAgY29uc3QgYzIgPSBjb3MoYTIpOwogICAgICBjb25zdCBzMiA9IHNpbihhMik7CiAgICAgIGNvbnRleHQubGluZVRvKHMyICogcjIsIC1jMiAqIHIyKTsKICAgICAgY29udGV4dC5saW5lVG8oYzIgKiB4MiAtIHMyICogeTIsIHMyICogeDIgKyBjMiAqIHkyKTsKICAgIH0KICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9zeW1ib2wvdHJpYW5nbGUuanMKdmFyIHNxcnQzID0gc3FydCgzKTsKdmFyIHRyaWFuZ2xlX2RlZmF1bHQgPSB7CiAgZHJhdyhjb250ZXh0LCBzaXplKSB7CiAgICBjb25zdCB5MiA9IC1zcXJ0KHNpemUgLyAoc3FydDMgKiAzKSk7CiAgICBjb250ZXh0Lm1vdmVUbygwLCB5MiAqIDIpOwogICAgY29udGV4dC5saW5lVG8oLXNxcnQzICogeTIsIC15Mik7CiAgICBjb250ZXh0LmxpbmVUbyhzcXJ0MyAqIHkyLCAteTIpOwogICAgY29udGV4dC5jbG9zZVBhdGgoKTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3N5bWJvbC93eWUuanMKdmFyIGMgPSAtMC41Owp2YXIgcyA9IHNxcnQoMykgLyAyOwp2YXIgayA9IDEgLyBzcXJ0KDEyKTsKdmFyIGEgPSAoayAvIDIgKyAxKSAqIDM7CnZhciB3eWVfZGVmYXVsdCA9IHsKICBkcmF3KGNvbnRleHQsIHNpemUpIHsKICAgIGNvbnN0IHIyID0gc3FydChzaXplIC8gYSk7CiAgICBjb25zdCB4MCA9IHIyIC8gMiwgeTAgPSByMiAqIGs7CiAgICBjb25zdCB4MSA9IHgwLCB5MSA9IHIyICogayArIHIyOwogICAgY29uc3QgeDIgPSAteDEsIHkyID0geTE7CiAgICBjb250ZXh0Lm1vdmVUbyh4MCwgeTApOwogICAgY29udGV4dC5saW5lVG8oeDEsIHkxKTsKICAgIGNvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICBjb250ZXh0LmxpbmVUbyhjICogeDAgLSBzICogeTAsIHMgKiB4MCArIGMgKiB5MCk7CiAgICBjb250ZXh0LmxpbmVUbyhjICogeDEgLSBzICogeTEsIHMgKiB4MSArIGMgKiB5MSk7CiAgICBjb250ZXh0LmxpbmVUbyhjICogeDIgLSBzICogeTIsIHMgKiB4MiArIGMgKiB5Mik7CiAgICBjb250ZXh0LmxpbmVUbyhjICogeDAgKyBzICogeTAsIGMgKiB5MCAtIHMgKiB4MCk7CiAgICBjb250ZXh0LmxpbmVUbyhjICogeDEgKyBzICogeTEsIGMgKiB5MSAtIHMgKiB4MSk7CiAgICBjb250ZXh0LmxpbmVUbyhjICogeDIgKyBzICogeTIsIGMgKiB5MiAtIHMgKiB4Mik7CiAgICBjb250ZXh0LmNsb3NlUGF0aCgpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvc3ltYm9sLmpzCmZ1bmN0aW9uIFN5bWJvbDIodHlwZSwgc2l6ZSkgewogIGxldCBjb250ZXh0ID0gbnVsbCwgcGF0aDIgPSB3aXRoUGF0aChzeW1ib2wpOwogIHR5cGUgPSB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiA/IHR5cGUgOiBjb25zdGFudF9kZWZhdWx0KHR5cGUgfHwgY2lyY2xlX2RlZmF1bHQpOwogIHNpemUgPSB0eXBlb2Ygc2l6ZSA9PT0gImZ1bmN0aW9uIiA/IHNpemUgOiBjb25zdGFudF9kZWZhdWx0KHNpemUgPT09IHZvaWQgMCA/IDY0IDogK3NpemUpOwogIGZ1bmN0aW9uIHN5bWJvbCgpIHsKICAgIGxldCBidWZmZXI7CiAgICBpZiAoIWNvbnRleHQpIGNvbnRleHQgPSBidWZmZXIgPSBwYXRoMigpOwogICAgdHlwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpLmRyYXcoY29udGV4dCwgK3NpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICBpZiAoYnVmZmVyKSByZXR1cm4gY29udGV4dCA9IG51bGwsIGJ1ZmZlciArICIiIHx8IG51bGw7CiAgfQogIHN5bWJvbC50eXBlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodHlwZSA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoXyksIHN5bWJvbCkgOiB0eXBlOwogIH07CiAgc3ltYm9sLnNpemUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChzaXplID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIHN5bWJvbCkgOiBzaXplOwogIH07CiAgc3ltYm9sLmNvbnRleHQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjb250ZXh0ID0gXyA9PSBudWxsID8gbnVsbCA6IF8sIHN5bWJvbCkgOiBjb250ZXh0OwogIH07CiAgcmV0dXJuIHN5bWJvbDsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9ub29wLmpzCmZ1bmN0aW9uIG5vb3BfZGVmYXVsdCgpIHsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9iYXNpcy5qcwpmdW5jdGlvbiBwb2ludCh0aGF0LCB4MiwgeTIpIHsKICB0aGF0Ll9jb250ZXh0LmJlemllckN1cnZlVG8oCiAgICAoMiAqIHRoYXQuX3gwICsgdGhhdC5feDEpIC8gMywKICAgICgyICogdGhhdC5feTAgKyB0aGF0Ll95MSkgLyAzLAogICAgKHRoYXQuX3gwICsgMiAqIHRoYXQuX3gxKSAvIDMsCiAgICAodGhhdC5feTAgKyAyICogdGhhdC5feTEpIC8gMywKICAgICh0aGF0Ll94MCArIDQgKiB0aGF0Ll94MSArIHgyKSAvIDYsCiAgICAodGhhdC5feTAgKyA0ICogdGhhdC5feTEgKyB5MikgLyA2CiAgKTsKfQpmdW5jdGlvbiBCYXNpcyhjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KQmFzaXMucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDM6CiAgICAgICAgcG9pbnQodGhpcywgdGhpcy5feDEsIHRoaXMuX3kxKTsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gxLCB0aGlzLl95MSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbygoNSAqIHRoaXMuX3gwICsgdGhpcy5feDEpIC8gNiwgKDUgKiB0aGlzLl95MCArIHRoaXMuX3kxKSAvIDYpOwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXMoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYmFzaXNDbG9zZWQuanMKZnVuY3Rpb24gQmFzaXNDbG9zZWQoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkJhc2lzQ2xvc2VkLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IG5vb3BfZGVmYXVsdCwKICBhcmVhRW5kOiBub29wX2RlZmF1bHQsCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl94MiA9IHRoaXMuX3gzID0gdGhpcy5feDQgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gdGhpcy5feTIgPSB0aGlzLl95MyA9IHRoaXMuX3k0ID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMTogewogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKHRoaXMuX3gyLCB0aGlzLl95Mik7CiAgICAgICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDI6IHsKICAgICAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbygodGhpcy5feDIgKyAyICogdGhpcy5feDMpIC8gMywgKHRoaXMuX3kyICsgMiAqIHRoaXMuX3kzKSAvIDMpOwogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKCh0aGlzLl94MyArIDIgKiB0aGlzLl94MikgLyAzLCAodGhpcy5feTMgKyAyICogdGhpcy5feTIpIC8gMyk7CiAgICAgICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDM6IHsKICAgICAgICB0aGlzLnBvaW50KHRoaXMuX3gyLCB0aGlzLl95Mik7CiAgICAgICAgdGhpcy5wb2ludCh0aGlzLl94MywgdGhpcy5feTMpOwogICAgICAgIHRoaXMucG9pbnQodGhpcy5feDQsIHRoaXMuX3k0KTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX3gyID0geDIsIHRoaXMuX3kyID0geTI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgdGhpcy5feDMgPSB4MiwgdGhpcy5feTMgPSB5MjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB0aGlzLl94NCA9IHgyLCB0aGlzLl95NCA9IHkyOwogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKCh0aGlzLl94MCArIDQgKiB0aGlzLl94MSArIHgyKSAvIDYsICh0aGlzLl95MCArIDQgKiB0aGlzLl95MSArIHkyKSAvIDYpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzQ2xvc2VkX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXNDbG9zZWQoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYmFzaXNPcGVuLmpzCmZ1bmN0aW9uIEJhc2lzT3Blbihjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KQmFzaXNPcGVuLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feDAgPSB0aGlzLl94MSA9IHRoaXMuX3kwID0gdGhpcy5feTEgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDMpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9wb2ludCA9IDM7CiAgICAgICAgdmFyIHgwID0gKHRoaXMuX3gwICsgNCAqIHRoaXMuX3gxICsgeDIpIC8gNiwgeTAgPSAodGhpcy5feTAgKyA0ICogdGhpcy5feTEgKyB5MikgLyA2OwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MCwgeTApIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDAsIHkwKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIHRoaXMuX3BvaW50ID0gNDsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludCh0aGlzLCB4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgdGhpcy5feDAgPSB0aGlzLl94MSwgdGhpcy5feDEgPSB4MjsKICAgIHRoaXMuX3kwID0gdGhpcy5feTEsIHRoaXMuX3kxID0geTI7CiAgfQp9OwpmdW5jdGlvbiBiYXNpc09wZW5fZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCYXNpc09wZW4oY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbGluZWFyQ2xvc2VkLmpzCmZ1bmN0aW9uIExpbmVhckNsb3NlZChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KTGluZWFyQ2xvc2VkLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IG5vb3BfZGVmYXVsdCwKICBhcmVhRW5kOiBub29wX2RlZmF1bHQsCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX3BvaW50KSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgaWYgKHRoaXMuX3BvaW50KSB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgZWxzZSB0aGlzLl9wb2ludCA9IDEsIHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgfQp9OwpmdW5jdGlvbiBsaW5lYXJDbG9zZWRfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBMaW5lYXJDbG9zZWQoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbW9ub3RvbmUuanMKZnVuY3Rpb24gc2lnbih4MikgewogIHJldHVybiB4MiA8IDAgPyAtMSA6IDE7Cn0KZnVuY3Rpb24gc2xvcGUzKHRoYXQsIHgyLCB5MikgewogIHZhciBoMCA9IHRoYXQuX3gxIC0gdGhhdC5feDAsIGgxID0geDIgLSB0aGF0Ll94MSwgczAgPSAodGhhdC5feTEgLSB0aGF0Ll95MCkgLyAoaDAgfHwgaDEgPCAwICYmIC0wKSwgczEgPSAoeTIgLSB0aGF0Ll95MSkgLyAoaDEgfHwgaDAgPCAwICYmIC0wKSwgcCA9IChzMCAqIGgxICsgczEgKiBoMCkgLyAoaDAgKyBoMSk7CiAgcmV0dXJuIChzaWduKHMwKSArIHNpZ24oczEpKSAqIE1hdGgubWluKE1hdGguYWJzKHMwKSwgTWF0aC5hYnMoczEpLCAwLjUgKiBNYXRoLmFicyhwKSkgfHwgMDsKfQpmdW5jdGlvbiBzbG9wZTIodGhhdCwgdCkgewogIHZhciBoID0gdGhhdC5feDEgLSB0aGF0Ll94MDsKICByZXR1cm4gaCA/ICgzICogKHRoYXQuX3kxIC0gdGhhdC5feTApIC8gaCAtIHQpIC8gMiA6IHQ7Cn0KZnVuY3Rpb24gcG9pbnQyKHRoYXQsIHQwMiwgdDEyKSB7CiAgdmFyIHgwID0gdGhhdC5feDAsIHkwID0gdGhhdC5feTAsIHgxID0gdGhhdC5feDEsIHkxID0gdGhhdC5feTEsIGR4ID0gKHgxIC0geDApIC8gMzsKICB0aGF0Ll9jb250ZXh0LmJlemllckN1cnZlVG8oeDAgKyBkeCwgeTAgKyBkeCAqIHQwMiwgeDEgLSBkeCwgeTEgLSBkeCAqIHQxMiwgeDEsIHkxKTsKfQpmdW5jdGlvbiBNb25vdG9uZVgoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9Ck1vbm90b25lWC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gdGhpcy5fdDAgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gxLCB0aGlzLl95MSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICBwb2ludDIodGhpcywgdGhpcy5fdDAsIHNsb3BlMih0aGlzLCB0aGlzLl90MCkpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHZhciB0MTIgPSBOYU47CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBpZiAoeDIgPT09IHRoaXMuX3gxICYmIHkyID09PSB0aGlzLl95MSkgcmV0dXJuOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICBwb2ludDIodGhpcywgc2xvcGUyKHRoaXMsIHQxMiA9IHNsb3BlMyh0aGlzLCB4MiwgeTIpKSwgdDEyKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludDIodGhpcywgdGhpcy5fdDAsIHQxMiA9IHNsb3BlMyh0aGlzLCB4MiwgeTIpKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogICAgdGhpcy5fdDAgPSB0MTI7CiAgfQp9OwpmdW5jdGlvbiBNb25vdG9uZVkoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBuZXcgUmVmbGVjdENvbnRleHQoY29udGV4dCk7Cn0KKE1vbm90b25lWS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKE1vbm90b25lWC5wcm90b3R5cGUpKS5wb2ludCA9IGZ1bmN0aW9uKHgyLCB5MikgewogIE1vbm90b25lWC5wcm90b3R5cGUucG9pbnQuY2FsbCh0aGlzLCB5MiwgeDIpOwp9OwpmdW5jdGlvbiBSZWZsZWN0Q29udGV4dChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KUmVmbGVjdENvbnRleHQucHJvdG90eXBlID0gewogIG1vdmVUbzogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbyh5MiwgeDIpOwogIH0sCiAgY2xvc2VQYXRoOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgfSwKICBsaW5lVG86IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdGhpcy5fY29udGV4dC5saW5lVG8oeTIsIHgyKTsKICB9LAogIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKHgxLCB5MSwgeDIsIHkyLCB4MywgeTMpIHsKICAgIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh5MSwgeDEsIHkyLCB4MiwgeTMsIHgzKTsKICB9Cn07CmZ1bmN0aW9uIG1vbm90b25lWChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBNb25vdG9uZVgoY29udGV4dCk7Cn0KZnVuY3Rpb24gbW9ub3RvbmVZKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IE1vbm90b25lWShjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9uYXR1cmFsLmpzCmZ1bmN0aW9uIE5hdHVyYWwoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9Ck5hdHVyYWwucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94ID0gW107CiAgICB0aGlzLl95ID0gW107CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIHZhciB4MiA9IHRoaXMuX3gsIHkyID0gdGhpcy5feSwgbiA9IHgyLmxlbmd0aDsKICAgIGlmIChuKSB7CiAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MlswXSwgeTJbMF0pIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDJbMF0sIHkyWzBdKTsKICAgICAgaWYgKG4gPT09IDIpIHsKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MlsxXSwgeTJbMV0pOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBweCA9IGNvbnRyb2xQb2ludHMoeDIpLCBweSA9IGNvbnRyb2xQb2ludHMoeTIpOwogICAgICAgIGZvciAodmFyIGkwID0gMCwgaTEgPSAxOyBpMSA8IG47ICsraTAsICsraTEpIHsKICAgICAgICAgIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyhweFswXVtpMF0sIHB5WzBdW2kwXSwgcHhbMV1baTBdLCBweVsxXVtpMF0sIHgyW2kxXSwgeTJbaTFdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgbiA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICAgIHRoaXMuX3ggPSB0aGlzLl95ID0gbnVsbDsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHRoaXMuX3gucHVzaCgreDIpOwogICAgdGhpcy5feS5wdXNoKCt5Mik7CiAgfQp9OwpmdW5jdGlvbiBjb250cm9sUG9pbnRzKHgyKSB7CiAgdmFyIGksIG4gPSB4Mi5sZW5ndGggLSAxLCBtLCBhMiA9IG5ldyBBcnJheShuKSwgYiA9IG5ldyBBcnJheShuKSwgcjIgPSBuZXcgQXJyYXkobik7CiAgYTJbMF0gPSAwLCBiWzBdID0gMiwgcjJbMF0gPSB4MlswXSArIDIgKiB4MlsxXTsKICBmb3IgKGkgPSAxOyBpIDwgbiAtIDE7ICsraSkgYTJbaV0gPSAxLCBiW2ldID0gNCwgcjJbaV0gPSA0ICogeDJbaV0gKyAyICogeDJbaSArIDFdOwogIGEyW24gLSAxXSA9IDIsIGJbbiAtIDFdID0gNywgcjJbbiAtIDFdID0gOCAqIHgyW24gLSAxXSArIHgyW25dOwogIGZvciAoaSA9IDE7IGkgPCBuOyArK2kpIG0gPSBhMltpXSAvIGJbaSAtIDFdLCBiW2ldIC09IG0sIHIyW2ldIC09IG0gKiByMltpIC0gMV07CiAgYTJbbiAtIDFdID0gcjJbbiAtIDFdIC8gYltuIC0gMV07CiAgZm9yIChpID0gbiAtIDI7IGkgPj0gMDsgLS1pKSBhMltpXSA9IChyMltpXSAtIGEyW2kgKyAxXSkgLyBiW2ldOwogIGJbbiAtIDFdID0gKHgyW25dICsgYTJbbiAtIDFdKSAvIDI7CiAgZm9yIChpID0gMDsgaSA8IG4gLSAxOyArK2kpIGJbaV0gPSAyICogeDJbaSArIDFdIC0gYTJbaSArIDFdOwogIHJldHVybiBbYTIsIGJdOwp9CmZ1bmN0aW9uIG5hdHVyYWxfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBOYXR1cmFsKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL3N0ZXAuanMKZnVuY3Rpb24gU3RlcChjb250ZXh0LCB0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7CiAgdGhpcy5fdCA9IHQ7Cn0KU3RlcC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3ggPSB0aGlzLl95ID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAoMCA8IHRoaXMuX3QgJiYgdGhpcy5fdCA8IDEgJiYgdGhpcy5fcG9pbnQgPT09IDIpIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gsIHRoaXMuX3kpOwogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIGlmICh0aGlzLl9saW5lID49IDApIHRoaXMuX3QgPSAxIC0gdGhpcy5fdCwgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgZGVmYXVsdDogewogICAgICAgIGlmICh0aGlzLl90IDw9IDApIHsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gsIHkyKTsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciB4MSA9IHRoaXMuX3ggKiAoMSAtIHRoaXMuX3QpICsgeDIgKiB0aGlzLl90OwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDEsIHRoaXMuX3kpOwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDEsIHkyKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3ggPSB4MiwgdGhpcy5feSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gc3RlcF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMC41KTsKfQpmdW5jdGlvbiBzdGVwQmVmb3JlKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMCk7Cn0KZnVuY3Rpb24gc3RlcEFmdGVyKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb2Zmc2V0L25vbmUuanMKZnVuY3Rpb24gbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMSkpIHJldHVybjsKICBmb3IgKHZhciBpID0gMSwgaiwgczAsIHMxID0gc2VyaWVzW29yZGVyWzBdXSwgbiwgbSA9IHMxLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgczAgPSBzMSwgczEgPSBzZXJpZXNbb3JkZXJbaV1dOwogICAgZm9yIChqID0gMDsgaiA8IG07ICsraikgewogICAgICBzMVtqXVsxXSArPSBzMVtqXVswXSA9IGlzTmFOKHMwW2pdWzFdKSA/IHMwW2pdWzBdIDogczBbal1bMV07CiAgICB9CiAgfQp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29yZGVyL25vbmUuanMKZnVuY3Rpb24gbm9uZV9kZWZhdWx0MihzZXJpZXMpIHsKICB2YXIgbiA9IHNlcmllcy5sZW5ndGgsIG8gPSBuZXcgQXJyYXkobik7CiAgd2hpbGUgKC0tbiA+PSAwKSBvW25dID0gbjsKICByZXR1cm4gbzsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9zdGFjay5qcwpmdW5jdGlvbiBzdGFja1ZhbHVlKGQsIGtleSkgewogIHJldHVybiBkW2tleV07Cn0KZnVuY3Rpb24gc3RhY2tTZXJpZXMoa2V5KSB7CiAgY29uc3Qgc2VyaWVzID0gW107CiAgc2VyaWVzLmtleSA9IGtleTsKICByZXR1cm4gc2VyaWVzOwp9CmZ1bmN0aW9uIHN0YWNrX2RlZmF1bHQoKSB7CiAgdmFyIGtleXMgPSBjb25zdGFudF9kZWZhdWx0KFtdKSwgb3JkZXIgPSBub25lX2RlZmF1bHQyLCBvZmZzZXQgPSBub25lX2RlZmF1bHQsIHZhbHVlID0gc3RhY2tWYWx1ZTsKICBmdW5jdGlvbiBzdGFjayhkYXRhKSB7CiAgICB2YXIgc3ogPSBBcnJheS5mcm9tKGtleXMuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgc3RhY2tTZXJpZXMpLCBpLCBuID0gc3oubGVuZ3RoLCBqID0gLTEsIG96OwogICAgZm9yIChjb25zdCBkIG9mIGRhdGEpIHsKICAgICAgZm9yIChpID0gMCwgKytqOyBpIDwgbjsgKytpKSB7CiAgICAgICAgKHN6W2ldW2pdID0gWzAsICt2YWx1ZShkLCBzeltpXS5rZXksIGosIGRhdGEpXSkuZGF0YSA9IGQ7CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IDAsIG96ID0gYXJyYXlfZGVmYXVsdChvcmRlcihzeikpOyBpIDwgbjsgKytpKSB7CiAgICAgIHN6W296W2ldXS5pbmRleCA9IGk7CiAgICB9CiAgICBvZmZzZXQoc3osIG96KTsKICAgIHJldHVybiBzejsKICB9CiAgc3RhY2sua2V5cyA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGtleXMgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KEFycmF5LmZyb20oXykpLCBzdGFjaykgOiBrZXlzOwogIH07CiAgc3RhY2sudmFsdWUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh2YWx1ZSA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBzdGFjaykgOiB2YWx1ZTsKICB9OwogIHN0YWNrLm9yZGVyID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAob3JkZXIgPSBfID09IG51bGwgPyBub25lX2RlZmF1bHQyIDogdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdChBcnJheS5mcm9tKF8pKSwgc3RhY2spIDogb3JkZXI7CiAgfTsKICBzdGFjay5vZmZzZXQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChvZmZzZXQgPSBfID09IG51bGwgPyBub25lX2RlZmF1bHQgOiBfLCBzdGFjaykgOiBvZmZzZXQ7CiAgfTsKICByZXR1cm4gc3RhY2s7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb2Zmc2V0L2V4cGFuZC5qcwpmdW5jdGlvbiBleHBhbmRfZGVmYXVsdChzZXJpZXMsIG9yZGVyKSB7CiAgaWYgKCEoKG4gPSBzZXJpZXMubGVuZ3RoKSA+IDApKSByZXR1cm47CiAgZm9yICh2YXIgaSwgbiwgaiA9IDAsIG0gPSBzZXJpZXNbMF0ubGVuZ3RoLCB5MjsgaiA8IG07ICsraikgewogICAgZm9yICh5MiA9IGkgPSAwOyBpIDwgbjsgKytpKSB5MiArPSBzZXJpZXNbaV1bal1bMV0gfHwgMDsKICAgIGlmICh5MikgZm9yIChpID0gMDsgaSA8IG47ICsraSkgc2VyaWVzW2ldW2pdWzFdIC89IHkyOwogIH0KICBub25lX2RlZmF1bHQoc2VyaWVzLCBvcmRlcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb2Zmc2V0L3NpbGhvdWV0dGUuanMKZnVuY3Rpb24gc2lsaG91ZXR0ZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMCkpIHJldHVybjsKICBmb3IgKHZhciBqID0gMCwgczAgPSBzZXJpZXNbb3JkZXJbMF1dLCBuLCBtID0gczAubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHZhciBpID0gMCwgeTIgPSAwOyBpIDwgbjsgKytpKSB5MiArPSBzZXJpZXNbaV1bal1bMV0gfHwgMDsKICAgIHMwW2pdWzFdICs9IHMwW2pdWzBdID0gLXkyIC8gMjsKICB9CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC93aWdnbGUuanMKZnVuY3Rpb24gd2lnZ2xlX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSB8fCAhKChtID0gKHMwID0gc2VyaWVzW29yZGVyWzBdXSkubGVuZ3RoKSA+IDApKSByZXR1cm47CiAgZm9yICh2YXIgeTIgPSAwLCBqID0gMSwgczAsIG0sIG47IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGkgPSAwLCBzMSA9IDAsIHMyID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YXIgc2kgPSBzZXJpZXNbb3JkZXJbaV1dLCBzaWowID0gc2lbal1bMV0gfHwgMCwgc2lqMSA9IHNpW2ogLSAxXVsxXSB8fCAwLCBzMyA9IChzaWowIC0gc2lqMSkgLyAyOwogICAgICBmb3IgKHZhciBrMiA9IDA7IGsyIDwgaTsgKytrMikgewogICAgICAgIHZhciBzayA9IHNlcmllc1tvcmRlcltrMl1dLCBza2owID0gc2tbal1bMV0gfHwgMCwgc2tqMSA9IHNrW2ogLSAxXVsxXSB8fCAwOwogICAgICAgIHMzICs9IHNrajAgLSBza2oxOwogICAgICB9CiAgICAgIHMxICs9IHNpajAsIHMyICs9IHMzICogc2lqMDsKICAgIH0KICAgIHMwW2ogLSAxXVsxXSArPSBzMFtqIC0gMV1bMF0gPSB5MjsKICAgIGlmIChzMSkgeTIgLT0gczIgLyBzMTsKICB9CiAgczBbaiAtIDFdWzFdICs9IHMwW2ogLSAxXVswXSA9IHkyOwogIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0RhdGFVdGlscy5qcwp2YXIgaW1wb3J0X2dldCA9IF9fdG9FU00ocmVxdWlyZV9nZXQyKCkpOwp2YXIgbWF0aFNpZ24gPSAodmFsdWUpID0+IHsKICBpZiAodmFsdWUgPT09IDApIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAodmFsdWUgPiAwKSB7CiAgICByZXR1cm4gMTsKICB9CiAgcmV0dXJuIC0xOwp9Owp2YXIgaXNOYW4gPSAodmFsdWUpID0+IHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICJudW1iZXIiICYmIHZhbHVlICE9ICt2YWx1ZTsKfTsKdmFyIGlzUGVyY2VudCA9ICh2YWx1ZSkgPT4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCIlIikgPT09IHZhbHVlLmxlbmd0aCAtIDE7CnZhciBpc051bWJlciA9ICh2YWx1ZSkgPT4gKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdmFsdWUgaW5zdGFuY2VvZiBOdW1iZXIpICYmICFpc05hbih2YWx1ZSk7CnZhciBpc051bU9yU3RyID0gKHZhbHVlKSA9PiBpc051bWJlcih2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIjsKdmFyIGlkQ291bnRlciA9IDA7CnZhciB1bmlxdWVJZCA9IChwcmVmaXgpID0+IHsKICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICByZXR1cm4gIiIuY29uY2F0KHByZWZpeCB8fCAiIikuY29uY2F0KGlkKTsKfTsKdmFyIGdldFBlcmNlbnRWYWx1ZSA9IGZ1bmN0aW9uIGdldFBlcmNlbnRWYWx1ZTIocGVyY2VudCwgdG90YWxWYWx1ZSkgewogIHZhciBkZWZhdWx0VmFsdWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IDA7CiAgdmFyIHZhbGlkYXRlID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbM10gOiBmYWxzZTsKICBpZiAoIWlzTnVtYmVyKHBlcmNlbnQpICYmIHR5cGVvZiBwZXJjZW50ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICB9CiAgdmFyIHZhbHVlOwogIGlmIChpc1BlcmNlbnQocGVyY2VudCkpIHsKICAgIGlmICh0b3RhbFZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KICAgIHZhciBpbmRleCA9IHBlcmNlbnQuaW5kZXhPZigiJSIpOwogICAgdmFsdWUgPSB0b3RhbFZhbHVlICogcGFyc2VGbG9hdChwZXJjZW50LnNsaWNlKDAsIGluZGV4KSkgLyAxMDA7CiAgfSBlbHNlIHsKICAgIHZhbHVlID0gK3BlcmNlbnQ7CiAgfQogIGlmIChpc05hbih2YWx1ZSkpIHsKICAgIHZhbHVlID0gZGVmYXVsdFZhbHVlOwogIH0KICBpZiAodmFsaWRhdGUgJiYgdG90YWxWYWx1ZSAhPSBudWxsICYmIHZhbHVlID4gdG90YWxWYWx1ZSkgewogICAgdmFsdWUgPSB0b3RhbFZhbHVlOwogIH0KICByZXR1cm4gdmFsdWU7Cn07CnZhciBoYXNEdXBsaWNhdGUgPSAoYXJ5KSA9PiB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFyeSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIGxlbiA9IGFyeS5sZW5ndGg7CiAgdmFyIGNhY2hlID0ge307CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgaWYgKCFjYWNoZVthcnlbaV1dKSB7CiAgICAgIGNhY2hlW2FyeVtpXV0gPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKZnVuY3Rpb24gaW50ZXJwb2xhdGUoc3RhcnQsIGVuZCwgdCkgewogIGlmIChpc051bWJlcihzdGFydCkgJiYgaXNOdW1iZXIoZW5kKSkgewogICAgcmV0dXJuIHN0YXJ0ICsgdCAqIChlbmQgLSBzdGFydCk7CiAgfQogIHJldHVybiBlbmQ7Cn0KZnVuY3Rpb24gZmluZEVudHJ5SW5BcnJheShhcnksIHNwZWNpZmllZEtleSwgc3BlY2lmaWVkVmFsdWUpIHsKICBpZiAoIWFyeSB8fCAhYXJ5Lmxlbmd0aCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGFyeS5maW5kKChlbnRyeSkgPT4gZW50cnkgJiYgKHR5cGVvZiBzcGVjaWZpZWRLZXkgPT09ICJmdW5jdGlvbiIgPyBzcGVjaWZpZWRLZXkoZW50cnkpIDogKDAsIGltcG9ydF9nZXQuZGVmYXVsdCkoZW50cnksIHNwZWNpZmllZEtleSkpID09PSBzcGVjaWZpZWRWYWx1ZSk7Cn0KdmFyIGlzTnVsbGlzaCA9ICh2YWx1ZSkgPT4gewogIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiOwp9Owp2YXIgdXBwZXJGaXJzdCA9ICh2YWx1ZSkgPT4gewogIGlmIChpc051bGxpc2godmFsdWUpKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHJldHVybiAiIi5jb25jYXQodmFsdWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkpLmNvbmNhdCh2YWx1ZS5zbGljZSgxKSk7Cn07CmZ1bmN0aW9uIGlzTm90TmlsKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9IG51bGw7Cn0KZnVuY3Rpb24gbm9vcCgpIHsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9TeW1ib2xzLmpzCnZhciBfZXhjbHVkZWQzID0gWyJ0eXBlIiwgInNpemUiLCAic2l6ZVR5cGUiXTsKZnVuY3Rpb24gX2V4dGVuZHMzKCkgewogIHJldHVybiBfZXh0ZW5kczMgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczMoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTMocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBzeW1ib2xGYWN0b3JpZXMgPSB7CiAgc3ltYm9sQ2lyY2xlOiBjaXJjbGVfZGVmYXVsdCwKICBzeW1ib2xDcm9zczogY3Jvc3NfZGVmYXVsdCwKICBzeW1ib2xEaWFtb25kOiBkaWFtb25kX2RlZmF1bHQsCiAgc3ltYm9sU3F1YXJlOiBzcXVhcmVfZGVmYXVsdCwKICBzeW1ib2xTdGFyOiBzdGFyX2RlZmF1bHQsCiAgc3ltYm9sVHJpYW5nbGU6IHRyaWFuZ2xlX2RlZmF1bHQsCiAgc3ltYm9sV3llOiB3eWVfZGVmYXVsdAp9Owp2YXIgUkFESUFOID0gTWF0aC5QSSAvIDE4MDsKdmFyIGdldFN5bWJvbEZhY3RvcnkgPSAodHlwZSkgPT4gewogIHZhciBuYW1lID0gInN5bWJvbCIuY29uY2F0KHVwcGVyRmlyc3QodHlwZSkpOwogIHJldHVybiBzeW1ib2xGYWN0b3JpZXNbbmFtZV0gfHwgY2lyY2xlX2RlZmF1bHQ7Cn07CnZhciBjYWxjdWxhdGVBcmVhU2l6ZSA9IChzaXplLCBzaXplVHlwZSwgdHlwZSkgPT4gewogIGlmIChzaXplVHlwZSA9PT0gImFyZWEiKSB7CiAgICByZXR1cm4gc2l6ZTsKICB9CiAgc3dpdGNoICh0eXBlKSB7CiAgICBjYXNlICJjcm9zcyI6CiAgICAgIHJldHVybiA1ICogc2l6ZSAqIHNpemUgLyA5OwogICAgY2FzZSAiZGlhbW9uZCI6CiAgICAgIHJldHVybiAwLjUgKiBzaXplICogc2l6ZSAvIE1hdGguc3FydCgzKTsKICAgIGNhc2UgInNxdWFyZSI6CiAgICAgIHJldHVybiBzaXplICogc2l6ZTsKICAgIGNhc2UgInN0YXIiOiB7CiAgICAgIHZhciBhbmdsZSA9IDE4ICogUkFESUFOOwogICAgICByZXR1cm4gMS4yNSAqIHNpemUgKiBzaXplICogKE1hdGgudGFuKGFuZ2xlKSAtIE1hdGgudGFuKGFuZ2xlICogMikgKiBNYXRoLnRhbihhbmdsZSkgKiogMik7CiAgICB9CiAgICBjYXNlICJ0cmlhbmdsZSI6CiAgICAgIHJldHVybiBNYXRoLnNxcnQoMykgKiBzaXplICogc2l6ZSAvIDQ7CiAgICBjYXNlICJ3eWUiOgogICAgICByZXR1cm4gKDIxIC0gMTAgKiBNYXRoLnNxcnQoMykpICogc2l6ZSAqIHNpemUgLyA4OwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIE1hdGguUEkgKiBzaXplICogc2l6ZSAvIDQ7CiAgfQp9Owp2YXIgcmVnaXN0ZXJTeW1ib2wgPSAoa2V5LCBmYWN0b3J5KSA9PiB7CiAgc3ltYm9sRmFjdG9yaWVzWyJzeW1ib2wiLmNvbmNhdCh1cHBlckZpcnN0KGtleSkpXSA9IGZhY3Rvcnk7Cn07CnZhciBTeW1ib2xzID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHR5cGUgPSAiY2lyY2xlIiwKICAgIHNpemUgPSA2NCwKICAgIHNpemVUeXBlID0gImFyZWEiCiAgfSA9IF9yZWYyLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMyhfcmVmMiwgX2V4Y2x1ZGVkMyk7CiAgdmFyIHByb3BzID0gX29iamVjdFNwcmVhZChfb2JqZWN0U3ByZWFkKHt9LCByZXN0KSwge30sIHsKICAgIHR5cGUsCiAgICBzaXplLAogICAgc2l6ZVR5cGUKICB9KTsKICB2YXIgcmVhbFR5cGUgPSAiY2lyY2xlIjsKICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICByZWFsVHlwZSA9IHR5cGU7CiAgfQogIHZhciBnZXRQYXRoMyA9ICgpID0+IHsKICAgIHZhciBzeW1ib2xGYWN0b3J5ID0gZ2V0U3ltYm9sRmFjdG9yeShyZWFsVHlwZSk7CiAgICB2YXIgc3ltYm9sID0gU3ltYm9sMigpLnR5cGUoc3ltYm9sRmFjdG9yeSkuc2l6ZShjYWxjdWxhdGVBcmVhU2l6ZShzaXplLCBzaXplVHlwZSwgcmVhbFR5cGUpKTsKICAgIHZhciBzMiA9IHN5bWJvbCgpOwogICAgaWYgKHMyID09PSBudWxsKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gczI7CiAgfTsKICB2YXIgewogICAgY2xhc3NOYW1lLAogICAgY3gsCiAgICBjeQogIH0gPSBwcm9wczsKICB2YXIgZmlsdGVyZWRQcm9wcyA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpOwogIGlmIChpc051bWJlcihjeCkgJiYgaXNOdW1iZXIoY3kpICYmIGlzTnVtYmVyKHNpemUpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0My5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHMzKHt9LCBmaWx0ZXJlZFByb3BzLCB7CiAgICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtc3ltYm9scyIsIGNsYXNzTmFtZSksCiAgICAgIHRyYW5zZm9ybTogInRyYW5zbGF0ZSgiLmNvbmNhdChjeCwgIiwgIikuY29uY2F0KGN5LCAiKSIpLAogICAgICBkOiBnZXRQYXRoMygpCiAgICB9KSk7CiAgfQogIHJldHVybiBudWxsOwp9OwpTeW1ib2xzLnJlZ2lzdGVyU3ltYm9sID0gcmVnaXN0ZXJTeW1ib2w7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdHlwZXMuanMKdmFyIGltcG9ydF9yZWFjdDcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpc1BvbGFyQ29vcmRpbmF0ZSA9IChjMikgPT4gewogIHJldHVybiAicmFkaXVzIiBpbiBjMiAmJiAic3RhcnRBbmdsZSIgaW4gYzIgJiYgImVuZEFuZ2xlIiBpbiBjMjsKfTsKdmFyIGFkYXB0RXZlbnRIYW5kbGVycyA9IChwcm9wcywgbmV3SGFuZGxlcikgPT4gewogIGlmICghcHJvcHMgfHwgdHlwZW9mIHByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBwcm9wcyA9PT0gImJvb2xlYW4iKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGlucHV0UHJvcHMgPSBwcm9wczsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q3LmlzVmFsaWRFbGVtZW50KShwcm9wcykpIHsKICAgIGlucHV0UHJvcHMgPSBwcm9wcy5wcm9wczsKICB9CiAgaWYgKHR5cGVvZiBpbnB1dFByb3BzICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgaW5wdXRQcm9wcyAhPT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBvdXQgPSB7fTsKICBPYmplY3Qua2V5cyhpbnB1dFByb3BzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgIGlmIChpc0V2ZW50S2V5KGtleSkpIHsKICAgICAgb3V0W2tleV0gPSBuZXdIYW5kbGVyIHx8ICgoZSkgPT4gaW5wdXRQcm9wc1trZXldKGlucHV0UHJvcHMsIGUpKTsKICAgIH0KICB9KTsKICByZXR1cm4gb3V0Owp9Owp2YXIgZ2V0RXZlbnRIYW5kbGVyT2ZDaGlsZCA9IChvcmlnaW5hbEhhbmRsZXIsIGRhdGEsIGluZGV4KSA9PiAoZSkgPT4gewogIG9yaWdpbmFsSGFuZGxlcihkYXRhLCBpbmRleCwgZSk7CiAgcmV0dXJuIG51bGw7Cn07CnZhciBhZGFwdEV2ZW50c09mQ2hpbGQgPSAocHJvcHMsIGRhdGEsIGluZGV4KSA9PiB7CiAgaWYgKHByb3BzID09PSBudWxsIHx8IHR5cGVvZiBwcm9wcyAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIHByb3BzICE9PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIG91dCA9IG51bGw7CiAgT2JqZWN0LmtleXMocHJvcHMpLmZvckVhY2goKGtleSkgPT4gewogICAgdmFyIGl0ZW0gPSBwcm9wc1trZXldOwogICAgaWYgKGlzRXZlbnRLZXkoa2V5KSAmJiB0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIikgewogICAgICBpZiAoIW91dCkgb3V0ID0ge307CiAgICAgIG91dFtrZXldID0gZ2V0RXZlbnRIYW5kbGVyT2ZDaGlsZChpdGVtLCBkYXRhLCBpbmRleCk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIG91dDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9yZXNvbHZlRGVmYXVsdFByb3BzLmpzCmZ1bmN0aW9uIG93bktleXMyKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTIoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Mih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIHJlc29sdmVEZWZhdWx0UHJvcHMocmVhbFByb3BzLCBkZWZhdWx0UHJvcHMpIHsKICB2YXIgcmVzb2x2ZWRQcm9wcyA9IF9vYmplY3RTcHJlYWQyKHt9LCByZWFsUHJvcHMpOwogIHZhciBkcCA9IGRlZmF1bHRQcm9wczsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRlZmF1bHRQcm9wcyk7CiAgdmFyIHdpdGhEZWZhdWx0cyA9IGtleXMucmVkdWNlKChhY2MsIGtleSkgPT4gewogICAgaWYgKGFjY1trZXldID09PSB2b2lkIDAgJiYgZHBba2V5XSAhPT0gdm9pZCAwKSB7CiAgICAgIGFjY1trZXldID0gZHBba2V5XTsKICAgIH0KICAgIHJldHVybiBhY2M7CiAgfSwgcmVzb2x2ZWRQcm9wcyk7CiAgcmV0dXJuIHdpdGhEZWZhdWx0czsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3BheWxvYWQvZ2V0VW5pcVBheWxvYWQuanMKdmFyIGltcG9ydF91bmlxQnkgPSBfX3RvRVNNKHJlcXVpcmVfdW5pcUJ5MygpKTsKZnVuY3Rpb24gZ2V0VW5pcVBheWxvYWQocGF5bG9hZCwgb3B0aW9uLCBkZWZhdWx0VW5pcUJ5MikgewogIGlmIChvcHRpb24gPT09IHRydWUpIHsKICAgIHJldHVybiAoMCwgaW1wb3J0X3VuaXFCeS5kZWZhdWx0KShwYXlsb2FkLCBkZWZhdWx0VW5pcUJ5Mik7CiAgfQogIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF91bmlxQnkuZGVmYXVsdCkocGF5bG9hZCwgb3B0aW9uKTsKICB9CiAgcmV0dXJuIHBheWxvYWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvaG9va3MuanMKdmFyIGltcG9ydF93aXRoX3NlbGVjdG9yID0gX190b0VTTShyZXF1aXJlX3dpdGhfc2VsZWN0b3IoKSk7CnZhciBpbXBvcnRfcmVhY3Q5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1JlZHV4Q29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0OCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFJlY2hhcnRzUmVkdXhDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q4LmNyZWF0ZUNvbnRleHQpKG51bGwpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9ob29rcy5qcwp2YXIgbm9vcERpc3BhdGNoID0gKGEyKSA9PiBhMjsKdmFyIHVzZUFwcERpc3BhdGNoID0gKCkgPT4gewogIHZhciBjb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDkudXNlQ29udGV4dCkoUmVjaGFydHNSZWR1eENvbnRleHQpOwogIGlmIChjb250ZXh0KSB7CiAgICByZXR1cm4gY29udGV4dC5zdG9yZS5kaXNwYXRjaDsKICB9CiAgcmV0dXJuIG5vb3BEaXNwYXRjaDsKfTsKdmFyIG5vb3AyID0gKCkgPT4gewp9Owp2YXIgYWRkTmVzdGVkU3ViTm9vcCA9ICgpID0+IG5vb3AyOwp2YXIgcmVmRXF1YWxpdHkgPSAoYTIsIGIpID0+IGEyID09PSBiOwpmdW5jdGlvbiB1c2VBcHBTZWxlY3RvcihzZWxlY3RvcikgewogIHZhciBjb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDkudXNlQ29udGV4dCkoUmVjaGFydHNSZWR1eENvbnRleHQpOwogIHJldHVybiAoMCwgaW1wb3J0X3dpdGhfc2VsZWN0b3IudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IpKGNvbnRleHQgPyBjb250ZXh0LnN1YnNjcmlwdGlvbi5hZGROZXN0ZWRTdWIgOiBhZGROZXN0ZWRTdWJOb29wLCBjb250ZXh0ID8gY29udGV4dC5zdG9yZS5nZXRTdGF0ZSA6IG5vb3AyLCBjb250ZXh0ID8gY29udGV4dC5zdG9yZS5nZXRTdGF0ZSA6IG5vb3AyLCBjb250ZXh0ID8gc2VsZWN0b3IgOiBub29wMiwgcmVmRXF1YWxpdHkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVzZWxlY3QvZGlzdC9yZXNlbGVjdC5tanMKdmFyIHJ1bklkZW50aXR5RnVuY3Rpb25DaGVjayA9IChyZXN1bHRGdW5jLCBpbnB1dFNlbGVjdG9yc1Jlc3VsdHMsIG91dHB1dFNlbGVjdG9yUmVzdWx0KSA9PiB7CiAgaWYgKGlucHV0U2VsZWN0b3JzUmVzdWx0cy5sZW5ndGggPT09IDEgJiYgaW5wdXRTZWxlY3RvcnNSZXN1bHRzWzBdID09PSBvdXRwdXRTZWxlY3RvclJlc3VsdCkgewogICAgbGV0IGlzSW5wdXRTYW1lQXNPdXRwdXQgPSBmYWxzZTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGVtcHR5T2JqZWN0ID0ge307CiAgICAgIGlmIChyZXN1bHRGdW5jKGVtcHR5T2JqZWN0KSA9PT0gZW1wdHlPYmplY3QpCiAgICAgICAgaXNJbnB1dFNhbWVBc091dHB1dCA9IHRydWU7CiAgICB9IGNhdGNoIHsKICAgIH0KICAgIGlmIChpc0lucHV0U2FtZUFzT3V0cHV0KSB7CiAgICAgIGxldCBzdGFjayA9IHZvaWQgMDsKICAgICAgdHJ5IHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIDsKICAgICAgICAoeyBzdGFjayB9ID0gZSk7CiAgICAgIH0KICAgICAgY29uc29sZS53YXJuKAogICAgICAgICJUaGUgcmVzdWx0IGZ1bmN0aW9uIHJldHVybmVkIGl0cyBvd24gaW5wdXRzIHdpdGhvdXQgbW9kaWZpY2F0aW9uLiBlLmdcbmBjcmVhdGVTZWxlY3Rvcihbc3RhdGUgPT4gc3RhdGUudG9kb3NdLCB0b2RvcyA9PiB0b2RvcylgXG5UaGlzIGNvdWxkIGxlYWQgdG8gaW5lZmZpY2llbnQgbWVtb2l6YXRpb24gYW5kIHVubmVjZXNzYXJ5IHJlLXJlbmRlcnMuXG5FbnN1cmUgdHJhbnNmb3JtYXRpb24gbG9naWMgaXMgaW4gdGhlIHJlc3VsdCBmdW5jdGlvbiwgYW5kIGV4dHJhY3Rpb24gbG9naWMgaXMgaW4gdGhlIGlucHV0IHNlbGVjdG9ycy4iLAogICAgICAgIHsgc3RhY2sgfQogICAgICApOwogICAgfQogIH0KfTsKdmFyIHJ1bklucHV0U3RhYmlsaXR5Q2hlY2sgPSAoaW5wdXRTZWxlY3RvclJlc3VsdHNPYmplY3QsIG9wdGlvbnMsIGlucHV0U2VsZWN0b3JBcmdzKSA9PiB7CiAgY29uc3QgeyBtZW1vaXplLCBtZW1vaXplT3B0aW9ucyB9ID0gb3B0aW9uczsKICBjb25zdCB7IGlucHV0U2VsZWN0b3JSZXN1bHRzLCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkgfSA9IGlucHV0U2VsZWN0b3JSZXN1bHRzT2JqZWN0OwogIGNvbnN0IGNyZWF0ZUFuRW1wdHlPYmplY3QgPSBtZW1vaXplKCgpID0+ICh7fSksIC4uLm1lbW9pemVPcHRpb25zKTsKICBjb25zdCBhcmVJbnB1dFNlbGVjdG9yUmVzdWx0c0VxdWFsID0gY3JlYXRlQW5FbXB0eU9iamVjdC5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yUmVzdWx0cykgPT09IGNyZWF0ZUFuRW1wdHlPYmplY3QuYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5KTsKICBpZiAoIWFyZUlucHV0U2VsZWN0b3JSZXN1bHRzRXF1YWwpIHsKICAgIGxldCBzdGFjayA9IHZvaWQgMDsKICAgIHRyeSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgfSBjYXRjaCAoZSkgewogICAgICA7CiAgICAgICh7IHN0YWNrIH0gPSBlKTsKICAgIH0KICAgIGNvbnNvbGUud2FybigKICAgICAgIkFuIGlucHV0IHNlbGVjdG9yIHJldHVybmVkIGEgZGlmZmVyZW50IHJlc3VsdCB3aGVuIHBhc3NlZCBzYW1lIGFyZ3VtZW50cy5cblRoaXMgbWVhbnMgeW91ciBvdXRwdXQgc2VsZWN0b3Igd2lsbCBsaWtlbHkgcnVuIG1vcmUgZnJlcXVlbnRseSB0aGFuIGludGVuZGVkLlxuQXZvaWQgcmV0dXJuaW5nIGEgbmV3IHJlZmVyZW5jZSBpbnNpZGUgeW91ciBpbnB1dCBzZWxlY3RvciwgZS5nLlxuYGNyZWF0ZVNlbGVjdG9yKFtzdGF0ZSA9PiBzdGF0ZS50b2Rvcy5tYXAodG9kbyA9PiB0b2RvLmlkKV0sIHRvZG9JZHMgPT4gdG9kb0lkcy5sZW5ndGgpYCIsCiAgICAgIHsKICAgICAgICBhcmd1bWVudHM6IGlucHV0U2VsZWN0b3JBcmdzLAogICAgICAgIGZpcnN0SW5wdXRzOiBpbnB1dFNlbGVjdG9yUmVzdWx0cywKICAgICAgICBzZWNvbmRJbnB1dHM6IGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSwKICAgICAgICBzdGFjawogICAgICB9CiAgICApOwogIH0KfTsKdmFyIGdsb2JhbERldk1vZGVDaGVja3MgPSB7CiAgaW5wdXRTdGFiaWxpdHlDaGVjazogIm9uY2UiLAogIGlkZW50aXR5RnVuY3Rpb25DaGVjazogIm9uY2UiCn07CmZ1bmN0aW9uIGFzc2VydElzRnVuY3Rpb24oZnVuYywgZXJyb3JNZXNzYWdlID0gYGV4cGVjdGVkIGEgZnVuY3Rpb24sIGluc3RlYWQgcmVjZWl2ZWQgJHt0eXBlb2YgZnVuY31gKSB7CiAgaWYgKHR5cGVvZiBmdW5jICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGVycm9yTWVzc2FnZSk7CiAgfQp9CmZ1bmN0aW9uIGFzc2VydElzT2JqZWN0KG9iamVjdCwgZXJyb3JNZXNzYWdlID0gYGV4cGVjdGVkIGFuIG9iamVjdCwgaW5zdGVhZCByZWNlaXZlZCAke3R5cGVvZiBvYmplY3R9YCkgewogIGlmICh0eXBlb2Ygb2JqZWN0ICE9PSAib2JqZWN0IikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihlcnJvck1lc3NhZ2UpOwogIH0KfQpmdW5jdGlvbiBhc3NlcnRJc0FycmF5T2ZGdW5jdGlvbnMoYXJyYXksIGVycm9yTWVzc2FnZSA9IGBleHBlY3RlZCBhbGwgaXRlbXMgdG8gYmUgZnVuY3Rpb25zLCBpbnN0ZWFkIHJlY2VpdmVkIHRoZSBmb2xsb3dpbmcgdHlwZXM6IGApIHsKICBpZiAoIWFycmF5LmV2ZXJ5KChpdGVtKSA9PiB0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIikpIHsKICAgIGNvbnN0IGl0ZW1UeXBlcyA9IGFycmF5Lm1hcCgKICAgICAgKGl0ZW0pID0+IHR5cGVvZiBpdGVtID09PSAiZnVuY3Rpb24iID8gYGZ1bmN0aW9uICR7aXRlbS5uYW1lIHx8ICJ1bm5hbWVkIn0oKWAgOiB0eXBlb2YgaXRlbQogICAgKS5qb2luKCIsICIpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgJHtlcnJvck1lc3NhZ2V9WyR7aXRlbVR5cGVzfV1gKTsKICB9Cn0KdmFyIGVuc3VyZUlzQXJyYXkgPSAoaXRlbSkgPT4gewogIHJldHVybiBBcnJheS5pc0FycmF5KGl0ZW0pID8gaXRlbSA6IFtpdGVtXTsKfTsKZnVuY3Rpb24gZ2V0RGVwZW5kZW5jaWVzKGNyZWF0ZVNlbGVjdG9yQXJncykgewogIGNvbnN0IGRlcGVuZGVuY2llcyA9IEFycmF5LmlzQXJyYXkoY3JlYXRlU2VsZWN0b3JBcmdzWzBdKSA/IGNyZWF0ZVNlbGVjdG9yQXJnc1swXSA6IGNyZWF0ZVNlbGVjdG9yQXJnczsKICBhc3NlcnRJc0FycmF5T2ZGdW5jdGlvbnMoCiAgICBkZXBlbmRlbmNpZXMsCiAgICBgY3JlYXRlU2VsZWN0b3IgZXhwZWN0cyBhbGwgaW5wdXQtc2VsZWN0b3JzIHRvIGJlIGZ1bmN0aW9ucywgYnV0IHJlY2VpdmVkIHRoZSBmb2xsb3dpbmcgdHlwZXM6IGAKICApOwogIHJldHVybiBkZXBlbmRlbmNpZXM7Cn0KZnVuY3Rpb24gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKGRlcGVuZGVuY2llcywgaW5wdXRTZWxlY3RvckFyZ3MpIHsKICBjb25zdCBpbnB1dFNlbGVjdG9yUmVzdWx0cyA9IFtdOwogIGNvbnN0IHsgbGVuZ3RoIH0gPSBkZXBlbmRlbmNpZXM7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgaW5wdXRTZWxlY3RvclJlc3VsdHMucHVzaChkZXBlbmRlbmNpZXNbaV0uYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvckFyZ3MpKTsKICB9CiAgcmV0dXJuIGlucHV0U2VsZWN0b3JSZXN1bHRzOwp9CnZhciBnZXREZXZNb2RlQ2hlY2tzRXhlY3V0aW9uSW5mbyA9IChmaXJzdFJ1biwgZGV2TW9kZUNoZWNrcykgPT4gewogIGNvbnN0IHsgaWRlbnRpdHlGdW5jdGlvbkNoZWNrLCBpbnB1dFN0YWJpbGl0eUNoZWNrIH0gPSB7CiAgICAuLi5nbG9iYWxEZXZNb2RlQ2hlY2tzLAogICAgLi4uZGV2TW9kZUNoZWNrcwogIH07CiAgcmV0dXJuIHsKICAgIGlkZW50aXR5RnVuY3Rpb25DaGVjazogewogICAgICBzaG91bGRSdW46IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9PT0gImFsd2F5cyIgfHwgaWRlbnRpdHlGdW5jdGlvbkNoZWNrID09PSAib25jZSIgJiYgZmlyc3RSdW4sCiAgICAgIHJ1bjogcnVuSWRlbnRpdHlGdW5jdGlvbkNoZWNrCiAgICB9LAogICAgaW5wdXRTdGFiaWxpdHlDaGVjazogewogICAgICBzaG91bGRSdW46IGlucHV0U3RhYmlsaXR5Q2hlY2sgPT09ICJhbHdheXMiIHx8IGlucHV0U3RhYmlsaXR5Q2hlY2sgPT09ICJvbmNlIiAmJiBmaXJzdFJ1biwKICAgICAgcnVuOiBydW5JbnB1dFN0YWJpbGl0eUNoZWNrCiAgICB9CiAgfTsKfTsKdmFyIFJFRFVYX1BST1hZX0xBQkVMID0gU3ltYm9sKCk7CnZhciBwcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih7fSk7CnZhciBTdHJvbmdSZWYgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IodmFsdWUpIHsKICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICB9CiAgZGVyZWYoKSB7CiAgICByZXR1cm4gdGhpcy52YWx1ZTsKICB9Cn07CnZhciBSZWYgPSB0eXBlb2YgV2Vha1JlZiAhPT0gInVuZGVmaW5lZCIgPyBXZWFrUmVmIDogU3Ryb25nUmVmOwp2YXIgVU5URVJNSU5BVEVEID0gMDsKdmFyIFRFUk1JTkFURUQgPSAxOwpmdW5jdGlvbiBjcmVhdGVDYWNoZU5vZGUoKSB7CiAgcmV0dXJuIHsKICAgIHM6IFVOVEVSTUlOQVRFRCwKICAgIHY6IHZvaWQgMCwKICAgIG86IG51bGwsCiAgICBwOiBudWxsCiAgfTsKfQpmdW5jdGlvbiB3ZWFrTWFwTWVtb2l6ZShmdW5jLCBvcHRpb25zID0ge30pIHsKICBsZXQgZm5Ob2RlID0gY3JlYXRlQ2FjaGVOb2RlKCk7CiAgY29uc3QgeyByZXN1bHRFcXVhbGl0eUNoZWNrIH0gPSBvcHRpb25zOwogIGxldCBsYXN0UmVzdWx0MjsKICBsZXQgcmVzdWx0c0NvdW50ID0gMDsKICBmdW5jdGlvbiBtZW1vaXplZCgpIHsKICAgIGxldCBjYWNoZU5vZGUgPSBmbk5vZGU7CiAgICBjb25zdCB7IGxlbmd0aCB9ID0gYXJndW1lbnRzOwogICAgZm9yIChsZXQgaSA9IDAsIGwgPSBsZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgY29uc3QgYXJnID0gYXJndW1lbnRzW2ldOwogICAgICBpZiAodHlwZW9mIGFyZyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgYXJnID09PSAib2JqZWN0IiAmJiBhcmcgIT09IG51bGwpIHsKICAgICAgICBsZXQgb2JqZWN0Q2FjaGUgPSBjYWNoZU5vZGUubzsKICAgICAgICBpZiAob2JqZWN0Q2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgIGNhY2hlTm9kZS5vID0gb2JqZWN0Q2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2JqZWN0Tm9kZSA9IG9iamVjdENhY2hlLmdldChhcmcpOwogICAgICAgIGlmIChvYmplY3ROb2RlID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgICAgICAgb2JqZWN0Q2FjaGUuc2V0KGFyZywgY2FjaGVOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVOb2RlID0gb2JqZWN0Tm9kZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IHByaW1pdGl2ZUNhY2hlID0gY2FjaGVOb2RlLnA7CiAgICAgICAgaWYgKHByaW1pdGl2ZUNhY2hlID09PSBudWxsKSB7CiAgICAgICAgICBjYWNoZU5vZGUucCA9IHByaW1pdGl2ZUNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcHJpbWl0aXZlTm9kZSA9IHByaW1pdGl2ZUNhY2hlLmdldChhcmcpOwogICAgICAgIGlmIChwcmltaXRpdmVOb2RlID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgICAgICAgcHJpbWl0aXZlQ2FjaGUuc2V0KGFyZywgY2FjaGVOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVOb2RlID0gcHJpbWl0aXZlTm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHRlcm1pbmF0ZWROb2RlID0gY2FjaGVOb2RlOwogICAgbGV0IHJlc3VsdDsKICAgIGlmIChjYWNoZU5vZGUucyA9PT0gVEVSTUlOQVRFRCkgewogICAgICByZXN1bHQgPSBjYWNoZU5vZGUudjsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgcmVzdWx0c0NvdW50Kys7CiAgICAgIGlmIChyZXN1bHRFcXVhbGl0eUNoZWNrKSB7CiAgICAgICAgY29uc3QgbGFzdFJlc3VsdFZhbHVlID0gbGFzdFJlc3VsdDI/LmRlcmVmPy4oKSA/PyBsYXN0UmVzdWx0MjsKICAgICAgICBpZiAobGFzdFJlc3VsdFZhbHVlICE9IG51bGwgJiYgcmVzdWx0RXF1YWxpdHlDaGVjayhsYXN0UmVzdWx0VmFsdWUsIHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IGxhc3RSZXN1bHRWYWx1ZTsKICAgICAgICAgIHJlc3VsdHNDb3VudCAhPT0gMCAmJiByZXN1bHRzQ291bnQtLTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbmVlZHNXZWFrUmVmID0gdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgJiYgcmVzdWx0ICE9PSBudWxsIHx8IHR5cGVvZiByZXN1bHQgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgbGFzdFJlc3VsdDIgPSBuZWVkc1dlYWtSZWYgPyBuZXcgUmVmKHJlc3VsdCkgOiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIHRlcm1pbmF0ZWROb2RlLnMgPSBURVJNSU5BVEVEOwogICAgdGVybWluYXRlZE5vZGUudiA9IHJlc3VsdDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIG1lbW9pemVkLmNsZWFyQ2FjaGUgPSAoKSA9PiB7CiAgICBmbk5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICAgIG1lbW9pemVkLnJlc2V0UmVzdWx0c0NvdW50KCk7CiAgfTsKICBtZW1vaXplZC5yZXN1bHRzQ291bnQgPSAoKSA9PiByZXN1bHRzQ291bnQ7CiAgbWVtb2l6ZWQucmVzZXRSZXN1bHRzQ291bnQgPSAoKSA9PiB7CiAgICByZXN1bHRzQ291bnQgPSAwOwogIH07CiAgcmV0dXJuIG1lbW9pemVkOwp9CmZ1bmN0aW9uIGNyZWF0ZVNlbGVjdG9yQ3JlYXRvcihtZW1vaXplT3JPcHRpb25zLCAuLi5tZW1vaXplT3B0aW9uc0Zyb21BcmdzKSB7CiAgY29uc3QgY3JlYXRlU2VsZWN0b3JDcmVhdG9yT3B0aW9ucyA9IHR5cGVvZiBtZW1vaXplT3JPcHRpb25zID09PSAiZnVuY3Rpb24iID8gewogICAgbWVtb2l6ZTogbWVtb2l6ZU9yT3B0aW9ucywKICAgIG1lbW9pemVPcHRpb25zOiBtZW1vaXplT3B0aW9uc0Zyb21BcmdzCiAgfSA6IG1lbW9pemVPck9wdGlvbnM7CiAgY29uc3QgY3JlYXRlU2VsZWN0b3IyID0gKC4uLmNyZWF0ZVNlbGVjdG9yQXJncykgPT4gewogICAgbGV0IHJlY29tcHV0YXRpb25zID0gMDsKICAgIGxldCBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMgPSAwOwogICAgbGV0IGxhc3RSZXN1bHQyOwogICAgbGV0IGRpcmVjdGx5UGFzc2VkT3B0aW9ucyA9IHt9OwogICAgbGV0IHJlc3VsdEZ1bmMgPSBjcmVhdGVTZWxlY3RvckFyZ3MucG9wKCk7CiAgICBpZiAodHlwZW9mIHJlc3VsdEZ1bmMgPT09ICJvYmplY3QiKSB7CiAgICAgIGRpcmVjdGx5UGFzc2VkT3B0aW9ucyA9IHJlc3VsdEZ1bmM7CiAgICAgIHJlc3VsdEZ1bmMgPSBjcmVhdGVTZWxlY3RvckFyZ3MucG9wKCk7CiAgICB9CiAgICBhc3NlcnRJc0Z1bmN0aW9uKAogICAgICByZXN1bHRGdW5jLAogICAgICBgY3JlYXRlU2VsZWN0b3IgZXhwZWN0cyBhbiBvdXRwdXQgZnVuY3Rpb24gYWZ0ZXIgdGhlIGlucHV0cywgYnV0IHJlY2VpdmVkOiBbJHt0eXBlb2YgcmVzdWx0RnVuY31dYAogICAgKTsKICAgIGNvbnN0IGNvbWJpbmVkT3B0aW9ucyA9IHsKICAgICAgLi4uY3JlYXRlU2VsZWN0b3JDcmVhdG9yT3B0aW9ucywKICAgICAgLi4uZGlyZWN0bHlQYXNzZWRPcHRpb25zCiAgICB9OwogICAgY29uc3QgewogICAgICBtZW1vaXplLAogICAgICBtZW1vaXplT3B0aW9ucyA9IFtdLAogICAgICBhcmdzTWVtb2l6ZSA9IHdlYWtNYXBNZW1vaXplLAogICAgICBhcmdzTWVtb2l6ZU9wdGlvbnMgPSBbXSwKICAgICAgZGV2TW9kZUNoZWNrcyA9IHt9CiAgICB9ID0gY29tYmluZWRPcHRpb25zOwogICAgY29uc3QgZmluYWxNZW1vaXplT3B0aW9ucyA9IGVuc3VyZUlzQXJyYXkobWVtb2l6ZU9wdGlvbnMpOwogICAgY29uc3QgZmluYWxBcmdzTWVtb2l6ZU9wdGlvbnMgPSBlbnN1cmVJc0FycmF5KGFyZ3NNZW1vaXplT3B0aW9ucyk7CiAgICBjb25zdCBkZXBlbmRlbmNpZXMgPSBnZXREZXBlbmRlbmNpZXMoY3JlYXRlU2VsZWN0b3JBcmdzKTsKICAgIGNvbnN0IG1lbW9pemVkUmVzdWx0RnVuYyA9IG1lbW9pemUoZnVuY3Rpb24gcmVjb21wdXRhdGlvbldyYXBwZXIoKSB7CiAgICAgIHJlY29tcHV0YXRpb25zKys7CiAgICAgIHJldHVybiByZXN1bHRGdW5jLmFwcGx5KAogICAgICAgIG51bGwsCiAgICAgICAgYXJndW1lbnRzCiAgICAgICk7CiAgICB9LCAuLi5maW5hbE1lbW9pemVPcHRpb25zKTsKICAgIGxldCBmaXJzdFJ1biA9IHRydWU7CiAgICBjb25zdCBzZWxlY3RvciA9IGFyZ3NNZW1vaXplKGZ1bmN0aW9uIGRlcGVuZGVuY2llc0NoZWNrZXIoKSB7CiAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9ucysrOwogICAgICBjb25zdCBpbnB1dFNlbGVjdG9yUmVzdWx0cyA9IGNvbGxlY3RJbnB1dFNlbGVjdG9yUmVzdWx0cygKICAgICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICAgYXJndW1lbnRzCiAgICAgICk7CiAgICAgIGxhc3RSZXN1bHQyID0gbWVtb2l6ZWRSZXN1bHRGdW5jLmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JSZXN1bHRzKTsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjaywgaW5wdXRTdGFiaWxpdHlDaGVjayB9ID0gZ2V0RGV2TW9kZUNoZWNrc0V4ZWN1dGlvbkluZm8oZmlyc3RSdW4sIGRldk1vZGVDaGVja3MpOwogICAgICAgIGlmIChpZGVudGl0eUZ1bmN0aW9uQ2hlY2suc2hvdWxkUnVuKSB7CiAgICAgICAgICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sucnVuKAogICAgICAgICAgICByZXN1bHRGdW5jLAogICAgICAgICAgICBpbnB1dFNlbGVjdG9yUmVzdWx0cywKICAgICAgICAgICAgbGFzdFJlc3VsdDIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChpbnB1dFN0YWJpbGl0eUNoZWNrLnNob3VsZFJ1bikgewogICAgICAgICAgY29uc3QgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5ID0gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKAogICAgICAgICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgKTsKICAgICAgICAgIGlucHV0U3RhYmlsaXR5Q2hlY2sucnVuKAogICAgICAgICAgICB7IGlucHV0U2VsZWN0b3JSZXN1bHRzLCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkgfSwKICAgICAgICAgICAgeyBtZW1vaXplLCBtZW1vaXplT3B0aW9uczogZmluYWxNZW1vaXplT3B0aW9ucyB9LAogICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChmaXJzdFJ1bikKICAgICAgICAgIGZpcnN0UnVuID0gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3RSZXN1bHQyOwogICAgfSwgLi4uZmluYWxBcmdzTWVtb2l6ZU9wdGlvbnMpOwogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oc2VsZWN0b3IsIHsKICAgICAgcmVzdWx0RnVuYywKICAgICAgbWVtb2l6ZWRSZXN1bHRGdW5jLAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9uczogKCkgPT4gZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zLAogICAgICByZXNldERlcGVuZGVuY3lSZWNvbXB1dGF0aW9uczogKCkgPT4gewogICAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9ucyA9IDA7CiAgICAgIH0sCiAgICAgIGxhc3RSZXN1bHQ6ICgpID0+IGxhc3RSZXN1bHQyLAogICAgICByZWNvbXB1dGF0aW9uczogKCkgPT4gcmVjb21wdXRhdGlvbnMsCiAgICAgIHJlc2V0UmVjb21wdXRhdGlvbnM6ICgpID0+IHsKICAgICAgICByZWNvbXB1dGF0aW9ucyA9IDA7CiAgICAgIH0sCiAgICAgIG1lbW9pemUsCiAgICAgIGFyZ3NNZW1vaXplCiAgICB9KTsKICB9OwogIE9iamVjdC5hc3NpZ24oY3JlYXRlU2VsZWN0b3IyLCB7CiAgICB3aXRoVHlwZXM6ICgpID0+IGNyZWF0ZVNlbGVjdG9yMgogIH0pOwogIHJldHVybiBjcmVhdGVTZWxlY3RvcjI7Cn0KdmFyIGNyZWF0ZVNlbGVjdG9yID0gLyogQF9fUFVSRV9fICovIGNyZWF0ZVNlbGVjdG9yQ3JlYXRvcih3ZWFrTWFwTWVtb2l6ZSk7CnZhciBjcmVhdGVTdHJ1Y3R1cmVkU2VsZWN0b3IgPSBPYmplY3QuYXNzaWduKAogIChpbnB1dFNlbGVjdG9yc09iamVjdCwgc2VsZWN0b3JDcmVhdG9yID0gY3JlYXRlU2VsZWN0b3IpID0+IHsKICAgIGFzc2VydElzT2JqZWN0KAogICAgICBpbnB1dFNlbGVjdG9yc09iamVjdCwKICAgICAgYGNyZWF0ZVN0cnVjdHVyZWRTZWxlY3RvciBleHBlY3RzIGZpcnN0IGFyZ3VtZW50IHRvIGJlIGFuIG9iamVjdCB3aGVyZSBlYWNoIHByb3BlcnR5IGlzIGEgc2VsZWN0b3IsIGluc3RlYWQgcmVjZWl2ZWQgYSAke3R5cGVvZiBpbnB1dFNlbGVjdG9yc09iamVjdH1gCiAgICApOwogICAgY29uc3QgaW5wdXRTZWxlY3RvcktleXMgPSBPYmplY3Qua2V5cyhpbnB1dFNlbGVjdG9yc09iamVjdCk7CiAgICBjb25zdCBkZXBlbmRlbmNpZXMgPSBpbnB1dFNlbGVjdG9yS2V5cy5tYXAoCiAgICAgIChrZXkpID0+IGlucHV0U2VsZWN0b3JzT2JqZWN0W2tleV0KICAgICk7CiAgICBjb25zdCBzdHJ1Y3R1cmVkU2VsZWN0b3IgPSBzZWxlY3RvckNyZWF0b3IoCiAgICAgIGRlcGVuZGVuY2llcywKICAgICAgKC4uLmlucHV0U2VsZWN0b3JSZXN1bHRzKSA9PiB7CiAgICAgICAgcmV0dXJuIGlucHV0U2VsZWN0b3JSZXN1bHRzLnJlZHVjZSgoY29tcG9zaXRpb24sIHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgICAgY29tcG9zaXRpb25baW5wdXRTZWxlY3RvcktleXNbaW5kZXhdXSA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIGNvbXBvc2l0aW9uOwogICAgICAgIH0sIHt9KTsKICAgICAgfQogICAgKTsKICAgIHJldHVybiBzdHJ1Y3R1cmVkU2VsZWN0b3I7CiAgfSwKICB7IHdpdGhUeXBlczogKCkgPT4gY3JlYXRlU3RydWN0dXJlZFNlbGVjdG9yIH0KKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2xlZ2VuZFNlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3NvcnRCeSA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwp2YXIgc2VsZWN0TGVnZW5kU2V0dGluZ3MgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5zZXR0aW5nczsKdmFyIHNlbGVjdExlZ2VuZFNpemUgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5zaXplOwp2YXIgc2VsZWN0QWxsTGVnZW5kUGF5bG9hZDJEQXJyYXkgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5wYXlsb2FkOwp2YXIgc2VsZWN0TGVnZW5kUGF5bG9hZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxMZWdlbmRQYXlsb2FkMkRBcnJheSwgc2VsZWN0TGVnZW5kU2V0dGluZ3NdLCAocGF5bG9hZHMsIF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGl0ZW1Tb3J0ZXIKICB9ID0gX3JlZjI7CiAgdmFyIGZsYXQgPSBwYXlsb2Fkcy5mbGF0KDEpOwogIHJldHVybiBpdGVtU29ydGVyID8gKDAsIGltcG9ydF9zb3J0QnkuZGVmYXVsdCkoZmxhdCwgaXRlbVNvcnRlcikgOiBmbGF0Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VFbGVtZW50T2Zmc2V0LmpzCnZhciBpbXBvcnRfcmVhY3QxMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIEVQUyA9IDE7CmZ1bmN0aW9uIHVzZUVsZW1lbnRPZmZzZXQoKSB7CiAgdmFyIGV4dHJhRGVwZW5kZW5jaWVzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMF0gOiBbXTsKICB2YXIgW2xhc3RCb3VuZGluZ0JveCwgc2V0TGFzdEJvdW5kaW5nQm94XSA9ICgwLCBpbXBvcnRfcmVhY3QxMC51c2VTdGF0ZSkoewogICAgaGVpZ2h0OiAwLAogICAgbGVmdDogMCwKICAgIHRvcDogMCwKICAgIHdpZHRoOiAwCiAgfSk7CiAgdmFyIHVwZGF0ZUJvdW5kaW5nQm94ID0gKDAsIGltcG9ydF9yZWFjdDEwLnVzZUNhbGxiYWNrKSgKICAgIChub2RlKSA9PiB7CiAgICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgICB2YXIgcmVjdCA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgdmFyIGJveCA9IHsKICAgICAgICAgIGhlaWdodDogcmVjdC5oZWlnaHQsCiAgICAgICAgICBsZWZ0OiByZWN0LmxlZnQsCiAgICAgICAgICB0b3A6IHJlY3QudG9wLAogICAgICAgICAgd2lkdGg6IHJlY3Qud2lkdGgKICAgICAgICB9OwogICAgICAgIGlmIChNYXRoLmFicyhib3guaGVpZ2h0IC0gbGFzdEJvdW5kaW5nQm94LmhlaWdodCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LmxlZnQgLSBsYXN0Qm91bmRpbmdCb3gubGVmdCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LnRvcCAtIGxhc3RCb3VuZGluZ0JveC50b3ApID4gRVBTIHx8IE1hdGguYWJzKGJveC53aWR0aCAtIGxhc3RCb3VuZGluZ0JveC53aWR0aCkgPiBFUFMpIHsKICAgICAgICAgIHNldExhc3RCb3VuZGluZ0JveCh7CiAgICAgICAgICAgIGhlaWdodDogYm94LmhlaWdodCwKICAgICAgICAgICAgbGVmdDogYm94LmxlZnQsCiAgICAgICAgICAgIHRvcDogYm94LnRvcCwKICAgICAgICAgICAgd2lkdGg6IGJveC53aWR0aAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwcwogICAgW2xhc3RCb3VuZGluZ0JveC53aWR0aCwgbGFzdEJvdW5kaW5nQm94LmhlaWdodCwgbGFzdEJvdW5kaW5nQm94LnRvcCwgbGFzdEJvdW5kaW5nQm94LmxlZnQsIC4uLmV4dHJhRGVwZW5kZW5jaWVzXQogICk7CiAgcmV0dXJuIFtsYXN0Qm91bmRpbmdCb3gsIHVwZGF0ZUJvdW5kaW5nQm94XTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2NoYXJ0TGF5b3V0Q29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0MTMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVkdXgvZGlzdC9yZWR1eC5tanMKdmFyICQkb2JzZXJ2YWJsZSA9IC8qIEBfX1BVUkVfXyAqLyAoKCkgPT4gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wub2JzZXJ2YWJsZSB8fCAiQEBvYnNlcnZhYmxlIikoKTsKdmFyIHN5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHQgPSAkJG9ic2VydmFibGU7CnZhciByYW5kb21TdHJpbmcgPSAoKSA9PiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoNykuc3BsaXQoIiIpLmpvaW4oIi4iKTsKdmFyIEFjdGlvblR5cGVzID0gewogIElOSVQ6IGBAQHJlZHV4L0lOSVQkey8qIEBfX1BVUkVfXyAqLyByYW5kb21TdHJpbmcoKX1gLAogIFJFUExBQ0U6IGBAQHJlZHV4L1JFUExBQ0Ukey8qIEBfX1BVUkVfXyAqLyByYW5kb21TdHJpbmcoKX1gLAogIFBST0JFX1VOS05PV05fQUNUSU9OOiAoKSA9PiBgQEByZWR1eC9QUk9CRV9VTktOT1dOX0FDVElPTiR7cmFuZG9tU3RyaW5nKCl9YAp9Owp2YXIgYWN0aW9uVHlwZXNfZGVmYXVsdCA9IEFjdGlvblR5cGVzOwpmdW5jdGlvbiBpc1BsYWluT2JqZWN0KG9iaikgewogIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IiB8fCBvYmogPT09IG51bGwpCiAgICByZXR1cm4gZmFsc2U7CiAgbGV0IHByb3RvMiA9IG9iajsKICB3aGlsZSAoT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvMikgIT09IG51bGwpIHsKICAgIHByb3RvMiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90bzIpOwogIH0KICByZXR1cm4gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iaikgPT09IHByb3RvMiB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSA9PT0gbnVsbDsKfQpmdW5jdGlvbiBtaW5pS2luZE9mKHZhbCkgewogIGlmICh2YWwgPT09IHZvaWQgMCkKICAgIHJldHVybiAidW5kZWZpbmVkIjsKICBpZiAodmFsID09PSBudWxsKQogICAgcmV0dXJuICJudWxsIjsKICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbDsKICBzd2l0Y2ggKHR5cGUpIHsKICAgIGNhc2UgImJvb2xlYW4iOgogICAgY2FzZSAic3RyaW5nIjoKICAgIGNhc2UgIm51bWJlciI6CiAgICBjYXNlICJzeW1ib2wiOgogICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgIHJldHVybiB0eXBlOwogICAgfQogIH0KICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKQogICAgcmV0dXJuICJhcnJheSI7CiAgaWYgKGlzRGF0ZSh2YWwpKQogICAgcmV0dXJuICJkYXRlIjsKICBpZiAoaXNFcnJvcih2YWwpKQogICAgcmV0dXJuICJlcnJvciI7CiAgY29uc3QgY29uc3RydWN0b3JOYW1lID0gY3Rvck5hbWUodmFsKTsKICBzd2l0Y2ggKGNvbnN0cnVjdG9yTmFtZSkgewogICAgY2FzZSAiU3ltYm9sIjoKICAgIGNhc2UgIlByb21pc2UiOgogICAgY2FzZSAiV2Vha01hcCI6CiAgICBjYXNlICJXZWFrU2V0IjoKICAgIGNhc2UgIk1hcCI6CiAgICBjYXNlICJTZXQiOgogICAgICByZXR1cm4gY29uc3RydWN0b3JOYW1lOwogIH0KICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbCkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMvZywgIiIpOwp9CmZ1bmN0aW9uIGN0b3JOYW1lKHZhbCkgewogIHJldHVybiB0eXBlb2YgdmFsLmNvbnN0cnVjdG9yID09PSAiZnVuY3Rpb24iID8gdmFsLmNvbnN0cnVjdG9yLm5hbWUgOiBudWxsOwp9CmZ1bmN0aW9uIGlzRXJyb3IodmFsKSB7CiAgcmV0dXJuIHZhbCBpbnN0YW5jZW9mIEVycm9yIHx8IHR5cGVvZiB2YWwubWVzc2FnZSA9PT0gInN0cmluZyIgJiYgdmFsLmNvbnN0cnVjdG9yICYmIHR5cGVvZiB2YWwuY29uc3RydWN0b3Iuc3RhY2tUcmFjZUxpbWl0ID09PSAibnVtYmVyIjsKfQpmdW5jdGlvbiBpc0RhdGUodmFsKSB7CiAgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpCiAgICByZXR1cm4gdHJ1ZTsKICByZXR1cm4gdHlwZW9mIHZhbC50b0RhdGVTdHJpbmcgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHZhbC5nZXREYXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiB2YWwuc2V0RGF0ZSA9PT0gImZ1bmN0aW9uIjsKfQpmdW5jdGlvbiBraW5kT2YodmFsKSB7CiAgbGV0IHR5cGVPZlZhbCA9IHR5cGVvZiB2YWw7CiAgaWYgKHRydWUpIHsKICAgIHR5cGVPZlZhbCA9IG1pbmlLaW5kT2YodmFsKTsKICB9CiAgcmV0dXJuIHR5cGVPZlZhbDsKfQpmdW5jdGlvbiBjcmVhdGVTdG9yZShyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSwgZW5oYW5jZXIpIHsKICBpZiAodHlwZW9mIHJlZHVjZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMikgOiBgRXhwZWN0ZWQgdGhlIHJvb3QgcmVkdWNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKHJlZHVjZXIpfSdgKTsKICB9CiAgaWYgKHR5cGVvZiBwcmVsb2FkZWRTdGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZW5oYW5jZXIgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGVuaGFuY2VyID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBhcmd1bWVudHNbM10gPT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMCkgOiAiSXQgbG9va3MgbGlrZSB5b3UgYXJlIHBhc3Npbmcgc2V2ZXJhbCBzdG9yZSBlbmhhbmNlcnMgdG8gY3JlYXRlU3RvcmUoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBJbnN0ZWFkLCBjb21wb3NlIHRoZW0gdG9nZXRoZXIgdG8gYSBzaW5nbGUgZnVuY3Rpb24uIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNC1zdG9yZSNjcmVhdGluZy1hLXN0b3JlLXdpdGgtZW5oYW5jZXJzIGZvciBhbiBleGFtcGxlLiIpOwogIH0KICBpZiAodHlwZW9mIHByZWxvYWRlZFN0YXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBlbmhhbmNlciA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGVuaGFuY2VyID0gcHJlbG9hZGVkU3RhdGU7CiAgICBwcmVsb2FkZWRTdGF0ZSA9IHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiBlbmhhbmNlciAhPT0gInVuZGVmaW5lZCIpIHsKICAgIGlmICh0eXBlb2YgZW5oYW5jZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxKSA6IGBFeHBlY3RlZCB0aGUgZW5oYW5jZXIgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihlbmhhbmNlcil9J2ApOwogICAgfQogICAgcmV0dXJuIGVuaGFuY2VyKGNyZWF0ZVN0b3JlKShyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSk7CiAgfQogIGxldCBjdXJyZW50UmVkdWNlciA9IHJlZHVjZXI7CiAgbGV0IGN1cnJlbnRTdGF0ZSA9IHByZWxvYWRlZFN0YXRlOwogIGxldCBjdXJyZW50TGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBsZXQgbmV4dExpc3RlbmVycyA9IGN1cnJlbnRMaXN0ZW5lcnM7CiAgbGV0IGxpc3RlbmVySWRDb3VudGVyID0gMDsKICBsZXQgaXNEaXNwYXRjaGluZyA9IGZhbHNlOwogIGZ1bmN0aW9uIGVuc3VyZUNhbk11dGF0ZU5leHRMaXN0ZW5lcnMoKSB7CiAgICBpZiAobmV4dExpc3RlbmVycyA9PT0gY3VycmVudExpc3RlbmVycykgewogICAgICBuZXh0TGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgY3VycmVudExpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcjIsIGtleSkgPT4gewogICAgICAgIG5leHRMaXN0ZW5lcnMuc2V0KGtleSwgbGlzdGVuZXIyKTsKICAgICAgfSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFN0YXRlKCkgewogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzKSA6ICJZb3UgbWF5IG5vdCBjYWxsIHN0b3JlLmdldFN0YXRlKCkgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBUaGUgcmVkdWNlciBoYXMgYWxyZWFkeSByZWNlaXZlZCB0aGUgc3RhdGUgYXMgYW4gYXJndW1lbnQuIFBhc3MgaXQgZG93biBmcm9tIHRoZSB0b3AgcmVkdWNlciBpbnN0ZWFkIG9mIHJlYWRpbmcgaXQgZnJvbSB0aGUgc3RvcmUuIik7CiAgICB9CiAgICByZXR1cm4gY3VycmVudFN0YXRlOwogIH0KICBmdW5jdGlvbiBzdWJzY3JpYmUobGlzdGVuZXIyKSB7CiAgICBpZiAodHlwZW9mIGxpc3RlbmVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQpIDogYEV4cGVjdGVkIHRoZSBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKGxpc3RlbmVyMil9J2ApOwogICAgfQogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg1KSA6ICJZb3UgbWF5IG5vdCBjYWxsIHN0b3JlLnN1YnNjcmliZSgpIHdoaWxlIHRoZSByZWR1Y2VyIGlzIGV4ZWN1dGluZy4gSWYgeW91IHdvdWxkIGxpa2UgdG8gYmUgbm90aWZpZWQgYWZ0ZXIgdGhlIHN0b3JlIGhhcyBiZWVuIHVwZGF0ZWQsIHN1YnNjcmliZSBmcm9tIGEgY29tcG9uZW50IGFuZCBpbnZva2Ugc3RvcmUuZ2V0U3RhdGUoKSBpbiB0aGUgY2FsbGJhY2sgdG8gYWNjZXNzIHRoZSBsYXRlc3Qgc3RhdGUuIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy9hcGkvc3RvcmUjc3Vic2NyaWJlbGlzdGVuZXIgZm9yIG1vcmUgZGV0YWlscy4iKTsKICAgIH0KICAgIGxldCBpc1N1YnNjcmliZWQgPSB0cnVlOwogICAgZW5zdXJlQ2FuTXV0YXRlTmV4dExpc3RlbmVycygpOwogICAgY29uc3QgbGlzdGVuZXJJZCA9IGxpc3RlbmVySWRDb3VudGVyKys7CiAgICBuZXh0TGlzdGVuZXJzLnNldChsaXN0ZW5lcklkLCBsaXN0ZW5lcjIpOwogICAgcmV0dXJuIGZ1bmN0aW9uIHVuc3Vic2NyaWJlKCkgewogICAgICBpZiAoIWlzU3Vic2NyaWJlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNikgOiAiWW91IG1heSBub3QgdW5zdWJzY3JpYmUgZnJvbSBhIHN0b3JlIGxpc3RlbmVyIHdoaWxlIHRoZSByZWR1Y2VyIGlzIGV4ZWN1dGluZy4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2FwaS9zdG9yZSNzdWJzY3JpYmVsaXN0ZW5lciBmb3IgbW9yZSBkZXRhaWxzLiIpOwogICAgICB9CiAgICAgIGlzU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICBlbnN1cmVDYW5NdXRhdGVOZXh0TGlzdGVuZXJzKCk7CiAgICAgIG5leHRMaXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVySWQpOwogICAgICBjdXJyZW50TGlzdGVuZXJzID0gbnVsbDsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGRpc3BhdGNoKGFjdGlvbikgewogICAgaWYgKCFpc1BsYWluT2JqZWN0KGFjdGlvbikpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg3KSA6IGBBY3Rpb25zIG11c3QgYmUgcGxhaW4gb2JqZWN0cy4gSW5zdGVhZCwgdGhlIGFjdHVhbCB0eXBlIHdhczogJyR7a2luZE9mKGFjdGlvbil9Jy4gWW91IG1heSBuZWVkIHRvIGFkZCBtaWRkbGV3YXJlIHRvIHlvdXIgc3RvcmUgc2V0dXAgdG8gaGFuZGxlIGRpc3BhdGNoaW5nIG90aGVyIHZhbHVlcywgc3VjaCBhcyAncmVkdXgtdGh1bmsnIHRvIGhhbmRsZSBkaXNwYXRjaGluZyBmdW5jdGlvbnMuIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNC1zdG9yZSNtaWRkbGV3YXJlIGFuZCBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNi1hc3luYy1sb2dpYyN1c2luZy10aGUtcmVkdXgtdGh1bmstbWlkZGxld2FyZSBmb3IgZXhhbXBsZXMuYCk7CiAgICB9CiAgICBpZiAodHlwZW9mIGFjdGlvbi50eXBlID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDgpIDogJ0FjdGlvbnMgbWF5IG5vdCBoYXZlIGFuIHVuZGVmaW5lZCAidHlwZSIgcHJvcGVydHkuIFlvdSBtYXkgaGF2ZSBtaXNzcGVsbGVkIGFuIGFjdGlvbiB0eXBlIHN0cmluZyBjb25zdGFudC4nKTsKICAgIH0KICAgIGlmICh0eXBlb2YgYWN0aW9uLnR5cGUgIT09ICJzdHJpbmciKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTcpIDogYEFjdGlvbiAidHlwZSIgcHJvcGVydHkgbXVzdCBiZSBhIHN0cmluZy4gSW5zdGVhZCwgdGhlIGFjdHVhbCB0eXBlIHdhczogJyR7a2luZE9mKGFjdGlvbi50eXBlKX0nLiBWYWx1ZSB3YXM6ICcke2FjdGlvbi50eXBlfScgKHN0cmluZ2lmaWVkKWApOwogICAgfQogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg5KSA6ICJSZWR1Y2VycyBtYXkgbm90IGRpc3BhdGNoIGFjdGlvbnMuIik7CiAgICB9CiAgICB0cnkgewogICAgICBpc0Rpc3BhdGNoaW5nID0gdHJ1ZTsKICAgICAgY3VycmVudFN0YXRlID0gY3VycmVudFJlZHVjZXIoY3VycmVudFN0YXRlLCBhY3Rpb24pOwogICAgfSBmaW5hbGx5IHsKICAgICAgaXNEaXNwYXRjaGluZyA9IGZhbHNlOwogICAgfQogICAgY29uc3QgbGlzdGVuZXJzID0gY3VycmVudExpc3RlbmVycyA9IG5leHRMaXN0ZW5lcnM7CiAgICBsaXN0ZW5lcnMuZm9yRWFjaCgobGlzdGVuZXIyKSA9PiB7CiAgICAgIGxpc3RlbmVyMigpOwogICAgfSk7CiAgICByZXR1cm4gYWN0aW9uOwogIH0KICBmdW5jdGlvbiByZXBsYWNlUmVkdWNlcihuZXh0UmVkdWNlcikgewogICAgaWYgKHR5cGVvZiBuZXh0UmVkdWNlciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEwKSA6IGBFeHBlY3RlZCB0aGUgbmV4dFJlZHVjZXIgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihuZXh0UmVkdWNlcil9YCk7CiAgICB9CiAgICBjdXJyZW50UmVkdWNlciA9IG5leHRSZWR1Y2VyOwogICAgZGlzcGF0Y2goewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LlJFUExBQ0UKICAgIH0pOwogIH0KICBmdW5jdGlvbiBvYnNlcnZhYmxlKCkgewogICAgY29uc3Qgb3V0ZXJTdWJzY3JpYmUgPSBzdWJzY3JpYmU7CiAgICByZXR1cm4gewogICAgICAvKioKICAgICAgICogVGhlIG1pbmltYWwgb2JzZXJ2YWJsZSBzdWJzY3JpcHRpb24gbWV0aG9kLgogICAgICAgKiBAcGFyYW0gb2JzZXJ2ZXIgQW55IG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIGFzIGFuIG9ic2VydmVyLgogICAgICAgKiBUaGUgb2JzZXJ2ZXIgb2JqZWN0IHNob3VsZCBoYXZlIGEgYG5leHRgIG1ldGhvZC4KICAgICAgICogQHJldHVybnMgQW4gb2JqZWN0IHdpdGggYW4gYHVuc3Vic2NyaWJlYCBtZXRob2QgdGhhdCBjYW4KICAgICAgICogYmUgdXNlZCB0byB1bnN1YnNjcmliZSB0aGUgb2JzZXJ2YWJsZSBmcm9tIHRoZSBzdG9yZSwgYW5kIHByZXZlbnQgZnVydGhlcgogICAgICAgKiBlbWlzc2lvbiBvZiB2YWx1ZXMgZnJvbSB0aGUgb2JzZXJ2YWJsZS4KICAgICAgICovCiAgICAgIHN1YnNjcmliZShvYnNlcnZlcikgewogICAgICAgIGlmICh0eXBlb2Ygb2JzZXJ2ZXIgIT09ICJvYmplY3QiIHx8IG9ic2VydmVyID09PSBudWxsKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDExKSA6IGBFeHBlY3RlZCB0aGUgb2JzZXJ2ZXIgdG8gYmUgYW4gb2JqZWN0LiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKG9ic2VydmVyKX0nYCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9ic2VydmVTdGF0ZSgpIHsKICAgICAgICAgIGNvbnN0IG9ic2VydmVyQXNPYnNlcnZlciA9IG9ic2VydmVyOwogICAgICAgICAgaWYgKG9ic2VydmVyQXNPYnNlcnZlci5uZXh0KSB7CiAgICAgICAgICAgIG9ic2VydmVyQXNPYnNlcnZlci5uZXh0KGdldFN0YXRlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvYnNlcnZlU3RhdGUoKTsKICAgICAgICBjb25zdCB1bnN1YnNjcmliZSA9IG91dGVyU3Vic2NyaWJlKG9ic2VydmVTdGF0ZSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHVuc3Vic2NyaWJlCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgW3N5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHRdKCkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICB9OwogIH0KICBkaXNwYXRjaCh7CiAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQKICB9KTsKICBjb25zdCBzdG9yZSA9IHsKICAgIGRpc3BhdGNoLAogICAgc3Vic2NyaWJlLAogICAgZ2V0U3RhdGUsCiAgICByZXBsYWNlUmVkdWNlciwKICAgIFtzeW1ib2xfb2JzZXJ2YWJsZV9kZWZhdWx0XTogb2JzZXJ2YWJsZQogIH07CiAgcmV0dXJuIHN0b3JlOwp9CmZ1bmN0aW9uIHdhcm5pbmcobWVzc2FnZSkgewogIGlmICh0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGNvbnNvbGUuZXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CiAgfQogIHRyeSB7CiAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7CiAgfSBjYXRjaCAoZSkgewogIH0KfQpmdW5jdGlvbiBnZXRVbmV4cGVjdGVkU3RhdGVTaGFwZVdhcm5pbmdNZXNzYWdlKGlucHV0U3RhdGUsIHJlZHVjZXJzLCBhY3Rpb24sIHVuZXhwZWN0ZWRLZXlDYWNoZSkgewogIGNvbnN0IHJlZHVjZXJLZXlzID0gT2JqZWN0LmtleXMocmVkdWNlcnMpOwogIGNvbnN0IGFyZ3VtZW50TmFtZSA9IGFjdGlvbiAmJiBhY3Rpb24udHlwZSA9PT0gYWN0aW9uVHlwZXNfZGVmYXVsdC5JTklUID8gInByZWxvYWRlZFN0YXRlIGFyZ3VtZW50IHBhc3NlZCB0byBjcmVhdGVTdG9yZSIgOiAicHJldmlvdXMgc3RhdGUgcmVjZWl2ZWQgYnkgdGhlIHJlZHVjZXIiOwogIGlmIChyZWR1Y2VyS2V5cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiAiU3RvcmUgZG9lcyBub3QgaGF2ZSBhIHZhbGlkIHJlZHVjZXIuIE1ha2Ugc3VyZSB0aGUgYXJndW1lbnQgcGFzc2VkIHRvIGNvbWJpbmVSZWR1Y2VycyBpcyBhbiBvYmplY3Qgd2hvc2UgdmFsdWVzIGFyZSByZWR1Y2Vycy4iOwogIH0KICBpZiAoIWlzUGxhaW5PYmplY3QoaW5wdXRTdGF0ZSkpIHsKICAgIHJldHVybiBgVGhlICR7YXJndW1lbnROYW1lfSBoYXMgdW5leHBlY3RlZCB0eXBlIG9mICIke2tpbmRPZihpbnB1dFN0YXRlKX0iLiBFeHBlY3RlZCBhcmd1bWVudCB0byBiZSBhbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIGtleXM6ICIke3JlZHVjZXJLZXlzLmpvaW4oJyIsICInKX0iYDsKICB9CiAgY29uc3QgdW5leHBlY3RlZEtleXMgPSBPYmplY3Qua2V5cyhpbnB1dFN0YXRlKS5maWx0ZXIoKGtleSkgPT4gIXJlZHVjZXJzLmhhc093blByb3BlcnR5KGtleSkgJiYgIXVuZXhwZWN0ZWRLZXlDYWNoZVtrZXldKTsKICB1bmV4cGVjdGVkS2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgIHVuZXhwZWN0ZWRLZXlDYWNoZVtrZXldID0gdHJ1ZTsKICB9KTsKICBpZiAoYWN0aW9uICYmIGFjdGlvbi50eXBlID09PSBhY3Rpb25UeXBlc19kZWZhdWx0LlJFUExBQ0UpCiAgICByZXR1cm47CiAgaWYgKHVuZXhwZWN0ZWRLZXlzLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBgVW5leHBlY3RlZCAke3VuZXhwZWN0ZWRLZXlzLmxlbmd0aCA+IDEgPyAia2V5cyIgOiAia2V5In0gIiR7dW5leHBlY3RlZEtleXMuam9pbignIiwgIicpfSIgZm91bmQgaW4gJHthcmd1bWVudE5hbWV9LiBFeHBlY3RlZCB0byBmaW5kIG9uZSBvZiB0aGUga25vd24gcmVkdWNlciBrZXlzIGluc3RlYWQ6ICIke3JlZHVjZXJLZXlzLmpvaW4oJyIsICInKX0iLiBVbmV4cGVjdGVkIGtleXMgd2lsbCBiZSBpZ25vcmVkLmA7CiAgfQp9CmZ1bmN0aW9uIGFzc2VydFJlZHVjZXJTaGFwZShyZWR1Y2VycykgewogIE9iamVjdC5rZXlzKHJlZHVjZXJzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgIGNvbnN0IHJlZHVjZXIgPSByZWR1Y2Vyc1trZXldOwogICAgY29uc3QgaW5pdGlhbFN0YXRlMTMgPSByZWR1Y2VyKHZvaWQgMCwgewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQKICAgIH0pOwogICAgaWYgKHR5cGVvZiBpbml0aWFsU3RhdGUxMyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMikgOiBgVGhlIHNsaWNlIHJlZHVjZXIgZm9yIGtleSAiJHtrZXl9IiByZXR1cm5lZCB1bmRlZmluZWQgZHVyaW5nIGluaXRpYWxpemF0aW9uLiBJZiB0aGUgc3RhdGUgcGFzc2VkIHRvIHRoZSByZWR1Y2VyIGlzIHVuZGVmaW5lZCwgeW91IG11c3QgZXhwbGljaXRseSByZXR1cm4gdGhlIGluaXRpYWwgc3RhdGUuIFRoZSBpbml0aWFsIHN0YXRlIG1heSBub3QgYmUgdW5kZWZpbmVkLiBJZiB5b3UgZG9uJ3Qgd2FudCB0byBzZXQgYSB2YWx1ZSBmb3IgdGhpcyByZWR1Y2VyLCB5b3UgY2FuIHVzZSBudWxsIGluc3RlYWQgb2YgdW5kZWZpbmVkLmApOwogICAgfQogICAgaWYgKHR5cGVvZiByZWR1Y2VyKHZvaWQgMCwgewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LlBST0JFX1VOS05PV05fQUNUSU9OKCkKICAgIH0pID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEzKSA6IGBUaGUgc2xpY2UgcmVkdWNlciBmb3Iga2V5ICIke2tleX0iIHJldHVybmVkIHVuZGVmaW5lZCB3aGVuIHByb2JlZCB3aXRoIGEgcmFuZG9tIHR5cGUuIERvbid0IHRyeSB0byBoYW5kbGUgJyR7YWN0aW9uVHlwZXNfZGVmYXVsdC5JTklUfScgb3Igb3RoZXIgYWN0aW9ucyBpbiAicmVkdXgvKiIgbmFtZXNwYWNlLiBUaGV5IGFyZSBjb25zaWRlcmVkIHByaXZhdGUuIEluc3RlYWQsIHlvdSBtdXN0IHJldHVybiB0aGUgY3VycmVudCBzdGF0ZSBmb3IgYW55IHVua25vd24gYWN0aW9ucywgdW5sZXNzIGl0IGlzIHVuZGVmaW5lZCwgaW4gd2hpY2ggY2FzZSB5b3UgbXVzdCByZXR1cm4gdGhlIGluaXRpYWwgc3RhdGUsIHJlZ2FyZGxlc3Mgb2YgdGhlIGFjdGlvbiB0eXBlLiBUaGUgaW5pdGlhbCBzdGF0ZSBtYXkgbm90IGJlIHVuZGVmaW5lZCwgYnV0IGNhbiBiZSBudWxsLmApOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGNvbWJpbmVSZWR1Y2VycyhyZWR1Y2VycykgewogIGNvbnN0IHJlZHVjZXJLZXlzID0gT2JqZWN0LmtleXMocmVkdWNlcnMpOwogIGNvbnN0IGZpbmFsUmVkdWNlcnMgPSB7fTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHJlZHVjZXJLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBrZXkgPSByZWR1Y2VyS2V5c1tpXTsKICAgIGlmICh0cnVlKSB7CiAgICAgIGlmICh0eXBlb2YgcmVkdWNlcnNba2V5XSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICB3YXJuaW5nKGBObyByZWR1Y2VyIHByb3ZpZGVkIGZvciBrZXkgIiR7a2V5fSJgKTsKICAgICAgfQogICAgfQogICAgaWYgKHR5cGVvZiByZWR1Y2Vyc1trZXldID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGZpbmFsUmVkdWNlcnNba2V5XSA9IHJlZHVjZXJzW2tleV07CiAgICB9CiAgfQogIGNvbnN0IGZpbmFsUmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhmaW5hbFJlZHVjZXJzKTsKICBsZXQgdW5leHBlY3RlZEtleUNhY2hlOwogIGlmICh0cnVlKSB7CiAgICB1bmV4cGVjdGVkS2V5Q2FjaGUgPSB7fTsKICB9CiAgbGV0IHNoYXBlQXNzZXJ0aW9uRXJyb3I7CiAgdHJ5IHsKICAgIGFzc2VydFJlZHVjZXJTaGFwZShmaW5hbFJlZHVjZXJzKTsKICB9IGNhdGNoIChlKSB7CiAgICBzaGFwZUFzc2VydGlvbkVycm9yID0gZTsKICB9CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbWJpbmF0aW9uKHN0YXRlID0ge30sIGFjdGlvbikgewogICAgaWYgKHNoYXBlQXNzZXJ0aW9uRXJyb3IpIHsKICAgICAgdGhyb3cgc2hhcGVBc3NlcnRpb25FcnJvcjsKICAgIH0KICAgIGlmICh0cnVlKSB7CiAgICAgIGNvbnN0IHdhcm5pbmdNZXNzYWdlID0gZ2V0VW5leHBlY3RlZFN0YXRlU2hhcGVXYXJuaW5nTWVzc2FnZShzdGF0ZSwgZmluYWxSZWR1Y2VycywgYWN0aW9uLCB1bmV4cGVjdGVkS2V5Q2FjaGUpOwogICAgICBpZiAod2FybmluZ01lc3NhZ2UpIHsKICAgICAgICB3YXJuaW5nKHdhcm5pbmdNZXNzYWdlKTsKICAgICAgfQogICAgfQogICAgbGV0IGhhc0NoYW5nZWQgPSBmYWxzZTsKICAgIGNvbnN0IG5leHRTdGF0ZSA9IHt9OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaW5hbFJlZHVjZXJLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGtleSA9IGZpbmFsUmVkdWNlcktleXNbaV07CiAgICAgIGNvbnN0IHJlZHVjZXIgPSBmaW5hbFJlZHVjZXJzW2tleV07CiAgICAgIGNvbnN0IHByZXZpb3VzU3RhdGVGb3JLZXkgPSBzdGF0ZVtrZXldOwogICAgICBjb25zdCBuZXh0U3RhdGVGb3JLZXkgPSByZWR1Y2VyKHByZXZpb3VzU3RhdGVGb3JLZXksIGFjdGlvbik7CiAgICAgIGlmICh0eXBlb2YgbmV4dFN0YXRlRm9yS2V5ID09PSAidW5kZWZpbmVkIikgewogICAgICAgIGNvbnN0IGFjdGlvblR5cGUgPSBhY3Rpb24gJiYgYWN0aW9uLnR5cGU7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNCkgOiBgV2hlbiBjYWxsZWQgd2l0aCBhbiBhY3Rpb24gb2YgdHlwZSAke2FjdGlvblR5cGUgPyBgIiR7U3RyaW5nKGFjdGlvblR5cGUpfSJgIDogIih1bmtub3duIHR5cGUpIn0sIHRoZSBzbGljZSByZWR1Y2VyIGZvciBrZXkgIiR7a2V5fSIgcmV0dXJuZWQgdW5kZWZpbmVkLiBUbyBpZ25vcmUgYW4gYWN0aW9uLCB5b3UgbXVzdCBleHBsaWNpdGx5IHJldHVybiB0aGUgcHJldmlvdXMgc3RhdGUuIElmIHlvdSB3YW50IHRoaXMgcmVkdWNlciB0byBob2xkIG5vIHZhbHVlLCB5b3UgY2FuIHJldHVybiBudWxsIGluc3RlYWQgb2YgdW5kZWZpbmVkLmApOwogICAgICB9CiAgICAgIG5leHRTdGF0ZVtrZXldID0gbmV4dFN0YXRlRm9yS2V5OwogICAgICBoYXNDaGFuZ2VkID0gaGFzQ2hhbmdlZCB8fCBuZXh0U3RhdGVGb3JLZXkgIT09IHByZXZpb3VzU3RhdGVGb3JLZXk7CiAgICB9CiAgICBoYXNDaGFuZ2VkID0gaGFzQ2hhbmdlZCB8fCBmaW5hbFJlZHVjZXJLZXlzLmxlbmd0aCAhPT0gT2JqZWN0LmtleXMoc3RhdGUpLmxlbmd0aDsKICAgIHJldHVybiBoYXNDaGFuZ2VkID8gbmV4dFN0YXRlIDogc3RhdGU7CiAgfTsKfQpmdW5jdGlvbiBjb21wb3NlKC4uLmZ1bmNzKSB7CiAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIChhcmcpID0+IGFyZzsKICB9CiAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMSkgewogICAgcmV0dXJuIGZ1bmNzWzBdOwogIH0KICByZXR1cm4gZnVuY3MucmVkdWNlKChhMiwgYikgPT4gKC4uLmFyZ3MpID0+IGEyKGIoLi4uYXJncykpKTsKfQpmdW5jdGlvbiBhcHBseU1pZGRsZXdhcmUoLi4ubWlkZGxld2FyZXMpIHsKICByZXR1cm4gKGNyZWF0ZVN0b3JlMikgPT4gKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlKSA9PiB7CiAgICBjb25zdCBzdG9yZSA9IGNyZWF0ZVN0b3JlMihyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSk7CiAgICBsZXQgZGlzcGF0Y2ggPSAoKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTUpIDogIkRpc3BhdGNoaW5nIHdoaWxlIGNvbnN0cnVjdGluZyB5b3VyIG1pZGRsZXdhcmUgaXMgbm90IGFsbG93ZWQuIE90aGVyIG1pZGRsZXdhcmUgd291bGQgbm90IGJlIGFwcGxpZWQgdG8gdGhpcyBkaXNwYXRjaC4iKTsKICAgIH07CiAgICBjb25zdCBtaWRkbGV3YXJlQVBJID0gewogICAgICBnZXRTdGF0ZTogc3RvcmUuZ2V0U3RhdGUsCiAgICAgIGRpc3BhdGNoOiAoYWN0aW9uLCAuLi5hcmdzKSA9PiBkaXNwYXRjaChhY3Rpb24sIC4uLmFyZ3MpCiAgICB9OwogICAgY29uc3QgY2hhaW4gPSBtaWRkbGV3YXJlcy5tYXAoKG1pZGRsZXdhcmUpID0+IG1pZGRsZXdhcmUobWlkZGxld2FyZUFQSSkpOwogICAgZGlzcGF0Y2ggPSBjb21wb3NlKC4uLmNoYWluKShzdG9yZS5kaXNwYXRjaCk7CiAgICByZXR1cm4gewogICAgICAuLi5zdG9yZSwKICAgICAgZGlzcGF0Y2gKICAgIH07CiAgfTsKfQpmdW5jdGlvbiBpc0FjdGlvbihhY3Rpb24pIHsKICByZXR1cm4gaXNQbGFpbk9iamVjdChhY3Rpb24pICYmICJ0eXBlIiBpbiBhY3Rpb24gJiYgdHlwZW9mIGFjdGlvbi50eXBlID09PSAic3RyaW5nIjsKfQoKLy8gbm9kZV9tb2R1bGVzL0ByZWR1eGpzL3Rvb2xraXQvbm9kZV9tb2R1bGVzL2ltbWVyL2Rpc3QvaW1tZXIubWpzCnZhciBOT1RISU5HID0gU3ltYm9sLmZvcigiaW1tZXItbm90aGluZyIpOwp2YXIgRFJBRlRBQkxFID0gU3ltYm9sLmZvcigiaW1tZXItZHJhZnRhYmxlIik7CnZhciBEUkFGVF9TVEFURSA9IFN5bWJvbC5mb3IoImltbWVyLXN0YXRlIik7CnZhciBlcnJvcnMgPSB0cnVlID8gWwogIC8vIEFsbCBlcnJvciBjb2Rlcywgc3RhcnRpbmcgYnkgMDoKICBmdW5jdGlvbihwbHVnaW4pIHsKICAgIHJldHVybiBgVGhlIHBsdWdpbiBmb3IgJyR7cGx1Z2lufScgaGFzIG5vdCBiZWVuIGxvYWRlZCBpbnRvIEltbWVyLiBUbyBlbmFibGUgdGhlIHBsdWdpbiwgaW1wb3J0IGFuZCBjYWxsIFxgZW5hYmxlJHtwbHVnaW59KClcYCB3aGVuIGluaXRpYWxpemluZyB5b3VyIGFwcGxpY2F0aW9uLmA7CiAgfSwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGBwcm9kdWNlIGNhbiBvbmx5IGJlIGNhbGxlZCBvbiB0aGluZ3MgdGhhdCBhcmUgZHJhZnRhYmxlOiBwbGFpbiBvYmplY3RzLCBhcnJheXMsIE1hcCwgU2V0IG9yIGNsYXNzZXMgdGhhdCBhcmUgbWFya2VkIHdpdGggJ1tpbW1lcmFibGVdOiB0cnVlJy4gR290ICcke3RoaW5nfSdgOwogIH0sCiAgIlRoaXMgb2JqZWN0IGhhcyBiZWVuIGZyb3plbiBhbmQgc2hvdWxkIG5vdCBiZSBtdXRhdGVkIiwKICBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gIkNhbm5vdCB1c2UgYSBwcm94eSB0aGF0IGhhcyBiZWVuIHJldm9rZWQuIERpZCB5b3UgcGFzcyBhbiBvYmplY3QgZnJvbSBpbnNpZGUgYW4gaW1tZXIgZnVuY3Rpb24gdG8gYW4gYXN5bmMgcHJvY2Vzcz8gIiArIGRhdGE7CiAgfSwKICAiQW4gaW1tZXIgcHJvZHVjZXIgcmV0dXJuZWQgYSBuZXcgdmFsdWUgKmFuZCogbW9kaWZpZWQgaXRzIGRyYWZ0LiBFaXRoZXIgcmV0dXJuIGEgbmV3IHZhbHVlICpvciogbW9kaWZ5IHRoZSBkcmFmdC4iLAogICJJbW1lciBmb3JiaWRzIGNpcmN1bGFyIHJlZmVyZW5jZXMiLAogICJUaGUgZmlyc3Qgb3Igc2Vjb25kIGFyZ3VtZW50IHRvIGBwcm9kdWNlYCBtdXN0IGJlIGEgZnVuY3Rpb24iLAogICJUaGUgdGhpcmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiBvciB1bmRlZmluZWQiLAogICJGaXJzdCBhcmd1bWVudCB0byBgY3JlYXRlRHJhZnRgIG11c3QgYmUgYSBwbGFpbiBvYmplY3QsIGFuIGFycmF5LCBvciBhbiBpbW1lcmFibGUgb2JqZWN0IiwKICAiRmlyc3QgYXJndW1lbnQgdG8gYGZpbmlzaERyYWZ0YCBtdXN0IGJlIGEgZHJhZnQgcmV0dXJuZWQgYnkgYGNyZWF0ZURyYWZ0YCIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ2N1cnJlbnQnIGV4cGVjdHMgYSBkcmFmdCwgZ290OiAke3RoaW5nfWA7CiAgfSwKICAiT2JqZWN0LmRlZmluZVByb3BlcnR5KCkgY2Fubm90IGJlIHVzZWQgb24gYW4gSW1tZXIgZHJhZnQiLAogICJPYmplY3Quc2V0UHJvdG90eXBlT2YoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgZGVsZXRpbmcgYXJyYXkgaW5kaWNlcyIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgc2V0dGluZyBhcnJheSBpbmRpY2VzIGFuZCB0aGUgJ2xlbmd0aCcgcHJvcGVydHkiLAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYCdvcmlnaW5hbCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9CiAgLy8gTm90ZTogaWYgbW9yZSBlcnJvcnMgYXJlIGFkZGVkLCB0aGUgZXJyb3JPZmZzZXQgaW4gUGF0Y2hlcy50cyBzaG91bGQgYmUgaW5jcmVhc2VkCiAgLy8gU2VlIFBhdGNoZXMudHMgZm9yIGFkZGl0aW9uYWwgZXJyb3JzCl0gOiBbXTsKZnVuY3Rpb24gZGllKGVycm9yLCAuLi5hcmdzKSB7CiAgaWYgKHRydWUpIHsKICAgIGNvbnN0IGUgPSBlcnJvcnNbZXJyb3JdOwogICAgY29uc3QgbXNnID0gaXNGdW5jdGlvbihlKSA/IGUuYXBwbHkobnVsbCwgYXJncykgOiBlOwogICAgdGhyb3cgbmV3IEVycm9yKGBbSW1tZXJdICR7bXNnfWApOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoCiAgICBgW0ltbWVyXSBtaW5pZmllZCBlcnJvciBucjogJHtlcnJvcn0uIEZ1bGwgZXJyb3IgYXQ6IGh0dHBzOi8vYml0Lmx5LzNjWEVLV2ZgCiAgKTsKfQp2YXIgTyA9IE9iamVjdDsKdmFyIGdldFByb3RvdHlwZU9mID0gTy5nZXRQcm90b3R5cGVPZjsKdmFyIENPTlNUUlVDVE9SID0gImNvbnN0cnVjdG9yIjsKdmFyIFBST1RPVFlQRSA9ICJwcm90b3R5cGUiOwp2YXIgQ09ORklHVVJBQkxFID0gImNvbmZpZ3VyYWJsZSI7CnZhciBFTlVNRVJBQkxFID0gImVudW1lcmFibGUiOwp2YXIgV1JJVEFCTEUgPSAid3JpdGFibGUiOwp2YXIgVkFMVUUgPSAidmFsdWUiOwp2YXIgaXNEcmFmdCA9ICh2YWx1ZSkgPT4gISF2YWx1ZSAmJiAhIXZhbHVlW0RSQUZUX1NUQVRFXTsKZnVuY3Rpb24gaXNEcmFmdGFibGUodmFsdWUpIHsKICBpZiAoIXZhbHVlKQogICAgcmV0dXJuIGZhbHNlOwogIHJldHVybiBpc1BsYWluT2JqZWN0Mih2YWx1ZSkgfHwgaXNBcnJheSh2YWx1ZSkgfHwgISF2YWx1ZVtEUkFGVEFCTEVdIHx8ICEhdmFsdWVbQ09OU1RSVUNUT1JdPy5bRFJBRlRBQkxFXSB8fCBpc01hcCh2YWx1ZSkgfHwgaXNTZXQodmFsdWUpOwp9CnZhciBvYmplY3RDdG9yU3RyaW5nID0gT1tQUk9UT1RZUEVdW0NPTlNUUlVDVE9SXS50b1N0cmluZygpOwp2YXIgY2FjaGVkQ3RvclN0cmluZ3MgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKZnVuY3Rpb24gaXNQbGFpbk9iamVjdDIodmFsdWUpIHsKICBpZiAoIXZhbHVlIHx8ICFpc09iamVjdGlzaCh2YWx1ZSkpCiAgICByZXR1cm4gZmFsc2U7CiAgY29uc3QgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YodmFsdWUpOwogIGlmIChwcm90bzIgPT09IG51bGwgfHwgcHJvdG8yID09PSBPW1BST1RPVFlQRV0pCiAgICByZXR1cm4gdHJ1ZTsKICBjb25zdCBDdG9yID0gTy5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3RvMiwgQ09OU1RSVUNUT1IpICYmIHByb3RvMltDT05TVFJVQ1RPUl07CiAgaWYgKEN0b3IgPT09IE9iamVjdCkKICAgIHJldHVybiB0cnVlOwogIGlmICghaXNGdW5jdGlvbihDdG9yKSkKICAgIHJldHVybiBmYWxzZTsKICBsZXQgY3RvclN0cmluZyA9IGNhY2hlZEN0b3JTdHJpbmdzLmdldChDdG9yKTsKICBpZiAoY3RvclN0cmluZyA9PT0gdm9pZCAwKSB7CiAgICBjdG9yU3RyaW5nID0gRnVuY3Rpb24udG9TdHJpbmcuY2FsbChDdG9yKTsKICAgIGNhY2hlZEN0b3JTdHJpbmdzLnNldChDdG9yLCBjdG9yU3RyaW5nKTsKICB9CiAgcmV0dXJuIGN0b3JTdHJpbmcgPT09IG9iamVjdEN0b3JTdHJpbmc7Cn0KZnVuY3Rpb24gZWFjaChvYmosIGl0ZXIsIHN0cmljdCA9IHRydWUpIHsKICBpZiAoZ2V0QXJjaHR5cGUob2JqKSA9PT0gMCkgewogICAgY29uc3Qga2V5cyA9IHN0cmljdCA/IFJlZmxlY3Qub3duS2V5cyhvYmopIDogTy5rZXlzKG9iaik7CiAgICBrZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgICBpdGVyKGtleSwgb2JqW2tleV0sIG9iaik7CiAgICB9KTsKICB9IGVsc2UgewogICAgb2JqLmZvckVhY2goKGVudHJ5LCBpbmRleCkgPT4gaXRlcihpbmRleCwgZW50cnksIG9iaikpOwogIH0KfQpmdW5jdGlvbiBnZXRBcmNodHlwZSh0aGluZykgewogIGNvbnN0IHN0YXRlID0gdGhpbmdbRFJBRlRfU1RBVEVdOwogIHJldHVybiBzdGF0ZSA/IHN0YXRlLnR5cGVfIDogaXNBcnJheSh0aGluZykgPyAxIDogaXNNYXAodGhpbmcpID8gMiA6IGlzU2V0KHRoaW5nKSA/IDMgOiAwOwp9CnZhciBoYXMgPSAodGhpbmcsIHByb3AsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+IHR5cGUgPT09IDIgPyB0aGluZy5oYXMocHJvcCkgOiBPW1BST1RPVFlQRV0uaGFzT3duUHJvcGVydHkuY2FsbCh0aGluZywgcHJvcCk7CnZhciBnZXQyID0gKHRoaW5nLCBwcm9wLCB0eXBlID0gZ2V0QXJjaHR5cGUodGhpbmcpKSA9PiAoCiAgLy8gQHRzLWlnbm9yZQogIHR5cGUgPT09IDIgPyB0aGluZy5nZXQocHJvcCkgOiB0aGluZ1twcm9wXQopOwp2YXIgc2V0ID0gKHRoaW5nLCBwcm9wT3JPbGRWYWx1ZSwgdmFsdWUsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+IHsKICBpZiAodHlwZSA9PT0gMikKICAgIHRoaW5nLnNldChwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpOwogIGVsc2UgaWYgKHR5cGUgPT09IDMpIHsKICAgIHRoaW5nLmFkZCh2YWx1ZSk7CiAgfSBlbHNlCiAgICB0aGluZ1twcm9wT3JPbGRWYWx1ZV0gPSB2YWx1ZTsKfTsKZnVuY3Rpb24gaXMoeDIsIHkyKSB7CiAgaWYgKHgyID09PSB5MikgewogICAgcmV0dXJuIHgyICE9PSAwIHx8IDEgLyB4MiA9PT0gMSAvIHkyOwogIH0gZWxzZSB7CiAgICByZXR1cm4geDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9Cn0KdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5Owp2YXIgaXNNYXAgPSAodGFyZ2V0KSA9PiB0YXJnZXQgaW5zdGFuY2VvZiBNYXA7CnZhciBpc1NldCA9ICh0YXJnZXQpID0+IHRhcmdldCBpbnN0YW5jZW9mIFNldDsKdmFyIGlzT2JqZWN0aXNoID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gIm9iamVjdCI7CnZhciBpc0Z1bmN0aW9uID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gImZ1bmN0aW9uIjsKdmFyIGlzQm9vbGVhbiA9ICh0YXJnZXQpID0+IHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIjsKdmFyIGxhdGVzdCA9IChzdGF0ZSkgPT4gc3RhdGUuY29weV8gfHwgc3RhdGUuYmFzZV87CnZhciBnZXRGaW5hbFZhbHVlID0gKHN0YXRlKSA9PiBzdGF0ZS5tb2RpZmllZF8gPyBzdGF0ZS5jb3B5XyA6IHN0YXRlLmJhc2VfOwpmdW5jdGlvbiBzaGFsbG93Q29weShiYXNlLCBzdHJpY3QpIHsKICBpZiAoaXNNYXAoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgTWFwKGJhc2UpOwogIH0KICBpZiAoaXNTZXQoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgU2V0KGJhc2UpOwogIH0KICBpZiAoaXNBcnJheShiYXNlKSkKICAgIHJldHVybiBBcnJheVtQUk9UT1RZUEVdLnNsaWNlLmNhbGwoYmFzZSk7CiAgY29uc3QgaXNQbGFpbjIgPSBpc1BsYWluT2JqZWN0MihiYXNlKTsKICBpZiAoc3RyaWN0ID09PSB0cnVlIHx8IHN0cmljdCA9PT0gImNsYXNzX29ubHkiICYmICFpc1BsYWluMikgewogICAgY29uc3QgZGVzY3JpcHRvcnMgPSBPLmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoYmFzZSk7CiAgICBkZWxldGUgZGVzY3JpcHRvcnNbRFJBRlRfU1RBVEVdOwogICAgbGV0IGtleXMgPSBSZWZsZWN0Lm93bktleXMoZGVzY3JpcHRvcnMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgIGNvbnN0IGRlc2MgPSBkZXNjcmlwdG9yc1trZXldOwogICAgICBpZiAoZGVzY1tXUklUQUJMRV0gPT09IGZhbHNlKSB7CiAgICAgICAgZGVzY1tXUklUQUJMRV0gPSB0cnVlOwogICAgICAgIGRlc2NbQ09ORklHVVJBQkxFXSA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KQogICAgICAgIGRlc2NyaXB0b3JzW2tleV0gPSB7CiAgICAgICAgICBbQ09ORklHVVJBQkxFXTogdHJ1ZSwKICAgICAgICAgIFtXUklUQUJMRV06IHRydWUsCiAgICAgICAgICAvLyBjb3VsZCBsaXZlIHdpdGggISFkZXNjLnNldCBhcyB3ZWxsIGhlcmUuLi4KICAgICAgICAgIFtFTlVNRVJBQkxFXTogZGVzY1tFTlVNRVJBQkxFXSwKICAgICAgICAgIFtWQUxVRV06IGJhc2Vba2V5XQogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gTy5jcmVhdGUoZ2V0UHJvdG90eXBlT2YoYmFzZSksIGRlc2NyaXB0b3JzKTsKICB9IGVsc2UgewogICAgY29uc3QgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YoYmFzZSk7CiAgICBpZiAocHJvdG8yICE9PSBudWxsICYmIGlzUGxhaW4yKSB7CiAgICAgIHJldHVybiB7IC4uLmJhc2UgfTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IE8uY3JlYXRlKHByb3RvMik7CiAgICByZXR1cm4gTy5hc3NpZ24ob2JqLCBiYXNlKTsKICB9Cn0KZnVuY3Rpb24gZnJlZXplKG9iaiwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKGlzRnJvemVuKG9iaikgfHwgaXNEcmFmdChvYmopIHx8ICFpc0RyYWZ0YWJsZShvYmopKQogICAgcmV0dXJuIG9iajsKICBpZiAoZ2V0QXJjaHR5cGUob2JqKSA+IDEpIHsKICAgIE8uZGVmaW5lUHJvcGVydGllcyhvYmosIHsKICAgICAgc2V0OiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGFkZDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlLAogICAgICBjbGVhcjogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlLAogICAgICBkZWxldGU6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZQogICAgfSk7CiAgfQogIE8uZnJlZXplKG9iaik7CiAgaWYgKGRlZXApCiAgICBlYWNoKAogICAgICBvYmosCiAgICAgIChfa2V5LCB2YWx1ZSkgPT4gewogICAgICAgIGZyZWV6ZSh2YWx1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGZhbHNlCiAgICApOwogIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zKCkgewogIGRpZSgyKTsKfQp2YXIgZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlID0gewogIFtWQUxVRV06IGRvbnRNdXRhdGVGcm96ZW5Db2xsZWN0aW9ucwp9OwpmdW5jdGlvbiBpc0Zyb3plbihvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8ICFpc09iamVjdGlzaChvYmopKQogICAgcmV0dXJuIHRydWU7CiAgcmV0dXJuIE8uaXNGcm96ZW4ob2JqKTsKfQp2YXIgUGx1Z2luTWFwU2V0ID0gIk1hcFNldCI7CnZhciBQbHVnaW5QYXRjaGVzID0gIlBhdGNoZXMiOwp2YXIgcGx1Z2lucyA9IHt9OwpmdW5jdGlvbiBnZXRQbHVnaW4ocGx1Z2luS2V5KSB7CiAgY29uc3QgcGx1Z2luID0gcGx1Z2luc1twbHVnaW5LZXldOwogIGlmICghcGx1Z2luKSB7CiAgICBkaWUoMCwgcGx1Z2luS2V5KTsKICB9CiAgcmV0dXJuIHBsdWdpbjsKfQp2YXIgaXNQbHVnaW5Mb2FkZWQgPSAocGx1Z2luS2V5KSA9PiAhIXBsdWdpbnNbcGx1Z2luS2V5XTsKdmFyIGN1cnJlbnRTY29wZTsKdmFyIGdldEN1cnJlbnRTY29wZSA9ICgpID0+IGN1cnJlbnRTY29wZTsKdmFyIGNyZWF0ZVNjb3BlID0gKHBhcmVudF8sIGltbWVyXykgPT4gKHsKICBkcmFmdHNfOiBbXSwKICBwYXJlbnRfLAogIGltbWVyXywKICAvLyBXaGVuZXZlciB0aGUgbW9kaWZpZWQgZHJhZnQgY29udGFpbnMgYSBkcmFmdCBmcm9tIGFub3RoZXIgc2NvcGUsIHdlCiAgLy8gbmVlZCB0byBwcmV2ZW50IGF1dG8tZnJlZXppbmcgc28gdGhlIHVub3duZWQgZHJhZnQgY2FuIGJlIGZpbmFsaXplZC4KICBjYW5BdXRvRnJlZXplXzogdHJ1ZSwKICB1bmZpbmFsaXplZERyYWZ0c186IDAsCiAgaGFuZGxlZFNldF86IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgcHJvY2Vzc2VkRm9yUGF0Y2hlc186IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgbWFwU2V0UGx1Z2luXzogaXNQbHVnaW5Mb2FkZWQoUGx1Z2luTWFwU2V0KSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpIDogdm9pZCAwCn0pOwpmdW5jdGlvbiB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcikgewogIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICBzY29wZS5wYXRjaFBsdWdpbl8gPSBnZXRQbHVnaW4oUGx1Z2luUGF0Y2hlcyk7CiAgICBzY29wZS5wYXRjaGVzXyA9IFtdOwogICAgc2NvcGUuaW52ZXJzZVBhdGNoZXNfID0gW107CiAgICBzY29wZS5wYXRjaExpc3RlbmVyXyA9IHBhdGNoTGlzdGVuZXI7CiAgfQp9CmZ1bmN0aW9uIHJldm9rZVNjb3BlKHNjb3BlKSB7CiAgbGVhdmVTY29wZShzY29wZSk7CiAgc2NvcGUuZHJhZnRzXy5mb3JFYWNoKHJldm9rZURyYWZ0KTsKICBzY29wZS5kcmFmdHNfID0gbnVsbDsKfQpmdW5jdGlvbiBsZWF2ZVNjb3BlKHNjb3BlKSB7CiAgaWYgKHNjb3BlID09PSBjdXJyZW50U2NvcGUpIHsKICAgIGN1cnJlbnRTY29wZSA9IHNjb3BlLnBhcmVudF87CiAgfQp9CnZhciBlbnRlclNjb3BlID0gKGltbWVyMjIpID0+IGN1cnJlbnRTY29wZSA9IGNyZWF0ZVNjb3BlKGN1cnJlbnRTY29wZSwgaW1tZXIyMik7CmZ1bmN0aW9uIHJldm9rZURyYWZ0KGRyYWZ0KSB7CiAgY29uc3Qgc3RhdGUgPSBkcmFmdFtEUkFGVF9TVEFURV07CiAgaWYgKHN0YXRlLnR5cGVfID09PSAwIHx8IHN0YXRlLnR5cGVfID09PSAxKQogICAgc3RhdGUucmV2b2tlXygpOwogIGVsc2UKICAgIHN0YXRlLnJldm9rZWRfID0gdHJ1ZTsKfQpmdW5jdGlvbiBwcm9jZXNzUmVzdWx0KHJlc3VsdCwgc2NvcGUpIHsKICBzY29wZS51bmZpbmFsaXplZERyYWZ0c18gPSBzY29wZS5kcmFmdHNfLmxlbmd0aDsKICBjb25zdCBiYXNlRHJhZnQgPSBzY29wZS5kcmFmdHNfWzBdOwogIGNvbnN0IGlzUmVwbGFjZWQgPSByZXN1bHQgIT09IHZvaWQgMCAmJiByZXN1bHQgIT09IGJhc2VEcmFmdDsKICBpZiAoaXNSZXBsYWNlZCkgewogICAgaWYgKGJhc2VEcmFmdFtEUkFGVF9TVEFURV0ubW9kaWZpZWRfKSB7CiAgICAgIHJldm9rZVNjb3BlKHNjb3BlKTsKICAgICAgZGllKDQpOwogICAgfQogICAgaWYgKGlzRHJhZnRhYmxlKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gZmluYWxpemUoc2NvcGUsIHJlc3VsdCk7CiAgICB9CiAgICBjb25zdCB7IHBhdGNoUGx1Z2luXyB9ID0gc2NvcGU7CiAgICBpZiAocGF0Y2hQbHVnaW5fKSB7CiAgICAgIHBhdGNoUGx1Z2luXy5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oCiAgICAgICAgYmFzZURyYWZ0W0RSQUZUX1NUQVRFXS5iYXNlXywKICAgICAgICByZXN1bHQsCiAgICAgICAgc2NvcGUKICAgICAgKTsKICAgIH0KICB9IGVsc2UgewogICAgcmVzdWx0ID0gZmluYWxpemUoc2NvcGUsIGJhc2VEcmFmdCk7CiAgfQogIG1heWJlRnJlZXplKHNjb3BlLCByZXN1bHQsIHRydWUpOwogIHJldm9rZVNjb3BlKHNjb3BlKTsKICBpZiAoc2NvcGUucGF0Y2hlc18pIHsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfKHNjb3BlLnBhdGNoZXNfLCBzY29wZS5pbnZlcnNlUGF0Y2hlc18pOwogIH0KICByZXR1cm4gcmVzdWx0ICE9PSBOT1RISU5HID8gcmVzdWx0IDogdm9pZCAwOwp9CmZ1bmN0aW9uIGZpbmFsaXplKHJvb3RTY29wZSwgdmFsdWUpIHsKICBpZiAoaXNGcm96ZW4odmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogIGlmICghc3RhdGUpIHsKICAgIGNvbnN0IGZpbmFsVmFsdWUgPSBoYW5kbGVWYWx1ZSh2YWx1ZSwgcm9vdFNjb3BlLmhhbmRsZWRTZXRfLCByb290U2NvcGUpOwogICAgcmV0dXJuIGZpbmFsVmFsdWU7CiAgfQogIGlmICghaXNTYW1lU2NvcGUoc3RhdGUsIHJvb3RTY29wZSkpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICB9CiAgaWYgKCFzdGF0ZS5maW5hbGl6ZWRfKSB7CiAgICBjb25zdCB7IGNhbGxiYWNrc18gfSA9IHN0YXRlOwogICAgaWYgKGNhbGxiYWNrc18pIHsKICAgICAgd2hpbGUgKGNhbGxiYWNrc18ubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IGNhbGxiYWNrID0gY2FsbGJhY2tzXy5wb3AoKTsKICAgICAgICBjYWxsYmFjayhyb290U2NvcGUpOwogICAgICB9CiAgICB9CiAgICBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKTsKICB9CiAgcmV0dXJuIHN0YXRlLmNvcHlfOwp9CmZ1bmN0aW9uIG1heWJlRnJlZXplKHNjb3BlLCB2YWx1ZSwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKCFzY29wZS5wYXJlbnRfICYmIHNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiBzY29wZS5jYW5BdXRvRnJlZXplXykgewogICAgZnJlZXplKHZhbHVlLCBkZWVwKTsKICB9Cn0KZnVuY3Rpb24gbWFya1N0YXRlRmluYWxpemVkKHN0YXRlKSB7CiAgc3RhdGUuZmluYWxpemVkXyA9IHRydWU7CiAgc3RhdGUuc2NvcGVfLnVuZmluYWxpemVkRHJhZnRzXy0tOwp9CnZhciBpc1NhbWVTY29wZSA9IChzdGF0ZSwgcm9vdFNjb3BlKSA9PiBzdGF0ZS5zY29wZV8gPT09IHJvb3RTY29wZTsKdmFyIEVNUFRZX0xPQ0FUSU9OU19SRVNVTFQgPSBbXTsKZnVuY3Rpb24gdXBkYXRlRHJhZnRJblBhcmVudChwYXJlbnQsIGRyYWZ0VmFsdWUsIGZpbmFsaXplZFZhbHVlLCBvcmlnaW5hbEtleSkgewogIGNvbnN0IHBhcmVudENvcHkgPSBsYXRlc3QocGFyZW50KTsKICBjb25zdCBwYXJlbnRUeXBlID0gcGFyZW50LnR5cGVfOwogIGlmIChvcmlnaW5hbEtleSAhPT0gdm9pZCAwKSB7CiAgICBjb25zdCBjdXJyZW50VmFsdWUgPSBnZXQyKHBhcmVudENvcHksIG9yaWdpbmFsS2V5LCBwYXJlbnRUeXBlKTsKICAgIGlmIChjdXJyZW50VmFsdWUgPT09IGRyYWZ0VmFsdWUpIHsKICAgICAgc2V0KHBhcmVudENvcHksIG9yaWdpbmFsS2V5LCBmaW5hbGl6ZWRWYWx1ZSwgcGFyZW50VHlwZSk7CiAgICAgIHJldHVybjsKICAgIH0KICB9CiAgaWYgKCFwYXJlbnQuZHJhZnRMb2NhdGlvbnNfKSB7CiAgICBjb25zdCBkcmFmdExvY2F0aW9ucyA9IHBhcmVudC5kcmFmdExvY2F0aW9uc18gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgZWFjaChwYXJlbnRDb3B5LCAoa2V5LCB2YWx1ZSkgPT4gewogICAgICBpZiAoaXNEcmFmdCh2YWx1ZSkpIHsKICAgICAgICBjb25zdCBrZXlzID0gZHJhZnRMb2NhdGlvbnMuZ2V0KHZhbHVlKSB8fCBbXTsKICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICBkcmFmdExvY2F0aW9ucy5zZXQodmFsdWUsIGtleXMpOwogICAgICB9CiAgICB9KTsKICB9CiAgY29uc3QgbG9jYXRpb25zID0gcGFyZW50LmRyYWZ0TG9jYXRpb25zXy5nZXQoZHJhZnRWYWx1ZSkgPz8gRU1QVFlfTE9DQVRJT05TX1JFU1VMVDsKICBmb3IgKGNvbnN0IGxvY2F0aW9uIG9mIGxvY2F0aW9ucykgewogICAgc2V0KHBhcmVudENvcHksIGxvY2F0aW9uLCBmaW5hbGl6ZWRWYWx1ZSwgcGFyZW50VHlwZSk7CiAgfQp9CmZ1bmN0aW9uIHJlZ2lzdGVyQ2hpbGRGaW5hbGl6YXRpb25DYWxsYmFjayhwYXJlbnQsIGNoaWxkLCBrZXkpIHsKICBwYXJlbnQuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIGNoaWxkQ2xlYW51cChyb290U2NvcGUpIHsKICAgIGNvbnN0IHN0YXRlID0gY2hpbGQ7CiAgICBpZiAoIXN0YXRlIHx8ICFpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByb290U2NvcGUubWFwU2V0UGx1Z2luXz8uZml4U2V0Q29udGVudHMoc3RhdGUpOwogICAgY29uc3QgZmluYWxpemVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgIHVwZGF0ZURyYWZ0SW5QYXJlbnQocGFyZW50LCBzdGF0ZS5kcmFmdF8gPz8gc3RhdGUsIGZpbmFsaXplZFZhbHVlLCBrZXkpOwogICAgZ2VuZXJhdGVQYXRjaGVzQW5kRmluYWxpemUoc3RhdGUsIHJvb3RTY29wZSk7CiAgfSk7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVQYXRjaGVzQW5kRmluYWxpemUoc3RhdGUsIHJvb3RTY29wZSkgewogIGNvbnN0IHNob3VsZEZpbmFsaXplID0gc3RhdGUubW9kaWZpZWRfICYmICFzdGF0ZS5maW5hbGl6ZWRfICYmIChzdGF0ZS50eXBlXyA9PT0gMyB8fCAoc3RhdGUuYXNzaWduZWRfPy5zaXplID8/IDApID4gMCk7CiAgaWYgKHNob3VsZEZpbmFsaXplKSB7CiAgICBjb25zdCB7IHBhdGNoUGx1Z2luXyB9ID0gcm9vdFNjb3BlOwogICAgaWYgKHBhdGNoUGx1Z2luXykgewogICAgICBjb25zdCBiYXNlUGF0aCA9IHBhdGNoUGx1Z2luXy5nZXRQYXRoKHN0YXRlKTsKICAgICAgaWYgKGJhc2VQYXRoKSB7CiAgICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUGF0Y2hlc18oc3RhdGUsIGJhc2VQYXRoLCByb290U2NvcGUpOwogICAgICB9CiAgICB9CiAgICBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpOwogIH0KfQpmdW5jdGlvbiBoYW5kbGVDcm9zc1JlZmVyZW5jZSh0YXJnZXQsIGtleSwgdmFsdWUpIHsKICBjb25zdCB7IHNjb3BlXyB9ID0gdGFyZ2V0OwogIGlmIChpc0RyYWZ0KHZhbHVlKSkgewogICAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgICBpZiAoaXNTYW1lU2NvcGUoc3RhdGUsIHNjb3BlXykpIHsKICAgICAgc3RhdGUuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIGNyb3NzUmVmZXJlbmNlQ2xlYW51cCgpIHsKICAgICAgICBwcmVwYXJlQ29weSh0YXJnZXQpOwogICAgICAgIGNvbnN0IGZpbmFsaXplZFZhbHVlID0gZ2V0RmluYWxWYWx1ZShzdGF0ZSk7CiAgICAgICAgdXBkYXRlRHJhZnRJblBhcmVudCh0YXJnZXQsIHZhbHVlLCBmaW5hbGl6ZWRWYWx1ZSwga2V5KTsKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChpc0RyYWZ0YWJsZSh2YWx1ZSkpIHsKICAgIHRhcmdldC5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gbmVzdGVkRHJhZnRDbGVhbnVwKCkgewogICAgICBjb25zdCB0YXJnZXRDb3B5ID0gbGF0ZXN0KHRhcmdldCk7CiAgICAgIGlmIChnZXQyKHRhcmdldENvcHksIGtleSwgdGFyZ2V0LnR5cGVfKSA9PT0gdmFsdWUpIHsKICAgICAgICBpZiAoc2NvcGVfLmRyYWZ0c18ubGVuZ3RoID4gMSAmJiAodGFyZ2V0LmFzc2lnbmVkXy5nZXQoa2V5KSA/PyBmYWxzZSkgPT09IHRydWUgJiYgdGFyZ2V0LmNvcHlfKSB7CiAgICAgICAgICBoYW5kbGVWYWx1ZSgKICAgICAgICAgICAgZ2V0Mih0YXJnZXQuY29weV8sIGtleSwgdGFyZ2V0LnR5cGVfKSwKICAgICAgICAgICAgc2NvcGVfLmhhbmRsZWRTZXRfLAogICAgICAgICAgICBzY29wZV8KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9Cn0KZnVuY3Rpb24gaGFuZGxlVmFsdWUodGFyZ2V0LCBoYW5kbGVkU2V0LCByb290U2NvcGUpIHsKICBpZiAoIXJvb3RTY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgcm9vdFNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA8IDEpIHsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIGlmIChpc0RyYWZ0KHRhcmdldCkgfHwgaGFuZGxlZFNldC5oYXModGFyZ2V0KSB8fCAhaXNEcmFmdGFibGUodGFyZ2V0KSB8fCBpc0Zyb3plbih0YXJnZXQpKSB7CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KICBoYW5kbGVkU2V0LmFkZCh0YXJnZXQpOwogIGVhY2godGFyZ2V0LCAoa2V5LCB2YWx1ZSkgPT4gewogICAgaWYgKGlzRHJhZnQodmFsdWUpKSB7CiAgICAgIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogICAgICBpZiAoaXNTYW1lU2NvcGUoc3RhdGUsIHJvb3RTY29wZSkpIHsKICAgICAgICBjb25zdCB1cGRhdGVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgICAgICBzZXQodGFyZ2V0LCBrZXksIHVwZGF0ZWRWYWx1ZSwgdGFyZ2V0LnR5cGVfKTsKICAgICAgICBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgICBoYW5kbGVWYWx1ZSh2YWx1ZSwgaGFuZGxlZFNldCwgcm9vdFNjb3BlKTsKICAgIH0KICB9KTsKICByZXR1cm4gdGFyZ2V0Owp9CmZ1bmN0aW9uIGNyZWF0ZVByb3h5UHJveHkoYmFzZSwgcGFyZW50KSB7CiAgY29uc3QgYmFzZUlzQXJyYXkgPSBpc0FycmF5KGJhc2UpOwogIGNvbnN0IHN0YXRlID0gewogICAgdHlwZV86IGJhc2VJc0FycmF5ID8gMSA6IDAsCiAgICAvLyBUcmFjayB3aGljaCBwcm9kdWNlIGNhbGwgdGhpcyBpcyBhc3NvY2lhdGVkIHdpdGguCiAgICBzY29wZV86IHBhcmVudCA/IHBhcmVudC5zY29wZV8gOiBnZXRDdXJyZW50U2NvcGUoKSwKICAgIC8vIFRydWUgZm9yIGJvdGggc2hhbGxvdyBhbmQgZGVlcCBjaGFuZ2VzLgogICAgbW9kaWZpZWRfOiBmYWxzZSwKICAgIC8vIFVzZWQgZHVyaW5nIGZpbmFsaXphdGlvbi4KICAgIGZpbmFsaXplZF86IGZhbHNlLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvcGVydGllcyBoYXZlIGJlZW4gYXNzaWduZWQgKHRydWUpIG9yIGRlbGV0ZWQgKGZhbHNlKS4KICAgIC8vIGFjdHVhbGx5IGluc3RhbnRpYXRlZCBpbiBgcHJlcGFyZUNvcHkoKWAKICAgIGFzc2lnbmVkXzogdm9pZCAwLAogICAgLy8gVGhlIHBhcmVudCBkcmFmdCBzdGF0ZS4KICAgIHBhcmVudF86IHBhcmVudCwKICAgIC8vIFRoZSBiYXNlIHN0YXRlLgogICAgYmFzZV86IGJhc2UsCiAgICAvLyBUaGUgYmFzZSBwcm94eS4KICAgIGRyYWZ0XzogbnVsbCwKICAgIC8vIHNldCBiZWxvdwogICAgLy8gVGhlIGJhc2UgY29weSB3aXRoIGFueSB1cGRhdGVkIHZhbHVlcy4KICAgIGNvcHlfOiBudWxsLAogICAgLy8gQ2FsbGVkIGJ5IHRoZSBgcHJvZHVjZWAgZnVuY3Rpb24uCiAgICByZXZva2VfOiBudWxsLAogICAgaXNNYW51YWxfOiBmYWxzZSwKICAgIC8vIGBjYWxsYmFja3NgIGFjdHVhbGx5IGdldHMgYXNzaWduZWQgaW4gYGNyZWF0ZVByb3h5YAogICAgY2FsbGJhY2tzXzogdm9pZCAwCiAgfTsKICBsZXQgdGFyZ2V0ID0gc3RhdGU7CiAgbGV0IHRyYXBzID0gb2JqZWN0VHJhcHM7CiAgaWYgKGJhc2VJc0FycmF5KSB7CiAgICB0YXJnZXQgPSBbc3RhdGVdOwogICAgdHJhcHMgPSBhcnJheVRyYXBzOwogIH0KICBjb25zdCB7IHJldm9rZSwgcHJveHkgfSA9IFByb3h5LnJldm9jYWJsZSh0YXJnZXQsIHRyYXBzKTsKICBzdGF0ZS5kcmFmdF8gPSBwcm94eTsKICBzdGF0ZS5yZXZva2VfID0gcmV2b2tlOwogIHJldHVybiBbcHJveHksIHN0YXRlXTsKfQp2YXIgb2JqZWN0VHJhcHMgPSB7CiAgZ2V0KHN0YXRlLCBwcm9wKSB7CiAgICBpZiAocHJvcCA9PT0gRFJBRlRfU1RBVEUpCiAgICAgIHJldHVybiBzdGF0ZTsKICAgIGNvbnN0IHNvdXJjZSA9IGxhdGVzdChzdGF0ZSk7CiAgICBpZiAoIWhhcyhzb3VyY2UsIHByb3AsIHN0YXRlLnR5cGVfKSkgewogICAgICByZXR1cm4gcmVhZFByb3BGcm9tUHJvdG8oc3RhdGUsIHNvdXJjZSwgcHJvcCk7CiAgICB9CiAgICBjb25zdCB2YWx1ZSA9IHNvdXJjZVtwcm9wXTsKICAgIGlmIChzdGF0ZS5maW5hbGl6ZWRfIHx8ICFpc0RyYWZ0YWJsZSh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKHZhbHVlID09PSBwZWVrKHN0YXRlLmJhc2VfLCBwcm9wKSkgewogICAgICBwcmVwYXJlQ29weShzdGF0ZSk7CiAgICAgIGNvbnN0IGNoaWxkS2V5ID0gc3RhdGUudHlwZV8gPT09IDEgPyArcHJvcCA6IHByb3A7CiAgICAgIGNvbnN0IGNoaWxkRHJhZnQgPSBjcmVhdGVQcm94eShzdGF0ZS5zY29wZV8sIHZhbHVlLCBzdGF0ZSwgY2hpbGRLZXkpOwogICAgICByZXR1cm4gc3RhdGUuY29weV9bY2hpbGRLZXldID0gY2hpbGREcmFmdDsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9LAogIGhhcyhzdGF0ZSwgcHJvcCkgewogICAgcmV0dXJuIHByb3AgaW4gbGF0ZXN0KHN0YXRlKTsKICB9LAogIG93bktleXMoc3RhdGUpIHsKICAgIHJldHVybiBSZWZsZWN0Lm93bktleXMobGF0ZXN0KHN0YXRlKSk7CiAgfSwKICBzZXQoc3RhdGUsIHByb3AsIHZhbHVlKSB7CiAgICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90byhsYXRlc3Qoc3RhdGUpLCBwcm9wKTsKICAgIGlmIChkZXNjPy5zZXQpIHsKICAgICAgZGVzYy5zZXQuY2FsbChzdGF0ZS5kcmFmdF8sIHZhbHVlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgICBjb25zdCBjdXJyZW50MjIgPSBwZWVrKGxhdGVzdChzdGF0ZSksIHByb3ApOwogICAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBjdXJyZW50MjI/LltEUkFGVF9TVEFURV07CiAgICAgIGlmIChjdXJyZW50U3RhdGUgJiYgY3VycmVudFN0YXRlLmJhc2VfID09PSB2YWx1ZSkgewogICAgICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICAgICAgc3RhdGUuYXNzaWduZWRfLnNldChwcm9wLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzKHZhbHVlLCBjdXJyZW50MjIpICYmICh2YWx1ZSAhPT0gdm9pZCAwIHx8IGhhcyhzdGF0ZS5iYXNlXywgcHJvcCwgc3RhdGUudHlwZV8pKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgcHJlcGFyZUNvcHkoc3RhdGUpOwogICAgICBtYXJrQ2hhbmdlZChzdGF0ZSk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV9bcHJvcF0gPT09IHZhbHVlICYmIC8vIHNwZWNpYWwgY2FzZTogaGFuZGxlIG5ldyBwcm9wcyB3aXRoIHZhbHVlICd1bmRlZmluZWQnCiAgICAodmFsdWUgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmNvcHlfKSB8fCAvLyBzcGVjaWFsIGNhc2U6IE5hTgogICAgTnVtYmVyLmlzTmFOKHZhbHVlKSAmJiBOdW1iZXIuaXNOYU4oc3RhdGUuY29weV9bcHJvcF0pKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIHRydWUpOwogICAgaGFuZGxlQ3Jvc3NSZWZlcmVuY2Uoc3RhdGUsIHByb3AsIHZhbHVlKTsKICAgIHJldHVybiB0cnVlOwogIH0sCiAgZGVsZXRlUHJvcGVydHkoc3RhdGUsIHByb3ApIHsKICAgIHByZXBhcmVDb3B5KHN0YXRlKTsKICAgIGlmIChwZWVrKHN0YXRlLmJhc2VfLCBwcm9wKSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuYmFzZV8pIHsKICAgICAgc3RhdGUuYXNzaWduZWRfLnNldChwcm9wLCBmYWxzZSk7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YXRlLmFzc2lnbmVkXy5kZWxldGUocHJvcCk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV8pIHsKICAgICAgZGVsZXRlIHN0YXRlLmNvcHlfW3Byb3BdOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfSwKICAvLyBOb3RlOiBXZSBuZXZlciBjb2VyY2UgYGRlc2MudmFsdWVgIGludG8gYW4gSW1tZXIgZHJhZnQsIGJlY2F1c2Ugd2UgY2FuJ3QgbWFrZQogIC8vIHRoZSBzYW1lIGd1YXJhbnRlZSBpbiBFUzUgbW9kZS4KICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc3RhdGUsIHByb3ApIHsKICAgIGNvbnN0IG93bmVyID0gbGF0ZXN0KHN0YXRlKTsKICAgIGNvbnN0IGRlc2MgPSBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvd25lciwgcHJvcCk7CiAgICBpZiAoIWRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcmV0dXJuIHsKICAgICAgW1dSSVRBQkxFXTogdHJ1ZSwKICAgICAgW0NPTkZJR1VSQUJMRV06IHN0YXRlLnR5cGVfICE9PSAxIHx8IHByb3AgIT09ICJsZW5ndGgiLAogICAgICBbRU5VTUVSQUJMRV06IGRlc2NbRU5VTUVSQUJMRV0sCiAgICAgIFtWQUxVRV06IG93bmVyW3Byb3BdCiAgICB9OwogIH0sCiAgZGVmaW5lUHJvcGVydHkoKSB7CiAgICBkaWUoMTEpOwogIH0sCiAgZ2V0UHJvdG90eXBlT2Yoc3RhdGUpIHsKICAgIHJldHVybiBnZXRQcm90b3R5cGVPZihzdGF0ZS5iYXNlXyk7CiAgfSwKICBzZXRQcm90b3R5cGVPZigpIHsKICAgIGRpZSgxMik7CiAgfQp9Owp2YXIgYXJyYXlUcmFwcyA9IHt9OwplYWNoKG9iamVjdFRyYXBzLCAoa2V5LCBmbikgPT4gewogIGFycmF5VHJhcHNba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgY29uc3QgYXJncyA9IGFyZ3VtZW50czsKICAgIGFyZ3NbMF0gPSBhcmdzWzBdWzBdOwogICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwogIH07Cn0pOwphcnJheVRyYXBzLmRlbGV0ZVByb3BlcnR5ID0gZnVuY3Rpb24oc3RhdGUsIHByb3ApIHsKICBpZiAoaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllKDEzKTsKICByZXR1cm4gYXJyYXlUcmFwcy5zZXQuY2FsbCh0aGlzLCBzdGF0ZSwgcHJvcCwgdm9pZCAwKTsKfTsKYXJyYXlUcmFwcy5zZXQgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICBpZiAocHJvcCAhPT0gImxlbmd0aCIgJiYgaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllKDE0KTsKICByZXR1cm4gb2JqZWN0VHJhcHMuc2V0LmNhbGwodGhpcywgc3RhdGVbMF0sIHByb3AsIHZhbHVlLCBzdGF0ZVswXSk7Cn07CmZ1bmN0aW9uIHBlZWsoZHJhZnQsIHByb3ApIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFXTsKICBjb25zdCBzb3VyY2UgPSBzdGF0ZSA/IGxhdGVzdChzdGF0ZSkgOiBkcmFmdDsKICByZXR1cm4gc291cmNlW3Byb3BdOwp9CmZ1bmN0aW9uIHJlYWRQcm9wRnJvbVByb3RvKHN0YXRlLCBzb3VyY2UsIHByb3ApIHsKICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90byhzb3VyY2UsIHByb3ApOwogIHJldHVybiBkZXNjID8gVkFMVUUgaW4gZGVzYyA/IGRlc2NbVkFMVUVdIDogKAogICAgLy8gVGhpcyBpcyBhIHZlcnkgc3BlY2lhbCBjYXNlLCBpZiB0aGUgcHJvcCBpcyBhIGdldHRlciBkZWZpbmVkIGJ5IHRoZQogICAgLy8gcHJvdG90eXBlLCB3ZSBzaG91bGQgaW52b2tlIGl0IHdpdGggdGhlIGRyYWZ0IGFzIGNvbnRleHQhCiAgICBkZXNjLmdldD8uY2FsbChzdGF0ZS5kcmFmdF8pCiAgKSA6IHZvaWQgMDsKfQpmdW5jdGlvbiBnZXREZXNjcmlwdG9yRnJvbVByb3RvKHNvdXJjZSwgcHJvcCkgewogIGlmICghKHByb3AgaW4gc291cmNlKSkKICAgIHJldHVybiB2b2lkIDA7CiAgbGV0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mKHNvdXJjZSk7CiAgd2hpbGUgKHByb3RvMikgewogICAgY29uc3QgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdG8yLCBwcm9wKTsKICAgIGlmIChkZXNjKQogICAgICByZXR1cm4gZGVzYzsKICAgIHByb3RvMiA9IGdldFByb3RvdHlwZU9mKHByb3RvMik7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFya0NoYW5nZWQoc3RhdGUpIHsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgc3RhdGUubW9kaWZpZWRfID0gdHJ1ZTsKICAgIGlmIChzdGF0ZS5wYXJlbnRfKSB7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlLnBhcmVudF8pOwogICAgfQogIH0KfQpmdW5jdGlvbiBwcmVwYXJlQ29weShzdGF0ZSkgewogIGlmICghc3RhdGUuY29weV8pIHsKICAgIHN0YXRlLmFzc2lnbmVkXyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBzdGF0ZS5jb3B5XyA9IHNoYWxsb3dDb3B5KAogICAgICBzdGF0ZS5iYXNlXywKICAgICAgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8KICAgICk7CiAgfQp9CnZhciBJbW1lcjIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29uZmlnKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdHJ1ZTsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gZmFsc2U7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSBmYWxzZTsKICAgIHRoaXMucHJvZHVjZSA9IChiYXNlLCByZWNpcGUsIHBhdGNoTGlzdGVuZXIpID0+IHsKICAgICAgaWYgKGlzRnVuY3Rpb24oYmFzZSkgJiYgIWlzRnVuY3Rpb24ocmVjaXBlKSkgewogICAgICAgIGNvbnN0IGRlZmF1bHRCYXNlID0gcmVjaXBlOwogICAgICAgIHJlY2lwZSA9IGJhc2U7CiAgICAgICAgY29uc3Qgc2VsZjIgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBjdXJyaWVkUHJvZHVjZShiYXNlMiA9IGRlZmF1bHRCYXNlLCAuLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gc2VsZjIucHJvZHVjZShiYXNlMiwgKGRyYWZ0KSA9PiByZWNpcGUuY2FsbCh0aGlzLCBkcmFmdCwgLi4uYXJncykpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKCFpc0Z1bmN0aW9uKHJlY2lwZSkpCiAgICAgICAgZGllKDYpOwogICAgICBpZiAocGF0Y2hMaXN0ZW5lciAhPT0gdm9pZCAwICYmICFpc0Z1bmN0aW9uKHBhdGNoTGlzdGVuZXIpKQogICAgICAgIGRpZSg3KTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgaWYgKGlzRHJhZnRhYmxlKGJhc2UpKSB7CiAgICAgICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlKHRoaXMpOwogICAgICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkoc2NvcGUsIGJhc2UsIHZvaWQgMCk7CiAgICAgICAgbGV0IGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzdWx0ID0gcmVjaXBlKHByb3h5KTsKICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChoYXNFcnJvcikKICAgICAgICAgICAgcmV2b2tlU2NvcGUoc2NvcGUpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICBsZWF2ZVNjb3BlKHNjb3BlKTsKICAgICAgICB9CiAgICAgICAgdXNlUGF0Y2hlc0luU2NvcGUoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgICAgIHJldHVybiBwcm9jZXNzUmVzdWx0KHJlc3VsdCwgc2NvcGUpOwogICAgICB9IGVsc2UgaWYgKCFiYXNlIHx8ICFpc09iamVjdGlzaChiYXNlKSkgewogICAgICAgIHJlc3VsdCA9IHJlY2lwZShiYXNlKTsKICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApCiAgICAgICAgICByZXN1bHQgPSBiYXNlOwogICAgICAgIGlmIChyZXN1bHQgPT09IE5PVEhJTkcpCiAgICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgaWYgKHRoaXMuYXV0b0ZyZWV6ZV8pCiAgICAgICAgICBmcmVlemUocmVzdWx0LCB0cnVlKTsKICAgICAgICBpZiAocGF0Y2hMaXN0ZW5lcikgewogICAgICAgICAgY29uc3QgcCA9IFtdOwogICAgICAgICAgY29uc3QgaXAgPSBbXTsKICAgICAgICAgIGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKS5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oYmFzZSwgcmVzdWx0LCB7CiAgICAgICAgICAgIHBhdGNoZXNfOiBwLAogICAgICAgICAgICBpbnZlcnNlUGF0Y2hlc186IGlwCiAgICAgICAgICB9KTsKICAgICAgICAgIHBhdGNoTGlzdGVuZXIocCwgaXApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9IGVsc2UKICAgICAgICBkaWUoMSwgYmFzZSk7CiAgICB9OwogICAgdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMgPSAoYmFzZSwgcmVjaXBlKSA9PiB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKGJhc2UpKSB7CiAgICAgICAgcmV0dXJuIChzdGF0ZSwgLi4uYXJncykgPT4gdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMoc3RhdGUsIChkcmFmdCkgPT4gYmFzZShkcmFmdCwgLi4uYXJncykpOwogICAgICB9CiAgICAgIGxldCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlczsKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wcm9kdWNlKGJhc2UsIHJlY2lwZSwgKHAsIGlwKSA9PiB7CiAgICAgICAgcGF0Y2hlcyA9IHA7CiAgICAgICAgaW52ZXJzZVBhdGNoZXMgPSBpcDsKICAgICAgfSk7CiAgICAgIHJldHVybiBbcmVzdWx0LCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlc107CiAgICB9OwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LmF1dG9GcmVlemUpKQogICAgICB0aGlzLnNldEF1dG9GcmVlemUoY29uZmlnLmF1dG9GcmVlemUpOwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LnVzZVN0cmljdFNoYWxsb3dDb3B5KSkKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RTaGFsbG93Q29weShjb25maWcudXNlU3RyaWN0U2hhbGxvd0NvcHkpOwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LnVzZVN0cmljdEl0ZXJhdGlvbikpCiAgICAgIHRoaXMuc2V0VXNlU3RyaWN0SXRlcmF0aW9uKGNvbmZpZy51c2VTdHJpY3RJdGVyYXRpb24pOwogIH0KICBjcmVhdGVEcmFmdChiYXNlKSB7CiAgICBpZiAoIWlzRHJhZnRhYmxlKGJhc2UpKQogICAgICBkaWUoOCk7CiAgICBpZiAoaXNEcmFmdChiYXNlKSkKICAgICAgYmFzZSA9IGN1cnJlbnQoYmFzZSk7CiAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUodGhpcyk7CiAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5KHNjb3BlLCBiYXNlLCB2b2lkIDApOwogICAgcHJveHlbRFJBRlRfU1RBVEVdLmlzTWFudWFsXyA9IHRydWU7CiAgICBsZWF2ZVNjb3BlKHNjb3BlKTsKICAgIHJldHVybiBwcm94eTsKICB9CiAgZmluaXNoRHJhZnQoZHJhZnQsIHBhdGNoTGlzdGVuZXIpIHsKICAgIGNvbnN0IHN0YXRlID0gZHJhZnQgJiYgZHJhZnRbRFJBRlRfU1RBVEVdOwogICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuaXNNYW51YWxfKQogICAgICBkaWUoOSk7CiAgICBjb25zdCB7IHNjb3BlXzogc2NvcGUgfSA9IHN0YXRlOwogICAgdXNlUGF0Y2hlc0luU2NvcGUoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQodm9pZCAwLCBzY29wZSk7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBhdXRvbWF0aWNhbGx5IGZyZWV6ZSBhbGwgY29waWVzIGNyZWF0ZWQgYnkgSW1tZXIuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBhdXRvLWZyZWV6aW5nIGlzIGVuYWJsZWQuCiAgICovCiAgc2V0QXV0b0ZyZWV6ZSh2YWx1ZSkgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gZW5hYmxlIHN0cmljdCBzaGFsbG93IGNvcHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBpbW1lciBkb2VzIG5vdCBjb3B5IHRoZSBvYmplY3QgZGVzY3JpcHRvcnMgc3VjaCBhcyBnZXR0ZXIsIHNldHRlciBhbmQgbm9uLWVudW1yYWJsZSBwcm9wZXJ0aWVzLgogICAqLwogIHNldFVzZVN0cmljdFNoYWxsb3dDb3B5KHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIGZhbHNlIHRvIHVzZSBmYXN0ZXIgaXRlcmF0aW9uIHRoYXQgc2tpcHMgbm9uLWVudW1lcmFibGUgcHJvcGVydGllcwogICAqIGJ1dCBzdGlsbCBoYW5kbGVzIHN5bWJvbHMgZm9yIGNvbXBhdGliaWxpdHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBzdHJpY3QgaXRlcmF0aW9uIGlzIGVuYWJsZWQgKGluY2x1ZGVzIGFsbCBvd24gcHJvcGVydGllcykuCiAgICovCiAgc2V0VXNlU3RyaWN0SXRlcmF0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB2YWx1ZTsKICB9CiAgc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCkgewogICAgcmV0dXJuIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXzsKICB9CiAgYXBwbHlQYXRjaGVzKGJhc2UsIHBhdGNoZXMpIHsKICAgIGxldCBpOwogICAgZm9yIChpID0gcGF0Y2hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwYXRjaCA9IHBhdGNoZXNbaV07CiAgICAgIGlmIChwYXRjaC5wYXRoLmxlbmd0aCA9PT0gMCAmJiBwYXRjaC5vcCA9PT0gInJlcGxhY2UiKSB7CiAgICAgICAgYmFzZSA9IHBhdGNoLnZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoaSA+IC0xKSB7CiAgICAgIHBhdGNoZXMgPSBwYXRjaGVzLnNsaWNlKGkgKyAxKTsKICAgIH0KICAgIGNvbnN0IGFwcGx5UGF0Y2hlc0ltcGwgPSBnZXRQbHVnaW4oUGx1Z2luUGF0Y2hlcykuYXBwbHlQYXRjaGVzXzsKICAgIGlmIChpc0RyYWZ0KGJhc2UpKSB7CiAgICAgIHJldHVybiBhcHBseVBhdGNoZXNJbXBsKGJhc2UsIHBhdGNoZXMpOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvZHVjZSgKICAgICAgYmFzZSwKICAgICAgKGRyYWZ0KSA9PiBhcHBseVBhdGNoZXNJbXBsKGRyYWZ0LCBwYXRjaGVzKQogICAgKTsKICB9Cn07CmZ1bmN0aW9uIGNyZWF0ZVByb3h5KHJvb3RTY29wZSwgdmFsdWUsIHBhcmVudCwga2V5KSB7CiAgY29uc3QgW2RyYWZ0LCBzdGF0ZV0gPSBpc01hcCh2YWx1ZSkgPyBnZXRQbHVnaW4oUGx1Z2luTWFwU2V0KS5wcm94eU1hcF8odmFsdWUsIHBhcmVudCkgOiBpc1NldCh2YWx1ZSkgPyBnZXRQbHVnaW4oUGx1Z2luTWFwU2V0KS5wcm94eVNldF8odmFsdWUsIHBhcmVudCkgOiBjcmVhdGVQcm94eVByb3h5KHZhbHVlLCBwYXJlbnQpOwogIGNvbnN0IHNjb3BlID0gcGFyZW50Py5zY29wZV8gPz8gZ2V0Q3VycmVudFNjb3BlKCk7CiAgc2NvcGUuZHJhZnRzXy5wdXNoKGRyYWZ0KTsKICBzdGF0ZS5jYWxsYmFja3NfID0gcGFyZW50Py5jYWxsYmFja3NfID8/IFtdOwogIHN0YXRlLmtleV8gPSBrZXk7CiAgaWYgKHBhcmVudCAmJiBrZXkgIT09IHZvaWQgMCkgewogICAgcmVnaXN0ZXJDaGlsZEZpbmFsaXphdGlvbkNhbGxiYWNrKHBhcmVudCwgc3RhdGUsIGtleSk7CiAgfSBlbHNlIHsKICAgIHN0YXRlLmNhbGxiYWNrc18ucHVzaChmdW5jdGlvbiByb290RHJhZnRDbGVhbnVwKHJvb3RTY29wZTIpIHsKICAgICAgcm9vdFNjb3BlMi5tYXBTZXRQbHVnaW5fPy5maXhTZXRDb250ZW50cyhzdGF0ZSk7CiAgICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSByb290U2NvcGUyOwogICAgICBpZiAoc3RhdGUubW9kaWZpZWRfICYmIHBhdGNoUGx1Z2luXykgewogICAgICAgIHBhdGNoUGx1Z2luXy5nZW5lcmF0ZVBhdGNoZXNfKHN0YXRlLCBbXSwgcm9vdFNjb3BlMik7CiAgICAgIH0KICAgIH0pOwogIH0KICByZXR1cm4gZHJhZnQ7Cn0KZnVuY3Rpb24gY3VycmVudCh2YWx1ZSkgewogIGlmICghaXNEcmFmdCh2YWx1ZSkpCiAgICBkaWUoMTAsIHZhbHVlKTsKICByZXR1cm4gY3VycmVudEltcGwodmFsdWUpOwp9CmZ1bmN0aW9uIGN1cnJlbnRJbXBsKHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0YWJsZSh2YWx1ZSkgfHwgaXNGcm96ZW4odmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogIGxldCBjb3B5MzsKICBsZXQgc3RyaWN0ID0gdHJ1ZTsKICBpZiAoc3RhdGUpIHsKICAgIGlmICghc3RhdGUubW9kaWZpZWRfKQogICAgICByZXR1cm4gc3RhdGUuYmFzZV87CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkodmFsdWUsIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfKTsKICAgIHN0cmljdCA9IHN0YXRlLnNjb3BlXy5pbW1lcl8uc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCk7CiAgfSBlbHNlIHsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkodmFsdWUsIHRydWUpOwogIH0KICBlYWNoKAogICAgY29weTMsCiAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiB7CiAgICAgIHNldChjb3B5Mywga2V5LCBjdXJyZW50SW1wbChjaGlsZFZhbHVlKSk7CiAgICB9LAogICAgc3RyaWN0CiAgKTsKICBpZiAoc3RhdGUpIHsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSBmYWxzZTsKICB9CiAgcmV0dXJuIGNvcHkzOwp9CnZhciBpbW1lciA9IG5ldyBJbW1lcjIoKTsKdmFyIHByb2R1Y2UgPSBpbW1lci5wcm9kdWNlOwoKLy8gbm9kZV9tb2R1bGVzL3JlZHV4LXRodW5rL2Rpc3QvcmVkdXgtdGh1bmsubWpzCmZ1bmN0aW9uIGNyZWF0ZVRodW5rTWlkZGxld2FyZShleHRyYUFyZ3VtZW50KSB7CiAgY29uc3QgbWlkZGxld2FyZSA9ICh7IGRpc3BhdGNoLCBnZXRTdGF0ZSB9KSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIGFjdGlvbihkaXNwYXRjaCwgZ2V0U3RhdGUsIGV4dHJhQXJndW1lbnQpOwogICAgfQogICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICB9OwogIHJldHVybiBtaWRkbGV3YXJlOwp9CnZhciB0aHVuayA9IGNyZWF0ZVRodW5rTWlkZGxld2FyZSgpOwp2YXIgd2l0aEV4dHJhQXJndW1lbnQgPSBjcmVhdGVUaHVua01pZGRsZXdhcmU7CgovLyBub2RlX21vZHVsZXMvQHJlZHV4anMvdG9vbGtpdC9kaXN0L3JlZHV4LXRvb2xraXQubW9kZXJuLm1qcwp2YXIgY29tcG9zZVdpdGhEZXZUb29scyA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9DT01QT1NFX18gPyB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fQ09NUE9TRV9fIDogZnVuY3Rpb24oKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHJldHVybiB2b2lkIDA7CiAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICJvYmplY3QiKSByZXR1cm4gY29tcG9zZTsKICByZXR1cm4gY29tcG9zZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9Owp2YXIgZGV2VG9vbHNFbmhhbmNlciA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9fID8gd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX18gOiBmdW5jdGlvbigpIHsKICByZXR1cm4gZnVuY3Rpb24obm9vcDMyKSB7CiAgICByZXR1cm4gbm9vcDMyOwogIH07Cn07CnZhciBoYXNNYXRjaEZ1bmN0aW9uID0gKHYpID0+IHsKICByZXR1cm4gdiAmJiB0eXBlb2Ygdi5tYXRjaCA9PT0gImZ1bmN0aW9uIjsKfTsKZnVuY3Rpb24gY3JlYXRlQWN0aW9uKHR5cGUsIHByZXBhcmVBY3Rpb24pIHsKICBmdW5jdGlvbiBhY3Rpb25DcmVhdG9yKC4uLmFyZ3MpIHsKICAgIGlmIChwcmVwYXJlQWN0aW9uKSB7CiAgICAgIGxldCBwcmVwYXJlZCA9IHByZXBhcmVBY3Rpb24oLi4uYXJncyk7CiAgICAgIGlmICghcHJlcGFyZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDApIDogInByZXBhcmVBY3Rpb24gZGlkIG5vdCByZXR1cm4gYW4gb2JqZWN0Iik7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB0eXBlLAogICAgICAgIHBheWxvYWQ6IHByZXBhcmVkLnBheWxvYWQsCiAgICAgICAgLi4uIm1ldGEiIGluIHByZXBhcmVkICYmIHsKICAgICAgICAgIG1ldGE6IHByZXBhcmVkLm1ldGEKICAgICAgICB9LAogICAgICAgIC4uLiJlcnJvciIgaW4gcHJlcGFyZWQgJiYgewogICAgICAgICAgZXJyb3I6IHByZXBhcmVkLmVycm9yCiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgcmV0dXJuIHsKICAgICAgdHlwZSwKICAgICAgcGF5bG9hZDogYXJnc1swXQogICAgfTsKICB9CiAgYWN0aW9uQ3JlYXRvci50b1N0cmluZyA9ICgpID0+IGAke3R5cGV9YDsKICBhY3Rpb25DcmVhdG9yLnR5cGUgPSB0eXBlOwogIGFjdGlvbkNyZWF0b3IubWF0Y2ggPSAoYWN0aW9uKSA9PiBpc0FjdGlvbihhY3Rpb24pICYmIGFjdGlvbi50eXBlID09PSB0eXBlOwogIHJldHVybiBhY3Rpb25DcmVhdG9yOwp9CmZ1bmN0aW9uIGlzQWN0aW9uQ3JlYXRvcihhY3Rpb24pIHsKICByZXR1cm4gdHlwZW9mIGFjdGlvbiA9PT0gImZ1bmN0aW9uIiAmJiAidHlwZSIgaW4gYWN0aW9uICYmIC8vIGhhc01hdGNoRnVuY3Rpb24gb25seSB3YW50cyBNYXRjaGVycyBidXQgSSBkb24ndCBzZWUgdGhlIHBvaW50IGluIHJld3JpdGluZyBpdAogIGhhc01hdGNoRnVuY3Rpb24oYWN0aW9uKTsKfQpmdW5jdGlvbiBnZXRNZXNzYWdlKHR5cGUpIHsKICBjb25zdCBzcGxpdFR5cGUgPSB0eXBlID8gYCR7dHlwZX1gLnNwbGl0KCIvIikgOiBbXTsKICBjb25zdCBhY3Rpb25OYW1lID0gc3BsaXRUeXBlW3NwbGl0VHlwZS5sZW5ndGggLSAxXSB8fCAiYWN0aW9uQ3JlYXRvciI7CiAgcmV0dXJuIGBEZXRlY3RlZCBhbiBhY3Rpb24gY3JlYXRvciB3aXRoIHR5cGUgIiR7dHlwZSB8fCAidW5rbm93biJ9IiBiZWluZyBkaXNwYXRjaGVkLiAKTWFrZSBzdXJlIHlvdSdyZSBjYWxsaW5nIHRoZSBhY3Rpb24gY3JlYXRvciBiZWZvcmUgZGlzcGF0Y2hpbmcsIGkuZS4gXGBkaXNwYXRjaCgke2FjdGlvbk5hbWV9KCkpXGAgaW5zdGVhZCBvZiBcYGRpc3BhdGNoKCR7YWN0aW9uTmFtZX0pXGAuIFRoaXMgaXMgbmVjZXNzYXJ5IGV2ZW4gaWYgdGhlIGFjdGlvbiBoYXMgbm8gcGF5bG9hZC5gOwp9CmZ1bmN0aW9uIGNyZWF0ZUFjdGlvbkNyZWF0b3JJbnZhcmlhbnRNaWRkbGV3YXJlKG9wdGlvbnMgPSB7fSkgewogIGlmIChmYWxzZSkgewogICAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiBuZXh0KGFjdGlvbik7CiAgfQogIGNvbnN0IHsKICAgIGlzQWN0aW9uQ3JlYXRvcjogaXNBY3Rpb25DcmVhdG9yMiA9IGlzQWN0aW9uQ3JlYXRvcgogIH0gPSBvcHRpb25zOwogIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgaWYgKGlzQWN0aW9uQ3JlYXRvcjIoYWN0aW9uKSkgewogICAgICBjb25zb2xlLndhcm4oZ2V0TWVzc2FnZShhY3Rpb24udHlwZSkpOwogICAgfQogICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICB9Owp9CmZ1bmN0aW9uIGdldFRpbWVNZWFzdXJlVXRpbHMobWF4RGVsYXksIGZuTmFtZSkgewogIGxldCBlbGFwc2VkID0gMDsKICByZXR1cm4gewogICAgbWVhc3VyZVRpbWUoZm4pIHsKICAgICAgY29uc3Qgc3RhcnRlZCA9IERhdGUubm93KCk7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgY29uc3QgZmluaXNoZWQgPSBEYXRlLm5vdygpOwogICAgICAgIGVsYXBzZWQgKz0gZmluaXNoZWQgLSBzdGFydGVkOwogICAgICB9CiAgICB9LAogICAgd2FybklmRXhjZWVkZWQoKSB7CiAgICAgIGlmIChlbGFwc2VkID4gbWF4RGVsYXkpIHsKICAgICAgICBjb25zb2xlLndhcm4oYCR7Zm5OYW1lfSB0b29rICR7ZWxhcHNlZH1tcywgd2hpY2ggaXMgbW9yZSB0aGFuIHRoZSB3YXJuaW5nIHRocmVzaG9sZCBvZiAke21heERlbGF5fW1zLiAKSWYgeW91ciBzdGF0ZSBvciBhY3Rpb25zIGFyZSB2ZXJ5IGxhcmdlLCB5b3UgbWF5IHdhbnQgdG8gZGlzYWJsZSB0aGUgbWlkZGxld2FyZSBhcyBpdCBtaWdodCBjYXVzZSB0b28gbXVjaCBvZiBhIHNsb3dkb3duIGluIGRldmVsb3BtZW50IG1vZGUuIFNlZSBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL2FwaS9nZXREZWZhdWx0TWlkZGxld2FyZSBmb3IgaW5zdHJ1Y3Rpb25zLgpJdCBpcyBkaXNhYmxlZCBpbiBwcm9kdWN0aW9uIGJ1aWxkcywgc28geW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgdGhhdC5gKTsKICAgICAgfQogICAgfQogIH07Cn0KdmFyIFR1cGxlID0gY2xhc3MgX1R1cGxlIGV4dGVuZHMgQXJyYXkgewogIGNvbnN0cnVjdG9yKC4uLml0ZW1zKSB7CiAgICBzdXBlciguLi5pdGVtcyk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YodGhpcywgX1R1cGxlLnByb3RvdHlwZSk7CiAgfQogIHN0YXRpYyBnZXQgW1N5bWJvbC5zcGVjaWVzXSgpIHsKICAgIHJldHVybiBfVHVwbGU7CiAgfQogIGNvbmNhdCguLi5hcnIpIHsKICAgIHJldHVybiBzdXBlci5jb25jYXQuYXBwbHkodGhpcywgYXJyKTsKICB9CiAgcHJlcGVuZCguLi5hcnIpIHsKICAgIGlmIChhcnIubGVuZ3RoID09PSAxICYmIEFycmF5LmlzQXJyYXkoYXJyWzBdKSkgewogICAgICByZXR1cm4gbmV3IF9UdXBsZSguLi5hcnJbMF0uY29uY2F0KHRoaXMpKTsKICAgIH0KICAgIHJldHVybiBuZXcgX1R1cGxlKC4uLmFyci5jb25jYXQodGhpcykpOwogIH0KfTsKZnVuY3Rpb24gZnJlZXplRHJhZnRhYmxlKHZhbCkgewogIHJldHVybiBpc0RyYWZ0YWJsZSh2YWwpID8gcHJvZHVjZSh2YWwsICgpID0+IHsKICB9KSA6IHZhbDsKfQpmdW5jdGlvbiBnZXRPckluc2VydENvbXB1dGVkKG1hcDMsIGtleSwgY29tcHV0ZSkgewogIGlmIChtYXAzLmhhcyhrZXkpKSByZXR1cm4gbWFwMy5nZXQoa2V5KTsKICByZXR1cm4gbWFwMy5zZXQoa2V5LCBjb21wdXRlKGtleSkpLmdldChrZXkpOwp9CmZ1bmN0aW9uIGlzSW1tdXRhYmxlRGVmYXVsdCh2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiIHx8IHZhbHVlID09IG51bGwgfHwgT2JqZWN0LmlzRnJvemVuKHZhbHVlKTsKfQpmdW5jdGlvbiB0cmFja0Zvck11dGF0aW9ucyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCBvYmopIHsKICBjb25zdCB0cmFja2VkUHJvcGVydGllcyA9IHRyYWNrUHJvcGVydGllcyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCBvYmopOwogIHJldHVybiB7CiAgICBkZXRlY3RNdXRhdGlvbnMoKSB7CiAgICAgIHJldHVybiBkZXRlY3RNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgdHJhY2tlZFByb3BlcnRpZXMsIG9iaik7CiAgICB9CiAgfTsKfQpmdW5jdGlvbiB0cmFja1Byb3BlcnRpZXMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocyA9IFtdLCBvYmosIHBhdGgyID0gIiIsIGNoZWNrZWRPYmplY3RzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSkgewogIGNvbnN0IHRyYWNrZWQgPSB7CiAgICB2YWx1ZTogb2JqCiAgfTsKICBpZiAoIWlzSW1tdXRhYmxlKG9iaikgJiYgIWNoZWNrZWRPYmplY3RzLmhhcyhvYmopKSB7CiAgICBjaGVja2VkT2JqZWN0cy5hZGQob2JqKTsKICAgIHRyYWNrZWQuY2hpbGRyZW4gPSB7fTsKICAgIGNvbnN0IGhhc0lnbm9yZWRQYXRocyA9IGlnbm9yZWRQYXRocy5sZW5ndGggPiAwOwogICAgZm9yIChjb25zdCBrZXkgaW4gb2JqKSB7CiAgICAgIGNvbnN0IG5lc3RlZFBhdGggPSBwYXRoMiA/IHBhdGgyICsgIi4iICsga2V5IDoga2V5OwogICAgICBpZiAoaGFzSWdub3JlZFBhdGhzKSB7CiAgICAgICAgY29uc3QgaGFzTWF0Y2hlcyA9IGlnbm9yZWRQYXRocy5zb21lKChpZ25vcmVkKSA9PiB7CiAgICAgICAgICBpZiAoaWdub3JlZCBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgICByZXR1cm4gaWdub3JlZC50ZXN0KG5lc3RlZFBhdGgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5lc3RlZFBhdGggPT09IGlnbm9yZWQ7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKGhhc01hdGNoZXMpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgfQogICAgICB0cmFja2VkLmNoaWxkcmVuW2tleV0gPSB0cmFja1Byb3BlcnRpZXMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgb2JqW2tleV0sIG5lc3RlZFBhdGgpOwogICAgfQogIH0KICByZXR1cm4gdHJhY2tlZDsKfQpmdW5jdGlvbiBkZXRlY3RNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocyA9IFtdLCB0cmFja2VkUHJvcGVydHksIG9iaiwgc2FtZVBhcmVudFJlZiA9IGZhbHNlLCBwYXRoMiA9ICIiKSB7CiAgY29uc3QgcHJldk9iaiA9IHRyYWNrZWRQcm9wZXJ0eSA/IHRyYWNrZWRQcm9wZXJ0eS52YWx1ZSA6IHZvaWQgMDsKICBjb25zdCBzYW1lUmVmID0gcHJldk9iaiA9PT0gb2JqOwogIGlmIChzYW1lUGFyZW50UmVmICYmICFzYW1lUmVmICYmICFOdW1iZXIuaXNOYU4ob2JqKSkgewogICAgcmV0dXJuIHsKICAgICAgd2FzTXV0YXRlZDogdHJ1ZSwKICAgICAgcGF0aDogcGF0aDIKICAgIH07CiAgfQogIGlmIChpc0ltbXV0YWJsZShwcmV2T2JqKSB8fCBpc0ltbXV0YWJsZShvYmopKSB7CiAgICByZXR1cm4gewogICAgICB3YXNNdXRhdGVkOiBmYWxzZQogICAgfTsKICB9CiAgY29uc3Qga2V5c1RvRGV0ZWN0ID0ge307CiAgZm9yIChsZXQga2V5IGluIHRyYWNrZWRQcm9wZXJ0eS5jaGlsZHJlbikgewogICAga2V5c1RvRGV0ZWN0W2tleV0gPSB0cnVlOwogIH0KICBmb3IgKGxldCBrZXkgaW4gb2JqKSB7CiAgICBrZXlzVG9EZXRlY3Rba2V5XSA9IHRydWU7CiAgfQogIGNvbnN0IGhhc0lnbm9yZWRQYXRocyA9IGlnbm9yZWRQYXRocy5sZW5ndGggPiAwOwogIGZvciAobGV0IGtleSBpbiBrZXlzVG9EZXRlY3QpIHsKICAgIGNvbnN0IG5lc3RlZFBhdGggPSBwYXRoMiA/IHBhdGgyICsgIi4iICsga2V5IDoga2V5OwogICAgaWYgKGhhc0lnbm9yZWRQYXRocykgewogICAgICBjb25zdCBoYXNNYXRjaGVzID0gaWdub3JlZFBhdGhzLnNvbWUoKGlnbm9yZWQpID0+IHsKICAgICAgICBpZiAoaWdub3JlZCBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgcmV0dXJuIGlnbm9yZWQudGVzdChuZXN0ZWRQYXRoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5lc3RlZFBhdGggPT09IGlnbm9yZWQ7CiAgICAgIH0pOwogICAgICBpZiAoaGFzTWF0Y2hlcykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSBkZXRlY3RNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgdHJhY2tlZFByb3BlcnR5LmNoaWxkcmVuW2tleV0sIG9ialtrZXldLCBzYW1lUmVmLCBuZXN0ZWRQYXRoKTsKICAgIGlmIChyZXN1bHQud2FzTXV0YXRlZCkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0KICByZXR1cm4gewogICAgd2FzTXV0YXRlZDogZmFsc2UKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZUltbXV0YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZShvcHRpb25zID0ge30pIHsKICBpZiAoZmFsc2UpIHsKICAgIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gbmV4dChhY3Rpb24pOwogIH0gZWxzZSB7CiAgICBsZXQgc3RyaW5naWZ5MiA9IGZ1bmN0aW9uKG9iaiwgc2VyaWFsaXplciwgaW5kZW50LCBkZWN5Y2xlcikgewogICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqLCBnZXRTZXJpYWxpemUyKHNlcmlhbGl6ZXIsIGRlY3ljbGVyKSwgaW5kZW50KTsKICAgIH0sIGdldFNlcmlhbGl6ZTIgPSBmdW5jdGlvbihzZXJpYWxpemVyLCBkZWN5Y2xlcikgewogICAgICBsZXQgc3RhY2sgPSBbXSwga2V5cyA9IFtdOwogICAgICBpZiAoIWRlY3ljbGVyKSBkZWN5Y2xlciA9IGZ1bmN0aW9uKF8sIHZhbHVlKSB7CiAgICAgICAgaWYgKHN0YWNrWzBdID09PSB2YWx1ZSkgcmV0dXJuICJbQ2lyY3VsYXIgfl0iOwogICAgICAgIHJldHVybiAiW0NpcmN1bGFyIH4uIiArIGtleXMuc2xpY2UoMCwgc3RhY2suaW5kZXhPZih2YWx1ZSkpLmpvaW4oIi4iKSArICJdIjsKICAgICAgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoc3RhY2subGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIHRoaXNQb3MgPSBzdGFjay5pbmRleE9mKHRoaXMpOwogICAgICAgICAgfnRoaXNQb3MgPyBzdGFjay5zcGxpY2UodGhpc1BvcyArIDEpIDogc3RhY2sucHVzaCh0aGlzKTsKICAgICAgICAgIH50aGlzUG9zID8ga2V5cy5zcGxpY2UodGhpc1BvcywgSW5maW5pdHksIGtleSkgOiBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgIGlmICh+c3RhY2suaW5kZXhPZih2YWx1ZSkpIHZhbHVlID0gZGVjeWNsZXIuY2FsbCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgICB9IGVsc2Ugc3RhY2sucHVzaCh2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZXIgPT0gbnVsbCA/IHZhbHVlIDogc2VyaWFsaXplci5jYWxsKHRoaXMsIGtleSwgdmFsdWUpOwogICAgICB9OwogICAgfTsKICAgIHZhciBzdHJpbmdpZnkgPSBzdHJpbmdpZnkyLCBnZXRTZXJpYWxpemUgPSBnZXRTZXJpYWxpemUyOwogICAgbGV0IHsKICAgICAgaXNJbW11dGFibGUgPSBpc0ltbXV0YWJsZURlZmF1bHQsCiAgICAgIGlnbm9yZWRQYXRocywKICAgICAgd2FybkFmdGVyID0gMzIKICAgIH0gPSBvcHRpb25zOwogICAgY29uc3QgdHJhY2sgPSB0cmFja0Zvck11dGF0aW9ucy5iaW5kKG51bGwsIGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMpOwogICAgcmV0dXJuICh7CiAgICAgIGdldFN0YXRlCiAgICB9KSA9PiB7CiAgICAgIGxldCBzdGF0ZSA9IGdldFN0YXRlKCk7CiAgICAgIGxldCB0cmFja2VyID0gdHJhY2soc3RhdGUpOwogICAgICBsZXQgcmVzdWx0OwogICAgICByZXR1cm4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgICAgICBjb25zdCBtZWFzdXJlVXRpbHMgPSBnZXRUaW1lTWVhc3VyZVV0aWxzKHdhcm5BZnRlciwgIkltbXV0YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZSIpOwogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBzdGF0ZSA9IGdldFN0YXRlKCk7CiAgICAgICAgICByZXN1bHQgPSB0cmFja2VyLmRldGVjdE11dGF0aW9ucygpOwogICAgICAgICAgdHJhY2tlciA9IHRyYWNrKHN0YXRlKTsKICAgICAgICAgIGlmIChyZXN1bHQud2FzTXV0YXRlZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE5KSA6IGBBIHN0YXRlIG11dGF0aW9uIHdhcyBkZXRlY3RlZCBiZXR3ZWVuIGRpc3BhdGNoZXMsIGluIHRoZSBwYXRoICcke3Jlc3VsdC5wYXRoIHx8ICIifScuICBUaGlzIG1heSBjYXVzZSBpbmNvcnJlY3QgYmVoYXZpb3IuIChodHRwczovL3JlZHV4LmpzLm9yZy9zdHlsZS1ndWlkZS9zdHlsZS1ndWlkZSNkby1ub3QtbXV0YXRlLXN0YXRlKWApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGRpc3BhdGNoZWRBY3Rpb24gPSBuZXh0KGFjdGlvbik7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIHN0YXRlID0gZ2V0U3RhdGUoKTsKICAgICAgICAgIHJlc3VsdCA9IHRyYWNrZXIuZGV0ZWN0TXV0YXRpb25zKCk7CiAgICAgICAgICB0cmFja2VyID0gdHJhY2soc3RhdGUpOwogICAgICAgICAgaWYgKHJlc3VsdC53YXNNdXRhdGVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjApIDogYEEgc3RhdGUgbXV0YXRpb24gd2FzIGRldGVjdGVkIGluc2lkZSBhIGRpc3BhdGNoLCBpbiB0aGUgcGF0aDogJHtyZXN1bHQucGF0aCB8fCAiIn0uIFRha2UgYSBsb29rIGF0IHRoZSByZWR1Y2VyKHMpIGhhbmRsaW5nIHRoZSBhY3Rpb24gJHtzdHJpbmdpZnkyKGFjdGlvbil9LiAoaHR0cHM6Ly9yZWR1eC5qcy5vcmcvc3R5bGUtZ3VpZGUvc3R5bGUtZ3VpZGUjZG8tbm90LW11dGF0ZS1zdGF0ZSlgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBtZWFzdXJlVXRpbHMud2FybklmRXhjZWVkZWQoKTsKICAgICAgICByZXR1cm4gZGlzcGF0Y2hlZEFjdGlvbjsKICAgICAgfTsKICAgIH07CiAgfQp9CmZ1bmN0aW9uIGlzUGxhaW4odmFsKSB7CiAgY29uc3QgdHlwZSA9IHR5cGVvZiB2YWw7CiAgcmV0dXJuIHZhbCA9PSBudWxsIHx8IHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGUgPT09ICJib29sZWFuIiB8fCB0eXBlID09PSAibnVtYmVyIiB8fCBBcnJheS5pc0FycmF5KHZhbCkgfHwgaXNQbGFpbk9iamVjdCh2YWwpOwp9CmZ1bmN0aW9uIGZpbmROb25TZXJpYWxpemFibGVWYWx1ZSh2YWx1ZSwgcGF0aDIgPSAiIiwgaXNTZXJpYWxpemFibGUgPSBpc1BsYWluLCBnZXRFbnRyaWVzLCBpZ25vcmVkUGF0aHMgPSBbXSwgY2FjaGUpIHsKICBsZXQgZm91bmROZXN0ZWRTZXJpYWxpemFibGU7CiAgaWYgKCFpc1NlcmlhbGl6YWJsZSh2YWx1ZSkpIHsKICAgIHJldHVybiB7CiAgICAgIGtleVBhdGg6IHBhdGgyIHx8ICI8cm9vdD4iLAogICAgICB2YWx1ZQogICAgfTsKICB9CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgfHwgdmFsdWUgPT09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKGNhY2hlPy5oYXModmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgZW50cmllcyA9IGdldEVudHJpZXMgIT0gbnVsbCA/IGdldEVudHJpZXModmFsdWUpIDogT2JqZWN0LmVudHJpZXModmFsdWUpOwogIGNvbnN0IGhhc0lnbm9yZWRQYXRocyA9IGlnbm9yZWRQYXRocy5sZW5ndGggPiAwOwogIGZvciAoY29uc3QgW2tleSwgbmVzdGVkVmFsdWVdIG9mIGVudHJpZXMpIHsKICAgIGNvbnN0IG5lc3RlZFBhdGggPSBwYXRoMiA/IHBhdGgyICsgIi4iICsga2V5IDoga2V5OwogICAgaWYgKGhhc0lnbm9yZWRQYXRocykgewogICAgICBjb25zdCBoYXNNYXRjaGVzID0gaWdub3JlZFBhdGhzLnNvbWUoKGlnbm9yZWQpID0+IHsKICAgICAgICBpZiAoaWdub3JlZCBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgcmV0dXJuIGlnbm9yZWQudGVzdChuZXN0ZWRQYXRoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5lc3RlZFBhdGggPT09IGlnbm9yZWQ7CiAgICAgIH0pOwogICAgICBpZiAoaGFzTWF0Y2hlcykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICB9CiAgICBpZiAoIWlzU2VyaWFsaXphYmxlKG5lc3RlZFZhbHVlKSkgewogICAgICByZXR1cm4gewogICAgICAgIGtleVBhdGg6IG5lc3RlZFBhdGgsCiAgICAgICAgdmFsdWU6IG5lc3RlZFZhbHVlCiAgICAgIH07CiAgICB9CiAgICBpZiAodHlwZW9mIG5lc3RlZFZhbHVlID09PSAib2JqZWN0IikgewogICAgICBmb3VuZE5lc3RlZFNlcmlhbGl6YWJsZSA9IGZpbmROb25TZXJpYWxpemFibGVWYWx1ZShuZXN0ZWRWYWx1ZSwgbmVzdGVkUGF0aCwgaXNTZXJpYWxpemFibGUsIGdldEVudHJpZXMsIGlnbm9yZWRQYXRocywgY2FjaGUpOwogICAgICBpZiAoZm91bmROZXN0ZWRTZXJpYWxpemFibGUpIHsKICAgICAgICByZXR1cm4gZm91bmROZXN0ZWRTZXJpYWxpemFibGU7CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKGNhY2hlICYmIGlzTmVzdGVkRnJvemVuKHZhbHVlKSkgY2FjaGUuYWRkKHZhbHVlKTsKICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gaXNOZXN0ZWRGcm96ZW4odmFsdWUpIHsKICBpZiAoIU9iamVjdC5pc0Zyb3plbih2YWx1ZSkpIHJldHVybiBmYWxzZTsKICBmb3IgKGNvbnN0IG5lc3RlZFZhbHVlIG9mIE9iamVjdC52YWx1ZXModmFsdWUpKSB7CiAgICBpZiAodHlwZW9mIG5lc3RlZFZhbHVlICE9PSAib2JqZWN0IiB8fCBuZXN0ZWRWYWx1ZSA9PT0gbnVsbCkgY29udGludWU7CiAgICBpZiAoIWlzTmVzdGVkRnJvemVuKG5lc3RlZFZhbHVlKSkgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBjcmVhdGVTZXJpYWxpemFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUob3B0aW9ucyA9IHt9KSB7CiAgaWYgKGZhbHNlKSB7CiAgICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IG5leHQoYWN0aW9uKTsKICB9IGVsc2UgewogICAgY29uc3QgewogICAgICBpc1NlcmlhbGl6YWJsZSA9IGlzUGxhaW4sCiAgICAgIGdldEVudHJpZXMsCiAgICAgIGlnbm9yZWRBY3Rpb25zID0gW10sCiAgICAgIGlnbm9yZWRBY3Rpb25QYXRocyA9IFsibWV0YS5hcmciLCAibWV0YS5iYXNlUXVlcnlNZXRhIl0sCiAgICAgIGlnbm9yZWRQYXRocyA9IFtdLAogICAgICB3YXJuQWZ0ZXIgPSAzMiwKICAgICAgaWdub3JlU3RhdGUgPSBmYWxzZSwKICAgICAgaWdub3JlQWN0aW9ucyA9IGZhbHNlLAogICAgICBkaXNhYmxlQ2FjaGUgPSBmYWxzZQogICAgfSA9IG9wdGlvbnM7CiAgICBjb25zdCBjYWNoZSA9ICFkaXNhYmxlQ2FjaGUgJiYgV2Vha1NldCA/IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpIDogdm9pZCAwOwogICAgcmV0dXJuIChzdG9yZUFQSSkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgICAgaWYgKCFpc0FjdGlvbihhY3Rpb24pKSB7CiAgICAgICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICAgICAgfQogICAgICBjb25zdCByZXN1bHQgPSBuZXh0KGFjdGlvbik7CiAgICAgIGNvbnN0IG1lYXN1cmVVdGlscyA9IGdldFRpbWVNZWFzdXJlVXRpbHMod2FybkFmdGVyLCAiU2VyaWFsaXphYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlIik7CiAgICAgIGlmICghaWdub3JlQWN0aW9ucyAmJiAhKGlnbm9yZWRBY3Rpb25zLmxlbmd0aCAmJiBpZ25vcmVkQWN0aW9ucy5pbmRleE9mKGFjdGlvbi50eXBlKSAhPT0gLTEpKSB7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIGNvbnN0IGZvdW5kQWN0aW9uTm9uU2VyaWFsaXphYmxlVmFsdWUgPSBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUoYWN0aW9uLCAiIiwgaXNTZXJpYWxpemFibGUsIGdldEVudHJpZXMsIGlnbm9yZWRBY3Rpb25QYXRocywgY2FjaGUpOwogICAgICAgICAgaWYgKGZvdW5kQWN0aW9uTm9uU2VyaWFsaXphYmxlVmFsdWUpIHsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGtleVBhdGgsCiAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgfSA9IGZvdW5kQWN0aW9uTm9uU2VyaWFsaXphYmxlVmFsdWU7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEEgbm9uLXNlcmlhbGl6YWJsZSB2YWx1ZSB3YXMgZGV0ZWN0ZWQgaW4gYW4gYWN0aW9uLCBpbiB0aGUgcGF0aDogXGAke2tleVBhdGh9XGAuIFZhbHVlOmAsIHZhbHVlLCAiXG5UYWtlIGEgbG9vayBhdCB0aGUgbG9naWMgdGhhdCBkaXNwYXRjaGVkIHRoaXMgYWN0aW9uOiAiLCBhY3Rpb24sICJcbihTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvZmFxL2FjdGlvbnMjd2h5LXNob3VsZC10eXBlLWJlLWEtc3RyaW5nLW9yLWF0LWxlYXN0LXNlcmlhbGl6YWJsZS13aHktc2hvdWxkLW15LWFjdGlvbi10eXBlcy1iZS1jb25zdGFudHMpIiwgIlxuKFRvIGFsbG93IG5vbi1zZXJpYWxpemFibGUgdmFsdWVzIHNlZTogaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy91c2FnZS91c2FnZS1ndWlkZSN3b3JraW5nLXdpdGgtbm9uLXNlcmlhbGl6YWJsZS1kYXRhKSIpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghaWdub3JlU3RhdGUpIHsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgY29uc3Qgc3RhdGUgPSBzdG9yZUFQSS5nZXRTdGF0ZSgpOwogICAgICAgICAgY29uc3QgZm91bmRTdGF0ZU5vblNlcmlhbGl6YWJsZVZhbHVlID0gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKHN0YXRlLCAiIiwgaXNTZXJpYWxpemFibGUsIGdldEVudHJpZXMsIGlnbm9yZWRQYXRocywgY2FjaGUpOwogICAgICAgICAgaWYgKGZvdW5kU3RhdGVOb25TZXJpYWxpemFibGVWYWx1ZSkgewogICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAga2V5UGF0aCwKICAgICAgICAgICAgICB2YWx1ZQogICAgICAgICAgICB9ID0gZm91bmRTdGF0ZU5vblNlcmlhbGl6YWJsZVZhbHVlOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBBIG5vbi1zZXJpYWxpemFibGUgdmFsdWUgd2FzIGRldGVjdGVkIGluIHRoZSBzdGF0ZSwgaW4gdGhlIHBhdGg6IFxgJHtrZXlQYXRofVxgLiBWYWx1ZTpgLCB2YWx1ZSwgYApUYWtlIGEgbG9vayBhdCB0aGUgcmVkdWNlcihzKSBoYW5kbGluZyB0aGlzIGFjdGlvbiB0eXBlOiAke2FjdGlvbi50eXBlfS4KKFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy9mYXEvb3JnYW5pemluZy1zdGF0ZSNjYW4taS1wdXQtZnVuY3Rpb25zLXByb21pc2VzLW9yLW90aGVyLW5vbi1zZXJpYWxpemFibGUtaXRlbXMtaW4tbXktc3RvcmUtc3RhdGUpYCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgbWVhc3VyZVV0aWxzLndhcm5JZkV4Y2VlZGVkKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQp9CmZ1bmN0aW9uIGlzQm9vbGVhbjIoeDIpIHsKICByZXR1cm4gdHlwZW9mIHgyID09PSAiYm9vbGVhbiI7Cn0KdmFyIGJ1aWxkR2V0RGVmYXVsdE1pZGRsZXdhcmUgPSAoKSA9PiBmdW5jdGlvbiBnZXREZWZhdWx0TWlkZGxld2FyZShvcHRpb25zKSB7CiAgY29uc3QgewogICAgdGh1bms6IHRodW5rMiA9IHRydWUsCiAgICBpbW11dGFibGVDaGVjayA9IHRydWUsCiAgICBzZXJpYWxpemFibGVDaGVjayA9IHRydWUsCiAgICBhY3Rpb25DcmVhdG9yQ2hlY2sgPSB0cnVlCiAgfSA9IG9wdGlvbnMgPz8ge307CiAgbGV0IG1pZGRsZXdhcmVBcnJheSA9IG5ldyBUdXBsZSgpOwogIGlmICh0aHVuazIpIHsKICAgIGlmIChpc0Jvb2xlYW4yKHRodW5rMikpIHsKICAgICAgbWlkZGxld2FyZUFycmF5LnB1c2godGh1bmspOwogICAgfSBlbHNlIHsKICAgICAgbWlkZGxld2FyZUFycmF5LnB1c2god2l0aEV4dHJhQXJndW1lbnQodGh1bmsyLmV4dHJhQXJndW1lbnQpKTsKICAgIH0KICB9CiAgaWYgKHRydWUpIHsKICAgIGlmIChpbW11dGFibGVDaGVjaykgewogICAgICBsZXQgaW1tdXRhYmxlT3B0aW9ucyA9IHt9OwogICAgICBpZiAoIWlzQm9vbGVhbjIoaW1tdXRhYmxlQ2hlY2spKSB7CiAgICAgICAgaW1tdXRhYmxlT3B0aW9ucyA9IGltbXV0YWJsZUNoZWNrOwogICAgICB9CiAgICAgIG1pZGRsZXdhcmVBcnJheS51bnNoaWZ0KGNyZWF0ZUltbXV0YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZShpbW11dGFibGVPcHRpb25zKSk7CiAgICB9CiAgICBpZiAoc2VyaWFsaXphYmxlQ2hlY2spIHsKICAgICAgbGV0IHNlcmlhbGl6YWJsZU9wdGlvbnMgPSB7fTsKICAgICAgaWYgKCFpc0Jvb2xlYW4yKHNlcmlhbGl6YWJsZUNoZWNrKSkgewogICAgICAgIHNlcmlhbGl6YWJsZU9wdGlvbnMgPSBzZXJpYWxpemFibGVDaGVjazsKICAgICAgfQogICAgICBtaWRkbGV3YXJlQXJyYXkucHVzaChjcmVhdGVTZXJpYWxpemFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUoc2VyaWFsaXphYmxlT3B0aW9ucykpOwogICAgfQogICAgaWYgKGFjdGlvbkNyZWF0b3JDaGVjaykgewogICAgICBsZXQgYWN0aW9uQ3JlYXRvck9wdGlvbnMgPSB7fTsKICAgICAgaWYgKCFpc0Jvb2xlYW4yKGFjdGlvbkNyZWF0b3JDaGVjaykpIHsKICAgICAgICBhY3Rpb25DcmVhdG9yT3B0aW9ucyA9IGFjdGlvbkNyZWF0b3JDaGVjazsKICAgICAgfQogICAgICBtaWRkbGV3YXJlQXJyYXkudW5zaGlmdChjcmVhdGVBY3Rpb25DcmVhdG9ySW52YXJpYW50TWlkZGxld2FyZShhY3Rpb25DcmVhdG9yT3B0aW9ucykpOwogICAgfQogIH0KICByZXR1cm4gbWlkZGxld2FyZUFycmF5Owp9Owp2YXIgU0hPVUxEX0FVVE9CQVRDSCA9ICJSVEtfYXV0b0JhdGNoIjsKdmFyIHByZXBhcmVBdXRvQmF0Y2hlZCA9ICgpID0+IChwYXlsb2FkKSA9PiAoewogIHBheWxvYWQsCiAgbWV0YTogewogICAgW1NIT1VMRF9BVVRPQkFUQ0hdOiB0cnVlCiAgfQp9KTsKdmFyIGNyZWF0ZVF1ZXVlV2l0aFRpbWVyID0gKHRpbWVvdXQpID0+IHsKICByZXR1cm4gKG5vdGlmeSkgPT4gewogICAgc2V0VGltZW91dChub3RpZnksIHRpbWVvdXQpOwogIH07Cn07CnZhciBhdXRvQmF0Y2hFbmhhbmNlciA9IChvcHRpb25zID0gewogIHR5cGU6ICJyYWYiCn0pID0+IChuZXh0KSA9PiAoLi4uYXJncykgPT4gewogIGNvbnN0IHN0b3JlID0gbmV4dCguLi5hcmdzKTsKICBsZXQgbm90aWZ5aW5nID0gdHJ1ZTsKICBsZXQgc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2sgPSBmYWxzZTsKICBsZXQgbm90aWZpY2F0aW9uUXVldWVkID0gZmFsc2U7CiAgY29uc3QgbGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICBjb25zdCBxdWV1ZUNhbGxiYWNrID0gb3B0aW9ucy50eXBlID09PSAidGljayIgPyBxdWV1ZU1pY3JvdGFzayA6IG9wdGlvbnMudHlwZSA9PT0gInJhZiIgPyAoCiAgICAvLyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgd29uJ3QgZXhpc3QgaW4gU1NSIGVudmlyb25tZW50cy4gRmFsbCBiYWNrIHRvIGEgdmFndWUgYXBwcm94aW1hdGlvbiBqdXN0IHRvIGtlZXAgZnJvbSBlcnJvcmluZy4KICAgIHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPyB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIDogY3JlYXRlUXVldWVXaXRoVGltZXIoMTApCiAgKSA6IG9wdGlvbnMudHlwZSA9PT0gImNhbGxiYWNrIiA/IG9wdGlvbnMucXVldWVOb3RpZmljYXRpb24gOiBjcmVhdGVRdWV1ZVdpdGhUaW1lcihvcHRpb25zLnRpbWVvdXQpOwogIGNvbnN0IG5vdGlmeUxpc3RlbmVycyA9ICgpID0+IHsKICAgIG5vdGlmaWNhdGlvblF1ZXVlZCA9IGZhbHNlOwogICAgaWYgKHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrKSB7CiAgICAgIHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrID0gZmFsc2U7CiAgICAgIGxpc3RlbmVycy5mb3JFYWNoKChsKSA9PiBsKCkpOwogICAgfQogIH07CiAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHN0b3JlLCB7CiAgICAvLyBPdmVycmlkZSB0aGUgYmFzZSBgc3RvcmUuc3Vic2NyaWJlYCBtZXRob2QgdG8ga2VlcCBvcmlnaW5hbCBsaXN0ZW5lcnMKICAgIC8vIGZyb20gcnVubmluZyBpZiB3ZSdyZSBkZWxheWluZyBub3RpZmljYXRpb25zCiAgICBzdWJzY3JpYmUobGlzdGVuZXIyKSB7CiAgICAgIGNvbnN0IHdyYXBwZWRMaXN0ZW5lciA9ICgpID0+IG5vdGlmeWluZyAmJiBsaXN0ZW5lcjIoKTsKICAgICAgY29uc3QgdW5zdWJzY3JpYmUgPSBzdG9yZS5zdWJzY3JpYmUod3JhcHBlZExpc3RlbmVyKTsKICAgICAgbGlzdGVuZXJzLmFkZChsaXN0ZW5lcjIpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICAgICAgbGlzdGVuZXJzLmRlbGV0ZShsaXN0ZW5lcjIpOwogICAgICB9OwogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoZSBiYXNlIGBzdG9yZS5kaXNwYXRjaGAgbWV0aG9kIHNvIHRoYXQgd2UgY2FuIGNoZWNrIGFjdGlvbnMKICAgIC8vIGZvciB0aGUgYHNob3VsZEF1dG9CYXRjaGAgZmxhZyBhbmQgZGV0ZXJtaW5lIGlmIGJhdGNoaW5nIGlzIGFjdGl2ZQogICAgZGlzcGF0Y2goYWN0aW9uKSB7CiAgICAgIHRyeSB7CiAgICAgICAgbm90aWZ5aW5nID0gIWFjdGlvbj8ubWV0YT8uW1NIT1VMRF9BVVRPQkFUQ0hdOwogICAgICAgIHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrID0gIW5vdGlmeWluZzsKICAgICAgICBpZiAoc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2spIHsKICAgICAgICAgIGlmICghbm90aWZpY2F0aW9uUXVldWVkKSB7CiAgICAgICAgICAgIG5vdGlmaWNhdGlvblF1ZXVlZCA9IHRydWU7CiAgICAgICAgICAgIHF1ZXVlQ2FsbGJhY2sobm90aWZ5TGlzdGVuZXJzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0b3JlLmRpc3BhdGNoKGFjdGlvbik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgbm90aWZ5aW5nID0gdHJ1ZTsKICAgICAgfQogICAgfQogIH0pOwp9Owp2YXIgYnVpbGRHZXREZWZhdWx0RW5oYW5jZXJzID0gKG1pZGRsZXdhcmVFbmhhbmNlcikgPT4gZnVuY3Rpb24gZ2V0RGVmYXVsdEVuaGFuY2VycyhvcHRpb25zKSB7CiAgY29uc3QgewogICAgYXV0b0JhdGNoID0gdHJ1ZQogIH0gPSBvcHRpb25zID8/IHt9OwogIGxldCBlbmhhbmNlckFycmF5ID0gbmV3IFR1cGxlKG1pZGRsZXdhcmVFbmhhbmNlcik7CiAgaWYgKGF1dG9CYXRjaCkgewogICAgZW5oYW5jZXJBcnJheS5wdXNoKGF1dG9CYXRjaEVuaGFuY2VyKHR5cGVvZiBhdXRvQmF0Y2ggPT09ICJvYmplY3QiID8gYXV0b0JhdGNoIDogdm9pZCAwKSk7CiAgfQogIHJldHVybiBlbmhhbmNlckFycmF5Owp9OwpmdW5jdGlvbiBjb25maWd1cmVTdG9yZShvcHRpb25zKSB7CiAgY29uc3QgZ2V0RGVmYXVsdE1pZGRsZXdhcmUgPSBidWlsZEdldERlZmF1bHRNaWRkbGV3YXJlKCk7CiAgY29uc3QgewogICAgcmVkdWNlciA9IHZvaWQgMCwKICAgIG1pZGRsZXdhcmUsCiAgICBkZXZUb29scyA9IHRydWUsCiAgICBkdXBsaWNhdGVNaWRkbGV3YXJlQ2hlY2sgPSB0cnVlLAogICAgcHJlbG9hZGVkU3RhdGUgPSB2b2lkIDAsCiAgICBlbmhhbmNlcnMgPSB2b2lkIDAKICB9ID0gb3B0aW9ucyB8fCB7fTsKICBsZXQgcm9vdFJlZHVjZXIyOwogIGlmICh0eXBlb2YgcmVkdWNlciA9PT0gImZ1bmN0aW9uIikgewogICAgcm9vdFJlZHVjZXIyID0gcmVkdWNlcjsKICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QocmVkdWNlcikpIHsKICAgIHJvb3RSZWR1Y2VyMiA9IGNvbWJpbmVSZWR1Y2VycyhyZWR1Y2VyKTsKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxKSA6ICJgcmVkdWNlcmAgaXMgYSByZXF1aXJlZCBhcmd1bWVudCwgYW5kIG11c3QgYmUgYSBmdW5jdGlvbiBvciBhbiBvYmplY3Qgb2YgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIHBhc3NlZCB0byBjb21iaW5lUmVkdWNlcnMiKTsKICB9CiAgaWYgKG1pZGRsZXdhcmUgJiYgdHlwZW9mIG1pZGRsZXdhcmUgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMikgOiAiYG1pZGRsZXdhcmVgIGZpZWxkIG11c3QgYmUgYSBjYWxsYmFjayIpOwogIH0KICBsZXQgZmluYWxNaWRkbGV3YXJlOwogIGlmICh0eXBlb2YgbWlkZGxld2FyZSA9PT0gImZ1bmN0aW9uIikgewogICAgZmluYWxNaWRkbGV3YXJlID0gbWlkZGxld2FyZShnZXREZWZhdWx0TWlkZGxld2FyZSk7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZmluYWxNaWRkbGV3YXJlKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMpIDogIndoZW4gdXNpbmcgYSBtaWRkbGV3YXJlIGJ1aWxkZXIgZnVuY3Rpb24sIGFuIGFycmF5IG9mIG1pZGRsZXdhcmUgbXVzdCBiZSByZXR1cm5lZCIpOwogICAgfQogIH0gZWxzZSB7CiAgICBmaW5hbE1pZGRsZXdhcmUgPSBnZXREZWZhdWx0TWlkZGxld2FyZSgpOwogIH0KICBpZiAoZmluYWxNaWRkbGV3YXJlLnNvbWUoKGl0ZW0pID0+IHR5cGVvZiBpdGVtICE9PSAiZnVuY3Rpb24iKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0KSA6ICJlYWNoIG1pZGRsZXdhcmUgcHJvdmlkZWQgdG8gY29uZmlndXJlU3RvcmUgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgfQogIGlmIChkdXBsaWNhdGVNaWRkbGV3YXJlQ2hlY2spIHsKICAgIGxldCBtaWRkbGV3YXJlUmVmZXJlbmNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBmaW5hbE1pZGRsZXdhcmUuZm9yRWFjaCgobWlkZGxld2FyZTIpID0+IHsKICAgICAgaWYgKG1pZGRsZXdhcmVSZWZlcmVuY2VzLmhhcyhtaWRkbGV3YXJlMikpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQyKSA6ICJEdXBsaWNhdGUgbWlkZGxld2FyZSByZWZlcmVuY2VzIGZvdW5kIHdoZW4gY3JlYXRpbmcgdGhlIHN0b3JlLiBFbnN1cmUgdGhhdCBlYWNoIG1pZGRsZXdhcmUgaXMgb25seSBpbmNsdWRlZCBvbmNlLiIpOwogICAgICB9CiAgICAgIG1pZGRsZXdhcmVSZWZlcmVuY2VzLmFkZChtaWRkbGV3YXJlMik7CiAgICB9KTsKICB9CiAgbGV0IGZpbmFsQ29tcG9zZSA9IGNvbXBvc2U7CiAgaWYgKGRldlRvb2xzKSB7CiAgICBmaW5hbENvbXBvc2UgPSBjb21wb3NlV2l0aERldlRvb2xzKHsKICAgICAgLy8gRW5hYmxlIGNhcHR1cmUgb2Ygc3RhY2sgdHJhY2VzIGZvciBkaXNwYXRjaGVkIFJlZHV4IGFjdGlvbnMKICAgICAgdHJhY2U6IHRydWUsCiAgICAgIC4uLnR5cGVvZiBkZXZUb29scyA9PT0gIm9iamVjdCIgJiYgZGV2VG9vbHMKICAgIH0pOwogIH0KICBjb25zdCBtaWRkbGV3YXJlRW5oYW5jZXIgPSBhcHBseU1pZGRsZXdhcmUoLi4uZmluYWxNaWRkbGV3YXJlKTsKICBjb25zdCBnZXREZWZhdWx0RW5oYW5jZXJzID0gYnVpbGRHZXREZWZhdWx0RW5oYW5jZXJzKG1pZGRsZXdhcmVFbmhhbmNlcik7CiAgaWYgKGVuaGFuY2VycyAmJiB0eXBlb2YgZW5oYW5jZXJzICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDUpIDogImBlbmhhbmNlcnNgIGZpZWxkIG11c3QgYmUgYSBjYWxsYmFjayIpOwogIH0KICBsZXQgc3RvcmVFbmhhbmNlcnMgPSB0eXBlb2YgZW5oYW5jZXJzID09PSAiZnVuY3Rpb24iID8gZW5oYW5jZXJzKGdldERlZmF1bHRFbmhhbmNlcnMpIDogZ2V0RGVmYXVsdEVuaGFuY2VycygpOwogIGlmICghQXJyYXkuaXNBcnJheShzdG9yZUVuaGFuY2VycykpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNikgOiAiYGVuaGFuY2Vyc2AgY2FsbGJhY2sgbXVzdCByZXR1cm4gYW4gYXJyYXkiKTsKICB9CiAgaWYgKHN0b3JlRW5oYW5jZXJzLnNvbWUoKGl0ZW0pID0+IHR5cGVvZiBpdGVtICE9PSAiZnVuY3Rpb24iKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg3KSA6ICJlYWNoIGVuaGFuY2VyIHByb3ZpZGVkIHRvIGNvbmZpZ3VyZVN0b3JlIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogIH0KICBpZiAoZmluYWxNaWRkbGV3YXJlLmxlbmd0aCAmJiAhc3RvcmVFbmhhbmNlcnMuaW5jbHVkZXMobWlkZGxld2FyZUVuaGFuY2VyKSkgewogICAgY29uc29sZS5lcnJvcigibWlkZGxld2FyZXMgd2VyZSBwcm92aWRlZCwgYnV0IG1pZGRsZXdhcmUgZW5oYW5jZXIgd2FzIG5vdCBpbmNsdWRlZCBpbiBmaW5hbCBlbmhhbmNlcnMgLSBtYWtlIHN1cmUgdG8gY2FsbCBgZ2V0RGVmYXVsdEVuaGFuY2Vyc2AiKTsKICB9CiAgY29uc3QgY29tcG9zZWRFbmhhbmNlciA9IGZpbmFsQ29tcG9zZSguLi5zdG9yZUVuaGFuY2Vycyk7CiAgcmV0dXJuIGNyZWF0ZVN0b3JlKHJvb3RSZWR1Y2VyMiwgcHJlbG9hZGVkU3RhdGUsIGNvbXBvc2VkRW5oYW5jZXIpOwp9CmZ1bmN0aW9uIGV4ZWN1dGVSZWR1Y2VyQnVpbGRlckNhbGxiYWNrKGJ1aWxkZXJDYWxsYmFjaykgewogIGNvbnN0IGFjdGlvbnNNYXAgPSB7fTsKICBjb25zdCBhY3Rpb25NYXRjaGVycyA9IFtdOwogIGxldCBkZWZhdWx0Q2FzZVJlZHVjZXI7CiAgY29uc3QgYnVpbGRlciA9IHsKICAgIGFkZENhc2UodHlwZU9yQWN0aW9uQ3JlYXRvciwgcmVkdWNlcikgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChhY3Rpb25NYXRjaGVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI2KSA6ICJgYnVpbGRlci5hZGRDYXNlYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYGJ1aWxkZXIuYWRkTWF0Y2hlcmAiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyNykgOiAiYGJ1aWxkZXIuYWRkQ2FzZWAgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCB0eXBlID0gdHlwZW9mIHR5cGVPckFjdGlvbkNyZWF0b3IgPT09ICJzdHJpbmciID8gdHlwZU9yQWN0aW9uQ3JlYXRvciA6IHR5cGVPckFjdGlvbkNyZWF0b3IudHlwZTsKICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyOCkgOiAiYGJ1aWxkZXIuYWRkQ2FzZWAgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGFuIGVtcHR5IGFjdGlvbiB0eXBlIik7CiAgICAgIH0KICAgICAgaWYgKHR5cGUgaW4gYWN0aW9uc01hcCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjkpIDogYFxgYnVpbGRlci5hZGRDYXNlXGAgY2Fubm90IGJlIGNhbGxlZCB3aXRoIHR3byByZWR1Y2VycyBmb3IgdGhlIHNhbWUgYWN0aW9uIHR5cGUgJyR7dHlwZX0nYCk7CiAgICAgIH0KICAgICAgYWN0aW9uc01hcFt0eXBlXSA9IHJlZHVjZXI7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfSwKICAgIGFkZEFzeW5jVGh1bmsoYXN5bmNUaHVuaywgcmVkdWNlcnMpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQzKSA6ICJgYnVpbGRlci5hZGRBc3luY1RodW5rYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChyZWR1Y2Vycy5wZW5kaW5nKSBhY3Rpb25zTWFwW2FzeW5jVGh1bmsucGVuZGluZy50eXBlXSA9IHJlZHVjZXJzLnBlbmRpbmc7CiAgICAgIGlmIChyZWR1Y2Vycy5yZWplY3RlZCkgYWN0aW9uc01hcFthc3luY1RodW5rLnJlamVjdGVkLnR5cGVdID0gcmVkdWNlcnMucmVqZWN0ZWQ7CiAgICAgIGlmIChyZWR1Y2Vycy5mdWxmaWxsZWQpIGFjdGlvbnNNYXBbYXN5bmNUaHVuay5mdWxmaWxsZWQudHlwZV0gPSByZWR1Y2Vycy5mdWxmaWxsZWQ7CiAgICAgIGlmIChyZWR1Y2Vycy5zZXR0bGVkKSBhY3Rpb25NYXRjaGVycy5wdXNoKHsKICAgICAgICBtYXRjaGVyOiBhc3luY1RodW5rLnNldHRsZWQsCiAgICAgICAgcmVkdWNlcjogcmVkdWNlcnMuc2V0dGxlZAogICAgICB9KTsKICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICB9LAogICAgYWRkTWF0Y2hlcihtYXRjaGVyLCByZWR1Y2VyKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzMCkgOiAiYGJ1aWxkZXIuYWRkTWF0Y2hlcmAgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBhY3Rpb25NYXRjaGVycy5wdXNoKHsKICAgICAgICBtYXRjaGVyLAogICAgICAgIHJlZHVjZXIKICAgICAgfSk7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfSwKICAgIGFkZERlZmF1bHRDYXNlKHJlZHVjZXIpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMxKSA6ICJgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAgY2FuIG9ubHkgYmUgY2FsbGVkIG9uY2UiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZGVmYXVsdENhc2VSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICB9CiAgfTsKICBidWlsZGVyQ2FsbGJhY2soYnVpbGRlcik7CiAgcmV0dXJuIFthY3Rpb25zTWFwLCBhY3Rpb25NYXRjaGVycywgZGVmYXVsdENhc2VSZWR1Y2VyXTsKfQpmdW5jdGlvbiBpc1N0YXRlRnVuY3Rpb24oeDIpIHsKICByZXR1cm4gdHlwZW9mIHgyID09PSAiZnVuY3Rpb24iOwp9CmZ1bmN0aW9uIGNyZWF0ZVJlZHVjZXIoaW5pdGlhbFN0YXRlMTMsIG1hcE9yQnVpbGRlckNhbGxiYWNrKSB7CiAgaWYgKHRydWUpIHsKICAgIGlmICh0eXBlb2YgbWFwT3JCdWlsZGVyQ2FsbGJhY2sgPT09ICJvYmplY3QiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoOCkgOiAiVGhlIG9iamVjdCBub3RhdGlvbiBmb3IgYGNyZWF0ZVJlZHVjZXJgIGhhcyBiZWVuIHJlbW92ZWQuIFBsZWFzZSB1c2UgdGhlICdidWlsZGVyIGNhbGxiYWNrJyBub3RhdGlvbiBpbnN0ZWFkOiBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL2FwaS9jcmVhdGVSZWR1Y2VyIik7CiAgICB9CiAgfQogIGxldCBbYWN0aW9uc01hcCwgZmluYWxBY3Rpb25NYXRjaGVycywgZmluYWxEZWZhdWx0Q2FzZVJlZHVjZXJdID0gZXhlY3V0ZVJlZHVjZXJCdWlsZGVyQ2FsbGJhY2sobWFwT3JCdWlsZGVyQ2FsbGJhY2spOwogIGxldCBnZXRJbml0aWFsU3RhdGU7CiAgaWYgKGlzU3RhdGVGdW5jdGlvbihpbml0aWFsU3RhdGUxMykpIHsKICAgIGdldEluaXRpYWxTdGF0ZSA9ICgpID0+IGZyZWV6ZURyYWZ0YWJsZShpbml0aWFsU3RhdGUxMygpKTsKICB9IGVsc2UgewogICAgY29uc3QgZnJvemVuSW5pdGlhbFN0YXRlID0gZnJlZXplRHJhZnRhYmxlKGluaXRpYWxTdGF0ZTEzKTsKICAgIGdldEluaXRpYWxTdGF0ZSA9ICgpID0+IGZyb3plbkluaXRpYWxTdGF0ZTsKICB9CiAgZnVuY3Rpb24gcmVkdWNlcihzdGF0ZSA9IGdldEluaXRpYWxTdGF0ZSgpLCBhY3Rpb24pIHsKICAgIGxldCBjYXNlUmVkdWNlcnMgPSBbYWN0aW9uc01hcFthY3Rpb24udHlwZV0sIC4uLmZpbmFsQWN0aW9uTWF0Y2hlcnMuZmlsdGVyKCh7CiAgICAgIG1hdGNoZXIKICAgIH0pID0+IG1hdGNoZXIoYWN0aW9uKSkubWFwKCh7CiAgICAgIHJlZHVjZXI6IHJlZHVjZXIyCiAgICB9KSA9PiByZWR1Y2VyMildOwogICAgaWYgKGNhc2VSZWR1Y2Vycy5maWx0ZXIoKGNyKSA9PiAhIWNyKS5sZW5ndGggPT09IDApIHsKICAgICAgY2FzZVJlZHVjZXJzID0gW2ZpbmFsRGVmYXVsdENhc2VSZWR1Y2VyXTsKICAgIH0KICAgIHJldHVybiBjYXNlUmVkdWNlcnMucmVkdWNlKChwcmV2aW91c1N0YXRlLCBjYXNlUmVkdWNlcikgPT4gewogICAgICBpZiAoY2FzZVJlZHVjZXIpIHsKICAgICAgICBpZiAoaXNEcmFmdChwcmV2aW91c1N0YXRlKSkgewogICAgICAgICAgY29uc3QgZHJhZnQgPSBwcmV2aW91c1N0YXRlOwogICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2FzZVJlZHVjZXIoZHJhZnQsIGFjdGlvbik7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0gZWxzZSBpZiAoIWlzRHJhZnRhYmxlKHByZXZpb3VzU3RhdGUpKSB7CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBjYXNlUmVkdWNlcihwcmV2aW91c1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChwcmV2aW91c1N0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzU3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkEgY2FzZSByZWR1Y2VyIG9uIGEgbm9uLWRyYWZ0YWJsZSB2YWx1ZSBtdXN0IG5vdCByZXR1cm4gdW5kZWZpbmVkIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gcHJvZHVjZShwcmV2aW91c1N0YXRlLCAoZHJhZnQpID0+IHsKICAgICAgICAgICAgcmV0dXJuIGNhc2VSZWR1Y2VyKGRyYWZ0LCBhY3Rpb24pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBwcmV2aW91c1N0YXRlOwogICAgfSwgc3RhdGUpOwogIH0KICByZWR1Y2VyLmdldEluaXRpYWxTdGF0ZSA9IGdldEluaXRpYWxTdGF0ZTsKICByZXR1cm4gcmVkdWNlcjsKfQp2YXIgbWF0Y2hlcyA9IChtYXRjaGVyLCBhY3Rpb24pID0+IHsKICBpZiAoaGFzTWF0Y2hGdW5jdGlvbihtYXRjaGVyKSkgewogICAgcmV0dXJuIG1hdGNoZXIubWF0Y2goYWN0aW9uKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG1hdGNoZXIoYWN0aW9uKTsKICB9Cn07CmZ1bmN0aW9uIGlzQW55T2YoLi4ubWF0Y2hlcnMpIHsKICByZXR1cm4gKGFjdGlvbikgPT4gewogICAgcmV0dXJuIG1hdGNoZXJzLnNvbWUoKG1hdGNoZXIpID0+IG1hdGNoZXMobWF0Y2hlciwgYWN0aW9uKSk7CiAgfTsKfQp2YXIgdXJsQWxwaGFiZXQgPSAiTW9kdWxlU3ltYmhhc093blByLTAxMjM0NTY3ODlBQkNERUZHSE5SVmZnY3RpVXZ6X0txWVRKa0x4cFpYSWpRVyI7CnZhciBuYW5vaWQgPSAoc2l6ZSA9IDIxKSA9PiB7CiAgbGV0IGlkID0gIiI7CiAgbGV0IGkgPSBzaXplOwogIHdoaWxlIChpLS0pIHsKICAgIGlkICs9IHVybEFscGhhYmV0W01hdGgucmFuZG9tKCkgKiA2NCB8IDBdOwogIH0KICByZXR1cm4gaWQ7Cn07CnZhciBjb21tb25Qcm9wZXJ0aWVzID0gWyJuYW1lIiwgIm1lc3NhZ2UiLCAic3RhY2siLCAiY29kZSJdOwp2YXIgUmVqZWN0V2l0aFZhbHVlID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHBheWxvYWQsIG1ldGEpIHsKICAgIHRoaXMucGF5bG9hZCA9IHBheWxvYWQ7CiAgICB0aGlzLm1ldGEgPSBtZXRhOwogIH0KICAvKgogIHR5cGUtb25seSBwcm9wZXJ0eSB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIFJlamVjdFdpdGhWYWx1ZSBhbmQgRnVsZmlsbFdpdGhNZXRhCiAgZG9lcyBub3QgZXhpc3QgYXQgcnVudGltZQogICovCiAgX3R5cGU7Cn07CnZhciBGdWxmaWxsV2l0aE1ldGEgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IocGF5bG9hZCwgbWV0YSkgewogICAgdGhpcy5wYXlsb2FkID0gcGF5bG9hZDsKICAgIHRoaXMubWV0YSA9IG1ldGE7CiAgfQogIC8qCiAgdHlwZS1vbmx5IHByb3BlcnR5IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gUmVqZWN0V2l0aFZhbHVlIGFuZCBGdWxmaWxsV2l0aE1ldGEKICBkb2VzIG5vdCBleGlzdCBhdCBydW50aW1lCiAgKi8KICBfdHlwZTsKfTsKdmFyIG1pbmlTZXJpYWxpemVFcnJvciA9ICh2YWx1ZSkgPT4gewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICBjb25zdCBzaW1wbGVFcnJvciA9IHt9OwogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBjb21tb25Qcm9wZXJ0aWVzKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWVbcHJvcGVydHldID09PSAic3RyaW5nIikgewogICAgICAgIHNpbXBsZUVycm9yW3Byb3BlcnR5XSA9IHZhbHVlW3Byb3BlcnR5XTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNpbXBsZUVycm9yOwogIH0KICByZXR1cm4gewogICAgbWVzc2FnZTogU3RyaW5nKHZhbHVlKQogIH07Cn07CnZhciBleHRlcm5hbEFib3J0TWVzc2FnZSA9ICJFeHRlcm5hbCBzaWduYWwgd2FzIGFib3J0ZWQiOwp2YXIgY3JlYXRlQXN5bmNUaHVuayA9IC8qIEBfX1BVUkVfXyAqLyAoKCkgPT4gewogIGZ1bmN0aW9uIGNyZWF0ZUFzeW5jVGh1bmsyKHR5cGVQcmVmaXgsIHBheWxvYWRDcmVhdG9yLCBvcHRpb25zKSB7CiAgICBjb25zdCBmdWxmaWxsZWQgPSBjcmVhdGVBY3Rpb24odHlwZVByZWZpeCArICIvZnVsZmlsbGVkIiwgKHBheWxvYWQsIHJlcXVlc3RJZCwgYXJnLCBtZXRhKSA9PiAoewogICAgICBwYXlsb2FkLAogICAgICBtZXRhOiB7CiAgICAgICAgLi4ubWV0YSB8fCB7fSwKICAgICAgICBhcmcsCiAgICAgICAgcmVxdWVzdElkLAogICAgICAgIHJlcXVlc3RTdGF0dXM6ICJmdWxmaWxsZWQiCiAgICAgIH0KICAgIH0pKTsKICAgIGNvbnN0IHBlbmRpbmcgPSBjcmVhdGVBY3Rpb24odHlwZVByZWZpeCArICIvcGVuZGluZyIsIChyZXF1ZXN0SWQsIGFyZywgbWV0YSkgPT4gKHsKICAgICAgcGF5bG9hZDogdm9pZCAwLAogICAgICBtZXRhOiB7CiAgICAgICAgLi4ubWV0YSB8fCB7fSwKICAgICAgICBhcmcsCiAgICAgICAgcmVxdWVzdElkLAogICAgICAgIHJlcXVlc3RTdGF0dXM6ICJwZW5kaW5nIgogICAgICB9CiAgICB9KSk7CiAgICBjb25zdCByZWplY3RlZCA9IGNyZWF0ZUFjdGlvbih0eXBlUHJlZml4ICsgIi9yZWplY3RlZCIsIChlcnJvciwgcmVxdWVzdElkLCBhcmcsIHBheWxvYWQsIG1ldGEpID0+ICh7CiAgICAgIHBheWxvYWQsCiAgICAgIGVycm9yOiAob3B0aW9ucyAmJiBvcHRpb25zLnNlcmlhbGl6ZUVycm9yIHx8IG1pbmlTZXJpYWxpemVFcnJvcikoZXJyb3IgfHwgIlJlamVjdGVkIiksCiAgICAgIG1ldGE6IHsKICAgICAgICAuLi5tZXRhIHx8IHt9LAogICAgICAgIGFyZywKICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgcmVqZWN0ZWRXaXRoVmFsdWU6ICEhcGF5bG9hZCwKICAgICAgICByZXF1ZXN0U3RhdHVzOiAicmVqZWN0ZWQiLAogICAgICAgIGFib3J0ZWQ6IGVycm9yPy5uYW1lID09PSAiQWJvcnRFcnJvciIsCiAgICAgICAgY29uZGl0aW9uOiBlcnJvcj8ubmFtZSA9PT0gIkNvbmRpdGlvbkVycm9yIgogICAgICB9CiAgICB9KSk7CiAgICBmdW5jdGlvbiBhY3Rpb25DcmVhdG9yKGFyZywgewogICAgICBzaWduYWwKICAgIH0gPSB7fSkgewogICAgICByZXR1cm4gKGRpc3BhdGNoLCBnZXRTdGF0ZSwgZXh0cmEpID0+IHsKICAgICAgICBjb25zdCByZXF1ZXN0SWQgPSBvcHRpb25zPy5pZEdlbmVyYXRvciA/IG9wdGlvbnMuaWRHZW5lcmF0b3IoYXJnKSA6IG5hbm9pZCgpOwogICAgICAgIGNvbnN0IGFib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICAgICBsZXQgYWJvcnRIYW5kbGVyOwogICAgICAgIGxldCBhYm9ydFJlYXNvbjsKICAgICAgICBmdW5jdGlvbiBhYm9ydChyZWFzb24pIHsKICAgICAgICAgIGFib3J0UmVhc29uID0gcmVhc29uOwogICAgICAgICAgYWJvcnRDb250cm9sbGVyLmFib3J0KCk7CiAgICAgICAgfQogICAgICAgIGlmIChzaWduYWwpIHsKICAgICAgICAgIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgICAgICAgICBhYm9ydChleHRlcm5hbEFib3J0TWVzc2FnZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCAoKSA9PiBhYm9ydChleHRlcm5hbEFib3J0TWVzc2FnZSksIHsKICAgICAgICAgICAgICBvbmNlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBwcm9taXNlID0gYXN5bmMgZnVuY3Rpb24oKSB7CiAgICAgICAgICBsZXQgZmluYWxBY3Rpb247CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsZXQgY29uZGl0aW9uUmVzdWx0ID0gb3B0aW9ucz8uY29uZGl0aW9uPy4oYXJnLCB7CiAgICAgICAgICAgICAgZ2V0U3RhdGUsCiAgICAgICAgICAgICAgZXh0cmEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChpc1RoZW5hYmxlKGNvbmRpdGlvblJlc3VsdCkpIHsKICAgICAgICAgICAgICBjb25kaXRpb25SZXN1bHQgPSBhd2FpdCBjb25kaXRpb25SZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbmRpdGlvblJlc3VsdCA9PT0gZmFsc2UgfHwgYWJvcnRDb250cm9sbGVyLnNpZ25hbC5hYm9ydGVkKSB7CiAgICAgICAgICAgICAgdGhyb3cgewogICAgICAgICAgICAgICAgbmFtZTogIkNvbmRpdGlvbkVycm9yIiwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICJBYm9ydGVkIGR1ZSB0byBjb25kaXRpb24gY2FsbGJhY2sgcmV0dXJuaW5nIGZhbHNlLiIKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGFib3J0ZWRQcm9taXNlID0gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4gewogICAgICAgICAgICAgIGFib3J0SGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgICAgICAgIG5hbWU6ICJBYm9ydEVycm9yIiwKICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYWJvcnRSZWFzb24gfHwgIkFib3J0ZWQiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGFib3J0Q29udHJvbGxlci5zaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBhYm9ydEhhbmRsZXIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGlzcGF0Y2gocGVuZGluZyhyZXF1ZXN0SWQsIGFyZywgb3B0aW9ucz8uZ2V0UGVuZGluZ01ldGE/Lih7CiAgICAgICAgICAgICAgcmVxdWVzdElkLAogICAgICAgICAgICAgIGFyZwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgZ2V0U3RhdGUsCiAgICAgICAgICAgICAgZXh0cmEKICAgICAgICAgICAgfSkpKTsKICAgICAgICAgICAgZmluYWxBY3Rpb24gPSBhd2FpdCBQcm9taXNlLnJhY2UoW2Fib3J0ZWRQcm9taXNlLCBQcm9taXNlLnJlc29sdmUocGF5bG9hZENyZWF0b3IoYXJnLCB7CiAgICAgICAgICAgICAgZGlzcGF0Y2gsCiAgICAgICAgICAgICAgZ2V0U3RhdGUsCiAgICAgICAgICAgICAgZXh0cmEsCiAgICAgICAgICAgICAgcmVxdWVzdElkLAogICAgICAgICAgICAgIHNpZ25hbDogYWJvcnRDb250cm9sbGVyLnNpZ25hbCwKICAgICAgICAgICAgICBhYm9ydCwKICAgICAgICAgICAgICByZWplY3RXaXRoVmFsdWU6ICh2YWx1ZSwgbWV0YSkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWplY3RXaXRoVmFsdWUodmFsdWUsIG1ldGEpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVsZmlsbFdpdGhWYWx1ZTogKHZhbHVlLCBtZXRhKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEZ1bGZpbGxXaXRoTWV0YSh2YWx1ZSwgbWV0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSkudGhlbigocmVzdWx0KSA9PiB7CiAgICAgICAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFJlamVjdFdpdGhWYWx1ZSkgewogICAgICAgICAgICAgICAgdGhyb3cgcmVzdWx0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgRnVsZmlsbFdpdGhNZXRhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVsZmlsbGVkKHJlc3VsdC5wYXlsb2FkLCByZXF1ZXN0SWQsIGFyZywgcmVzdWx0Lm1ldGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZnVsZmlsbGVkKHJlc3VsdCwgcmVxdWVzdElkLCBhcmcpOwogICAgICAgICAgICB9KV0pOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGZpbmFsQWN0aW9uID0gZXJyIGluc3RhbmNlb2YgUmVqZWN0V2l0aFZhbHVlID8gcmVqZWN0ZWQobnVsbCwgcmVxdWVzdElkLCBhcmcsIGVyci5wYXlsb2FkLCBlcnIubWV0YSkgOiByZWplY3RlZChlcnIsIHJlcXVlc3RJZCwgYXJnKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGlmIChhYm9ydEhhbmRsZXIpIHsKICAgICAgICAgICAgICBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImFib3J0IiwgYWJvcnRIYW5kbGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgc2tpcERpc3BhdGNoID0gb3B0aW9ucyAmJiAhb3B0aW9ucy5kaXNwYXRjaENvbmRpdGlvblJlamVjdGlvbiAmJiByZWplY3RlZC5tYXRjaChmaW5hbEFjdGlvbikgJiYgZmluYWxBY3Rpb24ubWV0YS5jb25kaXRpb247CiAgICAgICAgICBpZiAoIXNraXBEaXNwYXRjaCkgewogICAgICAgICAgICBkaXNwYXRjaChmaW5hbEFjdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmluYWxBY3Rpb247CiAgICAgICAgfSgpOwogICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHByb21pc2UsIHsKICAgICAgICAgIGFib3J0LAogICAgICAgICAgcmVxdWVzdElkLAogICAgICAgICAgYXJnLAogICAgICAgICAgdW53cmFwKCkgewogICAgICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKHVud3JhcFJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihhY3Rpb25DcmVhdG9yLCB7CiAgICAgIHBlbmRpbmcsCiAgICAgIHJlamVjdGVkLAogICAgICBmdWxmaWxsZWQsCiAgICAgIHNldHRsZWQ6IGlzQW55T2YocmVqZWN0ZWQsIGZ1bGZpbGxlZCksCiAgICAgIHR5cGVQcmVmaXgKICAgIH0pOwogIH0KICBjcmVhdGVBc3luY1RodW5rMi53aXRoVHlwZXMgPSAoKSA9PiBjcmVhdGVBc3luY1RodW5rMjsKICByZXR1cm4gY3JlYXRlQXN5bmNUaHVuazI7Cn0pKCk7CmZ1bmN0aW9uIHVud3JhcFJlc3VsdChhY3Rpb24pIHsKICBpZiAoYWN0aW9uLm1ldGEgJiYgYWN0aW9uLm1ldGEucmVqZWN0ZWRXaXRoVmFsdWUpIHsKICAgIHRocm93IGFjdGlvbi5wYXlsb2FkOwogIH0KICBpZiAoYWN0aW9uLmVycm9yKSB7CiAgICB0aHJvdyBhY3Rpb24uZXJyb3I7CiAgfQogIHJldHVybiBhY3Rpb24ucGF5bG9hZDsKfQpmdW5jdGlvbiBpc1RoZW5hYmxlKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHZhbHVlLnRoZW4gPT09ICJmdW5jdGlvbiI7Cn0KdmFyIGFzeW5jVGh1bmtTeW1ib2wgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcigicnRrLXNsaWNlLWNyZWF0ZWFzeW5jdGh1bmsiKTsKdmFyIGFzeW5jVGh1bmtDcmVhdG9yID0gewogIFthc3luY1RodW5rU3ltYm9sXTogY3JlYXRlQXN5bmNUaHVuawp9OwpmdW5jdGlvbiBnZXRUeXBlKHNsaWNlMiwgYWN0aW9uS2V5KSB7CiAgcmV0dXJuIGAke3NsaWNlMn0vJHthY3Rpb25LZXl9YDsKfQpmdW5jdGlvbiBidWlsZENyZWF0ZVNsaWNlKHsKICBjcmVhdG9ycwp9ID0ge30pIHsKICBjb25zdCBjQVQgPSBjcmVhdG9ycz8uYXN5bmNUaHVuaz8uW2FzeW5jVGh1bmtTeW1ib2xdOwogIHJldHVybiBmdW5jdGlvbiBjcmVhdGVTbGljZTIob3B0aW9ucykgewogICAgY29uc3QgewogICAgICBuYW1lLAogICAgICByZWR1Y2VyUGF0aCA9IG5hbWUKICAgIH0gPSBvcHRpb25zOwogICAgaWYgKCFuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTEpIDogImBuYW1lYCBpcyBhIHJlcXVpcmVkIG9wdGlvbiBmb3IgY3JlYXRlU2xpY2UiKTsKICAgIH0KICAgIGlmICh0eXBlb2YgcHJvY2VzcyAhPT0gInVuZGVmaW5lZCIgJiYgdHJ1ZSkgewogICAgICBpZiAob3B0aW9ucy5pbml0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIllvdSBtdXN0IHByb3ZpZGUgYW4gYGluaXRpYWxTdGF0ZWAgdmFsdWUgdGhhdCBpcyBub3QgYHVuZGVmaW5lZGAuIFlvdSBtYXkgaGF2ZSBtaXNzcGVsbGVkIGBpbml0aWFsU3RhdGVgIik7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlZHVjZXJzID0gKHR5cGVvZiBvcHRpb25zLnJlZHVjZXJzID09PSAiZnVuY3Rpb24iID8gb3B0aW9ucy5yZWR1Y2VycyhidWlsZFJlZHVjZXJDcmVhdG9ycygpKSA6IG9wdGlvbnMucmVkdWNlcnMpIHx8IHt9OwogICAgY29uc3QgcmVkdWNlck5hbWVzID0gT2JqZWN0LmtleXMocmVkdWNlcnMpOwogICAgY29uc3QgY29udGV4dCA9IHsKICAgICAgc2xpY2VDYXNlUmVkdWNlcnNCeU5hbWU6IHt9LAogICAgICBzbGljZUNhc2VSZWR1Y2Vyc0J5VHlwZToge30sCiAgICAgIGFjdGlvbkNyZWF0b3JzOiB7fSwKICAgICAgc2xpY2VNYXRjaGVyczogW10KICAgIH07CiAgICBjb25zdCBjb250ZXh0TWV0aG9kcyA9IHsKICAgICAgYWRkQ2FzZSh0eXBlT3JBY3Rpb25DcmVhdG9yLCByZWR1Y2VyMikgewogICAgICAgIGNvbnN0IHR5cGUgPSB0eXBlb2YgdHlwZU9yQWN0aW9uQ3JlYXRvciA9PT0gInN0cmluZyIgPyB0eXBlT3JBY3Rpb25DcmVhdG9yIDogdHlwZU9yQWN0aW9uQ3JlYXRvci50eXBlOwogICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMikgOiAiYGNvbnRleHQuYWRkQ2FzZWAgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGFuIGVtcHR5IGFjdGlvbiB0eXBlIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlIGluIGNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTMpIDogImBjb250ZXh0LmFkZENhc2VgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCB0d28gcmVkdWNlcnMgZm9yIHRoZSBzYW1lIGFjdGlvbiB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgfQogICAgICAgIGNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGVbdHlwZV0gPSByZWR1Y2VyMjsKICAgICAgICByZXR1cm4gY29udGV4dE1ldGhvZHM7CiAgICAgIH0sCiAgICAgIGFkZE1hdGNoZXIobWF0Y2hlciwgcmVkdWNlcjIpIHsKICAgICAgICBjb250ZXh0LnNsaWNlTWF0Y2hlcnMucHVzaCh7CiAgICAgICAgICBtYXRjaGVyLAogICAgICAgICAgcmVkdWNlcjogcmVkdWNlcjIKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY29udGV4dE1ldGhvZHM7CiAgICAgIH0sCiAgICAgIGV4cG9zZUFjdGlvbihuYW1lMiwgYWN0aW9uQ3JlYXRvcikgewogICAgICAgIGNvbnRleHQuYWN0aW9uQ3JlYXRvcnNbbmFtZTJdID0gYWN0aW9uQ3JlYXRvcjsKICAgICAgICByZXR1cm4gY29udGV4dE1ldGhvZHM7CiAgICAgIH0sCiAgICAgIGV4cG9zZUNhc2VSZWR1Y2VyKG5hbWUyLCByZWR1Y2VyMikgewogICAgICAgIGNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeU5hbWVbbmFtZTJdID0gcmVkdWNlcjI7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9CiAgICB9OwogICAgcmVkdWNlck5hbWVzLmZvckVhY2goKHJlZHVjZXJOYW1lKSA9PiB7CiAgICAgIGNvbnN0IHJlZHVjZXJEZWZpbml0aW9uID0gcmVkdWNlcnNbcmVkdWNlck5hbWVdOwogICAgICBjb25zdCByZWR1Y2VyRGV0YWlscyA9IHsKICAgICAgICByZWR1Y2VyTmFtZSwKICAgICAgICB0eXBlOiBnZXRUeXBlKG5hbWUsIHJlZHVjZXJOYW1lKSwKICAgICAgICBjcmVhdGVOb3RhdGlvbjogdHlwZW9mIG9wdGlvbnMucmVkdWNlcnMgPT09ICJmdW5jdGlvbiIKICAgICAgfTsKICAgICAgaWYgKGlzQXN5bmNUaHVua1NsaWNlUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRlZmluaXRpb24pKSB7CiAgICAgICAgaGFuZGxlVGh1bmtDYXNlUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRldGFpbHMsIHJlZHVjZXJEZWZpbml0aW9uLCBjb250ZXh0TWV0aG9kcywgY0FUKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBoYW5kbGVOb3JtYWxSZWR1Y2VyRGVmaW5pdGlvbihyZWR1Y2VyRGV0YWlscywgcmVkdWNlckRlZmluaXRpb24sIGNvbnRleHRNZXRob2RzKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBidWlsZFJlZHVjZXIoKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmV4dHJhUmVkdWNlcnMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE0KSA6ICJUaGUgb2JqZWN0IG5vdGF0aW9uIGZvciBgY3JlYXRlU2xpY2UuZXh0cmFSZWR1Y2Vyc2AgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHVzZSB0aGUgJ2J1aWxkZXIgY2FsbGJhY2snIG5vdGF0aW9uIGluc3RlYWQ6IGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvYXBpL2NyZWF0ZVNsaWNlIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IFtleHRyYVJlZHVjZXJzID0ge30sIGFjdGlvbk1hdGNoZXJzID0gW10sIGRlZmF1bHRDYXNlUmVkdWNlciA9IHZvaWQgMF0gPSB0eXBlb2Ygb3B0aW9ucy5leHRyYVJlZHVjZXJzID09PSAiZnVuY3Rpb24iID8gZXhlY3V0ZVJlZHVjZXJCdWlsZGVyQ2FsbGJhY2sob3B0aW9ucy5leHRyYVJlZHVjZXJzKSA6IFtvcHRpb25zLmV4dHJhUmVkdWNlcnNdOwogICAgICBjb25zdCBmaW5hbENhc2VSZWR1Y2VycyA9IHsKICAgICAgICAuLi5leHRyYVJlZHVjZXJzLAogICAgICAgIC4uLmNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGUKICAgICAgfTsKICAgICAgcmV0dXJuIGNyZWF0ZVJlZHVjZXIob3B0aW9ucy5pbml0aWFsU3RhdGUsIChidWlsZGVyKSA9PiB7CiAgICAgICAgZm9yIChsZXQga2V5IGluIGZpbmFsQ2FzZVJlZHVjZXJzKSB7CiAgICAgICAgICBidWlsZGVyLmFkZENhc2Uoa2V5LCBmaW5hbENhc2VSZWR1Y2Vyc1trZXldKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgc00gb2YgY29udGV4dC5zbGljZU1hdGNoZXJzKSB7CiAgICAgICAgICBidWlsZGVyLmFkZE1hdGNoZXIoc00ubWF0Y2hlciwgc00ucmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IG0gb2YgYWN0aW9uTWF0Y2hlcnMpIHsKICAgICAgICAgIGJ1aWxkZXIuYWRkTWF0Y2hlcihtLm1hdGNoZXIsIG0ucmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIGJ1aWxkZXIuYWRkRGVmYXVsdENhc2UoZGVmYXVsdENhc2VSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgc2VsZWN0U2VsZiA9IChzdGF0ZSkgPT4gc3RhdGU7CiAgICBjb25zdCBpbmplY3RlZFNlbGVjdG9yQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29uc3QgaW5qZWN0ZWRTdGF0ZUNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgICBsZXQgX3JlZHVjZXI7CiAgICBmdW5jdGlvbiByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgaWYgKCFfcmVkdWNlcikgX3JlZHVjZXIgPSBidWlsZFJlZHVjZXIoKTsKICAgICAgcmV0dXJuIF9yZWR1Y2VyKHN0YXRlLCBhY3Rpb24pOwogICAgfQogICAgZnVuY3Rpb24gZ2V0SW5pdGlhbFN0YXRlKCkgewogICAgICBpZiAoIV9yZWR1Y2VyKSBfcmVkdWNlciA9IGJ1aWxkUmVkdWNlcigpOwogICAgICByZXR1cm4gX3JlZHVjZXIuZ2V0SW5pdGlhbFN0YXRlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBtYWtlU2VsZWN0b3JQcm9wcyhyZWR1Y2VyUGF0aDIsIGluamVjdGVkID0gZmFsc2UpIHsKICAgICAgZnVuY3Rpb24gc2VsZWN0U2xpY2Uoc3RhdGUpIHsKICAgICAgICBsZXQgc2xpY2VTdGF0ZSA9IHN0YXRlW3JlZHVjZXJQYXRoMl07CiAgICAgICAgaWYgKHR5cGVvZiBzbGljZVN0YXRlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgaWYgKGluamVjdGVkKSB7CiAgICAgICAgICAgIHNsaWNlU3RhdGUgPSBnZXRPckluc2VydENvbXB1dGVkKGluamVjdGVkU3RhdGVDYWNoZSwgc2VsZWN0U2xpY2UsIGdldEluaXRpYWxTdGF0ZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRydWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNSkgOiAic2VsZWN0U2xpY2UgcmV0dXJuZWQgdW5kZWZpbmVkIGZvciBhbiB1bmluamVjdGVkIHNsaWNlIHJlZHVjZXIiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNsaWNlU3RhdGU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0b3JzKHNlbGVjdFN0YXRlID0gc2VsZWN0U2VsZikgewogICAgICAgIGNvbnN0IHNlbGVjdG9yQ2FjaGUgPSBnZXRPckluc2VydENvbXB1dGVkKGluamVjdGVkU2VsZWN0b3JDYWNoZSwgaW5qZWN0ZWQsICgpID0+IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpKTsKICAgICAgICByZXR1cm4gZ2V0T3JJbnNlcnRDb21wdXRlZChzZWxlY3RvckNhY2hlLCBzZWxlY3RTdGF0ZSwgKCkgPT4gewogICAgICAgICAgY29uc3QgbWFwMyA9IHt9OwogICAgICAgICAgZm9yIChjb25zdCBbbmFtZTIsIHNlbGVjdG9yXSBvZiBPYmplY3QuZW50cmllcyhvcHRpb25zLnNlbGVjdG9ycyA/PyB7fSkpIHsKICAgICAgICAgICAgbWFwM1tuYW1lMl0gPSB3cmFwU2VsZWN0b3Ioc2VsZWN0b3IsIHNlbGVjdFN0YXRlLCAoKSA9PiBnZXRPckluc2VydENvbXB1dGVkKGluamVjdGVkU3RhdGVDYWNoZSwgc2VsZWN0U3RhdGUsIGdldEluaXRpYWxTdGF0ZSksIGluamVjdGVkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXAzOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVkdWNlclBhdGg6IHJlZHVjZXJQYXRoMiwKICAgICAgICBnZXRTZWxlY3RvcnMsCiAgICAgICAgZ2V0IHNlbGVjdG9ycygpIHsKICAgICAgICAgIHJldHVybiBnZXRTZWxlY3RvcnMoc2VsZWN0U2xpY2UpOwogICAgICAgIH0sCiAgICAgICAgc2VsZWN0U2xpY2UKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHNsaWNlMiA9IHsKICAgICAgbmFtZSwKICAgICAgcmVkdWNlciwKICAgICAgYWN0aW9uczogY29udGV4dC5hY3Rpb25DcmVhdG9ycywKICAgICAgY2FzZVJlZHVjZXJzOiBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlOYW1lLAogICAgICBnZXRJbml0aWFsU3RhdGUsCiAgICAgIC4uLm1ha2VTZWxlY3RvclByb3BzKHJlZHVjZXJQYXRoKSwKICAgICAgaW5qZWN0SW50byhpbmplY3RhYmxlLCB7CiAgICAgICAgcmVkdWNlclBhdGg6IHBhdGhPcHQsCiAgICAgICAgLi4uY29uZmlnCiAgICAgIH0gPSB7fSkgewogICAgICAgIGNvbnN0IG5ld1JlZHVjZXJQYXRoID0gcGF0aE9wdCA/PyByZWR1Y2VyUGF0aDsKICAgICAgICBpbmplY3RhYmxlLmluamVjdCh7CiAgICAgICAgICByZWR1Y2VyUGF0aDogbmV3UmVkdWNlclBhdGgsCiAgICAgICAgICByZWR1Y2VyCiAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgLi4uc2xpY2UyLAogICAgICAgICAgLi4ubWFrZVNlbGVjdG9yUHJvcHMobmV3UmVkdWNlclBhdGgsIHRydWUpCiAgICAgICAgfTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiBzbGljZTI7CiAgfTsKfQpmdW5jdGlvbiB3cmFwU2VsZWN0b3Ioc2VsZWN0b3IsIHNlbGVjdFN0YXRlLCBnZXRJbml0aWFsU3RhdGUsIGluamVjdGVkKSB7CiAgZnVuY3Rpb24gd3JhcHBlcihyb290U3RhdGUsIC4uLmFyZ3MpIHsKICAgIGxldCBzbGljZVN0YXRlID0gc2VsZWN0U3RhdGUocm9vdFN0YXRlKTsKICAgIGlmICh0eXBlb2Ygc2xpY2VTdGF0ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgaWYgKGluamVjdGVkKSB7CiAgICAgICAgc2xpY2VTdGF0ZSA9IGdldEluaXRpYWxTdGF0ZSgpOwogICAgICB9IGVsc2UgaWYgKHRydWUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE2KSA6ICJzZWxlY3RTdGF0ZSByZXR1cm5lZCB1bmRlZmluZWQgZm9yIGFuIHVuaW5qZWN0ZWQgc2xpY2UgcmVkdWNlciIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2VsZWN0b3Ioc2xpY2VTdGF0ZSwgLi4uYXJncyk7CiAgfQogIHdyYXBwZXIudW53cmFwcGVkID0gc2VsZWN0b3I7CiAgcmV0dXJuIHdyYXBwZXI7Cn0KdmFyIGNyZWF0ZVNsaWNlID0gLyogQF9fUFVSRV9fICovIGJ1aWxkQ3JlYXRlU2xpY2UoKTsKZnVuY3Rpb24gYnVpbGRSZWR1Y2VyQ3JlYXRvcnMoKSB7CiAgZnVuY3Rpb24gYXN5bmNUaHVuayhwYXlsb2FkQ3JlYXRvciwgY29uZmlnKSB7CiAgICByZXR1cm4gewogICAgICBfcmVkdWNlckRlZmluaXRpb25UeXBlOiAiYXN5bmNUaHVuayIsCiAgICAgIHBheWxvYWRDcmVhdG9yLAogICAgICAuLi5jb25maWcKICAgIH07CiAgfQogIGFzeW5jVGh1bmsud2l0aFR5cGVzID0gKCkgPT4gYXN5bmNUaHVuazsKICByZXR1cm4gewogICAgcmVkdWNlcihjYXNlUmVkdWNlcikgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7CiAgICAgICAgLy8gaGFjayBzbyB0aGUgd3JhcHBpbmcgZnVuY3Rpb24gaGFzIHRoZSBzYW1lIG5hbWUgYXMgdGhlIG9yaWdpbmFsCiAgICAgICAgLy8gd2UgbmVlZCB0byBjcmVhdGUgYSB3cmFwcGVyIHNvIHRoZSBgcmVkdWNlckRlZmluaXRpb25UeXBlYCBpcyBub3QgYXNzaWduZWQgdG8gdGhlIG9yaWdpbmFsCiAgICAgICAgW2Nhc2VSZWR1Y2VyLm5hbWVdKC4uLmFyZ3MpIHsKICAgICAgICAgIHJldHVybiBjYXNlUmVkdWNlciguLi5hcmdzKTsKICAgICAgICB9CiAgICAgIH1bY2FzZVJlZHVjZXIubmFtZV0sIHsKICAgICAgICBfcmVkdWNlckRlZmluaXRpb25UeXBlOiAicmVkdWNlciIKICAgICAgICAvKiByZWR1Y2VyICovCiAgICAgIH0pOwogICAgfSwKICAgIHByZXBhcmVkUmVkdWNlcihwcmVwYXJlLCByZWR1Y2VyKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgX3JlZHVjZXJEZWZpbml0aW9uVHlwZTogInJlZHVjZXJXaXRoUHJlcGFyZSIsCiAgICAgICAgcHJlcGFyZSwKICAgICAgICByZWR1Y2VyCiAgICAgIH07CiAgICB9LAogICAgYXN5bmNUaHVuawogIH07Cn0KZnVuY3Rpb24gaGFuZGxlTm9ybWFsUmVkdWNlckRlZmluaXRpb24oewogIHR5cGUsCiAgcmVkdWNlck5hbWUsCiAgY3JlYXRlTm90YXRpb24KfSwgbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUsIGNvbnRleHQpIHsKICBsZXQgY2FzZVJlZHVjZXI7CiAgbGV0IHByZXBhcmVDYWxsYmFjazsKICBpZiAoInJlZHVjZXIiIGluIG1heWJlUmVkdWNlcldpdGhQcmVwYXJlKSB7CiAgICBpZiAoY3JlYXRlTm90YXRpb24gJiYgIWlzQ2FzZVJlZHVjZXJXaXRoUHJlcGFyZURlZmluaXRpb24obWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTcpIDogIlBsZWFzZSB1c2UgdGhlIGBjcmVhdGUucHJlcGFyZWRSZWR1Y2VyYCBub3RhdGlvbiBmb3IgcHJlcGFyZWQgYWN0aW9uIGNyZWF0b3JzIHdpdGggdGhlIGBjcmVhdGVgIG5vdGF0aW9uLiIpOwogICAgfQogICAgY2FzZVJlZHVjZXIgPSBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZS5yZWR1Y2VyOwogICAgcHJlcGFyZUNhbGxiYWNrID0gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUucHJlcGFyZTsKICB9IGVsc2UgewogICAgY2FzZVJlZHVjZXIgPSBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZTsKICB9CiAgY29udGV4dC5hZGRDYXNlKHR5cGUsIGNhc2VSZWR1Y2VyKS5leHBvc2VDYXNlUmVkdWNlcihyZWR1Y2VyTmFtZSwgY2FzZVJlZHVjZXIpLmV4cG9zZUFjdGlvbihyZWR1Y2VyTmFtZSwgcHJlcGFyZUNhbGxiYWNrID8gY3JlYXRlQWN0aW9uKHR5cGUsIHByZXBhcmVDYWxsYmFjaykgOiBjcmVhdGVBY3Rpb24odHlwZSkpOwp9CmZ1bmN0aW9uIGlzQXN5bmNUaHVua1NsaWNlUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRlZmluaXRpb24pIHsKICByZXR1cm4gcmVkdWNlckRlZmluaXRpb24uX3JlZHVjZXJEZWZpbml0aW9uVHlwZSA9PT0gImFzeW5jVGh1bmsiOwp9CmZ1bmN0aW9uIGlzQ2FzZVJlZHVjZXJXaXRoUHJlcGFyZURlZmluaXRpb24ocmVkdWNlckRlZmluaXRpb24pIHsKICByZXR1cm4gcmVkdWNlckRlZmluaXRpb24uX3JlZHVjZXJEZWZpbml0aW9uVHlwZSA9PT0gInJlZHVjZXJXaXRoUHJlcGFyZSI7Cn0KZnVuY3Rpb24gaGFuZGxlVGh1bmtDYXNlUmVkdWNlckRlZmluaXRpb24oewogIHR5cGUsCiAgcmVkdWNlck5hbWUKfSwgcmVkdWNlckRlZmluaXRpb24sIGNvbnRleHQsIGNBVCkgewogIGlmICghY0FUKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE4KSA6ICJDYW5ub3QgdXNlIGBjcmVhdGUuYXN5bmNUaHVua2AgaW4gdGhlIGJ1aWx0LWluIGBjcmVhdGVTbGljZWAuIFVzZSBgYnVpbGRDcmVhdGVTbGljZSh7IGNyZWF0b3JzOiB7IGFzeW5jVGh1bms6IGFzeW5jVGh1bmtDcmVhdG9yIH0gfSlgIHRvIGNyZWF0ZSBhIGN1c3RvbWlzZWQgdmVyc2lvbiBvZiBgY3JlYXRlU2xpY2VgLiIpOwogIH0KICBjb25zdCB7CiAgICBwYXlsb2FkQ3JlYXRvciwKICAgIGZ1bGZpbGxlZCwKICAgIHBlbmRpbmcsCiAgICByZWplY3RlZCwKICAgIHNldHRsZWQsCiAgICBvcHRpb25zCiAgfSA9IHJlZHVjZXJEZWZpbml0aW9uOwogIGNvbnN0IHRodW5rMiA9IGNBVCh0eXBlLCBwYXlsb2FkQ3JlYXRvciwgb3B0aW9ucyk7CiAgY29udGV4dC5leHBvc2VBY3Rpb24ocmVkdWNlck5hbWUsIHRodW5rMik7CiAgaWYgKGZ1bGZpbGxlZCkgewogICAgY29udGV4dC5hZGRDYXNlKHRodW5rMi5mdWxmaWxsZWQsIGZ1bGZpbGxlZCk7CiAgfQogIGlmIChwZW5kaW5nKSB7CiAgICBjb250ZXh0LmFkZENhc2UodGh1bmsyLnBlbmRpbmcsIHBlbmRpbmcpOwogIH0KICBpZiAocmVqZWN0ZWQpIHsKICAgIGNvbnRleHQuYWRkQ2FzZSh0aHVuazIucmVqZWN0ZWQsIHJlamVjdGVkKTsKICB9CiAgaWYgKHNldHRsZWQpIHsKICAgIGNvbnRleHQuYWRkTWF0Y2hlcih0aHVuazIuc2V0dGxlZCwgc2V0dGxlZCk7CiAgfQogIGNvbnRleHQuZXhwb3NlQ2FzZVJlZHVjZXIocmVkdWNlck5hbWUsIHsKICAgIGZ1bGZpbGxlZDogZnVsZmlsbGVkIHx8IG5vb3AzLAogICAgcGVuZGluZzogcGVuZGluZyB8fCBub29wMywKICAgIHJlamVjdGVkOiByZWplY3RlZCB8fCBub29wMywKICAgIHNldHRsZWQ6IHNldHRsZWQgfHwgbm9vcDMKICB9KTsKfQpmdW5jdGlvbiBub29wMygpIHsKfQp2YXIgdGFzayA9ICJ0YXNrIjsKdmFyIGxpc3RlbmVyID0gImxpc3RlbmVyIjsKdmFyIGNvbXBsZXRlZCA9ICJjb21wbGV0ZWQiOwp2YXIgY2FuY2VsbGVkID0gImNhbmNlbGxlZCI7CnZhciB0YXNrQ2FuY2VsbGVkID0gYHRhc2stJHtjYW5jZWxsZWR9YDsKdmFyIHRhc2tDb21wbGV0ZWQgPSBgdGFzay0ke2NvbXBsZXRlZH1gOwp2YXIgbGlzdGVuZXJDYW5jZWxsZWQgPSBgJHtsaXN0ZW5lcn0tJHtjYW5jZWxsZWR9YDsKdmFyIGxpc3RlbmVyQ29tcGxldGVkID0gYCR7bGlzdGVuZXJ9LSR7Y29tcGxldGVkfWA7CnZhciBUYXNrQWJvcnRFcnJvciA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb2RlKSB7CiAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgdGhpcy5tZXNzYWdlID0gYCR7dGFza30gJHtjYW5jZWxsZWR9IChyZWFzb246ICR7Y29kZX0pYDsKICB9CiAgbmFtZSA9ICJUYXNrQWJvcnRFcnJvciI7CiAgbWVzc2FnZTsKfTsKdmFyIGFzc2VydEZ1bmN0aW9uID0gKGZ1bmMsIGV4cGVjdGVkKSA9PiB7CiAgaWYgKHR5cGVvZiBmdW5jICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzMikgOiBgJHtleHBlY3RlZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKICB9Cn07CnZhciBub29wMjIgPSAoKSA9PiB7Cn07CnZhciBjYXRjaFJlamVjdGlvbiA9IChwcm9taXNlLCBvbkVycm9yID0gbm9vcDIyKSA9PiB7CiAgcHJvbWlzZS5jYXRjaChvbkVycm9yKTsKICByZXR1cm4gcHJvbWlzZTsKfTsKdmFyIGFkZEFib3J0U2lnbmFsTGlzdGVuZXIgPSAoYWJvcnRTaWduYWwsIGNhbGxiYWNrKSA9PiB7CiAgYWJvcnRTaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBjYWxsYmFjaywgewogICAgb25jZTogdHJ1ZQogIH0pOwogIHJldHVybiAoKSA9PiBhYm9ydFNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCJhYm9ydCIsIGNhbGxiYWNrKTsKfTsKdmFyIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24gPSAoYWJvcnRDb250cm9sbGVyLCByZWFzb24pID0+IHsKICBjb25zdCBzaWduYWwgPSBhYm9ydENvbnRyb2xsZXIuc2lnbmFsOwogIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgcmV0dXJuOwogIH0KICBpZiAoISgicmVhc29uIiBpbiBzaWduYWwpKSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc2lnbmFsLCAicmVhc29uIiwgewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZTogcmVhc29uLAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICB9KTsKICB9CiAgOwogIGFib3J0Q29udHJvbGxlci5hYm9ydChyZWFzb24pOwp9Owp2YXIgdmFsaWRhdGVBY3RpdmUgPSAoc2lnbmFsKSA9PiB7CiAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICBjb25zdCB7CiAgICAgIHJlYXNvbgogICAgfSA9IHNpZ25hbDsKICAgIHRocm93IG5ldyBUYXNrQWJvcnRFcnJvcihyZWFzb24pOwogIH0KfTsKZnVuY3Rpb24gcmFjZVdpdGhTaWduYWwoc2lnbmFsLCBwcm9taXNlKSB7CiAgbGV0IGNsZWFudXAgPSBub29wMjI7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGNvbnN0IG5vdGlmeVJlamVjdGlvbiA9ICgpID0+IHJlamVjdChuZXcgVGFza0Fib3J0RXJyb3Ioc2lnbmFsLnJlYXNvbikpOwogICAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICAgIG5vdGlmeVJlamVjdGlvbigpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjbGVhbnVwID0gYWRkQWJvcnRTaWduYWxMaXN0ZW5lcihzaWduYWwsIG5vdGlmeVJlamVjdGlvbik7CiAgICBwcm9taXNlLmZpbmFsbHkoKCkgPT4gY2xlYW51cCgpKS50aGVuKHJlc29sdmUsIHJlamVjdCk7CiAgfSkuZmluYWxseSgoKSA9PiB7CiAgICBjbGVhbnVwID0gbm9vcDIyOwogIH0pOwp9CnZhciBydW5UYXNrID0gYXN5bmMgKHRhc2syLCBjbGVhblVwKSA9PiB7CiAgdHJ5IHsKICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpOwogICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0YXNrMigpOwogICAgcmV0dXJuIHsKICAgICAgc3RhdHVzOiAib2siLAogICAgICB2YWx1ZQogICAgfTsKICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIHsKICAgICAgc3RhdHVzOiBlcnJvciBpbnN0YW5jZW9mIFRhc2tBYm9ydEVycm9yID8gImNhbmNlbGxlZCIgOiAicmVqZWN0ZWQiLAogICAgICBlcnJvcgogICAgfTsKICB9IGZpbmFsbHkgewogICAgY2xlYW5VcD8uKCk7CiAgfQp9Owp2YXIgY3JlYXRlUGF1c2UgPSAoc2lnbmFsKSA9PiB7CiAgcmV0dXJuIChwcm9taXNlKSA9PiB7CiAgICByZXR1cm4gY2F0Y2hSZWplY3Rpb24ocmFjZVdpdGhTaWduYWwoc2lnbmFsLCBwcm9taXNlKS50aGVuKChvdXRwdXQpID0+IHsKICAgICAgdmFsaWRhdGVBY3RpdmUoc2lnbmFsKTsKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0pKTsKICB9Owp9Owp2YXIgY3JlYXRlRGVsYXkgPSAoc2lnbmFsKSA9PiB7CiAgY29uc3QgcGF1c2UgPSBjcmVhdGVQYXVzZShzaWduYWwpOwogIHJldHVybiAodGltZW91dE1zKSA9PiB7CiAgICByZXR1cm4gcGF1c2UobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGltZW91dE1zKSkpOwogIH07Cn07CnZhciB7CiAgYXNzaWduCn0gPSBPYmplY3Q7CnZhciBJTlRFUk5BTF9OSUxfVE9LRU4gPSB7fTsKdmFyIGFsbSA9ICJsaXN0ZW5lck1pZGRsZXdhcmUiOwp2YXIgY3JlYXRlRm9yayA9IChwYXJlbnRBYm9ydFNpZ25hbCwgcGFyZW50QmxvY2tpbmdQcm9taXNlcykgPT4gewogIGNvbnN0IGxpbmtDb250cm9sbGVycyA9IChjb250cm9sbGVyKSA9PiBhZGRBYm9ydFNpZ25hbExpc3RlbmVyKHBhcmVudEFib3J0U2lnbmFsLCAoKSA9PiBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNvbnRyb2xsZXIsIHBhcmVudEFib3J0U2lnbmFsLnJlYXNvbikpOwogIHJldHVybiAodGFza0V4ZWN1dG9yLCBvcHRzKSA9PiB7CiAgICBhc3NlcnRGdW5jdGlvbih0YXNrRXhlY3V0b3IsICJ0YXNrRXhlY3V0b3IiKTsKICAgIGNvbnN0IGNoaWxkQWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgbGlua0NvbnRyb2xsZXJzKGNoaWxkQWJvcnRDb250cm9sbGVyKTsKICAgIGNvbnN0IHJlc3VsdCA9IHJ1blRhc2soYXN5bmMgKCkgPT4gewogICAgICB2YWxpZGF0ZUFjdGl2ZShwYXJlbnRBYm9ydFNpZ25hbCk7CiAgICAgIHZhbGlkYXRlQWN0aXZlKGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbCk7CiAgICAgIGNvbnN0IHJlc3VsdDIgPSBhd2FpdCB0YXNrRXhlY3V0b3IoewogICAgICAgIHBhdXNlOiBjcmVhdGVQYXVzZShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpLAogICAgICAgIGRlbGF5OiBjcmVhdGVEZWxheShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpLAogICAgICAgIHNpZ25hbDogY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsCiAgICAgIH0pOwogICAgICB2YWxpZGF0ZUFjdGl2ZShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpOwogICAgICByZXR1cm4gcmVzdWx0MjsKICAgIH0sICgpID0+IGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY2hpbGRBYm9ydENvbnRyb2xsZXIsIHRhc2tDb21wbGV0ZWQpKTsKICAgIGlmIChvcHRzPy5hdXRvSm9pbikgewogICAgICBwYXJlbnRCbG9ja2luZ1Byb21pc2VzLnB1c2gocmVzdWx0LmNhdGNoKG5vb3AyMikpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcmVzdWx0OiBjcmVhdGVQYXVzZShwYXJlbnRBYm9ydFNpZ25hbCkocmVzdWx0KSwKICAgICAgY2FuY2VsKCkgewogICAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY2hpbGRBYm9ydENvbnRyb2xsZXIsIHRhc2tDYW5jZWxsZWQpOwogICAgICB9CiAgICB9OwogIH07Cn07CnZhciBjcmVhdGVUYWtlUGF0dGVybiA9IChzdGFydExpc3RlbmluZywgc2lnbmFsKSA9PiB7CiAgY29uc3QgdGFrZSA9IGFzeW5jIChwcmVkaWNhdGUsIHRpbWVvdXQpID0+IHsKICAgIHZhbGlkYXRlQWN0aXZlKHNpZ25hbCk7CiAgICBsZXQgdW5zdWJzY3JpYmUgPSAoKSA9PiB7CiAgICB9OwogICAgY29uc3QgdHVwbGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBsZXQgc3RvcExpc3RlbmluZyA9IHN0YXJ0TGlzdGVuaW5nKHsKICAgICAgICBwcmVkaWNhdGUsCiAgICAgICAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgICAgICAgbGlzdGVuZXJBcGkudW5zdWJzY3JpYmUoKTsKICAgICAgICAgIHJlc29sdmUoW2FjdGlvbiwgbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKSwgbGlzdGVuZXJBcGkuZ2V0T3JpZ2luYWxTdGF0ZSgpXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdW5zdWJzY3JpYmUgPSAoKSA9PiB7CiAgICAgICAgc3RvcExpc3RlbmluZygpOwogICAgICAgIHJlamVjdCgpOwogICAgICB9OwogICAgfSk7CiAgICBjb25zdCBwcm9taXNlcyA9IFt0dXBsZVByb21pc2VdOwogICAgaWYgKHRpbWVvdXQgIT0gbnVsbCkgewogICAgICBwcm9taXNlcy5wdXNoKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQsIG51bGwpKSk7CiAgICB9CiAgICB0cnkgewogICAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCByYWNlV2l0aFNpZ25hbChzaWduYWwsIFByb21pc2UucmFjZShwcm9taXNlcykpOwogICAgICB2YWxpZGF0ZUFjdGl2ZShzaWduYWwpOwogICAgICByZXR1cm4gb3V0cHV0OwogICAgfSBmaW5hbGx5IHsKICAgICAgdW5zdWJzY3JpYmUoKTsKICAgIH0KICB9OwogIHJldHVybiAocHJlZGljYXRlLCB0aW1lb3V0KSA9PiBjYXRjaFJlamVjdGlvbih0YWtlKHByZWRpY2F0ZSwgdGltZW91dCkpOwp9Owp2YXIgZ2V0TGlzdGVuZXJFbnRyeVByb3BzRnJvbSA9IChvcHRpb25zKSA9PiB7CiAgbGV0IHsKICAgIHR5cGUsCiAgICBhY3Rpb25DcmVhdG9yLAogICAgbWF0Y2hlciwKICAgIHByZWRpY2F0ZSwKICAgIGVmZmVjdAogIH0gPSBvcHRpb25zOwogIGlmICh0eXBlKSB7CiAgICBwcmVkaWNhdGUgPSBjcmVhdGVBY3Rpb24odHlwZSkubWF0Y2g7CiAgfSBlbHNlIGlmIChhY3Rpb25DcmVhdG9yKSB7CiAgICB0eXBlID0gYWN0aW9uQ3JlYXRvci50eXBlOwogICAgcHJlZGljYXRlID0gYWN0aW9uQ3JlYXRvci5tYXRjaDsKICB9IGVsc2UgaWYgKG1hdGNoZXIpIHsKICAgIHByZWRpY2F0ZSA9IG1hdGNoZXI7CiAgfSBlbHNlIGlmIChwcmVkaWNhdGUpIHsKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMSkgOiAiQ3JlYXRpbmcgb3IgcmVtb3ZpbmcgYSBsaXN0ZW5lciByZXF1aXJlcyBvbmUgb2YgdGhlIGtub3duIGZpZWxkcyBmb3IgbWF0Y2hpbmcgYW4gYWN0aW9uIik7CiAgfQogIGFzc2VydEZ1bmN0aW9uKGVmZmVjdCwgIm9wdGlvbnMubGlzdGVuZXIiKTsKICByZXR1cm4gewogICAgcHJlZGljYXRlLAogICAgdHlwZSwKICAgIGVmZmVjdAogIH07Cn07CnZhciBjcmVhdGVMaXN0ZW5lckVudHJ5ID0gLyogQF9fUFVSRV9fICovIGFzc2lnbigob3B0aW9ucykgPT4gewogIGNvbnN0IHsKICAgIHR5cGUsCiAgICBwcmVkaWNhdGUsCiAgICBlZmZlY3QKICB9ID0gZ2V0TGlzdGVuZXJFbnRyeVByb3BzRnJvbShvcHRpb25zKTsKICBjb25zdCBlbnRyeSA9IHsKICAgIGlkOiBuYW5vaWQoKSwKICAgIGVmZmVjdCwKICAgIHR5cGUsCiAgICBwcmVkaWNhdGUsCiAgICBwZW5kaW5nOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLAogICAgdW5zdWJzY3JpYmU6ICgpID0+IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMikgOiAiVW5zdWJzY3JpYmUgbm90IGluaXRpYWxpemVkIik7CiAgICB9CiAgfTsKICByZXR1cm4gZW50cnk7Cn0sIHsKICB3aXRoVHlwZXM6ICgpID0+IGNyZWF0ZUxpc3RlbmVyRW50cnkKfSk7CnZhciBmaW5kTGlzdGVuZXJFbnRyeSA9IChsaXN0ZW5lck1hcCwgb3B0aW9ucykgPT4gewogIGNvbnN0IHsKICAgIHR5cGUsCiAgICBlZmZlY3QsCiAgICBwcmVkaWNhdGUKICB9ID0gZ2V0TGlzdGVuZXJFbnRyeVByb3BzRnJvbShvcHRpb25zKTsKICByZXR1cm4gQXJyYXkuZnJvbShsaXN0ZW5lck1hcC52YWx1ZXMoKSkuZmluZCgoZW50cnkpID0+IHsKICAgIGNvbnN0IG1hdGNoUHJlZGljYXRlT3JUeXBlID0gdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciID8gZW50cnkudHlwZSA9PT0gdHlwZSA6IGVudHJ5LnByZWRpY2F0ZSA9PT0gcHJlZGljYXRlOwogICAgcmV0dXJuIG1hdGNoUHJlZGljYXRlT3JUeXBlICYmIGVudHJ5LmVmZmVjdCA9PT0gZWZmZWN0OwogIH0pOwp9Owp2YXIgY2FuY2VsQWN0aXZlTGlzdGVuZXJzID0gKGVudHJ5KSA9PiB7CiAgZW50cnkucGVuZGluZy5mb3JFYWNoKChjb250cm9sbGVyKSA9PiB7CiAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNvbnRyb2xsZXIsIGxpc3RlbmVyQ2FuY2VsbGVkKTsKICB9KTsKfTsKdmFyIGNyZWF0ZUNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlID0gKGxpc3RlbmVyTWFwLCBleGVjdXRpbmdMaXN0ZW5lcnMpID0+IHsKICByZXR1cm4gKCkgPT4gewogICAgZm9yIChjb25zdCBsaXN0ZW5lcjIgb2YgZXhlY3V0aW5nTGlzdGVuZXJzLmtleXMoKSkgewogICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMobGlzdGVuZXIyKTsKICAgIH0KICAgIGxpc3RlbmVyTWFwLmNsZWFyKCk7CiAgfTsKfTsKdmFyIHNhZmVseU5vdGlmeUVycm9yID0gKGVycm9ySGFuZGxlciwgZXJyb3JUb05vdGlmeSwgZXJyb3JJbmZvKSA9PiB7CiAgdHJ5IHsKICAgIGVycm9ySGFuZGxlcihlcnJvclRvTm90aWZ5LCBlcnJvckluZm8pOwogIH0gY2F0Y2ggKGVycm9ySGFuZGxlckVycm9yKSB7CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdGhyb3cgZXJyb3JIYW5kbGVyRXJyb3I7CiAgICB9LCAwKTsKICB9Cn07CnZhciBhZGRMaXN0ZW5lciA9IC8qIEBfX1BVUkVfXyAqLyBhc3NpZ24oLyogQF9fUFVSRV9fICovIGNyZWF0ZUFjdGlvbihgJHthbG19L2FkZGApLCB7CiAgd2l0aFR5cGVzOiAoKSA9PiBhZGRMaXN0ZW5lcgp9KTsKdmFyIGNsZWFyQWxsTGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIGNyZWF0ZUFjdGlvbihgJHthbG19L3JlbW92ZUFsbGApOwp2YXIgcmVtb3ZlTGlzdGVuZXIgPSAvKiBAX19QVVJFX18gKi8gYXNzaWduKC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBY3Rpb24oYCR7YWxtfS9yZW1vdmVgKSwgewogIHdpdGhUeXBlczogKCkgPT4gcmVtb3ZlTGlzdGVuZXIKfSk7CnZhciBkZWZhdWx0RXJyb3JIYW5kbGVyID0gKC4uLmFyZ3MpID0+IHsKICBjb25zb2xlLmVycm9yKGAke2FsbX0vZXJyb3JgLCAuLi5hcmdzKTsKfTsKdmFyIGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSA9IChtaWRkbGV3YXJlT3B0aW9ucyA9IHt9KSA9PiB7CiAgY29uc3QgbGlzdGVuZXJNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IGV4ZWN1dGluZ0xpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgdHJhY2tFeGVjdXRpbmdMaXN0ZW5lciA9IChlbnRyeSkgPT4gewogICAgY29uc3QgY291bnQgPSBleGVjdXRpbmdMaXN0ZW5lcnMuZ2V0KGVudHJ5KSA/PyAwOwogICAgZXhlY3V0aW5nTGlzdGVuZXJzLnNldChlbnRyeSwgY291bnQgKyAxKTsKICB9OwogIGNvbnN0IHVudHJhY2tFeGVjdXRpbmdMaXN0ZW5lciA9IChlbnRyeSkgPT4gewogICAgY29uc3QgY291bnQgPSBleGVjdXRpbmdMaXN0ZW5lcnMuZ2V0KGVudHJ5KSA/PyAxOwogICAgaWYgKGNvdW50ID09PSAxKSB7CiAgICAgIGV4ZWN1dGluZ0xpc3RlbmVycy5kZWxldGUoZW50cnkpOwogICAgfSBlbHNlIHsKICAgICAgZXhlY3V0aW5nTGlzdGVuZXJzLnNldChlbnRyeSwgY291bnQgLSAxKTsKICAgIH0KICB9OwogIGNvbnN0IHsKICAgIGV4dHJhLAogICAgb25FcnJvciA9IGRlZmF1bHRFcnJvckhhbmRsZXIKICB9ID0gbWlkZGxld2FyZU9wdGlvbnM7CiAgYXNzZXJ0RnVuY3Rpb24ob25FcnJvciwgIm9uRXJyb3IiKTsKICBjb25zdCBpbnNlcnRFbnRyeSA9IChlbnRyeSkgPT4gewogICAgZW50cnkudW5zdWJzY3JpYmUgPSAoKSA9PiBsaXN0ZW5lck1hcC5kZWxldGUoZW50cnkuaWQpOwogICAgbGlzdGVuZXJNYXAuc2V0KGVudHJ5LmlkLCBlbnRyeSk7CiAgICByZXR1cm4gKGNhbmNlbE9wdGlvbnMpID0+IHsKICAgICAgZW50cnkudW5zdWJzY3JpYmUoKTsKICAgICAgaWYgKGNhbmNlbE9wdGlvbnM/LmNhbmNlbEFjdGl2ZSkgewogICAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyhlbnRyeSk7CiAgICAgIH0KICAgIH07CiAgfTsKICBjb25zdCBzdGFydExpc3RlbmluZyA9IChvcHRpb25zKSA9PiB7CiAgICBjb25zdCBlbnRyeSA9IGZpbmRMaXN0ZW5lckVudHJ5KGxpc3RlbmVyTWFwLCBvcHRpb25zKSA/PyBjcmVhdGVMaXN0ZW5lckVudHJ5KG9wdGlvbnMpOwogICAgcmV0dXJuIGluc2VydEVudHJ5KGVudHJ5KTsKICB9OwogIGFzc2lnbihzdGFydExpc3RlbmluZywgewogICAgd2l0aFR5cGVzOiAoKSA9PiBzdGFydExpc3RlbmluZwogIH0pOwogIGNvbnN0IHN0b3BMaXN0ZW5pbmcgPSAob3B0aW9ucykgPT4gewogICAgY29uc3QgZW50cnkgPSBmaW5kTGlzdGVuZXJFbnRyeShsaXN0ZW5lck1hcCwgb3B0aW9ucyk7CiAgICBpZiAoZW50cnkpIHsKICAgICAgZW50cnkudW5zdWJzY3JpYmUoKTsKICAgICAgaWYgKG9wdGlvbnMuY2FuY2VsQWN0aXZlKSB7CiAgICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzKGVudHJ5KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuICEhZW50cnk7CiAgfTsKICBhc3NpZ24oc3RvcExpc3RlbmluZywgewogICAgd2l0aFR5cGVzOiAoKSA9PiBzdG9wTGlzdGVuaW5nCiAgfSk7CiAgY29uc3Qgbm90aWZ5TGlzdGVuZXIgPSBhc3luYyAoZW50cnksIGFjdGlvbiwgYXBpLCBnZXRPcmlnaW5hbFN0YXRlKSA9PiB7CiAgICBjb25zdCBpbnRlcm5hbFRhc2tDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3QgdGFrZSA9IGNyZWF0ZVRha2VQYXR0ZXJuKHN0YXJ0TGlzdGVuaW5nLCBpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCk7CiAgICBjb25zdCBhdXRvSm9pblByb21pc2VzID0gW107CiAgICB0cnkgewogICAgICBlbnRyeS5wZW5kaW5nLmFkZChpbnRlcm5hbFRhc2tDb250cm9sbGVyKTsKICAgICAgdHJhY2tFeGVjdXRpbmdMaXN0ZW5lcihlbnRyeSk7CiAgICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZShlbnRyeS5lZmZlY3QoCiAgICAgICAgYWN0aW9uLAogICAgICAgIC8vIFVzZSBhc3NpZ24oKSByYXRoZXIgdGhhbiAuLi4gdG8gYXZvaWQgZXh0cmEgaGVscGVyIGZ1bmN0aW9ucyBhZGRlZCB0byBidW5kbGUKICAgICAgICBhc3NpZ24oe30sIGFwaSwgewogICAgICAgICAgZ2V0T3JpZ2luYWxTdGF0ZSwKICAgICAgICAgIGNvbmRpdGlvbjogKHByZWRpY2F0ZSwgdGltZW91dCkgPT4gdGFrZShwcmVkaWNhdGUsIHRpbWVvdXQpLnRoZW4oQm9vbGVhbiksCiAgICAgICAgICB0YWtlLAogICAgICAgICAgZGVsYXk6IGNyZWF0ZURlbGF5KGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICAgIHBhdXNlOiBjcmVhdGVQYXVzZShpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgICBleHRyYSwKICAgICAgICAgIHNpZ25hbDogaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwsCiAgICAgICAgICBmb3JrOiBjcmVhdGVGb3JrKGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsLCBhdXRvSm9pblByb21pc2VzKSwKICAgICAgICAgIHVuc3Vic2NyaWJlOiBlbnRyeS51bnN1YnNjcmliZSwKICAgICAgICAgIHN1YnNjcmliZTogKCkgPT4gewogICAgICAgICAgICBsaXN0ZW5lck1hcC5zZXQoZW50cnkuaWQsIGVudHJ5KTsKICAgICAgICAgIH0sCiAgICAgICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnM6ICgpID0+IHsKICAgICAgICAgICAgZW50cnkucGVuZGluZy5mb3JFYWNoKChjb250cm9sbGVyLCBfLCBzZXQzKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGNvbnRyb2xsZXIgIT09IGludGVybmFsVGFza0NvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY29udHJvbGxlciwgbGlzdGVuZXJDYW5jZWxsZWQpOwogICAgICAgICAgICAgICAgc2V0My5kZWxldGUoY29udHJvbGxlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBjYW5jZWw6ICgpID0+IHsKICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihpbnRlcm5hbFRhc2tDb250cm9sbGVyLCBsaXN0ZW5lckNhbmNlbGxlZCk7CiAgICAgICAgICAgIGVudHJ5LnBlbmRpbmcuZGVsZXRlKGludGVybmFsVGFza0NvbnRyb2xsZXIpOwogICAgICAgICAgfSwKICAgICAgICAgIHRocm93SWZDYW5jZWxsZWQ6ICgpID0+IHsKICAgICAgICAgICAgdmFsaWRhdGVBY3RpdmUoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICkpOwogICAgfSBjYXRjaCAobGlzdGVuZXJFcnJvcikgewogICAgICBpZiAoIShsaXN0ZW5lckVycm9yIGluc3RhbmNlb2YgVGFza0Fib3J0RXJyb3IpKSB7CiAgICAgICAgc2FmZWx5Tm90aWZ5RXJyb3Iob25FcnJvciwgbGlzdGVuZXJFcnJvciwgewogICAgICAgICAgcmFpc2VkQnk6ICJlZmZlY3QiCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKGF1dG9Kb2luUHJvbWlzZXMpOwogICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGludGVybmFsVGFza0NvbnRyb2xsZXIsIGxpc3RlbmVyQ29tcGxldGVkKTsKICAgICAgdW50cmFja0V4ZWN1dGluZ0xpc3RlbmVyKGVudHJ5KTsKICAgICAgZW50cnkucGVuZGluZy5kZWxldGUoaW50ZXJuYWxUYXNrQ29udHJvbGxlcik7CiAgICB9CiAgfTsKICBjb25zdCBjbGVhckxpc3RlbmVyTWlkZGxld2FyZSA9IGNyZWF0ZUNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlKGxpc3RlbmVyTWFwLCBleGVjdXRpbmdMaXN0ZW5lcnMpOwogIGNvbnN0IG1pZGRsZXdhcmUgPSAoYXBpKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgaWYgKCFpc0FjdGlvbihhY3Rpb24pKSB7CiAgICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgICB9CiAgICBpZiAoYWRkTGlzdGVuZXIubWF0Y2goYWN0aW9uKSkgewogICAgICByZXR1cm4gc3RhcnRMaXN0ZW5pbmcoYWN0aW9uLnBheWxvYWQpOwogICAgfQogICAgaWYgKGNsZWFyQWxsTGlzdGVuZXJzLm1hdGNoKGFjdGlvbikpIHsKICAgICAgY2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHJlbW92ZUxpc3RlbmVyLm1hdGNoKGFjdGlvbikpIHsKICAgICAgcmV0dXJuIHN0b3BMaXN0ZW5pbmcoYWN0aW9uLnBheWxvYWQpOwogICAgfQogICAgbGV0IG9yaWdpbmFsU3RhdGUgPSBhcGkuZ2V0U3RhdGUoKTsKICAgIGNvbnN0IGdldE9yaWdpbmFsU3RhdGUgPSAoKSA9PiB7CiAgICAgIGlmIChvcmlnaW5hbFN0YXRlID09PSBJTlRFUk5BTF9OSUxfVE9LRU4pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIzKSA6IGAke2FsbX06IGdldE9yaWdpbmFsU3RhdGUgY2FuIG9ubHkgYmUgY2FsbGVkIHN5bmNocm9ub3VzbHlgKTsKICAgICAgfQogICAgICByZXR1cm4gb3JpZ2luYWxTdGF0ZTsKICAgIH07CiAgICBsZXQgcmVzdWx0OwogICAgdHJ5IHsKICAgICAgcmVzdWx0ID0gbmV4dChhY3Rpb24pOwogICAgICBpZiAobGlzdGVuZXJNYXAuc2l6ZSA+IDApIHsKICAgICAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBhcGkuZ2V0U3RhdGUoKTsKICAgICAgICBjb25zdCBsaXN0ZW5lckVudHJpZXMgPSBBcnJheS5mcm9tKGxpc3RlbmVyTWFwLnZhbHVlcygpKTsKICAgICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGxpc3RlbmVyRW50cmllcykgewogICAgICAgICAgbGV0IHJ1bkxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBydW5MaXN0ZW5lciA9IGVudHJ5LnByZWRpY2F0ZShhY3Rpb24sIGN1cnJlbnRTdGF0ZSwgb3JpZ2luYWxTdGF0ZSk7CiAgICAgICAgICB9IGNhdGNoIChwcmVkaWNhdGVFcnJvcikgewogICAgICAgICAgICBydW5MaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgICBzYWZlbHlOb3RpZnlFcnJvcihvbkVycm9yLCBwcmVkaWNhdGVFcnJvciwgewogICAgICAgICAgICAgIHJhaXNlZEJ5OiAicHJlZGljYXRlIgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcnVuTGlzdGVuZXIpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBub3RpZnlMaXN0ZW5lcihlbnRyeSwgYWN0aW9uLCBhcGksIGdldE9yaWdpbmFsU3RhdGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgb3JpZ2luYWxTdGF0ZSA9IElOVEVSTkFMX05JTF9UT0tFTjsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICByZXR1cm4gewogICAgbWlkZGxld2FyZSwKICAgIHN0YXJ0TGlzdGVuaW5nLAogICAgc3RvcExpc3RlbmluZywKICAgIGNsZWFyTGlzdGVuZXJzOiBjbGVhckxpc3RlbmVyTWlkZGxld2FyZQogIH07Cn07CnZhciBPUklHSU5BTF9TVEFURSA9IFN5bWJvbC5mb3IoInJ0ay1zdGF0ZS1wcm94eS1vcmlnaW5hbCIpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9sYXlvdXRTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlID0gewogIGxheW91dFR5cGU6ICJob3Jpem9udGFsIiwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgbWFyZ2luOiB7CiAgICB0b3A6IDUsCiAgICByaWdodDogNSwKICAgIGJvdHRvbTogNSwKICAgIGxlZnQ6IDUKICB9LAogIHNjYWxlOiAxCn07CnZhciBjaGFydExheW91dFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJjaGFydExheW91dCIsCiAgaW5pdGlhbFN0YXRlLAogIHJlZHVjZXJzOiB7CiAgICBzZXRMYXlvdXQoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5sYXlvdXRUeXBlID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0Q2hhcnRTaXplKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUud2lkdGggPSBhY3Rpb24ucGF5bG9hZC53aWR0aDsKICAgICAgc3RhdGUuaGVpZ2h0ID0gYWN0aW9uLnBheWxvYWQuaGVpZ2h0OwogICAgfSwKICAgIHNldE1hcmdpbihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkdG9wLCBfYWN0aW9uJHBheWxvYWQkcmlnaHQsIF9hY3Rpb24kcGF5bG9hZCRib3R0bywgX2FjdGlvbiRwYXlsb2FkJGxlZnQ7CiAgICAgIHN0YXRlLm1hcmdpbi50b3AgPSAoX2FjdGlvbiRwYXlsb2FkJHRvcCA9IGFjdGlvbi5wYXlsb2FkLnRvcCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJHRvcCAhPT0gdm9pZCAwID8gX2FjdGlvbiRwYXlsb2FkJHRvcCA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5yaWdodCA9IChfYWN0aW9uJHBheWxvYWQkcmlnaHQgPSBhY3Rpb24ucGF5bG9hZC5yaWdodCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJHJpZ2h0ICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkcmlnaHQgOiAwOwogICAgICBzdGF0ZS5tYXJnaW4uYm90dG9tID0gKF9hY3Rpb24kcGF5bG9hZCRib3R0byA9IGFjdGlvbi5wYXlsb2FkLmJvdHRvbSkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGJvdHRvICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkYm90dG8gOiAwOwogICAgICBzdGF0ZS5tYXJnaW4ubGVmdCA9IChfYWN0aW9uJHBheWxvYWQkbGVmdCA9IGFjdGlvbi5wYXlsb2FkLmxlZnQpICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCRsZWZ0ICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkbGVmdCA6IDA7CiAgICB9LAogICAgc2V0U2NhbGUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zY2FsZSA9IGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0TWFyZ2luLAogIHNldExheW91dCwKICBzZXRDaGFydFNpemUsCiAgc2V0U2NhbGUKfSA9IGNoYXJ0TGF5b3V0U2xpY2UuYWN0aW9uczsKdmFyIGNoYXJ0TGF5b3V0UmVkdWNlciA9IGNoYXJ0TGF5b3V0U2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9DaGFydFV0aWxzLmpzCnZhciBpbXBvcnRfc29ydEJ5MiA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwp2YXIgaW1wb3J0X2dldDIgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRTbGljZWQuanMKZnVuY3Rpb24gZ2V0U2xpY2VkKGFyciwgc3RhcnRJbmRleCwgZW5kSW5kZXgpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgcmV0dXJuIGFycjsKICB9CiAgaWYgKGFyciAmJiBzdGFydEluZGV4ICsgZW5kSW5kZXggIT09IDApIHsKICAgIHJldHVybiBhcnIuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXggKyAxKTsKICB9CiAgcmV0dXJuIGFycjsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NoYXJ0VXRpbHMuanMKZnVuY3Rpb24gb3duS2V5czMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZ2V0VmFsdWVCeURhdGFLZXkob2JqLCBkYXRhS2V5LCBkZWZhdWx0VmFsdWUpIHsKICBpZiAoaXNOdWxsaXNoKG9iaikgfHwgaXNOdWxsaXNoKGRhdGFLZXkpKSB7CiAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogIH0KICBpZiAoaXNOdW1PclN0cihkYXRhS2V5KSkgewogICAgcmV0dXJuICgwLCBpbXBvcnRfZ2V0Mi5kZWZhdWx0KShvYmosIGRhdGFLZXksIGRlZmF1bHRWYWx1ZSk7CiAgfQogIGlmICh0eXBlb2YgZGF0YUtleSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGRhdGFLZXkob2JqKTsKICB9CiAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKfQp2YXIgYXBwZW5kT2Zmc2V0T2ZMZWdlbmQgPSAob2Zmc2V0LCBsZWdlbmRTZXR0aW5ncywgbGVnZW5kU2l6ZSkgPT4gewogIGlmIChsZWdlbmRTZXR0aW5ncyAmJiBsZWdlbmRTaXplKSB7CiAgICB2YXIgewogICAgICB3aWR0aDogYm94V2lkdGgsCiAgICAgIGhlaWdodDogYm94SGVpZ2h0CiAgICB9ID0gbGVnZW5kU2l6ZTsKICAgIHZhciB7CiAgICAgIGFsaWduLAogICAgICB2ZXJ0aWNhbEFsaWduLAogICAgICBsYXlvdXQKICAgIH0gPSBsZWdlbmRTZXR0aW5nczsKICAgIGlmICgobGF5b3V0ID09PSAidmVydGljYWwiIHx8IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIHZlcnRpY2FsQWxpZ24gPT09ICJtaWRkbGUiKSAmJiBhbGlnbiAhPT0gImNlbnRlciIgJiYgaXNOdW1iZXIob2Zmc2V0W2FsaWduXSkpIHsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQzKF9vYmplY3RTcHJlYWQzKHt9LCBvZmZzZXQpLCB7fSwgewogICAgICAgIFthbGlnbl06IG9mZnNldFthbGlnbl0gKyAoYm94V2lkdGggfHwgMCkKICAgICAgfSk7CiAgICB9CiAgICBpZiAoKGxheW91dCA9PT0gImhvcml6b250YWwiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBhbGlnbiA9PT0gImNlbnRlciIpICYmIHZlcnRpY2FsQWxpZ24gIT09ICJtaWRkbGUiICYmIGlzTnVtYmVyKG9mZnNldFt2ZXJ0aWNhbEFsaWduXSkpIHsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQzKF9vYmplY3RTcHJlYWQzKHt9LCBvZmZzZXQpLCB7fSwgewogICAgICAgIFt2ZXJ0aWNhbEFsaWduXTogb2Zmc2V0W3ZlcnRpY2FsQWxpZ25dICsgKGJveEhlaWdodCB8fCAwKQogICAgICB9KTsKICAgIH0KICB9CiAgcmV0dXJuIG9mZnNldDsKfTsKdmFyIGlzQ2F0ZWdvcmljYWxBeGlzID0gKGxheW91dCwgYXhpc1R5cGUpID0+IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIGF4aXNUeXBlID09PSAieEF4aXMiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBheGlzVHlwZSA9PT0gInlBeGlzIiB8fCBsYXlvdXQgPT09ICJjZW50cmljIiAmJiBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgfHwgbGF5b3V0ID09PSAicmFkaWFsIiAmJiBheGlzVHlwZSA9PT0gInJhZGl1c0F4aXMiOwp2YXIgZ2V0Q29vcmRpbmF0ZXNPZkdyaWQgPSAodGlja3MyLCBtaW5WYWx1ZSwgbWF4VmFsdWUsIHN5bmNXaXRoVGlja3MpID0+IHsKICBpZiAoc3luY1dpdGhUaWNrcykgewogICAgcmV0dXJuIHRpY2tzMi5tYXAoKGVudHJ5KSA9PiBlbnRyeS5jb29yZGluYXRlKTsKICB9CiAgdmFyIGhhc01pbiwgaGFzTWF4OwogIHZhciB2YWx1ZXMgPSB0aWNrczIubWFwKChlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5LmNvb3JkaW5hdGUgPT09IG1pblZhbHVlKSB7CiAgICAgIGhhc01pbiA9IHRydWU7CiAgICB9CiAgICBpZiAoZW50cnkuY29vcmRpbmF0ZSA9PT0gbWF4VmFsdWUpIHsKICAgICAgaGFzTWF4ID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBlbnRyeS5jb29yZGluYXRlOwogIH0pOwogIGlmICghaGFzTWluKSB7CiAgICB2YWx1ZXMucHVzaChtaW5WYWx1ZSk7CiAgfQogIGlmICghaGFzTWF4KSB7CiAgICB2YWx1ZXMucHVzaChtYXhWYWx1ZSk7CiAgfQogIHJldHVybiB2YWx1ZXM7Cn07CnZhciBnZXRUaWNrc09mQXhpcyA9IChheGlzLCBpc0dyaWQsIGlzQWxsKSA9PiB7CiAgaWYgKCFheGlzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGR1cGxpY2F0ZURvbWFpbiwKICAgIHR5cGUsCiAgICByYW5nZTogcmFuZ2U0LAogICAgc2NhbGUsCiAgICByZWFsU2NhbGVUeXBlLAogICAgaXNDYXRlZ29yaWNhbCwKICAgIGNhdGVnb3JpY2FsRG9tYWluLAogICAgdGlja0NvdW50LAogICAgdGlja3M6IHRpY2tzMiwKICAgIG5pY2VUaWNrcywKICAgIGF4aXNUeXBlCiAgfSA9IGF4aXM7CiAgaWYgKCFzY2FsZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyAyIDogMjsKICB2YXIgb2Zmc2V0ID0gKGlzR3JpZCB8fCBpc0FsbCkgJiYgdHlwZSA9PT0gImNhdGVnb3J5IiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIG9mZnNldEZvckJhbmQgOiAwOwogIG9mZnNldCA9IGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgJiYgcmFuZ2U0Lmxlbmd0aCA+PSAyID8gbWF0aFNpZ24ocmFuZ2U0WzBdIC0gcmFuZ2U0WzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzR3JpZCAmJiAodGlja3MyIHx8IG5pY2VUaWNrcykpIHsKICAgIHZhciByZXN1bHQgPSAodGlja3MyIHx8IG5pY2VUaWNrcyB8fCBbXSkubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgdmFyIHNjYWxlQ29udGVudCA9IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbi5pbmRleE9mKGVudHJ5KSA6IGVudHJ5OwogICAgICByZXR1cm4gewogICAgICAgIC8vIElmIHRoZSBzY2FsZUNvbnRlbnQgaXMgbm90IGEgbnVtYmVyLCB0aGUgY29vcmRpbmF0ZSB3aWxsIGJlIE5hTi4KICAgICAgICAvLyBUaGF0IGNvdWxkIGJlIHRoZSBjYXNlIGZvciBleGFtcGxlIHdpdGggYSBQb2ludFNjYWxlIGFuZCBhIHN0cmluZyBhcyBkb21haW4uCiAgICAgICAgY29vcmRpbmF0ZTogc2NhbGUoc2NhbGVDb250ZW50KSArIG9mZnNldCwKICAgICAgICB2YWx1ZTogZW50cnksCiAgICAgICAgb2Zmc2V0LAogICAgICAgIGluZGV4CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQuZmlsdGVyKChyb3cpID0+ICFpc05hbihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICBpZiAoc2NhbGUudGlja3MgJiYgIWlzQWxsICYmIHRpY2tDb3VudCAhPSBudWxsKSB7CiAgICByZXR1cm4gc2NhbGUudGlja3ModGlja0NvdW50KS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldCwKICAgICAgaW5kZXgKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgRVBTMiA9IDFlLTQ7CnZhciBjaGVja0RvbWFpbk9mU2NhbGUgPSAoc2NhbGUpID0+IHsKICB2YXIgZG9tYWluID0gc2NhbGUuZG9tYWluKCk7CiAgaWYgKCFkb21haW4gfHwgZG9tYWluLmxlbmd0aCA8PSAyKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBsZW4gPSBkb21haW4ubGVuZ3RoOwogIHZhciByYW5nZTQgPSBzY2FsZS5yYW5nZSgpOwogIHZhciBtaW5WYWx1ZSA9IE1hdGgubWluKHJhbmdlNFswXSwgcmFuZ2U0WzFdKSAtIEVQUzI7CiAgdmFyIG1heFZhbHVlID0gTWF0aC5tYXgocmFuZ2U0WzBdLCByYW5nZTRbMV0pICsgRVBTMjsKICB2YXIgZmlyc3QgPSBzY2FsZShkb21haW5bMF0pOwogIHZhciBsYXN0MiA9IHNjYWxlKGRvbWFpbltsZW4gLSAxXSk7CiAgaWYgKGZpcnN0IDwgbWluVmFsdWUgfHwgZmlyc3QgPiBtYXhWYWx1ZSB8fCBsYXN0MiA8IG1pblZhbHVlIHx8IGxhc3QyID4gbWF4VmFsdWUpIHsKICAgIHNjYWxlLmRvbWFpbihbZG9tYWluWzBdLCBkb21haW5bbGVuIC0gMV1dKTsKICB9Cn07CnZhciBvZmZzZXRTaWduID0gKHNlcmllcykgPT4gewogIHZhciBuID0gc2VyaWVzLmxlbmd0aDsKICBpZiAobiA8PSAwKSB7CiAgICByZXR1cm47CiAgfQogIGZvciAodmFyIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aDsgaiA8IG07ICsraikgewogICAgdmFyIHBvc2l0aXZlID0gMDsKICAgIHZhciBuZWdhdGl2ZSA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YXIgdmFsdWUgPSBpc05hbihzZXJpZXNbaV1bal1bMV0pID8gc2VyaWVzW2ldW2pdWzBdIDogc2VyaWVzW2ldW2pdWzFdOwogICAgICBpZiAodmFsdWUgPj0gMCkgewogICAgICAgIHNlcmllc1tpXVtqXVswXSA9IHBvc2l0aXZlOwogICAgICAgIHNlcmllc1tpXVtqXVsxXSA9IHBvc2l0aXZlICsgdmFsdWU7CiAgICAgICAgcG9zaXRpdmUgPSBzZXJpZXNbaV1bal1bMV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gbmVnYXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gbmVnYXRpdmUgKyB2YWx1ZTsKICAgICAgICBuZWdhdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfQogICAgfQogIH0KfTsKdmFyIG9mZnNldFBvc2l0aXZlID0gKHNlcmllcykgPT4gewogIHZhciBuID0gc2VyaWVzLmxlbmd0aDsKICBpZiAobiA8PSAwKSB7CiAgICByZXR1cm47CiAgfQogIGZvciAodmFyIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aDsgaiA8IG07ICsraikgewogICAgdmFyIHBvc2l0aXZlID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIHZhciB2YWx1ZSA9IGlzTmFuKHNlcmllc1tpXVtqXVsxXSkgPyBzZXJpZXNbaV1bal1bMF0gOiBzZXJpZXNbaV1bal1bMV07CiAgICAgIGlmICh2YWx1ZSA+PSAwKSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gcG9zaXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gcG9zaXRpdmUgKyB2YWx1ZTsKICAgICAgICBwb3NpdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSAwOwogICAgICAgIHNlcmllc1tpXVtqXVsxXSA9IDA7CiAgICAgIH0KICAgIH0KICB9Cn07CnZhciBTVEFDS19PRkZTRVRfTUFQID0gewogIHNpZ246IG9mZnNldFNpZ24sCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIGV4cGFuZDogZXhwYW5kX2RlZmF1bHQsCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIG5vbmU6IG5vbmVfZGVmYXVsdCwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgc2lsaG91ZXR0ZTogc2lsaG91ZXR0ZV9kZWZhdWx0LAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZGVmaW5pdGVseXR5cGVkIHR5cGVzIGFyZSBpbmNvcnJlY3QKICB3aWdnbGU6IHdpZ2dsZV9kZWZhdWx0LAogIHBvc2l0aXZlOiBvZmZzZXRQb3NpdGl2ZQp9Owp2YXIgZ2V0U3RhY2tlZERhdGEgPSAoZGF0YSwgZGF0YUtleXMsIG9mZnNldFR5cGUpID0+IHsKICB2YXIgb2Zmc2V0QWNjZXNzb3IgPSBTVEFDS19PRkZTRVRfTUFQW29mZnNldFR5cGVdOwogIHZhciBzdGFjayA9IHN0YWNrX2RlZmF1bHQoKS5rZXlzKGRhdGFLZXlzKS52YWx1ZSgoZCwga2V5KSA9PiBOdW1iZXIoZ2V0VmFsdWVCeURhdGFLZXkoZCwga2V5LCAwKSkpLm9yZGVyKG5vbmVfZGVmYXVsdDIpLm9mZnNldChvZmZzZXRBY2Nlc3Nvcik7CiAgcmV0dXJuIHN0YWNrKGRhdGEpOwp9OwpmdW5jdGlvbiBnZXROb3JtYWxpemVkU3RhY2tJZChwdWJsaWNTdGFja0lkKSB7CiAgcmV0dXJuIHB1YmxpY1N0YWNrSWQgPT0gbnVsbCA/IHZvaWQgMCA6IFN0cmluZyhwdWJsaWNTdGFja0lkKTsKfQpmdW5jdGlvbiBnZXRDYXRlQ29vcmRpbmF0ZU9mTGluZShfcmVmMikgewogIHZhciB7CiAgICBheGlzLAogICAgdGlja3M6IHRpY2tzMiwKICAgIGJhbmRTaXplLAogICAgZW50cnksCiAgICBpbmRleCwKICAgIGRhdGFLZXkKICB9ID0gX3JlZjI7CiAgaWYgKGF4aXMudHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgaWYgKCFheGlzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGF4aXMuZGF0YUtleSAmJiAhaXNOdWxsaXNoKGVudHJ5W2F4aXMuZGF0YUtleV0pKSB7CiAgICAgIHZhciBtYXRjaGVkVGljayA9IGZpbmRFbnRyeUluQXJyYXkodGlja3MyLCAidmFsdWUiLCBlbnRyeVtheGlzLmRhdGFLZXldKTsKICAgICAgaWYgKG1hdGNoZWRUaWNrKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZWRUaWNrLmNvb3JkaW5hdGUgKyBiYW5kU2l6ZSAvIDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aWNrczJbaW5kZXhdID8gdGlja3MyW2luZGV4XS5jb29yZGluYXRlICsgYmFuZFNpemUgLyAyIDogbnVsbDsKICB9CiAgdmFyIHZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksICFpc051bGxpc2goZGF0YUtleSkgPyBkYXRhS2V5IDogYXhpcy5kYXRhS2V5KTsKICByZXR1cm4gIWlzTnVsbGlzaCh2YWx1ZSkgPyBheGlzLnNjYWxlKHZhbHVlKSA6IG51bGw7Cn0KdmFyIGdldERvbWFpbk9mU2luZ2xlID0gKGRhdGEpID0+IHsKICB2YXIgZmxhdCA9IGRhdGEuZmxhdCgyKS5maWx0ZXIoaXNOdW1iZXIpOwogIHJldHVybiBbTWF0aC5taW4oLi4uZmxhdCksIE1hdGgubWF4KC4uLmZsYXQpXTsKfTsKdmFyIG1ha2VEb21haW5GaW5pdGUgPSAoZG9tYWluKSA9PiB7CiAgcmV0dXJuIFtkb21haW5bMF0gPT09IEluZmluaXR5ID8gMCA6IGRvbWFpblswXSwgZG9tYWluWzFdID09PSAtSW5maW5pdHkgPyAwIDogZG9tYWluWzFdXTsKfTsKdmFyIGdldERvbWFpbk9mU3RhY2tHcm91cHMgPSAoc3RhY2tHcm91cHMsIHN0YXJ0SW5kZXgsIGVuZEluZGV4KSA9PiB7CiAgaWYgKHN0YWNrR3JvdXBzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBtYWtlRG9tYWluRmluaXRlKE9iamVjdC5rZXlzKHN0YWNrR3JvdXBzKS5yZWR1Y2UoKHJlc3VsdCwgc3RhY2tJZCkgPT4gewogICAgdmFyIGdyb3VwID0gc3RhY2tHcm91cHNbc3RhY2tJZF07CiAgICB2YXIgewogICAgICBzdGFja2VkRGF0YQogICAgfSA9IGdyb3VwOwogICAgdmFyIGRvbWFpbiA9IHN0YWNrZWREYXRhLnJlZHVjZSgocmVzLCBlbnRyeSkgPT4gewogICAgICB2YXIgc2xpY2VkID0gZ2V0U2xpY2VkKGVudHJ5LCBzdGFydEluZGV4LCBlbmRJbmRleCk7CiAgICAgIHZhciBzMiA9IGdldERvbWFpbk9mU2luZ2xlKHNsaWNlZCk7CiAgICAgIHJldHVybiBbTWF0aC5taW4ocmVzWzBdLCBzMlswXSksIE1hdGgubWF4KHJlc1sxXSwgczJbMV0pXTsKICAgIH0sIFtJbmZpbml0eSwgLUluZmluaXR5XSk7CiAgICByZXR1cm4gW01hdGgubWluKGRvbWFpblswXSwgcmVzdWx0WzBdKSwgTWF0aC5tYXgoZG9tYWluWzFdLCByZXN1bHRbMV0pXTsKICB9LCBbSW5maW5pdHksIC1JbmZpbml0eV0pKTsKfTsKdmFyIE1JTl9WQUxVRV9SRUcgPSAvXmRhdGFNaW5bXHNdKi1bXHNdKihbMC05XSsoWy5dezF9WzAtOV0rKXswLDF9KSQvOwp2YXIgTUFYX1ZBTFVFX1JFRyA9IC9eZGF0YU1heFtcc10qXCtbXHNdKihbMC05XSsoWy5dezF9WzAtOV0rKXswLDF9KSQvOwp2YXIgZ2V0QmFuZFNpemVPZkF4aXMgPSAoYXhpcywgdGlja3MyLCBpc0JhcikgPT4gewogIGlmIChheGlzICYmIGF4aXMuc2NhbGUgJiYgYXhpcy5zY2FsZS5iYW5kd2lkdGgpIHsKICAgIHZhciBiYW5kV2lkdGggPSBheGlzLnNjYWxlLmJhbmR3aWR0aCgpOwogICAgaWYgKCFpc0JhciB8fCBiYW5kV2lkdGggPiAwKSB7CiAgICAgIHJldHVybiBiYW5kV2lkdGg7CiAgICB9CiAgfQogIGlmIChheGlzICYmIHRpY2tzMiAmJiB0aWNrczIubGVuZ3RoID49IDIpIHsKICAgIHZhciBvcmRlcmVkVGlja3MgPSAoMCwgaW1wb3J0X3NvcnRCeTIuZGVmYXVsdCkodGlja3MyLCAobykgPT4gby5jb29yZGluYXRlKTsKICAgIHZhciBiYW5kU2l6ZSA9IEluZmluaXR5OwogICAgZm9yICh2YXIgaSA9IDEsIGxlbiA9IG9yZGVyZWRUaWNrcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgY3VyID0gb3JkZXJlZFRpY2tzW2ldOwogICAgICB2YXIgcHJldiA9IG9yZGVyZWRUaWNrc1tpIC0gMV07CiAgICAgIGJhbmRTaXplID0gTWF0aC5taW4oKGN1ci5jb29yZGluYXRlIHx8IDApIC0gKHByZXYuY29vcmRpbmF0ZSB8fCAwKSwgYmFuZFNpemUpOwogICAgfQogICAgcmV0dXJuIGJhbmRTaXplID09PSBJbmZpbml0eSA/IDAgOiBiYW5kU2l6ZTsKICB9CiAgcmV0dXJuIGlzQmFyID8gdm9pZCAwIDogMDsKfTsKZnVuY3Rpb24gZ2V0VG9vbHRpcEVudHJ5KF9yZWY0KSB7CiAgdmFyIHsKICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzLAogICAgZGF0YUtleSwKICAgIHBheWxvYWQsCiAgICB2YWx1ZSwKICAgIG5hbWUKICB9ID0gX3JlZjQ7CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQzKF9vYmplY3RTcHJlYWQzKHt9LCB0b29sdGlwRW50cnlTZXR0aW5ncyksIHt9LCB7CiAgICBkYXRhS2V5LAogICAgcGF5bG9hZCwKICAgIHZhbHVlLAogICAgbmFtZQogIH0pOwp9CmZ1bmN0aW9uIGdldFRvb2x0aXBOYW1lUHJvcChuYW1lRnJvbUl0ZW0sIGRhdGFLZXkpIHsKICBpZiAobmFtZUZyb21JdGVtKSB7CiAgICByZXR1cm4gU3RyaW5nKG5hbWVGcm9tSXRlbSk7CiAgfQogIGlmICh0eXBlb2YgZGF0YUtleSA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiBkYXRhS2V5OwogIH0KICByZXR1cm4gdm9pZCAwOwp9CnZhciBjYWxjdWxhdGVDYXJ0ZXNpYW5Ub29sdGlwUG9zID0gKGNvb3JkaW5hdGUsIGxheW91dCkgPT4gewogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIGNvb3JkaW5hdGUuY2hhcnRYOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gY29vcmRpbmF0ZS5jaGFydFk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBjYWxjdWxhdGVQb2xhclRvb2x0aXBQb3MgPSAocmFuZ2VPYmosIGxheW91dCkgPT4gewogIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgcmV0dXJuIHJhbmdlT2JqLmFuZ2xlOwogIH0KICByZXR1cm4gcmFuZ2VPYmoucmFkaXVzOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29udGFpbmVyU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RDaGFydFdpZHRoID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQud2lkdGg7CnZhciBzZWxlY3RDaGFydEhlaWdodCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LmhlaWdodDsKdmFyIHNlbGVjdENvbnRhaW5lclNjYWxlID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQuc2NhbGU7CnZhciBzZWxlY3RNYXJnaW4gPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC5tYXJnaW47CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RBbGxBeGVzLmpzCnZhciBzZWxlY3RBbGxYQXhlcyA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUuY2FydGVzaWFuQXhpcy54QXhpcywgKHhBeGlzTWFwKSA9PiB7CiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoeEF4aXNNYXApOwp9KTsKdmFyIHNlbGVjdEFsbFlBeGVzID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnlBeGlzLCAoeUF4aXNNYXApID0+IHsKICByZXR1cm4gT2JqZWN0LnZhbHVlcyh5QXhpc01hcCk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NvbnN0YW50cy5qcwp2YXIgREFUQV9JVEVNX0lOREVYX0FUVFJJQlVURV9OQU1FID0gImRhdGEtcmVjaGFydHMtaXRlbS1pbmRleCI7CnZhciBEQVRBX0lURU1fREFUQUtFWV9BVFRSSUJVVEVfTkFNRSA9ICJkYXRhLXJlY2hhcnRzLWl0ZW0tZGF0YS1rZXkiOwp2YXIgREVGQVVMVF9ZX0FYSVNfV0lEVEggPSA2MDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwuanMKZnVuY3Rpb24gb3duS2V5czQoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ0KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzNChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5NChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM0KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5NChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk0KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlNCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHNlbGVjdEJydXNoSGVpZ2h0ID0gKHN0YXRlKSA9PiBzdGF0ZS5icnVzaC5oZWlnaHQ7CmZ1bmN0aW9uIHNlbGVjdExlZnRBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHlBeGVzID0gc2VsZWN0QWxsWUF4ZXMoc3RhdGUpOwogIHJldHVybiB5QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFlbnRyeS5taXJyb3IgJiYgIWVudHJ5LmhpZGUpIHsKICAgICAgdmFyIHdpZHRoID0gdHlwZW9mIGVudHJ5LndpZHRoID09PSAibnVtYmVyIiA/IGVudHJ5LndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgICAgIHJldHVybiByZXN1bHQgKyB3aWR0aDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwgMCk7Cn0KZnVuY3Rpb24gc2VsZWN0UmlnaHRBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHlBeGVzID0gc2VsZWN0QWxsWUF4ZXMoc3RhdGUpOwogIHJldHVybiB5QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHZhciB3aWR0aCA9IHR5cGVvZiBlbnRyeS53aWR0aCA9PT0gIm51bWJlciIgPyBlbnRyeS53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogICAgICByZXR1cm4gcmVzdWx0ICsgd2lkdGg7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdFRvcEF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeEF4ZXMgPSBzZWxlY3RBbGxYQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHhBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbnRyeS5oZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdEJvdHRvbUF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeEF4ZXMgPSBzZWxlY3RBbGxYQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHhBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbnRyeS5oZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CnZhciBzZWxlY3RDaGFydE9mZnNldEludGVybmFsID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RNYXJnaW4sIHNlbGVjdEJydXNoSGVpZ2h0LCBzZWxlY3RMZWZ0QXhlc09mZnNldCwgc2VsZWN0UmlnaHRBeGVzT2Zmc2V0LCBzZWxlY3RUb3BBeGVzT2Zmc2V0LCBzZWxlY3RCb3R0b21BeGVzT2Zmc2V0LCBzZWxlY3RMZWdlbmRTZXR0aW5ncywgc2VsZWN0TGVnZW5kU2l6ZV0sIChjaGFydFdpZHRoLCBjaGFydEhlaWdodCwgbWFyZ2luLCBicnVzaEhlaWdodCwgbGVmdEF4ZXNPZmZzZXQsIHJpZ2h0QXhlc09mZnNldCwgdG9wQXhlc09mZnNldCwgYm90dG9tQXhlc09mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpID0+IHsKICB2YXIgb2Zmc2V0SCA9IHsKICAgIGxlZnQ6IChtYXJnaW4ubGVmdCB8fCAwKSArIGxlZnRBeGVzT2Zmc2V0LAogICAgcmlnaHQ6IChtYXJnaW4ucmlnaHQgfHwgMCkgKyByaWdodEF4ZXNPZmZzZXQKICB9OwogIHZhciBvZmZzZXRWID0gewogICAgdG9wOiAobWFyZ2luLnRvcCB8fCAwKSArIHRvcEF4ZXNPZmZzZXQsCiAgICBib3R0b206IChtYXJnaW4uYm90dG9tIHx8IDApICsgYm90dG9tQXhlc09mZnNldAogIH07CiAgdmFyIG9mZnNldCA9IF9vYmplY3RTcHJlYWQ0KF9vYmplY3RTcHJlYWQ0KHt9LCBvZmZzZXRWKSwgb2Zmc2V0SCk7CiAgdmFyIGJydXNoQm90dG9tID0gb2Zmc2V0LmJvdHRvbTsKICBvZmZzZXQuYm90dG9tICs9IGJydXNoSGVpZ2h0OwogIG9mZnNldCA9IGFwcGVuZE9mZnNldE9mTGVnZW5kKG9mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpOwogIHZhciBvZmZzZXRXaWR0aCA9IGNoYXJ0V2lkdGggLSBvZmZzZXQubGVmdCAtIG9mZnNldC5yaWdodDsKICB2YXIgb2Zmc2V0SGVpZ2h0ID0gY2hhcnRIZWlnaHQgLSBvZmZzZXQudG9wIC0gb2Zmc2V0LmJvdHRvbTsKICByZXR1cm4gX29iamVjdFNwcmVhZDQoX29iamVjdFNwcmVhZDQoewogICAgYnJ1c2hCb3R0b20KICB9LCBvZmZzZXQpLCB7fSwgewogICAgLy8gbmV2ZXIgcmV0dXJuIG5lZ2F0aXZlIHZhbHVlcyBmb3IgaGVpZ2h0IGFuZCB3aWR0aAogICAgd2lkdGg6IE1hdGgubWF4KG9mZnNldFdpZHRoLCAwKSwKICAgIGhlaWdodDogTWF0aC5tYXgob2Zmc2V0SGVpZ2h0LCAwKQogIH0pOwp9KTsKdmFyIHNlbGVjdENoYXJ0Vmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIChvZmZzZXQpID0+ICh7CiAgeDogb2Zmc2V0LmxlZnQsCiAgeTogb2Zmc2V0LnRvcCwKICB3aWR0aDogb2Zmc2V0LndpZHRoLAogIGhlaWdodDogb2Zmc2V0LmhlaWdodAp9KSk7CnZhciBzZWxlY3RBeGlzVmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCAod2lkdGgsIGhlaWdodCkgPT4gKHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGgsCiAgaGVpZ2h0Cn0pKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9QYW5vcmFtYUNvbnRleHQuanMKdmFyIFJlYWN0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDExID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgUGFub3JhbWFDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxMS5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIHVzZUlzUGFub3JhbWEgPSAoKSA9PiAoMCwgaW1wb3J0X3JlYWN0MTEudXNlQ29udGV4dCkoUGFub3JhbWFDb250ZXh0KSAhPSBudWxsOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYnJ1c2hTZWxlY3RvcnMuanMKdmFyIHNlbGVjdEJydXNoU2V0dGluZ3MgPSAoc3RhdGUpID0+IHN0YXRlLmJydXNoOwp2YXIgc2VsZWN0QnJ1c2hEaW1lbnNpb25zID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJydXNoU2V0dGluZ3MsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdE1hcmdpbl0sIChicnVzaFNldHRpbmdzLCBvZmZzZXQsIG1hcmdpbikgPT4gKHsKICBoZWlnaHQ6IGJydXNoU2V0dGluZ3MuaGVpZ2h0LAogIHg6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3MueCkgPyBicnVzaFNldHRpbmdzLnggOiBvZmZzZXQubGVmdCwKICB5OiBpc051bWJlcihicnVzaFNldHRpbmdzLnkpID8gYnJ1c2hTZXR0aW5ncy55IDogb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgKyBvZmZzZXQuYnJ1c2hCb3R0b20gLSAoKG1hcmdpbiA9PT0gbnVsbCB8fCBtYXJnaW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IG1hcmdpbi5ib3R0b20pIHx8IDApLAogIHdpZHRoOiBpc051bWJlcihicnVzaFNldHRpbmdzLndpZHRoKSA/IGJydXNoU2V0dGluZ3Mud2lkdGggOiBvZmZzZXQud2lkdGgKfSkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvUmVzcG9uc2l2ZUNvbnRhaW5lci5qcwp2YXIgUmVhY3Q1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfdGhyb3R0bGUgPSBfX3RvRVNNKHJlcXVpcmVfdGhyb3R0bGUyKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0xvZ1V0aWxzLmpzCnZhciBpc0RldiA9IHRydWU7CnZhciB3YXJuID0gZnVuY3Rpb24gd2FybjIoY29uZGl0aW9uLCBmb3JtYXQyKSB7CiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDIgPyBfbGVuIC0gMiA6IDApLCBfa2V5ID0gMjsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgYXJnc1tfa2V5IC0gMl0gPSBhcmd1bWVudHNbX2tleV07CiAgfQogIGlmIChpc0RldiAmJiB0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS53YXJuKSB7CiAgICBpZiAoZm9ybWF0MiA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnNvbGUud2FybigiTG9nVXRpbHMgcmVxdWlyZXMgYW4gZXJyb3IgbWVzc2FnZSBhcmd1bWVudCIpOwogICAgfQogICAgaWYgKCFjb25kaXRpb24pIHsKICAgICAgaWYgKGZvcm1hdDIgPT09IHZvaWQgMCkgewogICAgICAgIGNvbnNvbGUud2FybigiTWluaWZpZWQgZXhjZXB0aW9uIG9jY3VycmVkOyB1c2UgdGhlIG5vbi1taW5pZmllZCBkZXYgZW52aXJvbm1lbnQgZm9yIHRoZSBmdWxsIGVycm9yIG1lc3NhZ2UgYW5kIGFkZGl0aW9uYWwgaGVscGZ1bCB3YXJuaW5ncy4iKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgYXJnSW5kZXggPSAwOwogICAgICAgIGNvbnNvbGUud2Fybihmb3JtYXQyLnJlcGxhY2UoLyVzL2csICgpID0+IGFyZ3NbYXJnSW5kZXgrK10pKTsKICAgICAgfQogICAgfQogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L3Jlc3BvbnNpdmVDb250YWluZXJVdGlscy5qcwp2YXIgY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zID0gKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQsIHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoID0gIjEwMCUiLAogICAgaGVpZ2h0ID0gIjEwMCUiLAogICAgYXNwZWN0LAogICAgbWF4SGVpZ2h0CiAgfSA9IHByb3BzOwogIHZhciBjYWxjdWxhdGVkV2lkdGggPSBpc1BlcmNlbnQod2lkdGgpID8gY29udGFpbmVyV2lkdGggOiBOdW1iZXIod2lkdGgpOwogIHZhciBjYWxjdWxhdGVkSGVpZ2h0ID0gaXNQZXJjZW50KGhlaWdodCkgPyBjb250YWluZXJIZWlnaHQgOiBOdW1iZXIoaGVpZ2h0KTsKICBpZiAoYXNwZWN0ICYmIGFzcGVjdCA+IDApIHsKICAgIGlmIChjYWxjdWxhdGVkV2lkdGgpIHsKICAgICAgY2FsY3VsYXRlZEhlaWdodCA9IGNhbGN1bGF0ZWRXaWR0aCAvIGFzcGVjdDsKICAgIH0gZWxzZSBpZiAoY2FsY3VsYXRlZEhlaWdodCkgewogICAgICBjYWxjdWxhdGVkV2lkdGggPSBjYWxjdWxhdGVkSGVpZ2h0ICogYXNwZWN0OwogICAgfQogICAgaWYgKG1heEhlaWdodCAmJiBjYWxjdWxhdGVkSGVpZ2h0ICE9IG51bGwgJiYgY2FsY3VsYXRlZEhlaWdodCA+IG1heEhlaWdodCkgewogICAgICBjYWxjdWxhdGVkSGVpZ2h0ID0gbWF4SGVpZ2h0OwogICAgfQogIH0KICByZXR1cm4gewogICAgY2FsY3VsYXRlZFdpZHRoLAogICAgY2FsY3VsYXRlZEhlaWdodAogIH07Cn07CnZhciBib3RoT3ZlcmZsb3cgPSB7CiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIG92ZXJmbG93OiAidmlzaWJsZSIKfTsKdmFyIG92ZXJmbG93WCA9IHsKICB3aWR0aDogMCwKICBvdmVyZmxvd1g6ICJ2aXNpYmxlIgp9Owp2YXIgb3ZlcmZsb3dZID0gewogIGhlaWdodDogMCwKICBvdmVyZmxvd1k6ICJ2aXNpYmxlIgp9Owp2YXIgbm9TdHlsZSA9IHt9Owp2YXIgZ2V0SW5uZXJEaXZTdHlsZSA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICB2YXIgaXNXaWR0aFBlcmNlbnQgPSBpc1BlcmNlbnQod2lkdGgpOwogIHZhciBpc0hlaWdodFBlcmNlbnQgPSBpc1BlcmNlbnQoaGVpZ2h0KTsKICBpZiAoaXNXaWR0aFBlcmNlbnQgJiYgaXNIZWlnaHRQZXJjZW50KSB7CiAgICByZXR1cm4gYm90aE92ZXJmbG93OwogIH0KICBpZiAoaXNXaWR0aFBlcmNlbnQpIHsKICAgIHJldHVybiBvdmVyZmxvd1g7CiAgfQogIGlmIChpc0hlaWdodFBlcmNlbnQpIHsKICAgIHJldHVybiBvdmVyZmxvd1k7CiAgfQogIHJldHVybiBub1N0eWxlOwp9OwpmdW5jdGlvbiBnZXREZWZhdWx0V2lkdGhBbmRIZWlnaHQoX3JlZjIpIHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBhc3BlY3QKICB9ID0gX3JlZjI7CiAgdmFyIGNhbGN1bGF0ZWRXaWR0aCA9IHdpZHRoOwogIHZhciBjYWxjdWxhdGVkSGVpZ2h0ID0gaGVpZ2h0OwogIGlmIChjYWxjdWxhdGVkV2lkdGggPT09IHZvaWQgMCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID09PSB2b2lkIDApIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCA9ICIxMDAlIjsKICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSAiMTAwJSI7CiAgfSBlbHNlIGlmIChjYWxjdWxhdGVkV2lkdGggPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZFdpZHRoID0gYXNwZWN0ICYmIGFzcGVjdCA+IDAgPyB2b2lkIDAgOiAiMTAwJSI7CiAgfSBlbHNlIGlmIChjYWxjdWxhdGVkSGVpZ2h0ID09PSB2b2lkIDApIHsKICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSBhc3BlY3QgJiYgYXNwZWN0ID4gMCA/IHZvaWQgMCA6ICIxMDAlIjsKICB9CiAgcmV0dXJuIHsKICAgIHdpZHRoOiBjYWxjdWxhdGVkV2lkdGgsCiAgICBoZWlnaHQ6IGNhbGN1bGF0ZWRIZWlnaHQKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvaXNXZWxsQmVoYXZlZE51bWJlci5qcwpmdW5jdGlvbiBpc1dlbGxCZWhhdmVkTnVtYmVyKG4pIHsKICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKG4pOwp9CmZ1bmN0aW9uIGlzUG9zaXRpdmVOdW1iZXIobikgewogIHJldHVybiB0eXBlb2YgbiA9PT0gIm51bWJlciIgJiYgbiA+IDAgJiYgTnVtYmVyLmlzRmluaXRlKG4pOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9SZXNwb25zaXZlQ29udGFpbmVyLmpzCmZ1bmN0aW9uIF9leHRlbmRzNCgpIHsKICByZXR1cm4gX2V4dGVuZHM0ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM0LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czUoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzNShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5NShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5NShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlNSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxMi5jcmVhdGVDb250ZXh0KSh7CiAgd2lkdGg6IC0xLAogIGhlaWdodDogLTEKfSk7CmZ1bmN0aW9uIGlzQWNjZXB0YWJsZVNpemUoc2l6ZSkgewogIHJldHVybiBpc1Bvc2l0aXZlTnVtYmVyKHNpemUud2lkdGgpICYmIGlzUG9zaXRpdmVOdW1iZXIoc2l6ZS5oZWlnaHQpOwp9CmZ1bmN0aW9uIFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0UHJvdmlkZXIoX3JlZjIpIHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBfcmVmMjsKICB2YXIgc2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VNZW1vKSgoKSA9PiAoewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9KSwgW3dpZHRoLCBoZWlnaHRdKTsKICBpZiAoIWlzQWNjZXB0YWJsZVNpemUoc2l6ZSkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogc2l6ZQogIH0sIGNoaWxkcmVuKTsKfQp2YXIgdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQgPSAoKSA9PiAoMCwgaW1wb3J0X3JlYWN0MTIudXNlQ29udGV4dCkoUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQpOwp2YXIgU2l6ZURldGVjdG9yQ29udGFpbmVyID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxMi5mb3J3YXJkUmVmKSgoX3JlZjIsIHJlZikgPT4gewogIHZhciB7CiAgICBhc3BlY3QsCiAgICBpbml0aWFsRGltZW5zaW9uID0gewogICAgICB3aWR0aDogLTEsCiAgICAgIGhlaWdodDogLTEKICAgIH0sCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIC8qCiAgICAgKiBkZWZhdWx0IG1pbi13aWR0aCB0byAwIGlmIG5vdCBzcGVjaWZpZWQgLSAnYXV0bycgY2F1c2VzIGlzc3VlcyB3aXRoIGZsZXhib3gKICAgICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9pc3N1ZXMvMTcyCiAgICAgKi8KICAgIG1pbldpZHRoID0gMCwKICAgIG1pbkhlaWdodCwKICAgIG1heEhlaWdodCwKICAgIGNoaWxkcmVuLAogICAgZGVib3VuY2UgPSAwLAogICAgaWQsCiAgICBjbGFzc05hbWUsCiAgICBvblJlc2l6ZSwKICAgIHN0eWxlID0ge30KICB9ID0gX3JlZjI7CiAgdmFyIGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VSZWYpKG51bGwpOwogIHZhciBvblJlc2l6ZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VSZWYpKCk7CiAgb25SZXNpemVSZWYuY3VycmVudCA9IG9uUmVzaXplOwogICgwLCBpbXBvcnRfcmVhY3QxMi51c2VJbXBlcmF0aXZlSGFuZGxlKShyZWYsICgpID0+IGNvbnRhaW5lclJlZi5jdXJyZW50KTsKICB2YXIgW3NpemVzLCBzZXRTaXplc10gPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlU3RhdGUpKHsKICAgIGNvbnRhaW5lcldpZHRoOiBpbml0aWFsRGltZW5zaW9uLndpZHRoLAogICAgY29udGFpbmVySGVpZ2h0OiBpbml0aWFsRGltZW5zaW9uLmhlaWdodAogIH0pOwogIHZhciBzZXRDb250YWluZXJTaXplID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZUNhbGxiYWNrKSgobmV3V2lkdGgsIG5ld0hlaWdodCkgPT4gewogICAgc2V0U2l6ZXMoKHByZXZTdGF0ZSkgPT4gewogICAgICB2YXIgcm91bmRlZFdpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCk7CiAgICAgIHZhciByb3VuZGVkSGVpZ2h0ID0gTWF0aC5yb3VuZChuZXdIZWlnaHQpOwogICAgICBpZiAocHJldlN0YXRlLmNvbnRhaW5lcldpZHRoID09PSByb3VuZGVkV2lkdGggJiYgcHJldlN0YXRlLmNvbnRhaW5lckhlaWdodCA9PT0gcm91bmRlZEhlaWdodCkgewogICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjb250YWluZXJXaWR0aDogcm91bmRlZFdpZHRoLAogICAgICAgIGNvbnRhaW5lckhlaWdodDogcm91bmRlZEhlaWdodAogICAgICB9OwogICAgfSk7CiAgfSwgW10pOwogICgwLCBpbXBvcnRfcmVhY3QxMi51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChjb250YWluZXJSZWYuY3VycmVudCA9PSBudWxsIHx8IHR5cGVvZiBSZXNpemVPYnNlcnZlciA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgY2FsbGJhY2sgPSAoZW50cmllcykgPT4gewogICAgICB2YXIgX29uUmVzaXplUmVmJGN1cnJlbnQ7CiAgICAgIHZhciB7CiAgICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoMywKICAgICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodDMKICAgICAgfSA9IGVudHJpZXNbMF0uY29udGVudFJlY3Q7CiAgICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgzLCBjb250YWluZXJIZWlnaHQzKTsKICAgICAgKF9vblJlc2l6ZVJlZiRjdXJyZW50ID0gb25SZXNpemVSZWYuY3VycmVudCkgPT09IG51bGwgfHwgX29uUmVzaXplUmVmJGN1cnJlbnQgPT09IHZvaWQgMCB8fCBfb25SZXNpemVSZWYkY3VycmVudC5jYWxsKG9uUmVzaXplUmVmLCBjb250YWluZXJXaWR0aDMsIGNvbnRhaW5lckhlaWdodDMpOwogICAgfTsKICAgIGlmIChkZWJvdW5jZSA+IDApIHsKICAgICAgY2FsbGJhY2sgPSAoMCwgaW1wb3J0X3Rocm90dGxlLmRlZmF1bHQpKGNhbGxiYWNrLCBkZWJvdW5jZSwgewogICAgICAgIHRyYWlsaW5nOiB0cnVlLAogICAgICAgIGxlYWRpbmc6IGZhbHNlCiAgICAgIH0pOwogICAgfQogICAgdmFyIG9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKGNhbGxiYWNrKTsKICAgIHZhciB7CiAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aDIsCiAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0MgogICAgfSA9IGNvbnRhaW5lclJlZi5jdXJyZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgc2V0Q29udGFpbmVyU2l6ZShjb250YWluZXJXaWR0aDIsIGNvbnRhaW5lckhlaWdodDIpOwogICAgb2JzZXJ2ZXIub2JzZXJ2ZShjb250YWluZXJSZWYuY3VycmVudCk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICB9OwogIH0sIFtzZXRDb250YWluZXJTaXplLCBkZWJvdW5jZV0pOwogIHZhciB7CiAgICBjb250YWluZXJXaWR0aCwKICAgIGNvbnRhaW5lckhlaWdodAogIH0gPSBzaXplczsKICB3YXJuKCFhc3BlY3QgfHwgYXNwZWN0ID4gMCwgIlRoZSBhc3BlY3QoJXMpIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIiwgYXNwZWN0KTsKICB2YXIgewogICAgY2FsY3VsYXRlZFdpZHRoLAogICAgY2FsY3VsYXRlZEhlaWdodAogIH0gPSBjYWxjdWxhdGVDaGFydERpbWVuc2lvbnMoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCwgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBhc3BlY3QsCiAgICBtYXhIZWlnaHQKICB9KTsKICB3YXJuKGNhbGN1bGF0ZWRXaWR0aCAhPSBudWxsICYmIGNhbGN1bGF0ZWRXaWR0aCA+IDAgfHwgY2FsY3VsYXRlZEhlaWdodCAhPSBudWxsICYmIGNhbGN1bGF0ZWRIZWlnaHQgPiAwLCAiVGhlIHdpZHRoKCVzKSBhbmQgaGVpZ2h0KCVzKSBvZiBjaGFydCBzaG91bGQgYmUgZ3JlYXRlciB0aGFuIDAsXG4gICAgICAgcGxlYXNlIGNoZWNrIHRoZSBzdHlsZSBvZiBjb250YWluZXIsIG9yIHRoZSBwcm9wcyB3aWR0aCglcykgYW5kIGhlaWdodCglcyksXG4gICAgICAgb3IgYWRkIGEgbWluV2lkdGgoJXMpIG9yIG1pbkhlaWdodCglcykgb3IgdXNlIGFzcGVjdCglcykgdG8gY29udHJvbCB0aGVcbiAgICAgICBoZWlnaHQgYW5kIHdpZHRoLiIsIGNhbGN1bGF0ZWRXaWR0aCwgY2FsY3VsYXRlZEhlaWdodCwgd2lkdGgsIGhlaWdodCwgbWluV2lkdGgsIG1pbkhlaWdodCwgYXNwZWN0KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJkaXYiLCB7CiAgICBpZDogaWQgPyAiIi5jb25jYXQoaWQpIDogdm9pZCAwLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1yZXNwb25zaXZlLWNvbnRhaW5lciIsIGNsYXNzTmFtZSksCiAgICBzdHlsZTogX29iamVjdFNwcmVhZDUoX29iamVjdFNwcmVhZDUoe30sIHN0eWxlKSwge30sIHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgbWluV2lkdGgsCiAgICAgIG1pbkhlaWdodCwKICAgICAgbWF4SGVpZ2h0CiAgICB9KSwKICAgIHJlZjogY29udGFpbmVyUmVmCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJkaXYiLCB7CiAgICBzdHlsZTogZ2V0SW5uZXJEaXZTdHlsZSh7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0pCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0UHJvdmlkZXIsIHsKICAgIHdpZHRoOiBjYWxjdWxhdGVkV2lkdGgsCiAgICBoZWlnaHQ6IGNhbGN1bGF0ZWRIZWlnaHQKICB9LCBjaGlsZHJlbikpKTsKfSk7CnZhciBSZXNwb25zaXZlQ29udGFpbmVyID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxMi5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciByZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCA9IHVzZVJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0KCk7CiAgaWYgKGlzUG9zaXRpdmVOdW1iZXIocmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQud2lkdGgpICYmIGlzUG9zaXRpdmVOdW1iZXIocmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQuaGVpZ2h0KSkgewogICAgcmV0dXJuIHByb3BzLmNoaWxkcmVuOwogIH0KICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gZ2V0RGVmYXVsdFdpZHRoQW5kSGVpZ2h0KHsKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgYXNwZWN0OiBwcm9wcy5hc3BlY3QKICB9KTsKICB2YXIgewogICAgY2FsY3VsYXRlZFdpZHRoLAogICAgY2FsY3VsYXRlZEhlaWdodAogIH0gPSBjYWxjdWxhdGVDaGFydERpbWVuc2lvbnModm9pZCAwLCB2b2lkIDAsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgYXNwZWN0OiBwcm9wcy5hc3BlY3QsCiAgICBtYXhIZWlnaHQ6IHByb3BzLm1heEhlaWdodAogIH0pOwogIGlmIChpc051bWJlcihjYWxjdWxhdGVkV2lkdGgpICYmIGlzTnVtYmVyKGNhbGN1bGF0ZWRIZWlnaHQpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0UHJvdmlkZXIsIHsKICAgICAgd2lkdGg6IGNhbGN1bGF0ZWRXaWR0aCwKICAgICAgaGVpZ2h0OiBjYWxjdWxhdGVkSGVpZ2h0CiAgICB9LCBwcm9wcy5jaGlsZHJlbik7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoU2l6ZURldGVjdG9yQ29udGFpbmVyLCBfZXh0ZW5kczQoe30sIHByb3BzLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJlZgogIH0pKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvY2hhcnRMYXlvdXRDb250ZXh0LmpzCmZ1bmN0aW9uIGNhcnRlc2lhblZpZXdCb3hUb1RyYXBlem9pZChib3gpIHsKICBpZiAoIWJveCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHsKICAgIHg6IGJveC54LAogICAgeTogYm94LnksCiAgICB1cHBlcldpZHRoOiAidXBwZXJXaWR0aCIgaW4gYm94ID8gYm94LnVwcGVyV2lkdGggOiBib3gud2lkdGgsCiAgICBsb3dlcldpZHRoOiAibG93ZXJXaWR0aCIgaW4gYm94ID8gYm94Lmxvd2VyV2lkdGggOiBib3gud2lkdGgsCiAgICB3aWR0aDogYm94LndpZHRoLAogICAgaGVpZ2h0OiBib3guaGVpZ2h0CiAgfTsKfQp2YXIgdXNlVmlld0JveCA9ICgpID0+IHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yOwogIHZhciBwYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcm9vdFZpZXdCb3ggPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydFZpZXdCb3gpOwogIHZhciBicnVzaERpbWVuc2lvbnMgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RCcnVzaERpbWVuc2lvbnMpOwogIHZhciBicnVzaFBhZGRpbmcgPSAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QnJ1c2hTZXR0aW5ncykpID09PSBudWxsIHx8IF91c2VBcHBTZWxlY3RvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3VzZUFwcFNlbGVjdG9yLnBhZGRpbmc7CiAgaWYgKCFwYW5vcmFtYSB8fCAhYnJ1c2hEaW1lbnNpb25zIHx8ICFicnVzaFBhZGRpbmcpIHsKICAgIHJldHVybiByb290Vmlld0JveDsKICB9CiAgcmV0dXJuIHsKICAgIHdpZHRoOiBicnVzaERpbWVuc2lvbnMud2lkdGggLSBicnVzaFBhZGRpbmcubGVmdCAtIGJydXNoUGFkZGluZy5yaWdodCwKICAgIGhlaWdodDogYnJ1c2hEaW1lbnNpb25zLmhlaWdodCAtIGJydXNoUGFkZGluZy50b3AgLSBicnVzaFBhZGRpbmcuYm90dG9tLAogICAgeDogYnJ1c2hQYWRkaW5nLmxlZnQsCiAgICB5OiBicnVzaFBhZGRpbmcudG9wCiAgfTsKfTsKdmFyIG1hbnlDb21wb25lbnRzVGhyb3dFcnJvcnNJZk9mZnNldElzVW5kZWZpbmVkID0gewogIHRvcDogMCwKICBib3R0b206IDAsCiAgbGVmdDogMCwKICByaWdodDogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgYnJ1c2hCb3R0b206IDAKfTsKdmFyIHVzZU9mZnNldEludGVybmFsID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3IyOwogIHJldHVybiAoX3VzZUFwcFNlbGVjdG9yMiA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IyICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IyIDogbWFueUNvbXBvbmVudHNUaHJvd0Vycm9yc0lmT2Zmc2V0SXNVbmRlZmluZWQ7Cn07CnZhciB1c2VDaGFydFdpZHRoID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydFdpZHRoKTsKfTsKdmFyIHVzZUNoYXJ0SGVpZ2h0ID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydEhlaWdodCk7Cn07CnZhciBzZWxlY3RDaGFydExheW91dCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LmxheW91dFR5cGU7CnZhciB1c2VDaGFydExheW91dCA9ICgpID0+IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0TGF5b3V0KTsKdmFyIHVzZUNhcnRlc2lhbkNoYXJ0TGF5b3V0ID0gKCkgPT4gewogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIiB8fCBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBsYXlvdXQ7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciB1c2VJc0luQ2hhcnRDb250ZXh0ID0gKCkgPT4gewogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHJldHVybiBsYXlvdXQgIT09IHZvaWQgMDsKfTsKdmFyIFJlcG9ydENoYXJ0U2l6ZSA9IChwcm9wcykgPT4gewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHsKICAgIHdpZHRoOiB3aWR0aEZyb21Qcm9wcywKICAgIGhlaWdodDogaGVpZ2h0RnJvbVByb3BzCiAgfSA9IHByb3BzOwogIHZhciByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID0gdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQoKTsKICB2YXIgd2lkdGggPSB3aWR0aEZyb21Qcm9wczsKICB2YXIgaGVpZ2h0ID0gaGVpZ2h0RnJvbVByb3BzOwogIGlmIChyZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zKSB7CiAgICB3aWR0aCA9IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGggPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCA6IHdpZHRoRnJvbVByb3BzOwogICAgaGVpZ2h0ID0gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQgPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQgOiBoZWlnaHRGcm9tUHJvcHM7CiAgfQogICgwLCBpbXBvcnRfcmVhY3QxMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmICghaXNQYW5vcmFtYSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHdpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKGhlaWdodCkpIHsKICAgICAgZGlzcGF0Y2goc2V0Q2hhcnRTaXplKHsKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQKICAgICAgfSkpOwogICAgfQogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgd2lkdGgsIGhlaWdodF0pOwogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzL2ltbWVyL2Rpc3QvaW1tZXIubWpzCnZhciBOT1RISU5HMiA9IFN5bWJvbC5mb3IoImltbWVyLW5vdGhpbmciKTsKdmFyIERSQUZUQUJMRTIgPSBTeW1ib2wuZm9yKCJpbW1lci1kcmFmdGFibGUiKTsKdmFyIERSQUZUX1NUQVRFMiA9IFN5bWJvbC5mb3IoImltbWVyLXN0YXRlIik7CnZhciBlcnJvcnMyID0gdHJ1ZSA/IFsKICAvLyBBbGwgZXJyb3IgY29kZXMsIHN0YXJ0aW5nIGJ5IDA6CiAgZnVuY3Rpb24ocGx1Z2luKSB7CiAgICByZXR1cm4gYFRoZSBwbHVnaW4gZm9yICcke3BsdWdpbn0nIGhhcyBub3QgYmVlbiBsb2FkZWQgaW50byBJbW1lci4gVG8gZW5hYmxlIHRoZSBwbHVnaW4sIGltcG9ydCBhbmQgY2FsbCBcYGVuYWJsZSR7cGx1Z2lufSgpXGAgd2hlbiBpbml0aWFsaXppbmcgeW91ciBhcHBsaWNhdGlvbi5gOwogIH0sCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgcHJvZHVjZSBjYW4gb25seSBiZSBjYWxsZWQgb24gdGhpbmdzIHRoYXQgYXJlIGRyYWZ0YWJsZTogcGxhaW4gb2JqZWN0cywgYXJyYXlzLCBNYXAsIFNldCBvciBjbGFzc2VzIHRoYXQgYXJlIG1hcmtlZCB3aXRoICdbaW1tZXJhYmxlXTogdHJ1ZScuIEdvdCAnJHt0aGluZ30nYDsKICB9LAogICJUaGlzIG9iamVjdCBoYXMgYmVlbiBmcm96ZW4gYW5kIHNob3VsZCBub3QgYmUgbXV0YXRlZCIsCiAgZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuICJDYW5ub3QgdXNlIGEgcHJveHkgdGhhdCBoYXMgYmVlbiByZXZva2VkLiBEaWQgeW91IHBhc3MgYW4gb2JqZWN0IGZyb20gaW5zaWRlIGFuIGltbWVyIGZ1bmN0aW9uIHRvIGFuIGFzeW5jIHByb2Nlc3M/ICIgKyBkYXRhOwogIH0sCiAgIkFuIGltbWVyIHByb2R1Y2VyIHJldHVybmVkIGEgbmV3IHZhbHVlICphbmQqIG1vZGlmaWVkIGl0cyBkcmFmdC4gRWl0aGVyIHJldHVybiBhIG5ldyB2YWx1ZSAqb3IqIG1vZGlmeSB0aGUgZHJhZnQuIiwKICAiSW1tZXIgZm9yYmlkcyBjaXJjdWxhciByZWZlcmVuY2VzIiwKICAiVGhlIGZpcnN0IG9yIHNlY29uZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIiwKICAiVGhlIHRoaXJkIGFyZ3VtZW50IHRvIGBwcm9kdWNlYCBtdXN0IGJlIGEgZnVuY3Rpb24gb3IgdW5kZWZpbmVkIiwKICAiRmlyc3QgYXJndW1lbnQgdG8gYGNyZWF0ZURyYWZ0YCBtdXN0IGJlIGEgcGxhaW4gb2JqZWN0LCBhbiBhcnJheSwgb3IgYW4gaW1tZXJhYmxlIG9iamVjdCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBmaW5pc2hEcmFmdGAgbXVzdCBiZSBhIGRyYWZ0IHJldHVybmVkIGJ5IGBjcmVhdGVEcmFmdGAiLAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYCdjdXJyZW50JyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0sCiAgIk9iamVjdC5kZWZpbmVQcm9wZXJ0eSgpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiT2JqZWN0LnNldFByb3RvdHlwZU9mKCkgY2Fubm90IGJlIHVzZWQgb24gYW4gSW1tZXIgZHJhZnQiLAogICJJbW1lciBvbmx5IHN1cHBvcnRzIGRlbGV0aW5nIGFycmF5IGluZGljZXMiLAogICJJbW1lciBvbmx5IHN1cHBvcnRzIHNldHRpbmcgYXJyYXkgaW5kaWNlcyBhbmQgdGhlICdsZW5ndGgnIHByb3BlcnR5IiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnb3JpZ2luYWwnIGV4cGVjdHMgYSBkcmFmdCwgZ290OiAke3RoaW5nfWA7CiAgfQogIC8vIE5vdGU6IGlmIG1vcmUgZXJyb3JzIGFyZSBhZGRlZCwgdGhlIGVycm9yT2Zmc2V0IGluIFBhdGNoZXMudHMgc2hvdWxkIGJlIGluY3JlYXNlZAogIC8vIFNlZSBQYXRjaGVzLnRzIGZvciBhZGRpdGlvbmFsIGVycm9ycwpdIDogW107CmZ1bmN0aW9uIGRpZTIoZXJyb3IsIC4uLmFyZ3MpIHsKICBpZiAodHJ1ZSkgewogICAgY29uc3QgZSA9IGVycm9yczJbZXJyb3JdOwogICAgY29uc3QgbXNnID0gdHlwZW9mIGUgPT09ICJmdW5jdGlvbiIgPyBlLmFwcGx5KG51bGwsIGFyZ3MpIDogZTsKICAgIHRocm93IG5ldyBFcnJvcihgW0ltbWVyXSAke21zZ31gKTsKICB9CiAgdGhyb3cgbmV3IEVycm9yKAogICAgYFtJbW1lcl0gbWluaWZpZWQgZXJyb3IgbnI6ICR7ZXJyb3J9LiBGdWxsIGVycm9yIGF0OiBodHRwczovL2JpdC5seS8zY1hFS1dmYAogICk7Cn0KdmFyIGdldFByb3RvdHlwZU9mMiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKZnVuY3Rpb24gaXNEcmFmdDIodmFsdWUpIHsKICByZXR1cm4gISF2YWx1ZSAmJiAhIXZhbHVlW0RSQUZUX1NUQVRFMl07Cn0KZnVuY3Rpb24gaXNEcmFmdGFibGUyKHZhbHVlKSB7CiAgaWYgKCF2YWx1ZSkKICAgIHJldHVybiBmYWxzZTsKICByZXR1cm4gaXNQbGFpbk9iamVjdDModmFsdWUpIHx8IEFycmF5LmlzQXJyYXkodmFsdWUpIHx8ICEhdmFsdWVbRFJBRlRBQkxFMl0gfHwgISF2YWx1ZS5jb25zdHJ1Y3Rvcj8uW0RSQUZUQUJMRTJdIHx8IGlzTWFwMih2YWx1ZSkgfHwgaXNTZXQyKHZhbHVlKTsKfQp2YXIgb2JqZWN0Q3RvclN0cmluZzIgPSBPYmplY3QucHJvdG90eXBlLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCk7CnZhciBjYWNoZWRDdG9yU3RyaW5nczIgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKZnVuY3Rpb24gaXNQbGFpbk9iamVjdDModmFsdWUpIHsKICBpZiAoIXZhbHVlIHx8IHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIpCiAgICByZXR1cm4gZmFsc2U7CiAgY29uc3QgcHJvdG8yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbHVlKTsKICBpZiAocHJvdG8yID09PSBudWxsIHx8IHByb3RvMiA9PT0gT2JqZWN0LnByb3RvdHlwZSkKICAgIHJldHVybiB0cnVlOwogIGNvbnN0IEN0b3IgPSBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChwcm90bzIsICJjb25zdHJ1Y3RvciIpICYmIHByb3RvMi5jb25zdHJ1Y3RvcjsKICBpZiAoQ3RvciA9PT0gT2JqZWN0KQogICAgcmV0dXJuIHRydWU7CiAgaWYgKHR5cGVvZiBDdG9yICE9PSAiZnVuY3Rpb24iKQogICAgcmV0dXJuIGZhbHNlOwogIGxldCBjdG9yU3RyaW5nID0gY2FjaGVkQ3RvclN0cmluZ3MyLmdldChDdG9yKTsKICBpZiAoY3RvclN0cmluZyA9PT0gdm9pZCAwKSB7CiAgICBjdG9yU3RyaW5nID0gRnVuY3Rpb24udG9TdHJpbmcuY2FsbChDdG9yKTsKICAgIGNhY2hlZEN0b3JTdHJpbmdzMi5zZXQoQ3RvciwgY3RvclN0cmluZyk7CiAgfQogIHJldHVybiBjdG9yU3RyaW5nID09PSBvYmplY3RDdG9yU3RyaW5nMjsKfQpmdW5jdGlvbiBlYWNoMihvYmosIGl0ZXIsIHN0cmljdCA9IHRydWUpIHsKICBpZiAoZ2V0QXJjaHR5cGUyKG9iaikgPT09IDApIHsKICAgIGNvbnN0IGtleXMgPSBzdHJpY3QgPyBSZWZsZWN0Lm93bktleXMob2JqKSA6IE9iamVjdC5rZXlzKG9iaik7CiAgICBrZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgICBpdGVyKGtleSwgb2JqW2tleV0sIG9iaik7CiAgICB9KTsKICB9IGVsc2UgewogICAgb2JqLmZvckVhY2goKGVudHJ5LCBpbmRleCkgPT4gaXRlcihpbmRleCwgZW50cnksIG9iaikpOwogIH0KfQpmdW5jdGlvbiBnZXRBcmNodHlwZTIodGhpbmcpIHsKICBjb25zdCBzdGF0ZSA9IHRoaW5nW0RSQUZUX1NUQVRFMl07CiAgcmV0dXJuIHN0YXRlID8gc3RhdGUudHlwZV8gOiBBcnJheS5pc0FycmF5KHRoaW5nKSA/IDEgOiBpc01hcDIodGhpbmcpID8gMiA6IGlzU2V0Mih0aGluZykgPyAzIDogMDsKfQpmdW5jdGlvbiBoYXMyKHRoaW5nLCBwcm9wKSB7CiAgcmV0dXJuIGdldEFyY2h0eXBlMih0aGluZykgPT09IDIgPyB0aGluZy5oYXMocHJvcCkgOiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpbmcsIHByb3ApOwp9CmZ1bmN0aW9uIHNldDIodGhpbmcsIHByb3BPck9sZFZhbHVlLCB2YWx1ZSkgewogIGNvbnN0IHQgPSBnZXRBcmNodHlwZTIodGhpbmcpOwogIGlmICh0ID09PSAyKQogICAgdGhpbmcuc2V0KHByb3BPck9sZFZhbHVlLCB2YWx1ZSk7CiAgZWxzZSBpZiAodCA9PT0gMykgewogICAgdGhpbmcuYWRkKHZhbHVlKTsKICB9IGVsc2UKICAgIHRoaW5nW3Byb3BPck9sZFZhbHVlXSA9IHZhbHVlOwp9CmZ1bmN0aW9uIGlzMih4MiwgeTIpIHsKICBpZiAoeDIgPT09IHkyKSB7CiAgICByZXR1cm4geDIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTI7CiAgfSBlbHNlIHsKICAgIHJldHVybiB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KfQpmdW5jdGlvbiBpc01hcDIodGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldCBpbnN0YW5jZW9mIE1hcDsKfQpmdW5jdGlvbiBpc1NldDIodGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldCBpbnN0YW5jZW9mIFNldDsKfQpmdW5jdGlvbiBsYXRlc3QyKHN0YXRlKSB7CiAgcmV0dXJuIHN0YXRlLmNvcHlfIHx8IHN0YXRlLmJhc2VfOwp9CmZ1bmN0aW9uIHNoYWxsb3dDb3B5MihiYXNlLCBzdHJpY3QpIHsKICBpZiAoaXNNYXAyKGJhc2UpKSB7CiAgICByZXR1cm4gbmV3IE1hcChiYXNlKTsKICB9CiAgaWYgKGlzU2V0MihiYXNlKSkgewogICAgcmV0dXJuIG5ldyBTZXQoYmFzZSk7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KGJhc2UpKQogICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGJhc2UpOwogIGNvbnN0IGlzUGxhaW4yID0gaXNQbGFpbk9iamVjdDMoYmFzZSk7CiAgaWYgKHN0cmljdCA9PT0gdHJ1ZSB8fCBzdHJpY3QgPT09ICJjbGFzc19vbmx5IiAmJiAhaXNQbGFpbjIpIHsKICAgIGNvbnN0IGRlc2NyaXB0b3JzID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoYmFzZSk7CiAgICBkZWxldGUgZGVzY3JpcHRvcnNbRFJBRlRfU1RBVEUyXTsKICAgIGxldCBrZXlzID0gUmVmbGVjdC5vd25LZXlzKGRlc2NyaXB0b3JzKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICBjb25zdCBkZXNjID0gZGVzY3JpcHRvcnNba2V5XTsKICAgICAgaWYgKGRlc2Mud3JpdGFibGUgPT09IGZhbHNlKSB7CiAgICAgICAgZGVzYy53cml0YWJsZSA9IHRydWU7CiAgICAgICAgZGVzYy5jb25maWd1cmFibGUgPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChkZXNjLmdldCB8fCBkZXNjLnNldCkKICAgICAgICBkZXNjcmlwdG9yc1trZXldID0gewogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAvLyBjb3VsZCBsaXZlIHdpdGggISFkZXNjLnNldCBhcyB3ZWxsIGhlcmUuLi4KICAgICAgICAgIGVudW1lcmFibGU6IGRlc2MuZW51bWVyYWJsZSwKICAgICAgICAgIHZhbHVlOiBiYXNlW2tleV0KICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIE9iamVjdC5jcmVhdGUoZ2V0UHJvdG90eXBlT2YyKGJhc2UpLCBkZXNjcmlwdG9ycyk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mMihiYXNlKTsKICAgIGlmIChwcm90bzIgIT09IG51bGwgJiYgaXNQbGFpbjIpIHsKICAgICAgcmV0dXJuIHsgLi4uYmFzZSB9OwogICAgfQogICAgY29uc3Qgb2JqID0gT2JqZWN0LmNyZWF0ZShwcm90bzIpOwogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24ob2JqLCBiYXNlKTsKICB9Cn0KZnVuY3Rpb24gZnJlZXplMihvYmosIGRlZXAgPSBmYWxzZSkgewogIGlmIChpc0Zyb3plbjIob2JqKSB8fCBpc0RyYWZ0MihvYmopIHx8ICFpc0RyYWZ0YWJsZTIob2JqKSkKICAgIHJldHVybiBvYmo7CiAgaWYgKGdldEFyY2h0eXBlMihvYmopID4gMSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMob2JqLCB7CiAgICAgIHNldDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiwKICAgICAgYWRkOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyLAogICAgICBjbGVhcjogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiwKICAgICAgZGVsZXRlOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyCiAgICB9KTsKICB9CiAgT2JqZWN0LmZyZWV6ZShvYmopOwogIGlmIChkZWVwKQogICAgT2JqZWN0LnZhbHVlcyhvYmopLmZvckVhY2goKHZhbHVlKSA9PiBmcmVlemUyKHZhbHVlLCB0cnVlKSk7CiAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMyKCkgewogIGRpZTIoMik7Cn0KdmFyIGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIgPSB7CiAgdmFsdWU6IGRvbnRNdXRhdGVGcm96ZW5Db2xsZWN0aW9uczIKfTsKZnVuY3Rpb24gaXNGcm96ZW4yKG9iaikgewogIGlmIChvYmogPT09IG51bGwgfHwgdHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpCiAgICByZXR1cm4gdHJ1ZTsKICByZXR1cm4gT2JqZWN0LmlzRnJvemVuKG9iaik7Cn0KdmFyIHBsdWdpbnMyID0ge307CmZ1bmN0aW9uIGdldFBsdWdpbjIocGx1Z2luS2V5KSB7CiAgY29uc3QgcGx1Z2luID0gcGx1Z2luczJbcGx1Z2luS2V5XTsKICBpZiAoIXBsdWdpbikgewogICAgZGllMigwLCBwbHVnaW5LZXkpOwogIH0KICByZXR1cm4gcGx1Z2luOwp9CnZhciBjdXJyZW50U2NvcGUyOwpmdW5jdGlvbiBnZXRDdXJyZW50U2NvcGUyKCkgewogIHJldHVybiBjdXJyZW50U2NvcGUyOwp9CmZ1bmN0aW9uIGNyZWF0ZVNjb3BlMihwYXJlbnRfLCBpbW1lcl8pIHsKICByZXR1cm4gewogICAgZHJhZnRzXzogW10sCiAgICBwYXJlbnRfLAogICAgaW1tZXJfLAogICAgLy8gV2hlbmV2ZXIgdGhlIG1vZGlmaWVkIGRyYWZ0IGNvbnRhaW5zIGEgZHJhZnQgZnJvbSBhbm90aGVyIHNjb3BlLCB3ZQogICAgLy8gbmVlZCB0byBwcmV2ZW50IGF1dG8tZnJlZXppbmcgc28gdGhlIHVub3duZWQgZHJhZnQgY2FuIGJlIGZpbmFsaXplZC4KICAgIGNhbkF1dG9GcmVlemVfOiB0cnVlLAogICAgdW5maW5hbGl6ZWREcmFmdHNfOiAwCiAgfTsKfQpmdW5jdGlvbiB1c2VQYXRjaGVzSW5TY29wZTIoc2NvcGUsIHBhdGNoTGlzdGVuZXIpIHsKICBpZiAocGF0Y2hMaXN0ZW5lcikgewogICAgZ2V0UGx1Z2luMigiUGF0Y2hlcyIpOwogICAgc2NvcGUucGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLmludmVyc2VQYXRjaGVzXyA9IFtdOwogICAgc2NvcGUucGF0Y2hMaXN0ZW5lcl8gPSBwYXRjaExpc3RlbmVyOwogIH0KfQpmdW5jdGlvbiByZXZva2VTY29wZTIoc2NvcGUpIHsKICBsZWF2ZVNjb3BlMihzY29wZSk7CiAgc2NvcGUuZHJhZnRzXy5mb3JFYWNoKHJldm9rZURyYWZ0Mik7CiAgc2NvcGUuZHJhZnRzXyA9IG51bGw7Cn0KZnVuY3Rpb24gbGVhdmVTY29wZTIoc2NvcGUpIHsKICBpZiAoc2NvcGUgPT09IGN1cnJlbnRTY29wZTIpIHsKICAgIGN1cnJlbnRTY29wZTIgPSBzY29wZS5wYXJlbnRfOwogIH0KfQpmdW5jdGlvbiBlbnRlclNjb3BlMihpbW1lcjIyKSB7CiAgcmV0dXJuIGN1cnJlbnRTY29wZTIgPSBjcmVhdGVTY29wZTIoY3VycmVudFNjb3BlMiwgaW1tZXIyMik7Cn0KZnVuY3Rpb24gcmV2b2tlRHJhZnQyKGRyYWZ0KSB7CiAgY29uc3Qgc3RhdGUgPSBkcmFmdFtEUkFGVF9TVEFURTJdOwogIGlmIChzdGF0ZS50eXBlXyA9PT0gMCB8fCBzdGF0ZS50eXBlXyA9PT0gMSkKICAgIHN0YXRlLnJldm9rZV8oKTsKICBlbHNlCiAgICBzdGF0ZS5yZXZva2VkXyA9IHRydWU7Cn0KZnVuY3Rpb24gcHJvY2Vzc1Jlc3VsdDIocmVzdWx0LCBzY29wZSkgewogIHNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA9IHNjb3BlLmRyYWZ0c18ubGVuZ3RoOwogIGNvbnN0IGJhc2VEcmFmdCA9IHNjb3BlLmRyYWZ0c19bMF07CiAgY29uc3QgaXNSZXBsYWNlZCA9IHJlc3VsdCAhPT0gdm9pZCAwICYmIHJlc3VsdCAhPT0gYmFzZURyYWZ0OwogIGlmIChpc1JlcGxhY2VkKSB7CiAgICBpZiAoYmFzZURyYWZ0W0RSQUZUX1NUQVRFMl0ubW9kaWZpZWRfKSB7CiAgICAgIHJldm9rZVNjb3BlMihzY29wZSk7CiAgICAgIGRpZTIoNCk7CiAgICB9CiAgICBpZiAoaXNEcmFmdGFibGUyKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gZmluYWxpemUyKHNjb3BlLCByZXN1bHQpOwogICAgICBpZiAoIXNjb3BlLnBhcmVudF8pCiAgICAgICAgbWF5YmVGcmVlemUyKHNjb3BlLCByZXN1bHQpOwogICAgfQogICAgaWYgKHNjb3BlLnBhdGNoZXNfKSB7CiAgICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKS5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oCiAgICAgICAgYmFzZURyYWZ0W0RSQUZUX1NUQVRFMl0uYmFzZV8sCiAgICAgICAgcmVzdWx0LAogICAgICAgIHNjb3BlLnBhdGNoZXNfLAogICAgICAgIHNjb3BlLmludmVyc2VQYXRjaGVzXwogICAgICApOwogICAgfQogIH0gZWxzZSB7CiAgICByZXN1bHQgPSBmaW5hbGl6ZTIoc2NvcGUsIGJhc2VEcmFmdCwgW10pOwogIH0KICByZXZva2VTY29wZTIoc2NvcGUpOwogIGlmIChzY29wZS5wYXRjaGVzXykgewogICAgc2NvcGUucGF0Y2hMaXN0ZW5lcl8oc2NvcGUucGF0Y2hlc18sIHNjb3BlLmludmVyc2VQYXRjaGVzXyk7CiAgfQogIHJldHVybiByZXN1bHQgIT09IE5PVEhJTkcyID8gcmVzdWx0IDogdm9pZCAwOwp9CmZ1bmN0aW9uIGZpbmFsaXplMihyb290U2NvcGUsIHZhbHVlLCBwYXRoMikgewogIGlmIChpc0Zyb3plbjIodmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHVzZVN0cmljdEl0ZXJhdGlvbiA9IHJvb3RTY29wZS5pbW1lcl8uc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCk7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURTJdOwogIGlmICghc3RhdGUpIHsKICAgIGVhY2gyKAogICAgICB2YWx1ZSwKICAgICAgKGtleSwgY2hpbGRWYWx1ZSkgPT4gZmluYWxpemVQcm9wZXJ0eShyb290U2NvcGUsIHN0YXRlLCB2YWx1ZSwga2V5LCBjaGlsZFZhbHVlLCBwYXRoMiksCiAgICAgIHVzZVN0cmljdEl0ZXJhdGlvbgogICAgKTsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgaWYgKHN0YXRlLnNjb3BlXyAhPT0gcm9vdFNjb3BlKQogICAgcmV0dXJuIHZhbHVlOwogIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICBtYXliZUZyZWV6ZTIocm9vdFNjb3BlLCBzdGF0ZS5iYXNlXywgdHJ1ZSk7CiAgICByZXR1cm4gc3RhdGUuYmFzZV87CiAgfQogIGlmICghc3RhdGUuZmluYWxpemVkXykgewogICAgc3RhdGUuZmluYWxpemVkXyA9IHRydWU7CiAgICBzdGF0ZS5zY29wZV8udW5maW5hbGl6ZWREcmFmdHNfLS07CiAgICBjb25zdCByZXN1bHQgPSBzdGF0ZS5jb3B5XzsKICAgIGxldCByZXN1bHRFYWNoID0gcmVzdWx0OwogICAgbGV0IGlzU2V0MjIgPSBmYWxzZTsKICAgIGlmIChzdGF0ZS50eXBlXyA9PT0gMykgewogICAgICByZXN1bHRFYWNoID0gbmV3IFNldChyZXN1bHQpOwogICAgICByZXN1bHQuY2xlYXIoKTsKICAgICAgaXNTZXQyMiA9IHRydWU7CiAgICB9CiAgICBlYWNoMigKICAgICAgcmVzdWx0RWFjaCwKICAgICAgKGtleSwgY2hpbGRWYWx1ZSkgPT4gZmluYWxpemVQcm9wZXJ0eSgKICAgICAgICByb290U2NvcGUsCiAgICAgICAgc3RhdGUsCiAgICAgICAgcmVzdWx0LAogICAgICAgIGtleSwKICAgICAgICBjaGlsZFZhbHVlLAogICAgICAgIHBhdGgyLAogICAgICAgIGlzU2V0MjIKICAgICAgKSwKICAgICAgdXNlU3RyaWN0SXRlcmF0aW9uCiAgICApOwogICAgbWF5YmVGcmVlemUyKHJvb3RTY29wZSwgcmVzdWx0LCBmYWxzZSk7CiAgICBpZiAocGF0aDIgJiYgcm9vdFNjb3BlLnBhdGNoZXNfKSB7CiAgICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKS5nZW5lcmF0ZVBhdGNoZXNfKAogICAgICAgIHN0YXRlLAogICAgICAgIHBhdGgyLAogICAgICAgIHJvb3RTY29wZS5wYXRjaGVzXywKICAgICAgICByb290U2NvcGUuaW52ZXJzZVBhdGNoZXNfCiAgICAgICk7CiAgICB9CiAgfQogIHJldHVybiBzdGF0ZS5jb3B5XzsKfQpmdW5jdGlvbiBmaW5hbGl6ZVByb3BlcnR5KHJvb3RTY29wZSwgcGFyZW50U3RhdGUsIHRhcmdldE9iamVjdCwgcHJvcCwgY2hpbGRWYWx1ZSwgcm9vdFBhdGgsIHRhcmdldElzU2V0KSB7CiAgaWYgKGNoaWxkVmFsdWUgPT0gbnVsbCkgewogICAgcmV0dXJuOwogIH0KICBpZiAodHlwZW9mIGNoaWxkVmFsdWUgIT09ICJvYmplY3QiICYmICF0YXJnZXRJc1NldCkgewogICAgcmV0dXJuOwogIH0KICBjb25zdCBjaGlsZElzRnJvemVuID0gaXNGcm96ZW4yKGNoaWxkVmFsdWUpOwogIGlmIChjaGlsZElzRnJvemVuICYmICF0YXJnZXRJc1NldCkgewogICAgcmV0dXJuOwogIH0KICBpZiAoY2hpbGRWYWx1ZSA9PT0gdGFyZ2V0T2JqZWN0KQogICAgZGllMig1KTsKICBpZiAoaXNEcmFmdDIoY2hpbGRWYWx1ZSkpIHsKICAgIGNvbnN0IHBhdGgyID0gcm9vdFBhdGggJiYgcGFyZW50U3RhdGUgJiYgcGFyZW50U3RhdGUudHlwZV8gIT09IDMgJiYgLy8gU2V0IG9iamVjdHMgYXJlIGF0b21pYyBzaW5jZSB0aGV5IGhhdmUgbm8ga2V5cy4KICAgICFoYXMyKHBhcmVudFN0YXRlLmFzc2lnbmVkXywgcHJvcCkgPyByb290UGF0aC5jb25jYXQocHJvcCkgOiB2b2lkIDA7CiAgICBjb25zdCByZXMgPSBmaW5hbGl6ZTIocm9vdFNjb3BlLCBjaGlsZFZhbHVlLCBwYXRoMik7CiAgICBzZXQyKHRhcmdldE9iamVjdCwgcHJvcCwgcmVzKTsKICAgIGlmIChpc0RyYWZ0MihyZXMpKSB7CiAgICAgIHJvb3RTY29wZS5jYW5BdXRvRnJlZXplXyA9IGZhbHNlOwogICAgfSBlbHNlCiAgICAgIHJldHVybjsKICB9IGVsc2UgaWYgKHRhcmdldElzU2V0KSB7CiAgICB0YXJnZXRPYmplY3QuYWRkKGNoaWxkVmFsdWUpOwogIH0KICBpZiAoaXNEcmFmdGFibGUyKGNoaWxkVmFsdWUpICYmICFjaGlsZElzRnJvemVuKSB7CiAgICBpZiAoIXJvb3RTY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgcm9vdFNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA8IDEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHBhcmVudFN0YXRlICYmIHBhcmVudFN0YXRlLmJhc2VfICYmIHBhcmVudFN0YXRlLmJhc2VfW3Byb3BdID09PSBjaGlsZFZhbHVlICYmIGNoaWxkSXNGcm96ZW4pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZmluYWxpemUyKHJvb3RTY29wZSwgY2hpbGRWYWx1ZSk7CiAgICBpZiAoKCFwYXJlbnRTdGF0ZSB8fCAhcGFyZW50U3RhdGUuc2NvcGVfLnBhcmVudF8pICYmIHR5cGVvZiBwcm9wICE9PSAic3ltYm9sIiAmJiAoaXNNYXAyKHRhcmdldE9iamVjdCkgPyB0YXJnZXRPYmplY3QuaGFzKHByb3ApIDogT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKHRhcmdldE9iamVjdCwgcHJvcCkpKQogICAgICBtYXliZUZyZWV6ZTIocm9vdFNjb3BlLCBjaGlsZFZhbHVlKTsKICB9Cn0KZnVuY3Rpb24gbWF5YmVGcmVlemUyKHNjb3BlLCB2YWx1ZSwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKCFzY29wZS5wYXJlbnRfICYmIHNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiBzY29wZS5jYW5BdXRvRnJlZXplXykgewogICAgZnJlZXplMih2YWx1ZSwgZGVlcCk7CiAgfQp9CmZ1bmN0aW9uIGNyZWF0ZVByb3h5UHJveHkyKGJhc2UsIHBhcmVudCkgewogIGNvbnN0IGlzQXJyYXkyID0gQXJyYXkuaXNBcnJheShiYXNlKTsKICBjb25zdCBzdGF0ZSA9IHsKICAgIHR5cGVfOiBpc0FycmF5MiA/IDEgOiAwLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvZHVjZSBjYWxsIHRoaXMgaXMgYXNzb2NpYXRlZCB3aXRoLgogICAgc2NvcGVfOiBwYXJlbnQgPyBwYXJlbnQuc2NvcGVfIDogZ2V0Q3VycmVudFNjb3BlMigpLAogICAgLy8gVHJ1ZSBmb3IgYm90aCBzaGFsbG93IGFuZCBkZWVwIGNoYW5nZXMuCiAgICBtb2RpZmllZF86IGZhbHNlLAogICAgLy8gVXNlZCBkdXJpbmcgZmluYWxpemF0aW9uLgogICAgZmluYWxpemVkXzogZmFsc2UsCiAgICAvLyBUcmFjayB3aGljaCBwcm9wZXJ0aWVzIGhhdmUgYmVlbiBhc3NpZ25lZCAodHJ1ZSkgb3IgZGVsZXRlZCAoZmFsc2UpLgogICAgYXNzaWduZWRfOiB7fSwKICAgIC8vIFRoZSBwYXJlbnQgZHJhZnQgc3RhdGUuCiAgICBwYXJlbnRfOiBwYXJlbnQsCiAgICAvLyBUaGUgYmFzZSBzdGF0ZS4KICAgIGJhc2VfOiBiYXNlLAogICAgLy8gVGhlIGJhc2UgcHJveHkuCiAgICBkcmFmdF86IG51bGwsCiAgICAvLyBzZXQgYmVsb3cKICAgIC8vIFRoZSBiYXNlIGNvcHkgd2l0aCBhbnkgdXBkYXRlZCB2YWx1ZXMuCiAgICBjb3B5XzogbnVsbCwKICAgIC8vIENhbGxlZCBieSB0aGUgYHByb2R1Y2VgIGZ1bmN0aW9uLgogICAgcmV2b2tlXzogbnVsbCwKICAgIGlzTWFudWFsXzogZmFsc2UKICB9OwogIGxldCB0YXJnZXQgPSBzdGF0ZTsKICBsZXQgdHJhcHMgPSBvYmplY3RUcmFwczI7CiAgaWYgKGlzQXJyYXkyKSB7CiAgICB0YXJnZXQgPSBbc3RhdGVdOwogICAgdHJhcHMgPSBhcnJheVRyYXBzMjsKICB9CiAgY29uc3QgeyByZXZva2UsIHByb3h5IH0gPSBQcm94eS5yZXZvY2FibGUodGFyZ2V0LCB0cmFwcyk7CiAgc3RhdGUuZHJhZnRfID0gcHJveHk7CiAgc3RhdGUucmV2b2tlXyA9IHJldm9rZTsKICByZXR1cm4gcHJveHk7Cn0KdmFyIG9iamVjdFRyYXBzMiA9IHsKICBnZXQoc3RhdGUsIHByb3ApIHsKICAgIGlmIChwcm9wID09PSBEUkFGVF9TVEFURTIpCiAgICAgIHJldHVybiBzdGF0ZTsKICAgIGNvbnN0IHNvdXJjZSA9IGxhdGVzdDIoc3RhdGUpOwogICAgaWYgKCFoYXMyKHNvdXJjZSwgcHJvcCkpIHsKICAgICAgcmV0dXJuIHJlYWRQcm9wRnJvbVByb3RvMihzdGF0ZSwgc291cmNlLCBwcm9wKTsKICAgIH0KICAgIGNvbnN0IHZhbHVlID0gc291cmNlW3Byb3BdOwogICAgaWYgKHN0YXRlLmZpbmFsaXplZF8gfHwgIWlzRHJhZnRhYmxlMih2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKHZhbHVlID09PSBwZWVrMihzdGF0ZS5iYXNlXywgcHJvcCkpIHsKICAgICAgcHJlcGFyZUNvcHkyKHN0YXRlKTsKICAgICAgcmV0dXJuIHN0YXRlLmNvcHlfW3Byb3BdID0gY3JlYXRlUHJveHkyKHZhbHVlLCBzdGF0ZSk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfSwKICBoYXMoc3RhdGUsIHByb3ApIHsKICAgIHJldHVybiBwcm9wIGluIGxhdGVzdDIoc3RhdGUpOwogIH0sCiAgb3duS2V5cyhzdGF0ZSkgewogICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyhsYXRlc3QyKHN0YXRlKSk7CiAgfSwKICBzZXQoc3RhdGUsIHByb3AsIHZhbHVlKSB7CiAgICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90bzIobGF0ZXN0MihzdGF0ZSksIHByb3ApOwogICAgaWYgKGRlc2M/LnNldCkgewogICAgICBkZXNjLnNldC5jYWxsKHN0YXRlLmRyYWZ0XywgdmFsdWUpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICAgIGNvbnN0IGN1cnJlbnQyMiA9IHBlZWsyKGxhdGVzdDIoc3RhdGUpLCBwcm9wKTsKICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gY3VycmVudDIyPy5bRFJBRlRfU1RBVEUyXTsKICAgICAgaWYgKGN1cnJlbnRTdGF0ZSAmJiBjdXJyZW50U3RhdGUuYmFzZV8gPT09IHZhbHVlKSB7CiAgICAgICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgICAgICBzdGF0ZS5hc3NpZ25lZF9bcHJvcF0gPSBmYWxzZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoaXMyKHZhbHVlLCBjdXJyZW50MjIpICYmICh2YWx1ZSAhPT0gdm9pZCAwIHx8IGhhczIoc3RhdGUuYmFzZV8sIHByb3ApKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgcHJlcGFyZUNvcHkyKHN0YXRlKTsKICAgICAgbWFya0NoYW5nZWQyKHN0YXRlKTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5X1twcm9wXSA9PT0gdmFsdWUgJiYgLy8gc3BlY2lhbCBjYXNlOiBoYW5kbGUgbmV3IHByb3BzIHdpdGggdmFsdWUgJ3VuZGVmaW5lZCcKICAgICh2YWx1ZSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuY29weV8pIHx8IC8vIHNwZWNpYWwgY2FzZTogTmFOCiAgICBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihzdGF0ZS5jb3B5X1twcm9wXSkpCiAgICAgIHJldHVybiB0cnVlOwogICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgIHN0YXRlLmFzc2lnbmVkX1twcm9wXSA9IHRydWU7CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIGRlbGV0ZVByb3BlcnR5KHN0YXRlLCBwcm9wKSB7CiAgICBpZiAocGVlazIoc3RhdGUuYmFzZV8sIHByb3ApICE9PSB2b2lkIDAgfHwgcHJvcCBpbiBzdGF0ZS5iYXNlXykgewogICAgICBzdGF0ZS5hc3NpZ25lZF9bcHJvcF0gPSBmYWxzZTsKICAgICAgcHJlcGFyZUNvcHkyKHN0YXRlKTsKICAgICAgbWFya0NoYW5nZWQyKHN0YXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5hc3NpZ25lZF9bcHJvcF07CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV8pIHsKICAgICAgZGVsZXRlIHN0YXRlLmNvcHlfW3Byb3BdOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfSwKICAvLyBOb3RlOiBXZSBuZXZlciBjb2VyY2UgYGRlc2MudmFsdWVgIGludG8gYW4gSW1tZXIgZHJhZnQsIGJlY2F1c2Ugd2UgY2FuJ3QgbWFrZQogIC8vIHRoZSBzYW1lIGd1YXJhbnRlZSBpbiBFUzUgbW9kZS4KICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc3RhdGUsIHByb3ApIHsKICAgIGNvbnN0IG93bmVyID0gbGF0ZXN0MihzdGF0ZSk7CiAgICBjb25zdCBkZXNjID0gUmVmbGVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob3duZXIsIHByb3ApOwogICAgaWYgKCFkZXNjKQogICAgICByZXR1cm4gZGVzYzsKICAgIHJldHVybiB7CiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHN0YXRlLnR5cGVfICE9PSAxIHx8IHByb3AgIT09ICJsZW5ndGgiLAogICAgICBlbnVtZXJhYmxlOiBkZXNjLmVudW1lcmFibGUsCiAgICAgIHZhbHVlOiBvd25lcltwcm9wXQogICAgfTsKICB9LAogIGRlZmluZVByb3BlcnR5KCkgewogICAgZGllMigxMSk7CiAgfSwKICBnZXRQcm90b3R5cGVPZihzdGF0ZSkgewogICAgcmV0dXJuIGdldFByb3RvdHlwZU9mMihzdGF0ZS5iYXNlXyk7CiAgfSwKICBzZXRQcm90b3R5cGVPZigpIHsKICAgIGRpZTIoMTIpOwogIH0KfTsKdmFyIGFycmF5VHJhcHMyID0ge307CmVhY2gyKG9iamVjdFRyYXBzMiwgKGtleSwgZm4pID0+IHsKICBhcnJheVRyYXBzMltrZXldID0gZnVuY3Rpb24oKSB7CiAgICBhcmd1bWVudHNbMF0gPSBhcmd1bWVudHNbMF1bMF07CiAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KTsKYXJyYXlUcmFwczIuZGVsZXRlUHJvcGVydHkgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCkgewogIGlmIChpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUyKDEzKTsKICByZXR1cm4gYXJyYXlUcmFwczIuc2V0LmNhbGwodGhpcywgc3RhdGUsIHByb3AsIHZvaWQgMCk7Cn07CmFycmF5VHJhcHMyLnNldCA9IGZ1bmN0aW9uKHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogIGlmIChwcm9wICE9PSAibGVuZ3RoIiAmJiBpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUyKDE0KTsKICByZXR1cm4gb2JqZWN0VHJhcHMyLnNldC5jYWxsKHRoaXMsIHN0YXRlWzBdLCBwcm9wLCB2YWx1ZSwgc3RhdGVbMF0pOwp9OwpmdW5jdGlvbiBwZWVrMihkcmFmdCwgcHJvcCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEUyXTsKICBjb25zdCBzb3VyY2UgPSBzdGF0ZSA/IGxhdGVzdDIoc3RhdGUpIDogZHJhZnQ7CiAgcmV0dXJuIHNvdXJjZVtwcm9wXTsKfQpmdW5jdGlvbiByZWFkUHJvcEZyb21Qcm90bzIoc3RhdGUsIHNvdXJjZSwgcHJvcCkgewogIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvMihzb3VyY2UsIHByb3ApOwogIHJldHVybiBkZXNjID8gYHZhbHVlYCBpbiBkZXNjID8gZGVzYy52YWx1ZSA6ICgKICAgIC8vIFRoaXMgaXMgYSB2ZXJ5IHNwZWNpYWwgY2FzZSwgaWYgdGhlIHByb3AgaXMgYSBnZXR0ZXIgZGVmaW5lZCBieSB0aGUKICAgIC8vIHByb3RvdHlwZSwgd2Ugc2hvdWxkIGludm9rZSBpdCB3aXRoIHRoZSBkcmFmdCBhcyBjb250ZXh0IQogICAgZGVzYy5nZXQ/LmNhbGwoc3RhdGUuZHJhZnRfKQogICkgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gZ2V0RGVzY3JpcHRvckZyb21Qcm90bzIoc291cmNlLCBwcm9wKSB7CiAgaWYgKCEocHJvcCBpbiBzb3VyY2UpKQogICAgcmV0dXJuIHZvaWQgMDsKICBsZXQgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YyKHNvdXJjZSk7CiAgd2hpbGUgKHByb3RvMikgewogICAgY29uc3QgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdG8yLCBwcm9wKTsKICAgIGlmIChkZXNjKQogICAgICByZXR1cm4gZGVzYzsKICAgIHByb3RvMiA9IGdldFByb3RvdHlwZU9mMihwcm90bzIpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIG1hcmtDaGFuZ2VkMihzdGF0ZSkgewogIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICBzdGF0ZS5tb2RpZmllZF8gPSB0cnVlOwogICAgaWYgKHN0YXRlLnBhcmVudF8pIHsKICAgICAgbWFya0NoYW5nZWQyKHN0YXRlLnBhcmVudF8pOwogICAgfQogIH0KfQpmdW5jdGlvbiBwcmVwYXJlQ29weTIoc3RhdGUpIHsKICBpZiAoIXN0YXRlLmNvcHlfKSB7CiAgICBzdGF0ZS5jb3B5XyA9IHNoYWxsb3dDb3B5MigKICAgICAgc3RhdGUuYmFzZV8sCiAgICAgIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfCiAgICApOwogIH0KfQp2YXIgSW1tZXIyMiA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb25maWcpIHsKICAgIHRoaXMuYXV0b0ZyZWV6ZV8gPSB0cnVlOwogICAgdGhpcy51c2VTdHJpY3RTaGFsbG93Q29weV8gPSBmYWxzZTsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IHRydWU7CiAgICB0aGlzLnByb2R1Y2UgPSAoYmFzZSwgcmVjaXBlLCBwYXRjaExpc3RlbmVyKSA9PiB7CiAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgcmVjaXBlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgY29uc3QgZGVmYXVsdEJhc2UgPSByZWNpcGU7CiAgICAgICAgcmVjaXBlID0gYmFzZTsKICAgICAgICBjb25zdCBzZWxmMiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGN1cnJpZWRQcm9kdWNlKGJhc2UyID0gZGVmYXVsdEJhc2UsIC4uLmFyZ3MpIHsKICAgICAgICAgIHJldHVybiBzZWxmMi5wcm9kdWNlKGJhc2UyLCAoZHJhZnQpID0+IHJlY2lwZS5jYWxsKHRoaXMsIGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHJlY2lwZSAhPT0gImZ1bmN0aW9uIikKICAgICAgICBkaWUyKDYpOwogICAgICBpZiAocGF0Y2hMaXN0ZW5lciAhPT0gdm9pZCAwICYmIHR5cGVvZiBwYXRjaExpc3RlbmVyICE9PSAiZnVuY3Rpb24iKQogICAgICAgIGRpZTIoNyk7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIGlmIChpc0RyYWZ0YWJsZTIoYmFzZSkpIHsKICAgICAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUyKHRoaXMpOwogICAgICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkyKGJhc2UsIHZvaWQgMCk7CiAgICAgICAgbGV0IGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzdWx0ID0gcmVjaXBlKHByb3h5KTsKICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChoYXNFcnJvcikKICAgICAgICAgICAgcmV2b2tlU2NvcGUyKHNjb3BlKTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgbGVhdmVTY29wZTIoc2NvcGUpOwogICAgICAgIH0KICAgICAgICB1c2VQYXRjaGVzSW5TY29wZTIoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgICAgIHJldHVybiBwcm9jZXNzUmVzdWx0MihyZXN1bHQsIHNjb3BlKTsKICAgICAgfSBlbHNlIGlmICghYmFzZSB8fCB0eXBlb2YgYmFzZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICByZXN1bHQgPSByZWNpcGUoYmFzZSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKQogICAgICAgICAgcmVzdWx0ID0gYmFzZTsKICAgICAgICBpZiAocmVzdWx0ID09PSBOT1RISU5HMikKICAgICAgICAgIHJlc3VsdCA9IHZvaWQgMDsKICAgICAgICBpZiAodGhpcy5hdXRvRnJlZXplXykKICAgICAgICAgIGZyZWV6ZTIocmVzdWx0LCB0cnVlKTsKICAgICAgICBpZiAocGF0Y2hMaXN0ZW5lcikgewogICAgICAgICAgY29uc3QgcCA9IFtdOwogICAgICAgICAgY29uc3QgaXAgPSBbXTsKICAgICAgICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKS5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oYmFzZSwgcmVzdWx0LCBwLCBpcCk7CiAgICAgICAgICBwYXRjaExpc3RlbmVyKHAsIGlwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSBlbHNlCiAgICAgICAgZGllMigxLCBiYXNlKTsKICAgIH07CiAgICB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyA9IChiYXNlLCByZWNpcGUpID0+IHsKICAgICAgaWYgKHR5cGVvZiBiYXNlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIChzdGF0ZSwgLi4uYXJncykgPT4gdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMoc3RhdGUsIChkcmFmdCkgPT4gYmFzZShkcmFmdCwgLi4uYXJncykpOwogICAgICB9CiAgICAgIGxldCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlczsKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wcm9kdWNlKGJhc2UsIHJlY2lwZSwgKHAsIGlwKSA9PiB7CiAgICAgICAgcGF0Y2hlcyA9IHA7CiAgICAgICAgaW52ZXJzZVBhdGNoZXMgPSBpcDsKICAgICAgfSk7CiAgICAgIHJldHVybiBbcmVzdWx0LCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlc107CiAgICB9OwogICAgaWYgKHR5cGVvZiBjb25maWc/LmF1dG9GcmVlemUgPT09ICJib29sZWFuIikKICAgICAgdGhpcy5zZXRBdXRvRnJlZXplKGNvbmZpZy5hdXRvRnJlZXplKTsKICAgIGlmICh0eXBlb2YgY29uZmlnPy51c2VTdHJpY3RTaGFsbG93Q29weSA9PT0gImJvb2xlYW4iKQogICAgICB0aGlzLnNldFVzZVN0cmljdFNoYWxsb3dDb3B5KGNvbmZpZy51c2VTdHJpY3RTaGFsbG93Q29weSk7CiAgICBpZiAodHlwZW9mIGNvbmZpZz8udXNlU3RyaWN0SXRlcmF0aW9uID09PSAiYm9vbGVhbiIpCiAgICAgIHRoaXMuc2V0VXNlU3RyaWN0SXRlcmF0aW9uKGNvbmZpZy51c2VTdHJpY3RJdGVyYXRpb24pOwogIH0KICBjcmVhdGVEcmFmdChiYXNlKSB7CiAgICBpZiAoIWlzRHJhZnRhYmxlMihiYXNlKSkKICAgICAgZGllMig4KTsKICAgIGlmIChpc0RyYWZ0MihiYXNlKSkKICAgICAgYmFzZSA9IGN1cnJlbnQyKGJhc2UpOwogICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlMih0aGlzKTsKICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkyKGJhc2UsIHZvaWQgMCk7CiAgICBwcm94eVtEUkFGVF9TVEFURTJdLmlzTWFudWFsXyA9IHRydWU7CiAgICBsZWF2ZVNjb3BlMihzY29wZSk7CiAgICByZXR1cm4gcHJveHk7CiAgfQogIGZpbmlzaERyYWZ0KGRyYWZ0LCBwYXRjaExpc3RlbmVyKSB7CiAgICBjb25zdCBzdGF0ZSA9IGRyYWZ0ICYmIGRyYWZ0W0RSQUZUX1NUQVRFMl07CiAgICBpZiAoIXN0YXRlIHx8ICFzdGF0ZS5pc01hbnVhbF8pCiAgICAgIGRpZTIoOSk7CiAgICBjb25zdCB7IHNjb3BlXzogc2NvcGUgfSA9IHN0YXRlOwogICAgdXNlUGF0Y2hlc0luU2NvcGUyKHNjb3BlLCBwYXRjaExpc3RlbmVyKTsKICAgIHJldHVybiBwcm9jZXNzUmVzdWx0Mih2b2lkIDAsIHNjb3BlKTsKICB9CiAgLyoqCiAgICogUGFzcyB0cnVlIHRvIGF1dG9tYXRpY2FsbHkgZnJlZXplIGFsbCBjb3BpZXMgY3JlYXRlZCBieSBJbW1lci4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGF1dG8tZnJlZXppbmcgaXMgZW5hYmxlZC4KICAgKi8KICBzZXRBdXRvRnJlZXplKHZhbHVlKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBlbmFibGUgc3RyaWN0IHNoYWxsb3cgY29weS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGltbWVyIGRvZXMgbm90IGNvcHkgdGhlIG9iamVjdCBkZXNjcmlwdG9ycyBzdWNoIGFzIGdldHRlciwgc2V0dGVyIGFuZCBub24tZW51bXJhYmxlIHByb3BlcnRpZXMuCiAgICovCiAgc2V0VXNlU3RyaWN0U2hhbGxvd0NvcHkodmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgZmFsc2UgdG8gdXNlIGZhc3RlciBpdGVyYXRpb24gdGhhdCBza2lwcyBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzCiAgICogYnV0IHN0aWxsIGhhbmRsZXMgc3ltYm9scyBmb3IgY29tcGF0aWJpbGl0eS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHN0cmljdCBpdGVyYXRpb24gaXMgZW5hYmxlZCAoaW5jbHVkZXMgYWxsIG93biBwcm9wZXJ0aWVzKS4KICAgKi8KICBzZXRVc2VTdHJpY3RJdGVyYXRpb24odmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IHZhbHVlOwogIH0KICBzaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fOwogIH0KICBhcHBseVBhdGNoZXMoYmFzZSwgcGF0Y2hlcykgewogICAgbGV0IGk7CiAgICBmb3IgKGkgPSBwYXRjaGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHBhdGNoID0gcGF0Y2hlc1tpXTsKICAgICAgaWYgKHBhdGNoLnBhdGgubGVuZ3RoID09PSAwICYmIHBhdGNoLm9wID09PSAicmVwbGFjZSIpIHsKICAgICAgICBiYXNlID0gcGF0Y2gudmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmIChpID4gLTEpIHsKICAgICAgcGF0Y2hlcyA9IHBhdGNoZXMuc2xpY2UoaSArIDEpOwogICAgfQogICAgY29uc3QgYXBwbHlQYXRjaGVzSW1wbCA9IGdldFBsdWdpbjIoIlBhdGNoZXMiKS5hcHBseVBhdGNoZXNfOwogICAgaWYgKGlzRHJhZnQyKGJhc2UpKSB7CiAgICAgIHJldHVybiBhcHBseVBhdGNoZXNJbXBsKGJhc2UsIHBhdGNoZXMpOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvZHVjZSgKICAgICAgYmFzZSwKICAgICAgKGRyYWZ0KSA9PiBhcHBseVBhdGNoZXNJbXBsKGRyYWZ0LCBwYXRjaGVzKQogICAgKTsKICB9Cn07CmZ1bmN0aW9uIGNyZWF0ZVByb3h5Mih2YWx1ZSwgcGFyZW50KSB7CiAgY29uc3QgZHJhZnQgPSBpc01hcDIodmFsdWUpID8gZ2V0UGx1Z2luMigiTWFwU2V0IikucHJveHlNYXBfKHZhbHVlLCBwYXJlbnQpIDogaXNTZXQyKHZhbHVlKSA/IGdldFBsdWdpbjIoIk1hcFNldCIpLnByb3h5U2V0Xyh2YWx1ZSwgcGFyZW50KSA6IGNyZWF0ZVByb3h5UHJveHkyKHZhbHVlLCBwYXJlbnQpOwogIGNvbnN0IHNjb3BlID0gcGFyZW50ID8gcGFyZW50LnNjb3BlXyA6IGdldEN1cnJlbnRTY29wZTIoKTsKICBzY29wZS5kcmFmdHNfLnB1c2goZHJhZnQpOwogIHJldHVybiBkcmFmdDsKfQpmdW5jdGlvbiBjdXJyZW50Mih2YWx1ZSkgewogIGlmICghaXNEcmFmdDIodmFsdWUpKQogICAgZGllMigxMCwgdmFsdWUpOwogIHJldHVybiBjdXJyZW50SW1wbDIodmFsdWUpOwp9CmZ1bmN0aW9uIGN1cnJlbnRJbXBsMih2YWx1ZSkgewogIGlmICghaXNEcmFmdGFibGUyKHZhbHVlKSB8fCBpc0Zyb3plbjIodmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEUyXTsKICBsZXQgY29weTM7CiAgbGV0IHN0cmljdCA9IHRydWU7CiAgaWYgKHN0YXRlKSB7CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykKICAgICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogICAgc3RhdGUuZmluYWxpemVkXyA9IHRydWU7CiAgICBjb3B5MyA9IHNoYWxsb3dDb3B5Mih2YWx1ZSwgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8pOwogICAgc3RyaWN0ID0gc3RhdGUuc2NvcGVfLmltbWVyXy5zaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKTsKICB9IGVsc2UgewogICAgY29weTMgPSBzaGFsbG93Q29weTIodmFsdWUsIHRydWUpOwogIH0KICBlYWNoMigKICAgIGNvcHkzLAogICAgKGtleSwgY2hpbGRWYWx1ZSkgPT4gewogICAgICBzZXQyKGNvcHkzLCBrZXksIGN1cnJlbnRJbXBsMihjaGlsZFZhbHVlKSk7CiAgICB9LAogICAgc3RyaWN0CiAgKTsKICBpZiAoc3RhdGUpIHsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSBmYWxzZTsKICB9CiAgcmV0dXJuIGNvcHkzOwp9CnZhciBpbW1lcjIgPSBuZXcgSW1tZXIyMigpOwp2YXIgcHJvZHVjZTIgPSBpbW1lcjIucHJvZHVjZTsKZnVuY3Rpb24gY2FzdERyYWZ0KHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2xlZ2VuZFNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUyID0gewogIHNldHRpbmdzOiB7CiAgICBsYXlvdXQ6ICJob3Jpem9udGFsIiwKICAgIGFsaWduOiAiY2VudGVyIiwKICAgIHZlcnRpY2FsQWxpZ246ICJtaWRkbGUiLAogICAgaXRlbVNvcnRlcjogInZhbHVlIgogIH0sCiAgc2l6ZTogewogICAgd2lkdGg6IDAsCiAgICBoZWlnaHQ6IDAKICB9LAogIHBheWxvYWQ6IFtdCn07CnZhciBsZWdlbmRTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAibGVnZW5kIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTIsCiAgcmVkdWNlcnM6IHsKICAgIHNldExlZ2VuZFNpemUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zaXplLndpZHRoID0gYWN0aW9uLnBheWxvYWQud2lkdGg7CiAgICAgIHN0YXRlLnNpemUuaGVpZ2h0ID0gYWN0aW9uLnBheWxvYWQuaGVpZ2h0OwogICAgfSwKICAgIHNldExlZ2VuZFNldHRpbmdzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc2V0dGluZ3MuYWxpZ24gPSBhY3Rpb24ucGF5bG9hZC5hbGlnbjsKICAgICAgc3RhdGUuc2V0dGluZ3MubGF5b3V0ID0gYWN0aW9uLnBheWxvYWQubGF5b3V0OwogICAgICBzdGF0ZS5zZXR0aW5ncy52ZXJ0aWNhbEFsaWduID0gYWN0aW9uLnBheWxvYWQudmVydGljYWxBbGlnbjsKICAgICAgc3RhdGUuc2V0dGluZ3MuaXRlbVNvcnRlciA9IGFjdGlvbi5wYXlsb2FkLml0ZW1Tb3J0ZXI7CiAgICB9LAogICAgYWRkTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS5wYXlsb2FkLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZUxlZ2VuZFBheWxvYWQ6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnBheWxvYWQuaW5kZXhPZihjYXN0RHJhZnQocHJldikpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5wYXlsb2FkW2luZGV4XSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5wYXlsb2FkLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBheWxvYWQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRMZWdlbmRTaXplLAogIHNldExlZ2VuZFNldHRpbmdzLAogIGFkZExlZ2VuZFBheWxvYWQsCiAgcmVwbGFjZUxlZ2VuZFBheWxvYWQsCiAgcmVtb3ZlTGVnZW5kUGF5bG9hZAp9ID0gbGVnZW5kU2xpY2UuYWN0aW9uczsKdmFyIGxlZ2VuZFJlZHVjZXIgPSBsZWdlbmRTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcC5qcwp2YXIgUmVhY3QxMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0X2RvbTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3RfZG9tKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvRGVmYXVsdFRvb2x0aXBDb250ZW50LmpzCnZhciBSZWFjdDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfc29ydEJ5MyA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwpmdW5jdGlvbiBfZXh0ZW5kczUoKSB7CiAgcmV0dXJuIF9leHRlbmRzNSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM2KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTYoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTYocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Nih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTYodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGRlZmF1bHRGb3JtYXR0ZXIodmFsdWUpIHsKICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgaXNOdW1PclN0cih2YWx1ZVswXSkgJiYgaXNOdW1PclN0cih2YWx1ZVsxXSkgPyB2YWx1ZS5qb2luKCIgfiAiKSA6IHZhbHVlOwp9CnZhciBEZWZhdWx0VG9vbHRpcENvbnRlbnQgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgc2VwYXJhdG9yID0gIiA6ICIsCiAgICBjb250ZW50U3R5bGUgPSB7fSwKICAgIGl0ZW1TdHlsZSA9IHt9LAogICAgbGFiZWxTdHlsZSA9IHt9LAogICAgcGF5bG9hZCwKICAgIGZvcm1hdHRlciwKICAgIGl0ZW1Tb3J0ZXIsCiAgICB3cmFwcGVyQ2xhc3NOYW1lLAogICAgbGFiZWxDbGFzc05hbWUsCiAgICBsYWJlbCwKICAgIGxhYmVsRm9ybWF0dGVyLAogICAgYWNjZXNzaWJpbGl0eUxheWVyID0gZmFsc2UKICB9ID0gcHJvcHM7CiAgdmFyIHJlbmRlckNvbnRlbnQyID0gKCkgPT4gewogICAgaWYgKHBheWxvYWQgJiYgcGF5bG9hZC5sZW5ndGgpIHsKICAgICAgdmFyIGxpc3RTdHlsZSA9IHsKICAgICAgICBwYWRkaW5nOiAwLAogICAgICAgIG1hcmdpbjogMAogICAgICB9OwogICAgICB2YXIgaXRlbXMgPSAoaXRlbVNvcnRlciA/ICgwLCBpbXBvcnRfc29ydEJ5My5kZWZhdWx0KShwYXlsb2FkLCBpdGVtU29ydGVyKSA6IHBheWxvYWQpLm1hcCgoZW50cnksIGkpID0+IHsKICAgICAgICBpZiAoZW50cnkudHlwZSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGZpbmFsRm9ybWF0dGVyID0gZW50cnkuZm9ybWF0dGVyIHx8IGZvcm1hdHRlciB8fCBkZWZhdWx0Rm9ybWF0dGVyOwogICAgICAgIHZhciB7CiAgICAgICAgICB2YWx1ZSwKICAgICAgICAgIG5hbWUKICAgICAgICB9ID0gZW50cnk7CiAgICAgICAgdmFyIGZpbmFsVmFsdWUgPSB2YWx1ZTsKICAgICAgICB2YXIgZmluYWxOYW1lID0gbmFtZTsKICAgICAgICBpZiAoZmluYWxGb3JtYXR0ZXIpIHsKICAgICAgICAgIHZhciBmb3JtYXR0ZWQgPSBmaW5hbEZvcm1hdHRlcih2YWx1ZSwgbmFtZSwgZW50cnksIGksIHBheWxvYWQpOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm9ybWF0dGVkKSkgewogICAgICAgICAgICBbZmluYWxWYWx1ZSwgZmluYWxOYW1lXSA9IGZvcm1hdHRlZDsKICAgICAgICAgIH0gZWxzZSBpZiAoZm9ybWF0dGVkICE9IG51bGwpIHsKICAgICAgICAgICAgZmluYWxWYWx1ZSA9IGZvcm1hdHRlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmluYWxJdGVtU3R5bGUgPSBfb2JqZWN0U3ByZWFkNih7CiAgICAgICAgICBkaXNwbGF5OiAiYmxvY2siLAogICAgICAgICAgcGFkZGluZ1RvcDogNCwKICAgICAgICAgIHBhZGRpbmdCb3R0b206IDQsCiAgICAgICAgICBjb2xvcjogZW50cnkuY29sb3IgfHwgIiMwMDAiCiAgICAgICAgfSwgaXRlbVN0eWxlKTsKICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0Ni5jcmVhdGVFbGVtZW50KCJsaSIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbSIsCiAgICAgICAgICBrZXk6ICJ0b29sdGlwLWl0ZW0tIi5jb25jYXQoaSksCiAgICAgICAgICBzdHlsZTogZmluYWxJdGVtU3R5bGUKICAgICAgICB9LCBpc051bU9yU3RyKGZpbmFsTmFtZSkgPyAvKiBAX19QVVJFX18gKi8gUmVhY3Q2LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tbmFtZSIKICAgICAgICB9LCBmaW5hbE5hbWUpIDogbnVsbCwgaXNOdW1PclN0cihmaW5hbE5hbWUpID8gLyogQF9fUFVSRV9fICovIFJlYWN0Ni5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLXNlcGFyYXRvciIKICAgICAgICB9LCBzZXBhcmF0b3IpIDogbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0Ni5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLXZhbHVlIgogICAgICAgIH0sIGZpbmFsVmFsdWUpLCAvKiBAX19QVVJFX18gKi8gUmVhY3Q2LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tdW5pdCIKICAgICAgICB9LCBlbnRyeS51bml0IHx8ICIiKSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0Ni5jcmVhdGVFbGVtZW50KCJ1bCIsIHsKICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tbGlzdCIsCiAgICAgICAgc3R5bGU6IGxpc3RTdHlsZQogICAgICB9LCBpdGVtcyk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9OwogIHZhciBmaW5hbFN0eWxlID0gX29iamVjdFNwcmVhZDYoewogICAgbWFyZ2luOiAwLAogICAgcGFkZGluZzogMTAsCiAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjZmZmIiwKICAgIGJvcmRlcjogIjFweCBzb2xpZCAjY2NjIiwKICAgIHdoaXRlU3BhY2U6ICJub3dyYXAiCiAgfSwgY29udGVudFN0eWxlKTsKICB2YXIgZmluYWxMYWJlbFN0eWxlID0gX29iamVjdFNwcmVhZDYoewogICAgbWFyZ2luOiAwCiAgfSwgbGFiZWxTdHlsZSk7CiAgdmFyIGhhc0xhYmVsID0gIWlzTnVsbGlzaChsYWJlbCk7CiAgdmFyIGZpbmFsTGFiZWwgPSBoYXNMYWJlbCA/IGxhYmVsIDogIiI7CiAgdmFyIHdyYXBwZXJDTiA9IGNsc3goInJlY2hhcnRzLWRlZmF1bHQtdG9vbHRpcCIsIHdyYXBwZXJDbGFzc05hbWUpOwogIHZhciBsYWJlbENOID0gY2xzeCgicmVjaGFydHMtdG9vbHRpcC1sYWJlbCIsIGxhYmVsQ2xhc3NOYW1lKTsKICBpZiAoaGFzTGFiZWwgJiYgbGFiZWxGb3JtYXR0ZXIgJiYgcGF5bG9hZCAhPT0gdm9pZCAwICYmIHBheWxvYWQgIT09IG51bGwpIHsKICAgIGZpbmFsTGFiZWwgPSBsYWJlbEZvcm1hdHRlcihsYWJlbCwgcGF5bG9hZCk7CiAgfQogIHZhciBhY2Nlc3NpYmlsaXR5QXR0cmlidXRlcyA9IGFjY2Vzc2liaWxpdHlMYXllciA/IHsKICAgIHJvbGU6ICJzdGF0dXMiLAogICAgImFyaWEtbGl2ZSI6ICJhc3NlcnRpdmUiCiAgfSA6IHt9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q2LmNyZWF0ZUVsZW1lbnQoImRpdiIsIF9leHRlbmRzNSh7CiAgICBjbGFzc05hbWU6IHdyYXBwZXJDTiwKICAgIHN0eWxlOiBmaW5hbFN0eWxlCiAgfSwgYWNjZXNzaWJpbGl0eUF0dHJpYnV0ZXMpLCAvKiBAX19QVVJFX18gKi8gUmVhY3Q2LmNyZWF0ZUVsZW1lbnQoInAiLCB7CiAgICBjbGFzc05hbWU6IGxhYmVsQ04sCiAgICBzdHlsZTogZmluYWxMYWJlbFN0eWxlCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0Ni5pc1ZhbGlkRWxlbWVudChmaW5hbExhYmVsKSA/IGZpbmFsTGFiZWwgOiAiIi5jb25jYXQoZmluYWxMYWJlbCkpLCByZW5kZXJDb250ZW50MigpKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXBCb3VuZGluZ0JveC5qcwp2YXIgUmVhY3Q3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdG9vbHRpcC90cmFuc2xhdGUuanMKdmFyIENTU19DTEFTU19QUkVGSVggPSAicmVjaGFydHMtdG9vbHRpcC13cmFwcGVyIjsKdmFyIFRPT0xUSVBfSElEREVOID0gewogIHZpc2liaWxpdHk6ICJoaWRkZW4iCn07CmZ1bmN0aW9uIGdldFRvb2x0aXBDU1NDbGFzc05hbWUoX3JlZjIpIHsKICB2YXIgewogICAgY29vcmRpbmF0ZSwKICAgIHRyYW5zbGF0ZVgsCiAgICB0cmFuc2xhdGVZCiAgfSA9IF9yZWYyOwogIHJldHVybiBjbHN4KENTU19DTEFTU19QUkVGSVgsIHsKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi1yaWdodCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWCkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLngpICYmIHRyYW5zbGF0ZVggPj0gY29vcmRpbmF0ZS54LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLWxlZnQiKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVgpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS54KSAmJiB0cmFuc2xhdGVYIDwgY29vcmRpbmF0ZS54LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLWJvdHRvbSIpXTogaXNOdW1iZXIodHJhbnNsYXRlWSkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLnkpICYmIHRyYW5zbGF0ZVkgPj0gY29vcmRpbmF0ZS55LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLXRvcCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWSkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLnkpICYmIHRyYW5zbGF0ZVkgPCBjb29yZGluYXRlLnkKICB9KTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwVHJhbnNsYXRlWFkoX3JlZjIpIHsKICB2YXIgewogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgY29vcmRpbmF0ZSwKICAgIGtleSwKICAgIG9mZnNldFRvcExlZnQsCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB0b29sdGlwRGltZW5zaW9uLAogICAgdmlld0JveCwKICAgIHZpZXdCb3hEaW1lbnNpb24KICB9ID0gX3JlZjI7CiAgaWYgKHBvc2l0aW9uICYmIGlzTnVtYmVyKHBvc2l0aW9uW2tleV0pKSB7CiAgICByZXR1cm4gcG9zaXRpb25ba2V5XTsKICB9CiAgdmFyIG5lZ2F0aXZlID0gY29vcmRpbmF0ZVtrZXldIC0gdG9vbHRpcERpbWVuc2lvbiAtIChvZmZzZXRUb3BMZWZ0ID4gMCA/IG9mZnNldFRvcExlZnQgOiAwKTsKICB2YXIgcG9zaXRpdmUgPSBjb29yZGluYXRlW2tleV0gKyBvZmZzZXRUb3BMZWZ0OwogIGlmIChhbGxvd0VzY2FwZVZpZXdCb3hba2V5XSkgewogICAgcmV0dXJuIHJldmVyc2VEaXJlY3Rpb25ba2V5XSA/IG5lZ2F0aXZlIDogcG9zaXRpdmU7CiAgfQogIHZhciB2aWV3Qm94S2V5ID0gdmlld0JveFtrZXldOwogIGlmICh2aWV3Qm94S2V5ID09IG51bGwpIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAocmV2ZXJzZURpcmVjdGlvbltrZXldKSB7CiAgICB2YXIgX3Rvb2x0aXBCb3VuZGFyeSA9IG5lZ2F0aXZlOwogICAgdmFyIF92aWV3Qm94Qm91bmRhcnkgPSB2aWV3Qm94S2V5OwogICAgaWYgKF90b29sdGlwQm91bmRhcnkgPCBfdmlld0JveEJvdW5kYXJ5KSB7CiAgICAgIHJldHVybiBNYXRoLm1heChwb3NpdGl2ZSwgdmlld0JveEtleSk7CiAgICB9CiAgICByZXR1cm4gTWF0aC5tYXgobmVnYXRpdmUsIHZpZXdCb3hLZXkpOwogIH0KICBpZiAodmlld0JveERpbWVuc2lvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgdmFyIHRvb2x0aXBCb3VuZGFyeSA9IHBvc2l0aXZlICsgdG9vbHRpcERpbWVuc2lvbjsKICB2YXIgdmlld0JveEJvdW5kYXJ5ID0gdmlld0JveEtleSArIHZpZXdCb3hEaW1lbnNpb247CiAgaWYgKHRvb2x0aXBCb3VuZGFyeSA+IHZpZXdCb3hCb3VuZGFyeSkgewogICAgcmV0dXJuIE1hdGgubWF4KG5lZ2F0aXZlLCB2aWV3Qm94S2V5KTsKICB9CiAgcmV0dXJuIE1hdGgubWF4KHBvc2l0aXZlLCB2aWV3Qm94S2V5KTsKfQpmdW5jdGlvbiBnZXRUcmFuc2Zvcm1TdHlsZShfcmVmMykgewogIHZhciB7CiAgICB0cmFuc2xhdGVYLAogICAgdHJhbnNsYXRlWSwKICAgIHVzZVRyYW5zbGF0ZTNkCiAgfSA9IF9yZWYzOwogIHJldHVybiB7CiAgICB0cmFuc2Zvcm06IHVzZVRyYW5zbGF0ZTNkID8gInRyYW5zbGF0ZTNkKCIuY29uY2F0KHRyYW5zbGF0ZVgsICJweCwgIikuY29uY2F0KHRyYW5zbGF0ZVksICJweCwgMCkiKSA6ICJ0cmFuc2xhdGUoIi5jb25jYXQodHJhbnNsYXRlWCwgInB4LCAiKS5jb25jYXQodHJhbnNsYXRlWSwgInB4KSIpCiAgfTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwVHJhbnNsYXRlKF9yZWY0KSB7CiAgdmFyIHsKICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgIGNvb3JkaW5hdGUsCiAgICBvZmZzZXRUb3BMZWZ0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdG9vbHRpcEJveCwKICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgdmlld0JveAogIH0gPSBfcmVmNDsKICB2YXIgY3NzUHJvcGVydGllcywgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWTsKICBpZiAodG9vbHRpcEJveC5oZWlnaHQgPiAwICYmIHRvb2x0aXBCb3gud2lkdGggPiAwICYmIGNvb3JkaW5hdGUpIHsKICAgIHRyYW5zbGF0ZVggPSBnZXRUb29sdGlwVHJhbnNsYXRlWFkoewogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIGtleTogIngiLAogICAgICBvZmZzZXRUb3BMZWZ0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdG9vbHRpcERpbWVuc2lvbjogdG9vbHRpcEJveC53aWR0aCwKICAgICAgdmlld0JveCwKICAgICAgdmlld0JveERpbWVuc2lvbjogdmlld0JveC53aWR0aAogICAgfSk7CiAgICB0cmFuc2xhdGVZID0gZ2V0VG9vbHRpcFRyYW5zbGF0ZVhZKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBrZXk6ICJ5IiwKICAgICAgb2Zmc2V0VG9wTGVmdCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHRvb2x0aXBEaW1lbnNpb246IHRvb2x0aXBCb3guaGVpZ2h0LAogICAgICB2aWV3Qm94LAogICAgICB2aWV3Qm94RGltZW5zaW9uOiB2aWV3Qm94LmhlaWdodAogICAgfSk7CiAgICBjc3NQcm9wZXJ0aWVzID0gZ2V0VHJhbnNmb3JtU3R5bGUoewogICAgICB0cmFuc2xhdGVYLAogICAgICB0cmFuc2xhdGVZLAogICAgICB1c2VUcmFuc2xhdGUzZAogICAgfSk7CiAgfSBlbHNlIHsKICAgIGNzc1Byb3BlcnRpZXMgPSBUT09MVElQX0hJRERFTjsKICB9CiAgcmV0dXJuIHsKICAgIGNzc1Byb3BlcnRpZXMsCiAgICBjc3NDbGFzc2VzOiBnZXRUb29sdGlwQ1NTQ2xhc3NOYW1lKHsKICAgICAgdHJhbnNsYXRlWCwKICAgICAgdHJhbnNsYXRlWSwKICAgICAgY29vcmRpbmF0ZQogICAgfSkKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9Ub29sdGlwQm91bmRpbmdCb3guanMKZnVuY3Rpb24gb3duS2V5czcoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzNyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5NyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk3KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5NyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk3KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTcodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlNyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFRvb2x0aXBCb3VuZGluZ0JveCA9IGNsYXNzIGV4dGVuZHMgaW1wb3J0X3JlYWN0MTQuUHVyZUNvbXBvbmVudCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlciguLi5hcmd1bWVudHMpOwogICAgX2RlZmluZVByb3BlcnR5Nyh0aGlzLCAic3RhdGUiLCB7CiAgICAgIGRpc21pc3NlZDogZmFsc2UsCiAgICAgIGRpc21pc3NlZEF0Q29vcmRpbmF0ZTogewogICAgICAgIHg6IDAsCiAgICAgICAgeTogMAogICAgICB9CiAgICB9KTsKICAgIF9kZWZpbmVQcm9wZXJ0eTcodGhpcywgImhhbmRsZUtleURvd24iLCAoZXZlbnQpID0+IHsKICAgICAgaWYgKGV2ZW50LmtleSA9PT0gIkVzY2FwZSIpIHsKICAgICAgICB2YXIgX3RoaXMkcHJvcHMkY29vcmRpbmF0LCBfdGhpcyRwcm9wcyRjb29yZGluYXQyLCBfdGhpcyRwcm9wcyRjb29yZGluYXQzLCBfdGhpcyRwcm9wcyRjb29yZGluYXQ0OwogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgZGlzbWlzc2VkOiB0cnVlLAogICAgICAgICAgZGlzbWlzc2VkQXRDb29yZGluYXRlOiB7CiAgICAgICAgICAgIHg6IChfdGhpcyRwcm9wcyRjb29yZGluYXQgPSAoX3RoaXMkcHJvcHMkY29vcmRpbmF0MiA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0MiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0Mi54KSAhPT0gbnVsbCAmJiBfdGhpcyRwcm9wcyRjb29yZGluYXQgIT09IHZvaWQgMCA/IF90aGlzJHByb3BzJGNvb3JkaW5hdCA6IDAsCiAgICAgICAgICAgIHk6IChfdGhpcyRwcm9wcyRjb29yZGluYXQzID0gKF90aGlzJHByb3BzJGNvb3JkaW5hdDQgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDQueSkgIT09IG51bGwgJiYgX3RoaXMkcHJvcHMkY29vcmRpbmF0MyAhPT0gdm9pZCAwID8gX3RoaXMkcHJvcHMkY29vcmRpbmF0MyA6IDAKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQogIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuaGFuZGxlS2V5RG93bik7CiAgfQogIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuaGFuZGxlS2V5RG93bik7CiAgfQogIGNvbXBvbmVudERpZFVwZGF0ZSgpIHsKICAgIHZhciBfdGhpcyRwcm9wcyRjb29yZGluYXQ1LCBfdGhpcyRwcm9wcyRjb29yZGluYXQ2OwogICAgaWYgKCF0aGlzLnN0YXRlLmRpc21pc3NlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoKChfdGhpcyRwcm9wcyRjb29yZGluYXQ1ID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQ1ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQ1LngpICE9PSB0aGlzLnN0YXRlLmRpc21pc3NlZEF0Q29vcmRpbmF0ZS54IHx8ICgoX3RoaXMkcHJvcHMkY29vcmRpbmF0NiA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0Ni55KSAhPT0gdGhpcy5zdGF0ZS5kaXNtaXNzZWRBdENvb3JkaW5hdGUueSkgewogICAgICB0aGlzLnN0YXRlLmRpc21pc3NlZCA9IGZhbHNlOwogICAgfQogIH0KICByZW5kZXIoKSB7CiAgICB2YXIgewogICAgICBhY3RpdmUsCiAgICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICAgIGFuaW1hdGlvbkVhc2luZywKICAgICAgY2hpbGRyZW4sCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIGhhc1BheWxvYWQsCiAgICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgICBvZmZzZXQsCiAgICAgIHBvc2l0aW9uLAogICAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgICB1c2VUcmFuc2xhdGUzZCwKICAgICAgdmlld0JveCwKICAgICAgd3JhcHBlclN0eWxlLAogICAgICBsYXN0Qm91bmRpbmdCb3gsCiAgICAgIGlubmVyUmVmLAogICAgICBoYXNQb3J0YWxGcm9tUHJvcHMKICAgIH0gPSB0aGlzLnByb3BzOwogICAgdmFyIHsKICAgICAgY3NzQ2xhc3NlcywKICAgICAgY3NzUHJvcGVydGllcwogICAgfSA9IGdldFRvb2x0aXBUcmFuc2xhdGUoewogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIG9mZnNldFRvcExlZnQ6IG9mZnNldCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHRvb2x0aXBCb3g6IHsKICAgICAgICBoZWlnaHQ6IGxhc3RCb3VuZGluZ0JveC5oZWlnaHQsCiAgICAgICAgd2lkdGg6IGxhc3RCb3VuZGluZ0JveC53aWR0aAogICAgICB9LAogICAgICB1c2VUcmFuc2xhdGUzZCwKICAgICAgdmlld0JveAogICAgfSk7CiAgICB2YXIgcG9zaXRpb25TdHlsZXMgPSBoYXNQb3J0YWxGcm9tUHJvcHMgPyB7fSA6IF9vYmplY3RTcHJlYWQ3KF9vYmplY3RTcHJlYWQ3KHsKICAgICAgdHJhbnNpdGlvbjogaXNBbmltYXRpb25BY3RpdmUgJiYgYWN0aXZlID8gInRyYW5zZm9ybSAiLmNvbmNhdChhbmltYXRpb25EdXJhdGlvbiwgIm1zICIpLmNvbmNhdChhbmltYXRpb25FYXNpbmcpIDogdm9pZCAwCiAgICB9LCBjc3NQcm9wZXJ0aWVzKSwge30sIHsKICAgICAgcG9pbnRlckV2ZW50czogIm5vbmUiLAogICAgICB2aXNpYmlsaXR5OiAhdGhpcy5zdGF0ZS5kaXNtaXNzZWQgJiYgYWN0aXZlICYmIGhhc1BheWxvYWQgPyAidmlzaWJsZSIgOiAiaGlkZGVuIiwKICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgIHRvcDogMCwKICAgICAgbGVmdDogMAogICAgfSk7CiAgICB2YXIgb3V0ZXJTdHlsZSA9IF9vYmplY3RTcHJlYWQ3KF9vYmplY3RTcHJlYWQ3KHt9LCBwb3NpdGlvblN0eWxlcyksIHt9LCB7CiAgICAgIHZpc2liaWxpdHk6ICF0aGlzLnN0YXRlLmRpc21pc3NlZCAmJiBhY3RpdmUgJiYgaGFzUGF5bG9hZCA/ICJ2aXNpYmxlIiA6ICJoaWRkZW4iCiAgICB9LCB3cmFwcGVyU3R5bGUpOwogICAgcmV0dXJuICgKICAgICAgLy8gVGhpcyBlbGVtZW50IGFsbG93IGxpc3RlbmluZyB0byB0aGUgYEVzY2FwZWAga2V5LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3JlY2hhcnRzL3JlY2hhcnRzL3B1bGwvMjkyNQogICAgICAvKiBAX19QVVJFX18gKi8gUmVhY3Q3LmNyZWF0ZUVsZW1lbnQoImRpdiIsIHsKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHR5cGVzY3JpcHQgbGlicmFyeSBkb2VzIG5vdCByZWNvZ25pemUgeG1sbnMgYXR0cmlidXRlLCBidXQgaXQncyByZXF1aXJlZCBmb3IgYW4gSFRNTCBjaHVuayBpbnNpZGUgU1ZHLgogICAgICAgIHhtbG5zOiAiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIsCiAgICAgICAgdGFiSW5kZXg6IC0xLAogICAgICAgIGNsYXNzTmFtZTogY3NzQ2xhc3NlcywKICAgICAgICBzdHlsZTogb3V0ZXJTdHlsZSwKICAgICAgICByZWY6IGlubmVyUmVmCiAgICAgIH0sIGNoaWxkcmVuKQogICAgKTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvYWNjZXNzaWJpbGl0eUNvbnRleHQuanMKdmFyIHVzZUFjY2Vzc2liaWxpdHlMYXllciA9ICgpID0+IHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yOwogIHJldHVybiAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuYWNjZXNzaWJpbGl0eUxheWVyKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IgOiB0cnVlOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQ3Vyc29yLmpzCnZhciBSZWFjdDEyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL0N1cnZlLmpzCnZhciBSZWFjdDggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIF9leHRlbmRzNigpIHsKICByZXR1cm4gX2V4dGVuZHM2ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM2LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czgoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ4KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzOChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5OChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM4KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk4KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5OChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk4KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTgodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIENVUlZFX0ZBQ1RPUklFUyA9IHsKICBjdXJ2ZUJhc2lzQ2xvc2VkOiBiYXNpc0Nsb3NlZF9kZWZhdWx0LAogIGN1cnZlQmFzaXNPcGVuOiBiYXNpc09wZW5fZGVmYXVsdCwKICBjdXJ2ZUJhc2lzOiBiYXNpc19kZWZhdWx0LAogIGN1cnZlQnVtcFg6IGJ1bXBYLAogIGN1cnZlQnVtcFk6IGJ1bXBZLAogIGN1cnZlTGluZWFyQ2xvc2VkOiBsaW5lYXJDbG9zZWRfZGVmYXVsdCwKICBjdXJ2ZUxpbmVhcjogbGluZWFyX2RlZmF1bHQsCiAgY3VydmVNb25vdG9uZVg6IG1vbm90b25lWCwKICBjdXJ2ZU1vbm90b25lWTogbW9ub3RvbmVZLAogIGN1cnZlTmF0dXJhbDogbmF0dXJhbF9kZWZhdWx0LAogIGN1cnZlU3RlcDogc3RlcF9kZWZhdWx0LAogIGN1cnZlU3RlcEFmdGVyOiBzdGVwQWZ0ZXIsCiAgY3VydmVTdGVwQmVmb3JlOiBzdGVwQmVmb3JlCn07CnZhciBkZWZpbmVkID0gKHApID0+IGlzV2VsbEJlaGF2ZWROdW1iZXIocC54KSAmJiBpc1dlbGxCZWhhdmVkTnVtYmVyKHAueSk7CnZhciBhcmVhRGVmaW5lZCA9IChkKSA9PiBkLmJhc2UgIT0gbnVsbCAmJiBkZWZpbmVkKGQuYmFzZSkgJiYgZGVmaW5lZChkKTsKdmFyIGdldFggPSAocCkgPT4gcC54Owp2YXIgZ2V0WSA9IChwKSA9PiBwLnk7CnZhciBnZXRDdXJ2ZUZhY3RvcnkgPSAodHlwZSwgbGF5b3V0KSA9PiB7CiAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gdHlwZTsKICB9CiAgdmFyIG5hbWUgPSAiY3VydmUiLmNvbmNhdCh1cHBlckZpcnN0KHR5cGUpKTsKICBpZiAoKG5hbWUgPT09ICJjdXJ2ZU1vbm90b25lIiB8fCBuYW1lID09PSAiY3VydmVCdW1wIikgJiYgbGF5b3V0KSB7CiAgICByZXR1cm4gQ1VSVkVfRkFDVE9SSUVTWyIiLmNvbmNhdChuYW1lKS5jb25jYXQobGF5b3V0ID09PSAidmVydGljYWwiID8gIlkiIDogIlgiKV07CiAgfQogIHJldHVybiBDVVJWRV9GQUNUT1JJRVNbbmFtZV0gfHwgbGluZWFyX2RlZmF1bHQ7Cn07CnZhciBnZXRQYXRoID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHR5cGUgPSAibGluZWFyIiwKICAgIHBvaW50cyA9IFtdLAogICAgYmFzZUxpbmUsCiAgICBsYXlvdXQsCiAgICBjb25uZWN0TnVsbHMgPSBmYWxzZQogIH0gPSBfcmVmMjsKICB2YXIgY3VydmVGYWN0b3J5ID0gZ2V0Q3VydmVGYWN0b3J5KHR5cGUsIGxheW91dCk7CiAgdmFyIGZvcm1hdFBvaW50cyA9IGNvbm5lY3ROdWxscyA/IHBvaW50cy5maWx0ZXIoZGVmaW5lZCkgOiBwb2ludHM7CiAgdmFyIGxpbmVGdW5jdGlvbjsKICBpZiAoQXJyYXkuaXNBcnJheShiYXNlTGluZSkpIHsKICAgIHZhciBhcmVhUG9pbnRzID0gcG9pbnRzLm1hcCgoZW50cnksIGluZGV4KSA9PiBfb2JqZWN0U3ByZWFkOChfb2JqZWN0U3ByZWFkOCh7fSwgZW50cnkpLCB7fSwgewogICAgICBiYXNlOiBiYXNlTGluZVtpbmRleF0KICAgIH0pKTsKICAgIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgICAgbGluZUZ1bmN0aW9uID0gYXJlYV9kZWZhdWx0KCkueShnZXRZKS54MShnZXRYKS54MCgoZCkgPT4gZC5iYXNlLngpOwogICAgfSBlbHNlIHsKICAgICAgbGluZUZ1bmN0aW9uID0gYXJlYV9kZWZhdWx0KCkueChnZXRYKS55MShnZXRZKS55MCgoZCkgPT4gZC5iYXNlLnkpOwogICAgfQogICAgdmFyIF9udWxsYWJsZUxpbmVGdW5jdGlvbiA9IGxpbmVGdW5jdGlvbi5kZWZpbmVkKGFyZWFEZWZpbmVkKS5jdXJ2ZShjdXJ2ZUZhY3RvcnkpOwogICAgdmFyIGZpbmFsUG9pbnRzID0gY29ubmVjdE51bGxzID8gYXJlYVBvaW50cy5maWx0ZXIoYXJlYURlZmluZWQpIDogYXJlYVBvaW50czsKICAgIHJldHVybiBfbnVsbGFibGVMaW5lRnVuY3Rpb24oZmluYWxQb2ludHMpOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiICYmIGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgbGluZUZ1bmN0aW9uID0gYXJlYV9kZWZhdWx0KCkueShnZXRZKS54MShnZXRYKS54MChiYXNlTGluZSk7CiAgfSBlbHNlIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLngoZ2V0WCkueTEoZ2V0WSkueTAoYmFzZUxpbmUpOwogIH0gZWxzZSB7CiAgICBsaW5lRnVuY3Rpb24gPSBsaW5lX2RlZmF1bHQoKS54KGdldFgpLnkoZ2V0WSk7CiAgfQogIHZhciBudWxsYWJsZUxpbmVGdW5jdGlvbiA9IGxpbmVGdW5jdGlvbi5kZWZpbmVkKGRlZmluZWQpLmN1cnZlKGN1cnZlRmFjdG9yeSk7CiAgcmV0dXJuIG51bGxhYmxlTGluZUZ1bmN0aW9uKGZvcm1hdFBvaW50cyk7Cn07CnZhciBDdXJ2ZSA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBjbGFzc05hbWUsCiAgICBwb2ludHMsCiAgICBwYXRoOiBwYXRoMiwKICAgIHBhdGhSZWYKICB9ID0gcHJvcHM7CiAgaWYgKCghcG9pbnRzIHx8ICFwb2ludHMubGVuZ3RoKSAmJiAhcGF0aDIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcmVhbFBhdGggPSBwb2ludHMgJiYgcG9pbnRzLmxlbmd0aCA/IGdldFBhdGgocHJvcHMpIDogcGF0aDI7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDguY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzNih7fSwgc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKSwgYWRhcHRFdmVudEhhbmRsZXJzKHByb3BzKSwgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jdXJ2ZSIsIGNsYXNzTmFtZSksCiAgICBkOiByZWFsUGF0aCA9PT0gbnVsbCA/IHZvaWQgMCA6IHJlYWxQYXRoLAogICAgcmVmOiBwYXRoUmVmCiAgfSkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9Dcm9zcy5qcwp2YXIgUmVhY3Q5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkNCA9IFsieCIsICJ5IiwgInRvcCIsICJsZWZ0IiwgIndpZHRoIiwgImhlaWdodCIsICJjbGFzc05hbWUiXTsKZnVuY3Rpb24gX2V4dGVuZHM3KCkgewogIHJldHVybiBfZXh0ZW5kczcgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczcuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzOShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDkoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM5KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czkoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlOSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU5KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM0KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U0KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U0KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgZ2V0UGF0aDIgPSAoeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCB0b3AsIGxlZnQpID0+IHsKICByZXR1cm4gIk0iLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQodG9wLCAidiIpLmNvbmNhdChoZWlnaHQsICJNIikuY29uY2F0KGxlZnQsICIsIikuY29uY2F0KHkyLCAiaCIpLmNvbmNhdCh3aWR0aCk7Cn07CnZhciBDcm9zcyA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB4OiB4MiA9IDAsCiAgICB5OiB5MiA9IDAsCiAgICB0b3AgPSAwLAogICAgbGVmdCA9IDAsCiAgICB3aWR0aCA9IDAsCiAgICBoZWlnaHQgPSAwLAogICAgY2xhc3NOYW1lCiAgfSA9IF9yZWYyLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChfcmVmMiwgX2V4Y2x1ZGVkNCk7CiAgdmFyIHByb3BzID0gX29iamVjdFNwcmVhZDkoewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHRvcCwKICAgIGxlZnQsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0sIHJlc3QpOwogIGlmICghaXNOdW1iZXIoeDIpIHx8ICFpc051bWJlcih5MikgfHwgIWlzTnVtYmVyKHdpZHRoKSB8fCAhaXNOdW1iZXIoaGVpZ2h0KSB8fCAhaXNOdW1iZXIodG9wKSB8fCAhaXNOdW1iZXIobGVmdCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0OS5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM3KHt9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jcm9zcyIsIGNsYXNzTmFtZSksCiAgICBkOiBnZXRQYXRoMih4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHRvcCwgbGVmdCkKICB9KSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvY3Vyc29yL2dldEN1cnNvclJlY3RhbmdsZS5qcwpmdW5jdGlvbiBnZXRDdXJzb3JSZWN0YW5nbGUobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQsIHRvb2x0aXBBeGlzQmFuZFNpemUpIHsKICB2YXIgaGFsZlNpemUgPSB0b29sdGlwQXhpc0JhbmRTaXplIC8gMjsKICByZXR1cm4gewogICAgc3Ryb2tlOiAibm9uZSIsCiAgICBmaWxsOiAiI2NjYyIsCiAgICB4OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IGFjdGl2ZUNvb3JkaW5hdGUueCAtIGhhbGZTaXplIDogb2Zmc2V0LmxlZnQgKyAwLjUsCiAgICB5OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IG9mZnNldC50b3AgKyAwLjUgOiBhY3RpdmVDb29yZGluYXRlLnkgLSBoYWxmU2l6ZSwKICAgIHdpZHRoOiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHRvb2x0aXBBeGlzQmFuZFNpemUgOiBvZmZzZXQud2lkdGggLSAxLAogICAgaGVpZ2h0OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IG9mZnNldC5oZWlnaHQgLSAxIDogdG9vbHRpcEF4aXNCYW5kU2l6ZQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvUmVjdGFuZ2xlLmpzCnZhciBSZWFjdDEwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9KYXZhc2NyaXB0QW5pbWF0ZS5qcwp2YXIgaW1wb3J0X3JlYWN0MTYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi91dGlsLmpzCmZ1bmN0aW9uIG93bktleXMxMChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDEwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTAoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTEwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czEwKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTEwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTEwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTEwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTEwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZ2V0RGFzaENhc2UgPSAobmFtZSkgPT4gbmFtZS5yZXBsYWNlKC8oW0EtWl0pL2csICh2KSA9PiAiLSIuY29uY2F0KHYudG9Mb3dlckNhc2UoKSkpOwp2YXIgZ2V0VHJhbnNpdGlvblZhbCA9IChwcm9wcywgZHVyYXRpb24sIGVhc2luZykgPT4gcHJvcHMubWFwKChwcm9wKSA9PiAiIi5jb25jYXQoZ2V0RGFzaENhc2UocHJvcCksICIgIikuY29uY2F0KGR1cmF0aW9uLCAibXMgIikuY29uY2F0KGVhc2luZykpLmpvaW4oIiwiKTsKdmFyIGdldEludGVyc2VjdGlvbktleXMgPSAocHJlT2JqLCBuZXh0T2JqKSA9PiBbT2JqZWN0LmtleXMocHJlT2JqKSwgT2JqZWN0LmtleXMobmV4dE9iaildLnJlZHVjZSgoYTIsIGIpID0+IGEyLmZpbHRlcigoYzIpID0+IGIuaW5jbHVkZXMoYzIpKSk7CnZhciBtYXBPYmplY3QgPSAoZm4sIG9iaikgPT4gT2JqZWN0LmtleXMob2JqKS5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCByZXMpLCB7fSwgewogIFtrZXldOiBmbihrZXksIG9ialtrZXldKQp9KSwge30pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vY29uZmlnVXBkYXRlLmpzCmZ1bmN0aW9uIG93bktleXMxMShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDExKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTEoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTExKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czExKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTExKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTExKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTExKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTExKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgYWxwaGEgPSAoYmVnaW4sIGVuZCwgazIpID0+IGJlZ2luICsgKGVuZCAtIGJlZ2luKSAqIGsyOwp2YXIgbmVlZENvbnRpbnVlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGZyb206IGZyb20yLAogICAgdG86IHRvMgogIH0gPSBfcmVmMjsKICByZXR1cm4gZnJvbTIgIT09IHRvMjsKfTsKdmFyIGNhbFN0ZXBwZXJWYWxzID0gKGVhc2luZywgcHJlVmFscywgc3RlcHMpID0+IHsKICB2YXIgbmV4dFN0ZXBWYWxzID0gbWFwT2JqZWN0KChrZXksIHZhbCkgPT4gewogICAgaWYgKG5lZWRDb250aW51ZSh2YWwpKSB7CiAgICAgIHZhciBbbmV3WCwgbmV3Vl0gPSBlYXNpbmcodmFsLmZyb20sIHZhbC50bywgdmFsLnZlbG9jaXR5KTsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoe30sIHZhbCksIHt9LCB7CiAgICAgICAgZnJvbTogbmV3WCwKICAgICAgICB2ZWxvY2l0eTogbmV3VgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB2YWw7CiAgfSwgcHJlVmFscyk7CiAgaWYgKHN0ZXBzIDwgMSkgewogICAgcmV0dXJuIG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHsKICAgICAgaWYgKG5lZWRDb250aW51ZSh2YWwpKSB7CiAgICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoe30sIHZhbCksIHt9LCB7CiAgICAgICAgICB2ZWxvY2l0eTogYWxwaGEodmFsLnZlbG9jaXR5LCBuZXh0U3RlcFZhbHNba2V5XS52ZWxvY2l0eSwgc3RlcHMpLAogICAgICAgICAgZnJvbTogYWxwaGEodmFsLmZyb20sIG5leHRTdGVwVmFsc1trZXldLmZyb20sIHN0ZXBzKQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB2YWw7CiAgICB9LCBwcmVWYWxzKTsKICB9CiAgcmV0dXJuIGNhbFN0ZXBwZXJWYWxzKGVhc2luZywgbmV4dFN0ZXBWYWxzLCBzdGVwcyAtIDEpOwp9OwpmdW5jdGlvbiBjcmVhdGVTdGVwcGVyVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIHByZVRpbWU7CiAgdmFyIHN0ZXBwZXJTdHlsZSA9IGludGVyS2V5cy5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkMTEoX29iamVjdFNwcmVhZDExKHt9LCByZXMpLCB7fSwgewogICAgW2tleV06IHsKICAgICAgZnJvbTogZnJvbTJba2V5XSwKICAgICAgdmVsb2NpdHk6IDAsCiAgICAgIHRvOiB0bzJba2V5XQogICAgfQogIH0pLCB7fSk7CiAgdmFyIGdldEN1cnJTdHlsZSA9ICgpID0+IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHZhbC5mcm9tLCBzdGVwcGVyU3R5bGUpOwogIHZhciBzaG91bGRTdG9wQW5pbWF0aW9uID0gKCkgPT4gIU9iamVjdC52YWx1ZXMoc3RlcHBlclN0eWxlKS5maWx0ZXIobmVlZENvbnRpbnVlKS5sZW5ndGg7CiAgdmFyIHN0b3BBbmltYXRpb24gPSBudWxsOwogIHZhciBzdGVwcGVyVXBkYXRlID0gKG5vdykgPT4gewogICAgaWYgKCFwcmVUaW1lKSB7CiAgICAgIHByZVRpbWUgPSBub3c7CiAgICB9CiAgICB2YXIgZGVsdGFUaW1lID0gbm93IC0gcHJlVGltZTsKICAgIHZhciBzdGVwcyA9IGRlbHRhVGltZSAvIGVhc2luZy5kdDsKICAgIHN0ZXBwZXJTdHlsZSA9IGNhbFN0ZXBwZXJWYWxzKGVhc2luZywgc3RlcHBlclN0eWxlLCBzdGVwcyk7CiAgICByZW5kZXIoX29iamVjdFNwcmVhZDExKF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoe30sIGZyb20yKSwgdG8yKSwgZ2V0Q3VyclN0eWxlKCkpKTsKICAgIHByZVRpbWUgPSBub3c7CiAgICBpZiAoIXNob3VsZFN0b3BBbmltYXRpb24oKSkgewogICAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzdGVwcGVyVXBkYXRlKTsKICAgIH0KICB9OwogIHJldHVybiAoKSA9PiB7CiAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzdGVwcGVyVXBkYXRlKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBfc3RvcEFuaW1hdGlvbjsKICAgICAgKF9zdG9wQW5pbWF0aW9uID0gc3RvcEFuaW1hdGlvbikgPT09IG51bGwgfHwgX3N0b3BBbmltYXRpb24gPT09IHZvaWQgMCB8fCBfc3RvcEFuaW1hdGlvbigpOwogICAgfTsKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZVRpbWluZ1VwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpIHsKICB2YXIgc3RvcEFuaW1hdGlvbiA9IG51bGw7CiAgdmFyIHRpbWluZ1N0eWxlID0gaW50ZXJLZXlzLnJlZHVjZSgocmVzLCBrZXkpID0+IF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoe30sIHJlcyksIHt9LCB7CiAgICBba2V5XTogW2Zyb20yW2tleV0sIHRvMltrZXldXQogIH0pLCB7fSk7CiAgdmFyIGJlZ2luVGltZTsKICB2YXIgdGltaW5nVXBkYXRlID0gKG5vdykgPT4gewogICAgaWYgKCFiZWdpblRpbWUpIHsKICAgICAgYmVnaW5UaW1lID0gbm93OwogICAgfQogICAgdmFyIHQgPSAobm93IC0gYmVnaW5UaW1lKSAvIGR1cmF0aW9uOwogICAgdmFyIGN1cnJTdHlsZSA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IGFscGhhKC4uLnZhbCwgZWFzaW5nKHQpKSwgdGltaW5nU3R5bGUpOwogICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoX29iamVjdFNwcmVhZDExKHt9LCBmcm9tMiksIHRvMiksIGN1cnJTdHlsZSkpOwogICAgaWYgKHQgPCAxKSB7CiAgICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHRpbWluZ1VwZGF0ZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZmluYWxTdHlsZSA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IGFscGhhKC4uLnZhbCwgZWFzaW5nKDEpKSwgdGltaW5nU3R5bGUpOwogICAgICByZW5kZXIoX29iamVjdFNwcmVhZDExKF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoe30sIGZyb20yKSwgdG8yKSwgZmluYWxTdHlsZSkpOwogICAgfQogIH07CiAgcmV0dXJuICgpID0+IHsKICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHRpbWluZ1VwZGF0ZSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICB2YXIgX3N0b3BBbmltYXRpb24yOwogICAgICAoX3N0b3BBbmltYXRpb24yID0gc3RvcEFuaW1hdGlvbikgPT09IG51bGwgfHwgX3N0b3BBbmltYXRpb24yID09PSB2b2lkIDAgfHwgX3N0b3BBbmltYXRpb24yKCk7CiAgICB9OwogIH07Cn0KdmFyIGNvbmZpZ1VwZGF0ZV9kZWZhdWx0ID0gKGZyb20yLCB0bzIsIGVhc2luZywgZHVyYXRpb24sIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpID0+IHsKICB2YXIgaW50ZXJLZXlzID0gZ2V0SW50ZXJzZWN0aW9uS2V5cyhmcm9tMiwgdG8yKTsKICBpZiAoZWFzaW5nID09IG51bGwpIHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHJlbmRlcihfb2JqZWN0U3ByZWFkMTEoX29iamVjdFNwcmVhZDExKHt9LCBmcm9tMiksIHRvMikpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICB9OwogICAgfTsKICB9CiAgcmV0dXJuIGVhc2luZy5pc1N0ZXBwZXIgPT09IHRydWUgPyBjcmVhdGVTdGVwcGVyVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSA6IGNyZWF0ZVRpbWluZ1VwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vZWFzaW5nLmpzCnZhciBBQ0NVUkFDWSA9IDFlLTQ7CnZhciBjdWJpY0JlemllckZhY3RvciA9IChjMSwgYzIpID0+IFswLCAzICogYzEsIDMgKiBjMiAtIDYgKiBjMSwgMyAqIGMxIC0gMyAqIGMyICsgMV07CnZhciBldmFsdWF0ZVBvbHlub21pYWwgPSAocGFyYW1zLCB0KSA9PiBwYXJhbXMubWFwKChwYXJhbSwgaSkgPT4gcGFyYW0gKiB0ICoqIGkpLnJlZHVjZSgocHJlLCBjdXJyKSA9PiBwcmUgKyBjdXJyKTsKdmFyIGN1YmljQmV6aWVyID0gKGMxLCBjMikgPT4gKHQpID0+IHsKICB2YXIgcGFyYW1zID0gY3ViaWNCZXppZXJGYWN0b3IoYzEsIGMyKTsKICByZXR1cm4gZXZhbHVhdGVQb2x5bm9taWFsKHBhcmFtcywgdCk7Cn07CnZhciBkZXJpdmF0aXZlQ3ViaWNCZXppZXIgPSAoYzEsIGMyKSA9PiAodCkgPT4gewogIHZhciBwYXJhbXMgPSBjdWJpY0JlemllckZhY3RvcihjMSwgYzIpOwogIHZhciBuZXdQYXJhbXMgPSBbLi4ucGFyYW1zLm1hcCgocGFyYW0sIGkpID0+IHBhcmFtICogaSkuc2xpY2UoMSksIDBdOwogIHJldHVybiBldmFsdWF0ZVBvbHlub21pYWwobmV3UGFyYW1zLCB0KTsKfTsKdmFyIGdldEJlemllckNvb3JkaW5hdGVzID0gZnVuY3Rpb24gZ2V0QmV6aWVyQ29vcmRpbmF0ZXMyKCkgewogIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICB9CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAxKSB7CiAgICBzd2l0Y2ggKGFyZ3NbMF0pIHsKICAgICAgY2FzZSAibGluZWFyIjoKICAgICAgICByZXR1cm4gWzAsIDAsIDEsIDFdOwogICAgICBjYXNlICJlYXNlIjoKICAgICAgICByZXR1cm4gWzAuMjUsIDAuMSwgMC4yNSwgMV07CiAgICAgIGNhc2UgImVhc2UtaW4iOgogICAgICAgIHJldHVybiBbMC40MiwgMCwgMSwgMV07CiAgICAgIGNhc2UgImVhc2Utb3V0IjoKICAgICAgICByZXR1cm4gWzAuNDIsIDAsIDAuNTgsIDFdOwogICAgICBjYXNlICJlYXNlLWluLW91dCI6CiAgICAgICAgcmV0dXJuIFswLCAwLCAwLjU4LCAxXTsKICAgICAgZGVmYXVsdDogewogICAgICAgIHZhciBfZWFzaW5nJDsKICAgICAgICB2YXIgZWFzaW5nID0gYXJnc1swXS5zcGxpdCgiKCIpOwogICAgICAgIGlmIChlYXNpbmdbMF0gPT09ICJjdWJpYy1iZXppZXIiICYmICgoX2Vhc2luZyQgPSBlYXNpbmdbMV0pID09PSBudWxsIHx8IF9lYXNpbmckID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZWFzaW5nJC5zcGxpdCgiKSIpWzBdLnNwbGl0KCIsIikubGVuZ3RoKSA9PT0gNCkgewogICAgICAgICAgdmFyIGNvb3JkcyA9IGVhc2luZ1sxXS5zcGxpdCgiKSIpWzBdLnNwbGl0KCIsIikubWFwKCh4MikgPT4gcGFyc2VGbG9hdCh4MikpOwogICAgICAgICAgcmV0dXJuIFtjb29yZHNbMF0sIGNvb3Jkc1sxXSwgY29vcmRzWzJdLCBjb29yZHNbM11dOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBpZiAoYXJncy5sZW5ndGggPT09IDQpIHsKICAgIHJldHVybiBhcmdzOwogIH0KICByZXR1cm4gWzAsIDAsIDEsIDFdOwp9Owp2YXIgY3JlYXRlQmV6aWVyRWFzaW5nID0gKHgxLCB5MSwgeDIsIHkyKSA9PiB7CiAgdmFyIGN1cnZlWCA9IGN1YmljQmV6aWVyKHgxLCB4Mik7CiAgdmFyIGN1cnZlWSA9IGN1YmljQmV6aWVyKHkxLCB5Mik7CiAgdmFyIGRlckN1cnZlWCA9IGRlcml2YXRpdmVDdWJpY0Jlemllcih4MSwgeDIpOwogIHZhciByYW5nZVZhbHVlID0gKHZhbHVlKSA9PiB7CiAgICBpZiAodmFsdWUgPiAxKSB7CiAgICAgIHJldHVybiAxOwogICAgfQogICAgaWYgKHZhbHVlIDwgMCkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9OwogIHZhciBiZXppZXIgPSAoX3QpID0+IHsKICAgIHZhciB0ID0gX3QgPiAxID8gMSA6IF90OwogICAgdmFyIHgzID0gdDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgKytpKSB7CiAgICAgIHZhciBldmFsVCA9IGN1cnZlWCh4MykgLSB0OwogICAgICB2YXIgZGVyVmFsID0gZGVyQ3VydmVYKHgzKTsKICAgICAgaWYgKE1hdGguYWJzKGV2YWxUIC0gdCkgPCBBQ0NVUkFDWSB8fCBkZXJWYWwgPCBBQ0NVUkFDWSkgewogICAgICAgIHJldHVybiBjdXJ2ZVkoeDMpOwogICAgICB9CiAgICAgIHgzID0gcmFuZ2VWYWx1ZSh4MyAtIGV2YWxUIC8gZGVyVmFsKTsKICAgIH0KICAgIHJldHVybiBjdXJ2ZVkoeDMpOwogIH07CiAgYmV6aWVyLmlzU3RlcHBlciA9IGZhbHNlOwogIHJldHVybiBiZXppZXI7Cn07CnZhciBjb25maWdCZXppZXIgPSBmdW5jdGlvbiBjb25maWdCZXppZXIyKCkgewogIHJldHVybiBjcmVhdGVCZXppZXJFYXNpbmcoLi4uZ2V0QmV6aWVyQ29vcmRpbmF0ZXMoLi4uYXJndW1lbnRzKSk7Cn07CnZhciBjb25maWdTcHJpbmcgPSBmdW5jdGlvbiBjb25maWdTcHJpbmcyKCkgewogIHZhciBjb25maWcgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1swXSA6IHt9OwogIHZhciB7CiAgICBzdGlmZiA9IDEwMCwKICAgIGRhbXBpbmcgPSA4LAogICAgZHQgPSAxNwogIH0gPSBjb25maWc7CiAgdmFyIHN0ZXBwZXIgPSAoY3VyclgsIGRlc3RYLCBjdXJyVikgPT4gewogICAgdmFyIEZTcHJpbmcgPSAtKGN1cnJYIC0gZGVzdFgpICogc3RpZmY7CiAgICB2YXIgRkRhbXBpbmcgPSBjdXJyViAqIGRhbXBpbmc7CiAgICB2YXIgbmV3ViA9IGN1cnJWICsgKEZTcHJpbmcgLSBGRGFtcGluZykgKiBkdCAvIDFlMzsKICAgIHZhciBuZXdYID0gY3VyclYgKiBkdCAvIDFlMyArIGN1cnJYOwogICAgaWYgKE1hdGguYWJzKG5ld1ggLSBkZXN0WCkgPCBBQ0NVUkFDWSAmJiBNYXRoLmFicyhuZXdWKSA8IEFDQ1VSQUNZKSB7CiAgICAgIHJldHVybiBbZGVzdFgsIDBdOwogICAgfQogICAgcmV0dXJuIFtuZXdYLCBuZXdWXTsKICB9OwogIHN0ZXBwZXIuaXNTdGVwcGVyID0gdHJ1ZTsKICBzdGVwcGVyLmR0ID0gZHQ7CiAgcmV0dXJuIHN0ZXBwZXI7Cn07CnZhciBjb25maWdFYXNpbmcgPSAoZWFzaW5nKSA9PiB7CiAgaWYgKHR5cGVvZiBlYXNpbmcgPT09ICJzdHJpbmciKSB7CiAgICBzd2l0Y2ggKGVhc2luZykgewogICAgICBjYXNlICJlYXNlIjoKICAgICAgY2FzZSAiZWFzZS1pbi1vdXQiOgogICAgICBjYXNlICJlYXNlLW91dCI6CiAgICAgIGNhc2UgImVhc2UtaW4iOgogICAgICBjYXNlICJsaW5lYXIiOgogICAgICAgIHJldHVybiBjb25maWdCZXppZXIoZWFzaW5nKTsKICAgICAgY2FzZSAic3ByaW5nIjoKICAgICAgICByZXR1cm4gY29uZmlnU3ByaW5nKCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKGVhc2luZy5zcGxpdCgiKCIpWzBdID09PSAiY3ViaWMtYmV6aWVyIikgewogICAgICAgICAgcmV0dXJuIGNvbmZpZ0JlemllcihlYXNpbmcpOwogICAgICAgIH0KICAgIH0KICB9CiAgaWYgKHR5cGVvZiBlYXNpbmcgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBlYXNpbmc7CiAgfQogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdXNlQW5pbWF0aW9uTWFuYWdlci5qcwp2YXIgaW1wb3J0X3JlYWN0MTUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9BbmltYXRpb25NYW5hZ2VyLmpzCmZ1bmN0aW9uIGNyZWF0ZUFuaW1hdGVNYW5hZ2VyKHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIGN1cnJTdHlsZTsKICB2YXIgaGFuZGxlQ2hhbmdlID0gKCkgPT4gbnVsbDsKICB2YXIgc2hvdWxkU3RvcCA9IGZhbHNlOwogIHZhciBjYW5jZWxUaW1lb3V0ID0gbnVsbDsKICB2YXIgc2V0U3R5bGUgPSAoX3N0eWxlKSA9PiB7CiAgICBpZiAoc2hvdWxkU3RvcCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheShfc3R5bGUpKSB7CiAgICAgIGlmICghX3N0eWxlLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgc3R5bGVzID0gX3N0eWxlOwogICAgICB2YXIgW2N1cnIsIC4uLnJlc3RTdHlsZXNdID0gc3R5bGVzOwogICAgICBpZiAodHlwZW9mIGN1cnIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgY2FuY2VsVGltZW91dCA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc2V0U3R5bGUuYmluZChudWxsLCByZXN0U3R5bGVzKSwgY3Vycik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNldFN0eWxlKGN1cnIpOwogICAgICBjYW5jZWxUaW1lb3V0ID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzZXRTdHlsZS5iaW5kKG51bGwsIHJlc3RTdHlsZXMpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHR5cGVvZiBfc3R5bGUgPT09ICJzdHJpbmciKSB7CiAgICAgIGN1cnJTdHlsZSA9IF9zdHlsZTsKICAgICAgaGFuZGxlQ2hhbmdlKGN1cnJTdHlsZSk7CiAgICB9CiAgICBpZiAodHlwZW9mIF9zdHlsZSA9PT0gIm9iamVjdCIpIHsKICAgICAgY3VyclN0eWxlID0gX3N0eWxlOwogICAgICBoYW5kbGVDaGFuZ2UoY3VyclN0eWxlKTsKICAgIH0KICAgIGlmICh0eXBlb2YgX3N0eWxlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIF9zdHlsZSgpOwogICAgfQogIH07CiAgcmV0dXJuIHsKICAgIHN0b3A6ICgpID0+IHsKICAgICAgc2hvdWxkU3RvcCA9IHRydWU7CiAgICB9LAogICAgc3RhcnQ6IChzdHlsZSkgPT4gewogICAgICBzaG91bGRTdG9wID0gZmFsc2U7CiAgICAgIGlmIChjYW5jZWxUaW1lb3V0KSB7CiAgICAgICAgY2FuY2VsVGltZW91dCgpOwogICAgICAgIGNhbmNlbFRpbWVvdXQgPSBudWxsOwogICAgICB9CiAgICAgIHNldFN0eWxlKHN0eWxlKTsKICAgIH0sCiAgICBzdWJzY3JpYmU6IChfaGFuZGxlQ2hhbmdlKSA9PiB7CiAgICAgIGhhbmRsZUNoYW5nZSA9IF9oYW5kbGVDaGFuZ2U7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgaGFuZGxlQ2hhbmdlID0gKCkgPT4gbnVsbDsKICAgICAgfTsKICAgIH0sCiAgICBnZXRUaW1lb3V0Q29udHJvbGxlcjogKCkgPT4gdGltZW91dENvbnRyb2xsZXIKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi90aW1lb3V0Q29udHJvbGxlci5qcwp2YXIgUmVxdWVzdEFuaW1hdGlvbkZyYW1lVGltZW91dENvbnRyb2xsZXIgPSBjbGFzcyB7CiAgc2V0VGltZW91dChjYWxsYmFjaykgewogICAgdmFyIGRlbGF5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiAwOwogICAgdmFyIHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgdmFyIHJlcXVlc3RJZCA9IG51bGw7CiAgICB2YXIgZXhlY3V0ZUNhbGxiYWNrID0gKG5vdykgPT4gewogICAgICBpZiAobm93IC0gc3RhcnRUaW1lID49IGRlbGF5KSB7CiAgICAgICAgY2FsbGJhY2sobm93KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmVxdWVzdElkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGV4ZWN1dGVDYWxsYmFjayk7CiAgICAgIH0KICAgIH07CiAgICByZXF1ZXN0SWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZXhlY3V0ZUNhbGxiYWNrKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChyZXF1ZXN0SWQgIT0gbnVsbCkgewogICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJlcXVlc3RJZCk7CiAgICAgIH0KICAgIH07CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vY3JlYXRlRGVmYXVsdEFuaW1hdGlvbk1hbmFnZXIuanMKZnVuY3Rpb24gY3JlYXRlRGVmYXVsdEFuaW1hdGlvbk1hbmFnZXIoKSB7CiAgcmV0dXJuIGNyZWF0ZUFuaW1hdGVNYW5hZ2VyKG5ldyBSZXF1ZXN0QW5pbWF0aW9uRnJhbWVUaW1lb3V0Q29udHJvbGxlcigpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdXNlQW5pbWF0aW9uTWFuYWdlci5qcwp2YXIgQW5pbWF0aW9uTWFuYWdlckNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDE1LmNyZWF0ZUNvbnRleHQpKGNyZWF0ZURlZmF1bHRBbmltYXRpb25NYW5hZ2VyKTsKZnVuY3Rpb24gdXNlQW5pbWF0aW9uTWFuYWdlcihhbmltYXRpb25JZCwgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcykgewogIHZhciBjb250ZXh0QW5pbWF0aW9uTWFuYWdlciA9ICgwLCBpbXBvcnRfcmVhY3QxNS51c2VDb250ZXh0KShBbmltYXRpb25NYW5hZ2VyQ29udGV4dCk7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QxNS51c2VNZW1vKSgoKSA9PiBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzICE9PSBudWxsICYmIGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgIT09IHZvaWQgMCA/IGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgOiBjb250ZXh0QW5pbWF0aW9uTWFuYWdlcihhbmltYXRpb25JZCksIFthbmltYXRpb25JZCwgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcywgY29udGV4dEFuaW1hdGlvbk1hbmFnZXJdKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0dsb2JhbC5qcwp2YXIgcGFyc2VJc1NzckJ5RGVmYXVsdCA9ICgpID0+ICEodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmRvY3VtZW50ICYmIEJvb2xlYW4od2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQpICYmIHdpbmRvdy5zZXRUaW1lb3V0KTsKdmFyIEdsb2JhbCA9IHsKICBkZXZUb29sc0VuYWJsZWQ6IGZhbHNlLAogIGlzU3NyOiBwYXJzZUlzU3NyQnlEZWZhdWx0KCkKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL0phdmFzY3JpcHRBbmltYXRlLmpzCnZhciBkZWZhdWx0SmF2YXNjcmlwdEFuaW1hdGVQcm9wcyA9IHsKICBiZWdpbjogMCwKICBkdXJhdGlvbjogMWUzLAogIGVhc2luZzogImVhc2UiLAogIGlzQWN0aXZlOiB0cnVlLAogIGNhbkJlZ2luOiB0cnVlLAogIG9uQW5pbWF0aW9uRW5kOiAoKSA9PiB7CiAgfSwKICBvbkFuaW1hdGlvblN0YXJ0OiAoKSA9PiB7CiAgfQp9Owp2YXIgZnJvbSA9IHsKICB0OiAwCn07CnZhciB0byA9IHsKICB0OiAxCn07CmZ1bmN0aW9uIEphdmFzY3JpcHRBbmltYXRlKG91dHNpZGVQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0SmF2YXNjcmlwdEFuaW1hdGVQcm9wcyk7CiAgdmFyIHsKICAgIGlzQWN0aXZlOiBpc0FjdGl2ZVByb3AsCiAgICBjYW5CZWdpbiwKICAgIGR1cmF0aW9uLAogICAgZWFzaW5nLAogICAgYmVnaW4sCiAgICBvbkFuaW1hdGlvbkVuZCwKICAgIG9uQW5pbWF0aW9uU3RhcnQsCiAgICBjaGlsZHJlbgogIH0gPSBwcm9wczsKICB2YXIgaXNBY3RpdmUgPSBpc0FjdGl2ZVByb3AgPT09ICJhdXRvIiA/ICFHbG9iYWwuaXNTc3IgOiBpc0FjdGl2ZVByb3A7CiAgdmFyIGFuaW1hdGlvbk1hbmFnZXIgPSB1c2VBbmltYXRpb25NYW5hZ2VyKHByb3BzLmFuaW1hdGlvbklkLCBwcm9wcy5hbmltYXRpb25NYW5hZ2VyKTsKICB2YXIgW3N0eWxlLCBzZXRTdHlsZV0gPSAoMCwgaW1wb3J0X3JlYWN0MTYudXNlU3RhdGUpKGlzQWN0aXZlID8gZnJvbSA6IHRvKTsKICB2YXIgc3RvcEpTQW5pbWF0aW9uID0gKDAsIGltcG9ydF9yZWFjdDE2LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDE2LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc0FjdGl2ZSkgewogICAgICBzZXRTdHlsZSh0byk7CiAgICB9CiAgfSwgW2lzQWN0aXZlXSk7CiAgKDAsIGltcG9ydF9yZWFjdDE2LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc0FjdGl2ZSB8fCAhY2FuQmVnaW4pIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgc3RhcnRBbmltYXRpb24gPSBjb25maWdVcGRhdGVfZGVmYXVsdChmcm9tLCB0bywgY29uZmlnRWFzaW5nKGVhc2luZyksIGR1cmF0aW9uLCBzZXRTdHlsZSwgYW5pbWF0aW9uTWFuYWdlci5nZXRUaW1lb3V0Q29udHJvbGxlcigpKTsKICAgIHZhciBvbkFuaW1hdGlvbkFjdGl2ZSA9ICgpID0+IHsKICAgICAgc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQgPSBzdGFydEFuaW1hdGlvbigpOwogICAgfTsKICAgIGFuaW1hdGlvbk1hbmFnZXIuc3RhcnQoW29uQW5pbWF0aW9uU3RhcnQsIGJlZ2luLCBvbkFuaW1hdGlvbkFjdGl2ZSwgZHVyYXRpb24sIG9uQW5pbWF0aW9uRW5kXSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBhbmltYXRpb25NYW5hZ2VyLnN0b3AoKTsKICAgICAgaWYgKHN0b3BKU0FuaW1hdGlvbi5jdXJyZW50KSB7CiAgICAgICAgc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQoKTsKICAgICAgfQogICAgICBvbkFuaW1hdGlvbkVuZCgpOwogICAgfTsKICB9LCBbaXNBY3RpdmUsIGNhbkJlZ2luLCBkdXJhdGlvbiwgZWFzaW5nLCBiZWdpbiwgb25BbmltYXRpb25TdGFydCwgb25BbmltYXRpb25FbmQsIGFuaW1hdGlvbk1hbmFnZXJdKTsKICByZXR1cm4gY2hpbGRyZW4oc3R5bGUudCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VBbmltYXRpb25JZC5qcwp2YXIgaW1wb3J0X3JlYWN0MTcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZUFuaW1hdGlvbklkKGlucHV0KSB7CiAgdmFyIHByZWZpeCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogImFuaW1hdGlvbi0iOwogIHZhciBhbmltYXRpb25JZCA9ICgwLCBpbXBvcnRfcmVhY3QxNy51c2VSZWYpKHVuaXF1ZUlkKHByZWZpeCkpOwogIHZhciBwcmV2UHJvcHMgPSAoMCwgaW1wb3J0X3JlYWN0MTcudXNlUmVmKShpbnB1dCk7CiAgaWYgKHByZXZQcm9wcy5jdXJyZW50ICE9PSBpbnB1dCkgewogICAgYW5pbWF0aW9uSWQuY3VycmVudCA9IHVuaXF1ZUlkKHByZWZpeCk7CiAgICBwcmV2UHJvcHMuY3VycmVudCA9IGlucHV0OwogIH0KICByZXR1cm4gYW5pbWF0aW9uSWQuY3VycmVudDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9SZWN0YW5nbGUuanMKdmFyIF9leGNsdWRlZDUgPSBbInJhZGl1cyJdOwp2YXIgX2V4Y2x1ZGVkMjIgPSBbInJhZGl1cyJdOwpmdW5jdGlvbiBvd25LZXlzMTIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czEyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxMihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxMihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxMih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHM4KCkgewogIHJldHVybiBfZXh0ZW5kczggPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczguYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM1KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U1KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U1KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgZ2V0UmVjdGFuZ2xlUGF0aCA9ICh4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHJhZGl1cykgPT4gewogIHZhciBtYXhSYWRpdXMgPSBNYXRoLm1pbihNYXRoLmFicyh3aWR0aCkgLyAyLCBNYXRoLmFicyhoZWlnaHQpIC8gMik7CiAgdmFyIHlTaWduID0gaGVpZ2h0ID49IDAgPyAxIDogLTE7CiAgdmFyIHhTaWduID0gd2lkdGggPj0gMCA/IDEgOiAtMTsKICB2YXIgY2xvY2tXaXNlID0gaGVpZ2h0ID49IDAgJiYgd2lkdGggPj0gMCB8fCBoZWlnaHQgPCAwICYmIHdpZHRoIDwgMCA/IDEgOiAwOwogIHZhciBwYXRoMjsKICBpZiAobWF4UmFkaXVzID4gMCAmJiByYWRpdXMgaW5zdGFuY2VvZiBBcnJheSkgewogICAgdmFyIG5ld1JhZGl1cyA9IFswLCAwLCAwLCAwXTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSA0OyBpIDwgbGVuOyBpKyspIHsKICAgICAgbmV3UmFkaXVzW2ldID0gcmFkaXVzW2ldID4gbWF4UmFkaXVzID8gbWF4UmFkaXVzIDogcmFkaXVzW2ldOwogICAgfQogICAgcGF0aDIgPSAiTSIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogbmV3UmFkaXVzWzBdKTsKICAgIGlmIChuZXdSYWRpdXNbMF0gPiAwKSB7CiAgICAgIHBhdGgyICs9ICJBICIuY29uY2F0KG5ld1JhZGl1c1swXSwgIiwiKS5jb25jYXQobmV3UmFkaXVzWzBdLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHhTaWduICogbmV3UmFkaXVzWzBdLCAiLCIpLmNvbmNhdCh5Mik7CiAgICB9CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHdpZHRoIC0geFNpZ24gKiBuZXdSYWRpdXNbMV0sICIsIikuY29uY2F0KHkyKTsKICAgIGlmIChuZXdSYWRpdXNbMV0gPiAwKSB7CiAgICAgIHBhdGgyICs9ICJBICIuY29uY2F0KG5ld1JhZGl1c1sxXSwgIiwiKS5jb25jYXQobmV3UmFkaXVzWzFdLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLFxuICAgICAgICAiKS5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIG5ld1JhZGl1c1sxXSk7CiAgICB9CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogbmV3UmFkaXVzWzJdKTsKICAgIGlmIChuZXdSYWRpdXNbMl0gPiAwKSB7CiAgICAgIHBhdGgyICs9ICJBICIuY29uY2F0KG5ld1JhZGl1c1syXSwgIiwiKS5jb25jYXQobmV3UmFkaXVzWzJdLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLFxuICAgICAgICAiKS5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogbmV3UmFkaXVzWzJdLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCk7CiAgICB9CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHhTaWduICogbmV3UmFkaXVzWzNdLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCk7CiAgICBpZiAobmV3UmFkaXVzWzNdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbM10sICIsIikuY29uY2F0KG5ld1JhZGl1c1szXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIixcbiAgICAgICAgIikuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogbmV3UmFkaXVzWzNdKTsKICAgIH0KICAgIHBhdGgyICs9ICJaIjsKICB9IGVsc2UgaWYgKG1heFJhZGl1cyA+IDAgJiYgcmFkaXVzID09PSArcmFkaXVzICYmIHJhZGl1cyA+IDApIHsKICAgIHZhciBfbmV3UmFkaXVzID0gTWF0aC5taW4obWF4UmFkaXVzLCByYWRpdXMpOwogICAgcGF0aDIgPSAiTSAiLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIF9uZXdSYWRpdXMsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgeFNpZ24gKiBfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdCh5MiwgIlxuICAgICAgICAgICAgTCAiKS5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBfbmV3UmFkaXVzLCAiXG4gICAgICAgICAgICBMICIpLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogX25ld1JhZGl1cywgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoX25ld1JhZGl1cywgIiwiKS5jb25jYXQoX25ld1JhZGl1cywgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQsICJcbiAgICAgICAgICAgIEwgIikuY29uY2F0KHgyICsgeFNpZ24gKiBfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCwgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoX25ld1JhZGl1cywgIiwiKS5jb25jYXQoX25ld1JhZGl1cywgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0IC0geVNpZ24gKiBfbmV3UmFkaXVzLCAiIFoiKTsKICB9IGVsc2UgewogICAgcGF0aDIgPSAiTSAiLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIsICIgaCAiKS5jb25jYXQod2lkdGgsICIgdiAiKS5jb25jYXQoaGVpZ2h0LCAiIGggIikuY29uY2F0KC13aWR0aCwgIiBaIik7CiAgfQogIHJldHVybiBwYXRoMjsKfTsKdmFyIGRlZmF1bHRSZWN0YW5nbGVQcm9wcyA9IHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIC8vIFRoZSByYWRpdXMgb2YgYm9yZGVyCiAgLy8gVGhlIHJhZGl1cyBvZiBmb3VyIGNvcm5lcnMgd2hlbiByYWRpdXMgaXMgYSBudW1iZXIKICAvLyBUaGUgcmFkaXVzIG9mIGxlZnQtdG9wLCByaWdodC10b3AsIHJpZ2h0LWJvdHRvbSwgbGVmdC1ib3R0b20gd2hlbiByYWRpdXMgaXMgYW4gYXJyYXkKICByYWRpdXM6IDAsCiAgaXNBbmltYXRpb25BY3RpdmU6IGZhbHNlLAogIGlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlOiBmYWxzZSwKICBhbmltYXRpb25CZWdpbjogMCwKICBhbmltYXRpb25EdXJhdGlvbjogMTUwMCwKICBhbmltYXRpb25FYXNpbmc6ICJlYXNlIgp9Owp2YXIgUmVjdGFuZ2xlID0gKHJlY3RhbmdsZVByb3BzKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhyZWN0YW5nbGVQcm9wcywgZGVmYXVsdFJlY3RhbmdsZVByb3BzKTsKICB2YXIgcGF0aFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKG51bGwpOwogIHZhciBbdG90YWxMZW5ndGgsIHNldFRvdGFsTGVuZ3RoXSA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VTdGF0ZSkoLTEpOwogICgwLCBpbXBvcnRfcmVhY3QxOC51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChwYXRoUmVmLmN1cnJlbnQgJiYgcGF0aFJlZi5jdXJyZW50LmdldFRvdGFsTGVuZ3RoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHBhdGhUb3RhbExlbmd0aCA9IHBhdGhSZWYuY3VycmVudC5nZXRUb3RhbExlbmd0aCgpOwogICAgICAgIGlmIChwYXRoVG90YWxMZW5ndGgpIHsKICAgICAgICAgIHNldFRvdGFsTGVuZ3RoKHBhdGhUb3RhbExlbmd0aCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICAgIH0KICAgIH0KICB9LCBbXSk7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJhZGl1cywKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICB2YXIgewogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgaXNVcGRhdGVBbmltYXRpb25BY3RpdmUKICB9ID0gcHJvcHM7CiAgdmFyIHByZXZXaWR0aFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKHdpZHRoKTsKICB2YXIgcHJldkhlaWdodFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKGhlaWdodCk7CiAgdmFyIHByZXZYUmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikoeDIpOwogIHZhciBwcmV2WVJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKHkyKTsKICB2YXIgYW5pbWF0aW9uSWRJbnB1dCA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VNZW1vKSgoKSA9PiAoewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmFkaXVzCiAgfSksIFt4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHJhZGl1c10pOwogIHZhciBhbmltYXRpb25JZCA9IHVzZUFuaW1hdGlvbklkKGFuaW1hdGlvbklkSW5wdXQsICJyZWN0YW5nbGUtIik7CiAgaWYgKHgyICE9PSAreDIgfHwgeTIgIT09ICt5MiB8fCB3aWR0aCAhPT0gK3dpZHRoIHx8IGhlaWdodCAhPT0gK2hlaWdodCB8fCB3aWR0aCA9PT0gMCB8fCBoZWlnaHQgPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLXJlY3RhbmdsZSIsIGNsYXNzTmFtZSk7CiAgaWYgKCFpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZSkgewogICAgdmFyIF9zdmdQcm9wZXJ0aWVzQW5kRXZlbiA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICAgIHJhZGl1czogXwogICAgfSA9IF9zdmdQcm9wZXJ0aWVzQW5kRXZlbiwgb3RoZXJQYXRoUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM1KF9zdmdQcm9wZXJ0aWVzQW5kRXZlbiwgX2V4Y2x1ZGVkNSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTAuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzOCh7fSwgb3RoZXJQYXRoUHJvcHMsIHsKICAgICAgcmFkaXVzOiB0eXBlb2YgcmFkaXVzID09PSAibnVtYmVyIiA/IHJhZGl1cyA6IHZvaWQgMCwKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgICBkOiBnZXRSZWN0YW5nbGVQYXRoKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgcmFkaXVzKQogICAgfSkpOwogIH0KICB2YXIgcHJldldpZHRoID0gcHJldldpZHRoUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZIZWlnaHQgPSBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZYID0gcHJldlhSZWYuY3VycmVudDsKICB2YXIgcHJldlkgPSBwcmV2WVJlZi5jdXJyZW50OwogIHZhciBmcm9tMiA9ICIwcHggIi5jb25jYXQodG90YWxMZW5ndGggPT09IC0xID8gMSA6IHRvdGFsTGVuZ3RoLCAicHgiKTsKICB2YXIgdG8yID0gIiIuY29uY2F0KHRvdGFsTGVuZ3RoLCAicHggMHB4Iik7CiAgdmFyIHRyYW5zaXRpb24gPSBnZXRUcmFuc2l0aW9uVmFsKFsic3Ryb2tlRGFzaGFycmF5Il0sIGFuaW1hdGlvbkR1cmF0aW9uLCB0eXBlb2YgYW5pbWF0aW9uRWFzaW5nID09PSAic3RyaW5nIiA/IGFuaW1hdGlvbkVhc2luZyA6IGRlZmF1bHRSZWN0YW5nbGVQcm9wcy5hbmltYXRpb25FYXNpbmcpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMC5jcmVhdGVFbGVtZW50KEphdmFzY3JpcHRBbmltYXRlLCB7CiAgICBhbmltYXRpb25JZCwKICAgIGtleTogYW5pbWF0aW9uSWQsCiAgICBjYW5CZWdpbjogdG90YWxMZW5ndGggPiAwLAogICAgZHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uLAogICAgZWFzaW5nOiBhbmltYXRpb25FYXNpbmcsCiAgICBpc0FjdGl2ZTogaXNVcGRhdGVBbmltYXRpb25BY3RpdmUsCiAgICBiZWdpbjogYW5pbWF0aW9uQmVnaW4KICB9LCAodCkgPT4gewogICAgdmFyIGN1cnJXaWR0aCA9IGludGVycG9sYXRlKHByZXZXaWR0aCwgd2lkdGgsIHQpOwogICAgdmFyIGN1cnJIZWlnaHQgPSBpbnRlcnBvbGF0ZShwcmV2SGVpZ2h0LCBoZWlnaHQsIHQpOwogICAgdmFyIGN1cnJYID0gaW50ZXJwb2xhdGUocHJldlgsIHgyLCB0KTsKICAgIHZhciBjdXJyWSA9IGludGVycG9sYXRlKHByZXZZLCB5MiwgdCk7CiAgICBpZiAocGF0aFJlZi5jdXJyZW50KSB7CiAgICAgIHByZXZXaWR0aFJlZi5jdXJyZW50ID0gY3VycldpZHRoOwogICAgICBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQgPSBjdXJySGVpZ2h0OwogICAgICBwcmV2WFJlZi5jdXJyZW50ID0gY3Vyclg7CiAgICAgIHByZXZZUmVmLmN1cnJlbnQgPSBjdXJyWTsKICAgIH0KICAgIHZhciBhbmltYXRpb25TdHlsZTsKICAgIGlmICghaXNBbmltYXRpb25BY3RpdmUpIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0bzIKICAgICAgfTsKICAgIH0gZWxzZSBpZiAodCA+IDApIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgdHJhbnNpdGlvbiwKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRvMgogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiBmcm9tMgogICAgICB9OwogICAgfQogICAgdmFyIF9zdmdQcm9wZXJ0aWVzQW5kRXZlbjIgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgICByYWRpdXM6IF8yCiAgICB9ID0gX3N2Z1Byb3BlcnRpZXNBbmRFdmVuMiwgb3RoZXJQYXRoUHJvcHMyID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNShfc3ZnUHJvcGVydGllc0FuZEV2ZW4yLCBfZXhjbHVkZWQyMik7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTAuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzOCh7fSwgb3RoZXJQYXRoUHJvcHMyLCB7CiAgICAgIHJhZGl1czogdHlwZW9mIHJhZGl1cyA9PT0gIm51bWJlciIgPyByYWRpdXMgOiB2b2lkIDAsCiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgICAgZDogZ2V0UmVjdGFuZ2xlUGF0aChjdXJyWCwgY3VyclksIGN1cnJXaWR0aCwgY3VyckhlaWdodCwgcmFkaXVzKSwKICAgICAgcmVmOiBwYXRoUmVmLAogICAgICBzdHlsZTogX29iamVjdFNwcmVhZDEyKF9vYmplY3RTcHJlYWQxMih7fSwgYW5pbWF0aW9uU3R5bGUpLCBwcm9wcy5zdHlsZSkKICAgIH0pKTsKICB9KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9Qb2xhclV0aWxzLmpzCnZhciBpbXBvcnRfcmVhY3QxOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gb3duS2V5czEzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTMoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBSQURJQU4yID0gTWF0aC5QSSAvIDE4MDsKdmFyIHJhZGlhblRvRGVncmVlID0gKGFuZ2xlSW5SYWRpYW4pID0+IGFuZ2xlSW5SYWRpYW4gKiAxODAgLyBNYXRoLlBJOwp2YXIgcG9sYXJUb0NhcnRlc2lhbiA9IChjeCwgY3ksIHJhZGl1cywgYW5nbGUpID0+ICh7CiAgeDogY3ggKyBNYXRoLmNvcygtUkFESUFOMiAqIGFuZ2xlKSAqIHJhZGl1cywKICB5OiBjeSArIE1hdGguc2luKC1SQURJQU4yICogYW5nbGUpICogcmFkaXVzCn0pOwp2YXIgZ2V0TWF4UmFkaXVzID0gZnVuY3Rpb24gZ2V0TWF4UmFkaXVzMih3aWR0aCwgaGVpZ2h0KSB7CiAgdmFyIG9mZnNldCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogewogICAgdG9wOiAwLAogICAgcmlnaHQ6IDAsCiAgICBib3R0b206IDAsCiAgICBsZWZ0OiAwLAogICAgd2lkdGg6IDAsCiAgICBoZWlnaHQ6IDAsCiAgICBicnVzaEJvdHRvbTogMAogIH07CiAgcmV0dXJuIE1hdGgubWluKE1hdGguYWJzKHdpZHRoIC0gKG9mZnNldC5sZWZ0IHx8IDApIC0gKG9mZnNldC5yaWdodCB8fCAwKSksIE1hdGguYWJzKGhlaWdodCAtIChvZmZzZXQudG9wIHx8IDApIC0gKG9mZnNldC5ib3R0b20gfHwgMCkpKSAvIDI7Cn07CnZhciBkaXN0YW5jZUJldHdlZW5Qb2ludHMgPSAocG9pbnQ0LCBhbm90aGVyUG9pbnQpID0+IHsKICB2YXIgewogICAgeDogeDEsCiAgICB5OiB5MQogIH0gPSBwb2ludDQ7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9ID0gYW5vdGhlclBvaW50OwogIHJldHVybiBNYXRoLnNxcnQoKHgxIC0geDIpICoqIDIgKyAoeTEgLSB5MikgKiogMik7Cn07CnZhciBnZXRBbmdsZU9mUG9pbnQgPSAoX3JlZjIsIF9yZWYyMikgPT4gewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBjeCwKICAgIGN5CiAgfSA9IF9yZWYyMjsKICB2YXIgcmFkaXVzID0gZGlzdGFuY2VCZXR3ZWVuUG9pbnRzKHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9LCB7CiAgICB4OiBjeCwKICAgIHk6IGN5CiAgfSk7CiAgaWYgKHJhZGl1cyA8PSAwKSB7CiAgICByZXR1cm4gewogICAgICByYWRpdXMsCiAgICAgIGFuZ2xlOiAwCiAgICB9OwogIH0KICB2YXIgY29zMiA9ICh4MiAtIGN4KSAvIHJhZGl1czsKICB2YXIgYW5nbGVJblJhZGlhbiA9IE1hdGguYWNvcyhjb3MyKTsKICBpZiAoeTIgPiBjeSkgewogICAgYW5nbGVJblJhZGlhbiA9IDIgKiBNYXRoLlBJIC0gYW5nbGVJblJhZGlhbjsKICB9CiAgcmV0dXJuIHsKICAgIHJhZGl1cywKICAgIGFuZ2xlOiByYWRpYW5Ub0RlZ3JlZShhbmdsZUluUmFkaWFuKSwKICAgIGFuZ2xlSW5SYWRpYW4KICB9Owp9Owp2YXIgZm9ybWF0QW5nbGVPZlNlY3RvciA9IChfcmVmMykgPT4gewogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjM7CiAgdmFyIHN0YXJ0Q250ID0gTWF0aC5mbG9vcihzdGFydEFuZ2xlIC8gMzYwKTsKICB2YXIgZW5kQ250ID0gTWF0aC5mbG9vcihlbmRBbmdsZSAvIDM2MCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihzdGFydENudCwgZW5kQ250KTsKICByZXR1cm4gewogICAgc3RhcnRBbmdsZTogc3RhcnRBbmdsZSAtIG1pbjIgKiAzNjAsCiAgICBlbmRBbmdsZTogZW5kQW5nbGUgLSBtaW4yICogMzYwCiAgfTsKfTsKdmFyIHJldmVyc2VGb3JtYXRBbmdsZU9mU2VjdG9yID0gKGFuZ2xlLCBfcmVmNCkgPT4gewogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjQ7CiAgdmFyIHN0YXJ0Q250ID0gTWF0aC5mbG9vcihzdGFydEFuZ2xlIC8gMzYwKTsKICB2YXIgZW5kQ250ID0gTWF0aC5mbG9vcihlbmRBbmdsZSAvIDM2MCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihzdGFydENudCwgZW5kQ250KTsKICByZXR1cm4gYW5nbGUgKyBtaW4yICogMzYwOwp9Owp2YXIgaW5SYW5nZU9mU2VjdG9yID0gKF9yZWY1LCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0WDogeDIsCiAgICBjaGFydFk6IHkyCiAgfSA9IF9yZWY1OwogIHZhciB7CiAgICByYWRpdXMsCiAgICBhbmdsZQogIH0gPSBnZXRBbmdsZU9mUG9pbnQoewogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIHZpZXdCb3gpOwogIHZhciB7CiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzCiAgfSA9IHZpZXdCb3g7CiAgaWYgKHJhZGl1cyA8IGlubmVyUmFkaXVzIHx8IHJhZGl1cyA+IG91dGVyUmFkaXVzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKHJhZGl1cyA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gZm9ybWF0QW5nbGVPZlNlY3Rvcih2aWV3Qm94KTsKICB2YXIgZm9ybWF0QW5nbGUgPSBhbmdsZTsKICB2YXIgaW5SYW5nZTsKICBpZiAoc3RhcnRBbmdsZSA8PSBlbmRBbmdsZSkgewogICAgd2hpbGUgKGZvcm1hdEFuZ2xlID4gZW5kQW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgLT0gMzYwOwogICAgfQogICAgd2hpbGUgKGZvcm1hdEFuZ2xlIDwgc3RhcnRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSArPSAzNjA7CiAgICB9CiAgICBpblJhbmdlID0gZm9ybWF0QW5nbGUgPj0gc3RhcnRBbmdsZSAmJiBmb3JtYXRBbmdsZSA8PSBlbmRBbmdsZTsKICB9IGVsc2UgewogICAgd2hpbGUgKGZvcm1hdEFuZ2xlID4gc3RhcnRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSAtPSAzNjA7CiAgICB9CiAgICB3aGlsZSAoZm9ybWF0QW5nbGUgPCBlbmRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSArPSAzNjA7CiAgICB9CiAgICBpblJhbmdlID0gZm9ybWF0QW5nbGUgPj0gZW5kQW5nbGUgJiYgZm9ybWF0QW5nbGUgPD0gc3RhcnRBbmdsZTsKICB9CiAgaWYgKGluUmFuZ2UpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTMoX29iamVjdFNwcmVhZDEzKHt9LCB2aWV3Qm94KSwge30sIHsKICAgICAgcmFkaXVzLAogICAgICBhbmdsZTogcmV2ZXJzZUZvcm1hdEFuZ2xlT2ZTZWN0b3IoZm9ybWF0QW5nbGUsIHZpZXdCb3gpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvY3Vyc29yL2dldFJhZGlhbEN1cnNvclBvaW50cy5qcwpmdW5jdGlvbiBnZXRSYWRpYWxDdXJzb3JQb2ludHMoYWN0aXZlQ29vcmRpbmF0ZSkgewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IGFjdGl2ZUNvb3JkaW5hdGU7CiAgdmFyIHN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBzdGFydEFuZ2xlKTsKICB2YXIgZW5kUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBlbmRBbmdsZSk7CiAgcmV0dXJuIHsKICAgIHBvaW50czogW3N0YXJ0UG9pbnQsIGVuZFBvaW50XSwKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL1NlY3Rvci5qcwp2YXIgUmVhY3QxMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gX2V4dGVuZHM5KCkgewogIHJldHVybiBfZXh0ZW5kczkgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgZ2V0RGVsdGFBbmdsZSA9IChzdGFydEFuZ2xlLCBlbmRBbmdsZSkgPT4gewogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBNYXRoLm1pbihNYXRoLmFicyhlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpLCAzNTkuOTk5KTsKICByZXR1cm4gc2lnbjIgKiBkZWx0YUFuZ2xlOwp9Owp2YXIgZ2V0VGFuZ2VudENpcmNsZSA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzLAogICAgYW5nbGUsCiAgICBzaWduOiBzaWduMiwKICAgIGlzRXh0ZXJuYWwsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSA9IF9yZWYyOwogIHZhciBjZW50ZXJSYWRpdXMgPSBjb3JuZXJSYWRpdXMgKiAoaXNFeHRlcm5hbCA/IDEgOiAtMSkgKyByYWRpdXM7CiAgdmFyIHRoZXRhID0gTWF0aC5hc2luKGNvcm5lclJhZGl1cyAvIGNlbnRlclJhZGl1cykgLyBSQURJQU4yOwogIHZhciBjZW50ZXJBbmdsZSA9IGNvcm5lcklzRXh0ZXJuYWwgPyBhbmdsZSA6IGFuZ2xlICsgc2lnbjIgKiB0aGV0YTsKICB2YXIgY2VudGVyID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGNlbnRlclJhZGl1cywgY2VudGVyQW5nbGUpOwogIHZhciBjaXJjbGVUYW5nZW5jeSA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIGNlbnRlckFuZ2xlKTsKICB2YXIgbGluZVRhbmdlbmN5QW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gYW5nbGUgLSBzaWduMiAqIHRoZXRhIDogYW5nbGU7CiAgdmFyIGxpbmVUYW5nZW5jeSA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBjZW50ZXJSYWRpdXMgKiBNYXRoLmNvcyh0aGV0YSAqIFJBRElBTjIpLCBsaW5lVGFuZ2VuY3lBbmdsZSk7CiAgcmV0dXJuIHsKICAgIGNlbnRlciwKICAgIGNpcmNsZVRhbmdlbmN5LAogICAgbGluZVRhbmdlbmN5LAogICAgdGhldGEKICB9Owp9Owp2YXIgZ2V0U2VjdG9yUGF0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBfcmVmMjsKICB2YXIgYW5nbGUgPSBnZXREZWx0YUFuZ2xlKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKTsKICB2YXIgdGVtcEVuZEFuZ2xlID0gc3RhcnRBbmdsZSArIGFuZ2xlOwogIHZhciBvdXRlclN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgb3V0ZXJSYWRpdXMsIHN0YXJ0QW5nbGUpOwogIHZhciBvdXRlckVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCB0ZW1wRW5kQW5nbGUpOwogIHZhciBwYXRoMiA9ICJNICIuY29uY2F0KG91dGVyU3RhcnRQb2ludC54LCAiLCIpLmNvbmNhdChvdXRlclN0YXJ0UG9pbnQueSwgIlxuICAgIEEgIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLCIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwwLFxuICAgICIpLmNvbmNhdCgrKE1hdGguYWJzKGFuZ2xlKSA+IDE4MCksICIsIikuY29uY2F0KCsoc3RhcnRBbmdsZSA+IHRlbXBFbmRBbmdsZSksICIsXG4gICAgIikuY29uY2F0KG91dGVyRW5kUG9pbnQueCwgIiwiKS5jb25jYXQob3V0ZXJFbmRQb2ludC55LCAiXG4gICIpOwogIGlmIChpbm5lclJhZGl1cyA+IDApIHsKICAgIHZhciBpbm5lclN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIHN0YXJ0QW5nbGUpOwogICAgdmFyIGlubmVyRW5kUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIHRlbXBFbmRBbmdsZSk7CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdChpbm5lckVuZFBvaW50LngsICIsIikuY29uY2F0KGlubmVyRW5kUG9pbnQueSwgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoaW5uZXJSYWRpdXMsICIsIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLDAsXG4gICAgICAgICAgICAiKS5jb25jYXQoKyhNYXRoLmFicyhhbmdsZSkgPiAxODApLCAiLCIpLmNvbmNhdCgrKHN0YXJ0QW5nbGUgPD0gdGVtcEVuZEFuZ2xlKSwgIixcbiAgICAgICAgICAgICIpLmNvbmNhdChpbm5lclN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQoaW5uZXJTdGFydFBvaW50LnksICIgWiIpOwogIH0gZWxzZSB7CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICIgWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBnZXRTZWN0b3JXaXRoQ29ybmVyID0gKF9yZWYzKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgY29ybmVyUmFkaXVzLAogICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWYzOwogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIHsKICAgIGNpcmNsZVRhbmdlbmN5OiBzb2N0LAogICAgbGluZVRhbmdlbmN5OiBzb2x0LAogICAgdGhldGE6IHNvdAogIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXM6IG91dGVyUmFkaXVzLAogICAgYW5nbGU6IHN0YXJ0QW5nbGUsCiAgICBzaWduOiBzaWduMiwKICAgIGNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwKICB9KTsKICB2YXIgewogICAgY2lyY2xlVGFuZ2VuY3k6IGVvY3QsCiAgICBsaW5lVGFuZ2VuY3k6IGVvbHQsCiAgICB0aGV0YTogZW90CiAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1czogb3V0ZXJSYWRpdXMsCiAgICBhbmdsZTogZW5kQW5nbGUsCiAgICBzaWduOiAtc2lnbjIsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSk7CiAgdmFyIG91dGVyQXJjQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA6IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgLSBzb3QgLSBlb3Q7CiAgaWYgKG91dGVyQXJjQW5nbGUgPCAwKSB7CiAgICBpZiAoZm9yY2VDb3JuZXJSYWRpdXMpIHsKICAgICAgcmV0dXJuICJNICIuY29uY2F0KHNvbHQueCwgIiwiKS5jb25jYXQoc29sdC55LCAiXG4gICAgICAgIGEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLDEsIikuY29uY2F0KGNvcm5lclJhZGl1cyAqIDIsICIsMFxuICAgICAgICBhIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwxLCIpLmNvbmNhdCgtY29ybmVyUmFkaXVzICogMiwgIiwwXG4gICAgICAiKTsKICAgIH0KICAgIHJldHVybiBnZXRTZWN0b3JQYXRoKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBpbm5lclJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9KTsKICB9CiAgdmFyIHBhdGgyID0gIk0gIi5jb25jYXQoc29sdC54LCAiLCIpLmNvbmNhdChzb2x0LnksICJcbiAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChzb2N0LngsICIsIikuY29uY2F0KHNvY3QueSwgIlxuICAgIEEiKS5jb25jYXQob3V0ZXJSYWRpdXMsICIsIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLDAsIikuY29uY2F0KCsob3V0ZXJBcmNBbmdsZSA+IDE4MCksICIsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoZW9jdC54LCAiLCIpLmNvbmNhdChlb2N0LnksICJcbiAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChlb2x0LngsICIsIikuY29uY2F0KGVvbHQueSwgIlxuICAiKTsKICBpZiAoaW5uZXJSYWRpdXMgPiAwKSB7CiAgICB2YXIgewogICAgICBjaXJjbGVUYW5nZW5jeTogc2ljdCwKICAgICAgbGluZVRhbmdlbmN5OiBzaWx0LAogICAgICB0aGV0YTogc2l0CiAgICB9ID0gZ2V0VGFuZ2VudENpcmNsZSh7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcmFkaXVzOiBpbm5lclJhZGl1cywKICAgICAgYW5nbGU6IHN0YXJ0QW5nbGUsCiAgICAgIHNpZ246IHNpZ24yLAogICAgICBpc0V4dGVybmFsOiB0cnVlLAogICAgICBjb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwKICAgIH0pOwogICAgdmFyIHsKICAgICAgY2lyY2xlVGFuZ2VuY3k6IGVpY3QsCiAgICAgIGxpbmVUYW5nZW5jeTogZWlsdCwKICAgICAgdGhldGE6IGVpdAogICAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1czogaW5uZXJSYWRpdXMsCiAgICAgIGFuZ2xlOiBlbmRBbmdsZSwKICAgICAgc2lnbjogLXNpZ24yLAogICAgICBpc0V4dGVybmFsOiB0cnVlLAogICAgICBjb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwKICAgIH0pOwogICAgdmFyIGlubmVyQXJjQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA6IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgLSBzaXQgLSBlaXQ7CiAgICBpZiAoaW5uZXJBcmNBbmdsZSA8IDAgJiYgY29ybmVyUmFkaXVzID09PSAwKSB7CiAgICAgIHJldHVybiAiIi5jb25jYXQocGF0aDIsICJMIikuY29uY2F0KGN4LCAiLCIpLmNvbmNhdChjeSwgIloiKTsKICAgIH0KICAgIHBhdGgyICs9ICJMIi5jb25jYXQoZWlsdC54LCAiLCIpLmNvbmNhdChlaWx0LnksICJcbiAgICAgIEEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KGVpY3QueCwgIiwiKS5jb25jYXQoZWljdC55LCAiXG4gICAgICBBIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLCIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwwLCIpLmNvbmNhdCgrKGlubmVyQXJjQW5nbGUgPiAxODApLCAiLCIpLmNvbmNhdCgrKHNpZ24yID4gMCksICIsIikuY29uY2F0KHNpY3QueCwgIiwiKS5jb25jYXQoc2ljdC55LCAiXG4gICAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChzaWx0LngsICIsIikuY29uY2F0KHNpbHQueSwgIloiKTsKICB9IGVsc2UgewogICAgcGF0aDIgKz0gIkwiLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICJaIik7CiAgfQogIHJldHVybiBwYXRoMjsKfTsKdmFyIGRlZmF1bHRTZWN0b3JQcm9wcyA9IHsKICBjeDogMCwKICBjeTogMCwKICBpbm5lclJhZGl1czogMCwKICBvdXRlclJhZGl1czogMCwKICBzdGFydEFuZ2xlOiAwLAogIGVuZEFuZ2xlOiAwLAogIGNvcm5lclJhZGl1czogMCwKICBmb3JjZUNvcm5lclJhZGl1czogZmFsc2UsCiAgY29ybmVySXNFeHRlcm5hbDogZmFsc2UKfTsKdmFyIFNlY3RvciA9IChzZWN0b3JQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMoc2VjdG9yUHJvcHMsIGRlZmF1bHRTZWN0b3JQcm9wcyk7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgY29ybmVyUmFkaXVzLAogICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIGlmIChvdXRlclJhZGl1cyA8IGlubmVyUmFkaXVzIHx8IHN0YXJ0QW5nbGUgPT09IGVuZEFuZ2xlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1zZWN0b3IiLCBjbGFzc05hbWUpOwogIHZhciBkZWx0YVJhZGl1cyA9IG91dGVyUmFkaXVzIC0gaW5uZXJSYWRpdXM7CiAgdmFyIGNyID0gZ2V0UGVyY2VudFZhbHVlKGNvcm5lclJhZGl1cywgZGVsdGFSYWRpdXMsIDAsIHRydWUpOwogIHZhciBwYXRoMjsKICBpZiAoY3IgPiAwICYmIE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgPCAzNjApIHsKICAgIHBhdGgyID0gZ2V0U2VjdG9yV2l0aENvcm5lcih7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgaW5uZXJSYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzLAogICAgICBjb3JuZXJSYWRpdXM6IE1hdGgubWluKGNyLCBkZWx0YVJhZGl1cyAvIDIpLAogICAgICBmb3JjZUNvcm5lclJhZGl1cywKICAgICAgY29ybmVySXNFeHRlcm5hbCwKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0gZWxzZSB7CiAgICBwYXRoMiA9IGdldFNlY3RvclBhdGgoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIGlubmVyUmFkaXVzLAogICAgICBvdXRlclJhZGl1cywKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTEuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzOSh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyksIHsKICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgIGQ6IHBhdGgyCiAgfSkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2N1cnNvci9nZXRDdXJzb3JQb2ludHMuanMKZnVuY3Rpb24gZ2V0Q3Vyc29yUG9pbnRzKGxheW91dCwgYWN0aXZlQ29vcmRpbmF0ZSwgb2Zmc2V0KSB7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gW3sKICAgICAgeDogYWN0aXZlQ29vcmRpbmF0ZS54LAogICAgICB5OiBvZmZzZXQudG9wCiAgICB9LCB7CiAgICAgIHg6IGFjdGl2ZUNvb3JkaW5hdGUueCwKICAgICAgeTogb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQKICAgIH1dOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gW3sKICAgICAgeDogb2Zmc2V0LmxlZnQsCiAgICAgIHk6IGFjdGl2ZUNvb3JkaW5hdGUueQogICAgfSwgewogICAgICB4OiBvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCwKICAgICAgeTogYWN0aXZlQ29vcmRpbmF0ZS55CiAgICB9XTsKICB9CiAgaWYgKGlzUG9sYXJDb29yZGluYXRlKGFjdGl2ZUNvb3JkaW5hdGUpKSB7CiAgICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgICAgdmFyIHsKICAgICAgICBjeCwKICAgICAgICBjeSwKICAgICAgICBpbm5lclJhZGl1cywKICAgICAgICBvdXRlclJhZGl1cywKICAgICAgICBhbmdsZQogICAgICB9ID0gYWN0aXZlQ29vcmRpbmF0ZTsKICAgICAgdmFyIGlubmVyUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIGFuZ2xlKTsKICAgICAgdmFyIG91dGVyUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgb3V0ZXJSYWRpdXMsIGFuZ2xlKTsKICAgICAgcmV0dXJuIFt7CiAgICAgICAgeDogaW5uZXJQb2ludC54LAogICAgICAgIHk6IGlubmVyUG9pbnQueQogICAgICB9LCB7CiAgICAgICAgeDogb3V0ZXJQb2ludC54LAogICAgICAgIHk6IG91dGVyUG9pbnQueQogICAgICB9XTsKICAgIH0KICAgIHJldHVybiBnZXRSYWRpYWxDdXJzb3JQb2ludHMoYWN0aXZlQ29vcmRpbmF0ZSk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2F4aXNTZWxlY3RvcnMuanMKdmFyIGltcG9ydF9yYW5nZTIgPSBfX3RvRVNNKHJlcXVpcmVfcmFuZ2UyKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3ZpY3RvcnktdmVuZG9yL2VzL2QzLXNjYWxlLmpzCnZhciBkM19zY2FsZV9leHBvcnRzID0ge307Cl9fZXhwb3J0KGQzX3NjYWxlX2V4cG9ydHMsIHsKICBzY2FsZUJhbmQ6ICgpID0+IGJhbmQsCiAgc2NhbGVEaXZlcmdpbmc6ICgpID0+IGRpdmVyZ2luZywKICBzY2FsZURpdmVyZ2luZ0xvZzogKCkgPT4gZGl2ZXJnaW5nTG9nLAogIHNjYWxlRGl2ZXJnaW5nUG93OiAoKSA9PiBkaXZlcmdpbmdQb3csCiAgc2NhbGVEaXZlcmdpbmdTcXJ0OiAoKSA9PiBkaXZlcmdpbmdTcXJ0LAogIHNjYWxlRGl2ZXJnaW5nU3ltbG9nOiAoKSA9PiBkaXZlcmdpbmdTeW1sb2csCiAgc2NhbGVJZGVudGl0eTogKCkgPT4gaWRlbnRpdHkyLAogIHNjYWxlSW1wbGljaXQ6ICgpID0+IGltcGxpY2l0LAogIHNjYWxlTGluZWFyOiAoKSA9PiBsaW5lYXIyLAogIHNjYWxlTG9nOiAoKSA9PiBsb2csCiAgc2NhbGVPcmRpbmFsOiAoKSA9PiBvcmRpbmFsLAogIHNjYWxlUG9pbnQ6ICgpID0+IHBvaW50MywKICBzY2FsZVBvdzogKCkgPT4gcG93LAogIHNjYWxlUXVhbnRpbGU6ICgpID0+IHF1YW50aWxlMiwKICBzY2FsZVF1YW50aXplOiAoKSA9PiBxdWFudGl6ZSwKICBzY2FsZVJhZGlhbDogKCkgPT4gcmFkaWFsLAogIHNjYWxlU2VxdWVudGlhbDogKCkgPT4gc2VxdWVudGlhbCwKICBzY2FsZVNlcXVlbnRpYWxMb2c6ICgpID0+IHNlcXVlbnRpYWxMb2csCiAgc2NhbGVTZXF1ZW50aWFsUG93OiAoKSA9PiBzZXF1ZW50aWFsUG93LAogIHNjYWxlU2VxdWVudGlhbFF1YW50aWxlOiAoKSA9PiBzZXF1ZW50aWFsUXVhbnRpbGUsCiAgc2NhbGVTZXF1ZW50aWFsU3FydDogKCkgPT4gc2VxdWVudGlhbFNxcnQsCiAgc2NhbGVTZXF1ZW50aWFsU3ltbG9nOiAoKSA9PiBzZXF1ZW50aWFsU3ltbG9nLAogIHNjYWxlU3FydDogKCkgPT4gc3FydDIsCiAgc2NhbGVTeW1sb2c6ICgpID0+IHN5bWxvZywKICBzY2FsZVRocmVzaG9sZDogKCkgPT4gdGhyZXNob2xkLAogIHNjYWxlVGltZTogKCkgPT4gdGltZSwKICBzY2FsZVV0YzogKCkgPT4gdXRjVGltZSwKICB0aWNrRm9ybWF0OiAoKSA9PiB0aWNrRm9ybWF0Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9hc2NlbmRpbmcuanMKZnVuY3Rpb24gYXNjZW5kaW5nKGEyLCBiKSB7CiAgcmV0dXJuIGEyID09IG51bGwgfHwgYiA9PSBudWxsID8gTmFOIDogYTIgPCBiID8gLTEgOiBhMiA+IGIgPyAxIDogYTIgPj0gYiA/IDAgOiBOYU47Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvZGVzY2VuZGluZy5qcwpmdW5jdGlvbiBkZXNjZW5kaW5nKGEyLCBiKSB7CiAgcmV0dXJuIGEyID09IG51bGwgfHwgYiA9PSBudWxsID8gTmFOIDogYiA8IGEyID8gLTEgOiBiID4gYTIgPyAxIDogYiA+PSBhMiA/IDAgOiBOYU47Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYmlzZWN0b3IuanMKZnVuY3Rpb24gYmlzZWN0b3IoZikgewogIGxldCBjb21wYXJlMSwgY29tcGFyZTIsIGRlbHRhOwogIGlmIChmLmxlbmd0aCAhPT0gMikgewogICAgY29tcGFyZTEgPSBhc2NlbmRpbmc7CiAgICBjb21wYXJlMiA9IChkLCB4MikgPT4gYXNjZW5kaW5nKGYoZCksIHgyKTsKICAgIGRlbHRhID0gKGQsIHgyKSA9PiBmKGQpIC0geDI7CiAgfSBlbHNlIHsKICAgIGNvbXBhcmUxID0gZiA9PT0gYXNjZW5kaW5nIHx8IGYgPT09IGRlc2NlbmRpbmcgPyBmIDogemVybzsKICAgIGNvbXBhcmUyID0gZjsKICAgIGRlbHRhID0gZjsKICB9CiAgZnVuY3Rpb24gbGVmdChhMiwgeDIsIGxvID0gMCwgaGkgPSBhMi5sZW5ndGgpIHsKICAgIGlmIChsbyA8IGhpKSB7CiAgICAgIGlmIChjb21wYXJlMSh4MiwgeDIpICE9PSAwKSByZXR1cm4gaGk7CiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtaWQgPSBsbyArIGhpID4+PiAxOwogICAgICAgIGlmIChjb21wYXJlMihhMlttaWRdLCB4MikgPCAwKSBsbyA9IG1pZCArIDE7CiAgICAgICAgZWxzZSBoaSA9IG1pZDsKICAgICAgfSB3aGlsZSAobG8gPCBoaSk7CiAgICB9CiAgICByZXR1cm4gbG87CiAgfQogIGZ1bmN0aW9uIHJpZ2h0KGEyLCB4MiwgbG8gPSAwLCBoaSA9IGEyLmxlbmd0aCkgewogICAgaWYgKGxvIDwgaGkpIHsKICAgICAgaWYgKGNvbXBhcmUxKHgyLCB4MikgIT09IDApIHJldHVybiBoaTsKICAgICAgZG8gewogICAgICAgIGNvbnN0IG1pZCA9IGxvICsgaGkgPj4+IDE7CiAgICAgICAgaWYgKGNvbXBhcmUyKGEyW21pZF0sIHgyKSA8PSAwKSBsbyA9IG1pZCArIDE7CiAgICAgICAgZWxzZSBoaSA9IG1pZDsKICAgICAgfSB3aGlsZSAobG8gPCBoaSk7CiAgICB9CiAgICByZXR1cm4gbG87CiAgfQogIGZ1bmN0aW9uIGNlbnRlcihhMiwgeDIsIGxvID0gMCwgaGkgPSBhMi5sZW5ndGgpIHsKICAgIGNvbnN0IGkgPSBsZWZ0KGEyLCB4MiwgbG8sIGhpIC0gMSk7CiAgICByZXR1cm4gaSA+IGxvICYmIGRlbHRhKGEyW2kgLSAxXSwgeDIpID4gLWRlbHRhKGEyW2ldLCB4MikgPyBpIC0gMSA6IGk7CiAgfQogIHJldHVybiB7IGxlZnQsIGNlbnRlciwgcmlnaHQgfTsKfQpmdW5jdGlvbiB6ZXJvKCkgewogIHJldHVybiAwOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL251bWJlci5qcwpmdW5jdGlvbiBudW1iZXIoeDIpIHsKICByZXR1cm4geDIgPT09IG51bGwgPyBOYU4gOiAreDI7Cn0KZnVuY3Rpb24qIG51bWJlcnModmFsdWVzLCB2YWx1ZW9mKSB7CiAgaWYgKHZhbHVlb2YgPT09IHZvaWQgMCkgewogICAgZm9yIChsZXQgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmICh2YWx1ZSA9ICt2YWx1ZSkgPj0gdmFsdWUpIHsKICAgICAgICB5aWVsZCB2YWx1ZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBsZXQgaW5kZXggPSAtMTsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAoKHZhbHVlID0gdmFsdWVvZih2YWx1ZSwgKytpbmRleCwgdmFsdWVzKSkgIT0gbnVsbCAmJiAodmFsdWUgPSArdmFsdWUpID49IHZhbHVlKSB7CiAgICAgICAgeWllbGQgdmFsdWU7CiAgICAgIH0KICAgIH0KICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYmlzZWN0LmpzCnZhciBhc2NlbmRpbmdCaXNlY3QgPSBiaXNlY3Rvcihhc2NlbmRpbmcpOwp2YXIgYmlzZWN0UmlnaHQgPSBhc2NlbmRpbmdCaXNlY3QucmlnaHQ7CnZhciBiaXNlY3RMZWZ0ID0gYXNjZW5kaW5nQmlzZWN0LmxlZnQ7CnZhciBiaXNlY3RDZW50ZXIgPSBiaXNlY3RvcihudW1iZXIpLmNlbnRlcjsKdmFyIGJpc2VjdF9kZWZhdWx0ID0gYmlzZWN0UmlnaHQ7CgovLyBub2RlX21vZHVsZXMvaW50ZXJubWFwL3NyYy9pbmRleC5qcwp2YXIgSW50ZXJuTWFwID0gY2xhc3MgZXh0ZW5kcyBNYXAgewogIGNvbnN0cnVjdG9yKGVudHJpZXMsIGtleSA9IGtleW9mKSB7CiAgICBzdXBlcigpOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgeyBfaW50ZXJuOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpIH0sIF9rZXk6IHsgdmFsdWU6IGtleSB9IH0pOwogICAgaWYgKGVudHJpZXMgIT0gbnVsbCkgZm9yIChjb25zdCBba2V5MiwgdmFsdWVdIG9mIGVudHJpZXMpIHRoaXMuc2V0KGtleTIsIHZhbHVlKTsKICB9CiAgZ2V0KGtleSkgewogICAgcmV0dXJuIHN1cGVyLmdldChpbnRlcm5fZ2V0KHRoaXMsIGtleSkpOwogIH0KICBoYXMoa2V5KSB7CiAgICByZXR1cm4gc3VwZXIuaGFzKGludGVybl9nZXQodGhpcywga2V5KSk7CiAgfQogIHNldChrZXksIHZhbHVlKSB7CiAgICByZXR1cm4gc3VwZXIuc2V0KGludGVybl9zZXQodGhpcywga2V5KSwgdmFsdWUpOwogIH0KICBkZWxldGUoa2V5KSB7CiAgICByZXR1cm4gc3VwZXIuZGVsZXRlKGludGVybl9kZWxldGUodGhpcywga2V5KSk7CiAgfQp9OwpmdW5jdGlvbiBpbnRlcm5fZ2V0KHsgX2ludGVybiwgX2tleSB9LCB2YWx1ZSkgewogIGNvbnN0IGtleSA9IF9rZXkodmFsdWUpOwogIHJldHVybiBfaW50ZXJuLmhhcyhrZXkpID8gX2ludGVybi5nZXQoa2V5KSA6IHZhbHVlOwp9CmZ1bmN0aW9uIGludGVybl9zZXQoeyBfaW50ZXJuLCBfa2V5IH0sIHZhbHVlKSB7CiAgY29uc3Qga2V5ID0gX2tleSh2YWx1ZSk7CiAgaWYgKF9pbnRlcm4uaGFzKGtleSkpIHJldHVybiBfaW50ZXJuLmdldChrZXkpOwogIF9pbnRlcm4uc2V0KGtleSwgdmFsdWUpOwogIHJldHVybiB2YWx1ZTsKfQpmdW5jdGlvbiBpbnRlcm5fZGVsZXRlKHsgX2ludGVybiwgX2tleSB9LCB2YWx1ZSkgewogIGNvbnN0IGtleSA9IF9rZXkodmFsdWUpOwogIGlmIChfaW50ZXJuLmhhcyhrZXkpKSB7CiAgICB2YWx1ZSA9IF9pbnRlcm4uZ2V0KGtleSk7CiAgICBfaW50ZXJuLmRlbGV0ZShrZXkpOwogIH0KICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24ga2V5b2YodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiA/IHZhbHVlLnZhbHVlT2YoKSA6IHZhbHVlOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3NvcnQuanMKZnVuY3Rpb24gY29tcGFyZURlZmluZWQoY29tcGFyZSA9IGFzY2VuZGluZykgewogIGlmIChjb21wYXJlID09PSBhc2NlbmRpbmcpIHJldHVybiBhc2NlbmRpbmdEZWZpbmVkOwogIGlmICh0eXBlb2YgY29tcGFyZSAhPT0gImZ1bmN0aW9uIikgdGhyb3cgbmV3IFR5cGVFcnJvcigiY29tcGFyZSBpcyBub3QgYSBmdW5jdGlvbiIpOwogIHJldHVybiAoYTIsIGIpID0+IHsKICAgIGNvbnN0IHgyID0gY29tcGFyZShhMiwgYik7CiAgICBpZiAoeDIgfHwgeDIgPT09IDApIHJldHVybiB4MjsKICAgIHJldHVybiAoY29tcGFyZShiLCBiKSA9PT0gMCkgLSAoY29tcGFyZShhMiwgYTIpID09PSAwKTsKICB9Owp9CmZ1bmN0aW9uIGFzY2VuZGluZ0RlZmluZWQoYTIsIGIpIHsKICByZXR1cm4gKGEyID09IG51bGwgfHwgIShhMiA+PSBhMikpIC0gKGIgPT0gbnVsbCB8fCAhKGIgPj0gYikpIHx8IChhMiA8IGIgPyAtMSA6IGEyID4gYiA/IDEgOiAwKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy90aWNrcy5qcwp2YXIgZTEwID0gTWF0aC5zcXJ0KDUwKTsKdmFyIGU1ID0gTWF0aC5zcXJ0KDEwKTsKdmFyIGUyID0gTWF0aC5zcXJ0KDIpOwpmdW5jdGlvbiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpIHsKICBjb25zdCBzdGVwID0gKHN0b3AgLSBzdGFydCkgLyBNYXRoLm1heCgwLCBjb3VudCksIHBvd2VyID0gTWF0aC5mbG9vcihNYXRoLmxvZzEwKHN0ZXApKSwgZXJyb3IgPSBzdGVwIC8gTWF0aC5wb3coMTAsIHBvd2VyKSwgZmFjdG9yID0gZXJyb3IgPj0gZTEwID8gMTAgOiBlcnJvciA+PSBlNSA/IDUgOiBlcnJvciA+PSBlMiA/IDIgOiAxOwogIGxldCBpMSwgaTIsIGluYzsKICBpZiAocG93ZXIgPCAwKSB7CiAgICBpbmMgPSBNYXRoLnBvdygxMCwgLXBvd2VyKSAvIGZhY3RvcjsKICAgIGkxID0gTWF0aC5yb3VuZChzdGFydCAqIGluYyk7CiAgICBpMiA9IE1hdGgucm91bmQoc3RvcCAqIGluYyk7CiAgICBpZiAoaTEgLyBpbmMgPCBzdGFydCkgKytpMTsKICAgIGlmIChpMiAvIGluYyA+IHN0b3ApIC0taTI7CiAgICBpbmMgPSAtaW5jOwogIH0gZWxzZSB7CiAgICBpbmMgPSBNYXRoLnBvdygxMCwgcG93ZXIpICogZmFjdG9yOwogICAgaTEgPSBNYXRoLnJvdW5kKHN0YXJ0IC8gaW5jKTsKICAgIGkyID0gTWF0aC5yb3VuZChzdG9wIC8gaW5jKTsKICAgIGlmIChpMSAqIGluYyA8IHN0YXJ0KSArK2kxOwogICAgaWYgKGkyICogaW5jID4gc3RvcCkgLS1pMjsKICB9CiAgaWYgKGkyIDwgaTEgJiYgMC41IDw9IGNvdW50ICYmIGNvdW50IDwgMikgcmV0dXJuIHRpY2tTcGVjKHN0YXJ0LCBzdG9wLCBjb3VudCAqIDIpOwogIHJldHVybiBbaTEsIGkyLCBpbmNdOwp9CmZ1bmN0aW9uIHRpY2tzKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIGlmICghKGNvdW50ID4gMCkpIHJldHVybiBbXTsKICBpZiAoc3RhcnQgPT09IHN0b3ApIHJldHVybiBbc3RhcnRdOwogIGNvbnN0IHJldmVyc2UyID0gc3RvcCA8IHN0YXJ0LCBbaTEsIGkyLCBpbmNdID0gcmV2ZXJzZTIgPyB0aWNrU3BlYyhzdG9wLCBzdGFydCwgY291bnQpIDogdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50KTsKICBpZiAoIShpMiA+PSBpMSkpIHJldHVybiBbXTsKICBjb25zdCBuID0gaTIgLSBpMSArIDEsIHRpY2tzMiA9IG5ldyBBcnJheShuKTsKICBpZiAocmV2ZXJzZTIpIHsKICAgIGlmIChpbmMgPCAwKSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkyIC0gaSkgLyAtaW5jOwogICAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkyIC0gaSkgKiBpbmM7CiAgfSBlbHNlIHsKICAgIGlmIChpbmMgPCAwKSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkxICsgaSkgLyAtaW5jOwogICAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkxICsgaSkgKiBpbmM7CiAgfQogIHJldHVybiB0aWNrczI7Cn0KZnVuY3Rpb24gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpIHsKICBzdG9wID0gK3N0b3AsIHN0YXJ0ID0gK3N0YXJ0LCBjb3VudCA9ICtjb3VudDsKICByZXR1cm4gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50KVsyXTsKfQpmdW5jdGlvbiB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpIHsKICBzdG9wID0gK3N0b3AsIHN0YXJ0ID0gK3N0YXJ0LCBjb3VudCA9ICtjb3VudDsKICBjb25zdCByZXZlcnNlMiA9IHN0b3AgPCBzdGFydCwgaW5jID0gcmV2ZXJzZTIgPyB0aWNrSW5jcmVtZW50KHN0b3AsIHN0YXJ0LCBjb3VudCkgOiB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgcmV0dXJuIChyZXZlcnNlMiA/IC0xIDogMSkgKiAoaW5jIDwgMCA/IDEgLyAtaW5jIDogaW5jKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9tYXguanMKZnVuY3Rpb24gbWF4KHZhbHVlcywgdmFsdWVvZikgewogIGxldCBtYXgyOwogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIChtYXgyIDwgdmFsdWUgfHwgbWF4MiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1heDIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBsZXQgaW5kZXggPSAtMTsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAoKHZhbHVlID0gdmFsdWVvZih2YWx1ZSwgKytpbmRleCwgdmFsdWVzKSkgIT0gbnVsbCAmJiAobWF4MiA8IHZhbHVlIHx8IG1heDIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtYXgyID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1heDI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvbWluLmpzCmZ1bmN0aW9uIG1pbih2YWx1ZXMsIHZhbHVlb2YpIHsKICBsZXQgbWluMjsKICBpZiAodmFsdWVvZiA9PT0gdm9pZCAwKSB7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiAobWluMiA+IHZhbHVlIHx8IG1pbjIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtaW4yID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbGV0IGluZGV4ID0gLTE7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKCh2YWx1ZSA9IHZhbHVlb2YodmFsdWUsICsraW5kZXgsIHZhbHVlcykpICE9IG51bGwgJiYgKG1pbjIgPiB2YWx1ZSB8fCBtaW4yID09PSB2b2lkIDAgJiYgdmFsdWUgPj0gdmFsdWUpKSB7CiAgICAgICAgbWluMiA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBtaW4yOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3F1aWNrc2VsZWN0LmpzCmZ1bmN0aW9uIHF1aWNrc2VsZWN0KGFycmF5LCBrMiwgbGVmdCA9IDAsIHJpZ2h0ID0gSW5maW5pdHksIGNvbXBhcmUpIHsKICBrMiA9IE1hdGguZmxvb3IoazIpOwogIGxlZnQgPSBNYXRoLmZsb29yKE1hdGgubWF4KDAsIGxlZnQpKTsKICByaWdodCA9IE1hdGguZmxvb3IoTWF0aC5taW4oYXJyYXkubGVuZ3RoIC0gMSwgcmlnaHQpKTsKICBpZiAoIShsZWZ0IDw9IGsyICYmIGsyIDw9IHJpZ2h0KSkgcmV0dXJuIGFycmF5OwogIGNvbXBhcmUgPSBjb21wYXJlID09PSB2b2lkIDAgPyBhc2NlbmRpbmdEZWZpbmVkIDogY29tcGFyZURlZmluZWQoY29tcGFyZSk7CiAgd2hpbGUgKHJpZ2h0ID4gbGVmdCkgewogICAgaWYgKHJpZ2h0IC0gbGVmdCA+IDYwMCkgewogICAgICBjb25zdCBuID0gcmlnaHQgLSBsZWZ0ICsgMTsKICAgICAgY29uc3QgbSA9IGsyIC0gbGVmdCArIDE7CiAgICAgIGNvbnN0IHogPSBNYXRoLmxvZyhuKTsKICAgICAgY29uc3QgczIgPSAwLjUgKiBNYXRoLmV4cCgyICogeiAvIDMpOwogICAgICBjb25zdCBzZCA9IDAuNSAqIE1hdGguc3FydCh6ICogczIgKiAobiAtIHMyKSAvIG4pICogKG0gLSBuIC8gMiA8IDAgPyAtMSA6IDEpOwogICAgICBjb25zdCBuZXdMZWZ0ID0gTWF0aC5tYXgobGVmdCwgTWF0aC5mbG9vcihrMiAtIG0gKiBzMiAvIG4gKyBzZCkpOwogICAgICBjb25zdCBuZXdSaWdodCA9IE1hdGgubWluKHJpZ2h0LCBNYXRoLmZsb29yKGsyICsgKG4gLSBtKSAqIHMyIC8gbiArIHNkKSk7CiAgICAgIHF1aWNrc2VsZWN0KGFycmF5LCBrMiwgbmV3TGVmdCwgbmV3UmlnaHQsIGNvbXBhcmUpOwogICAgfQogICAgY29uc3QgdCA9IGFycmF5W2syXTsKICAgIGxldCBpID0gbGVmdDsKICAgIGxldCBqID0gcmlnaHQ7CiAgICBzd2FwKGFycmF5LCBsZWZ0LCBrMik7CiAgICBpZiAoY29tcGFyZShhcnJheVtyaWdodF0sIHQpID4gMCkgc3dhcChhcnJheSwgbGVmdCwgcmlnaHQpOwogICAgd2hpbGUgKGkgPCBqKSB7CiAgICAgIHN3YXAoYXJyYXksIGksIGopLCArK2ksIC0tajsKICAgICAgd2hpbGUgKGNvbXBhcmUoYXJyYXlbaV0sIHQpIDwgMCkgKytpOwogICAgICB3aGlsZSAoY29tcGFyZShhcnJheVtqXSwgdCkgPiAwKSAtLWo7CiAgICB9CiAgICBpZiAoY29tcGFyZShhcnJheVtsZWZ0XSwgdCkgPT09IDApIHN3YXAoYXJyYXksIGxlZnQsIGopOwogICAgZWxzZSArK2osIHN3YXAoYXJyYXksIGosIHJpZ2h0KTsKICAgIGlmIChqIDw9IGsyKSBsZWZ0ID0gaiArIDE7CiAgICBpZiAoazIgPD0gaikgcmlnaHQgPSBqIC0gMTsKICB9CiAgcmV0dXJuIGFycmF5Owp9CmZ1bmN0aW9uIHN3YXAoYXJyYXksIGksIGopIHsKICBjb25zdCB0ID0gYXJyYXlbaV07CiAgYXJyYXlbaV0gPSBhcnJheVtqXTsKICBhcnJheVtqXSA9IHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcXVhbnRpbGUuanMKZnVuY3Rpb24gcXVhbnRpbGUodmFsdWVzLCBwLCB2YWx1ZW9mKSB7CiAgdmFsdWVzID0gRmxvYXQ2NEFycmF5LmZyb20obnVtYmVycyh2YWx1ZXMsIHZhbHVlb2YpKTsKICBpZiAoIShuID0gdmFsdWVzLmxlbmd0aCkgfHwgaXNOYU4ocCA9ICtwKSkgcmV0dXJuOwogIGlmIChwIDw9IDAgfHwgbiA8IDIpIHJldHVybiBtaW4odmFsdWVzKTsKICBpZiAocCA+PSAxKSByZXR1cm4gbWF4KHZhbHVlcyk7CiAgdmFyIG4sIGkgPSAobiAtIDEpICogcCwgaTAgPSBNYXRoLmZsb29yKGkpLCB2YWx1ZTAgPSBtYXgocXVpY2tzZWxlY3QodmFsdWVzLCBpMCkuc3ViYXJyYXkoMCwgaTAgKyAxKSksIHZhbHVlMSA9IG1pbih2YWx1ZXMuc3ViYXJyYXkoaTAgKyAxKSk7CiAgcmV0dXJuIHZhbHVlMCArICh2YWx1ZTEgLSB2YWx1ZTApICogKGkgLSBpMCk7Cn0KZnVuY3Rpb24gcXVhbnRpbGVTb3J0ZWQodmFsdWVzLCBwLCB2YWx1ZW9mID0gbnVtYmVyKSB7CiAgaWYgKCEobiA9IHZhbHVlcy5sZW5ndGgpIHx8IGlzTmFOKHAgPSArcCkpIHJldHVybjsKICBpZiAocCA8PSAwIHx8IG4gPCAyKSByZXR1cm4gK3ZhbHVlb2YodmFsdWVzWzBdLCAwLCB2YWx1ZXMpOwogIGlmIChwID49IDEpIHJldHVybiArdmFsdWVvZih2YWx1ZXNbbiAtIDFdLCBuIC0gMSwgdmFsdWVzKTsKICB2YXIgbiwgaSA9IChuIC0gMSkgKiBwLCBpMCA9IE1hdGguZmxvb3IoaSksIHZhbHVlMCA9ICt2YWx1ZW9mKHZhbHVlc1tpMF0sIGkwLCB2YWx1ZXMpLCB2YWx1ZTEgPSArdmFsdWVvZih2YWx1ZXNbaTAgKyAxXSwgaTAgKyAxLCB2YWx1ZXMpOwogIHJldHVybiB2YWx1ZTAgKyAodmFsdWUxIC0gdmFsdWUwKSAqIChpIC0gaTApOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3JhbmdlLmpzCmZ1bmN0aW9uIHJhbmdlKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgc3RhcnQgPSArc3RhcnQsIHN0b3AgPSArc3RvcCwgc3RlcCA9IChuID0gYXJndW1lbnRzLmxlbmd0aCkgPCAyID8gKHN0b3AgPSBzdGFydCwgc3RhcnQgPSAwLCAxKSA6IG4gPCAzID8gMSA6ICtzdGVwOwogIHZhciBpID0gLTEsIG4gPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoKHN0b3AgLSBzdGFydCkgLyBzdGVwKSkgfCAwLCByYW5nZTQgPSBuZXcgQXJyYXkobik7CiAgd2hpbGUgKCsraSA8IG4pIHsKICAgIHJhbmdlNFtpXSA9IHN0YXJ0ICsgaSAqIHN0ZXA7CiAgfQogIHJldHVybiByYW5nZTQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvaW5pdC5qcwpmdW5jdGlvbiBpbml0UmFuZ2UoZG9tYWluLCByYW5nZTQpIHsKICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIGNhc2UgMDoKICAgICAgYnJlYWs7CiAgICBjYXNlIDE6CiAgICAgIHRoaXMucmFuZ2UoZG9tYWluKTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB0aGlzLnJhbmdlKHJhbmdlNCkuZG9tYWluKGRvbWFpbik7CiAgICAgIGJyZWFrOwogIH0KICByZXR1cm4gdGhpczsKfQpmdW5jdGlvbiBpbml0SW50ZXJwb2xhdG9yKGRvbWFpbiwgaW50ZXJwb2xhdG9yKSB7CiAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICBjYXNlIDA6CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOiB7CiAgICAgIGlmICh0eXBlb2YgZG9tYWluID09PSAiZnVuY3Rpb24iKSB0aGlzLmludGVycG9sYXRvcihkb21haW4pOwogICAgICBlbHNlIHRoaXMucmFuZ2UoZG9tYWluKTsKICAgICAgYnJlYWs7CiAgICB9CiAgICBkZWZhdWx0OiB7CiAgICAgIHRoaXMuZG9tYWluKGRvbWFpbik7CiAgICAgIGlmICh0eXBlb2YgaW50ZXJwb2xhdG9yID09PSAiZnVuY3Rpb24iKSB0aGlzLmludGVycG9sYXRvcihpbnRlcnBvbGF0b3IpOwogICAgICBlbHNlIHRoaXMucmFuZ2UoaW50ZXJwb2xhdG9yKTsKICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHJldHVybiB0aGlzOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL29yZGluYWwuanMKdmFyIGltcGxpY2l0ID0gU3ltYm9sKCJpbXBsaWNpdCIpOwpmdW5jdGlvbiBvcmRpbmFsKCkgewogIHZhciBpbmRleCA9IG5ldyBJbnRlcm5NYXAoKSwgZG9tYWluID0gW10sIHJhbmdlNCA9IFtdLCB1bmtub3duID0gaW1wbGljaXQ7CiAgZnVuY3Rpb24gc2NhbGUoZCkgewogICAgbGV0IGkgPSBpbmRleC5nZXQoZCk7CiAgICBpZiAoaSA9PT0gdm9pZCAwKSB7CiAgICAgIGlmICh1bmtub3duICE9PSBpbXBsaWNpdCkgcmV0dXJuIHVua25vd247CiAgICAgIGluZGV4LnNldChkLCBpID0gZG9tYWluLnB1c2goZCkgLSAxKTsKICAgIH0KICAgIHJldHVybiByYW5nZTRbaSAlIHJhbmdlNC5sZW5ndGhdOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdLCBpbmRleCA9IG5ldyBJbnRlcm5NYXAoKTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgXykgewogICAgICBpZiAoaW5kZXguaGFzKHZhbHVlKSkgY29udGludWU7CiAgICAgIGluZGV4LnNldCh2YWx1ZSwgZG9tYWluLnB1c2godmFsdWUpIC0gMSk7CiAgICB9CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlNCA9IEFycmF5LmZyb20oXyksIHNjYWxlKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG9yZGluYWwoZG9tYWluLCByYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHNjYWxlOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2JhbmQuanMKZnVuY3Rpb24gYmFuZCgpIHsKICB2YXIgc2NhbGUgPSBvcmRpbmFsKCkudW5rbm93bih2b2lkIDApLCBkb21haW4gPSBzY2FsZS5kb21haW4sIG9yZGluYWxSYW5nZSA9IHNjYWxlLnJhbmdlLCByMCA9IDAsIHIxID0gMSwgc3RlcCwgYmFuZHdpZHRoLCByb3VuZCA9IGZhbHNlLCBwYWRkaW5nSW5uZXIgPSAwLCBwYWRkaW5nT3V0ZXIgPSAwLCBhbGlnbiA9IDAuNTsKICBkZWxldGUgc2NhbGUudW5rbm93bjsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIG4gPSBkb21haW4oKS5sZW5ndGgsIHJldmVyc2UyID0gcjEgPCByMCwgc3RhcnQgPSByZXZlcnNlMiA/IHIxIDogcjAsIHN0b3AgPSByZXZlcnNlMiA/IHIwIDogcjE7CiAgICBzdGVwID0gKHN0b3AgLSBzdGFydCkgLyBNYXRoLm1heCgxLCBuIC0gcGFkZGluZ0lubmVyICsgcGFkZGluZ091dGVyICogMik7CiAgICBpZiAocm91bmQpIHN0ZXAgPSBNYXRoLmZsb29yKHN0ZXApOwogICAgc3RhcnQgKz0gKHN0b3AgLSBzdGFydCAtIHN0ZXAgKiAobiAtIHBhZGRpbmdJbm5lcikpICogYWxpZ247CiAgICBiYW5kd2lkdGggPSBzdGVwICogKDEgLSBwYWRkaW5nSW5uZXIpOwogICAgaWYgKHJvdW5kKSBzdGFydCA9IE1hdGgucm91bmQoc3RhcnQpLCBiYW5kd2lkdGggPSBNYXRoLnJvdW5kKGJhbmR3aWR0aCk7CiAgICB2YXIgdmFsdWVzID0gcmFuZ2UobikubWFwKGZ1bmN0aW9uKGkpIHsKICAgICAgcmV0dXJuIHN0YXJ0ICsgc3RlcCAqIGk7CiAgICB9KTsKICAgIHJldHVybiBvcmRpbmFsUmFuZ2UocmV2ZXJzZTIgPyB2YWx1ZXMucmV2ZXJzZSgpIDogdmFsdWVzKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluKF8pLCByZXNjYWxlKCkpIDogZG9tYWluKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFtyMCwgcjFdID0gXywgcjAgPSArcjAsIHIxID0gK3IxLCByZXNjYWxlKCkpIDogW3IwLCByMV07CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIFtyMCwgcjFdID0gXywgcjAgPSArcjAsIHIxID0gK3IxLCByb3VuZCA9IHRydWUsIHJlc2NhbGUoKTsKICB9OwogIHNjYWxlLmJhbmR3aWR0aCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGJhbmR3aWR0aDsKICB9OwogIHNjYWxlLnN0ZXAgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzdGVwOwogIH07CiAgc2NhbGUucm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyb3VuZCA9ICEhXywgcmVzY2FsZSgpKSA6IHJvdW5kOwogIH07CiAgc2NhbGUucGFkZGluZyA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdJbm5lciA9IE1hdGgubWluKDEsIHBhZGRpbmdPdXRlciA9ICtfKSwgcmVzY2FsZSgpKSA6IHBhZGRpbmdJbm5lcjsKICB9OwogIHNjYWxlLnBhZGRpbmdJbm5lciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdJbm5lciA9IE1hdGgubWluKDEsIF8pLCByZXNjYWxlKCkpIDogcGFkZGluZ0lubmVyOwogIH07CiAgc2NhbGUucGFkZGluZ091dGVyID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocGFkZGluZ091dGVyID0gK18sIHJlc2NhbGUoKSkgOiBwYWRkaW5nT3V0ZXI7CiAgfTsKICBzY2FsZS5hbGlnbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGFsaWduID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgXykpLCByZXNjYWxlKCkpIDogYWxpZ247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYmFuZChkb21haW4oKSwgW3IwLCByMV0pLnJvdW5kKHJvdW5kKS5wYWRkaW5nSW5uZXIocGFkZGluZ0lubmVyKS5wYWRkaW5nT3V0ZXIocGFkZGluZ091dGVyKS5hbGlnbihhbGlnbik7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHJlc2NhbGUoKSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBwb2ludGlzaChzY2FsZSkgewogIHZhciBjb3B5MyA9IHNjYWxlLmNvcHk7CiAgc2NhbGUucGFkZGluZyA9IHNjYWxlLnBhZGRpbmdPdXRlcjsKICBkZWxldGUgc2NhbGUucGFkZGluZ0lubmVyOwogIGRlbGV0ZSBzY2FsZS5wYWRkaW5nT3V0ZXI7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHBvaW50aXNoKGNvcHkzKCkpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIHBvaW50MygpIHsKICByZXR1cm4gcG9pbnRpc2goYmFuZC5hcHBseShudWxsLCBhcmd1bWVudHMpLnBhZGRpbmdJbm5lcigxKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1jb2xvci9zcmMvZGVmaW5lLmpzCmZ1bmN0aW9uIGRlZmluZV9kZWZhdWx0KGNvbnN0cnVjdG9yLCBmYWN0b3J5LCBwcm90b3R5cGUpIHsKICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBmYWN0b3J5LnByb3RvdHlwZSA9IHByb3RvdHlwZTsKICBwcm90b3R5cGUuY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcjsKfQpmdW5jdGlvbiBleHRlbmQocGFyZW50LCBkZWZpbml0aW9uKSB7CiAgdmFyIHByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocGFyZW50LnByb3RvdHlwZSk7CiAgZm9yICh2YXIga2V5IGluIGRlZmluaXRpb24pIHByb3RvdHlwZVtrZXldID0gZGVmaW5pdGlvbltrZXldOwogIHJldHVybiBwcm90b3R5cGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1jb2xvci9zcmMvY29sb3IuanMKZnVuY3Rpb24gQ29sb3IoKSB7Cn0KdmFyIGRhcmtlciA9IDAuNzsKdmFyIGJyaWdodGVyID0gMSAvIGRhcmtlcjsKdmFyIHJlSSA9ICJcXHMqKFsrLV0/XFxkKylcXHMqIjsKdmFyIHJlTiA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPylcXHMqIjsKdmFyIHJlUCA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPyklXFxzKiI7CnZhciByZUhleCA9IC9eIyhbMC05YS1mXXszLDh9KSQvOwp2YXIgcmVSZ2JJbnRlZ2VyID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVJfSwke3JlSX0sJHtyZUl9XFwpJGApOwp2YXIgcmVSZ2JQZXJjZW50ID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVQfSwke3JlUH0sJHtyZVB9XFwpJGApOwp2YXIgcmVSZ2JhSW50ZWdlciA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZUl9LCR7cmVJfSwke3JlSX0sJHtyZU59XFwpJGApOwp2YXIgcmVSZ2JhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZVB9LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwp2YXIgcmVIc2xQZXJjZW50ID0gbmV3IFJlZ0V4cChgXmhzbFxcKCR7cmVOfSwke3JlUH0sJHtyZVB9XFwpJGApOwp2YXIgcmVIc2xhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5oc2xhXFwoJHtyZU59LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwp2YXIgbmFtZWQgPSB7CiAgYWxpY2VibHVlOiAxNTc5MjM4MywKICBhbnRpcXVld2hpdGU6IDE2NDQ0Mzc1LAogIGFxdWE6IDY1NTM1LAogIGFxdWFtYXJpbmU6IDgzODg1NjQsCiAgYXp1cmU6IDE1Nzk0MTc1LAogIGJlaWdlOiAxNjExOTI2MCwKICBiaXNxdWU6IDE2NzcwMjQ0LAogIGJsYWNrOiAwLAogIGJsYW5jaGVkYWxtb25kOiAxNjc3MjA0NSwKICBibHVlOiAyNTUsCiAgYmx1ZXZpb2xldDogOTA1NTIwMiwKICBicm93bjogMTA4MjQyMzQsCiAgYnVybHl3b29kOiAxNDU5NjIzMSwKICBjYWRldGJsdWU6IDYyNjY1MjgsCiAgY2hhcnRyZXVzZTogODM4ODM1MiwKICBjaG9jb2xhdGU6IDEzNzg5NDcwLAogIGNvcmFsOiAxNjc0NDI3MiwKICBjb3JuZmxvd2VyYmx1ZTogNjU5MTk4MSwKICBjb3Juc2lsazogMTY3NzUzODgsCiAgY3JpbXNvbjogMTQ0MjMxMDAsCiAgY3lhbjogNjU1MzUsCiAgZGFya2JsdWU6IDEzOSwKICBkYXJrY3lhbjogMzU3MjMsCiAgZGFya2dvbGRlbnJvZDogMTIwOTI5MzksCiAgZGFya2dyYXk6IDExMTE5MDE3LAogIGRhcmtncmVlbjogMjU2MDAsCiAgZGFya2dyZXk6IDExMTE5MDE3LAogIGRhcmtraGFraTogMTI0MzMyNTksCiAgZGFya21hZ2VudGE6IDkxMDk2NDMsCiAgZGFya29saXZlZ3JlZW46IDU1OTc5OTksCiAgZGFya29yYW5nZTogMTY3NDc1MjAsCiAgZGFya29yY2hpZDogMTAwNDAwMTIsCiAgZGFya3JlZDogOTEwOTUwNCwKICBkYXJrc2FsbW9uOiAxNTMwODQxMCwKICBkYXJrc2VhZ3JlZW46IDk0MTk5MTksCiAgZGFya3NsYXRlYmx1ZTogNDczNDM0NywKICBkYXJrc2xhdGVncmF5OiAzMTAwNDk1LAogIGRhcmtzbGF0ZWdyZXk6IDMxMDA0OTUsCiAgZGFya3R1cnF1b2lzZTogNTI5NDUsCiAgZGFya3Zpb2xldDogOTY5OTUzOSwKICBkZWVwcGluazogMTY3MTY5NDcsCiAgZGVlcHNreWJsdWU6IDQ5MTUxLAogIGRpbWdyYXk6IDY5MDgyNjUsCiAgZGltZ3JleTogNjkwODI2NSwKICBkb2RnZXJibHVlOiAyMDAzMTk5LAogIGZpcmVicmljazogMTE2NzQxNDYsCiAgZmxvcmFsd2hpdGU6IDE2Nzc1OTIwLAogIGZvcmVzdGdyZWVuOiAyMjYzODQyLAogIGZ1Y2hzaWE6IDE2NzExOTM1LAogIGdhaW5zYm9ybzogMTQ0NzQ0NjAsCiAgZ2hvc3R3aGl0ZTogMTYzMTY2NzEsCiAgZ29sZDogMTY3NjY3MjAsCiAgZ29sZGVucm9kOiAxNDMyOTEyMCwKICBncmF5OiA4NDIxNTA0LAogIGdyZWVuOiAzMjc2OCwKICBncmVlbnllbGxvdzogMTE0MDMwNTUsCiAgZ3JleTogODQyMTUwNCwKICBob25leWRldzogMTU3OTQxNjAsCiAgaG90cGluazogMTY3Mzg3NDAsCiAgaW5kaWFucmVkOiAxMzQ1ODUyNCwKICBpbmRpZ286IDQ5MTUzMzAsCiAgaXZvcnk6IDE2Nzc3MjAwLAogIGtoYWtpOiAxNTc4NzY2MCwKICBsYXZlbmRlcjogMTUxMzI0MTAsCiAgbGF2ZW5kZXJibHVzaDogMTY3NzMzNjUsCiAgbGF3bmdyZWVuOiA4MTkwOTc2LAogIGxlbW9uY2hpZmZvbjogMTY3NzU4ODUsCiAgbGlnaHRibHVlOiAxMTM5MzI1NCwKICBsaWdodGNvcmFsOiAxNTc2MTUzNiwKICBsaWdodGN5YW46IDE0NzQ1NTk5LAogIGxpZ2h0Z29sZGVucm9keWVsbG93OiAxNjQ0ODIxMCwKICBsaWdodGdyYXk6IDEzODgyMzIzLAogIGxpZ2h0Z3JlZW46IDk0OTgyNTYsCiAgbGlnaHRncmV5OiAxMzg4MjMyMywKICBsaWdodHBpbms6IDE2NzU4NDY1LAogIGxpZ2h0c2FsbW9uOiAxNjc1Mjc2MiwKICBsaWdodHNlYWdyZWVuOiAyMTQyODkwLAogIGxpZ2h0c2t5Ymx1ZTogODkwMDM0NiwKICBsaWdodHNsYXRlZ3JheTogNzgzMzc1MywKICBsaWdodHNsYXRlZ3JleTogNzgzMzc1MywKICBsaWdodHN0ZWVsYmx1ZTogMTE1ODQ3MzQsCiAgbGlnaHR5ZWxsb3c6IDE2Nzc3MTg0LAogIGxpbWU6IDY1MjgwLAogIGxpbWVncmVlbjogMzMyOTMzMCwKICBsaW5lbjogMTY0NDU2NzAsCiAgbWFnZW50YTogMTY3MTE5MzUsCiAgbWFyb29uOiA4Mzg4NjA4LAogIG1lZGl1bWFxdWFtYXJpbmU6IDY3MzczMjIsCiAgbWVkaXVtYmx1ZTogMjA1LAogIG1lZGl1bW9yY2hpZDogMTIyMTE2NjcsCiAgbWVkaXVtcHVycGxlOiA5NjYyNjgzLAogIG1lZGl1bXNlYWdyZWVuOiAzOTc4MDk3LAogIG1lZGl1bXNsYXRlYmx1ZTogODA4Nzc5MCwKICBtZWRpdW1zcHJpbmdncmVlbjogNjQxNTQsCiAgbWVkaXVtdHVycXVvaXNlOiA0NzcyMzAwLAogIG1lZGl1bXZpb2xldHJlZDogMTMwNDcxNzMsCiAgbWlkbmlnaHRibHVlOiAxNjQ0OTEyLAogIG1pbnRjcmVhbTogMTYxMjE4NTAsCiAgbWlzdHlyb3NlOiAxNjc3MDI3MywKICBtb2NjYXNpbjogMTY3NzAyMjksCiAgbmF2YWpvd2hpdGU6IDE2NzY4Njg1LAogIG5hdnk6IDEyOCwKICBvbGRsYWNlOiAxNjY0MzU1OCwKICBvbGl2ZTogODQyMTM3NiwKICBvbGl2ZWRyYWI6IDcwNDg3MzksCiAgb3JhbmdlOiAxNjc1MzkyMCwKICBvcmFuZ2VyZWQ6IDE2NzI5MzQ0LAogIG9yY2hpZDogMTQzMTU3MzQsCiAgcGFsZWdvbGRlbnJvZDogMTU2NTcxMzAsCiAgcGFsZWdyZWVuOiAxMDAyNTg4MCwKICBwYWxldHVycXVvaXNlOiAxMTUyOTk2NiwKICBwYWxldmlvbGV0cmVkOiAxNDM4MTIwMywKICBwYXBheWF3aGlwOiAxNjc3MzA3NywKICBwZWFjaHB1ZmY6IDE2NzY3NjczLAogIHBlcnU6IDEzNDY4OTkxLAogIHBpbms6IDE2NzYxMDM1LAogIHBsdW06IDE0NTI0NjM3LAogIHBvd2RlcmJsdWU6IDExNTkxOTEwLAogIHB1cnBsZTogODM4ODczNiwKICByZWJlY2NhcHVycGxlOiA2Njk3ODgxLAogIHJlZDogMTY3MTE2ODAsCiAgcm9zeWJyb3duOiAxMjM1NzUxOSwKICByb3lhbGJsdWU6IDQyODY5NDUsCiAgc2FkZGxlYnJvd246IDkxMjcxODcsCiAgc2FsbW9uOiAxNjQxNjg4MiwKICBzYW5keWJyb3duOiAxNjAzMjg2NCwKICBzZWFncmVlbjogMzA1MDMyNywKICBzZWFzaGVsbDogMTY3NzQ2MzgsCiAgc2llbm5hOiAxMDUwNjc5NywKICBzaWx2ZXI6IDEyNjMyMjU2LAogIHNreWJsdWU6IDg5MDAzMzEsCiAgc2xhdGVibHVlOiA2OTcwMDYxLAogIHNsYXRlZ3JheTogNzM3Mjk0NCwKICBzbGF0ZWdyZXk6IDczNzI5NDQsCiAgc25vdzogMTY3NzU5MzAsCiAgc3ByaW5nZ3JlZW46IDY1NDA3LAogIHN0ZWVsYmx1ZTogNDYyMDk4MCwKICB0YW46IDEzODA4NzgwLAogIHRlYWw6IDMyODk2LAogIHRoaXN0bGU6IDE0MjA0ODg4LAogIHRvbWF0bzogMTY3MzcwOTUsCiAgdHVycXVvaXNlOiA0MjUxODU2LAogIHZpb2xldDogMTU2MzEwODYsCiAgd2hlYXQ6IDE2MTEzMzMxLAogIHdoaXRlOiAxNjc3NzIxNSwKICB3aGl0ZXNtb2tlOiAxNjExOTI4NSwKICB5ZWxsb3c6IDE2Nzc2OTYwLAogIHllbGxvd2dyZWVuOiAxMDE0NTA3NAp9OwpkZWZpbmVfZGVmYXVsdChDb2xvciwgY29sb3IsIHsKICBjb3B5KGNoYW5uZWxzKSB7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLCB0aGlzLCBjaGFubmVscyk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiB0aGlzLnJnYigpLmRpc3BsYXlhYmxlKCk7CiAgfSwKICBoZXg6IGNvbG9yX2Zvcm1hdEhleCwKICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogIGZvcm1hdEhleDogY29sb3JfZm9ybWF0SGV4LAogIGZvcm1hdEhleDg6IGNvbG9yX2Zvcm1hdEhleDgsCiAgZm9ybWF0SHNsOiBjb2xvcl9mb3JtYXRIc2wsCiAgZm9ybWF0UmdiOiBjb2xvcl9mb3JtYXRSZ2IsCiAgdG9TdHJpbmc6IGNvbG9yX2Zvcm1hdFJnYgp9KTsKZnVuY3Rpb24gY29sb3JfZm9ybWF0SGV4KCkgewogIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdEhleCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhleDgoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0SGV4OCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhzbCgpIHsKICByZXR1cm4gaHNsQ29udmVydCh0aGlzKS5mb3JtYXRIc2woKTsKfQpmdW5jdGlvbiBjb2xvcl9mb3JtYXRSZ2IoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0UmdiKCk7Cn0KZnVuY3Rpb24gY29sb3IoZm9ybWF0MikgewogIHZhciBtLCBsOwogIGZvcm1hdDIgPSAoZm9ybWF0MiArICIiKS50cmltKCkudG9Mb3dlckNhc2UoKTsKICByZXR1cm4gKG0gPSByZUhleC5leGVjKGZvcm1hdDIpKSA/IChsID0gbVsxXS5sZW5ndGgsIG0gPSBwYXJzZUludChtWzFdLCAxNiksIGwgPT09IDYgPyByZ2JuKG0pIDogbCA9PT0gMyA/IG5ldyBSZ2IobSA+PiA4ICYgMTUgfCBtID4+IDQgJiAyNDAsIG0gPj4gNCAmIDE1IHwgbSAmIDI0MCwgKG0gJiAxNSkgPDwgNCB8IG0gJiAxNSwgMSkgOiBsID09PSA4ID8gcmdiYShtID4+IDI0ICYgMjU1LCBtID4+IDE2ICYgMjU1LCBtID4+IDggJiAyNTUsIChtICYgMjU1KSAvIDI1NSkgOiBsID09PSA0ID8gcmdiYShtID4+IDEyICYgMTUgfCBtID4+IDggJiAyNDAsIG0gPj4gOCAmIDE1IHwgbSA+PiA0ICYgMjQwLCBtID4+IDQgJiAxNSB8IG0gJiAyNDAsICgobSAmIDE1KSA8PCA0IHwgbSAmIDE1KSAvIDI1NSkgOiBudWxsKSA6IChtID0gcmVSZ2JJbnRlZ2VyLmV4ZWMoZm9ybWF0MikpID8gbmV3IFJnYihtWzFdLCBtWzJdLCBtWzNdLCAxKSA6IChtID0gcmVSZ2JQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gbmV3IFJnYihtWzFdICogMjU1IC8gMTAwLCBtWzJdICogMjU1IC8gMTAwLCBtWzNdICogMjU1IC8gMTAwLCAxKSA6IChtID0gcmVSZ2JhSW50ZWdlci5leGVjKGZvcm1hdDIpKSA/IHJnYmEobVsxXSwgbVsyXSwgbVszXSwgbVs0XSkgOiAobSA9IHJlUmdiYVBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyByZ2JhKG1bMV0gKiAyNTUgLyAxMDAsIG1bMl0gKiAyNTUgLyAxMDAsIG1bM10gKiAyNTUgLyAxMDAsIG1bNF0pIDogKG0gPSByZUhzbFBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyBoc2xhKG1bMV0sIG1bMl0gLyAxMDAsIG1bM10gLyAxMDAsIDEpIDogKG0gPSByZUhzbGFQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gaHNsYShtWzFdLCBtWzJdIC8gMTAwLCBtWzNdIC8gMTAwLCBtWzRdKSA6IG5hbWVkLmhhc093blByb3BlcnR5KGZvcm1hdDIpID8gcmdibihuYW1lZFtmb3JtYXQyXSkgOiBmb3JtYXQyID09PSAidHJhbnNwYXJlbnQiID8gbmV3IFJnYihOYU4sIE5hTiwgTmFOLCAwKSA6IG51bGw7Cn0KZnVuY3Rpb24gcmdibihuKSB7CiAgcmV0dXJuIG5ldyBSZ2IobiA+PiAxNiAmIDI1NSwgbiA+PiA4ICYgMjU1LCBuICYgMjU1LCAxKTsKfQpmdW5jdGlvbiByZ2JhKHIyLCBnLCBiLCBhMikgewogIGlmIChhMiA8PSAwKSByMiA9IGcgPSBiID0gTmFOOwogIHJldHVybiBuZXcgUmdiKHIyLCBnLCBiLCBhMik7Cn0KZnVuY3Rpb24gcmdiQ29udmVydChvKSB7CiAgaWYgKCEobyBpbnN0YW5jZW9mIENvbG9yKSkgbyA9IGNvbG9yKG8pOwogIGlmICghbykgcmV0dXJuIG5ldyBSZ2IoKTsKICBvID0gby5yZ2IoKTsKICByZXR1cm4gbmV3IFJnYihvLnIsIG8uZywgby5iLCBvLm9wYWNpdHkpOwp9CmZ1bmN0aW9uIHJnYihyMiwgZywgYiwgb3BhY2l0eSkgewogIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gcmdiQ29udmVydChyMikgOiBuZXcgUmdiKHIyLCBnLCBiLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gUmdiKHIyLCBnLCBiLCBvcGFjaXR5KSB7CiAgdGhpcy5yID0gK3IyOwogIHRoaXMuZyA9ICtnOwogIHRoaXMuYiA9ICtiOwogIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5Owp9CmRlZmluZV9kZWZhdWx0KFJnYiwgcmdiLCBleHRlbmQoQ29sb3IsIHsKICBicmlnaHRlcihrMikgewogICAgazIgPSBrMiA9PSBudWxsID8gYnJpZ2h0ZXIgOiBNYXRoLnBvdyhicmlnaHRlciwgazIpOwogICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogazIsIHRoaXMuZyAqIGsyLCB0aGlzLmIgKiBrMiwgdGhpcy5vcGFjaXR5KTsKICB9LAogIGRhcmtlcihrMikgewogICAgazIgPSBrMiA9PSBudWxsID8gZGFya2VyIDogTWF0aC5wb3coZGFya2VyLCBrMik7CiAgICByZXR1cm4gbmV3IFJnYih0aGlzLnIgKiBrMiwgdGhpcy5nICogazIsIHRoaXMuYiAqIGsyLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgcmdiKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBjbGFtcCgpIHsKICAgIHJldHVybiBuZXcgUmdiKGNsYW1waSh0aGlzLnIpLCBjbGFtcGkodGhpcy5nKSwgY2xhbXBpKHRoaXMuYiksIGNsYW1wYSh0aGlzLm9wYWNpdHkpKTsKICB9LAogIGRpc3BsYXlhYmxlKCkgewogICAgcmV0dXJuIC0wLjUgPD0gdGhpcy5yICYmIHRoaXMuciA8IDI1NS41ICYmICgtMC41IDw9IHRoaXMuZyAmJiB0aGlzLmcgPCAyNTUuNSkgJiYgKC0wLjUgPD0gdGhpcy5iICYmIHRoaXMuYiA8IDI1NS41KSAmJiAoMCA8PSB0aGlzLm9wYWNpdHkgJiYgdGhpcy5vcGFjaXR5IDw9IDEpOwogIH0sCiAgaGV4OiByZ2JfZm9ybWF0SGV4LAogIC8vIERlcHJlY2F0ZWQhIFVzZSBjb2xvci5mb3JtYXRIZXguCiAgZm9ybWF0SGV4OiByZ2JfZm9ybWF0SGV4LAogIGZvcm1hdEhleDg6IHJnYl9mb3JtYXRIZXg4LAogIGZvcm1hdFJnYjogcmdiX2Zvcm1hdFJnYiwKICB0b1N0cmluZzogcmdiX2Zvcm1hdFJnYgp9KSk7CmZ1bmN0aW9uIHJnYl9mb3JtYXRIZXgoKSB7CiAgcmV0dXJuIGAjJHtoZXgodGhpcy5yKX0ke2hleCh0aGlzLmcpfSR7aGV4KHRoaXMuYil9YDsKfQpmdW5jdGlvbiByZ2JfZm9ybWF0SGV4OCgpIHsKICByZXR1cm4gYCMke2hleCh0aGlzLnIpfSR7aGV4KHRoaXMuZyl9JHtoZXgodGhpcy5iKX0ke2hleCgoaXNOYU4odGhpcy5vcGFjaXR5KSA/IDEgOiB0aGlzLm9wYWNpdHkpICogMjU1KX1gOwp9CmZ1bmN0aW9uIHJnYl9mb3JtYXRSZ2IoKSB7CiAgY29uc3QgYTIgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICByZXR1cm4gYCR7YTIgPT09IDEgPyAicmdiKCIgOiAicmdiYSgifSR7Y2xhbXBpKHRoaXMucil9LCAke2NsYW1waSh0aGlzLmcpfSwgJHtjbGFtcGkodGhpcy5iKX0ke2EyID09PSAxID8gIikiIDogYCwgJHthMn0pYH1gOwp9CmZ1bmN0aW9uIGNsYW1wYShvcGFjaXR5KSB7CiAgcmV0dXJuIGlzTmFOKG9wYWNpdHkpID8gMSA6IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIG9wYWNpdHkpKTsKfQpmdW5jdGlvbiBjbGFtcGkodmFsdWUpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMjU1LCBNYXRoLnJvdW5kKHZhbHVlKSB8fCAwKSk7Cn0KZnVuY3Rpb24gaGV4KHZhbHVlKSB7CiAgdmFsdWUgPSBjbGFtcGkodmFsdWUpOwogIHJldHVybiAodmFsdWUgPCAxNiA/ICIwIiA6ICIiKSArIHZhbHVlLnRvU3RyaW5nKDE2KTsKfQpmdW5jdGlvbiBoc2xhKGgsIHMyLCBsLCBhMikgewogIGlmIChhMiA8PSAwKSBoID0gczIgPSBsID0gTmFOOwogIGVsc2UgaWYgKGwgPD0gMCB8fCBsID49IDEpIGggPSBzMiA9IE5hTjsKICBlbHNlIGlmIChzMiA8PSAwKSBoID0gTmFOOwogIHJldHVybiBuZXcgSHNsKGgsIHMyLCBsLCBhMik7Cn0KZnVuY3Rpb24gaHNsQ29udmVydChvKSB7CiAgaWYgKG8gaW5zdGFuY2VvZiBIc2wpIHJldHVybiBuZXcgSHNsKG8uaCwgby5zLCBvLmwsIG8ub3BhY2l0eSk7CiAgaWYgKCEobyBpbnN0YW5jZW9mIENvbG9yKSkgbyA9IGNvbG9yKG8pOwogIGlmICghbykgcmV0dXJuIG5ldyBIc2woKTsKICBpZiAobyBpbnN0YW5jZW9mIEhzbCkgcmV0dXJuIG87CiAgbyA9IG8ucmdiKCk7CiAgdmFyIHIyID0gby5yIC8gMjU1LCBnID0gby5nIC8gMjU1LCBiID0gby5iIC8gMjU1LCBtaW4yID0gTWF0aC5taW4ocjIsIGcsIGIpLCBtYXgyID0gTWF0aC5tYXgocjIsIGcsIGIpLCBoID0gTmFOLCBzMiA9IG1heDIgLSBtaW4yLCBsID0gKG1heDIgKyBtaW4yKSAvIDI7CiAgaWYgKHMyKSB7CiAgICBpZiAocjIgPT09IG1heDIpIGggPSAoZyAtIGIpIC8gczIgKyAoZyA8IGIpICogNjsKICAgIGVsc2UgaWYgKGcgPT09IG1heDIpIGggPSAoYiAtIHIyKSAvIHMyICsgMjsKICAgIGVsc2UgaCA9IChyMiAtIGcpIC8gczIgKyA0OwogICAgczIgLz0gbCA8IDAuNSA/IG1heDIgKyBtaW4yIDogMiAtIG1heDIgLSBtaW4yOwogICAgaCAqPSA2MDsKICB9IGVsc2UgewogICAgczIgPSBsID4gMCAmJiBsIDwgMSA/IDAgOiBoOwogIH0KICByZXR1cm4gbmV3IEhzbChoLCBzMiwgbCwgby5vcGFjaXR5KTsKfQpmdW5jdGlvbiBoc2woaCwgczIsIGwsIG9wYWNpdHkpIHsKICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IGhzbENvbnZlcnQoaCkgOiBuZXcgSHNsKGgsIHMyLCBsLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gSHNsKGgsIHMyLCBsLCBvcGFjaXR5KSB7CiAgdGhpcy5oID0gK2g7CiAgdGhpcy5zID0gK3MyOwogIHRoaXMubCA9ICtsOwogIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5Owp9CmRlZmluZV9kZWZhdWx0KEhzbCwgaHNsLCBleHRlbmQoQ29sb3IsIHsKICBicmlnaHRlcihrMikgewogICAgazIgPSBrMiA9PSBudWxsID8gYnJpZ2h0ZXIgOiBNYXRoLnBvdyhicmlnaHRlciwgazIpOwogICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGsyLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgZGFya2VyKGsyKSB7CiAgICBrMiA9IGsyID09IG51bGwgPyBkYXJrZXIgOiBNYXRoLnBvdyhkYXJrZXIsIGsyKTsKICAgIHJldHVybiBuZXcgSHNsKHRoaXMuaCwgdGhpcy5zLCB0aGlzLmwgKiBrMiwgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHZhciBoID0gdGhpcy5oICUgMzYwICsgKHRoaXMuaCA8IDApICogMzYwLCBzMiA9IGlzTmFOKGgpIHx8IGlzTmFOKHRoaXMucykgPyAwIDogdGhpcy5zLCBsID0gdGhpcy5sLCBtMiA9IGwgKyAobCA8IDAuNSA/IGwgOiAxIC0gbCkgKiBzMiwgbTEgPSAyICogbCAtIG0yOwogICAgcmV0dXJuIG5ldyBSZ2IoCiAgICAgIGhzbDJyZ2IoaCA+PSAyNDAgPyBoIC0gMjQwIDogaCArIDEyMCwgbTEsIG0yKSwKICAgICAgaHNsMnJnYihoLCBtMSwgbTIpLAogICAgICBoc2wycmdiKGggPCAxMjAgPyBoICsgMjQwIDogaCAtIDEyMCwgbTEsIG0yKSwKICAgICAgdGhpcy5vcGFjaXR5CiAgICApOwogIH0sCiAgY2xhbXAoKSB7CiAgICByZXR1cm4gbmV3IEhzbChjbGFtcGgodGhpcy5oKSwgY2xhbXB0KHRoaXMucyksIGNsYW1wdCh0aGlzLmwpLCBjbGFtcGEodGhpcy5vcGFjaXR5KSk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiAoMCA8PSB0aGlzLnMgJiYgdGhpcy5zIDw9IDEgfHwgaXNOYU4odGhpcy5zKSkgJiYgKDAgPD0gdGhpcy5sICYmIHRoaXMubCA8PSAxKSAmJiAoMCA8PSB0aGlzLm9wYWNpdHkgJiYgdGhpcy5vcGFjaXR5IDw9IDEpOwogIH0sCiAgZm9ybWF0SHNsKCkgewogICAgY29uc3QgYTIgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICAgIHJldHVybiBgJHthMiA9PT0gMSA/ICJoc2woIiA6ICJoc2xhKCJ9JHtjbGFtcGgodGhpcy5oKX0sICR7Y2xhbXB0KHRoaXMucykgKiAxMDB9JSwgJHtjbGFtcHQodGhpcy5sKSAqIDEwMH0lJHthMiA9PT0gMSA/ICIpIiA6IGAsICR7YTJ9KWB9YDsKICB9Cn0pKTsKZnVuY3Rpb24gY2xhbXBoKHZhbHVlKSB7CiAgdmFsdWUgPSAodmFsdWUgfHwgMCkgJSAzNjA7CiAgcmV0dXJuIHZhbHVlIDwgMCA/IHZhbHVlICsgMzYwIDogdmFsdWU7Cn0KZnVuY3Rpb24gY2xhbXB0KHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZhbHVlIHx8IDApKTsKfQpmdW5jdGlvbiBoc2wycmdiKGgsIG0xLCBtMikgewogIHJldHVybiAoaCA8IDYwID8gbTEgKyAobTIgLSBtMSkgKiBoIC8gNjAgOiBoIDwgMTgwID8gbTIgOiBoIDwgMjQwID8gbTEgKyAobTIgLSBtMSkgKiAoMjQwIC0gaCkgLyA2MCA6IG0xKSAqIDI1NTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9iYXNpcy5qcwpmdW5jdGlvbiBiYXNpcyh0MTIsIHYwLCB2MSwgdjIsIHYzKSB7CiAgdmFyIHQyID0gdDEyICogdDEyLCB0MyA9IHQyICogdDEyOwogIHJldHVybiAoKDEgLSAzICogdDEyICsgMyAqIHQyIC0gdDMpICogdjAgKyAoNCAtIDYgKiB0MiArIDMgKiB0MykgKiB2MSArICgxICsgMyAqIHQxMiArIDMgKiB0MiAtIDMgKiB0MykgKiB2MiArIHQzICogdjMpIC8gNjsKfQpmdW5jdGlvbiBiYXNpc19kZWZhdWx0Mih2YWx1ZXMpIHsKICB2YXIgbiA9IHZhbHVlcy5sZW5ndGggLSAxOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB2YXIgaSA9IHQgPD0gMCA/IHQgPSAwIDogdCA+PSAxID8gKHQgPSAxLCBuIC0gMSkgOiBNYXRoLmZsb29yKHQgKiBuKSwgdjEgPSB2YWx1ZXNbaV0sIHYyID0gdmFsdWVzW2kgKyAxXSwgdjAgPSBpID4gMCA/IHZhbHVlc1tpIC0gMV0gOiAyICogdjEgLSB2MiwgdjMgPSBpIDwgbiAtIDEgPyB2YWx1ZXNbaSArIDJdIDogMiAqIHYyIC0gdjE7CiAgICByZXR1cm4gYmFzaXMoKHQgLSBpIC8gbikgKiBuLCB2MCwgdjEsIHYyLCB2Myk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9iYXNpc0Nsb3NlZC5qcwpmdW5jdGlvbiBiYXNpc0Nsb3NlZF9kZWZhdWx0Mih2YWx1ZXMpIHsKICB2YXIgbiA9IHZhbHVlcy5sZW5ndGg7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHZhciBpID0gTWF0aC5mbG9vcigoKHQgJT0gMSkgPCAwID8gKyt0IDogdCkgKiBuKSwgdjAgPSB2YWx1ZXNbKGkgKyBuIC0gMSkgJSBuXSwgdjEgPSB2YWx1ZXNbaSAlIG5dLCB2MiA9IHZhbHVlc1soaSArIDEpICUgbl0sIHYzID0gdmFsdWVzWyhpICsgMikgJSBuXTsKICAgIHJldHVybiBiYXNpcygodCAtIGkgLyBuKSAqIG4sIHYwLCB2MSwgdjIsIHYzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2NvbnN0YW50LmpzCnZhciBjb25zdGFudF9kZWZhdWx0MiA9ICh4MikgPT4gKCkgPT4geDI7CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2NvbG9yLmpzCmZ1bmN0aW9uIGxpbmVhcihhMiwgZCkgewogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gYTIgKyB0ICogZDsKICB9Owp9CmZ1bmN0aW9uIGV4cG9uZW50aWFsKGEyLCBiLCB5MikgewogIHJldHVybiBhMiA9IE1hdGgucG93KGEyLCB5MiksIGIgPSBNYXRoLnBvdyhiLCB5MikgLSBhMiwgeTIgPSAxIC8geTIsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBNYXRoLnBvdyhhMiArIHQgKiBiLCB5Mik7CiAgfTsKfQpmdW5jdGlvbiBnYW1tYSh5MikgewogIHJldHVybiAoeTIgPSAreTIpID09PSAxID8gbm9nYW1tYSA6IGZ1bmN0aW9uKGEyLCBiKSB7CiAgICByZXR1cm4gYiAtIGEyID8gZXhwb25lbnRpYWwoYTIsIGIsIHkyKSA6IGNvbnN0YW50X2RlZmF1bHQyKGlzTmFOKGEyKSA/IGIgOiBhMik7CiAgfTsKfQpmdW5jdGlvbiBub2dhbW1hKGEyLCBiKSB7CiAgdmFyIGQgPSBiIC0gYTI7CiAgcmV0dXJuIGQgPyBsaW5lYXIoYTIsIGQpIDogY29uc3RhbnRfZGVmYXVsdDIoaXNOYU4oYTIpID8gYiA6IGEyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9yZ2IuanMKdmFyIHJnYl9kZWZhdWx0ID0gZnVuY3Rpb24gcmdiR2FtbWEoeTIpIHsKICB2YXIgY29sb3IyID0gZ2FtbWEoeTIpOwogIGZ1bmN0aW9uIHJnYjIoc3RhcnQsIGVuZCkgewogICAgdmFyIHIyID0gY29sb3IyKChzdGFydCA9IHJnYihzdGFydCkpLnIsIChlbmQgPSByZ2IoZW5kKSkuciksIGcgPSBjb2xvcjIoc3RhcnQuZywgZW5kLmcpLCBiID0gY29sb3IyKHN0YXJ0LmIsIGVuZC5iKSwgb3BhY2l0eSA9IG5vZ2FtbWEoc3RhcnQub3BhY2l0eSwgZW5kLm9wYWNpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgc3RhcnQuciA9IHIyKHQpOwogICAgICBzdGFydC5nID0gZyh0KTsKICAgICAgc3RhcnQuYiA9IGIodCk7CiAgICAgIHN0YXJ0Lm9wYWNpdHkgPSBvcGFjaXR5KHQpOwogICAgICByZXR1cm4gc3RhcnQgKyAiIjsKICAgIH07CiAgfQogIHJnYjIuZ2FtbWEgPSByZ2JHYW1tYTsKICByZXR1cm4gcmdiMjsKfSgxKTsKZnVuY3Rpb24gcmdiU3BsaW5lKHNwbGluZSkgewogIHJldHVybiBmdW5jdGlvbihjb2xvcnMpIHsKICAgIHZhciBuID0gY29sb3JzLmxlbmd0aCwgcjIgPSBuZXcgQXJyYXkobiksIGcgPSBuZXcgQXJyYXkobiksIGIgPSBuZXcgQXJyYXkobiksIGksIGNvbG9yMjsKICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgY29sb3IyID0gcmdiKGNvbG9yc1tpXSk7CiAgICAgIHIyW2ldID0gY29sb3IyLnIgfHwgMDsKICAgICAgZ1tpXSA9IGNvbG9yMi5nIHx8IDA7CiAgICAgIGJbaV0gPSBjb2xvcjIuYiB8fCAwOwogICAgfQogICAgcjIgPSBzcGxpbmUocjIpOwogICAgZyA9IHNwbGluZShnKTsKICAgIGIgPSBzcGxpbmUoYik7CiAgICBjb2xvcjIub3BhY2l0eSA9IDE7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICBjb2xvcjIuciA9IHIyKHQpOwogICAgICBjb2xvcjIuZyA9IGcodCk7CiAgICAgIGNvbG9yMi5iID0gYih0KTsKICAgICAgcmV0dXJuIGNvbG9yMiArICIiOwogICAgfTsKICB9Owp9CnZhciByZ2JCYXNpcyA9IHJnYlNwbGluZShiYXNpc19kZWZhdWx0Mik7CnZhciByZ2JCYXNpc0Nsb3NlZCA9IHJnYlNwbGluZShiYXNpc0Nsb3NlZF9kZWZhdWx0Mik7CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL251bWJlckFycmF5LmpzCmZ1bmN0aW9uIG51bWJlckFycmF5X2RlZmF1bHQoYTIsIGIpIHsKICBpZiAoIWIpIGIgPSBbXTsKICB2YXIgbiA9IGEyID8gTWF0aC5taW4oYi5sZW5ndGgsIGEyLmxlbmd0aCkgOiAwLCBjMiA9IGIuc2xpY2UoKSwgaTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgYzJbaV0gPSBhMltpXSAqICgxIC0gdCkgKyBiW2ldICogdDsKICAgIHJldHVybiBjMjsKICB9Owp9CmZ1bmN0aW9uIGlzTnVtYmVyQXJyYXkoeDIpIHsKICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2FycmF5LmpzCmZ1bmN0aW9uIGdlbmVyaWNBcnJheShhMiwgYikgewogIHZhciBuYiA9IGIgPyBiLmxlbmd0aCA6IDAsIG5hID0gYTIgPyBNYXRoLm1pbihuYiwgYTIubGVuZ3RoKSA6IDAsIHgyID0gbmV3IEFycmF5KG5hKSwgYzIgPSBuZXcgQXJyYXkobmIpLCBpOwogIGZvciAoaSA9IDA7IGkgPCBuYTsgKytpKSB4MltpXSA9IHZhbHVlX2RlZmF1bHQoYTJbaV0sIGJbaV0pOwogIGZvciAoOyBpIDwgbmI7ICsraSkgYzJbaV0gPSBiW2ldOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICBmb3IgKGkgPSAwOyBpIDwgbmE7ICsraSkgYzJbaV0gPSB4MltpXSh0KTsKICAgIHJldHVybiBjMjsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2RhdGUuanMKZnVuY3Rpb24gZGF0ZV9kZWZhdWx0KGEyLCBiKSB7CiAgdmFyIGQgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKICByZXR1cm4gYTIgPSArYTIsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGQuc2V0VGltZShhMiAqICgxIC0gdCkgKyBiICogdCksIGQ7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyX2RlZmF1bHQoYTIsIGIpIHsKICByZXR1cm4gYTIgPSArYTIsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGEyICogKDEgLSB0KSArIGIgKiB0OwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvb2JqZWN0LmpzCmZ1bmN0aW9uIG9iamVjdF9kZWZhdWx0KGEyLCBiKSB7CiAgdmFyIGkgPSB7fSwgYzIgPSB7fSwgazI7CiAgaWYgKGEyID09PSBudWxsIHx8IHR5cGVvZiBhMiAhPT0gIm9iamVjdCIpIGEyID0ge307CiAgaWYgKGIgPT09IG51bGwgfHwgdHlwZW9mIGIgIT09ICJvYmplY3QiKSBiID0ge307CiAgZm9yIChrMiBpbiBiKSB7CiAgICBpZiAoazIgaW4gYTIpIHsKICAgICAgaVtrMl0gPSB2YWx1ZV9kZWZhdWx0KGEyW2syXSwgYltrMl0pOwogICAgfSBlbHNlIHsKICAgICAgYzJbazJdID0gYltrMl07CiAgICB9CiAgfQogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICBmb3IgKGsyIGluIGkpIGMyW2syXSA9IGlbazJdKHQpOwogICAgcmV0dXJuIGMyOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvc3RyaW5nLmpzCnZhciByZUEgPSAvWy0rXT8oPzpcZCtcLj9cZCp8XC4/XGQrKSg/OltlRV1bLStdP1xkKyk/L2c7CnZhciByZUIgPSBuZXcgUmVnRXhwKHJlQS5zb3VyY2UsICJnIik7CmZ1bmN0aW9uIHplcm8yKGIpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYjsKICB9Owp9CmZ1bmN0aW9uIG9uZShiKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBiKHQpICsgIiI7CiAgfTsKfQpmdW5jdGlvbiBzdHJpbmdfZGVmYXVsdChhMiwgYikgewogIHZhciBiaSA9IHJlQS5sYXN0SW5kZXggPSByZUIubGFzdEluZGV4ID0gMCwgYW0sIGJtLCBicywgaSA9IC0xLCBzMiA9IFtdLCBxID0gW107CiAgYTIgPSBhMiArICIiLCBiID0gYiArICIiOwogIHdoaWxlICgoYW0gPSByZUEuZXhlYyhhMikpICYmIChibSA9IHJlQi5leGVjKGIpKSkgewogICAgaWYgKChicyA9IGJtLmluZGV4KSA+IGJpKSB7CiAgICAgIGJzID0gYi5zbGljZShiaSwgYnMpOwogICAgICBpZiAoczJbaV0pIHMyW2ldICs9IGJzOwogICAgICBlbHNlIHMyWysraV0gPSBiczsKICAgIH0KICAgIGlmICgoYW0gPSBhbVswXSkgPT09IChibSA9IGJtWzBdKSkgewogICAgICBpZiAoczJbaV0pIHMyW2ldICs9IGJtOwogICAgICBlbHNlIHMyWysraV0gPSBibTsKICAgIH0gZWxzZSB7CiAgICAgIHMyWysraV0gPSBudWxsOwogICAgICBxLnB1c2goeyBpLCB4OiBudW1iZXJfZGVmYXVsdChhbSwgYm0pIH0pOwogICAgfQogICAgYmkgPSByZUIubGFzdEluZGV4OwogIH0KICBpZiAoYmkgPCBiLmxlbmd0aCkgewogICAgYnMgPSBiLnNsaWNlKGJpKTsKICAgIGlmIChzMltpXSkgczJbaV0gKz0gYnM7CiAgICBlbHNlIHMyWysraV0gPSBiczsKICB9CiAgcmV0dXJuIHMyLmxlbmd0aCA8IDIgPyBxWzBdID8gb25lKHFbMF0ueCkgOiB6ZXJvMihiKSA6IChiID0gcS5sZW5ndGgsIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAodmFyIGkyID0gMCwgbzsgaTIgPCBiOyArK2kyKSBzMlsobyA9IHFbaTJdKS5pXSA9IG8ueCh0KTsKICAgIHJldHVybiBzMi5qb2luKCIiKTsKICB9KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy92YWx1ZS5qcwpmdW5jdGlvbiB2YWx1ZV9kZWZhdWx0KGEyLCBiKSB7CiAgdmFyIHQgPSB0eXBlb2YgYiwgYzI7CiAgcmV0dXJuIGIgPT0gbnVsbCB8fCB0ID09PSAiYm9vbGVhbiIgPyBjb25zdGFudF9kZWZhdWx0MihiKSA6ICh0ID09PSAibnVtYmVyIiA/IG51bWJlcl9kZWZhdWx0IDogdCA9PT0gInN0cmluZyIgPyAoYzIgPSBjb2xvcihiKSkgPyAoYiA9IGMyLCByZ2JfZGVmYXVsdCkgOiBzdHJpbmdfZGVmYXVsdCA6IGIgaW5zdGFuY2VvZiBjb2xvciA/IHJnYl9kZWZhdWx0IDogYiBpbnN0YW5jZW9mIERhdGUgPyBkYXRlX2RlZmF1bHQgOiBpc051bWJlckFycmF5KGIpID8gbnVtYmVyQXJyYXlfZGVmYXVsdCA6IEFycmF5LmlzQXJyYXkoYikgPyBnZW5lcmljQXJyYXkgOiB0eXBlb2YgYi52YWx1ZU9mICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBiLnRvU3RyaW5nICE9PSAiZnVuY3Rpb24iIHx8IGlzTmFOKGIpID8gb2JqZWN0X2RlZmF1bHQgOiBudW1iZXJfZGVmYXVsdCkoYTIsIGIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3JvdW5kLmpzCmZ1bmN0aW9uIHJvdW5kX2RlZmF1bHQoYTIsIGIpIHsKICByZXR1cm4gYTIgPSArYTIsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIE1hdGgucm91bmQoYTIgKiAoMSAtIHQpICsgYiAqIHQpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvcGllY2V3aXNlLmpzCmZ1bmN0aW9uIHBpZWNld2lzZShpbnRlcnBvbGF0ZTIsIHZhbHVlcykgewogIGlmICh2YWx1ZXMgPT09IHZvaWQgMCkgdmFsdWVzID0gaW50ZXJwb2xhdGUyLCBpbnRlcnBvbGF0ZTIgPSB2YWx1ZV9kZWZhdWx0OwogIHZhciBpID0gMCwgbiA9IHZhbHVlcy5sZW5ndGggLSAxLCB2ID0gdmFsdWVzWzBdLCBJID0gbmV3IEFycmF5KG4gPCAwID8gMCA6IG4pOwogIHdoaWxlIChpIDwgbikgSVtpXSA9IGludGVycG9sYXRlMih2LCB2ID0gdmFsdWVzWysraV0pOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB2YXIgaTIgPSBNYXRoLm1heCgwLCBNYXRoLm1pbihuIC0gMSwgTWF0aC5mbG9vcih0ICo9IG4pKSk7CiAgICByZXR1cm4gSVtpMl0odCAtIGkyKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2NvbnN0YW50LmpzCmZ1bmN0aW9uIGNvbnN0YW50cyh4MikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB4MjsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL251bWJlci5qcwpmdW5jdGlvbiBudW1iZXIyKHgyKSB7CiAgcmV0dXJuICt4MjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9jb250aW51b3VzLmpzCnZhciB1bml0ID0gWzAsIDFdOwpmdW5jdGlvbiBpZGVudGl0eSh4MikgewogIHJldHVybiB4MjsKfQpmdW5jdGlvbiBub3JtYWxpemUoYTIsIGIpIHsKICByZXR1cm4gKGIgLT0gYTIgPSArYTIpID8gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiAoeDIgLSBhMikgLyBiOwogIH0gOiBjb25zdGFudHMoaXNOYU4oYikgPyBOYU4gOiAwLjUpOwp9CmZ1bmN0aW9uIGNsYW1wZXIoYTIsIGIpIHsKICB2YXIgdDsKICBpZiAoYTIgPiBiKSB0ID0gYTIsIGEyID0gYiwgYiA9IHQ7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoYTIsIE1hdGgubWluKGIsIHgyKSk7CiAgfTsKfQpmdW5jdGlvbiBiaW1hcChkb21haW4sIHJhbmdlNCwgaW50ZXJwb2xhdGUyKSB7CiAgdmFyIGQwID0gZG9tYWluWzBdLCBkMSA9IGRvbWFpblsxXSwgcjAgPSByYW5nZTRbMF0sIHIxID0gcmFuZ2U0WzFdOwogIGlmIChkMSA8IGQwKSBkMCA9IG5vcm1hbGl6ZShkMSwgZDApLCByMCA9IGludGVycG9sYXRlMihyMSwgcjApOwogIGVsc2UgZDAgPSBub3JtYWxpemUoZDAsIGQxKSwgcjAgPSBpbnRlcnBvbGF0ZTIocjAsIHIxKTsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiByMChkMCh4MikpOwogIH07Cn0KZnVuY3Rpb24gcG9seW1hcChkb21haW4sIHJhbmdlNCwgaW50ZXJwb2xhdGUyKSB7CiAgdmFyIGogPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoKSAtIDEsIGQgPSBuZXcgQXJyYXkoaiksIHIyID0gbmV3IEFycmF5KGopLCBpID0gLTE7CiAgaWYgKGRvbWFpbltqXSA8IGRvbWFpblswXSkgewogICAgZG9tYWluID0gZG9tYWluLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgcmFuZ2U0ID0gcmFuZ2U0LnNsaWNlKCkucmV2ZXJzZSgpOwogIH0KICB3aGlsZSAoKytpIDwgaikgewogICAgZFtpXSA9IG5vcm1hbGl6ZShkb21haW5baV0sIGRvbWFpbltpICsgMV0pOwogICAgcjJbaV0gPSBpbnRlcnBvbGF0ZTIocmFuZ2U0W2ldLCByYW5nZTRbaSArIDFdKTsKICB9CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICB2YXIgaTIgPSBiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAxLCBqKSAtIDE7CiAgICByZXR1cm4gcjJbaTJdKGRbaTJdKHgyKSk7CiAgfTsKfQpmdW5jdGlvbiBjb3B5KHNvdXJjZSwgdGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldC5kb21haW4oc291cmNlLmRvbWFpbigpKS5yYW5nZShzb3VyY2UucmFuZ2UoKSkuaW50ZXJwb2xhdGUoc291cmNlLmludGVycG9sYXRlKCkpLmNsYW1wKHNvdXJjZS5jbGFtcCgpKS51bmtub3duKHNvdXJjZS51bmtub3duKCkpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybWVyKCkgewogIHZhciBkb21haW4gPSB1bml0LCByYW5nZTQgPSB1bml0LCBpbnRlcnBvbGF0ZTIgPSB2YWx1ZV9kZWZhdWx0LCB0cmFuc2Zvcm0sIHVudHJhbnNmb3JtLCB1bmtub3duLCBjbGFtcCA9IGlkZW50aXR5LCBwaWVjZXdpc2UyLCBvdXRwdXQsIGlucHV0OwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICB2YXIgbiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlNC5sZW5ndGgpOwogICAgaWYgKGNsYW1wICE9PSBpZGVudGl0eSkgY2xhbXAgPSBjbGFtcGVyKGRvbWFpblswXSwgZG9tYWluW24gLSAxXSk7CiAgICBwaWVjZXdpc2UyID0gbiA+IDIgPyBwb2x5bWFwIDogYmltYXA7CiAgICBvdXRwdXQgPSBpbnB1dCA9IG51bGw7CiAgICByZXR1cm4gc2NhbGU7CiAgfQogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogKG91dHB1dCB8fCAob3V0cHV0ID0gcGllY2V3aXNlMihkb21haW4ubWFwKHRyYW5zZm9ybSksIHJhbmdlNCwgaW50ZXJwb2xhdGUyKSkpKHRyYW5zZm9ybShjbGFtcCh4MikpKTsKICB9CiAgc2NhbGUuaW52ZXJ0ID0gZnVuY3Rpb24oeTIpIHsKICAgIHJldHVybiBjbGFtcCh1bnRyYW5zZm9ybSgoaW5wdXQgfHwgKGlucHV0ID0gcGllY2V3aXNlMihyYW5nZTQsIGRvbWFpbi5tYXAodHJhbnNmb3JtKSwgbnVtYmVyX2RlZmF1bHQpKSkoeTIpKSk7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4gPSBBcnJheS5mcm9tKF8sIG51bWJlcjIpLCByZXNjYWxlKCkpIDogZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlNCA9IEFycmF5LmZyb20oXyksIHJlc2NhbGUoKSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlUm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gcmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgaW50ZXJwb2xhdGUyID0gcm91bmRfZGVmYXVsdCwgcmVzY2FsZSgpOwogIH07CiAgc2NhbGUuY2xhbXAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjbGFtcCA9IF8gPyB0cnVlIDogaWRlbnRpdHksIHJlc2NhbGUoKSkgOiBjbGFtcCAhPT0gaWRlbnRpdHk7CiAgfTsKICBzY2FsZS5pbnRlcnBvbGF0ZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRlMiA9IF8sIHJlc2NhbGUoKSkgOiBpbnRlcnBvbGF0ZTI7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICByZXR1cm4gZnVuY3Rpb24odCwgdSkgewogICAgdHJhbnNmb3JtID0gdCwgdW50cmFuc2Zvcm0gPSB1OwogICAgcmV0dXJuIHJlc2NhbGUoKTsKICB9Owp9CmZ1bmN0aW9uIGNvbnRpbnVvdXMoKSB7CiAgcmV0dXJuIHRyYW5zZm9ybWVyKCkoaWRlbnRpdHksIGlkZW50aXR5KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0RGVjaW1hbC5qcwpmdW5jdGlvbiBmb3JtYXREZWNpbWFsX2RlZmF1bHQoeDIpIHsKICByZXR1cm4gTWF0aC5hYnMoeDIgPSBNYXRoLnJvdW5kKHgyKSkgPj0gMWUyMSA/IHgyLnRvTG9jYWxlU3RyaW5nKCJlbiIpLnJlcGxhY2UoLywvZywgIiIpIDogeDIudG9TdHJpbmcoMTApOwp9CmZ1bmN0aW9uIGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCkgewogIGlmICgoaSA9ICh4MiA9IHAgPyB4Mi50b0V4cG9uZW50aWFsKHAgLSAxKSA6IHgyLnRvRXhwb25lbnRpYWwoKSkuaW5kZXhPZigiZSIpKSA8IDApIHJldHVybiBudWxsOwogIHZhciBpLCBjb2VmZmljaWVudCA9IHgyLnNsaWNlKDAsIGkpOwogIHJldHVybiBbCiAgICBjb2VmZmljaWVudC5sZW5ndGggPiAxID8gY29lZmZpY2llbnRbMF0gKyBjb2VmZmljaWVudC5zbGljZSgyKSA6IGNvZWZmaWNpZW50LAogICAgK3gyLnNsaWNlKGkgKyAxKQogIF07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2V4cG9uZW50LmpzCmZ1bmN0aW9uIGV4cG9uZW50X2RlZmF1bHQoeDIpIHsKICByZXR1cm4geDIgPSBmb3JtYXREZWNpbWFsUGFydHMoTWF0aC5hYnMoeDIpKSwgeDIgPyB4MlsxXSA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0R3JvdXAuanMKZnVuY3Rpb24gZm9ybWF0R3JvdXBfZGVmYXVsdChncm91cGluZywgdGhvdXNhbmRzKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCB3aWR0aCkgewogICAgdmFyIGkgPSB2YWx1ZS5sZW5ndGgsIHQgPSBbXSwgaiA9IDAsIGcgPSBncm91cGluZ1swXSwgbGVuZ3RoID0gMDsKICAgIHdoaWxlIChpID4gMCAmJiBnID4gMCkgewogICAgICBpZiAobGVuZ3RoICsgZyArIDEgPiB3aWR0aCkgZyA9IE1hdGgubWF4KDEsIHdpZHRoIC0gbGVuZ3RoKTsKICAgICAgdC5wdXNoKHZhbHVlLnN1YnN0cmluZyhpIC09IGcsIGkgKyBnKSk7CiAgICAgIGlmICgobGVuZ3RoICs9IGcgKyAxKSA+IHdpZHRoKSBicmVhazsKICAgICAgZyA9IGdyb3VwaW5nW2ogPSAoaiArIDEpICUgZ3JvdXBpbmcubGVuZ3RoXTsKICAgIH0KICAgIHJldHVybiB0LnJldmVyc2UoKS5qb2luKHRob3VzYW5kcyk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0TnVtZXJhbHMuanMKZnVuY3Rpb24gZm9ybWF0TnVtZXJhbHNfZGVmYXVsdChudW1lcmFscykgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoL1swLTldL2csIGZ1bmN0aW9uKGkpIHsKICAgICAgcmV0dXJuIG51bWVyYWxzWytpXTsKICAgIH0pOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFNwZWNpZmllci5qcwp2YXIgcmUgPSAvXig/OiguKT8oWzw+PV5dKSk/KFsrXC0oIF0pPyhbJCNdKT8oMCk/KFxkKyk/KCwpPyhcLlxkKyk/KH4pPyhbYS16JV0pPyQvaTsKZnVuY3Rpb24gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikgewogIGlmICghKG1hdGNoID0gcmUuZXhlYyhzcGVjaWZpZXIpKSkgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkIGZvcm1hdDogIiArIHNwZWNpZmllcik7CiAgdmFyIG1hdGNoOwogIHJldHVybiBuZXcgRm9ybWF0U3BlY2lmaWVyKHsKICAgIGZpbGw6IG1hdGNoWzFdLAogICAgYWxpZ246IG1hdGNoWzJdLAogICAgc2lnbjogbWF0Y2hbM10sCiAgICBzeW1ib2w6IG1hdGNoWzRdLAogICAgemVybzogbWF0Y2hbNV0sCiAgICB3aWR0aDogbWF0Y2hbNl0sCiAgICBjb21tYTogbWF0Y2hbN10sCiAgICBwcmVjaXNpb246IG1hdGNoWzhdICYmIG1hdGNoWzhdLnNsaWNlKDEpLAogICAgdHJpbTogbWF0Y2hbOV0sCiAgICB0eXBlOiBtYXRjaFsxMF0KICB9KTsKfQpmb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlID0gRm9ybWF0U3BlY2lmaWVyLnByb3RvdHlwZTsKZnVuY3Rpb24gRm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikgewogIHRoaXMuZmlsbCA9IHNwZWNpZmllci5maWxsID09PSB2b2lkIDAgPyAiICIgOiBzcGVjaWZpZXIuZmlsbCArICIiOwogIHRoaXMuYWxpZ24gPSBzcGVjaWZpZXIuYWxpZ24gPT09IHZvaWQgMCA/ICI+IiA6IHNwZWNpZmllci5hbGlnbiArICIiOwogIHRoaXMuc2lnbiA9IHNwZWNpZmllci5zaWduID09PSB2b2lkIDAgPyAiLSIgOiBzcGVjaWZpZXIuc2lnbiArICIiOwogIHRoaXMuc3ltYm9sID0gc3BlY2lmaWVyLnN5bWJvbCA9PT0gdm9pZCAwID8gIiIgOiBzcGVjaWZpZXIuc3ltYm9sICsgIiI7CiAgdGhpcy56ZXJvID0gISFzcGVjaWZpZXIuemVybzsKICB0aGlzLndpZHRoID0gc3BlY2lmaWVyLndpZHRoID09PSB2b2lkIDAgPyB2b2lkIDAgOiArc3BlY2lmaWVyLndpZHRoOwogIHRoaXMuY29tbWEgPSAhIXNwZWNpZmllci5jb21tYTsKICB0aGlzLnByZWNpc2lvbiA9IHNwZWNpZmllci5wcmVjaXNpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6ICtzcGVjaWZpZXIucHJlY2lzaW9uOwogIHRoaXMudHJpbSA9ICEhc3BlY2lmaWVyLnRyaW07CiAgdGhpcy50eXBlID0gc3BlY2lmaWVyLnR5cGUgPT09IHZvaWQgMCA/ICIiIDogc3BlY2lmaWVyLnR5cGUgKyAiIjsKfQpGb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuZmlsbCArIHRoaXMuYWxpZ24gKyB0aGlzLnNpZ24gKyB0aGlzLnN5bWJvbCArICh0aGlzLnplcm8gPyAiMCIgOiAiIikgKyAodGhpcy53aWR0aCA9PT0gdm9pZCAwID8gIiIgOiBNYXRoLm1heCgxLCB0aGlzLndpZHRoIHwgMCkpICsgKHRoaXMuY29tbWEgPyAiLCIgOiAiIikgKyAodGhpcy5wcmVjaXNpb24gPT09IHZvaWQgMCA/ICIiIDogIi4iICsgTWF0aC5tYXgoMCwgdGhpcy5wcmVjaXNpb24gfCAwKSkgKyAodGhpcy50cmltID8gIn4iIDogIiIpICsgdGhpcy50eXBlOwp9OwoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0VHJpbS5qcwpmdW5jdGlvbiBmb3JtYXRUcmltX2RlZmF1bHQoczIpIHsKICBvdXQ6IGZvciAodmFyIG4gPSBzMi5sZW5ndGgsIGkgPSAxLCBpMCA9IC0xLCBpMTsgaSA8IG47ICsraSkgewogICAgc3dpdGNoIChzMltpXSkgewogICAgICBjYXNlICIuIjoKICAgICAgICBpMCA9IGkxID0gaTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiMCI6CiAgICAgICAgaWYgKGkwID09PSAwKSBpMCA9IGk7CiAgICAgICAgaTEgPSBpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIGlmICghK3MyW2ldKSBicmVhayBvdXQ7CiAgICAgICAgaWYgKGkwID4gMCkgaTAgPSAwOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICByZXR1cm4gaTAgPiAwID8gczIuc2xpY2UoMCwgaTApICsgczIuc2xpY2UoaTEgKyAxKSA6IHMyOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRQcmVmaXhBdXRvLmpzCnZhciBwcmVmaXhFeHBvbmVudDsKZnVuY3Rpb24gZm9ybWF0UHJlZml4QXV0b19kZWZhdWx0KHgyLCBwKSB7CiAgdmFyIGQgPSBmb3JtYXREZWNpbWFsUGFydHMoeDIsIHApOwogIGlmICghZCkgcmV0dXJuIHgyICsgIiI7CiAgdmFyIGNvZWZmaWNpZW50ID0gZFswXSwgZXhwb25lbnQgPSBkWzFdLCBpID0gZXhwb25lbnQgLSAocHJlZml4RXhwb25lbnQgPSBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudCAvIDMpKSkgKiAzKSArIDEsIG4gPSBjb2VmZmljaWVudC5sZW5ndGg7CiAgcmV0dXJuIGkgPT09IG4gPyBjb2VmZmljaWVudCA6IGkgPiBuID8gY29lZmZpY2llbnQgKyBuZXcgQXJyYXkoaSAtIG4gKyAxKS5qb2luKCIwIikgOiBpID4gMCA/IGNvZWZmaWNpZW50LnNsaWNlKDAsIGkpICsgIi4iICsgY29lZmZpY2llbnQuc2xpY2UoaSkgOiAiMC4iICsgbmV3IEFycmF5KDEgLSBpKS5qb2luKCIwIikgKyBmb3JtYXREZWNpbWFsUGFydHMoeDIsIE1hdGgubWF4KDAsIHAgKyBpIC0gMSkpWzBdOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRSb3VuZGVkLmpzCmZ1bmN0aW9uIGZvcm1hdFJvdW5kZWRfZGVmYXVsdCh4MiwgcCkgewogIHZhciBkID0gZm9ybWF0RGVjaW1hbFBhcnRzKHgyLCBwKTsKICBpZiAoIWQpIHJldHVybiB4MiArICIiOwogIHZhciBjb2VmZmljaWVudCA9IGRbMF0sIGV4cG9uZW50ID0gZFsxXTsKICByZXR1cm4gZXhwb25lbnQgPCAwID8gIjAuIiArIG5ldyBBcnJheSgtZXhwb25lbnQpLmpvaW4oIjAiKSArIGNvZWZmaWNpZW50IDogY29lZmZpY2llbnQubGVuZ3RoID4gZXhwb25lbnQgKyAxID8gY29lZmZpY2llbnQuc2xpY2UoMCwgZXhwb25lbnQgKyAxKSArICIuIiArIGNvZWZmaWNpZW50LnNsaWNlKGV4cG9uZW50ICsgMSkgOiBjb2VmZmljaWVudCArIG5ldyBBcnJheShleHBvbmVudCAtIGNvZWZmaWNpZW50Lmxlbmd0aCArIDIpLmpvaW4oIjAiKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0VHlwZXMuanMKdmFyIGZvcm1hdFR5cGVzX2RlZmF1bHQgPSB7CiAgIiUiOiAoeDIsIHApID0+ICh4MiAqIDEwMCkudG9GaXhlZChwKSwKICAiYiI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMiksCiAgImMiOiAoeDIpID0+IHgyICsgIiIsCiAgImQiOiBmb3JtYXREZWNpbWFsX2RlZmF1bHQsCiAgImUiOiAoeDIsIHApID0+IHgyLnRvRXhwb25lbnRpYWwocCksCiAgImYiOiAoeDIsIHApID0+IHgyLnRvRml4ZWQocCksCiAgImciOiAoeDIsIHApID0+IHgyLnRvUHJlY2lzaW9uKHApLAogICJvIjogKHgyKSA9PiBNYXRoLnJvdW5kKHgyKS50b1N0cmluZyg4KSwKICAicCI6ICh4MiwgcCkgPT4gZm9ybWF0Um91bmRlZF9kZWZhdWx0KHgyICogMTAwLCBwKSwKICAiciI6IGZvcm1hdFJvdW5kZWRfZGVmYXVsdCwKICAicyI6IGZvcm1hdFByZWZpeEF1dG9fZGVmYXVsdCwKICAiWCI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCksCiAgIngiOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDE2KQp9OwoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvaWRlbnRpdHkuanMKZnVuY3Rpb24gaWRlbnRpdHlfZGVmYXVsdCh4MikgewogIHJldHVybiB4MjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvbG9jYWxlLmpzCnZhciBtYXAgPSBBcnJheS5wcm90b3R5cGUubWFwOwp2YXIgcHJlZml4ZXMgPSBbInkiLCAieiIsICJhIiwgImYiLCAicCIsICJuIiwgIlx4QjUiLCAibSIsICIiLCAiayIsICJNIiwgIkciLCAiVCIsICJQIiwgIkUiLCAiWiIsICJZIl07CmZ1bmN0aW9uIGxvY2FsZV9kZWZhdWx0KGxvY2FsZTMpIHsKICB2YXIgZ3JvdXAgPSBsb2NhbGUzLmdyb3VwaW5nID09PSB2b2lkIDAgfHwgbG9jYWxlMy50aG91c2FuZHMgPT09IHZvaWQgMCA/IGlkZW50aXR5X2RlZmF1bHQgOiBmb3JtYXRHcm91cF9kZWZhdWx0KG1hcC5jYWxsKGxvY2FsZTMuZ3JvdXBpbmcsIE51bWJlciksIGxvY2FsZTMudGhvdXNhbmRzICsgIiIpLCBjdXJyZW5jeVByZWZpeCA9IGxvY2FsZTMuY3VycmVuY3kgPT09IHZvaWQgMCA/ICIiIDogbG9jYWxlMy5jdXJyZW5jeVswXSArICIiLCBjdXJyZW5jeVN1ZmZpeCA9IGxvY2FsZTMuY3VycmVuY3kgPT09IHZvaWQgMCA/ICIiIDogbG9jYWxlMy5jdXJyZW5jeVsxXSArICIiLCBkZWNpbWFsID0gbG9jYWxlMy5kZWNpbWFsID09PSB2b2lkIDAgPyAiLiIgOiBsb2NhbGUzLmRlY2ltYWwgKyAiIiwgbnVtZXJhbHMgPSBsb2NhbGUzLm51bWVyYWxzID09PSB2b2lkIDAgPyBpZGVudGl0eV9kZWZhdWx0IDogZm9ybWF0TnVtZXJhbHNfZGVmYXVsdChtYXAuY2FsbChsb2NhbGUzLm51bWVyYWxzLCBTdHJpbmcpKSwgcGVyY2VudCA9IGxvY2FsZTMucGVyY2VudCA9PT0gdm9pZCAwID8gIiUiIDogbG9jYWxlMy5wZXJjZW50ICsgIiIsIG1pbnVzID0gbG9jYWxlMy5taW51cyA9PT0gdm9pZCAwID8gIlx1MjIxMiIgOiBsb2NhbGUzLm1pbnVzICsgIiIsIG5hbiA9IGxvY2FsZTMubmFuID09PSB2b2lkIDAgPyAiTmFOIiA6IGxvY2FsZTMubmFuICsgIiI7CiAgZnVuY3Rpb24gbmV3Rm9ybWF0KHNwZWNpZmllcikgewogICAgc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcik7CiAgICB2YXIgZmlsbCA9IHNwZWNpZmllci5maWxsLCBhbGlnbiA9IHNwZWNpZmllci5hbGlnbiwgc2lnbjIgPSBzcGVjaWZpZXIuc2lnbiwgc3ltYm9sID0gc3BlY2lmaWVyLnN5bWJvbCwgemVybzMgPSBzcGVjaWZpZXIuemVybywgd2lkdGggPSBzcGVjaWZpZXIud2lkdGgsIGNvbW1hID0gc3BlY2lmaWVyLmNvbW1hLCBwcmVjaXNpb24gPSBzcGVjaWZpZXIucHJlY2lzaW9uLCB0cmltID0gc3BlY2lmaWVyLnRyaW0sIHR5cGUgPSBzcGVjaWZpZXIudHlwZTsKICAgIGlmICh0eXBlID09PSAibiIpIGNvbW1hID0gdHJ1ZSwgdHlwZSA9ICJnIjsKICAgIGVsc2UgaWYgKCFmb3JtYXRUeXBlc19kZWZhdWx0W3R5cGVdKSBwcmVjaXNpb24gPT09IHZvaWQgMCAmJiAocHJlY2lzaW9uID0gMTIpLCB0cmltID0gdHJ1ZSwgdHlwZSA9ICJnIjsKICAgIGlmICh6ZXJvMyB8fCBmaWxsID09PSAiMCIgJiYgYWxpZ24gPT09ICI9IikgemVybzMgPSB0cnVlLCBmaWxsID0gIjAiLCBhbGlnbiA9ICI9IjsKICAgIHZhciBwcmVmaXggPSBzeW1ib2wgPT09ICIkIiA/IGN1cnJlbmN5UHJlZml4IDogc3ltYm9sID09PSAiIyIgJiYgL1tib3hYXS8udGVzdCh0eXBlKSA/ICIwIiArIHR5cGUudG9Mb3dlckNhc2UoKSA6ICIiLCBzdWZmaXgyID0gc3ltYm9sID09PSAiJCIgPyBjdXJyZW5jeVN1ZmZpeCA6IC9bJXBdLy50ZXN0KHR5cGUpID8gcGVyY2VudCA6ICIiOwogICAgdmFyIGZvcm1hdFR5cGUgPSBmb3JtYXRUeXBlc19kZWZhdWx0W3R5cGVdLCBtYXliZVN1ZmZpeCA9IC9bZGVmZ3BycyVdLy50ZXN0KHR5cGUpOwogICAgcHJlY2lzaW9uID0gcHJlY2lzaW9uID09PSB2b2lkIDAgPyA2IDogL1tncHJzXS8udGVzdCh0eXBlKSA/IE1hdGgubWF4KDEsIE1hdGgubWluKDIxLCBwcmVjaXNpb24pKSA6IE1hdGgubWF4KDAsIE1hdGgubWluKDIwLCBwcmVjaXNpb24pKTsKICAgIGZ1bmN0aW9uIGZvcm1hdDIodmFsdWUpIHsKICAgICAgdmFyIHZhbHVlUHJlZml4ID0gcHJlZml4LCB2YWx1ZVN1ZmZpeCA9IHN1ZmZpeDIsIGksIG4sIGMyOwogICAgICBpZiAodHlwZSA9PT0gImMiKSB7CiAgICAgICAgdmFsdWVTdWZmaXggPSBmb3JtYXRUeXBlKHZhbHVlKSArIHZhbHVlU3VmZml4OwogICAgICAgIHZhbHVlID0gIiI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgPSArdmFsdWU7CiAgICAgICAgdmFyIHZhbHVlTmVnYXRpdmUgPSB2YWx1ZSA8IDAgfHwgMSAvIHZhbHVlIDwgMDsKICAgICAgICB2YWx1ZSA9IGlzTmFOKHZhbHVlKSA/IG5hbiA6IGZvcm1hdFR5cGUoTWF0aC5hYnModmFsdWUpLCBwcmVjaXNpb24pOwogICAgICAgIGlmICh0cmltKSB2YWx1ZSA9IGZvcm1hdFRyaW1fZGVmYXVsdCh2YWx1ZSk7CiAgICAgICAgaWYgKHZhbHVlTmVnYXRpdmUgJiYgK3ZhbHVlID09PSAwICYmIHNpZ24yICE9PSAiKyIpIHZhbHVlTmVnYXRpdmUgPSBmYWxzZTsKICAgICAgICB2YWx1ZVByZWZpeCA9ICh2YWx1ZU5lZ2F0aXZlID8gc2lnbjIgPT09ICIoIiA/IHNpZ24yIDogbWludXMgOiBzaWduMiA9PT0gIi0iIHx8IHNpZ24yID09PSAiKCIgPyAiIiA6IHNpZ24yKSArIHZhbHVlUHJlZml4OwogICAgICAgIHZhbHVlU3VmZml4ID0gKHR5cGUgPT09ICJzIiA/IHByZWZpeGVzWzggKyBwcmVmaXhFeHBvbmVudCAvIDNdIDogIiIpICsgdmFsdWVTdWZmaXggKyAodmFsdWVOZWdhdGl2ZSAmJiBzaWduMiA9PT0gIigiID8gIikiIDogIiIpOwogICAgICAgIGlmIChtYXliZVN1ZmZpeCkgewogICAgICAgICAgaSA9IC0xLCBuID0gdmFsdWUubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCsraSA8IG4pIHsKICAgICAgICAgICAgaWYgKGMyID0gdmFsdWUuY2hhckNvZGVBdChpKSwgNDggPiBjMiB8fCBjMiA+IDU3KSB7CiAgICAgICAgICAgICAgdmFsdWVTdWZmaXggPSAoYzIgPT09IDQ2ID8gZGVjaW1hbCArIHZhbHVlLnNsaWNlKGkgKyAxKSA6IHZhbHVlLnNsaWNlKGkpKSArIHZhbHVlU3VmZml4OwogICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMCwgaSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGNvbW1hICYmICF6ZXJvMykgdmFsdWUgPSBncm91cCh2YWx1ZSwgSW5maW5pdHkpOwogICAgICB2YXIgbGVuZ3RoID0gdmFsdWVQcmVmaXgubGVuZ3RoICsgdmFsdWUubGVuZ3RoICsgdmFsdWVTdWZmaXgubGVuZ3RoLCBwYWRkaW5nID0gbGVuZ3RoIDwgd2lkdGggPyBuZXcgQXJyYXkod2lkdGggLSBsZW5ndGggKyAxKS5qb2luKGZpbGwpIDogIiI7CiAgICAgIGlmIChjb21tYSAmJiB6ZXJvMykgdmFsdWUgPSBncm91cChwYWRkaW5nICsgdmFsdWUsIHBhZGRpbmcubGVuZ3RoID8gd2lkdGggLSB2YWx1ZVN1ZmZpeC5sZW5ndGggOiBJbmZpbml0eSksIHBhZGRpbmcgPSAiIjsKICAgICAgc3dpdGNoIChhbGlnbikgewogICAgICAgIGNhc2UgIjwiOgogICAgICAgICAgdmFsdWUgPSB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXggKyBwYWRkaW5nOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiPSI6CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlUHJlZml4ICsgcGFkZGluZyArIHZhbHVlICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJeIjoKICAgICAgICAgIHZhbHVlID0gcGFkZGluZy5zbGljZSgwLCBsZW5ndGggPSBwYWRkaW5nLmxlbmd0aCA+PiAxKSArIHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeCArIHBhZGRpbmcuc2xpY2UobGVuZ3RoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB2YWx1ZSA9IHBhZGRpbmcgKyB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgICByZXR1cm4gbnVtZXJhbHModmFsdWUpOwogICAgfQogICAgZm9ybWF0Mi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3BlY2lmaWVyICsgIiI7CiAgICB9OwogICAgcmV0dXJuIGZvcm1hdDI7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFByZWZpeDIoc3BlY2lmaWVyLCB2YWx1ZSkgewogICAgdmFyIGYgPSBuZXdGb3JtYXQoKHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpLCBzcGVjaWZpZXIudHlwZSA9ICJmIiwgc3BlY2lmaWVyKSksIGUgPSBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudF9kZWZhdWx0KHZhbHVlKSAvIDMpKSkgKiAzLCBrMiA9IE1hdGgucG93KDEwLCAtZSksIHByZWZpeCA9IHByZWZpeGVzWzggKyBlIC8gM107CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUyKSB7CiAgICAgIHJldHVybiBmKGsyICogdmFsdWUyKSArIHByZWZpeDsKICAgIH07CiAgfQogIHJldHVybiB7CiAgICBmb3JtYXQ6IG5ld0Zvcm1hdCwKICAgIGZvcm1hdFByZWZpeDogZm9ybWF0UHJlZml4MgogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2RlZmF1bHRMb2NhbGUuanMKdmFyIGxvY2FsZTsKdmFyIGZvcm1hdDsKdmFyIGZvcm1hdFByZWZpeDsKZGVmYXVsdExvY2FsZSh7CiAgdGhvdXNhbmRzOiAiLCIsCiAgZ3JvdXBpbmc6IFszXSwKICBjdXJyZW5jeTogWyIkIiwgIiJdCn0pOwpmdW5jdGlvbiBkZWZhdWx0TG9jYWxlKGRlZmluaXRpb24pIHsKICBsb2NhbGUgPSBsb2NhbGVfZGVmYXVsdChkZWZpbml0aW9uKTsKICBmb3JtYXQgPSBsb2NhbGUuZm9ybWF0OwogIGZvcm1hdFByZWZpeCA9IGxvY2FsZS5mb3JtYXRQcmVmaXg7CiAgcmV0dXJuIGxvY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvcHJlY2lzaW9uRml4ZWQuanMKZnVuY3Rpb24gcHJlY2lzaW9uRml4ZWRfZGVmYXVsdChzdGVwKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIC1leHBvbmVudF9kZWZhdWx0KE1hdGguYWJzKHN0ZXApKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvblByZWZpeC5qcwpmdW5jdGlvbiBwcmVjaXNpb25QcmVmaXhfZGVmYXVsdChzdGVwLCB2YWx1ZSkgewogIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudF9kZWZhdWx0KHZhbHVlKSAvIDMpKSkgKiAzIC0gZXhwb25lbnRfZGVmYXVsdChNYXRoLmFicyhzdGVwKSkpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9wcmVjaXNpb25Sb3VuZC5qcwpmdW5jdGlvbiBwcmVjaXNpb25Sb3VuZF9kZWZhdWx0KHN0ZXAsIG1heDIpIHsKICBzdGVwID0gTWF0aC5hYnMoc3RlcCksIG1heDIgPSBNYXRoLmFicyhtYXgyKSAtIHN0ZXA7CiAgcmV0dXJuIE1hdGgubWF4KDAsIGV4cG9uZW50X2RlZmF1bHQobWF4MikgLSBleHBvbmVudF9kZWZhdWx0KHN0ZXApKSArIDE7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGlja0Zvcm1hdC5qcwpmdW5jdGlvbiB0aWNrRm9ybWF0KHN0YXJ0LCBzdG9wLCBjb3VudCwgc3BlY2lmaWVyKSB7CiAgdmFyIHN0ZXAgPSB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpLCBwcmVjaXNpb247CiAgc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllciA9PSBudWxsID8gIixmIiA6IHNwZWNpZmllcik7CiAgc3dpdGNoIChzcGVjaWZpZXIudHlwZSkgewogICAgY2FzZSAicyI6IHsKICAgICAgdmFyIHZhbHVlID0gTWF0aC5tYXgoTWF0aC5hYnMoc3RhcnQpLCBNYXRoLmFicyhzdG9wKSk7CiAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvblByZWZpeF9kZWZhdWx0KHN0ZXAsIHZhbHVlKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb247CiAgICAgIHJldHVybiBmb3JtYXRQcmVmaXgoc3BlY2lmaWVyLCB2YWx1ZSk7CiAgICB9CiAgICBjYXNlICIiOgogICAgY2FzZSAiZSI6CiAgICBjYXNlICJnIjoKICAgIGNhc2UgInAiOgogICAgY2FzZSAiciI6IHsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uUm91bmRfZGVmYXVsdChzdGVwLCBNYXRoLm1heChNYXRoLmFicyhzdGFydCksIE1hdGguYWJzKHN0b3ApKSkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uIC0gKHNwZWNpZmllci50eXBlID09PSAiZSIpOwogICAgICBicmVhazsKICAgIH0KICAgIGNhc2UgImYiOgogICAgY2FzZSAiJSI6IHsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uRml4ZWRfZGVmYXVsdChzdGVwKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb24gLSAoc3BlY2lmaWVyLnR5cGUgPT09ICIlIikgKiAyOwogICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIGZvcm1hdChzcGVjaWZpZXIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2xpbmVhci5qcwpmdW5jdGlvbiBsaW5lYXJpc2goc2NhbGUpIHsKICB2YXIgZG9tYWluID0gc2NhbGUuZG9tYWluOwogIHNjYWxlLnRpY2tzID0gZnVuY3Rpb24oY291bnQpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja3MoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBjb3VudCA9PSBudWxsID8gMTAgOiBjb3VudCk7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gZnVuY3Rpb24oY291bnQsIHNwZWNpZmllcikgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHJldHVybiB0aWNrRm9ybWF0KGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgY291bnQgPT0gbnVsbCA/IDEwIDogY291bnQsIHNwZWNpZmllcik7CiAgfTsKICBzY2FsZS5uaWNlID0gZnVuY3Rpb24oY291bnQpIHsKICAgIGlmIChjb3VudCA9PSBudWxsKSBjb3VudCA9IDEwOwogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHZhciBpMCA9IDA7CiAgICB2YXIgaTEgPSBkLmxlbmd0aCAtIDE7CiAgICB2YXIgc3RhcnQgPSBkW2kwXTsKICAgIHZhciBzdG9wID0gZFtpMV07CiAgICB2YXIgcHJlc3RlcDsKICAgIHZhciBzdGVwOwogICAgdmFyIG1heEl0ZXIgPSAxMDsKICAgIGlmIChzdG9wIDwgc3RhcnQpIHsKICAgICAgc3RlcCA9IHN0YXJ0LCBzdGFydCA9IHN0b3AsIHN0b3AgPSBzdGVwOwogICAgICBzdGVwID0gaTAsIGkwID0gaTEsIGkxID0gc3RlcDsKICAgIH0KICAgIHdoaWxlIChtYXhJdGVyLS0gPiAwKSB7CiAgICAgIHN0ZXAgPSB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgICAgIGlmIChzdGVwID09PSBwcmVzdGVwKSB7CiAgICAgICAgZFtpMF0gPSBzdGFydDsKICAgICAgICBkW2kxXSA9IHN0b3A7CiAgICAgICAgcmV0dXJuIGRvbWFpbihkKTsKICAgICAgfSBlbHNlIGlmIChzdGVwID4gMCkgewogICAgICAgIHN0YXJ0ID0gTWF0aC5mbG9vcihzdGFydCAvIHN0ZXApICogc3RlcDsKICAgICAgICBzdG9wID0gTWF0aC5jZWlsKHN0b3AgLyBzdGVwKSAqIHN0ZXA7CiAgICAgIH0gZWxzZSBpZiAoc3RlcCA8IDApIHsKICAgICAgICBzdGFydCA9IE1hdGguY2VpbChzdGFydCAqIHN0ZXApIC8gc3RlcDsKICAgICAgICBzdG9wID0gTWF0aC5mbG9vcihzdG9wICogc3RlcCkgLyBzdGVwOwogICAgICB9IGVsc2UgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHByZXN0ZXAgPSBzdGVwOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIGxpbmVhcjIoKSB7CiAgdmFyIHNjYWxlID0gY29udGludW91cygpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBsaW5lYXIyKCkpOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2lkZW50aXR5LmpzCmZ1bmN0aW9uIGlkZW50aXR5Mihkb21haW4pIHsKICB2YXIgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgfHwgaXNOYU4oeDIgPSAreDIpID8gdW5rbm93biA6IHgyOwogIH0KICBzY2FsZS5pbnZlcnQgPSBzY2FsZTsKICBzY2FsZS5kb21haW4gPSBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbiA9IEFycmF5LmZyb20oXywgbnVtYmVyMiksIHNjYWxlKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGlkZW50aXR5Mihkb21haW4pLnVua25vd24odW5rbm93bik7CiAgfTsKICBkb21haW4gPSBhcmd1bWVudHMubGVuZ3RoID8gQXJyYXkuZnJvbShkb21haW4sIG51bWJlcjIpIDogWzAsIDFdOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL25pY2UuanMKZnVuY3Rpb24gbmljZShkb21haW4sIGludGVydmFsKSB7CiAgZG9tYWluID0gZG9tYWluLnNsaWNlKCk7CiAgdmFyIGkwID0gMCwgaTEgPSBkb21haW4ubGVuZ3RoIC0gMSwgeDAgPSBkb21haW5baTBdLCB4MSA9IGRvbWFpbltpMV0sIHQ7CiAgaWYgKHgxIDwgeDApIHsKICAgIHQgPSBpMCwgaTAgPSBpMSwgaTEgPSB0OwogICAgdCA9IHgwLCB4MCA9IHgxLCB4MSA9IHQ7CiAgfQogIGRvbWFpbltpMF0gPSBpbnRlcnZhbC5mbG9vcih4MCk7CiAgZG9tYWluW2kxXSA9IGludGVydmFsLmNlaWwoeDEpOwogIHJldHVybiBkb21haW47Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbG9nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybUxvZyh4MikgewogIHJldHVybiBNYXRoLmxvZyh4Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtRXhwKHgyKSB7CiAgcmV0dXJuIE1hdGguZXhwKHgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1Mb2duKHgyKSB7CiAgcmV0dXJuIC1NYXRoLmxvZygteDIpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUV4cG4oeDIpIHsKICByZXR1cm4gLU1hdGguZXhwKC14Mik7Cn0KZnVuY3Rpb24gcG93MTAoeDIpIHsKICByZXR1cm4gaXNGaW5pdGUoeDIpID8gKygiMWUiICsgeDIpIDogeDIgPCAwID8gMCA6IHgyOwp9CmZ1bmN0aW9uIHBvd3AoYmFzZSkgewogIHJldHVybiBiYXNlID09PSAxMCA/IHBvdzEwIDogYmFzZSA9PT0gTWF0aC5FID8gTWF0aC5leHAgOiAoeDIpID0+IE1hdGgucG93KGJhc2UsIHgyKTsKfQpmdW5jdGlvbiBsb2dwKGJhc2UpIHsKICByZXR1cm4gYmFzZSA9PT0gTWF0aC5FID8gTWF0aC5sb2cgOiBiYXNlID09PSAxMCAmJiBNYXRoLmxvZzEwIHx8IGJhc2UgPT09IDIgJiYgTWF0aC5sb2cyIHx8IChiYXNlID0gTWF0aC5sb2coYmFzZSksICh4MikgPT4gTWF0aC5sb2coeDIpIC8gYmFzZSk7Cn0KZnVuY3Rpb24gcmVmbGVjdChmKSB7CiAgcmV0dXJuICh4MiwgazIpID0+IC1mKC14MiwgazIpOwp9CmZ1bmN0aW9uIGxvZ2dpc2godHJhbnNmb3JtKSB7CiAgY29uc3Qgc2NhbGUgPSB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nLCB0cmFuc2Zvcm1FeHApOwogIGNvbnN0IGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICBsZXQgYmFzZSA9IDEwOwogIGxldCBsb2dzOwogIGxldCBwb3dzOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICBsb2dzID0gbG9ncChiYXNlKSwgcG93cyA9IHBvd3AoYmFzZSk7CiAgICBpZiAoZG9tYWluKClbMF0gPCAwKSB7CiAgICAgIGxvZ3MgPSByZWZsZWN0KGxvZ3MpLCBwb3dzID0gcmVmbGVjdChwb3dzKTsKICAgICAgdHJhbnNmb3JtKHRyYW5zZm9ybUxvZ24sIHRyYW5zZm9ybUV4cG4pOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNmb3JtKHRyYW5zZm9ybUxvZywgdHJhbnNmb3JtRXhwKTsKICAgIH0KICAgIHJldHVybiBzY2FsZTsKICB9CiAgc2NhbGUuYmFzZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGJhc2UgPSArXywgcmVzY2FsZSgpKSA6IGJhc2U7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4oXyksIHJlc2NhbGUoKSkgOiBkb21haW4oKTsKICB9OwogIHNjYWxlLnRpY2tzID0gKGNvdW50KSA9PiB7CiAgICBjb25zdCBkID0gZG9tYWluKCk7CiAgICBsZXQgdSA9IGRbMF07CiAgICBsZXQgdiA9IGRbZC5sZW5ndGggLSAxXTsKICAgIGNvbnN0IHIyID0gdiA8IHU7CiAgICBpZiAocjIpIFt1LCB2XSA9IFt2LCB1XTsKICAgIGxldCBpID0gbG9ncyh1KTsKICAgIGxldCBqID0gbG9ncyh2KTsKICAgIGxldCBrMjsKICAgIGxldCB0OwogICAgY29uc3QgbiA9IGNvdW50ID09IG51bGwgPyAxMCA6ICtjb3VudDsKICAgIGxldCB6ID0gW107CiAgICBpZiAoIShiYXNlICUgMSkgJiYgaiAtIGkgPCBuKSB7CiAgICAgIGkgPSBNYXRoLmZsb29yKGkpLCBqID0gTWF0aC5jZWlsKGopOwogICAgICBpZiAodSA+IDApIGZvciAoOyBpIDw9IGo7ICsraSkgewogICAgICAgIGZvciAoazIgPSAxOyBrMiA8IGJhc2U7ICsrazIpIHsKICAgICAgICAgIHQgPSBpIDwgMCA/IGsyIC8gcG93cygtaSkgOiBrMiAqIHBvd3MoaSk7CiAgICAgICAgICBpZiAodCA8IHUpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHQgPiB2KSBicmVhazsKICAgICAgICAgIHoucHVzaCh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSBmb3IgKDsgaSA8PSBqOyArK2kpIHsKICAgICAgICBmb3IgKGsyID0gYmFzZSAtIDE7IGsyID49IDE7IC0tazIpIHsKICAgICAgICAgIHQgPSBpID4gMCA/IGsyIC8gcG93cygtaSkgOiBrMiAqIHBvd3MoaSk7CiAgICAgICAgICBpZiAodCA8IHUpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHQgPiB2KSBicmVhazsKICAgICAgICAgIHoucHVzaCh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHoubGVuZ3RoICogMiA8IG4pIHogPSB0aWNrcyh1LCB2LCBuKTsKICAgIH0gZWxzZSB7CiAgICAgIHogPSB0aWNrcyhpLCBqLCBNYXRoLm1pbihqIC0gaSwgbikpLm1hcChwb3dzKTsKICAgIH0KICAgIHJldHVybiByMiA/IHoucmV2ZXJzZSgpIDogejsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSAoY291bnQsIHNwZWNpZmllcikgPT4gewogICAgaWYgKGNvdW50ID09IG51bGwpIGNvdW50ID0gMTA7CiAgICBpZiAoc3BlY2lmaWVyID09IG51bGwpIHNwZWNpZmllciA9IGJhc2UgPT09IDEwID8gInMiIDogIiwiOwogICAgaWYgKHR5cGVvZiBzcGVjaWZpZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCEoYmFzZSAlIDEpICYmIChzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSkucHJlY2lzaW9uID09IG51bGwpIHNwZWNpZmllci50cmltID0gdHJ1ZTsKICAgICAgc3BlY2lmaWVyID0gZm9ybWF0KHNwZWNpZmllcik7CiAgICB9CiAgICBpZiAoY291bnQgPT09IEluZmluaXR5KSByZXR1cm4gc3BlY2lmaWVyOwogICAgY29uc3QgazIgPSBNYXRoLm1heCgxLCBiYXNlICogY291bnQgLyBzY2FsZS50aWNrcygpLmxlbmd0aCk7CiAgICByZXR1cm4gKGQpID0+IHsKICAgICAgbGV0IGkgPSBkIC8gcG93cyhNYXRoLnJvdW5kKGxvZ3MoZCkpKTsKICAgICAgaWYgKGkgKiBiYXNlIDwgYmFzZSAtIDAuNSkgaSAqPSBiYXNlOwogICAgICByZXR1cm4gaSA8PSBrMiA/IHNwZWNpZmllcihkKSA6ICIiOwogICAgfTsKICB9OwogIHNjYWxlLm5pY2UgPSAoKSA9PiB7CiAgICByZXR1cm4gZG9tYWluKG5pY2UoZG9tYWluKCksIHsKICAgICAgZmxvb3I6ICh4MikgPT4gcG93cyhNYXRoLmZsb29yKGxvZ3MoeDIpKSksCiAgICAgIGNlaWw6ICh4MikgPT4gcG93cyhNYXRoLmNlaWwobG9ncyh4MikpKQogICAgfSkpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIGxvZygpIHsKICBjb25zdCBzY2FsZSA9IGxvZ2dpc2godHJhbnNmb3JtZXIoKSkuZG9tYWluKFsxLCAxMF0pOwogIHNjYWxlLmNvcHkgPSAoKSA9PiBjb3B5KHNjYWxlLCBsb2coKSkuYmFzZShzY2FsZS5iYXNlKCkpOwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gc2NhbGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvc3ltbG9nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybVN5bWxvZyhjMikgewogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIE1hdGguc2lnbih4MikgKiBNYXRoLmxvZzFwKE1hdGguYWJzKHgyIC8gYzIpKTsKICB9Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybVN5bWV4cChjMikgewogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIE1hdGguc2lnbih4MikgKiBNYXRoLmV4cG0xKE1hdGguYWJzKHgyKSkgKiBjMjsKICB9Owp9CmZ1bmN0aW9uIHN5bWxvZ2lzaCh0cmFuc2Zvcm0pIHsKICB2YXIgYzIgPSAxLCBzY2FsZSA9IHRyYW5zZm9ybSh0cmFuc2Zvcm1TeW1sb2coYzIpLCB0cmFuc2Zvcm1TeW1leHAoYzIpKTsKICBzY2FsZS5jb25zdGFudCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gdHJhbnNmb3JtKHRyYW5zZm9ybVN5bWxvZyhjMiA9ICtfKSwgdHJhbnNmb3JtU3ltZXhwKGMyKSkgOiBjMjsKICB9OwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CmZ1bmN0aW9uIHN5bWxvZygpIHsKICB2YXIgc2NhbGUgPSBzeW1sb2dpc2godHJhbnNmb3JtZXIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIHN5bWxvZygpKS5jb25zdGFudChzY2FsZS5jb25zdGFudCgpKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcG93LmpzCmZ1bmN0aW9uIHRyYW5zZm9ybVBvdyhleHBvbmVudCkgewogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIHgyIDwgMCA/IC1NYXRoLnBvdygteDIsIGV4cG9uZW50KSA6IE1hdGgucG93KHgyLCBleHBvbmVudCk7CiAgfTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1TcXJ0KHgyKSB7CiAgcmV0dXJuIHgyIDwgMCA/IC1NYXRoLnNxcnQoLXgyKSA6IE1hdGguc3FydCh4Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtU3F1YXJlKHgyKSB7CiAgcmV0dXJuIHgyIDwgMCA/IC14MiAqIHgyIDogeDIgKiB4MjsKfQpmdW5jdGlvbiBwb3dpc2godHJhbnNmb3JtKSB7CiAgdmFyIHNjYWxlID0gdHJhbnNmb3JtKGlkZW50aXR5LCBpZGVudGl0eSksIGV4cG9uZW50ID0gMTsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgcmV0dXJuIGV4cG9uZW50ID09PSAxID8gdHJhbnNmb3JtKGlkZW50aXR5LCBpZGVudGl0eSkgOiBleHBvbmVudCA9PT0gMC41ID8gdHJhbnNmb3JtKHRyYW5zZm9ybVNxcnQsIHRyYW5zZm9ybVNxdWFyZSkgOiB0cmFuc2Zvcm0odHJhbnNmb3JtUG93KGV4cG9uZW50KSwgdHJhbnNmb3JtUG93KDEgLyBleHBvbmVudCkpOwogIH0KICBzY2FsZS5leHBvbmVudCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGV4cG9uZW50ID0gK18sIHJlc2NhbGUoKSkgOiBleHBvbmVudDsKICB9OwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CmZ1bmN0aW9uIHBvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIHBvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gc3FydDIoKSB7CiAgcmV0dXJuIHBvdy5hcHBseShudWxsLCBhcmd1bWVudHMpLmV4cG9uZW50KDAuNSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcmFkaWFsLmpzCmZ1bmN0aW9uIHNxdWFyZSh4MikgewogIHJldHVybiBNYXRoLnNpZ24oeDIpICogeDIgKiB4MjsKfQpmdW5jdGlvbiB1bnNxdWFyZSh4MikgewogIHJldHVybiBNYXRoLnNpZ24oeDIpICogTWF0aC5zcXJ0KE1hdGguYWJzKHgyKSk7Cn0KZnVuY3Rpb24gcmFkaWFsKCkgewogIHZhciBzcXVhcmVkID0gY29udGludW91cygpLCByYW5nZTQgPSBbMCwgMV0sIHJvdW5kID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHZhciB5MiA9IHVuc3F1YXJlKHNxdWFyZWQoeDIpKTsKICAgIHJldHVybiBpc05hTih5MikgPyB1bmtub3duIDogcm91bmQgPyBNYXRoLnJvdW5kKHkyKSA6IHkyOwogIH0KICBzY2FsZS5pbnZlcnQgPSBmdW5jdGlvbih5MikgewogICAgcmV0dXJuIHNxdWFyZWQuaW52ZXJ0KHNxdWFyZSh5MikpOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5kb21haW4oXyksIHNjYWxlKSA6IHNxdWFyZWQuZG9tYWluKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHNxdWFyZWQucmFuZ2UoKHJhbmdlNCA9IEFycmF5LmZyb20oXywgbnVtYmVyMikpLm1hcChzcXVhcmUpKSwgc2NhbGUpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIHNjYWxlLnJhbmdlKF8pLnJvdW5kKHRydWUpOwogIH07CiAgc2NhbGUucm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyb3VuZCA9ICEhXywgc2NhbGUpIDogcm91bmQ7CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHNxdWFyZWQuY2xhbXAoXyksIHNjYWxlKSA6IHNxdWFyZWQuY2xhbXAoKTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiByYWRpYWwoc3F1YXJlZC5kb21haW4oKSwgcmFuZ2U0KS5yb3VuZChyb3VuZCkuY2xhbXAoc3F1YXJlZC5jbGFtcCgpKS51bmtub3duKHVua25vd24pOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3F1YW50aWxlLmpzCmZ1bmN0aW9uIHF1YW50aWxlMigpIHsKICB2YXIgZG9tYWluID0gW10sIHJhbmdlNCA9IFtdLCB0aHJlc2hvbGRzID0gW10sIHVua25vd247CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBpID0gMCwgbiA9IE1hdGgubWF4KDEsIHJhbmdlNC5sZW5ndGgpOwogICAgdGhyZXNob2xkcyA9IG5ldyBBcnJheShuIC0gMSk7CiAgICB3aGlsZSAoKytpIDwgbikgdGhyZXNob2xkc1tpIC0gMV0gPSBxdWFudGlsZVNvcnRlZChkb21haW4sIGkgLyBuKTsKICAgIHJldHVybiBzY2FsZTsKICB9CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiByYW5nZTRbYmlzZWN0X2RlZmF1bHQodGhyZXNob2xkcywgeDIpXTsKICB9CiAgc2NhbGUuaW52ZXJ0RXh0ZW50ID0gZnVuY3Rpb24oeTIpIHsKICAgIHZhciBpID0gcmFuZ2U0LmluZGV4T2YoeTIpOwogICAgcmV0dXJuIGkgPCAwID8gW05hTiwgTmFOXSA6IFsKICAgICAgaSA+IDAgPyB0aHJlc2hvbGRzW2kgLSAxXSA6IGRvbWFpblswXSwKICAgICAgaSA8IHRocmVzaG9sZHMubGVuZ3RoID8gdGhyZXNob2xkc1tpXSA6IGRvbWFpbltkb21haW4ubGVuZ3RoIC0gMV0KICAgIF07CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdOwogICAgZm9yIChsZXQgZCBvZiBfKSBpZiAoZCAhPSBudWxsICYmICFpc05hTihkID0gK2QpKSBkb21haW4ucHVzaChkKTsKICAgIGRvbWFpbi5zb3J0KGFzY2VuZGluZyk7CiAgICByZXR1cm4gcmVzY2FsZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5xdWFudGlsZXMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aHJlc2hvbGRzLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcXVhbnRpbGUyKCkuZG9tYWluKGRvbWFpbikucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9xdWFudGl6ZS5qcwpmdW5jdGlvbiBxdWFudGl6ZSgpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDEsIG4gPSAxLCBkb21haW4gPSBbMC41XSwgcmFuZ2U0ID0gWzAsIDFdLCB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgIT0gbnVsbCAmJiB4MiA8PSB4MiA/IHJhbmdlNFtiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAwLCBuKV0gOiB1bmtub3duOwogIH0KICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIGkgPSAtMTsKICAgIGRvbWFpbiA9IG5ldyBBcnJheShuKTsKICAgIHdoaWxlICgrK2kgPCBuKSBkb21haW5baV0gPSAoKGkgKyAxKSAqIHgxIC0gKGkgLSBuKSAqIHgwKSAvIChuICsgMSk7CiAgICByZXR1cm4gc2NhbGU7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFt4MCwgeDFdID0gXywgeDAgPSAreDAsIHgxID0gK3gxLCByZXNjYWxlKCkpIDogW3gwLCB4MV07CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKG4gPSAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSkubGVuZ3RoIC0gMSwgcmVzY2FsZSgpKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUuaW52ZXJ0RXh0ZW50ID0gZnVuY3Rpb24oeTIpIHsKICAgIHZhciBpID0gcmFuZ2U0LmluZGV4T2YoeTIpOwogICAgcmV0dXJuIGkgPCAwID8gW05hTiwgTmFOXSA6IGkgPCAxID8gW3gwLCBkb21haW5bMF1dIDogaSA+PSBuID8gW2RvbWFpbltuIC0gMV0sIHgxXSA6IFtkb21haW5baSAtIDFdLCBkb21haW5baV1dOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiBzY2FsZTsKICB9OwogIHNjYWxlLnRocmVzaG9sZHMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBkb21haW4uc2xpY2UoKTsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBxdWFudGl6ZSgpLmRvbWFpbihbeDAsIHgxXSkucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShsaW5lYXJpc2goc2NhbGUpLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3RocmVzaG9sZC5qcwpmdW5jdGlvbiB0aHJlc2hvbGQoKSB7CiAgdmFyIGRvbWFpbiA9IFswLjVdLCByYW5nZTQgPSBbMCwgMV0sIHVua25vd24sIG4gPSAxOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgIT0gbnVsbCAmJiB4MiA8PSB4MiA/IHJhbmdlNFtiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAwLCBuKV0gOiB1bmtub3duOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4gPSBBcnJheS5mcm9tKF8pLCBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCAtIDEpLCBzY2FsZSkgOiBkb21haW4uc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgbiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlNC5sZW5ndGggLSAxKSwgc2NhbGUpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5pbnZlcnRFeHRlbnQgPSBmdW5jdGlvbih5MikgewogICAgdmFyIGkgPSByYW5nZTQuaW5kZXhPZih5Mik7CiAgICByZXR1cm4gW2RvbWFpbltpIC0gMV0sIGRvbWFpbltpXV07CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhyZXNob2xkKCkuZG9tYWluKGRvbWFpbikucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2ludGVydmFsLmpzCnZhciB0MCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwp2YXIgdDEgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKZnVuY3Rpb24gdGltZUludGVydmFsKGZsb29yaSwgb2Zmc2V0aSwgY291bnQsIGZpZWxkKSB7CiAgZnVuY3Rpb24gaW50ZXJ2YWwoZGF0ZTIpIHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTIgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwID8gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkgOiAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKSksIGRhdGUyOwogIH0KICBpbnRlcnZhbC5mbG9vciA9IChkYXRlMikgPT4gewogICAgcmV0dXJuIGZsb29yaShkYXRlMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTIpKSwgZGF0ZTI7CiAgfTsKICBpbnRlcnZhbC5jZWlsID0gKGRhdGUyKSA9PiB7CiAgICByZXR1cm4gZmxvb3JpKGRhdGUyID0gbmV3IERhdGUoZGF0ZTIgLSAxKSksIG9mZnNldGkoZGF0ZTIsIDEpLCBmbG9vcmkoZGF0ZTIpLCBkYXRlMjsKICB9OwogIGludGVydmFsLnJvdW5kID0gKGRhdGUyKSA9PiB7CiAgICBjb25zdCBkMCA9IGludGVydmFsKGRhdGUyKSwgZDEgPSBpbnRlcnZhbC5jZWlsKGRhdGUyKTsKICAgIHJldHVybiBkYXRlMiAtIGQwIDwgZDEgLSBkYXRlMiA/IGQwIDogZDE7CiAgfTsKICBpbnRlcnZhbC5vZmZzZXQgPSAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIHJldHVybiBvZmZzZXRpKGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMiksIHN0ZXAgPT0gbnVsbCA/IDEgOiBNYXRoLmZsb29yKHN0ZXApKSwgZGF0ZTI7CiAgfTsKICBpbnRlcnZhbC5yYW5nZSA9IChzdGFydCwgc3RvcCwgc3RlcCkgPT4gewogICAgY29uc3QgcmFuZ2U0ID0gW107CiAgICBzdGFydCA9IGludGVydmFsLmNlaWwoc3RhcnQpOwogICAgc3RlcCA9IHN0ZXAgPT0gbnVsbCA/IDEgOiBNYXRoLmZsb29yKHN0ZXApOwogICAgaWYgKCEoc3RhcnQgPCBzdG9wKSB8fCAhKHN0ZXAgPiAwKSkgcmV0dXJuIHJhbmdlNDsKICAgIGxldCBwcmV2aW91czsKICAgIGRvCiAgICAgIHJhbmdlNC5wdXNoKHByZXZpb3VzID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtzdGFydCkpLCBvZmZzZXRpKHN0YXJ0LCBzdGVwKSwgZmxvb3JpKHN0YXJ0KTsKICAgIHdoaWxlIChwcmV2aW91cyA8IHN0YXJ0ICYmIHN0YXJ0IDwgc3RvcCk7CiAgICByZXR1cm4gcmFuZ2U0OwogIH07CiAgaW50ZXJ2YWwuZmlsdGVyID0gKHRlc3QpID0+IHsKICAgIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICAgIGlmIChkYXRlMiA+PSBkYXRlMikgd2hpbGUgKGZsb29yaShkYXRlMiksICF0ZXN0KGRhdGUyKSkgZGF0ZTIuc2V0VGltZShkYXRlMiAtIDEpOwogICAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICAgIGlmIChkYXRlMiA+PSBkYXRlMikgewogICAgICAgIGlmIChzdGVwIDwgMCkgd2hpbGUgKCsrc3RlcCA8PSAwKSB7CiAgICAgICAgICB3aGlsZSAob2Zmc2V0aShkYXRlMiwgLTEpLCAhdGVzdChkYXRlMikpIHsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB3aGlsZSAoLS1zdGVwID49IDApIHsKICAgICAgICAgIHdoaWxlIChvZmZzZXRpKGRhdGUyLCAxKSwgIXRlc3QoZGF0ZTIpKSB7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9OwogIGlmIChjb3VudCkgewogICAgaW50ZXJ2YWwuY291bnQgPSAoc3RhcnQsIGVuZCkgPT4gewogICAgICB0MC5zZXRUaW1lKCtzdGFydCksIHQxLnNldFRpbWUoK2VuZCk7CiAgICAgIGZsb29yaSh0MCksIGZsb29yaSh0MSk7CiAgICAgIHJldHVybiBNYXRoLmZsb29yKGNvdW50KHQwLCB0MSkpOwogICAgfTsKICAgIGludGVydmFsLmV2ZXJ5ID0gKHN0ZXApID0+IHsKICAgICAgc3RlcCA9IE1hdGguZmxvb3Ioc3RlcCk7CiAgICAgIHJldHVybiAhaXNGaW5pdGUoc3RlcCkgfHwgIShzdGVwID4gMCkgPyBudWxsIDogIShzdGVwID4gMSkgPyBpbnRlcnZhbCA6IGludGVydmFsLmZpbHRlcihmaWVsZCA/IChkKSA9PiBmaWVsZChkKSAlIHN0ZXAgPT09IDAgOiAoZCkgPT4gaW50ZXJ2YWwuY291bnQoMCwgZCkgJSBzdGVwID09PSAwKTsKICAgIH07CiAgfQogIHJldHVybiBpbnRlcnZhbDsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21pbGxpc2Vjb25kLmpzCnZhciBtaWxsaXNlY29uZCA9IHRpbWVJbnRlcnZhbCgoKSA9PiB7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZCAtIHN0YXJ0Owp9KTsKbWlsbGlzZWNvbmQuZXZlcnkgPSAoazIpID0+IHsKICBrMiA9IE1hdGguZmxvb3IoazIpOwogIGlmICghaXNGaW5pdGUoazIpIHx8ICEoazIgPiAwKSkgcmV0dXJuIG51bGw7CiAgaWYgKCEoazIgPiAxKSkgcmV0dXJuIG1pbGxpc2Vjb25kOwogIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRUaW1lKE1hdGguZmxvb3IoZGF0ZTIgLyBrMikgKiBrMik7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBrMik7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gazI7CiAgfSk7Cn07CnZhciBtaWxsaXNlY29uZHMgPSBtaWxsaXNlY29uZC5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9kdXJhdGlvbi5qcwp2YXIgZHVyYXRpb25TZWNvbmQgPSAxZTM7CnZhciBkdXJhdGlvbk1pbnV0ZSA9IGR1cmF0aW9uU2Vjb25kICogNjA7CnZhciBkdXJhdGlvbkhvdXIgPSBkdXJhdGlvbk1pbnV0ZSAqIDYwOwp2YXIgZHVyYXRpb25EYXkgPSBkdXJhdGlvbkhvdXIgKiAyNDsKdmFyIGR1cmF0aW9uV2VlayA9IGR1cmF0aW9uRGF5ICogNzsKdmFyIGR1cmF0aW9uTW9udGggPSBkdXJhdGlvbkRheSAqIDMwOwp2YXIgZHVyYXRpb25ZZWFyID0gZHVyYXRpb25EYXkgKiAzNjU7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvc2Vjb25kLmpzCnZhciBzZWNvbmQgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VGltZShkYXRlMiAtIGRhdGUyLmdldE1pbGxpc2Vjb25kcygpKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25TZWNvbmQpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25TZWNvbmQ7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENTZWNvbmRzKCk7Cn0pOwp2YXIgc2Vjb25kcyA9IHNlY29uZC5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9taW51dGUuanMKdmFyIHRpbWVNaW51dGUgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VGltZShkYXRlMiAtIGRhdGUyLmdldE1pbGxpc2Vjb25kcygpIC0gZGF0ZTIuZ2V0U2Vjb25kcygpICogZHVyYXRpb25TZWNvbmQpOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbk1pbnV0ZSk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbk1pbnV0ZTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldE1pbnV0ZXMoKTsKfSk7CnZhciB0aW1lTWludXRlcyA9IHRpbWVNaW51dGUucmFuZ2U7CnZhciB1dGNNaW51dGUgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDU2Vjb25kcygwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25NaW51dGUpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25NaW51dGU7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENNaW51dGVzKCk7Cn0pOwp2YXIgdXRjTWludXRlcyA9IHV0Y01pbnV0ZS5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9ob3VyLmpzCnZhciB0aW1lSG91ciA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gZGF0ZTIuZ2V0TWlsbGlzZWNvbmRzKCkgLSBkYXRlMi5nZXRTZWNvbmRzKCkgKiBkdXJhdGlvblNlY29uZCAtIGRhdGUyLmdldE1pbnV0ZXMoKSAqIGR1cmF0aW9uTWludXRlKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25Ib3VyKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uSG91cjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldEhvdXJzKCk7Cn0pOwp2YXIgdGltZUhvdXJzID0gdGltZUhvdXIucmFuZ2U7CnZhciB1dGNIb3VyID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ01pbnV0ZXMoMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uSG91cik7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkhvdXI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENIb3VycygpOwp9KTsKdmFyIHV0Y0hvdXJzID0gdXRjSG91ci5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9kYXkuanMKdmFyIHRpbWVEYXkgPSB0aW1lSW50ZXJ2YWwoCiAgKGRhdGUyKSA9PiBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKSwKICAoZGF0ZTIsIHN0ZXApID0+IGRhdGUyLnNldERhdGUoZGF0ZTIuZ2V0RGF0ZSgpICsgc3RlcCksCiAgKHN0YXJ0LCBlbmQpID0+IChlbmQgLSBzdGFydCAtIChlbmQuZ2V0VGltZXpvbmVPZmZzZXQoKSAtIHN0YXJ0LmdldFRpbWV6b25lT2Zmc2V0KCkpICogZHVyYXRpb25NaW51dGUpIC8gZHVyYXRpb25EYXksCiAgKGRhdGUyKSA9PiBkYXRlMi5nZXREYXRlKCkgLSAxCik7CnZhciB0aW1lRGF5cyA9IHRpbWVEYXkucmFuZ2U7CnZhciB1dGNEYXkgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ0RhdGUoZGF0ZTIuZ2V0VVRDRGF0ZSgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkRheTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ0RhdGUoKSAtIDE7Cn0pOwp2YXIgdXRjRGF5cyA9IHV0Y0RheS5yYW5nZTsKdmFyIHVuaXhEYXkgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ0RhdGUoZGF0ZTIuZ2V0VVRDRGF0ZSgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkRheTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIE1hdGguZmxvb3IoZGF0ZTIgLyBkdXJhdGlvbkRheSk7Cn0pOwp2YXIgdW5peERheXMgPSB1bml4RGF5LnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3dlZWsuanMKZnVuY3Rpb24gdGltZVdlZWtkYXkoaSkgewogIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXREYXRlKGRhdGUyLmdldERhdGUoKSAtIChkYXRlMi5nZXREYXkoKSArIDcgLSBpKSAlIDcpOwogICAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXREYXRlKGRhdGUyLmdldERhdGUoKSArIHN0ZXAgKiA3KTsKICB9LCAoc3RhcnQsIGVuZCkgPT4gewogICAgcmV0dXJuIChlbmQgLSBzdGFydCAtIChlbmQuZ2V0VGltZXpvbmVPZmZzZXQoKSAtIHN0YXJ0LmdldFRpbWV6b25lT2Zmc2V0KCkpICogZHVyYXRpb25NaW51dGUpIC8gZHVyYXRpb25XZWVrOwogIH0pOwp9CnZhciB0aW1lU3VuZGF5ID0gdGltZVdlZWtkYXkoMCk7CnZhciB0aW1lTW9uZGF5ID0gdGltZVdlZWtkYXkoMSk7CnZhciB0aW1lVHVlc2RheSA9IHRpbWVXZWVrZGF5KDIpOwp2YXIgdGltZVdlZG5lc2RheSA9IHRpbWVXZWVrZGF5KDMpOwp2YXIgdGltZVRodXJzZGF5ID0gdGltZVdlZWtkYXkoNCk7CnZhciB0aW1lRnJpZGF5ID0gdGltZVdlZWtkYXkoNSk7CnZhciB0aW1lU2F0dXJkYXkgPSB0aW1lV2Vla2RheSg2KTsKdmFyIHRpbWVTdW5kYXlzID0gdGltZVN1bmRheS5yYW5nZTsKdmFyIHRpbWVNb25kYXlzID0gdGltZU1vbmRheS5yYW5nZTsKdmFyIHRpbWVUdWVzZGF5cyA9IHRpbWVUdWVzZGF5LnJhbmdlOwp2YXIgdGltZVdlZG5lc2RheXMgPSB0aW1lV2VkbmVzZGF5LnJhbmdlOwp2YXIgdGltZVRodXJzZGF5cyA9IHRpbWVUaHVyc2RheS5yYW5nZTsKdmFyIHRpbWVGcmlkYXlzID0gdGltZUZyaWRheS5yYW5nZTsKdmFyIHRpbWVTYXR1cmRheXMgPSB0aW1lU2F0dXJkYXkucmFuZ2U7CmZ1bmN0aW9uIHV0Y1dlZWtkYXkoaSkgewogIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSAtIChkYXRlMi5nZXRVVENEYXkoKSArIDcgLSBpKSAlIDcpOwogICAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSArIHN0ZXAgKiA3KTsKICB9LCAoc3RhcnQsIGVuZCkgPT4gewogICAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbldlZWs7CiAgfSk7Cn0KdmFyIHV0Y1N1bmRheSA9IHV0Y1dlZWtkYXkoMCk7CnZhciB1dGNNb25kYXkgPSB1dGNXZWVrZGF5KDEpOwp2YXIgdXRjVHVlc2RheSA9IHV0Y1dlZWtkYXkoMik7CnZhciB1dGNXZWRuZXNkYXkgPSB1dGNXZWVrZGF5KDMpOwp2YXIgdXRjVGh1cnNkYXkgPSB1dGNXZWVrZGF5KDQpOwp2YXIgdXRjRnJpZGF5ID0gdXRjV2Vla2RheSg1KTsKdmFyIHV0Y1NhdHVyZGF5ID0gdXRjV2Vla2RheSg2KTsKdmFyIHV0Y1N1bmRheXMgPSB1dGNTdW5kYXkucmFuZ2U7CnZhciB1dGNNb25kYXlzID0gdXRjTW9uZGF5LnJhbmdlOwp2YXIgdXRjVHVlc2RheXMgPSB1dGNUdWVzZGF5LnJhbmdlOwp2YXIgdXRjV2VkbmVzZGF5cyA9IHV0Y1dlZG5lc2RheS5yYW5nZTsKdmFyIHV0Y1RodXJzZGF5cyA9IHV0Y1RodXJzZGF5LnJhbmdlOwp2YXIgdXRjRnJpZGF5cyA9IHV0Y0ZyaWRheS5yYW5nZTsKdmFyIHV0Y1NhdHVyZGF5cyA9IHV0Y1NhdHVyZGF5LnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21vbnRoLmpzCnZhciB0aW1lTW9udGggPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0RGF0ZSgxKTsKICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0TW9udGgoZGF0ZTIuZ2V0TW9udGgoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiBlbmQuZ2V0TW9udGgoKSAtIHN0YXJ0LmdldE1vbnRoKCkgKyAoZW5kLmdldEZ1bGxZZWFyKCkgLSBzdGFydC5nZXRGdWxsWWVhcigpKSAqIDEyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0TW9udGgoKTsKfSk7CnZhciB0aW1lTW9udGhzID0gdGltZU1vbnRoLnJhbmdlOwp2YXIgdXRjTW9udGggPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDRGF0ZSgxKTsKICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VVRDTW9udGgoZGF0ZTIuZ2V0VVRDTW9udGgoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiBlbmQuZ2V0VVRDTW9udGgoKSAtIHN0YXJ0LmdldFVUQ01vbnRoKCkgKyAoZW5kLmdldFVUQ0Z1bGxZZWFyKCkgLSBzdGFydC5nZXRVVENGdWxsWWVhcigpKSAqIDEyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDTW9udGgoKTsKfSk7CnZhciB1dGNNb250aHMgPSB1dGNNb250aC5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy95ZWFyLmpzCnZhciB0aW1lWWVhciA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRNb250aCgwLCAxKTsKICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0RnVsbFllYXIoZGF0ZTIuZ2V0RnVsbFllYXIoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiBlbmQuZ2V0RnVsbFllYXIoKSAtIHN0YXJ0LmdldEZ1bGxZZWFyKCk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRGdWxsWWVhcigpOwp9KTsKdGltZVllYXIuZXZlcnkgPSAoazIpID0+IHsKICByZXR1cm4gIWlzRmluaXRlKGsyID0gTWF0aC5mbG9vcihrMikpIHx8ICEoazIgPiAwKSA/IG51bGwgOiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihNYXRoLmZsb29yKGRhdGUyLmdldEZ1bGxZZWFyKCkgLyBrMikgKiBrMik7CiAgICBkYXRlMi5zZXRNb250aCgwLCAxKTsKICAgIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0RnVsbFllYXIoZGF0ZTIuZ2V0RnVsbFllYXIoKSArIHN0ZXAgKiBrMik7CiAgfSk7Cn07CnZhciB0aW1lWWVhcnMgPSB0aW1lWWVhci5yYW5nZTsKdmFyIHV0Y1llYXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDTW9udGgoMCwgMSk7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldFVUQ0Z1bGxZZWFyKCkgLSBzdGFydC5nZXRVVENGdWxsWWVhcigpOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKTsKfSk7CnV0Y1llYXIuZXZlcnkgPSAoazIpID0+IHsKICByZXR1cm4gIWlzRmluaXRlKGsyID0gTWF0aC5mbG9vcihrMikpIHx8ICEoazIgPiAwKSA/IG51bGwgOiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRVVENGdWxsWWVhcihNYXRoLmZsb29yKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgLyBrMikgKiBrMik7CiAgICBkYXRlMi5zZXRVVENNb250aCgwLCAxKTsKICAgIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKSArIHN0ZXAgKiBrMik7CiAgfSk7Cn07CnZhciB1dGNZZWFycyA9IHV0Y1llYXIucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvdGlja3MuanMKZnVuY3Rpb24gdGlja2VyKHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSkgewogIGNvbnN0IHRpY2tJbnRlcnZhbHMgPSBbCiAgICBbc2Vjb25kLCAxLCBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCA1LCA1ICogZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgMTUsIDE1ICogZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgMzAsIDMwICogZHVyYXRpb25TZWNvbmRdLAogICAgW21pbnV0ZSwgMSwgZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgNSwgNSAqIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDE1LCAxNSAqIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDMwLCAzMCAqIGR1cmF0aW9uTWludXRlXSwKICAgIFtob3VyLCAxLCBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDMsIDMgKiBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDYsIDYgKiBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDEyLCAxMiAqIGR1cmF0aW9uSG91cl0sCiAgICBbZGF5LCAxLCBkdXJhdGlvbkRheV0sCiAgICBbZGF5LCAyLCAyICogZHVyYXRpb25EYXldLAogICAgW3dlZWssIDEsIGR1cmF0aW9uV2Vla10sCiAgICBbbW9udGgsIDEsIGR1cmF0aW9uTW9udGhdLAogICAgW21vbnRoLCAzLCAzICogZHVyYXRpb25Nb250aF0sCiAgICBbeWVhciwgMSwgZHVyYXRpb25ZZWFyXQogIF07CiAgZnVuY3Rpb24gdGlja3MyKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogICAgY29uc3QgcmV2ZXJzZTIgPSBzdG9wIDwgc3RhcnQ7CiAgICBpZiAocmV2ZXJzZTIpIFtzdGFydCwgc3RvcF0gPSBbc3RvcCwgc3RhcnRdOwogICAgY29uc3QgaW50ZXJ2YWwgPSBjb3VudCAmJiB0eXBlb2YgY291bnQucmFuZ2UgPT09ICJmdW5jdGlvbiIgPyBjb3VudCA6IHRpY2tJbnRlcnZhbChzdGFydCwgc3RvcCwgY291bnQpOwogICAgY29uc3QgdGlja3MzID0gaW50ZXJ2YWwgPyBpbnRlcnZhbC5yYW5nZShzdGFydCwgK3N0b3AgKyAxKSA6IFtdOwogICAgcmV0dXJuIHJldmVyc2UyID8gdGlja3MzLnJldmVyc2UoKSA6IHRpY2tzMzsKICB9CiAgZnVuY3Rpb24gdGlja0ludGVydmFsKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogICAgY29uc3QgdGFyZ2V0ID0gTWF0aC5hYnMoc3RvcCAtIHN0YXJ0KSAvIGNvdW50OwogICAgY29uc3QgaSA9IGJpc2VjdG9yKChbLCAsIHN0ZXAyXSkgPT4gc3RlcDIpLnJpZ2h0KHRpY2tJbnRlcnZhbHMsIHRhcmdldCk7CiAgICBpZiAoaSA9PT0gdGlja0ludGVydmFscy5sZW5ndGgpIHJldHVybiB5ZWFyLmV2ZXJ5KHRpY2tTdGVwKHN0YXJ0IC8gZHVyYXRpb25ZZWFyLCBzdG9wIC8gZHVyYXRpb25ZZWFyLCBjb3VudCkpOwogICAgaWYgKGkgPT09IDApIHJldHVybiBtaWxsaXNlY29uZC5ldmVyeShNYXRoLm1heCh0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpLCAxKSk7CiAgICBjb25zdCBbdCwgc3RlcF0gPSB0aWNrSW50ZXJ2YWxzW3RhcmdldCAvIHRpY2tJbnRlcnZhbHNbaSAtIDFdWzJdIDwgdGlja0ludGVydmFsc1tpXVsyXSAvIHRhcmdldCA/IGkgLSAxIDogaV07CiAgICByZXR1cm4gdC5ldmVyeShzdGVwKTsKICB9CiAgcmV0dXJuIFt0aWNrczIsIHRpY2tJbnRlcnZhbF07Cn0KdmFyIFt1dGNUaWNrcywgdXRjVGlja0ludGVydmFsXSA9IHRpY2tlcih1dGNZZWFyLCB1dGNNb250aCwgdXRjU3VuZGF5LCB1bml4RGF5LCB1dGNIb3VyLCB1dGNNaW51dGUpOwp2YXIgW3RpbWVUaWNrcywgdGltZVRpY2tJbnRlcnZhbF0gPSB0aWNrZXIodGltZVllYXIsIHRpbWVNb250aCwgdGltZVN1bmRheSwgdGltZURheSwgdGltZUhvdXIsIHRpbWVNaW51dGUpOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9sb2NhbGUuanMKZnVuY3Rpb24gbG9jYWxEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTIgPSBuZXcgRGF0ZSgtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCk7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihkLnkpOwogICAgcmV0dXJuIGRhdGUyOwogIH0KICByZXR1cm4gbmV3IERhdGUoZC55LCBkLm0sIGQuZCwgZC5ILCBkLk0sIGQuUywgZC5MKTsKfQpmdW5jdGlvbiB1dGNEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTIgPSBuZXcgRGF0ZShEYXRlLlVUQygtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZC55KTsKICAgIHJldHVybiBkYXRlMjsKICB9CiAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKGQueSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwp9CmZ1bmN0aW9uIG5ld0RhdGUoeTIsIG0sIGQpIHsKICByZXR1cm4geyB5OiB5MiwgbSwgZCwgSDogMCwgTTogMCwgUzogMCwgTDogMCB9Owp9CmZ1bmN0aW9uIGZvcm1hdExvY2FsZShsb2NhbGUzKSB7CiAgdmFyIGxvY2FsZV9kYXRlVGltZSA9IGxvY2FsZTMuZGF0ZVRpbWUsIGxvY2FsZV9kYXRlID0gbG9jYWxlMy5kYXRlLCBsb2NhbGVfdGltZSA9IGxvY2FsZTMudGltZSwgbG9jYWxlX3BlcmlvZHMgPSBsb2NhbGUzLnBlcmlvZHMsIGxvY2FsZV93ZWVrZGF5cyA9IGxvY2FsZTMuZGF5cywgbG9jYWxlX3Nob3J0V2Vla2RheXMgPSBsb2NhbGUzLnNob3J0RGF5cywgbG9jYWxlX21vbnRocyA9IGxvY2FsZTMubW9udGhzLCBsb2NhbGVfc2hvcnRNb250aHMgPSBsb2NhbGUzLnNob3J0TW9udGhzOwogIHZhciBwZXJpb2RSZSA9IGZvcm1hdFJlKGxvY2FsZV9wZXJpb2RzKSwgcGVyaW9kTG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9wZXJpb2RzKSwgd2Vla2RheVJlID0gZm9ybWF0UmUobG9jYWxlX3dlZWtkYXlzKSwgd2Vla2RheUxvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfd2Vla2RheXMpLCBzaG9ydFdlZWtkYXlSZSA9IGZvcm1hdFJlKGxvY2FsZV9zaG9ydFdlZWtkYXlzKSwgc2hvcnRXZWVrZGF5TG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9zaG9ydFdlZWtkYXlzKSwgbW9udGhSZSA9IGZvcm1hdFJlKGxvY2FsZV9tb250aHMpLCBtb250aExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfbW9udGhzKSwgc2hvcnRNb250aFJlID0gZm9ybWF0UmUobG9jYWxlX3Nob3J0TW9udGhzKSwgc2hvcnRNb250aExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfc2hvcnRNb250aHMpOwogIHZhciBmb3JtYXRzID0gewogICAgImEiOiBmb3JtYXRTaG9ydFdlZWtkYXksCiAgICAiQSI6IGZvcm1hdFdlZWtkYXksCiAgICAiYiI6IGZvcm1hdFNob3J0TW9udGgsCiAgICAiQiI6IGZvcm1hdE1vbnRoLAogICAgImMiOiBudWxsLAogICAgImQiOiBmb3JtYXREYXlPZk1vbnRoLAogICAgImUiOiBmb3JtYXREYXlPZk1vbnRoLAogICAgImYiOiBmb3JtYXRNaWNyb3NlY29uZHMsCiAgICAiZyI6IGZvcm1hdFllYXJJU08sCiAgICAiRyI6IGZvcm1hdEZ1bGxZZWFySVNPLAogICAgIkgiOiBmb3JtYXRIb3VyMjQsCiAgICAiSSI6IGZvcm1hdEhvdXIxMiwKICAgICJqIjogZm9ybWF0RGF5T2ZZZWFyLAogICAgIkwiOiBmb3JtYXRNaWxsaXNlY29uZHMsCiAgICAibSI6IGZvcm1hdE1vbnRoTnVtYmVyLAogICAgIk0iOiBmb3JtYXRNaW51dGVzLAogICAgInAiOiBmb3JtYXRQZXJpb2QsCiAgICAicSI6IGZvcm1hdFF1YXJ0ZXIsCiAgICAiUSI6IGZvcm1hdFVuaXhUaW1lc3RhbXAsCiAgICAicyI6IGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBmb3JtYXRTZWNvbmRzLAogICAgInUiOiBmb3JtYXRXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBmb3JtYXRXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBmb3JtYXRXZWVrTnVtYmVySVNPLAogICAgInciOiBmb3JtYXRXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBmb3JtYXRXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBudWxsLAogICAgIlgiOiBudWxsLAogICAgInkiOiBmb3JtYXRZZWFyLAogICAgIlkiOiBmb3JtYXRGdWxsWWVhciwKICAgICJaIjogZm9ybWF0Wm9uZSwKICAgICIlIjogZm9ybWF0TGl0ZXJhbFBlcmNlbnQKICB9OwogIHZhciB1dGNGb3JtYXRzID0gewogICAgImEiOiBmb3JtYXRVVENTaG9ydFdlZWtkYXksCiAgICAiQSI6IGZvcm1hdFVUQ1dlZWtkYXksCiAgICAiYiI6IGZvcm1hdFVUQ1Nob3J0TW9udGgsCiAgICAiQiI6IGZvcm1hdFVUQ01vbnRoLAogICAgImMiOiBudWxsLAogICAgImQiOiBmb3JtYXRVVENEYXlPZk1vbnRoLAogICAgImUiOiBmb3JtYXRVVENEYXlPZk1vbnRoLAogICAgImYiOiBmb3JtYXRVVENNaWNyb3NlY29uZHMsCiAgICAiZyI6IGZvcm1hdFVUQ1llYXJJU08sCiAgICAiRyI6IGZvcm1hdFVUQ0Z1bGxZZWFySVNPLAogICAgIkgiOiBmb3JtYXRVVENIb3VyMjQsCiAgICAiSSI6IGZvcm1hdFVUQ0hvdXIxMiwKICAgICJqIjogZm9ybWF0VVRDRGF5T2ZZZWFyLAogICAgIkwiOiBmb3JtYXRVVENNaWxsaXNlY29uZHMsCiAgICAibSI6IGZvcm1hdFVUQ01vbnRoTnVtYmVyLAogICAgIk0iOiBmb3JtYXRVVENNaW51dGVzLAogICAgInAiOiBmb3JtYXRVVENQZXJpb2QsCiAgICAicSI6IGZvcm1hdFVUQ1F1YXJ0ZXIsCiAgICAiUSI6IGZvcm1hdFVuaXhUaW1lc3RhbXAsCiAgICAicyI6IGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBmb3JtYXRVVENTZWNvbmRzLAogICAgInUiOiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBmb3JtYXRVVENXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBmb3JtYXRVVENXZWVrTnVtYmVySVNPLAogICAgInciOiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBmb3JtYXRVVENXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBudWxsLAogICAgIlgiOiBudWxsLAogICAgInkiOiBmb3JtYXRVVENZZWFyLAogICAgIlkiOiBmb3JtYXRVVENGdWxsWWVhciwKICAgICJaIjogZm9ybWF0VVRDWm9uZSwKICAgICIlIjogZm9ybWF0TGl0ZXJhbFBlcmNlbnQKICB9OwogIHZhciBwYXJzZXMgPSB7CiAgICAiYSI6IHBhcnNlU2hvcnRXZWVrZGF5LAogICAgIkEiOiBwYXJzZVdlZWtkYXksCiAgICAiYiI6IHBhcnNlU2hvcnRNb250aCwKICAgICJCIjogcGFyc2VNb250aCwKICAgICJjIjogcGFyc2VMb2NhbGVEYXRlVGltZSwKICAgICJkIjogcGFyc2VEYXlPZk1vbnRoLAogICAgImUiOiBwYXJzZURheU9mTW9udGgsCiAgICAiZiI6IHBhcnNlTWljcm9zZWNvbmRzLAogICAgImciOiBwYXJzZVllYXIsCiAgICAiRyI6IHBhcnNlRnVsbFllYXIsCiAgICAiSCI6IHBhcnNlSG91cjI0LAogICAgIkkiOiBwYXJzZUhvdXIyNCwKICAgICJqIjogcGFyc2VEYXlPZlllYXIsCiAgICAiTCI6IHBhcnNlTWlsbGlzZWNvbmRzLAogICAgIm0iOiBwYXJzZU1vbnRoTnVtYmVyLAogICAgIk0iOiBwYXJzZU1pbnV0ZXMsCiAgICAicCI6IHBhcnNlUGVyaW9kLAogICAgInEiOiBwYXJzZVF1YXJ0ZXIsCiAgICAiUSI6IHBhcnNlVW5peFRpbWVzdGFtcCwKICAgICJzIjogcGFyc2VVbml4VGltZXN0YW1wU2Vjb25kcywKICAgICJTIjogcGFyc2VTZWNvbmRzLAogICAgInUiOiBwYXJzZVdlZWtkYXlOdW1iZXJNb25kYXksCiAgICAiVSI6IHBhcnNlV2Vla051bWJlclN1bmRheSwKICAgICJWIjogcGFyc2VXZWVrTnVtYmVySVNPLAogICAgInciOiBwYXJzZVdlZWtkYXlOdW1iZXJTdW5kYXksCiAgICAiVyI6IHBhcnNlV2Vla051bWJlck1vbmRheSwKICAgICJ4IjogcGFyc2VMb2NhbGVEYXRlLAogICAgIlgiOiBwYXJzZUxvY2FsZVRpbWUsCiAgICAieSI6IHBhcnNlWWVhciwKICAgICJZIjogcGFyc2VGdWxsWWVhciwKICAgICJaIjogcGFyc2Vab25lLAogICAgIiUiOiBwYXJzZUxpdGVyYWxQZXJjZW50CiAgfTsKICBmb3JtYXRzLnggPSBuZXdGb3JtYXQobG9jYWxlX2RhdGUsIGZvcm1hdHMpOwogIGZvcm1hdHMuWCA9IG5ld0Zvcm1hdChsb2NhbGVfdGltZSwgZm9ybWF0cyk7CiAgZm9ybWF0cy5jID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlVGltZSwgZm9ybWF0cyk7CiAgdXRjRm9ybWF0cy54ID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlLCB1dGNGb3JtYXRzKTsKICB1dGNGb3JtYXRzLlggPSBuZXdGb3JtYXQobG9jYWxlX3RpbWUsIHV0Y0Zvcm1hdHMpOwogIHV0Y0Zvcm1hdHMuYyA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZVRpbWUsIHV0Y0Zvcm1hdHMpOwogIGZ1bmN0aW9uIG5ld0Zvcm1hdChzcGVjaWZpZXIsIGZvcm1hdHMyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZTIpIHsKICAgICAgdmFyIHN0cmluZyA9IFtdLCBpID0gLTEsIGogPSAwLCBuID0gc3BlY2lmaWVyLmxlbmd0aCwgYzIsIHBhZDIsIGZvcm1hdDI7CiAgICAgIGlmICghKGRhdGUyIGluc3RhbmNlb2YgRGF0ZSkpIGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMik7CiAgICAgIHdoaWxlICgrK2kgPCBuKSB7CiAgICAgICAgaWYgKHNwZWNpZmllci5jaGFyQ29kZUF0KGkpID09PSAzNykgewogICAgICAgICAgc3RyaW5nLnB1c2goc3BlY2lmaWVyLnNsaWNlKGosIGkpKTsKICAgICAgICAgIGlmICgocGFkMiA9IHBhZHNbYzIgPSBzcGVjaWZpZXIuY2hhckF0KCsraSldKSAhPSBudWxsKSBjMiA9IHNwZWNpZmllci5jaGFyQXQoKytpKTsKICAgICAgICAgIGVsc2UgcGFkMiA9IGMyID09PSAiZSIgPyAiICIgOiAiMCI7CiAgICAgICAgICBpZiAoZm9ybWF0MiA9IGZvcm1hdHMyW2MyXSkgYzIgPSBmb3JtYXQyKGRhdGUyLCBwYWQyKTsKICAgICAgICAgIHN0cmluZy5wdXNoKGMyKTsKICAgICAgICAgIGogPSBpICsgMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc3RyaW5nLnB1c2goc3BlY2lmaWVyLnNsaWNlKGosIGkpKTsKICAgICAgcmV0dXJuIHN0cmluZy5qb2luKCIiKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIG5ld1BhcnNlKHNwZWNpZmllciwgWikgewogICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICB2YXIgZCA9IG5ld0RhdGUoMTkwMCwgdm9pZCAwLCAxKSwgaSA9IHBhcnNlU3BlY2lmaWVyKGQsIHNwZWNpZmllciwgc3RyaW5nICs9ICIiLCAwKSwgd2VlaywgZGF5OwogICAgICBpZiAoaSAhPSBzdHJpbmcubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKCJRIiBpbiBkKSByZXR1cm4gbmV3IERhdGUoZC5RKTsKICAgICAgaWYgKCJzIiBpbiBkKSByZXR1cm4gbmV3IERhdGUoZC5zICogMWUzICsgKCJMIiBpbiBkID8gZC5MIDogMCkpOwogICAgICBpZiAoWiAmJiAhKCJaIiBpbiBkKSkgZC5aID0gMDsKICAgICAgaWYgKCJwIiBpbiBkKSBkLkggPSBkLkggJSAxMiArIGQucCAqIDEyOwogICAgICBpZiAoZC5tID09PSB2b2lkIDApIGQubSA9ICJxIiBpbiBkID8gZC5xIDogMDsKICAgICAgaWYgKCJWIiBpbiBkKSB7CiAgICAgICAgaWYgKGQuViA8IDEgfHwgZC5WID4gNTMpIHJldHVybiBudWxsOwogICAgICAgIGlmICghKCJ3IiBpbiBkKSkgZC53ID0gMTsKICAgICAgICBpZiAoIloiIGluIGQpIHsKICAgICAgICAgIHdlZWsgPSB1dGNEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSksIGRheSA9IHdlZWsuZ2V0VVRDRGF5KCk7CiAgICAgICAgICB3ZWVrID0gZGF5ID4gNCB8fCBkYXkgPT09IDAgPyB1dGNNb25kYXkuY2VpbCh3ZWVrKSA6IHV0Y01vbmRheSh3ZWVrKTsKICAgICAgICAgIHdlZWsgPSB1dGNEYXkub2Zmc2V0KHdlZWssIChkLlYgLSAxKSAqIDcpOwogICAgICAgICAgZC55ID0gd2Vlay5nZXRVVENGdWxsWWVhcigpOwogICAgICAgICAgZC5tID0gd2Vlay5nZXRVVENNb250aCgpOwogICAgICAgICAgZC5kID0gd2Vlay5nZXRVVENEYXRlKCkgKyAoZC53ICsgNikgJSA3OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3ZWVrID0gbG9jYWxEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSksIGRheSA9IHdlZWsuZ2V0RGF5KCk7CiAgICAgICAgICB3ZWVrID0gZGF5ID4gNCB8fCBkYXkgPT09IDAgPyB0aW1lTW9uZGF5LmNlaWwod2VlaykgOiB0aW1lTW9uZGF5KHdlZWspOwogICAgICAgICAgd2VlayA9IHRpbWVEYXkub2Zmc2V0KHdlZWssIChkLlYgLSAxKSAqIDcpOwogICAgICAgICAgZC55ID0gd2Vlay5nZXRGdWxsWWVhcigpOwogICAgICAgICAgZC5tID0gd2Vlay5nZXRNb250aCgpOwogICAgICAgICAgZC5kID0gd2Vlay5nZXREYXRlKCkgKyAoZC53ICsgNikgJSA3OwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgiVyIgaW4gZCB8fCAiVSIgaW4gZCkgewogICAgICAgIGlmICghKCJ3IiBpbiBkKSkgZC53ID0gInUiIGluIGQgPyBkLnUgJSA3IDogIlciIGluIGQgPyAxIDogMDsKICAgICAgICBkYXkgPSAiWiIgaW4gZCA/IHV0Y0RhdGUobmV3RGF0ZShkLnksIDAsIDEpKS5nZXRVVENEYXkoKSA6IGxvY2FsRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLmdldERheSgpOwogICAgICAgIGQubSA9IDA7CiAgICAgICAgZC5kID0gIlciIGluIGQgPyAoZC53ICsgNikgJSA3ICsgZC5XICogNyAtIChkYXkgKyA1KSAlIDcgOiBkLncgKyBkLlUgKiA3IC0gKGRheSArIDYpICUgNzsKICAgICAgfQogICAgICBpZiAoIloiIGluIGQpIHsKICAgICAgICBkLkggKz0gZC5aIC8gMTAwIHwgMDsKICAgICAgICBkLk0gKz0gZC5aICUgMTAwOwogICAgICAgIHJldHVybiB1dGNEYXRlKGQpOwogICAgICB9CiAgICAgIHJldHVybiBsb2NhbERhdGUoZCk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZVNwZWNpZmllcihkLCBzcGVjaWZpZXIsIHN0cmluZywgaikgewogICAgdmFyIGkgPSAwLCBuID0gc3BlY2lmaWVyLmxlbmd0aCwgbSA9IHN0cmluZy5sZW5ndGgsIGMyLCBwYXJzZTsKICAgIHdoaWxlIChpIDwgbikgewogICAgICBpZiAoaiA+PSBtKSByZXR1cm4gLTE7CiAgICAgIGMyID0gc3BlY2lmaWVyLmNoYXJDb2RlQXQoaSsrKTsKICAgICAgaWYgKGMyID09PSAzNykgewogICAgICAgIGMyID0gc3BlY2lmaWVyLmNoYXJBdChpKyspOwogICAgICAgIHBhcnNlID0gcGFyc2VzW2MyIGluIHBhZHMgPyBzcGVjaWZpZXIuY2hhckF0KGkrKykgOiBjMl07CiAgICAgICAgaWYgKCFwYXJzZSB8fCAoaiA9IHBhcnNlKGQsIHN0cmluZywgaikpIDwgMCkgcmV0dXJuIC0xOwogICAgICB9IGVsc2UgaWYgKGMyICE9IHN0cmluZy5jaGFyQ29kZUF0KGorKykpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBqOwogIH0KICBmdW5jdGlvbiBwYXJzZVBlcmlvZChkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gcGVyaW9kUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5wID0gcGVyaW9kTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlU2hvcnRXZWVrZGF5KGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBzaG9ydFdlZWtkYXlSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLncgPSBzaG9ydFdlZWtkYXlMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VXZWVrZGF5KGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSB3ZWVrZGF5UmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC53ID0gd2Vla2RheUxvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZVNob3J0TW9udGgoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHNob3J0TW9udGhSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLm0gPSBzaG9ydE1vbnRoTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTW9udGgoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IG1vbnRoUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5tID0gbW9udGhMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMb2NhbGVEYXRlVGltZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfZGF0ZVRpbWUsIHN0cmluZywgaSk7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlRGF0ZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfZGF0ZSwgc3RyaW5nLCBpKTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMb2NhbGVUaW1lKGQsIHN0cmluZywgaSkgewogICAgcmV0dXJuIHBhcnNlU3BlY2lmaWVyKGQsIGxvY2FsZV90aW1lLCBzdHJpbmcsIGkpOwogIH0KICBmdW5jdGlvbiBmb3JtYXRTaG9ydFdlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydFdlZWtkYXlzW2QuZ2V0RGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfd2Vla2RheXNbZC5nZXREYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFNob3J0TW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydE1vbnRoc1tkLmdldE1vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX21vbnRoc1tkLmdldE1vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRQZXJpb2QoZCkgewogICAgcmV0dXJuIGxvY2FsZV9wZXJpb2RzWysoZC5nZXRIb3VycygpID49IDEyKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFF1YXJ0ZXIoZCkgewogICAgcmV0dXJuIDEgKyB+fihkLmdldE1vbnRoKCkgLyAzKTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDU2hvcnRXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRXZWVrZGF5c1tkLmdldFVUQ0RheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDV2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3dlZWtkYXlzW2QuZ2V0VVRDRGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENTaG9ydE1vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRNb250aHNbZC5nZXRVVENNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDTW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9tb250aHNbZC5nZXRVVENNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDUGVyaW9kKGQpIHsKICAgIHJldHVybiBsb2NhbGVfcGVyaW9kc1srKGQuZ2V0VVRDSG91cnMoKSA+PSAxMildOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENRdWFydGVyKGQpIHsKICAgIHJldHVybiAxICsgfn4oZC5nZXRVVENNb250aCgpIC8gMyk7CiAgfQogIHJldHVybiB7CiAgICBmb3JtYXQ6IGZ1bmN0aW9uKHNwZWNpZmllcikgewogICAgICB2YXIgZiA9IG5ld0Zvcm1hdChzcGVjaWZpZXIgKz0gIiIsIGZvcm1hdHMpOwogICAgICBmLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllcjsKICAgICAgfTsKICAgICAgcmV0dXJuIGY7CiAgICB9LAogICAgcGFyc2U6IGZ1bmN0aW9uKHNwZWNpZmllcikgewogICAgICB2YXIgcCA9IG5ld1BhcnNlKHNwZWNpZmllciArPSAiIiwgZmFsc2UpOwogICAgICBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllcjsKICAgICAgfTsKICAgICAgcmV0dXJuIHA7CiAgICB9LAogICAgdXRjRm9ybWF0OiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIGYgPSBuZXdGb3JtYXQoc3BlY2lmaWVyICs9ICIiLCB1dGNGb3JtYXRzKTsKICAgICAgZi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBmOwogICAgfSwKICAgIHV0Y1BhcnNlOiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIHAgPSBuZXdQYXJzZShzcGVjaWZpZXIgKz0gIiIsIHRydWUpOwogICAgICBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllcjsKICAgICAgfTsKICAgICAgcmV0dXJuIHA7CiAgICB9CiAgfTsKfQp2YXIgcGFkcyA9IHsgIi0iOiAiIiwgIl8iOiAiICIsICIwIjogIjAiIH07CnZhciBudW1iZXJSZSA9IC9eXHMqXGQrLzsKdmFyIHBlcmNlbnRSZSA9IC9eJS87CnZhciByZXF1b3RlUmUgPSAvW1xcXiQqKz98W1xdKCkue31dL2c7CmZ1bmN0aW9uIHBhZCh2YWx1ZSwgZmlsbCwgd2lkdGgpIHsKICB2YXIgc2lnbjIgPSB2YWx1ZSA8IDAgPyAiLSIgOiAiIiwgc3RyaW5nID0gKHNpZ24yID8gLXZhbHVlIDogdmFsdWUpICsgIiIsIGxlbmd0aCA9IHN0cmluZy5sZW5ndGg7CiAgcmV0dXJuIHNpZ24yICsgKGxlbmd0aCA8IHdpZHRoID8gbmV3IEFycmF5KHdpZHRoIC0gbGVuZ3RoICsgMSkuam9pbihmaWxsKSArIHN0cmluZyA6IHN0cmluZyk7Cn0KZnVuY3Rpb24gcmVxdW90ZShzMikgewogIHJldHVybiBzMi5yZXBsYWNlKHJlcXVvdGVSZSwgIlxcJCYiKTsKfQpmdW5jdGlvbiBmb3JtYXRSZShuYW1lcykgewogIHJldHVybiBuZXcgUmVnRXhwKCJeKD86IiArIG5hbWVzLm1hcChyZXF1b3RlKS5qb2luKCJ8IikgKyAiKSIsICJpIik7Cn0KZnVuY3Rpb24gZm9ybWF0TG9va3VwKG5hbWVzKSB7CiAgcmV0dXJuIG5ldyBNYXAobmFtZXMubWFwKChuYW1lLCBpKSA9PiBbbmFtZS50b0xvd2VyQ2FzZSgpLCBpXSkpOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla2RheU51bWJlclN1bmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyAoZC53ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtkYXlOdW1iZXJNb25kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gKGQudSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrTnVtYmVyU3VuZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlUgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla051bWJlcklTTyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5WID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtOdW1iZXJNb25kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuVyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VGdWxsWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyA0KSk7CiAgcmV0dXJuIG4gPyAoZC55ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVllYXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQueSA9ICtuWzBdICsgKCtuWzBdID4gNjggPyAxOTAwIDogMmUzKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlWm9uZShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IC9eKFopfChbKy1dXGRcZCkoPzo6PyhcZFxkKSk/Ly5leGVjKHN0cmluZy5zbGljZShpLCBpICsgNikpOwogIHJldHVybiBuID8gKGQuWiA9IG5bMV0gPyAwIDogLShuWzJdICsgKG5bM10gfHwgIjAwIikpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VRdWFydGVyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IChkLnEgPSBuWzBdICogMyAtIDMsIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZU1vbnRoTnVtYmVyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLm0gPSBuWzBdIC0gMSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlRGF5T2ZNb250aChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5kID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZURheU9mWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAzKSk7CiAgcmV0dXJuIG4gPyAoZC5tID0gMCwgZC5kID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUhvdXIyNChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5IID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZU1pbnV0ZXMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuTSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VTZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlMgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWlsbGlzZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDMpKTsKICByZXR1cm4gbiA/IChkLkwgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWljcm9zZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDYpKTsKICByZXR1cm4gbiA/IChkLkwgPSBNYXRoLmZsb29yKG5bMF0gLyAxZTMpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VMaXRlcmFsUGVyY2VudChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IHBlcmNlbnRSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gaSArIG5bMF0ubGVuZ3RoIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VVbml4VGltZXN0YW1wKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogIHJldHVybiBuID8gKGQuUSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VVbml4VGltZXN0YW1wU2Vjb25kcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICByZXR1cm4gbiA/IChkLnMgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIGZvcm1hdERheU9mTW9udGgoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXREYXRlKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdEhvdXIyNChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEhvdXJzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdEhvdXIxMihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEhvdXJzKCkgJSAxMiB8fCAxMiwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0RGF5T2ZZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKDEgKyB0aW1lRGF5LmNvdW50KHRpbWVZZWFyKGQpLCBkKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0TWlsbGlzZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0TWlsbGlzZWNvbmRzKCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdE1pY3Jvc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIGZvcm1hdE1pbGxpc2Vjb25kcyhkLCBwKSArICIwMDAiOwp9CmZ1bmN0aW9uIGZvcm1hdE1vbnRoTnVtYmVyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0TW9udGgoKSArIDEsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdE1pbnV0ZXMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNaW51dGVzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFNlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRTZWNvbmRzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtkYXlOdW1iZXJNb25kYXkoZCkgewogIHZhciBkYXkgPSBkLmdldERheSgpOwogIHJldHVybiBkYXkgPT09IDAgPyA3IDogZGF5Owp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtOdW1iZXJTdW5kYXkoZCwgcCkgewogIHJldHVybiBwYWQodGltZVN1bmRheS5jb3VudCh0aW1lWWVhcihkKSAtIDEsIGQpLCBwLCAyKTsKfQpmdW5jdGlvbiBkSVNPKGQpIHsKICB2YXIgZGF5ID0gZC5nZXREYXkoKTsKICByZXR1cm4gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdGltZVRodXJzZGF5KGQpIDogdGltZVRodXJzZGF5LmNlaWwoZCk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlcklTTyhkLCBwKSB7CiAgZCA9IGRJU08oZCk7CiAgcmV0dXJuIHBhZCh0aW1lVGh1cnNkYXkuY291bnQodGltZVllYXIoZCksIGQpICsgKHRpbWVZZWFyKGQpLmdldERheSgpID09PSA0KSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla2RheU51bWJlclN1bmRheShkKSB7CiAgcmV0dXJuIGQuZ2V0RGF5KCk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlck1vbmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh0aW1lTW9uZGF5LmNvdW50KHRpbWVZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRZZWFySVNPKGQsIHApIHsKICBkID0gZElTTyhkKTsKICByZXR1cm4gcGFkKGQuZ2V0RnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0RnVsbFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRGdWxsWWVhcklTTyhkLCBwKSB7CiAgdmFyIGRheSA9IGQuZ2V0RGF5KCk7CiAgZCA9IGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHRpbWVUaHVyc2RheShkKSA6IHRpbWVUaHVyc2RheS5jZWlsKGQpOwogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRab25lKGQpIHsKICB2YXIgeiA9IGQuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICByZXR1cm4gKHogPiAwID8gIi0iIDogKHogKj0gLTEsICIrIikpICsgcGFkKHogLyA2MCB8IDAsICIwIiwgMikgKyBwYWQoeiAlIDYwLCAiMCIsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0RheU9mTW9udGgoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENEYXRlKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0hvdXIyNChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0hvdXJzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0hvdXIxMihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0hvdXJzKCkgJSAxMiB8fCAxMiwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRGF5T2ZZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKDEgKyB1dGNEYXkuY291bnQodXRjWWVhcihkKSwgZCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pbGxpc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ01pbGxpc2Vjb25kcygpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENNaWNyb3NlY29uZHMoZCwgcCkgewogIHJldHVybiBmb3JtYXRVVENNaWxsaXNlY29uZHMoZCwgcCkgKyAiMDAwIjsKfQpmdW5jdGlvbiBmb3JtYXRVVENNb250aE51bWJlcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ01vbnRoKCkgKyAxLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENNaW51dGVzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTWludXRlcygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENTZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDU2Vjb25kcygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyTW9uZGF5KGQpIHsKICB2YXIgZG93ID0gZC5nZXRVVENEYXkoKTsKICByZXR1cm4gZG93ID09PSAwID8gNyA6IGRvdzsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVyU3VuZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHV0Y1N1bmRheS5jb3VudCh1dGNZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIFVUQ2RJU08oZCkgewogIHZhciBkYXkgPSBkLmdldFVUQ0RheSgpOwogIHJldHVybiBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB1dGNUaHVyc2RheShkKSA6IHV0Y1RodXJzZGF5LmNlaWwoZCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla051bWJlcklTTyhkLCBwKSB7CiAgZCA9IFVUQ2RJU08oZCk7CiAgcmV0dXJuIHBhZCh1dGNUaHVyc2RheS5jb3VudCh1dGNZZWFyKGQpLCBkKSArICh1dGNZZWFyKGQpLmdldFVUQ0RheSgpID09PSA0KSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla2RheU51bWJlclN1bmRheShkKSB7CiAgcmV0dXJuIGQuZ2V0VVRDRGF5KCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla051bWJlck1vbmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh1dGNNb25kYXkuY291bnQodXRjWWVhcihkKSAtIDEsIGQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDWWVhcklTTyhkLCBwKSB7CiAgZCA9IFVUQ2RJU08oZCk7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0Z1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0Z1bGxZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRnVsbFllYXJJU08oZCwgcCkgewogIHZhciBkYXkgPSBkLmdldFVUQ0RheSgpOwogIGQgPSBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB1dGNUaHVyc2RheShkKSA6IHV0Y1RodXJzZGF5LmNlaWwoZCk7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0Z1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1pvbmUoKSB7CiAgcmV0dXJuICIrMDAwMCI7Cn0KZnVuY3Rpb24gZm9ybWF0TGl0ZXJhbFBlcmNlbnQoKSB7CiAgcmV0dXJuICIlIjsKfQpmdW5jdGlvbiBmb3JtYXRVbml4VGltZXN0YW1wKGQpIHsKICByZXR1cm4gK2Q7Cn0KZnVuY3Rpb24gZm9ybWF0VW5peFRpbWVzdGFtcFNlY29uZHMoZCkgewogIHJldHVybiBNYXRoLmZsb29yKCtkIC8gMWUzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9kZWZhdWx0TG9jYWxlLmpzCnZhciBsb2NhbGUyOwp2YXIgdGltZUZvcm1hdDsKdmFyIHRpbWVQYXJzZTsKdmFyIHV0Y0Zvcm1hdDsKdmFyIHV0Y1BhcnNlOwpkZWZhdWx0TG9jYWxlMih7CiAgZGF0ZVRpbWU6ICIleCwgJVgiLAogIGRhdGU6ICIlLW0vJS1kLyVZIiwKICB0aW1lOiAiJS1JOiVNOiVTICVwIiwKICBwZXJpb2RzOiBbIkFNIiwgIlBNIl0sCiAgZGF5czogWyJTdW5kYXkiLCAiTW9uZGF5IiwgIlR1ZXNkYXkiLCAiV2VkbmVzZGF5IiwgIlRodXJzZGF5IiwgIkZyaWRheSIsICJTYXR1cmRheSJdLAogIHNob3J0RGF5czogWyJTdW4iLCAiTW9uIiwgIlR1ZSIsICJXZWQiLCAiVGh1IiwgIkZyaSIsICJTYXQiXSwKICBtb250aHM6IFsiSmFudWFyeSIsICJGZWJydWFyeSIsICJNYXJjaCIsICJBcHJpbCIsICJNYXkiLCAiSnVuZSIsICJKdWx5IiwgIkF1Z3VzdCIsICJTZXB0ZW1iZXIiLCAiT2N0b2JlciIsICJOb3ZlbWJlciIsICJEZWNlbWJlciJdLAogIHNob3J0TW9udGhzOiBbIkphbiIsICJGZWIiLCAiTWFyIiwgIkFwciIsICJNYXkiLCAiSnVuIiwgIkp1bCIsICJBdWciLCAiU2VwIiwgIk9jdCIsICJOb3YiLCAiRGVjIl0KfSk7CmZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUyKGRlZmluaXRpb24pIHsKICBsb2NhbGUyID0gZm9ybWF0TG9jYWxlKGRlZmluaXRpb24pOwogIHRpbWVGb3JtYXQgPSBsb2NhbGUyLmZvcm1hdDsKICB0aW1lUGFyc2UgPSBsb2NhbGUyLnBhcnNlOwogIHV0Y0Zvcm1hdCA9IGxvY2FsZTIudXRjRm9ybWF0OwogIHV0Y1BhcnNlID0gbG9jYWxlMi51dGNQYXJzZTsKICByZXR1cm4gbG9jYWxlMjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy90aW1lLmpzCmZ1bmN0aW9uIGRhdGUodCkgewogIHJldHVybiBuZXcgRGF0ZSh0KTsKfQpmdW5jdGlvbiBudW1iZXIzKHQpIHsKICByZXR1cm4gdCBpbnN0YW5jZW9mIERhdGUgPyArdCA6ICsvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK3QpOwp9CmZ1bmN0aW9uIGNhbGVuZGFyKHRpY2tzMiwgdGlja0ludGVydmFsLCB5ZWFyLCBtb250aCwgd2VlaywgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZDIsIGZvcm1hdDIpIHsKICB2YXIgc2NhbGUgPSBjb250aW51b3VzKCksIGludmVydCA9IHNjYWxlLmludmVydCwgZG9tYWluID0gc2NhbGUuZG9tYWluOwogIHZhciBmb3JtYXRNaWxsaXNlY29uZCA9IGZvcm1hdDIoIi4lTCIpLCBmb3JtYXRTZWNvbmQgPSBmb3JtYXQyKCI6JVMiKSwgZm9ybWF0TWludXRlID0gZm9ybWF0MigiJUk6JU0iKSwgZm9ybWF0SG91ciA9IGZvcm1hdDIoIiVJICVwIiksIGZvcm1hdERheSA9IGZvcm1hdDIoIiVhICVkIiksIGZvcm1hdFdlZWsgPSBmb3JtYXQyKCIlYiAlZCIpLCBmb3JtYXRNb250aCA9IGZvcm1hdDIoIiVCIiksIGZvcm1hdFllYXIyID0gZm9ybWF0MigiJVkiKTsKICBmdW5jdGlvbiB0aWNrRm9ybWF0MihkYXRlMikgewogICAgcmV0dXJuIChzZWNvbmQyKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0TWlsbGlzZWNvbmQgOiBtaW51dGUoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRTZWNvbmQgOiBob3VyKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0TWludXRlIDogZGF5KGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0SG91ciA6IG1vbnRoKGRhdGUyKSA8IGRhdGUyID8gd2VlayhkYXRlMikgPCBkYXRlMiA/IGZvcm1hdERheSA6IGZvcm1hdFdlZWsgOiB5ZWFyKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0TW9udGggOiBmb3JtYXRZZWFyMikoZGF0ZTIpOwogIH0KICBzY2FsZS5pbnZlcnQgPSBmdW5jdGlvbih5MikgewogICAgcmV0dXJuIG5ldyBEYXRlKGludmVydCh5MikpOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyBkb21haW4oQXJyYXkuZnJvbShfLCBudW1iZXIzKSkgOiBkb21haW4oKS5tYXAoZGF0ZSk7CiAgfTsKICBzY2FsZS50aWNrcyA9IGZ1bmN0aW9uKGludGVydmFsKSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgcmV0dXJuIHRpY2tzMihkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGludGVydmFsID09IG51bGwgPyAxMCA6IGludGVydmFsKTsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSBmdW5jdGlvbihjb3VudCwgc3BlY2lmaWVyKSB7CiAgICByZXR1cm4gc3BlY2lmaWVyID09IG51bGwgPyB0aWNrRm9ybWF0MiA6IGZvcm1hdDIoc3BlY2lmaWVyKTsKICB9OwogIHNjYWxlLm5pY2UgPSBmdW5jdGlvbihpbnRlcnZhbCkgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIGlmICghaW50ZXJ2YWwgfHwgdHlwZW9mIGludGVydmFsLnJhbmdlICE9PSAiZnVuY3Rpb24iKSBpbnRlcnZhbCA9IHRpY2tJbnRlcnZhbChkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGludGVydmFsID09IG51bGwgPyAxMCA6IGludGVydmFsKTsKICAgIHJldHVybiBpbnRlcnZhbCA/IGRvbWFpbihuaWNlKGQsIGludGVydmFsKSkgOiBzY2FsZTsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBjYWxlbmRhcih0aWNrczIsIHRpY2tJbnRlcnZhbCwgeWVhciwgbW9udGgsIHdlZWssIGRheSwgaG91ciwgbWludXRlLCBzZWNvbmQyLCBmb3JtYXQyKSk7CiAgfTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gdGltZSgpIHsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KGNhbGVuZGFyKHRpbWVUaWNrcywgdGltZVRpY2tJbnRlcnZhbCwgdGltZVllYXIsIHRpbWVNb250aCwgdGltZVN1bmRheSwgdGltZURheSwgdGltZUhvdXIsIHRpbWVNaW51dGUsIHNlY29uZCwgdGltZUZvcm1hdCkuZG9tYWluKFtuZXcgRGF0ZSgyZTMsIDAsIDEpLCBuZXcgRGF0ZSgyZTMsIDAsIDIpXSksIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdXRjVGltZS5qcwpmdW5jdGlvbiB1dGNUaW1lKCkgewogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoY2FsZW5kYXIodXRjVGlja3MsIHV0Y1RpY2tJbnRlcnZhbCwgdXRjWWVhciwgdXRjTW9udGgsIHV0Y1N1bmRheSwgdXRjRGF5LCB1dGNIb3VyLCB1dGNNaW51dGUsIHNlY29uZCwgdXRjRm9ybWF0KS5kb21haW4oW0RhdGUuVVRDKDJlMywgMCwgMSksIERhdGUuVVRDKDJlMywgMCwgMildKSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zZXF1ZW50aWFsLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybWVyMigpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDEsIHQwMiwgdDEyLCBrMTAsIHRyYW5zZm9ybSwgaW50ZXJwb2xhdG9yID0gaWRlbnRpdHksIGNsYW1wID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiBpbnRlcnBvbGF0b3IoazEwID09PSAwID8gMC41IDogKHgyID0gKHRyYW5zZm9ybSh4MikgLSB0MDIpICogazEwLCBjbGFtcCA/IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHgyKSkgOiB4MikpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbeDAsIHgxXSA9IF8sIHQwMiA9IHRyYW5zZm9ybSh4MCA9ICt4MCksIHQxMiA9IHRyYW5zZm9ybSh4MSA9ICt4MSksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDEgLyAodDEyIC0gdDAyKSwgc2NhbGUpIDogW3gwLCB4MV07CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gISFfLCBzY2FsZSkgOiBjbGFtcDsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIGZ1bmN0aW9uIHJhbmdlNChpbnRlcnBvbGF0ZTIpIHsKICAgIHJldHVybiBmdW5jdGlvbihfKSB7CiAgICAgIHZhciByMCwgcjE7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFtyMCwgcjFdID0gXywgaW50ZXJwb2xhdG9yID0gaW50ZXJwb2xhdGUyKHIwLCByMSksIHNjYWxlKSA6IFtpbnRlcnBvbGF0b3IoMCksIGludGVycG9sYXRvcigxKV07CiAgICB9OwogIH0KICBzY2FsZS5yYW5nZSA9IHJhbmdlNCh2YWx1ZV9kZWZhdWx0KTsKICBzY2FsZS5yYW5nZVJvdW5kID0gcmFuZ2U0KHJvdW5kX2RlZmF1bHQpOwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB0MDIgPSB0KHgwKSwgdDEyID0gdCh4MSksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDEgLyAodDEyIC0gdDAyKTsKICAgIHJldHVybiBzY2FsZTsKICB9Owp9CmZ1bmN0aW9uIGNvcHkyKHNvdXJjZSwgdGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldC5kb21haW4oc291cmNlLmRvbWFpbigpKS5pbnRlcnBvbGF0b3Ioc291cmNlLmludGVycG9sYXRvcigpKS5jbGFtcChzb3VyY2UuY2xhbXAoKSkudW5rbm93bihzb3VyY2UudW5rbm93bigpKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsKCkgewogIHZhciBzY2FsZSA9IGxpbmVhcmlzaCh0cmFuc2Zvcm1lcjIoKShpZGVudGl0eSkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxMb2coKSB7CiAgdmFyIHNjYWxlID0gbG9nZ2lzaCh0cmFuc2Zvcm1lcjIoKSkuZG9tYWluKFsxLCAxMF0pOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbExvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsU3ltbG9nKCkgewogIHZhciBzY2FsZSA9IHN5bWxvZ2lzaCh0cmFuc2Zvcm1lcjIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBzZXF1ZW50aWFsU3ltbG9nKCkpLmNvbnN0YW50KHNjYWxlLmNvbnN0YW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbFBvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbFBvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxTcXJ0KCkgewogIHJldHVybiBzZXF1ZW50aWFsUG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zZXF1ZW50aWFsUXVhbnRpbGUuanMKZnVuY3Rpb24gc2VxdWVudGlhbFF1YW50aWxlKCkgewogIHZhciBkb21haW4gPSBbXSwgaW50ZXJwb2xhdG9yID0gaWRlbnRpdHk7CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIGlmICh4MiAhPSBudWxsICYmICFpc05hTih4MiA9ICt4MikpIHJldHVybiBpbnRlcnBvbGF0b3IoKGJpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDEpIC0gMSkgLyAoZG9tYWluLmxlbmd0aCAtIDEpKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgICBkb21haW4gPSBbXTsKICAgIGZvciAobGV0IGQgb2YgXykgaWYgKGQgIT0gbnVsbCAmJiAhaXNOYU4oZCA9ICtkKSkgZG9tYWluLnB1c2goZCk7CiAgICBkb21haW4uc29ydChhc2NlbmRpbmcpOwogICAgcmV0dXJuIHNjYWxlOwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdG9yID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaW50ZXJwb2xhdG9yID0gXywgc2NhbGUpIDogaW50ZXJwb2xhdG9yOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBkb21haW4ubWFwKChkLCBpKSA9PiBpbnRlcnBvbGF0b3IoaSAvIChkb21haW4ubGVuZ3RoIC0gMSkpKTsKICB9OwogIHNjYWxlLnF1YW50aWxlcyA9IGZ1bmN0aW9uKG4pIHsKICAgIHJldHVybiBBcnJheS5mcm9tKHsgbGVuZ3RoOiBuICsgMSB9LCAoXywgaSkgPT4gcXVhbnRpbGUoZG9tYWluLCBpIC8gbikpOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlcXVlbnRpYWxRdWFudGlsZShpbnRlcnBvbGF0b3IpLmRvbWFpbihkb21haW4pOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvZGl2ZXJnaW5nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybWVyMygpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDAuNSwgeDIgPSAxLCBzMiA9IDEsIHQwMiwgdDEyLCB0MiwgazEwLCBrMjEsIGludGVycG9sYXRvciA9IGlkZW50aXR5LCB0cmFuc2Zvcm0sIGNsYW1wID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDMpIHsKICAgIHJldHVybiBpc05hTih4MyA9ICt4MykgPyB1bmtub3duIDogKHgzID0gMC41ICsgKCh4MyA9ICt0cmFuc2Zvcm0oeDMpKSAtIHQxMikgKiAoczIgKiB4MyA8IHMyICogdDEyID8gazEwIDogazIxKSwgaW50ZXJwb2xhdG9yKGNsYW1wID8gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgeDMpKSA6IHgzKSk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFt4MCwgeDEsIHgyXSA9IF8sIHQwMiA9IHRyYW5zZm9ybSh4MCA9ICt4MCksIHQxMiA9IHRyYW5zZm9ybSh4MSA9ICt4MSksIHQyID0gdHJhbnNmb3JtKHgyID0gK3gyKSwgazEwID0gdDAyID09PSB0MTIgPyAwIDogMC41IC8gKHQxMiAtIHQwMiksIGsyMSA9IHQxMiA9PT0gdDIgPyAwIDogMC41IC8gKHQyIC0gdDEyKSwgczIgPSB0MTIgPCB0MDIgPyAtMSA6IDEsIHNjYWxlKSA6IFt4MCwgeDEsIHgyXTsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY2xhbXAgPSAhIV8sIHNjYWxlKSA6IGNsYW1wOwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdG9yID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaW50ZXJwb2xhdG9yID0gXywgc2NhbGUpIDogaW50ZXJwb2xhdG9yOwogIH07CiAgZnVuY3Rpb24gcmFuZ2U0KGludGVycG9sYXRlMikgewogICAgcmV0dXJuIGZ1bmN0aW9uKF8pIHsKICAgICAgdmFyIHIwLCByMSwgcjI7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFtyMCwgcjEsIHIyXSA9IF8sIGludGVycG9sYXRvciA9IHBpZWNld2lzZShpbnRlcnBvbGF0ZTIsIFtyMCwgcjEsIHIyXSksIHNjYWxlKSA6IFtpbnRlcnBvbGF0b3IoMCksIGludGVycG9sYXRvcigwLjUpLCBpbnRlcnBvbGF0b3IoMSldOwogICAgfTsKICB9CiAgc2NhbGUucmFuZ2UgPSByYW5nZTQodmFsdWVfZGVmYXVsdCk7CiAgc2NhbGUucmFuZ2VSb3VuZCA9IHJhbmdlNChyb3VuZF9kZWZhdWx0KTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdHJhbnNmb3JtID0gdCwgdDAyID0gdCh4MCksIHQxMiA9IHQoeDEpLCB0MiA9IHQoeDIpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAwLjUgLyAodDEyIC0gdDAyKSwgazIxID0gdDEyID09PSB0MiA/IDAgOiAwLjUgLyAodDIgLSB0MTIpLCBzMiA9IHQxMiA8IHQwMiA/IC0xIDogMTsKICAgIHJldHVybiBzY2FsZTsKICB9Owp9CmZ1bmN0aW9uIGRpdmVyZ2luZygpIHsKICB2YXIgc2NhbGUgPSBsaW5lYXJpc2godHJhbnNmb3JtZXIzKCkoaWRlbnRpdHkpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZygpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ0xvZygpIHsKICB2YXIgc2NhbGUgPSBsb2dnaXNoKHRyYW5zZm9ybWVyMygpKS5kb21haW4oWzAuMSwgMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ0xvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdTeW1sb2coKSB7CiAgdmFyIHNjYWxlID0gc3ltbG9naXNoKHRyYW5zZm9ybWVyMygpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ1N5bWxvZygpKS5jb25zdGFudChzY2FsZS5jb25zdGFudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ1BvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIzKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgZGl2ZXJnaW5nUG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nU3FydCgpIHsKICByZXR1cm4gZGl2ZXJnaW5nUG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvZGF0YVNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMgPSAoc3RhdGUpID0+IHN0YXRlLmNoYXJ0RGF0YTsKdmFyIHNlbGVjdENoYXJ0RGF0YUFuZEFsd2F5c0lnbm9yZUluZGV4ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNdLCAoZGF0YVN0YXRlKSA9PiB7CiAgdmFyIGRhdGFFbmRJbmRleCA9IGRhdGFTdGF0ZS5jaGFydERhdGEgIT0gbnVsbCA/IGRhdGFTdGF0ZS5jaGFydERhdGEubGVuZ3RoIC0gMSA6IDA7CiAgcmV0dXJuIHsKICAgIGNoYXJ0RGF0YTogZGF0YVN0YXRlLmNoYXJ0RGF0YSwKICAgIGNvbXB1dGVkRGF0YTogZGF0YVN0YXRlLmNvbXB1dGVkRGF0YSwKICAgIGRhdGFFbmRJbmRleCwKICAgIGRhdGFTdGFydEluZGV4OiAwCiAgfTsKfSk7CnZhciBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc0lmTm90SW5QYW5vcmFtYSA9IChzdGF0ZSwgX3VudXNlZDEsIF91bnVzZWQyLCBpc1Bhbm9yYW1hKSA9PiB7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBzZWxlY3RDaGFydERhdGFBbmRBbHdheXNJZ25vcmVJbmRleGVzKHN0YXRlKTsKICB9CiAgcmV0dXJuIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzKHN0YXRlKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9pc0RvbWFpblNwZWNpZmllZEJ5VXNlci5qcwpmdW5jdGlvbiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4odikgewogIGlmIChBcnJheS5pc0FycmF5KHYpICYmIHYubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW21pbjIsIG1heDJdID0gdjsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKG1pbjIpICYmIGlzV2VsbEJlaGF2ZWROdW1iZXIobWF4MikpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBleHRlbmREb21haW4ocHJvdmlkZWREb21haW4sIGJvdW5kYXJ5RG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdykgewogIGlmIChhbGxvd0RhdGFPdmVyZmxvdykgewogICAgcmV0dXJuIHByb3ZpZGVkRG9tYWluOwogIH0KICByZXR1cm4gW01hdGgubWluKHByb3ZpZGVkRG9tYWluWzBdLCBib3VuZGFyeURvbWFpblswXSksIE1hdGgubWF4KHByb3ZpZGVkRG9tYWluWzFdLCBib3VuZGFyeURvbWFpblsxXSldOwp9CmZ1bmN0aW9uIG51bWVyaWNhbERvbWFpblNwZWNpZmllZFdpdGhvdXRSZXF1aXJpbmdEYXRhKHVzZXJEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KSB7CiAgaWYgKCFhbGxvd0RhdGFPdmVyZmxvdykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiB1c2VyRG9tYWluID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyRG9tYWluKSAmJiB1c2VyRG9tYWluLmxlbmd0aCA9PT0gMikgewogICAgdmFyIFtwcm92aWRlZE1pbiwgcHJvdmlkZWRNYXhdID0gdXNlckRvbWFpbjsKICAgIHZhciBmaW5hbE1pbiwgZmluYWxNYXg7CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihwcm92aWRlZE1pbikpIHsKICAgICAgZmluYWxNaW4gPSBwcm92aWRlZE1pbjsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWluID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihwcm92aWRlZE1heCkpIHsKICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB2YXIgY2FuZGlkYXRlID0gW2ZpbmFsTWluLCBmaW5hbE1heF07CiAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGNhbmRpZGF0ZSkpIHsKICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgIH0KICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBwYXJzZU51bWVyaWNhbFVzZXJEb21haW4odXNlckRvbWFpbiwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICBpZiAoIWFsbG93RGF0YU92ZXJmbG93ICYmIGRhdGFEb21haW4gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiB1c2VyRG9tYWluID09PSAiZnVuY3Rpb24iICYmIGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgdHJ5IHsKICAgICAgdmFyIHJlc3VsdCA9IHVzZXJEb21haW4oZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKHJlc3VsdCkpIHsKICAgICAgICByZXR1cm4gZXh0ZW5kRG9tYWluKHJlc3VsdCwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgICB9CiAgICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICB9CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHVzZXJEb21haW4pICYmIHVzZXJEb21haW4ubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW3Byb3ZpZGVkTWluLCBwcm92aWRlZE1heF0gPSB1c2VyRG9tYWluOwogICAgdmFyIGZpbmFsTWluLCBmaW5hbE1heDsKICAgIGlmIChwcm92aWRlZE1pbiA9PT0gImF1dG8iKSB7CiAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICBmaW5hbE1pbiA9IE1hdGgubWluKC4uLmRhdGFEb21haW4pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKHByb3ZpZGVkTWluKSkgewogICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNaW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdHJ5IHsKICAgICAgICBpZiAoZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluKGRhdGFEb21haW4gPT09IG51bGwgfHwgZGF0YURvbWFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YURvbWFpblswXSk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChfdW51c2VkMikgewogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1pbiA9PT0gInN0cmluZyIgJiYgTUlOX1ZBTFVFX1JFRy50ZXN0KHByb3ZpZGVkTWluKSkgewogICAgICB2YXIgbWF0Y2ggPSBNSU5fVkFMVUVfUkVHLmV4ZWMocHJvdmlkZWRNaW4pOwogICAgICBpZiAobWF0Y2ggPT0gbnVsbCB8fCBkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICBmaW5hbE1pbiA9IHZvaWQgMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdmFsdWUgPSArbWF0Y2hbMV07CiAgICAgICAgZmluYWxNaW4gPSBkYXRhRG9tYWluWzBdIC0gdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZpbmFsTWluID0gZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzBdOwogICAgfQogICAgaWYgKHByb3ZpZGVkTWF4ID09PSAiYXV0byIpIHsKICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgIGZpbmFsTWF4ID0gTWF0aC5tYXgoLi4uZGF0YURvbWFpbik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIocHJvdmlkZWRNYXgpKSB7CiAgICAgIGZpbmFsTWF4ID0gcHJvdmlkZWRNYXg7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1heCA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cnkgewogICAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICAgIGZpbmFsTWF4ID0gcHJvdmlkZWRNYXgoZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzFdKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKF91bnVzZWQzKSB7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAic3RyaW5nIiAmJiBNQVhfVkFMVUVfUkVHLnRlc3QocHJvdmlkZWRNYXgpKSB7CiAgICAgIHZhciBfbWF0Y2ggPSBNQVhfVkFMVUVfUkVHLmV4ZWMocHJvdmlkZWRNYXgpOwogICAgICBpZiAoX21hdGNoID09IG51bGwgfHwgZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICAgICAgZmluYWxNYXggPSB2b2lkIDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF92YWx1ZSA9ICtfbWF0Y2hbMV07CiAgICAgICAgZmluYWxNYXggPSBkYXRhRG9tYWluWzFdICsgX3ZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmaW5hbE1heCA9IGRhdGFEb21haW4gPT09IG51bGwgfHwgZGF0YURvbWFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YURvbWFpblsxXTsKICAgIH0KICAgIHZhciBjYW5kaWRhdGUgPSBbZmluYWxNaW4sIGZpbmFsTWF4XTsKICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oY2FuZGlkYXRlKSkgewogICAgICBpZiAoZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gZXh0ZW5kRG9tYWluKGNhbmRpZGF0ZSwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgfQogIH0KICByZXR1cm4gdm9pZCAwOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvZ2V0TmljZVRpY2tWYWx1ZXMuanMKdmFyIGltcG9ydF9kZWNpbWFsMiA9IF9fdG9FU00ocmVxdWlyZV9kZWNpbWFsKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3NjYWxlL3V0aWwvdXRpbHMuanMKdmFyIGlkZW50aXR5MyA9IChpKSA9PiBpOwp2YXIgUExBQ0VfSE9MREVSID0gewogICJAQGZ1bmN0aW9uYWwvcGxhY2Vob2xkZXIiOiB0cnVlCn07CnZhciBpc1BsYWNlSG9sZGVyID0gKHZhbCkgPT4gdmFsID09PSBQTEFDRV9IT0xERVI7CnZhciBjdXJyeTAgPSAoZm4pID0+IGZ1bmN0aW9uIF9jdXJyaWVkKCkgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwIHx8IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgaXNQbGFjZUhvbGRlcihhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB2b2lkIDAgOiBhcmd1bWVudHNbMF0pKSB7CiAgICByZXR1cm4gX2N1cnJpZWQ7CiAgfQogIHJldHVybiBmbiguLi5hcmd1bWVudHMpOwp9Owp2YXIgY3VycnlOID0gKG4sIGZuKSA9PiB7CiAgaWYgKG4gPT09IDEpIHsKICAgIHJldHVybiBmbjsKICB9CiAgcmV0dXJuIGN1cnJ5MChmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgfQogICAgdmFyIGFyZ3NMZW5ndGggPSBhcmdzLmZpbHRlcigoYXJnKSA9PiBhcmcgIT09IFBMQUNFX0hPTERFUikubGVuZ3RoOwogICAgaWYgKGFyZ3NMZW5ndGggPj0gbikgewogICAgICByZXR1cm4gZm4oLi4uYXJncyk7CiAgICB9CiAgICByZXR1cm4gY3VycnlOKG4gLSBhcmdzTGVuZ3RoLCBjdXJyeTAoZnVuY3Rpb24oKSB7CiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgcmVzdEFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIpLCBfa2V5MiA9IDA7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICByZXN0QXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CiAgICAgIHZhciBuZXdBcmdzID0gYXJncy5tYXAoKGFyZykgPT4gaXNQbGFjZUhvbGRlcihhcmcpID8gcmVzdEFyZ3Muc2hpZnQoKSA6IGFyZyk7CiAgICAgIHJldHVybiBmbiguLi5uZXdBcmdzLCAuLi5yZXN0QXJncyk7CiAgICB9KSk7CiAgfSk7Cn07CnZhciBjdXJyeSA9IChmbikgPT4gY3VycnlOKGZuLmxlbmd0aCwgZm4pOwp2YXIgcmFuZ2UyID0gKGJlZ2luLCBlbmQpID0+IHsKICB2YXIgYXJyID0gW107CiAgZm9yICh2YXIgaSA9IGJlZ2luOyBpIDwgZW5kOyArK2kpIHsKICAgIGFycltpIC0gYmVnaW5dID0gaTsKICB9CiAgcmV0dXJuIGFycjsKfTsKdmFyIG1hcDIgPSBjdXJyeSgoZm4sIGFycikgPT4gewogIGlmIChBcnJheS5pc0FycmF5KGFycikpIHsKICAgIHJldHVybiBhcnIubWFwKGZuKTsKICB9CiAgcmV0dXJuIE9iamVjdC5rZXlzKGFycikubWFwKChrZXkpID0+IGFycltrZXldKS5tYXAoZm4pOwp9KTsKdmFyIGNvbXBvc2UyID0gZnVuY3Rpb24gY29tcG9zZTMoKSB7CiAgZm9yICh2YXIgX2xlbjMgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4zKSwgX2tleTMgPSAwOyBfa2V5MyA8IF9sZW4zOyBfa2V5MysrKSB7CiAgICBhcmdzW19rZXkzXSA9IGFyZ3VtZW50c1tfa2V5M107CiAgfQogIGlmICghYXJncy5sZW5ndGgpIHsKICAgIHJldHVybiBpZGVudGl0eTM7CiAgfQogIHZhciBmbnMgPSBhcmdzLnJldmVyc2UoKTsKICB2YXIgZmlyc3RGbiA9IGZuc1swXTsKICB2YXIgdGFpbHNGbiA9IGZucy5zbGljZSgxKTsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGFpbHNGbi5yZWR1Y2UoKHJlcywgZm4pID0+IGZuKHJlcyksIGZpcnN0Rm4oLi4uYXJndW1lbnRzKSk7CiAgfTsKfTsKdmFyIHJldmVyc2UgPSAoYXJyKSA9PiB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgcmV0dXJuIGFyci5yZXZlcnNlKCk7CiAgfQogIHJldHVybiBhcnIuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS91dGlsL2FyaXRobWV0aWMuanMKdmFyIGltcG9ydF9kZWNpbWFsID0gX190b0VTTShyZXF1aXJlX2RlY2ltYWwoKSk7CmZ1bmN0aW9uIGdldERpZ2l0Q291bnQodmFsdWUpIHsKICB2YXIgcmVzdWx0OwogIGlmICh2YWx1ZSA9PT0gMCkgewogICAgcmVzdWx0ID0gMTsKICB9IGVsc2UgewogICAgcmVzdWx0ID0gTWF0aC5mbG9vcihuZXcgaW1wb3J0X2RlY2ltYWwuZGVmYXVsdCh2YWx1ZSkuYWJzKCkubG9nKDEwKS50b051bWJlcigpKSArIDE7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gcmFuZ2VTdGVwKHN0YXJ0LCBlbmQsIHN0ZXApIHsKICB2YXIgbnVtID0gbmV3IGltcG9ydF9kZWNpbWFsLmRlZmF1bHQoc3RhcnQpOwogIHZhciBpID0gMDsKICB2YXIgcmVzdWx0ID0gW107CiAgd2hpbGUgKG51bS5sdChlbmQpICYmIGkgPCAxZTUpIHsKICAgIHJlc3VsdC5wdXNoKG51bS50b051bWJlcigpKTsKICAgIG51bSA9IG51bS5hZGQoc3RlcCk7CiAgICBpKys7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS9nZXROaWNlVGlja1ZhbHVlcy5qcwp2YXIgZ2V0VmFsaWRJbnRlcnZhbCA9IChfcmVmMikgPT4gewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMjsKICB2YXIgW3ZhbGlkTWluLCB2YWxpZE1heF0gPSBbbWluMiwgbWF4Ml07CiAgaWYgKG1pbjIgPiBtYXgyKSB7CiAgICBbdmFsaWRNaW4sIHZhbGlkTWF4XSA9IFttYXgyLCBtaW4yXTsKICB9CiAgcmV0dXJuIFt2YWxpZE1pbiwgdmFsaWRNYXhdOwp9Owp2YXIgZ2V0Rm9ybWF0U3RlcCA9IChyb3VnaFN0ZXAsIGFsbG93RGVjaW1hbHMsIGNvcnJlY3Rpb25GYWN0b3IpID0+IHsKICBpZiAocm91Z2hTdGVwLmx0ZSgwKSkgewogICAgcmV0dXJuIG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKTsKICB9CiAgdmFyIGRpZ2l0Q291bnQgPSBnZXREaWdpdENvdW50KHJvdWdoU3RlcC50b051bWJlcigpKTsKICB2YXIgZGlnaXRDb3VudFZhbHVlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEwKS5wb3coZGlnaXRDb3VudCk7CiAgdmFyIHN0ZXBSYXRpbyA9IHJvdWdoU3RlcC5kaXYoZGlnaXRDb3VudFZhbHVlKTsKICB2YXIgc3RlcFJhdGlvU2NhbGUgPSBkaWdpdENvdW50ICE9PSAxID8gMC4wNSA6IDAuMTsKICB2YXIgYW1lbmRTdGVwUmF0aW8gPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5jZWlsKHN0ZXBSYXRpby5kaXYoc3RlcFJhdGlvU2NhbGUpLnRvTnVtYmVyKCkpKS5hZGQoY29ycmVjdGlvbkZhY3RvcikubXVsKHN0ZXBSYXRpb1NjYWxlKTsKICB2YXIgZm9ybWF0U3RlcCA9IGFtZW5kU3RlcFJhdGlvLm11bChkaWdpdENvdW50VmFsdWUpOwogIHJldHVybiBhbGxvd0RlY2ltYWxzID8gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGZvcm1hdFN0ZXAudG9OdW1iZXIoKSkgOiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5jZWlsKGZvcm1hdFN0ZXAudG9OdW1iZXIoKSkpOwp9Owp2YXIgZ2V0VGlja09mU2luZ2xlVmFsdWUgPSAodmFsdWUsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscykgPT4gewogIHZhciBzdGVwID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEpOwogIHZhciBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQodmFsdWUpOwogIGlmICghbWlkZGxlLmlzaW50KCkgJiYgYWxsb3dEZWNpbWFscykgewogICAgdmFyIGFic1ZhbCA9IE1hdGguYWJzKHZhbHVlKTsKICAgIGlmIChhYnNWYWwgPCAxKSB7CiAgICAgIHN0ZXAgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMTApLnBvdyhnZXREaWdpdENvdW50KHZhbHVlKSAtIDEpOwogICAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcihtaWRkbGUuZGl2KHN0ZXApLnRvTnVtYmVyKCkpKS5tdWwoc3RlcCk7CiAgICB9IGVsc2UgaWYgKGFic1ZhbCA+IDEpIHsKICAgICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IodmFsdWUpKTsKICAgIH0KICB9IGVsc2UgaWYgKHZhbHVlID09PSAwKSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcigodGlja0NvdW50IC0gMSkgLyAyKSk7CiAgfSBlbHNlIGlmICghYWxsb3dEZWNpbWFscykgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IodmFsdWUpKTsKICB9CiAgdmFyIG1pZGRsZUluZGV4ID0gTWF0aC5mbG9vcigodGlja0NvdW50IC0gMSkgLyAyKTsKICB2YXIgZm4gPSBjb21wb3NlMihtYXAyKChuKSA9PiBtaWRkbGUuYWRkKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChuIC0gbWlkZGxlSW5kZXgpLm11bChzdGVwKSkudG9OdW1iZXIoKSksIHJhbmdlMik7CiAgcmV0dXJuIGZuKDAsIHRpY2tDb3VudCk7Cn07CnZhciBfY2FsY3VsYXRlU3RlcCA9IGZ1bmN0aW9uIGNhbGN1bGF0ZVN0ZXAobWluMiwgbWF4MiwgdGlja0NvdW50LCBhbGxvd0RlY2ltYWxzKSB7CiAgdmFyIGNvcnJlY3Rpb25GYWN0b3IgPSBhcmd1bWVudHMubGVuZ3RoID4gNCAmJiBhcmd1bWVudHNbNF0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1s0XSA6IDA7CiAgaWYgKCFOdW1iZXIuaXNGaW5pdGUoKG1heDIgLSBtaW4yKSAvICh0aWNrQ291bnQgLSAxKSkpIHsKICAgIHJldHVybiB7CiAgICAgIHN0ZXA6IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKSwKICAgICAgdGlja01pbjogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApLAogICAgICB0aWNrTWF4OiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCkKICAgIH07CiAgfQogIHZhciBzdGVwID0gZ2V0Rm9ybWF0U3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWF4Mikuc3ViKG1pbjIpLmRpdih0aWNrQ291bnQgLSAxKSwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3Rvcik7CiAgdmFyIG1pZGRsZTsKICBpZiAobWluMiA8PSAwICYmIG1heDIgPj0gMCkgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApOwogIH0gZWxzZSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWluMikuYWRkKG1heDIpLmRpdigyKTsKICAgIG1pZGRsZSA9IG1pZGRsZS5zdWIobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1pZGRsZSkubW9kKHN0ZXApKTsKICB9CiAgdmFyIGJlbG93Q291bnQgPSBNYXRoLmNlaWwobWlkZGxlLnN1YihtaW4yKS5kaXYoc3RlcCkudG9OdW1iZXIoKSk7CiAgdmFyIHVwQ291bnQgPSBNYXRoLmNlaWwobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1heDIpLnN1YihtaWRkbGUpLmRpdihzdGVwKS50b051bWJlcigpKTsKICB2YXIgc2NhbGVDb3VudCA9IGJlbG93Q291bnQgKyB1cENvdW50ICsgMTsKICBpZiAoc2NhbGVDb3VudCA+IHRpY2tDb3VudCkgewogICAgcmV0dXJuIF9jYWxjdWxhdGVTdGVwKG1pbjIsIG1heDIsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3RvciArIDEpOwogIH0KICBpZiAoc2NhbGVDb3VudCA8IHRpY2tDb3VudCkgewogICAgdXBDb3VudCA9IG1heDIgPiAwID8gdXBDb3VudCArICh0aWNrQ291bnQgLSBzY2FsZUNvdW50KSA6IHVwQ291bnQ7CiAgICBiZWxvd0NvdW50ID0gbWF4MiA+IDAgPyBiZWxvd0NvdW50IDogYmVsb3dDb3VudCArICh0aWNrQ291bnQgLSBzY2FsZUNvdW50KTsKICB9CiAgcmV0dXJuIHsKICAgIHN0ZXAsCiAgICB0aWNrTWluOiBtaWRkbGUuc3ViKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChiZWxvd0NvdW50KS5tdWwoc3RlcCkpLAogICAgdGlja01heDogbWlkZGxlLmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQodXBDb3VudCkubXVsKHN0ZXApKQogIH07Cn07CnZhciBnZXROaWNlVGlja1ZhbHVlcyA9IGZ1bmN0aW9uIGdldE5pY2VUaWNrVmFsdWVzMihfcmVmMikgewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMjsKICB2YXIgdGlja0NvdW50ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiA2OwogIHZhciBhbGxvd0RlY2ltYWxzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB0cnVlOwogIHZhciBjb3VudCA9IE1hdGgubWF4KHRpY2tDb3VudCwgMik7CiAgdmFyIFtjb3JtaW4sIGNvcm1heF0gPSBnZXRWYWxpZEludGVydmFsKFttaW4yLCBtYXgyXSk7CiAgaWYgKGNvcm1pbiA9PT0gLUluZmluaXR5IHx8IGNvcm1heCA9PT0gSW5maW5pdHkpIHsKICAgIHZhciBfdmFsdWVzID0gY29ybWF4ID09PSBJbmZpbml0eSA/IFtjb3JtaW4sIC4uLnJhbmdlMigwLCB0aWNrQ291bnQgLSAxKS5tYXAoKCkgPT4gSW5maW5pdHkpXSA6IFsuLi5yYW5nZTIoMCwgdGlja0NvdW50IC0gMSkubWFwKCgpID0+IC1JbmZpbml0eSksIGNvcm1heF07CiAgICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKF92YWx1ZXMpIDogX3ZhbHVlczsKICB9CiAgaWYgKGNvcm1pbiA9PT0gY29ybWF4KSB7CiAgICByZXR1cm4gZ2V0VGlja09mU2luZ2xlVmFsdWUoY29ybWluLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMpOwogIH0KICB2YXIgewogICAgc3RlcCwKICAgIHRpY2tNaW4sCiAgICB0aWNrTWF4CiAgfSA9IF9jYWxjdWxhdGVTdGVwKGNvcm1pbiwgY29ybWF4LCBjb3VudCwgYWxsb3dEZWNpbWFscywgMCk7CiAgdmFyIHZhbHVlcyA9IHJhbmdlU3RlcCh0aWNrTWluLCB0aWNrTWF4LmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMC4xKS5tdWwoc3RlcCkpLCBzdGVwKTsKICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKHZhbHVlcykgOiB2YWx1ZXM7Cn07CnZhciBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4gPSBmdW5jdGlvbiBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4yKF9yZWYzLCB0aWNrQ291bnQpIHsKICB2YXIgW21pbjIsIG1heDJdID0gX3JlZjM7CiAgdmFyIGFsbG93RGVjaW1hbHMgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IHRydWU7CiAgdmFyIFtjb3JtaW4sIGNvcm1heF0gPSBnZXRWYWxpZEludGVydmFsKFttaW4yLCBtYXgyXSk7CiAgaWYgKGNvcm1pbiA9PT0gLUluZmluaXR5IHx8IGNvcm1heCA9PT0gSW5maW5pdHkpIHsKICAgIHJldHVybiBbbWluMiwgbWF4Ml07CiAgfQogIGlmIChjb3JtaW4gPT09IGNvcm1heCkgewogICAgcmV0dXJuIFtjb3JtaW5dOwogIH0KICB2YXIgY291bnQgPSBNYXRoLm1heCh0aWNrQ291bnQsIDIpOwogIHZhciBzdGVwID0gZ2V0Rm9ybWF0U3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoY29ybWF4KS5zdWIoY29ybWluKS5kaXYoY291bnQgLSAxKSwgYWxsb3dEZWNpbWFscywgMCk7CiAgdmFyIHZhbHVlcyA9IFsuLi5yYW5nZVN0ZXAobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGNvcm1pbiksIG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChjb3JtYXgpLCBzdGVwKSwgY29ybWF4XTsKICBpZiAoYWxsb3dEZWNpbWFscyA9PT0gZmFsc2UpIHsKICAgIHZhbHVlcyA9IHZhbHVlcy5tYXAoKHZhbHVlKSA9PiBNYXRoLnJvdW5kKHZhbHVlKSk7CiAgfQogIHJldHVybiBtaW4yID4gbWF4MiA/IHJldmVyc2UodmFsdWVzKSA6IHZhbHVlczsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3Jvb3RQcm9wc1NlbGVjdG9ycy5qcwp2YXIgc2VsZWN0QmFyQ2F0ZWdvcnlHYXAgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5iYXJDYXRlZ29yeUdhcDsKdmFyIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnN0YWNrT2Zmc2V0Owp2YXIgc2VsZWN0UmV2ZXJzZVN0YWNrT3JkZXIgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5yZXZlcnNlU3RhY2tPcmRlcjsKdmFyIHNlbGVjdENoYXJ0TmFtZSA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy5jaGFydE5hbWU7CnZhciBzZWxlY3RTeW5jSWQgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5zeW5jSWQ7CnZhciBzZWxlY3RTeW5jTWV0aG9kID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuc3luY01ldGhvZDsKdmFyIHNlbGVjdEV2ZW50RW1pdHRlciA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy5ldmVudEVtaXR0ZXI7CnZhciBzZWxlY3RDaGFydEJhc2VWYWx1ZSA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLmJhc2VWYWx1ZTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L0RlZmF1bHRaSW5kZXhlcy5qcwp2YXIgRGVmYXVsdFpJbmRleGVzID0gewogIC8qKgogICAqIENhcnRlc2lhbkdyaWQgYW5kIFBvbGFyR3JpZAogICAqLwogIGdyaWQ6IC0xMDAsCiAgLyoqCiAgICogQmFja2dyb3VuZCBvZiBCYXIgYW5kIFJhZGlhbEJhci4KICAgKiBUaGlzIGlzIG5vdCB2aXNpYmxlIGJ5IGRlZmF1bHQgYnV0IGNhbiBiZSBlbmFibGVkIGJ5IHNldHRpbmcgYmFja2dyb3VuZD17dHJ1ZX0gb24gQmFyIG9yIFJhZGlhbEJhci4KICAgKi8KICBiYXJCYWNrZ3JvdW5kOiAtNTAsCiAgLyoKICAgKiBvdGhlciBjaGFydCBlbGVtZW50cyBvciBjdXN0b20gZWxlbWVudHMgd2l0aG91dCBzcGVjaWZpYyB6SW5kZXgKICAgKiByZW5kZXIgaW4gaGVyZSwgYXQgekluZGV4IDAKICAgKi8KICAvKioKICAgKiBBcmVhLCBQaWUsIFJhZGFyLCBhbmQgUmVmZXJlbmNlQXJlYQogICAqLwogIGFyZWE6IDEwMCwKICAvKioKICAgKiBDdXJzb3IgaXMgZW1iZWRkZWQgaW5zaWRlIFRvb2x0aXAgYW5kIGNvbnRyb2xsZWQgYnkgaXQuCiAgICogVGhlIFRvb2x0aXAgaXRzZWxmIGhhcyBhIHNlcGFyYXRlIHBvcnRhbCBhbmQgaXMgbm90IGluY2x1ZGVkIGluIHRoZSB6SW5kZXggc3lzdGVtOwogICAqIEN1cnNvciBpcyB0aGUgZGVjb3JhdGlvbiBpbnNpZGUgdGhlIGNoYXJ0IGFyZWEuIEN1cnNvclJlY3RhbmdsZSBpcyBhIHJlY3RhbmdsZSBib3guCiAgICogSXQgcmVuZGVycyBiZWxvdyBiYXIgc28gdGhhdCBpbiBhIHN0YWNrZWQgYmFyIGNoYXJ0IHRoZSBjdXJzb3IgcmVjdGFuZ2xlIGRvZXMgbm90IGhpZGUgdGhlIG90aGVyIGJhcnMuCiAgICovCiAgY3Vyc29yUmVjdGFuZ2xlOiAyMDAsCiAgLyoqCiAgICogQmFyIGFuZCBSYWRpYWxCYXIKICAgKi8KICBiYXI6IDMwMCwKICAvKioKICAgKiBMaW5lIGFuZCBSZWZlcmVuY2VMaW5lLCBhbmQgRXJyb3JCb3IKICAgKi8KICBsaW5lOiA0MDAsCiAgLyoqCiAgICogWEF4aXMgYW5kIFlBeGlzIGFuZCBQb2xhckFuZ2xlQXhpcyBhbmQgUG9sYXJSYWRpdXNBeGlzIHRpY2tzIGFuZCBsaW5lcyBhbmQgY2hpbGRyZW4KICAgKi8KICBheGlzOiA1MDAsCiAgLyoqCiAgICogU2NhdHRlciBhbmQgUmVmZXJlbmNlRG90LAogICAqIGFuZCBEb3RzIG9mIExpbmUgYW5kIEFyZWEgYW5kIFJhZGFyIGlmIHRoZXkgaGF2ZSBkb3Q9dHJ1ZQogICAqLwogIHNjYXR0ZXI6IDYwMCwKICAvKioKICAgKiBIb3ZlcmluZyBvdmVyIGEgQmFyIG9yIFJhZGlhbEJhciByZW5kZXJzIGEgaGlnaGxpZ2h0IHJlY3RhbmdsZQogICAqLwogIGFjdGl2ZUJhcjogMWUzLAogIC8qKgogICAqIEN1cnNvciBpcyBlbWJlZGRlZCBpbnNpZGUgVG9vbHRpcCBhbmQgY29udHJvbGxlZCBieSBpdC4KICAgKiBUaGUgVG9vbHRpcCBpdHNlbGYgaGFzIGEgc2VwYXJhdGUgcG9ydGFsIGFuZCBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHpJbmRleCBzeXN0ZW07CiAgICogQ3Vyc29yIGlzIHRoZSBkZWNvcmF0aW9uIGluc2lkZSB0aGUgY2hhcnQgYXJlYSwgdXN1YWxseSBhIGNyb3NzIG9yIGEgYm94LgogICAqIEN1cnNvckxpbmUgaXMgYSBsaW5lIGN1cnNvciByZW5kZXJlZCBpbiBMaW5lLCBBcmVhLCBTY2F0dGVyLCBSYWRhciBjaGFydHMuCiAgICogSXQgcmVuZGVycyBhYm92ZSB0aGUgTGluZSBhbmQgU2NhdHRlciBzbyB0aGF0IGl0IGlzIGFsd2F5cyB2aXNpYmxlLgogICAqIEl0IHJlbmRlcnMgYmVsb3cgYWN0aXZlIGRvdCBzbyB0aGF0IHRoZSBkb3QgaXMgYWx3YXlzIHZpc2libGUgYW5kIHNob3dzIHRoZSBjdXJyZW50IHBvaW50LgogICAqIFdlJ3JlIGFsc28gYXNzdW1pbmcgdGhhdCB0aGUgYWN0aXZlIGRvdCBpcyBzbWFsbCBlbm91Z2ggdGhhdCBpdCBkb2VzIG5vdCBmdWxseSBjb3ZlciB0aGUgY3Vyc29yIGxpbmUuCiAgICoKICAgKiBUaGlzIGFsc28gYXBwbGllcyB0byB0aGUgcmFkaWFsIGN1cnNvciBpbiBSYWRpYWxCYXJDaGFydC4KICAgKi8KICBjdXJzb3JMaW5lOiAxMTAwLAogIC8qKgogICAqIEhvdmVyaW5nIG92ZXIgYSBQb2ludCBpbiBMaW5lLCBBcmVhLCBTY2F0dGVyLCBSYWRhciByZW5kZXJzIGEgaGlnaGxpZ2h0IGRvdAogICAqLwogIGFjdGl2ZURvdDogMTIwMCwKICAvKioKICAgKiBMYWJlbExpc3QgYW5kIExhYmVsLCBpbmNsdWRpbmcgQXhpcyBsYWJlbHMKICAgKi8KICBsYWJlbDogMmUzCn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL2RlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmpzCnZhciBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcyA9IHsKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICAvLyBpZiBJIHNldCB0aGlzIHRvIGZhbHNlIHRoZW4gVG9vbHRpcCBzeW5jaHJvbmlzYXRpb24gc3RvcHMgd29ya2luZyBpbiBSYWRhciwgd3RmCiAgYW5nbGVBeGlzSWQ6IDAsCiAgYXhpc0xpbmU6IHRydWUsCiAgYXhpc0xpbmVUeXBlOiAicG9seWdvbiIsCiAgY3g6IDAsCiAgY3k6IDAsCiAgb3JpZW50YXRpb246ICJvdXRlciIsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrTGluZTogdHJ1ZSwKICB0aWNrU2l6ZTogOCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmF4aXMKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvcG9sYXIvZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmpzCnZhciBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiB0cnVlLAogIGFuZ2xlOiAwLAogIGF4aXNMaW5lOiB0cnVlLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIGxhYmVsOiBmYWxzZSwKICBvcmllbnRhdGlvbjogInJpZ2h0IiwKICByYWRpdXNBeGlzSWQ6IDAsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgc3Ryb2tlOiAiI2NjYyIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdHlwZTogIm51bWJlciIsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXhpcwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZS5qcwp2YXIgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlID0gKGF4aXNTZXR0aW5ncywgYXhpc1JhbmdlKSA9PiB7CiAgaWYgKCFheGlzU2V0dGluZ3MgfHwgIWF4aXNSYW5nZSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncyAhPT0gbnVsbCAmJiBheGlzU2V0dGluZ3MgIT09IHZvaWQgMCAmJiBheGlzU2V0dGluZ3MucmV2ZXJzZWQpIHsKICAgIHJldHVybiBbYXhpc1JhbmdlWzFdLCBheGlzUmFuZ2VbMF1dOwogIH0KICByZXR1cm4gYXhpc1JhbmdlOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcG9sYXJBeGlzU2VsZWN0b3JzLmpzCnZhciBpbXBsaWNpdEFuZ2xlQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGZhbHNlLAogIC8vIGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5IGhhcyBpdCBzZXQgdG8gdHJ1ZSBidXQgdGhlIGFjdHVhbCBheGlzIHJlbmRlcmluZyBpZ25vcmVzIHRoZSBwcm9wIGJlY2F1c2UgcmVhc29ucywKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFuZ2xlQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMucmV2ZXJzZWQsCiAgc2NhbGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy50eXBlLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpdXNBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5yYWRpdXNBeGlzSWQsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnRpY2tDb3VudCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50eXBlLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpYWxCYXJBbmdsZUF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFuZ2xlQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAibnVtYmVyIiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIGltcGxpY2l0UmFkaWFsQmFyUmFkaXVzQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMucmFkaXVzQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGljaywKICB0aWNrQ291bnQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrQ291bnQsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgc2VsZWN0QW5nbGVBeGlzID0gKHN0YXRlLCBhbmdsZUF4aXNJZCkgPT4gewogIGlmIChzdGF0ZS5wb2xhckF4aXMuYW5nbGVBeGlzW2FuZ2xlQXhpc0lkXSAhPSBudWxsKSB7CiAgICByZXR1cm4gc3RhdGUucG9sYXJBeGlzLmFuZ2xlQXhpc1thbmdsZUF4aXNJZF07CiAgfQogIGlmIChzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZSA9PT0gInJhZGlhbCIpIHsKICAgIHJldHVybiBpbXBsaWNpdFJhZGlhbEJhckFuZ2xlQXhpczsKICB9CiAgcmV0dXJuIGltcGxpY2l0QW5nbGVBeGlzOwp9Owp2YXIgc2VsZWN0UmFkaXVzQXhpcyA9IChzdGF0ZSwgcmFkaXVzQXhpc0lkKSA9PiB7CiAgaWYgKHN0YXRlLnBvbGFyQXhpcy5yYWRpdXNBeGlzW3JhZGl1c0F4aXNJZF0gIT0gbnVsbCkgewogICAgcmV0dXJuIHN0YXRlLnBvbGFyQXhpcy5yYWRpdXNBeGlzW3JhZGl1c0F4aXNJZF07CiAgfQogIGlmIChzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZSA9PT0gInJhZGlhbCIpIHsKICAgIHJldHVybiBpbXBsaWNpdFJhZGlhbEJhclJhZGl1c0F4aXM7CiAgfQogIHJldHVybiBpbXBsaWNpdFJhZGl1c0F4aXM7Cn07CnZhciBzZWxlY3RQb2xhck9wdGlvbnMgPSAoc3RhdGUpID0+IHN0YXRlLnBvbGFyT3B0aW9uczsKdmFyIHNlbGVjdE1heFJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIGdldE1heFJhZGl1cyk7CnZhciBzZWxlY3RJbm5lclJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnMsIHNlbGVjdE1heFJhZGl1c10sIChwb2xhckNoYXJ0T3B0aW9ucywgbWF4UmFkaXVzKSA9PiB7CiAgaWYgKHBvbGFyQ2hhcnRPcHRpb25zID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBnZXRQZXJjZW50VmFsdWUocG9sYXJDaGFydE9wdGlvbnMuaW5uZXJSYWRpdXMsIG1heFJhZGl1cywgMCk7Cn0pOwp2YXIgc2VsZWN0T3V0ZXJSYWRpdXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJPcHRpb25zLCBzZWxlY3RNYXhSYWRpdXNdLCAocG9sYXJDaGFydE9wdGlvbnMsIG1heFJhZGl1cykgPT4gewogIGlmIChwb2xhckNoYXJ0T3B0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZ2V0UGVyY2VudFZhbHVlKHBvbGFyQ2hhcnRPcHRpb25zLm91dGVyUmFkaXVzLCBtYXhSYWRpdXMsIG1heFJhZGl1cyAqIDAuOCk7Cn0pOwp2YXIgY29tYmluZUFuZ2xlQXhpc1JhbmdlID0gKHBvbGFyT3B0aW9ucykgPT4gewogIGlmIChwb2xhck9wdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIFswLCAwXTsKICB9CiAgdmFyIHsKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBwb2xhck9wdGlvbnM7CiAgcmV0dXJuIFtzdGFydEFuZ2xlLCBlbmRBbmdsZV07Cn07CnZhciBzZWxlY3RBbmdsZUF4aXNSYW5nZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnNdLCBjb21iaW5lQW5nbGVBeGlzUmFuZ2UpOwp2YXIgc2VsZWN0QW5nbGVBeGlzUmFuZ2VXaXRoUmV2ZXJzZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QW5nbGVBeGlzLCBzZWxlY3RBbmdsZUF4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RSYWRpdXNBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0TWF4UmFkaXVzLCBzZWxlY3RJbm5lclJhZGl1cywgc2VsZWN0T3V0ZXJSYWRpdXNdLCAobWF4UmFkaXVzLCBpbm5lclJhZGl1cywgb3V0ZXJSYWRpdXMpID0+IHsKICBpZiAobWF4UmFkaXVzID09IG51bGwgfHwgaW5uZXJSYWRpdXMgPT0gbnVsbCB8fCBvdXRlclJhZGl1cyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW2lubmVyUmFkaXVzLCBvdXRlclJhZGl1c107Cn0pOwp2YXIgc2VsZWN0UmFkaXVzQXhpc1JhbmdlV2l0aFJldmVyc2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJhZGl1c0F4aXMsIHNlbGVjdFJhZGl1c0F4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RQb2xhclZpZXdCb3ggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFBvbGFyT3B0aW9ucywgc2VsZWN0SW5uZXJSYWRpdXMsIHNlbGVjdE91dGVyUmFkaXVzLCBzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodF0sIChsYXlvdXQsIHBvbGFyT3B0aW9ucywgaW5uZXJSYWRpdXMsIG91dGVyUmFkaXVzLCB3aWR0aCwgaGVpZ2h0KSA9PiB7CiAgaWYgKGxheW91dCAhPT0gImNlbnRyaWMiICYmIGxheW91dCAhPT0gInJhZGlhbCIgfHwgcG9sYXJPcHRpb25zID09IG51bGwgfHwgaW5uZXJSYWRpdXMgPT0gbnVsbCB8fCBvdXRlclJhZGl1cyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBwb2xhck9wdGlvbnM7CiAgcmV0dXJuIHsKICAgIGN4OiBnZXRQZXJjZW50VmFsdWUoY3gsIHdpZHRoLCB3aWR0aCAvIDIpLAogICAgY3k6IGdldFBlcmNlbnRWYWx1ZShjeSwgaGVpZ2h0LCBoZWlnaHQgLyAyKSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUsCiAgICBjbG9ja1dpc2U6IGZhbHNlCiAgICAvLyB0aGlzIHByb3BlcnR5IGxvb2sgdXNlZnVsLCB3aHkgbm90IHVzZSBpdD8KICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3BpY2tBeGlzVHlwZS5qcwp2YXIgcGlja0F4aXNUeXBlID0gKF9zdGF0ZSwgYXhpc1R5cGUpID0+IGF4aXNUeXBlOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcGlja0F4aXNJZC5qcwp2YXIgcGlja0F4aXNJZCA9IChfc3RhdGUsIF9heGlzVHlwZSwgYXhpc0lkKSA9PiBheGlzSWQ7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3RhY2tzL2dldFN0YWNrU2VyaWVzSWRlbnRpZmllci5qcwpmdW5jdGlvbiBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoZ3JhcGhpY2FsSXRlbSkgewogIHJldHVybiBncmFwaGljYWxJdGVtID09PSBudWxsIHx8IGdyYXBoaWNhbEl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGdyYXBoaWNhbEl0ZW0uaWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEuanMKZnVuY3Rpb24gY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhKHN0YWNrZWRHcmFwaGljYWxJdGVtcywgX3JlZjIsIHRvb2x0aXBBeGlzU2V0dGluZ3MpIHsKICB2YXIgewogICAgY2hhcnREYXRhID0gW10KICB9ID0gX3JlZjI7CiAgdmFyIHsKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgZGF0YUtleTogdG9vbHRpcERhdGFLZXkKICB9ID0gdG9vbHRpcEF4aXNTZXR0aW5nczsKICB2YXIga25vd25JdGVtc0J5RGF0YUtleSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgc3RhY2tlZEdyYXBoaWNhbEl0ZW1zLmZvckVhY2goKGl0ZW0pID0+IHsKICAgIHZhciBfaXRlbSRkYXRhOwogICAgdmFyIHJlc29sdmVkRGF0YSA9IChfaXRlbSRkYXRhID0gaXRlbS5kYXRhKSAhPT0gbnVsbCAmJiBfaXRlbSRkYXRhICE9PSB2b2lkIDAgPyBfaXRlbSRkYXRhIDogY2hhcnREYXRhOwogICAgaWYgKHJlc29sdmVkRGF0YSA9PSBudWxsIHx8IHJlc29sdmVkRGF0YS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHN0YWNrSWRlbnRpZmllciA9IGdldFN0YWNrU2VyaWVzSWRlbnRpZmllcihpdGVtKTsKICAgIHJlc29sdmVkRGF0YS5mb3JFYWNoKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgdmFyIHRvb2x0aXBWYWx1ZSA9IHRvb2x0aXBEYXRhS2V5ID09IG51bGwgfHwgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgPyBpbmRleCA6IFN0cmluZyhnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgdG9vbHRpcERhdGFLZXksIG51bGwpKTsKICAgICAgdmFyIG51bWVyaWNWYWx1ZSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBpdGVtLmRhdGFLZXksIDApOwogICAgICB2YXIgY3VycjsKICAgICAgaWYgKGtub3duSXRlbXNCeURhdGFLZXkuaGFzKHRvb2x0aXBWYWx1ZSkpIHsKICAgICAgICBjdXJyID0ga25vd25JdGVtc0J5RGF0YUtleS5nZXQodG9vbHRpcFZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJyID0ge307CiAgICAgIH0KICAgICAgT2JqZWN0LmFzc2lnbihjdXJyLCB7CiAgICAgICAgW3N0YWNrSWRlbnRpZmllcl06IG51bWVyaWNWYWx1ZQogICAgICB9KTsKICAgICAga25vd25JdGVtc0J5RGF0YUtleS5zZXQodG9vbHRpcFZhbHVlLCBjdXJyKTsKICAgIH0pOwogIH0pOwogIHJldHVybiBBcnJheS5mcm9tKGtub3duSXRlbXNCeURhdGFLZXkudmFsdWVzKCkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3R5cGVzL1N0YWNrZWRHcmFwaGljYWxJdGVtLmpzCmZ1bmN0aW9uIGlzU3RhY2tlZChncmFwaGljYWxJdGVtKSB7CiAgcmV0dXJuIGdyYXBoaWNhbEl0ZW0uc3RhY2tJZCAhPSBudWxsICYmIGdyYXBoaWNhbEl0ZW0uZGF0YUtleSAhPSBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9udW1iZXJEb21haW5FcXVhbGl0eUNoZWNrLmpzCnZhciBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrID0gKGEyLCBiKSA9PiB7CiAgaWYgKGEyID09PSBiKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKGEyID09IG51bGwgfHwgYiA9PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiBhMlswXSA9PT0gYlswXSAmJiBhMlsxXSA9PT0gYlsxXTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2FycmF5RXF1YWxpdHlDaGVjay5qcwpmdW5jdGlvbiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2soYTIsIGIpIHsKICBpZiAoQXJyYXkuaXNBcnJheShhMikgJiYgQXJyYXkuaXNBcnJheShiKSAmJiBhMi5sZW5ndGggPT09IDAgJiYgYi5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gYTIgPT09IGI7Cn0KZnVuY3Rpb24gYXJyYXlDb250ZW50c0FyZUVxdWFsQ2hlY2soYTIsIGIpIHsKICBpZiAoYTIubGVuZ3RoID09PSBiLmxlbmd0aCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhMi5sZW5ndGg7IGkrKykgewogICAgICBpZiAoYTJbaV0gIT09IGJbaV0pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBBeGlzVHlwZS5qcwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNUeXBlID0gKHN0YXRlKSA9PiB7CiAgdmFyIGxheW91dCA9IHNlbGVjdENoYXJ0TGF5b3V0KHN0YXRlKTsKICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgIHJldHVybiAieEF4aXMiOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gInlBeGlzIjsKICB9CiAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICByZXR1cm4gImFuZ2xlQXhpcyI7CiAgfQogIHJldHVybiAicmFkaXVzQXhpcyI7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwQXhpc0lkLmpzCnZhciBzZWxlY3RUb29sdGlwQXhpc0lkID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzLmF4aXNJZDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2F4aXNTZWxlY3RvcnMuanMKZnVuY3Rpb24gb3duS2V5czE0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0TnVtZXJpY0RvbWFpbiA9IFswLCAiYXV0byJdOwp2YXIgaW1wbGljaXRYQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogdHJ1ZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaGVpZ2h0OiAzMCwKICBoaWRlOiB0cnVlLAogIGlkOiAwLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIGludGVydmFsOiAicHJlc2VydmVFbmQiLAogIG1pblRpY2tHYXA6IDUsCiAgbWlycm9yOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgb3JpZW50YXRpb246ICJib3R0b20iLAogIHBhZGRpbmc6IHsKICAgIGxlZnQ6IDAsCiAgICByaWdodDogMAogIH0sCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdGlja0Zvcm1hdHRlcjogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogImNhdGVnb3J5IiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIHNlbGVjdFhBeGlzU2V0dGluZ3NOb0RlZmF1bHRzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICByZXR1cm4gc3RhdGUuY2FydGVzaWFuQXhpcy54QXhpc1theGlzSWRdOwp9Owp2YXIgc2VsZWN0WEF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXMgPSBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gaW1wbGljaXRYQXhpczsKICB9CiAgcmV0dXJuIGF4aXM7Cn07CnZhciBpbXBsaWNpdFlBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiB0cnVlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiB0cnVlLAogIGFuZ2xlOiAwLAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IGRlZmF1bHROdW1lcmljRG9tYWluLAogIGhpZGU6IHRydWUsCiAgaWQ6IDAsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgaW50ZXJ2YWw6ICJwcmVzZXJ2ZUVuZCIsCiAgbWluVGlja0dhcDogNSwKICBtaXJyb3I6IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICBvcmllbnRhdGlvbjogImxlZnQiLAogIHBhZGRpbmc6IHsKICAgIHRvcDogMCwKICAgIGJvdHRvbTogMAogIH0sCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdGlja0Zvcm1hdHRlcjogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogdm9pZCAwLAogIHdpZHRoOiBERUZBVUxUX1lfQVhJU19XSURUSAp9Owp2YXIgc2VsZWN0WUF4aXNTZXR0aW5nc05vRGVmYXVsdHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHJldHVybiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnlBeGlzW2F4aXNJZF07Cn07CnZhciBzZWxlY3RZQXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpcyA9IHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFlBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIGltcGxpY2l0WkF4aXMgPSB7CiAgZG9tYWluOiBbMCwgImF1dG8iXSwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICByZXZlcnNlZDogZmFsc2UsCiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBmYWxzZSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgaWQ6IDAsCiAgbmFtZTogIiIsCiAgcmFuZ2U6IFs2NCwgNjRdLAogIHNjYWxlOiAiYXV0byIsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogIiIKfTsKdmFyIHNlbGVjdFpBeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzID0gc3RhdGUuY2FydGVzaWFuQXhpcy56QXhpc1theGlzSWRdOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFpBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIHNlbGVjdEJhc2VBeGlzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiekF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiYW5nbGVBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAicmFkaXVzQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdENhcnRlc2lhbkF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInlBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBheGlzIHR5cGU6ICIuY29uY2F0KGF4aXNUeXBlKSk7CiAgfQp9Owp2YXIgc2VsZWN0QXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiYW5nbGVBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAicmFkaXVzQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdEhhc0JhciA9IChzdGF0ZSkgPT4gc3RhdGUuZ3JhcGhpY2FsSXRlbXMuY2FydGVzaWFuSXRlbXMuc29tZSgoaXRlbSkgPT4gaXRlbS50eXBlID09PSAiYmFyIikgfHwgc3RhdGUuZ3JhcGhpY2FsSXRlbXMucG9sYXJJdGVtcy5zb21lKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJyYWRpYWxCYXIiKTsKZnVuY3Rpb24gaXRlbUF4aXNQcmVkaWNhdGUoYXhpc1R5cGUsIGF4aXNJZCkgewogIHJldHVybiAoaXRlbSkgPT4gewogICAgc3dpdGNoIChheGlzVHlwZSkgewogICAgICBjYXNlICJ4QXhpcyI6CiAgICAgICAgcmV0dXJuICJ4QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ueEF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJ5QXhpcyI6CiAgICAgICAgcmV0dXJuICJ5QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ueUF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJ6QXhpcyI6CiAgICAgICAgcmV0dXJuICJ6QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0uekF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJhbmdsZUF4aXMiOgogICAgICAgIHJldHVybiAiYW5nbGVBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS5hbmdsZUF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJyYWRpdXNBeGlzIjoKICAgICAgICByZXR1cm4gInJhZGl1c0F4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnJhZGl1c0F4aXNJZCA9PT0gYXhpc0lkOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9Owp9CnZhciBzZWxlY3RVbmZpbHRlcmVkQ2FydGVzaWFuSXRlbXMgPSAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zOwp2YXIgc2VsZWN0QXhpc1ByZWRpY2F0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBpdGVtQXhpc1ByZWRpY2F0ZSk7CnZhciBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IChncmFwaGljYWxJdGVtcywgYXhpc1NldHRpbmdzLCBheGlzUHJlZGljYXRlKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoYXhpc1ByZWRpY2F0ZSkuZmlsdGVyKChpdGVtKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuaW5jbHVkZUhpZGRlbikgPT09IHRydWUpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gIWl0ZW0uaGlkZTsKfSk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFVuZmlsdGVyZWRDYXJ0ZXNpYW5JdGVtcywgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNQcmVkaWNhdGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIChjYXJ0ZXNpYW5JdGVtcykgPT4gewogIHJldHVybiBjYXJ0ZXNpYW5JdGVtcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gImFyZWEiIHx8IGl0ZW0udHlwZSA9PT0gImJhciIpLmZpbHRlcihpc1N0YWNrZWQpOwp9KTsKdmFyIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyA9IChjYXJ0ZXNpYW5JdGVtcykgPT4gY2FydGVzaWFuSXRlbXMuZmlsdGVyKChpdGVtKSA9PiAhKCJzdGFja0lkIiBpbiBpdGVtKSB8fCBpdGVtLnN0YWNrSWQgPT09IHZvaWQgMCk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzRXhjZXB0U3RhY2tlZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgZmlsdGVyR3JhcGhpY2FsTm90U3RhY2tlZEl0ZW1zKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtc0RhdGEgPSAoY2FydGVzaWFuSXRlbXMpID0+IGNhcnRlc2lhbkl0ZW1zLm1hcCgoaXRlbSkgPT4gaXRlbS5kYXRhKS5maWx0ZXIoQm9vbGVhbikuZmxhdCgxKTsKdmFyIHNlbGVjdENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1zRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zRGF0YSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgY29tYmluZURpc3BsYXllZERhdGEgPSAoZ3JhcGhpY2FsSXRlbXNEYXRhLCBfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEgPSBbXSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYyOwogIGlmIChncmFwaGljYWxJdGVtc0RhdGEubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGdyYXBoaWNhbEl0ZW1zRGF0YTsKICB9CiAgcmV0dXJuIGNoYXJ0RGF0YS5zbGljZShkYXRhU3RhcnRJbmRleCwgZGF0YUVuZEluZGV4ICsgMSk7Cn07CnZhciBzZWxlY3REaXNwbGF5ZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1zRGF0YSwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWFdLCBjb21iaW5lRGlzcGxheWVkRGF0YSk7CnZhciBjb21iaW5lQXBwbGllZFZhbHVlcyA9IChkYXRhLCBheGlzU2V0dGluZ3MsIGl0ZW1zKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuZGF0YUtleSkgIT0gbnVsbCkgewogICAgcmV0dXJuIGRhdGEubWFwKChpdGVtKSA9PiAoewogICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkoaXRlbSwgYXhpc1NldHRpbmdzLmRhdGFLZXkpCiAgICB9KSk7CiAgfQogIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gaXRlbXMubWFwKChpdGVtKSA9PiBpdGVtLmRhdGFLZXkpLmZsYXRNYXAoKGRhdGFLZXkpID0+IGRhdGEubWFwKChlbnRyeSkgPT4gKHsKICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBkYXRhS2V5KQogICAgfSkpKTsKICB9CiAgcmV0dXJuIGRhdGEubWFwKChlbnRyeSkgPT4gKHsKICAgIHZhbHVlOiBlbnRyeQogIH0pKTsKfTsKdmFyIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lQXBwbGllZFZhbHVlcyk7CmZ1bmN0aW9uIGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlcnJvckJhcikgewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjoKICAgICAgcmV0dXJuIGVycm9yQmFyLmRpcmVjdGlvbiA9PT0gIngiOwogICAgY2FzZSAieUF4aXMiOgogICAgICByZXR1cm4gZXJyb3JCYXIuZGlyZWN0aW9uID09PSAieSI7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gZmFsc2U7CiAgfQp9CmZ1bmN0aW9uIG1ha2VOdW1iZXIodmFsKSB7CiAgaWYgKGlzTnVtT3JTdHIodmFsKSB8fCB2YWwgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICB2YXIgbiA9IE51bWJlcih2YWwpOwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobikpIHsKICAgICAgcmV0dXJuIG47CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFrZURvbWFpbih2YWwpIHsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICB2YXIgYXR0ZW1wdCA9IFttYWtlTnVtYmVyKHZhbFswXSksIG1ha2VOdW1iZXIodmFsWzFdKV07CiAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGF0dGVtcHQpKSB7CiAgICAgIHJldHVybiBhdHRlbXB0OwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG4gPSBtYWtlTnVtYmVyKHZhbCk7CiAgaWYgKG4gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtuLCBuXTsKfQpmdW5jdGlvbiBvbmx5QWxsb3dOdW1iZXJzKGRhdGEpIHsKICByZXR1cm4gZGF0YS5tYXAobWFrZU51bWJlcikuZmlsdGVyKGlzTm90TmlsKTsKfQpmdW5jdGlvbiBnZXRFcnJvckRvbWFpbkJ5RGF0YUtleShlbnRyeSwgYXBwbGllZFZhbHVlLCByZWxldmFudEVycm9yQmFycykgewogIGlmICghcmVsZXZhbnRFcnJvckJhcnMgfHwgdHlwZW9mIGFwcGxpZWRWYWx1ZSAhPT0gIm51bWJlciIgfHwgaXNOYW4oYXBwbGllZFZhbHVlKSkgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAoIXJlbGV2YW50RXJyb3JCYXJzLmxlbmd0aCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhyZWxldmFudEVycm9yQmFycy5mbGF0TWFwKChlYikgPT4gewogICAgdmFyIGVycm9yVmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZWIuZGF0YUtleSk7CiAgICB2YXIgbG93Qm91bmQsIGhpZ2hCb3VuZDsKICAgIGlmIChBcnJheS5pc0FycmF5KGVycm9yVmFsdWUpKSB7CiAgICAgIFtsb3dCb3VuZCwgaGlnaEJvdW5kXSA9IGVycm9yVmFsdWU7CiAgICB9IGVsc2UgewogICAgICBsb3dCb3VuZCA9IGhpZ2hCb3VuZCA9IGVycm9yVmFsdWU7CiAgICB9CiAgICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIobG93Qm91bmQpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGhpZ2hCb3VuZCkpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBbYXBwbGllZFZhbHVlIC0gbG93Qm91bmQsIGFwcGxpZWRWYWx1ZSArIGhpZ2hCb3VuZF07CiAgfSkpOwp9CnZhciBzZWxlY3RUb29sdGlwQXhpcyA9IChzdGF0ZSkgPT4gewogIHZhciBheGlzVHlwZSA9IHNlbGVjdFRvb2x0aXBBeGlzVHlwZShzdGF0ZSk7CiAgdmFyIGF4aXNJZCA9IHNlbGVjdFRvb2x0aXBBeGlzSWQoc3RhdGUpOwogIHJldHVybiBzZWxlY3RBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzXSwgKGF4aXMpID0+IGF4aXMgPT09IG51bGwgfHwgYXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpcy5kYXRhS2V5KTsKdmFyIHNlbGVjdERpc3BsYXllZFN0YWNrZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFN0YWNrZWRDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc0lmTm90SW5QYW5vcmFtYSwgc2VsZWN0VG9vbHRpcEF4aXNdLCBjb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEpOwp2YXIgY29tYmluZVN0YWNrR3JvdXBzID0gKGRpc3BsYXllZERhdGEsIGl0ZW1zLCBzdGFja09mZnNldFR5cGUsIHJldmVyc2VTdGFja09yZGVyKSA9PiB7CiAgdmFyIGluaXRpYWxJdGVtc0dyb3VwcyA9IHt9OwogIHZhciBpdGVtc0dyb3VwID0gaXRlbXMucmVkdWNlKChhY2MsIGl0ZW0pID0+IHsKICAgIGlmIChpdGVtLnN0YWNrSWQgPT0gbnVsbCkgewogICAgICByZXR1cm4gYWNjOwogICAgfQogICAgaWYgKGFjY1tpdGVtLnN0YWNrSWRdID09IG51bGwpIHsKICAgICAgYWNjW2l0ZW0uc3RhY2tJZF0gPSBbXTsKICAgIH0KICAgIGFjY1tpdGVtLnN0YWNrSWRdLnB1c2goaXRlbSk7CiAgICByZXR1cm4gYWNjOwogIH0sIGluaXRpYWxJdGVtc0dyb3Vwcyk7CiAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhpdGVtc0dyb3VwKS5tYXAoKF9yZWYyKSA9PiB7CiAgICB2YXIgW3N0YWNrSWQsIGdyYXBoaWNhbEl0ZW1zXSA9IF9yZWYyOwogICAgdmFyIG9yZGVyZWRHcmFwaGljYWxJdGVtcyA9IHJldmVyc2VTdGFja09yZGVyID8gWy4uLmdyYXBoaWNhbEl0ZW1zXS5yZXZlcnNlKCkgOiBncmFwaGljYWxJdGVtczsKICAgIHZhciBkYXRhS2V5cyA9IG9yZGVyZWRHcmFwaGljYWxJdGVtcy5tYXAoZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKTsKICAgIHJldHVybiBbc3RhY2tJZCwgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFN0YWNrZWREYXRhIHJlcXVpcmVzIHRoYXQgdGhlIGlucHV0IGlzIGFycmF5IG9mIG9iamVjdHMsIFJlY2hhcnRzIGRvZXMgbm90IHRlc3QgZm9yIHRoYXQKICAgICAgc3RhY2tlZERhdGE6IGdldFN0YWNrZWREYXRhKGRpc3BsYXllZERhdGEsIGRhdGFLZXlzLCBzdGFja09mZnNldFR5cGUpLAogICAgICBncmFwaGljYWxJdGVtczogb3JkZXJlZEdyYXBoaWNhbEl0ZW1zCiAgICB9XTsKICB9KSk7Cn07CnZhciBzZWxlY3RTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REaXNwbGF5ZWRTdGFja2VkRGF0YSwgc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0UmV2ZXJzZVN0YWNrT3JkZXJdLCBjb21iaW5lU3RhY2tHcm91cHMpOwp2YXIgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMgPSAoc3RhY2tHcm91cHMsIF9yZWYzLCBheGlzVHlwZSwgZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYzOwogIGlmIChkb21haW5Gcm9tVXNlclByZWZlcmVuY2UgIT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGF4aXNUeXBlID09PSAiekF4aXMiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZG9tYWluT2ZTdGFja0dyb3VwcyA9IGdldERvbWFpbk9mU3RhY2tHcm91cHMoc3RhY2tHcm91cHMsIGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXgpOwogIGlmIChkb21haW5PZlN0YWNrR3JvdXBzICE9IG51bGwgJiYgZG9tYWluT2ZTdGFja0dyb3Vwc1swXSA9PT0gMCAmJiBkb21haW5PZlN0YWNrR3JvdXBzWzFdID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZG9tYWluT2ZTdGFja0dyb3VwczsKfTsKdmFyIHNlbGVjdEFsbG93c0RhdGFPdmVyZmxvdyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpc10sIChheGlzU2V0dGluZ3MpID0+IGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7CnZhciBnZXREb21haW5EZWZpbml0aW9uID0gKGF4aXNTZXR0aW5ncykgPT4gewogIHZhciBfYXhpc1NldHRpbmdzJGRvbWFpbjsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwgfHwgISgiZG9tYWluIiBpbiBheGlzU2V0dGluZ3MpKSB7CiAgICByZXR1cm4gZGVmYXVsdE51bWVyaWNEb21haW47CiAgfQogIGlmIChheGlzU2V0dGluZ3MuZG9tYWluICE9IG51bGwpIHsKICAgIHJldHVybiBheGlzU2V0dGluZ3MuZG9tYWluOwogIH0KICBpZiAoYXhpc1NldHRpbmdzLnRpY2tzICE9IG51bGwpIHsKICAgIGlmIChheGlzU2V0dGluZ3MudHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgdmFyIGFsbFZhbHVlcyA9IG9ubHlBbGxvd051bWJlcnMoYXhpc1NldHRpbmdzLnRpY2tzKTsKICAgICAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxWYWx1ZXMpLCBNYXRoLm1heCguLi5hbGxWYWx1ZXMpXTsKICAgIH0KICAgIGlmIChheGlzU2V0dGluZ3MudHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgICByZXR1cm4gYXhpc1NldHRpbmdzLnRpY2tzLm1hcChTdHJpbmcpOwogICAgfQogIH0KICByZXR1cm4gKF9heGlzU2V0dGluZ3MkZG9tYWluID0gYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRvbWFpbikgIT09IG51bGwgJiYgX2F4aXNTZXR0aW5ncyRkb21haW4gIT09IHZvaWQgMCA/IF9heGlzU2V0dGluZ3MkZG9tYWluIDogZGVmYXVsdE51bWVyaWNEb21haW47Cn07CnZhciBzZWxlY3REb21haW5EZWZpbml0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzXSwgZ2V0RG9tYWluRGVmaW5pdGlvbik7CnZhciBzZWxlY3REb21haW5Gcm9tVXNlclByZWZlcmVuY2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0QWxsb3dzRGF0YU92ZXJmbG93XSwgbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEpOwp2YXIgc2VsZWN0RG9tYWluT2ZTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RTdGFja0dyb3Vwcywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHBpY2tBeGlzVHlwZSwgc2VsZWN0RG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlXSwgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS5lcnJvckJhcnM7CnZhciBjb21iaW5lUmVsZXZhbnRFcnJvckJhclNldHRpbmdzID0gKGNhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIGFsbEVycm9yQmFyU2V0dGluZ3MsIGF4aXNUeXBlKSA9PiB7CiAgcmV0dXJuIGNhcnRlc2lhbkl0ZW1zU2V0dGluZ3MuZmxhdE1hcCgoaXRlbSkgPT4gewogICAgcmV0dXJuIGFsbEVycm9yQmFyU2V0dGluZ3NbaXRlbS5pZF07CiAgfSkuZmlsdGVyKEJvb2xlYW4pLmZpbHRlcigoZSkgPT4gewogICAgcmV0dXJuIGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlKTsKICB9KTsKfTsKdmFyIG1lcmdlRG9tYWlucyA9IGZ1bmN0aW9uIG1lcmdlRG9tYWluczIoKSB7CiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGRvbWFpbnMgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICBkb21haW5zW19rZXldID0gYXJndW1lbnRzW19rZXldOwogIH0KICB2YXIgYWxsRG9tYWlucyA9IGRvbWFpbnMuZmlsdGVyKEJvb2xlYW4pOwogIGlmIChhbGxEb21haW5zLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGFsbFZhbHVlcyA9IGFsbERvbWFpbnMuZmxhdCgpOwogIHZhciBtaW4yID0gTWF0aC5taW4oLi4uYWxsVmFsdWVzKTsKICB2YXIgbWF4MiA9IE1hdGgubWF4KC4uLmFsbFZhbHVlcyk7CiAgcmV0dXJuIFttaW4yLCBtYXgyXTsKfTsKdmFyIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcyA9IChkYXRhLCBheGlzU2V0dGluZ3MsIGl0ZW1zLCBlcnJvckJhcnMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGxvd2VyRW5kLCB1cHBlckVuZDsKICBpZiAoaXRlbXMubGVuZ3RoID4gMCkgewogICAgZGF0YS5mb3JFYWNoKChlbnRyeSkgPT4gewogICAgICBpdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgICAgdmFyIF9lcnJvckJhcnMkaXRlbSRpZCwgX2F4aXNTZXR0aW5ncyRkYXRhS2V5OwogICAgICAgIHZhciByZWxldmFudEVycm9yQmFycyA9IChfZXJyb3JCYXJzJGl0ZW0kaWQgPSBlcnJvckJhcnNbaXRlbS5pZF0pID09PSBudWxsIHx8IF9lcnJvckJhcnMkaXRlbSRpZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vycm9yQmFycyRpdGVtJGlkLmZpbHRlcigoZXJyb3JCYXIpID0+IGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlcnJvckJhcikpOwogICAgICAgIHZhciB2YWx1ZUJ5RGF0YUtleSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCAoX2F4aXNTZXR0aW5ncyRkYXRhS2V5ID0gYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9PSBudWxsICYmIF9heGlzU2V0dGluZ3MkZGF0YUtleSAhPT0gdm9pZCAwID8gX2F4aXNTZXR0aW5ncyRkYXRhS2V5IDogaXRlbS5kYXRhS2V5KTsKICAgICAgICB2YXIgZXJyb3JEb21haW4gPSBnZXRFcnJvckRvbWFpbkJ5RGF0YUtleShlbnRyeSwgdmFsdWVCeURhdGFLZXksIHJlbGV2YW50RXJyb3JCYXJzKTsKICAgICAgICBpZiAoZXJyb3JEb21haW4ubGVuZ3RoID49IDIpIHsKICAgICAgICAgIHZhciBsb2NhbExvd2VyID0gTWF0aC5taW4oLi4uZXJyb3JEb21haW4pOwogICAgICAgICAgdmFyIGxvY2FsVXBwZXIgPSBNYXRoLm1heCguLi5lcnJvckRvbWFpbik7CiAgICAgICAgICBpZiAobG93ZXJFbmQgPT0gbnVsbCB8fCBsb2NhbExvd2VyIDwgbG93ZXJFbmQpIHsKICAgICAgICAgICAgbG93ZXJFbmQgPSBsb2NhbExvd2VyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwcGVyRW5kID09IG51bGwgfHwgbG9jYWxVcHBlciA+IHVwcGVyRW5kKSB7CiAgICAgICAgICAgIHVwcGVyRW5kID0gbG9jYWxVcHBlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRhdGFWYWx1ZURvbWFpbiA9IG1ha2VEb21haW4odmFsdWVCeURhdGFLZXkpOwogICAgICAgIGlmIChkYXRhVmFsdWVEb21haW4gIT0gbnVsbCkgewogICAgICAgICAgbG93ZXJFbmQgPSBsb3dlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzBdIDogTWF0aC5taW4obG93ZXJFbmQsIGRhdGFWYWx1ZURvbWFpblswXSk7CiAgICAgICAgICB1cHBlckVuZCA9IHVwcGVyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMV0gOiBNYXRoLm1heCh1cHBlckVuZCwgZGF0YVZhbHVlRG9tYWluWzFdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9IG51bGwpIHsKICAgIGRhdGEuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICB2YXIgZGF0YVZhbHVlRG9tYWluID0gbWFrZURvbWFpbihnZXRWYWx1ZUJ5RGF0YUtleShpdGVtLCBheGlzU2V0dGluZ3MuZGF0YUtleSkpOwogICAgICBpZiAoZGF0YVZhbHVlRG9tYWluICE9IG51bGwpIHsKICAgICAgICBsb3dlckVuZCA9IGxvd2VyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMF0gOiBNYXRoLm1pbihsb3dlckVuZCwgZGF0YVZhbHVlRG9tYWluWzBdKTsKICAgICAgICB1cHBlckVuZCA9IHVwcGVyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMV0gOiBNYXRoLm1heCh1cHBlckVuZCwgZGF0YVZhbHVlRG9tYWluWzFdKTsKICAgICAgfQogICAgfSk7CiAgfQogIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKGxvd2VyRW5kKSAmJiBpc1dlbGxCZWhhdmVkTnVtYmVyKHVwcGVyRW5kKSkgewogICAgcmV0dXJuIFtsb3dlckVuZCwgdXBwZXJFbmRdOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkLCBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lRG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CmZ1bmN0aW9uIG9ubHlBbGxvd051bWJlcnNBbmRTdHJpbmdzQW5kRGF0ZXMoaXRlbSkgewogIHZhciB7CiAgICB2YWx1ZQogIH0gPSBpdGVtOwogIGlmIChpc051bU9yU3RyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQp2YXIgY29tcHV0ZURvbWFpbk9mVHlwZUNhdGVnb3J5ID0gKGFsbERhdGFTcXVpc2hlZCwgYXhpc1NldHRpbmdzLCBpc0NhdGVnb3JpY2FsKSA9PiB7CiAgdmFyIGNhdGVnb3JpY2FsRG9tYWluID0gYWxsRGF0YVNxdWlzaGVkLm1hcChvbmx5QWxsb3dOdW1iZXJzQW5kU3RyaW5nc0FuZERhdGVzKS5maWx0ZXIoKHYpID0+IHYgIT0gbnVsbCk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgKGF4aXNTZXR0aW5ncy5kYXRhS2V5ID09IG51bGwgfHwgYXhpc1NldHRpbmdzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGhhc0R1cGxpY2F0ZShjYXRlZ29yaWNhbERvbWFpbikpKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF9yYW5nZTIuZGVmYXVsdCkoMCwgYWxsRGF0YVNxdWlzaGVkLmxlbmd0aCk7CiAgfQogIGlmIChheGlzU2V0dGluZ3MuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkpIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbjsKICB9CiAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChjYXRlZ29yaWNhbERvbWFpbikpOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlRG90cyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMuZG90czsKdmFyIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzID0gKGVsZW1lbnRzLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgcmV0dXJuIGVsZW1lbnRzLmZpbHRlcigoZWwpID0+IGVsLmlmT3ZlcmZsb3cgPT09ICJleHRlbmREb21haW4iKS5maWx0ZXIoKGVsKSA9PiB7CiAgICBpZiAoYXhpc1R5cGUgPT09ICJ4QXhpcyIpIHsKICAgICAgcmV0dXJuIGVsLnhBeGlzSWQgPT09IGF4aXNJZDsKICAgIH0KICAgIHJldHVybiBlbC55QXhpc0lkID09PSBheGlzSWQ7CiAgfSk7Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHMsIHBpY2tBeGlzVHlwZSwgcGlja0F4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzID0gKHN0YXRlKSA9PiBzdGF0ZS5yZWZlcmVuY2VFbGVtZW50cy5hcmVhczsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzLCBwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lcyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMubGluZXM7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0J5QXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lcywgcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgY29tYmluZURvdHNEb21haW4gPSAoZG90cywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gb25seUFsbG93TnVtYmVycyhkb3RzLm1hcCgoZG90KSA9PiBheGlzVHlwZSA9PT0gInhBeGlzIiA/IGRvdC54IDogZG90LnkpKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNEb21haW4gPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RSZWZlcmVuY2VEb3RzQnlBeGlzLCBwaWNrQXhpc1R5cGUsIGNvbWJpbmVEb3RzRG9tYWluKTsKdmFyIGNvbWJpbmVBcmVhc0RvbWFpbiA9IChhcmVhcywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gb25seUFsbG93TnVtYmVycyhhcmVhcy5mbGF0TWFwKChhcmVhKSA9PiBbYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBhcmVhLngxIDogYXJlYS55MSwgYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBhcmVhLngyIDogYXJlYS55Ml0pKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzQnlBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXJlYXNEb21haW4pOwpmdW5jdGlvbiBleHRyYWN0WENvb3JkaW5hdGVzKGxpbmUpIHsKICB2YXIgX2xpbmUkc2VnbWVudDsKICBpZiAobGluZS54ICE9IG51bGwpIHsKICAgIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKFtsaW5lLnhdKTsKICB9CiAgdmFyIHNlZ21lbnRDb29yZGluYXRlcyA9IChfbGluZSRzZWdtZW50ID0gbGluZS5zZWdtZW50KSA9PT0gbnVsbCB8fCBfbGluZSRzZWdtZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbGluZSRzZWdtZW50Lm1hcCgoczIpID0+IHMyLngpOwogIGlmIChzZWdtZW50Q29vcmRpbmF0ZXMgPT0gbnVsbCB8fCBzZWdtZW50Q29vcmRpbmF0ZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gW107CiAgfQogIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKHNlZ21lbnRDb29yZGluYXRlcyk7Cn0KZnVuY3Rpb24gZXh0cmFjdFlDb29yZGluYXRlcyhsaW5lKSB7CiAgdmFyIF9saW5lJHNlZ21lbnQyOwogIGlmIChsaW5lLnkgIT0gbnVsbCkgewogICAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMoW2xpbmUueV0pOwogIH0KICB2YXIgc2VnbWVudENvb3JkaW5hdGVzID0gKF9saW5lJHNlZ21lbnQyID0gbGluZS5zZWdtZW50KSA9PT0gbnVsbCB8fCBfbGluZSRzZWdtZW50MiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2xpbmUkc2VnbWVudDIubWFwKChzMikgPT4gczIueSk7CiAgaWYgKHNlZ21lbnRDb29yZGluYXRlcyA9PSBudWxsIHx8IHNlZ21lbnRDb29yZGluYXRlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMoc2VnbWVudENvb3JkaW5hdGVzKTsKfQp2YXIgY29tYmluZUxpbmVzRG9tYWluID0gKGxpbmVzLCBheGlzVHlwZSkgPT4gewogIHZhciBhbGxDb29yZHMgPSBsaW5lcy5mbGF0TWFwKChsaW5lKSA9PiBheGlzVHlwZSA9PT0gInhBeGlzIiA/IGV4dHJhY3RYQ29vcmRpbmF0ZXMobGluZSkgOiBleHRyYWN0WUNvb3JkaW5hdGVzKGxpbmUpKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZUxpbmVzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUxpbmVzQnlBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lTGluZXNEb21haW4pOwp2YXIgc2VsZWN0UmVmZXJlbmNlRWxlbWVudHNEb21haW4gPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RSZWZlcmVuY2VEb3RzRG9tYWluLCBzZWxlY3RSZWZlcmVuY2VMaW5lc0RvbWFpbiwgc2VsZWN0UmVmZXJlbmNlQXJlYXNEb21haW4sIChkb3RzRG9tYWluLCBsaW5lc0RvbWFpbiwgYXJlYXNEb21haW4pID0+IHsKICByZXR1cm4gbWVyZ2VEb21haW5zKGRvdHNEb21haW4sIGFyZWFzRG9tYWluLCBsaW5lc0RvbWFpbik7Cn0pOwp2YXIgY29tYmluZU51bWVyaWNhbERvbWFpbiA9IChheGlzU2V0dGluZ3MsIGRvbWFpbkRlZmluaXRpb24sIGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSwgZG9tYWluT2ZTdGFja0dyb3VwcywgZGF0YUFuZEVycm9yQmFyc0RvbWFpbiwgcmVmZXJlbmNlRWxlbWVudHNEb21haW4sIGxheW91dCwgYXhpc1R5cGUpID0+IHsKICBpZiAoZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlICE9IG51bGwpIHsKICAgIHJldHVybiBkb21haW5Gcm9tVXNlclByZWZlcmVuY2U7CiAgfQogIHZhciBzaG91bGRJbmNsdWRlRG9tYWluT2ZTdGFja0dyb3VwcyA9IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBheGlzVHlwZSA9PT0gInhBeGlzIiB8fCBsYXlvdXQgPT09ICJob3Jpem9udGFsIiAmJiBheGlzVHlwZSA9PT0gInlBeGlzIjsKICB2YXIgbWVyZ2VkRG9tYWlucyA9IHNob3VsZEluY2x1ZGVEb21haW5PZlN0YWNrR3JvdXBzID8gbWVyZ2VEb21haW5zKGRvbWFpbk9mU3RhY2tHcm91cHMsIHJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluKSA6IG1lcmdlRG9tYWlucyhyZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgZGF0YUFuZEVycm9yQmFyc0RvbWFpbik7CiAgcmV0dXJuIHBhcnNlTnVtZXJpY2FsVXNlckRvbWFpbihkb21haW5EZWZpbml0aW9uLCBtZXJnZWREb21haW5zLCBheGlzU2V0dGluZ3MuYWxsb3dEYXRhT3ZlcmZsb3cpOwp9Owp2YXIgc2VsZWN0TnVtZXJpY2FsRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3REb21haW5EZWZpbml0aW9uLCBzZWxlY3REb21haW5Gcm9tVXNlclByZWZlcmVuY2UsIHNlbGVjdERvbWFpbk9mU3RhY2tHcm91cHMsIHNlbGVjdERvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzLCBzZWxlY3RSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgc2VsZWN0Q2hhcnRMYXlvdXQsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVOdW1lcmljYWxEb21haW4sIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBleHBhbmREb21haW4gPSBbMCwgMV07CnZhciBjb21iaW5lQXhpc0RvbWFpbiA9IChheGlzU2V0dGluZ3MsIGxheW91dCwgZGlzcGxheWVkRGF0YSwgYWxsQXBwbGllZFZhbHVlcywgc3RhY2tPZmZzZXRUeXBlLCBheGlzVHlwZSwgbnVtZXJpY2FsRG9tYWluKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT0gbnVsbCB8fCBkaXNwbGF5ZWREYXRhID09IG51bGwgfHwgZGlzcGxheWVkRGF0YS5sZW5ndGggPT09IDApICYmIG51bWVyaWNhbERvbWFpbiA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgZGF0YUtleSwKICAgIHR5cGUKICB9ID0gYXhpc1NldHRpbmdzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgZGF0YUtleSA9PSBudWxsKSB7CiAgICB2YXIgX2Rpc3BsYXllZERhdGEkbGVuZ3RoOwogICAgcmV0dXJuICgwLCBpbXBvcnRfcmFuZ2UyLmRlZmF1bHQpKDAsIChfZGlzcGxheWVkRGF0YSRsZW5ndGggPSBkaXNwbGF5ZWREYXRhID09PSBudWxsIHx8IGRpc3BsYXllZERhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRpc3BsYXllZERhdGEubGVuZ3RoKSAhPT0gbnVsbCAmJiBfZGlzcGxheWVkRGF0YSRsZW5ndGggIT09IHZvaWQgMCA/IF9kaXNwbGF5ZWREYXRhJGxlbmd0aCA6IDApOwogIH0KICBpZiAodHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgcmV0dXJuIGNvbXB1dGVEb21haW5PZlR5cGVDYXRlZ29yeShhbGxBcHBsaWVkVmFsdWVzLCBheGlzU2V0dGluZ3MsIGlzQ2F0ZWdvcmljYWwpOwogIH0KICBpZiAoc3RhY2tPZmZzZXRUeXBlID09PSAiZXhwYW5kIikgewogICAgcmV0dXJuIGV4cGFuZERvbWFpbjsKICB9CiAgcmV0dXJuIG51bWVyaWNhbERvbWFpbjsKfTsKdmFyIHNlbGVjdEF4aXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3REaXNwbGF5ZWREYXRhLCBzZWxlY3RBbGxBcHBsaWVkVmFsdWVzLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHBpY2tBeGlzVHlwZSwgc2VsZWN0TnVtZXJpY2FsRG9tYWluXSwgY29tYmluZUF4aXNEb21haW4pOwp2YXIgY29tYmluZVJlYWxTY2FsZVR5cGUgPSAoYXhpc0NvbmZpZywgbGF5b3V0LCBoYXNCYXIsIGNoYXJ0VHlwZSwgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpc0NvbmZpZyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgc2NhbGUsCiAgICB0eXBlCiAgfSA9IGF4aXNDb25maWc7CiAgaWYgKHNjYWxlID09PSAiYXV0byIpIHsKICAgIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAicmFkaXVzQXhpcyIpIHsKICAgICAgcmV0dXJuICJiYW5kIjsKICAgIH0KICAgIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIikgewogICAgICByZXR1cm4gImxpbmVhciI7CiAgICB9CiAgICBpZiAodHlwZSA9PT0gImNhdGVnb3J5IiAmJiBjaGFydFR5cGUgJiYgKGNoYXJ0VHlwZS5pbmRleE9mKCJMaW5lQ2hhcnQiKSA+PSAwIHx8IGNoYXJ0VHlwZS5pbmRleE9mKCJBcmVhQ2hhcnQiKSA+PSAwIHx8IGNoYXJ0VHlwZS5pbmRleE9mKCJDb21wb3NlZENoYXJ0IikgPj0gMCAmJiAhaGFzQmFyKSkgewogICAgICByZXR1cm4gInBvaW50IjsKICAgIH0KICAgIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICAgIHJldHVybiAiYmFuZCI7CiAgICB9CiAgICByZXR1cm4gImxpbmVhciI7CiAgfQogIGlmICh0eXBlb2Ygc2NhbGUgPT09ICJzdHJpbmciKSB7CiAgICB2YXIgbmFtZSA9ICJzY2FsZSIuY29uY2F0KHVwcGVyRmlyc3Qoc2NhbGUpKTsKICAgIHJldHVybiBuYW1lIGluIGQzX3NjYWxlX2V4cG9ydHMgPyBuYW1lIDogInBvaW50IjsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdFJlYWxTY2FsZVR5cGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RIYXNCYXIsIHNlbGVjdENoYXJ0TmFtZSwgcGlja0F4aXNUeXBlXSwgY29tYmluZVJlYWxTY2FsZVR5cGUpOwpmdW5jdGlvbiBnZXREM1NjYWxlRnJvbVR5cGUocmVhbFNjYWxlVHlwZSkgewogIGlmIChyZWFsU2NhbGVUeXBlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChyZWFsU2NhbGVUeXBlIGluIGQzX3NjYWxlX2V4cG9ydHMpIHsKICAgIHJldHVybiBkM19zY2FsZV9leHBvcnRzW3JlYWxTY2FsZVR5cGVdKCk7CiAgfQogIHZhciBuYW1lID0gInNjYWxlIi5jb25jYXQodXBwZXJGaXJzdChyZWFsU2NhbGVUeXBlKSk7CiAgaWYgKG5hbWUgaW4gZDNfc2NhbGVfZXhwb3J0cykgewogICAgcmV0dXJuIGQzX3NjYWxlX2V4cG9ydHNbbmFtZV0oKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBjb21iaW5lU2NhbGVGdW5jdGlvbihheGlzLCByZWFsU2NhbGVUeXBlLCBheGlzRG9tYWluLCBheGlzUmFuZ2UpIHsKICBpZiAoYXhpc0RvbWFpbiA9PSBudWxsIHx8IGF4aXNSYW5nZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIGF4aXMuc2NhbGUgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBheGlzLnNjYWxlLmNvcHkoKS5kb21haW4oYXhpc0RvbWFpbikucmFuZ2UoYXhpc1JhbmdlKTsKICB9CiAgdmFyIGQzU2NhbGVGdW5jdGlvbiA9IGdldEQzU2NhbGVGcm9tVHlwZShyZWFsU2NhbGVUeXBlKTsKICBpZiAoZDNTY2FsZUZ1bmN0aW9uID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBzY2FsZSA9IGQzU2NhbGVGdW5jdGlvbi5kb21haW4oYXhpc0RvbWFpbikucmFuZ2UoYXhpc1JhbmdlKTsKICBjaGVja0RvbWFpbk9mU2NhbGUoc2NhbGUpOwogIHJldHVybiBzY2FsZTsKfQp2YXIgY29tYmluZU5pY2VUaWNrcyA9IChheGlzRG9tYWluLCBheGlzU2V0dGluZ3MsIHJlYWxTY2FsZVR5cGUpID0+IHsKICB2YXIgZG9tYWluRGVmaW5pdGlvbiA9IGdldERvbWFpbkRlZmluaXRpb24oYXhpc1NldHRpbmdzKTsKICBpZiAocmVhbFNjYWxlVHlwZSAhPT0gImF1dG8iICYmIHJlYWxTY2FsZVR5cGUgIT09ICJsaW5lYXIiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoYXhpc1NldHRpbmdzICE9IG51bGwgJiYgYXhpc1NldHRpbmdzLnRpY2tDb3VudCAmJiBBcnJheS5pc0FycmF5KGRvbWFpbkRlZmluaXRpb24pICYmIChkb21haW5EZWZpbml0aW9uWzBdID09PSAiYXV0byIgfHwgZG9tYWluRGVmaW5pdGlvblsxXSA9PT0gImF1dG8iKSAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oYXhpc0RvbWFpbikpIHsKICAgIHJldHVybiBnZXROaWNlVGlja1ZhbHVlcyhheGlzRG9tYWluLCBheGlzU2V0dGluZ3MudGlja0NvdW50LCBheGlzU2V0dGluZ3MuYWxsb3dEZWNpbWFscyk7CiAgfQogIGlmIChheGlzU2V0dGluZ3MgIT0gbnVsbCAmJiBheGlzU2V0dGluZ3MudGlja0NvdW50ICYmIGF4aXNTZXR0aW5ncy50eXBlID09PSAibnVtYmVyIiAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oYXhpc0RvbWFpbikpIHsKICAgIHJldHVybiBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4oYXhpc0RvbWFpbiwgYXhpc1NldHRpbmdzLnRpY2tDb3VudCwgYXhpc1NldHRpbmdzLmFsbG93RGVjaW1hbHMpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0TmljZVRpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEF4aXNEb21haW4sIHNlbGVjdEF4aXNTZXR0aW5ncywgc2VsZWN0UmVhbFNjYWxlVHlwZV0sIGNvbWJpbmVOaWNlVGlja3MpOwp2YXIgY29tYmluZUF4aXNEb21haW5XaXRoTmljZVRpY2tzID0gKGF4aXNTZXR0aW5ncywgZG9tYWluLCBuaWNlVGlja3MsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKAogICAgLyoKICAgICAqIEFuZ2xlIGF4aXMgZm9yIHNvbWUgcmVhc29uIHVzZXMgbmljZSB0aWNrcyB3aGVuIHJlbmRlcmluZyBheGlzIHRpY2sgbGFiZWxzLAogICAgICogYnV0IGRvZXNuJ3QgdXNlIG5pY2UgdGlja3MgZm9yIGV4dGVuZGluZyBkb21haW4gbGlrZSBhbGwgdGhlIG90aGVyIGF4ZXMgZG8uCiAgICAgKiBOb3QgcmVhbGx5IHN1cmUgd2h5PyBJcyB0aGVyZSBhIGdvb2QgcmVhc29uLAogICAgICogb3IgaXMgaXQganVzdCBiZWNhdXNlIHNvbWVvbmUgYWRkZWQgc3VwcG9ydCBmb3IgbmljZSB0aWNrcyB0byB0aGUgb3RoZXIgYXhlcyBhbmQgZm9yZ290IHRoaXMgb25lPwogICAgICovCiAgICBheGlzVHlwZSAhPT0gImFuZ2xlQXhpcyIgJiYgKGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy50eXBlKSA9PT0gIm51bWJlciIgJiYgaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGRvbWFpbikgJiYgQXJyYXkuaXNBcnJheShuaWNlVGlja3MpICYmIG5pY2VUaWNrcy5sZW5ndGggPiAwCiAgKSB7CiAgICB2YXIgbWluRnJvbURvbWFpbiA9IGRvbWFpblswXTsKICAgIHZhciBtaW5Gcm9tVGlja3MgPSBuaWNlVGlja3NbMF07CiAgICB2YXIgbWF4RnJvbURvbWFpbiA9IGRvbWFpblsxXTsKICAgIHZhciBtYXhGcm9tVGlja3MgPSBuaWNlVGlja3NbbmljZVRpY2tzLmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIFtNYXRoLm1pbihtaW5Gcm9tRG9tYWluLCBtaW5Gcm9tVGlja3MpLCBNYXRoLm1heChtYXhGcm9tRG9tYWluLCBtYXhGcm9tVGlja3MpXTsKICB9CiAgcmV0dXJuIGRvbWFpbjsKfTsKdmFyIHNlbGVjdEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNEb21haW4sIHNlbGVjdE5pY2VUaWNrcywgcGlja0F4aXNUeXBlXSwgY29tYmluZUF4aXNEb21haW5XaXRoTmljZVRpY2tzKTsKdmFyIHNlbGVjdFNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QmFzZUF4aXMsIChhbGxEYXRhU3F1aXNoZWQsIGF4aXNTZXR0aW5ncykgPT4gewogIGlmICghYXhpc1NldHRpbmdzIHx8IGF4aXNTZXR0aW5ncy50eXBlICE9PSAibnVtYmVyIikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzID0gSW5maW5pdHk7CiAgdmFyIHNvcnRlZFZhbHVlcyA9IEFycmF5LmZyb20ob25seUFsbG93TnVtYmVycyhhbGxEYXRhU3F1aXNoZWQubWFwKChkKSA9PiBkLnZhbHVlKSkpLnNvcnQoKGEyLCBiKSA9PiBhMiAtIGIpOwogIGlmIChzb3J0ZWRWYWx1ZXMubGVuZ3RoIDwgMikgewogICAgcmV0dXJuIEluZmluaXR5OwogIH0KICB2YXIgZGlmZiA9IHNvcnRlZFZhbHVlc1tzb3J0ZWRWYWx1ZXMubGVuZ3RoIC0gMV0gLSBzb3J0ZWRWYWx1ZXNbMF07CiAgaWYgKGRpZmYgPT09IDApIHsKICAgIHJldHVybiBJbmZpbml0eTsKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRWYWx1ZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICB2YXIgZGlzdGFuY2UgPSBzb3J0ZWRWYWx1ZXNbaSArIDFdIC0gc29ydGVkVmFsdWVzW2ldOwogICAgc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBNYXRoLm1pbihzbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcywgZGlzdGFuY2UpOwogIH0KICByZXR1cm4gc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgLyBkaWZmOwp9KTsKdmFyIHNlbGVjdENhbGN1bGF0ZWRQYWRkaW5nID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0U21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RCYXJDYXRlZ29yeUdhcCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgKF8xLCBfMiwgXzMsIHBhZGRpbmcpID0+IHBhZGRpbmcsIChzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50LCBsYXlvdXQsIGJhckNhdGVnb3J5R2FwLCBvZmZzZXQsIHBhZGRpbmcpID0+IHsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCkpIHsKICAgIHJldHVybiAwOwogIH0KICB2YXIgcmFuZ2VXaWR0aCA9IGxheW91dCA9PT0gInZlcnRpY2FsIiA/IG9mZnNldC5oZWlnaHQgOiBvZmZzZXQud2lkdGg7CiAgaWYgKHBhZGRpbmcgPT09ICJnYXAiKSB7CiAgICByZXR1cm4gc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCAqIHJhbmdlV2lkdGggLyAyOwogIH0KICBpZiAocGFkZGluZyA9PT0gIm5vLWdhcCIpIHsKICAgIHZhciBnYXAgPSBnZXRQZXJjZW50VmFsdWUoYmFyQ2F0ZWdvcnlHYXAsIHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoKTsKICAgIHZhciBoYWxmQmFuZCA9IHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoIC8gMjsKICAgIHJldHVybiBoYWxmQmFuZCAtIGdhcCAtIChoYWxmQmFuZCAtIGdhcCkgLyByYW5nZVdpZHRoICogZ2FwOwogIH0KICByZXR1cm4gMDsKfSk7CnZhciBzZWxlY3RDYWxjdWxhdGVkWEF4aXNQYWRkaW5nID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgeEF4aXNTZXR0aW5ncyA9IHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKHhBeGlzU2V0dGluZ3MgPT0gbnVsbCB8fCB0eXBlb2YgeEF4aXNTZXR0aW5ncy5wYWRkaW5nICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIDA7CiAgfQogIHJldHVybiBzZWxlY3RDYWxjdWxhdGVkUGFkZGluZyhzdGF0ZSwgInhBeGlzIiwgYXhpc0lkLCB4QXhpc1NldHRpbmdzLnBhZGRpbmcpOwp9Owp2YXIgc2VsZWN0Q2FsY3VsYXRlZFlBeGlzUGFkZGluZyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIHlBeGlzU2V0dGluZ3MgPSBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmICh5QXhpc1NldHRpbmdzID09IG51bGwgfHwgdHlwZW9mIHlBeGlzU2V0dGluZ3MucGFkZGluZyAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gc2VsZWN0Q2FsY3VsYXRlZFBhZGRpbmcoc3RhdGUsICJ5QXhpcyIsIGF4aXNJZCwgeUF4aXNTZXR0aW5ncy5wYWRkaW5nKTsKfTsKdmFyIHNlbGVjdFhBeGlzUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFhBeGlzU2V0dGluZ3MsIHNlbGVjdENhbGN1bGF0ZWRYQXhpc1BhZGRpbmcsICh4QXhpc1NldHRpbmdzLCBjYWxjdWxhdGVkKSA9PiB7CiAgdmFyIF9wYWRkaW5nJGxlZnQsIF9wYWRkaW5nJHJpZ2h0OwogIGlmICh4QXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwCiAgICB9OwogIH0KICB2YXIgewogICAgcGFkZGluZwogIH0gPSB4QXhpc1NldHRpbmdzOwogIGlmICh0eXBlb2YgcGFkZGluZyA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IGNhbGN1bGF0ZWQsCiAgICAgIHJpZ2h0OiBjYWxjdWxhdGVkCiAgICB9OwogIH0KICByZXR1cm4gewogICAgbGVmdDogKChfcGFkZGluZyRsZWZ0ID0gcGFkZGluZy5sZWZ0KSAhPT0gbnVsbCAmJiBfcGFkZGluZyRsZWZ0ICE9PSB2b2lkIDAgPyBfcGFkZGluZyRsZWZ0IDogMCkgKyBjYWxjdWxhdGVkLAogICAgcmlnaHQ6ICgoX3BhZGRpbmckcmlnaHQgPSBwYWRkaW5nLnJpZ2h0KSAhPT0gbnVsbCAmJiBfcGFkZGluZyRyaWdodCAhPT0gdm9pZCAwID8gX3BhZGRpbmckcmlnaHQgOiAwKSArIGNhbGN1bGF0ZWQKICB9Owp9KTsKdmFyIHNlbGVjdFlBeGlzUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFlBeGlzU2V0dGluZ3MsIHNlbGVjdENhbGN1bGF0ZWRZQXhpc1BhZGRpbmcsICh5QXhpc1NldHRpbmdzLCBjYWxjdWxhdGVkKSA9PiB7CiAgdmFyIF9wYWRkaW5nJHRvcCwgX3BhZGRpbmckYm90dG9tOwogIGlmICh5QXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHRvcDogMCwKICAgICAgYm90dG9tOiAwCiAgICB9OwogIH0KICB2YXIgewogICAgcGFkZGluZwogIH0gPSB5QXhpc1NldHRpbmdzOwogIGlmICh0eXBlb2YgcGFkZGluZyA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIHRvcDogY2FsY3VsYXRlZCwKICAgICAgYm90dG9tOiBjYWxjdWxhdGVkCiAgICB9OwogIH0KICByZXR1cm4gewogICAgdG9wOiAoKF9wYWRkaW5nJHRvcCA9IHBhZGRpbmcudG9wKSAhPT0gbnVsbCAmJiBfcGFkZGluZyR0b3AgIT09IHZvaWQgMCA/IF9wYWRkaW5nJHRvcCA6IDApICsgY2FsY3VsYXRlZCwKICAgIGJvdHRvbTogKChfcGFkZGluZyRib3R0b20gPSBwYWRkaW5nLmJvdHRvbSkgIT09IG51bGwgJiYgX3BhZGRpbmckYm90dG9tICE9PSB2b2lkIDAgPyBfcGFkZGluZyRib3R0b20gOiAwKSArIGNhbGN1bGF0ZWQKICB9Owp9KTsKdmFyIGNvbWJpbmVYQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzUGFkZGluZywgc2VsZWN0QnJ1c2hEaW1lbnNpb25zLCBzZWxlY3RCcnVzaFNldHRpbmdzLCAoX3N0YXRlLCBfYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hXSwgKG9mZnNldCwgcGFkZGluZywgYnJ1c2hEaW1lbnNpb25zLCBfcmVmNCwgaXNQYW5vcmFtYSkgPT4gewogIHZhciB7CiAgICBwYWRkaW5nOiBicnVzaFBhZGRpbmcKICB9ID0gX3JlZjQ7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBbYnJ1c2hQYWRkaW5nLmxlZnQsIGJydXNoRGltZW5zaW9ucy53aWR0aCAtIGJydXNoUGFkZGluZy5yaWdodF07CiAgfQogIHJldHVybiBbb2Zmc2V0LmxlZnQgKyBwYWRkaW5nLmxlZnQsIG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoIC0gcGFkZGluZy5yaWdodF07Cn0pOwp2YXIgY29tYmluZVlBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFlBeGlzUGFkZGluZywgc2VsZWN0QnJ1c2hEaW1lbnNpb25zLCBzZWxlY3RCcnVzaFNldHRpbmdzLCAoX3N0YXRlLCBfYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hXSwgKG9mZnNldCwgbGF5b3V0LCBwYWRkaW5nLCBicnVzaERpbWVuc2lvbnMsIF9yZWY1LCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIHsKICAgIHBhZGRpbmc6IGJydXNoUGFkZGluZwogIH0gPSBfcmVmNTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIFticnVzaERpbWVuc2lvbnMuaGVpZ2h0IC0gYnJ1c2hQYWRkaW5nLmJvdHRvbSwgYnJ1c2hQYWRkaW5nLnRvcF07CiAgfQogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIFtvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCAtIHBhZGRpbmcuYm90dG9tLCBvZmZzZXQudG9wICsgcGFkZGluZy50b3BdOwogIH0KICByZXR1cm4gW29mZnNldC50b3AgKyBwYWRkaW5nLnRvcCwgb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgLSBwYWRkaW5nLmJvdHRvbV07Cn0pOwp2YXIgc2VsZWN0QXhpc1JhbmdlID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIF9zZWxlY3RaQXhpc1NldHRpbmdzOwogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjoKICAgICAgcmV0dXJuIGNvbWJpbmVYQXhpc1JhbmdlKHN0YXRlLCBheGlzSWQsIGlzUGFub3JhbWEpOwogICAgY2FzZSAieUF4aXMiOgogICAgICByZXR1cm4gY29tYmluZVlBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgICBjYXNlICJ6QXhpcyI6CiAgICAgIHJldHVybiAoX3NlbGVjdFpBeGlzU2V0dGluZ3MgPSBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpKSA9PT0gbnVsbCB8fCBfc2VsZWN0WkF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3NlbGVjdFpBeGlzU2V0dGluZ3MucmFuZ2U7CiAgICBjYXNlICJhbmdsZUF4aXMiOgogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzUmFuZ2Uoc3RhdGUpOwogICAgY2FzZSAicmFkaXVzQXhpcyI6CiAgICAgIHJldHVybiBzZWxlY3RSYWRpdXNBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCk7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gdm9pZCAwOwogIH0KfTsKdmFyIHNlbGVjdEF4aXNSYW5nZVdpdGhSZXZlcnNlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0QXhpc1NjYWxlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzLCBzZWxlY3RBeGlzUmFuZ2VXaXRoUmV2ZXJzZV0sIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKTsKdmFyIHNlbGVjdEVycm9yQmFyc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVSZWxldmFudEVycm9yQmFyU2V0dGluZ3MpOwpmdW5jdGlvbiBjb21wYXJlSWRzKGEyLCBiKSB7CiAgaWYgKGEyLmlkIDwgYi5pZCkgewogICAgcmV0dXJuIC0xOwogIH0KICBpZiAoYTIuaWQgPiBiLmlkKSB7CiAgICByZXR1cm4gMTsKICB9CiAgcmV0dXJuIDA7Cn0KdmFyIHBpY2tBeGlzT3JpZW50YXRpb24gPSAoX3N0YXRlLCBvcmllbnRhdGlvbikgPT4gb3JpZW50YXRpb247CnZhciBwaWNrTWlycm9yID0gKF9zdGF0ZSwgX29yaWVudGF0aW9uLCBtaXJyb3IpID0+IG1pcnJvcjsKdmFyIHNlbGVjdEFsbFhBeGVzV2l0aE9mZnNldFR5cGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxYQXhlcywgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGFsbEF4ZXMsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IGFsbEF4ZXMuZmlsdGVyKChheGlzKSA9PiBheGlzLm9yaWVudGF0aW9uID09PSBvcmllbnRhdGlvbikuZmlsdGVyKChheGlzKSA9PiBheGlzLm1pcnJvciA9PT0gbWlycm9yKS5zb3J0KGNvbXBhcmVJZHMpKTsKdmFyIHNlbGVjdEFsbFlBeGVzV2l0aE9mZnNldFR5cGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxZQXhlcywgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGFsbEF4ZXMsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IGFsbEF4ZXMuZmlsdGVyKChheGlzKSA9PiBheGlzLm9yaWVudGF0aW9uID09PSBvcmllbnRhdGlvbikuZmlsdGVyKChheGlzKSA9PiBheGlzLm1pcnJvciA9PT0gbWlycm9yKS5zb3J0KGNvbXBhcmVJZHMpKTsKdmFyIGdldFhBeGlzU2l6ZSA9IChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHJldHVybiB7CiAgICB3aWR0aDogb2Zmc2V0LndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2V0dGluZ3MuaGVpZ2h0CiAgfTsKfTsKdmFyIGdldFlBeGlzU2l6ZSA9IChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHZhciB3aWR0aCA9IHR5cGVvZiBheGlzU2V0dGluZ3Mud2lkdGggPT09ICJudW1iZXIiID8gYXhpc1NldHRpbmdzLndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgcmV0dXJuIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0OiBvZmZzZXQuaGVpZ2h0CiAgfTsKfTsKdmFyIHNlbGVjdFhBeGlzU2l6ZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzU2V0dGluZ3MsIGdldFhBeGlzU2l6ZSk7CnZhciBjb21iaW5lWEF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQgPSAob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRIZWlnaHQpID0+IHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJ0b3AiOgogICAgICByZXR1cm4gb2Zmc2V0LnRvcDsKICAgIGNhc2UgImJvdHRvbSI6CiAgICAgIHJldHVybiBjaGFydEhlaWdodCAtIG9mZnNldC5ib3R0b207CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gMDsKICB9Cn07CnZhciBjb21iaW5lWUF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQgPSAob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRXaWR0aCkgPT4gewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgICByZXR1cm4gb2Zmc2V0LmxlZnQ7CiAgICBjYXNlICJyaWdodCI6CiAgICAgIHJldHVybiBjaGFydFdpZHRoIC0gb2Zmc2V0LnJpZ2h0OwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIDA7CiAgfQp9Owp2YXIgc2VsZWN0QWxsWEF4ZXNPZmZzZXRTdGVwcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RBbGxYQXhlc1dpdGhPZmZzZXRUeXBlLCBwaWNrQXhpc09yaWVudGF0aW9uLCBwaWNrTWlycm9yLCAoY2hhcnRIZWlnaHQsIG9mZnNldCwgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZSwgb3JpZW50YXRpb24sIG1pcnJvcikgPT4gewogIHZhciBzdGVwcyA9IHt9OwogIHZhciBwb3NpdGlvbjsKICBhbGxBeGVzV2l0aFNhbWVPZmZzZXRUeXBlLmZvckVhY2goKGF4aXMpID0+IHsKICAgIHZhciBheGlzU2l6ZSA9IGdldFhBeGlzU2l6ZShvZmZzZXQsIGF4aXMpOwogICAgaWYgKHBvc2l0aW9uID09IG51bGwpIHsKICAgICAgcG9zaXRpb24gPSBjb21iaW5lWEF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRIZWlnaHQpOwogICAgfQogICAgdmFyIG5lZWRTcGFjZSA9IG9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiBtaXJyb3I7CiAgICBzdGVwc1theGlzLmlkXSA9IHBvc2l0aW9uIC0gTnVtYmVyKG5lZWRTcGFjZSkgKiBheGlzU2l6ZS5oZWlnaHQ7CiAgICBwb3NpdGlvbiArPSAobmVlZFNwYWNlID8gLTEgOiAxKSAqIGF4aXNTaXplLmhlaWdodDsKICB9KTsKICByZXR1cm4gc3RlcHM7Cn0pOwp2YXIgc2VsZWN0QWxsWUF4ZXNPZmZzZXRTdGVwcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdEFsbFlBeGVzV2l0aE9mZnNldFR5cGUsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChjaGFydFdpZHRoLCBvZmZzZXQsIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IHsKICB2YXIgc3RlcHMgPSB7fTsKICB2YXIgcG9zaXRpb247CiAgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZS5mb3JFYWNoKChheGlzKSA9PiB7CiAgICB2YXIgYXhpc1NpemUgPSBnZXRZQXhpc1NpemUob2Zmc2V0LCBheGlzKTsKICAgIGlmIChwb3NpdGlvbiA9PSBudWxsKSB7CiAgICAgIHBvc2l0aW9uID0gY29tYmluZVlBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50KG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0V2lkdGgpOwogICAgfQogICAgdmFyIG5lZWRTcGFjZSA9IG9yaWVudGF0aW9uID09PSAibGVmdCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiBtaXJyb3I7CiAgICBzdGVwc1theGlzLmlkXSA9IHBvc2l0aW9uIC0gTnVtYmVyKG5lZWRTcGFjZSkgKiBheGlzU2l6ZS53aWR0aDsKICAgIHBvc2l0aW9uICs9IChuZWVkU3BhY2UgPyAtMSA6IDEpICogYXhpc1NpemUud2lkdGg7CiAgfSk7CiAgcmV0dXJuIHN0ZXBzOwp9KTsKdmFyIHNlbGVjdFhBeGlzT2Zmc2V0U3RlcHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzU2V0dGluZ3MgPSBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHNlbGVjdEFsbFhBeGVzT2Zmc2V0U3RlcHMoc3RhdGUsIGF4aXNTZXR0aW5ncy5vcmllbnRhdGlvbiwgYXhpc1NldHRpbmdzLm1pcnJvcik7Cn07CnZhciBzZWxlY3RYQXhpc1Bvc2l0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzU2V0dGluZ3MsIHNlbGVjdFhBeGlzT2Zmc2V0U3RlcHMsIChfLCBheGlzSWQpID0+IGF4aXNJZF0sIChvZmZzZXQsIGF4aXNTZXR0aW5ncywgYWxsU3RlcHMsIGF4aXNJZCkgPT4gewogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHN0ZXBPZlRoaXNBeGlzID0gYWxsU3RlcHMgPT09IG51bGwgfHwgYWxsU3RlcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFsbFN0ZXBzW2F4aXNJZF07CiAgaWYgKHN0ZXBPZlRoaXNBeGlzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IG9mZnNldC5sZWZ0LAogICAgICB5OiAwCiAgICB9OwogIH0KICByZXR1cm4gewogICAgeDogb2Zmc2V0LmxlZnQsCiAgICB5OiBzdGVwT2ZUaGlzQXhpcwogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNPZmZzZXRTdGVwcyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXNTZXR0aW5ncyA9IHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gc2VsZWN0QWxsWUF4ZXNPZmZzZXRTdGVwcyhzdGF0ZSwgYXhpc1NldHRpbmdzLm9yaWVudGF0aW9uLCBheGlzU2V0dGluZ3MubWlycm9yKTsKfTsKdmFyIHNlbGVjdFlBeGlzUG9zaXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WUF4aXNTZXR0aW5ncywgc2VsZWN0WUF4aXNPZmZzZXRTdGVwcywgKF8sIGF4aXNJZCkgPT4gYXhpc0lkXSwgKG9mZnNldCwgYXhpc1NldHRpbmdzLCBhbGxTdGVwcywgYXhpc0lkKSA9PiB7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc3RlcE9mVGhpc0F4aXMgPSBhbGxTdGVwcyA9PT0gbnVsbCB8fCBhbGxTdGVwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWxsU3RlcHNbYXhpc0lkXTsKICBpZiAoc3RlcE9mVGhpc0F4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgeDogMCwKICAgICAgeTogb2Zmc2V0LnRvcAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHg6IHN0ZXBPZlRoaXNBeGlzLAogICAgeTogb2Zmc2V0LnRvcAogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNTaXplID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WUF4aXNTZXR0aW5ncywgKG9mZnNldCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgdmFyIHdpZHRoID0gdHlwZW9mIGF4aXNTZXR0aW5ncy53aWR0aCA9PT0gIm51bWJlciIgPyBheGlzU2V0dGluZ3Mud2lkdGggOiBERUZBVUxUX1lfQVhJU19XSURUSDsKICByZXR1cm4gewogICAgd2lkdGgsCiAgICBoZWlnaHQ6IG9mZnNldC5oZWlnaHQKICB9Owp9KTsKdmFyIGNvbWJpbmVEdXBsaWNhdGVEb21haW4gPSAoY2hhcnRMYXlvdXQsIGFwcGxpZWRWYWx1ZXMsIGF4aXMsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgdHlwZSwKICAgIGRhdGFLZXkKICB9ID0gYXhpczsKICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGNoYXJ0TGF5b3V0LCBheGlzVHlwZSk7CiAgdmFyIGFsbERhdGEgPSBhcHBsaWVkVmFsdWVzLm1hcCgoYXYpID0+IGF2LnZhbHVlKTsKICBpZiAoZGF0YUtleSAmJiBpc0NhdGVnb3JpY2FsICYmIHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgJiYgaGFzRHVwbGljYXRlKGFsbERhdGEpKSB7CiAgICByZXR1cm4gYWxsRGF0YTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdER1cGxpY2F0ZURvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QmFzZUF4aXMsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVEdXBsaWNhdGVEb21haW4pOwp2YXIgY29tYmluZUNhdGVnb3JpY2FsRG9tYWluID0gKGxheW91dCwgYXBwbGllZFZhbHVlcywgYXhpcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IGF4aXMuZGF0YUtleSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgdHlwZSwKICAgIHNjYWxlCiAgfSA9IGF4aXM7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiAodHlwZSA9PT0gIm51bWJlciIgfHwgc2NhbGUgIT09ICJhdXRvIikpIHsKICAgIHJldHVybiBhcHBsaWVkVmFsdWVzLm1hcCgoZCkgPT4gZC52YWx1ZSk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QXhpc1NldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4pOwp2YXIgc2VsZWN0QXhpc1Byb3BzTmVlZGVkRm9yQ2FydGVzaWFuR3JpZFRpY2tzR2VuZXJhdG9yID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RDYXJ0ZXNpYW5BeGlzU2V0dGluZ3MsIHNlbGVjdFJlYWxTY2FsZVR5cGUsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0RHVwbGljYXRlRG9tYWluLCBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiwgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3ROaWNlVGlja3MsIHBpY2tBeGlzVHlwZV0sIChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzUmFuZ2UsIG5pY2VUaWNrcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHJldHVybiB7CiAgICBhbmdsZTogYXhpcy5hbmdsZSwKICAgIGludGVydmFsOiBheGlzLmludGVydmFsLAogICAgbWluVGlja0dhcDogYXhpcy5taW5UaWNrR2FwLAogICAgb3JpZW50YXRpb246IGF4aXMub3JpZW50YXRpb24sCiAgICB0aWNrOiBheGlzLnRpY2ssCiAgICB0aWNrQ291bnQ6IGF4aXMudGlja0NvdW50LAogICAgdGlja0Zvcm1hdHRlcjogYXhpcy50aWNrRm9ybWF0dGVyLAogICAgdGlja3M6IGF4aXMudGlja3MsCiAgICB0eXBlOiBheGlzLnR5cGUsCiAgICB1bml0OiBheGlzLnVuaXQsCiAgICBheGlzVHlwZSwKICAgIGNhdGVnb3JpY2FsRG9tYWluLAogICAgZHVwbGljYXRlRG9tYWluLAogICAgaXNDYXRlZ29yaWNhbCwKICAgIG5pY2VUaWNrcywKICAgIHJhbmdlOiBheGlzUmFuZ2UsCiAgICByZWFsU2NhbGVUeXBlLAogICAgc2NhbGUKICB9Owp9KTsKdmFyIGNvbWJpbmVBeGlzVGlja3MgPSAobGF5b3V0LCBheGlzLCByZWFsU2NhbGVUeXBlLCBzY2FsZSwgbmljZVRpY2tzLCBheGlzUmFuZ2UsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBzY2FsZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHZhciB7CiAgICB0eXBlLAogICAgdGlja3M6IHRpY2tzMiwKICAgIHRpY2tDb3VudAogIH0gPSBheGlzOwogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgdHlwZW9mIHNjYWxlLmJhbmR3aWR0aCA9PT0gImZ1bmN0aW9uIiA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gMiA6IDI7CiAgdmFyIG9mZnNldCA9IHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyBvZmZzZXRGb3JCYW5kIDogMDsKICBvZmZzZXQgPSBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgYXhpc1JhbmdlICE9IG51bGwgJiYgYXhpc1JhbmdlLmxlbmd0aCA+PSAyID8gbWF0aFNpZ24oYXhpc1JhbmdlWzBdIC0gYXhpc1JhbmdlWzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgdmFyIHRpY2tzT3JOaWNlVGlja3MgPSB0aWNrczIgfHwgbmljZVRpY2tzOwogIGlmICh0aWNrc09yTmljZVRpY2tzKSB7CiAgICB2YXIgcmVzdWx0ID0gdGlja3NPck5pY2VUaWNrcy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgc2NhbGVDb250ZW50ID0gZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluLmluZGV4T2YoZW50cnkpIDogZW50cnk7CiAgICAgIHJldHVybiB7CiAgICAgICAgaW5kZXgsCiAgICAgICAgLy8gSWYgdGhlIHNjYWxlQ29udGVudCBpcyBub3QgYSBudW1iZXIsIHRoZSBjb29yZGluYXRlIHdpbGwgYmUgTmFOLgogICAgICAgIC8vIFRoYXQgY291bGQgYmUgdGhlIGNhc2UgZm9yIGV4YW1wbGUgd2l0aCBhIFBvaW50U2NhbGUgYW5kIGEgc3RyaW5nIGFzIGRvbWFpbi4KICAgICAgICBjb29yZGluYXRlOiBzY2FsZShzY2FsZUNvbnRlbnQpICsgb2Zmc2V0LAogICAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgICBvZmZzZXQKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5maWx0ZXIoKHJvdykgPT4gaXNXZWxsQmVoYXZlZE51bWJlcihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpLmZpbHRlcigocm93KSA9PiBpc1dlbGxCZWhhdmVkTnVtYmVyKHJvdy5jb29yZGluYXRlKSk7CiAgfQogIGlmIChzY2FsZS50aWNrcykgewogICAgcmV0dXJuIHNjYWxlLnRpY2tzKHRpY2tDb3VudCkubWFwKChlbnRyeSkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBzZWxlY3RUaWNrc09mQXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzU2NhbGUsIHNlbGVjdE5pY2VUaWNrcywgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXhpc1RpY2tzKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtVGlja3MgPSAobGF5b3V0LCBheGlzLCBzY2FsZSwgYXhpc1JhbmdlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCB8fCBheGlzUmFuZ2UgPT0gbnVsbCB8fCBheGlzUmFuZ2VbMF0gPT09IGF4aXNSYW5nZVsxXSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICB2YXIgewogICAgdGlja0NvdW50CiAgfSA9IGF4aXM7CiAgdmFyIG9mZnNldCA9IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIChheGlzUmFuZ2UgPT09IG51bGwgfHwgYXhpc1JhbmdlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzUmFuZ2UubGVuZ3RoKSA+PSAyID8gbWF0aFNpZ24oYXhpc1JhbmdlWzBdIC0gYXhpc1JhbmdlWzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgaWYgKHNjYWxlLnRpY2tzKSB7CiAgICByZXR1cm4gc2NhbGUudGlja3ModGlja0NvdW50KS5tYXAoKGVudHJ5KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIHJldHVybiBzY2FsZS5kb21haW4oKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgIHZhbHVlOiBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW5bZW50cnldIDogZW50cnksCiAgICBpbmRleCwKICAgIG9mZnNldAogIH0pKTsKfTsKdmFyIHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBeGlzU2V0dGluZ3MsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbVRpY2tzKTsKdmFyIHNlbGVjdEF4aXNXaXRoU2NhbGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc1NjYWxlLCAoYXhpcywgc2NhbGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTQoX29iamVjdFNwcmVhZDE0KHt9LCBheGlzKSwge30sIHsKICAgIHNjYWxlCiAgfSk7Cn0pOwp2YXIgc2VsZWN0WkF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0QXhpc1JhbmdlV2l0aFJldmVyc2VdLCBjb21iaW5lU2NhbGVGdW5jdGlvbik7CnZhciBzZWxlY3RaQXhpc1dpdGhTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSwgX2F4aXNUeXBlLCBheGlzSWQpID0+IHNlbGVjdFpBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCksIHNlbGVjdFpBeGlzU2NhbGUsIChheGlzLCBzY2FsZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNChfb2JqZWN0U3ByZWFkMTQoe30sIGF4aXMpLCB7fSwgewogICAgc2NhbGUKICB9KTsKfSk7CnZhciBzZWxlY3RDaGFydERpcmVjdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsWEF4ZXMsIHNlbGVjdEFsbFlBeGVzXSwgKGxheW91dCwgYWxsWEF4ZXMsIGFsbFlBeGVzKSA9PiB7CiAgc3dpdGNoIChsYXlvdXQpIHsKICAgIGNhc2UgImhvcml6b250YWwiOiB7CiAgICAgIHJldHVybiBhbGxYQXhlcy5zb21lKChheGlzKSA9PiBheGlzLnJldmVyc2VkKSA/ICJyaWdodC10by1sZWZ0IiA6ICJsZWZ0LXRvLXJpZ2h0IjsKICAgIH0KICAgIGNhc2UgInZlcnRpY2FsIjogewogICAgICByZXR1cm4gYWxsWUF4ZXMuc29tZSgoYXhpcykgPT4gYXhpcy5yZXZlcnNlZCkgPyAiYm90dG9tLXRvLXRvcCIgOiAidG9wLXRvLWJvdHRvbSI7CiAgICB9CiAgICBjYXNlICJjZW50cmljIjoKICAgIGNhc2UgInJhZGlhbCI6IHsKICAgICAgcmV0dXJuICJsZWZ0LXRvLXJpZ2h0IjsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcEV2ZW50VHlwZS5qcwp2YXIgc2VsZWN0RGVmYXVsdFRvb2x0aXBFdmVudFR5cGUgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMuZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7CnZhciBzZWxlY3RWYWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLnZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXM7CmZ1bmN0aW9uIGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMpIHsKICBpZiAoc2hhcmVkID09IG51bGwpIHsKICAgIHJldHVybiBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTsKICB9CiAgdmFyIGV2ZW50VHlwZSA9IHNoYXJlZCA/ICJheGlzIiA6ICJpdGVtIjsKICBpZiAodmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyA9PSBudWxsKSB7CiAgICByZXR1cm4gZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7CiAgfQogIHJldHVybiB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLmluY2x1ZGVzKGV2ZW50VHlwZSkgPyBldmVudFR5cGUgOiBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTsKfQpmdW5jdGlvbiBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzaGFyZWQpIHsKICB2YXIgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUgPSBzZWxlY3REZWZhdWx0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSk7CiAgdmFyIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMgPSBzZWxlY3RWYWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzKHN0YXRlKTsKICByZXR1cm4gY29tYmluZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkLCBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyk7Cn0KZnVuY3Rpb24gdXNlVG9vbHRpcEV2ZW50VHlwZShzaGFyZWQpIHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzaGFyZWQpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVBY3RpdmVMYWJlbC5qcwp2YXIgY29tYmluZUFjdGl2ZUxhYmVsID0gKHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgpID0+IHsKICB2YXIgX3Rvb2x0aXBUaWNrcyRuOwogIHZhciBuID0gTnVtYmVyKGFjdGl2ZUluZGV4KTsKICBpZiAoaXNOYW4obikgfHwgYWN0aXZlSW5kZXggPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIG4gPj0gMCA/IHRvb2x0aXBUaWNrcyA9PT0gbnVsbCB8fCB0b29sdGlwVGlja3MgPT09IHZvaWQgMCB8fCAoX3Rvb2x0aXBUaWNrcyRuID0gdG9vbHRpcFRpY2tzW25dKSA9PT0gbnVsbCB8fCBfdG9vbHRpcFRpY2tzJG4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90b29sdGlwVGlja3Mkbi52YWx1ZSA6IHZvaWQgMDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBTZXR0aW5ncy5qcwp2YXIgc2VsZWN0VG9vbHRpcFNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS90b29sdGlwU2xpY2UuanMKdmFyIG5vSW50ZXJhY3Rpb24gPSB7CiAgYWN0aXZlOiBmYWxzZSwKICBpbmRleDogbnVsbCwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAsCiAgY29vcmRpbmF0ZTogdm9pZCAwCn07CnZhciBpbml0aWFsU3RhdGUzID0gewogIGl0ZW1JbnRlcmFjdGlvbjogewogICAgY2xpY2s6IG5vSW50ZXJhY3Rpb24sCiAgICBob3Zlcjogbm9JbnRlcmFjdGlvbgogIH0sCiAgYXhpc0ludGVyYWN0aW9uOiB7CiAgICBjbGljazogbm9JbnRlcmFjdGlvbiwKICAgIGhvdmVyOiBub0ludGVyYWN0aW9uCiAgfSwKICBrZXlib2FyZEludGVyYWN0aW9uOiBub0ludGVyYWN0aW9uLAogIHN5bmNJbnRlcmFjdGlvbjogewogICAgYWN0aXZlOiBmYWxzZSwKICAgIGluZGV4OiBudWxsLAogICAgZGF0YUtleTogdm9pZCAwLAogICAgbGFiZWw6IHZvaWQgMCwKICAgIGNvb3JkaW5hdGU6IHZvaWQgMCwKICAgIHNvdXJjZVZpZXdCb3g6IHZvaWQgMCwKICAgIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwCiAgfSwKICB0b29sdGlwSXRlbVBheWxvYWRzOiBbXSwKICBzZXR0aW5nczogewogICAgc2hhcmVkOiB2b2lkIDAsCiAgICB0cmlnZ2VyOiAiaG92ZXIiLAogICAgYXhpc0lkOiAwLAogICAgYWN0aXZlOiBmYWxzZSwKICAgIGRlZmF1bHRJbmRleDogdm9pZCAwCiAgfQp9Owp2YXIgdG9vbHRpcFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJ0b29sdGlwIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTMsCiAgcmVkdWNlcnM6IHsKICAgIGFkZFRvb2x0aXBFbnRyeVNldHRpbmdzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlVG9vbHRpcEVudHJ5U2V0dGluZ3M6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnRvb2x0aXBJdGVtUGF5bG9hZHMuaW5kZXhPZihjYXN0RHJhZnQocHJldikpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzW2luZGV4XSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlVG9vbHRpcEVudHJ5U2V0dGluZ3M6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkudG9vbHRpcEl0ZW1QYXlsb2Fkcy5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHNldFRvb2x0aXBTZXR0aW5nc1N0YXRlKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc2V0dGluZ3MgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXRBY3RpdmVNb3VzZU92ZXJJdGVtSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZ3JhcGhpY2FsSXRlbUlkID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlR3JhcGhpY2FsSXRlbUlkOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgbW91c2VMZWF2ZUNoYXJ0KHN0YXRlKSB7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgfSwKICAgIG1vdXNlTGVhdmVJdGVtKHN0YXRlKSB7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSBmYWxzZTsKICAgIH0sCiAgICBzZXRBY3RpdmVDbGlja0l0ZW1JbmRleChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmFjdGl2ZSA9IHRydWU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5ncmFwaGljYWxJdGVtSWQgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVHcmFwaGljYWxJdGVtSWQ7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgIH0sCiAgICBzZXRNb3VzZU92ZXJBeGlzSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgc2V0TW91c2VDbGlja0F4aXNJbmRleChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmFjdGl2ZSA9IHRydWU7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgIH0sCiAgICBzZXRTeW5jSW50ZXJhY3Rpb24oc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24gPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXRLZXlib2FyZEludGVyYWN0aW9uKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZFRvb2x0aXBFbnRyeVNldHRpbmdzLAogIHJlcGxhY2VUb29sdGlwRW50cnlTZXR0aW5ncywKICByZW1vdmVUb29sdGlwRW50cnlTZXR0aW5ncywKICBzZXRUb29sdGlwU2V0dGluZ3NTdGF0ZSwKICBzZXRBY3RpdmVNb3VzZU92ZXJJdGVtSW5kZXgsCiAgbW91c2VMZWF2ZUl0ZW0sCiAgbW91c2VMZWF2ZUNoYXJ0LAogIHNldEFjdGl2ZUNsaWNrSXRlbUluZGV4LAogIHNldE1vdXNlT3ZlckF4aXNJbmRleCwKICBzZXRNb3VzZUNsaWNrQXhpc0luZGV4LAogIHNldFN5bmNJbnRlcmFjdGlvbiwKICBzZXRLZXlib2FyZEludGVyYWN0aW9uCn0gPSB0b29sdGlwU2xpY2UuYWN0aW9uczsKdmFyIHRvb2x0aXBSZWR1Y2VyID0gdG9vbHRpcFNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmpzCmZ1bmN0aW9uIG93bktleXMxNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTUoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE1KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBjaG9vc2VBcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24odG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgaWYgKHRyaWdnZXIgPT09ICJjbGljayIpIHsKICAgICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2s7CiAgICB9CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3ZlcjsKICB9CiAgaWYgKHRyaWdnZXIgPT09ICJjbGljayIpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrOwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3ZlcjsKfQpmdW5jdGlvbiBoYXNCZWVuQWN0aXZlUHJldmlvdXNseSh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSkgewogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5pbmRleCAhPSBudWxsOwp9CnZhciBjb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUgPSAodG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXgpID0+IHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbm9JbnRlcmFjdGlvbjsKICB9CiAgdmFyIGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbiA9IGNob29zZUFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbih0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpOwogIGlmIChhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIG5vSW50ZXJhY3Rpb247CiAgfQogIGlmIChhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICByZXR1cm4gYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uOwogIH0KICBpZiAodG9vbHRpcFN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb247CiAgfQogIGlmICh0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSAmJiB0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uLmluZGV4ICE9IG51bGwpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uOwogIH0KICB2YXIgYWN0aXZlRnJvbVByb3BzID0gdG9vbHRpcFN0YXRlLnNldHRpbmdzLmFjdGl2ZSA9PT0gdHJ1ZTsKICBpZiAoaGFzQmVlbkFjdGl2ZVByZXZpb3VzbHkoYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKSkgewogICAgaWYgKGFjdGl2ZUZyb21Qcm9wcykgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDE1KF9vYmplY3RTcHJlYWQxNSh7fSwgYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKSwge30sIHsKICAgICAgICBhY3RpdmU6IHRydWUKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChkZWZhdWx0SW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgYWN0aXZlOiB0cnVlLAogICAgICBjb29yZGluYXRlOiB2b2lkIDAsCiAgICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgICAgaW5kZXg6IGRlZmF1bHRJbmRleCwKICAgICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICAgIH07CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTUoX29iamVjdFNwcmVhZDE1KHt9LCBub0ludGVyYWN0aW9uKSwge30sIHsKICAgIGNvb3JkaW5hdGU6IGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbi5jb29yZGluYXRlCiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleC5qcwpmdW5jdGlvbiB0b0Zpbml0ZU51bWJlcih2YWx1ZSkgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHZhbHVlKSA/IHZhbHVlIDogdm9pZCAwOwogIH0KICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICB2YXIgbnVtZXJpY1ZhbHVlID0gdmFsdWUudmFsdWVPZigpOwogICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShudW1lcmljVmFsdWUpID8gbnVtZXJpY1ZhbHVlIDogdm9pZCAwOwogIH0KICB2YXIgcGFyc2VkID0gTnVtYmVyKHZhbHVlKTsKICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHBhcnNlZCkgPyBwYXJzZWQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gaXNWYWx1ZVdpdGhpbk51bWJlckRvbWFpbih2YWx1ZSwgZG9tYWluKSB7CiAgdmFyIG51bWVyaWNWYWx1ZSA9IHRvRmluaXRlTnVtYmVyKHZhbHVlKTsKICB2YXIgbG93ZXJCb3VuZCA9IGRvbWFpblswXTsKICB2YXIgdXBwZXJCb3VuZCA9IGRvbWFpblsxXTsKICBpZiAobnVtZXJpY1ZhbHVlID09PSB2b2lkIDApIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihsb3dlckJvdW5kLCB1cHBlckJvdW5kKTsKICB2YXIgbWF4MiA9IE1hdGgubWF4KGxvd2VyQm91bmQsIHVwcGVyQm91bmQpOwogIHJldHVybiBudW1lcmljVmFsdWUgPj0gbWluMiAmJiBudW1lcmljVmFsdWUgPD0gbWF4MjsKfQpmdW5jdGlvbiBpc1ZhbHVlV2l0aGluRG9tYWluKGVudHJ5LCBheGlzRGF0YUtleSwgZG9tYWluKSB7CiAgaWYgKGRvbWFpbiA9PSBudWxsIHx8IGF4aXNEYXRhS2V5ID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICB2YXIgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgYXhpc0RhdGFLZXkpOwogIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKCFpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oZG9tYWluKSkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBpc1ZhbHVlV2l0aGluTnVtYmVyRG9tYWluKHZhbHVlLCBkb21haW4pOwp9CnZhciBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4ID0gKHRvb2x0aXBJbnRlcmFjdGlvbiwgY2hhcnREYXRhLCBheGlzRGF0YUtleSwgZG9tYWluKSA9PiB7CiAgdmFyIGRlc2lyZWRJbmRleCA9IHRvb2x0aXBJbnRlcmFjdGlvbiA9PT0gbnVsbCB8fCB0b29sdGlwSW50ZXJhY3Rpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBJbnRlcmFjdGlvbi5pbmRleDsKICBpZiAoZGVzaXJlZEluZGV4ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgaW5kZXhBc051bWJlciA9IE51bWJlcihkZXNpcmVkSW5kZXgpOwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihpbmRleEFzTnVtYmVyKSkgewogICAgcmV0dXJuIGRlc2lyZWRJbmRleDsKICB9CiAgdmFyIGxvd2VyTGltaXQgPSAwOwogIHZhciB1cHBlckxpbWl0ID0gSW5maW5pdHk7CiAgaWYgKGNoYXJ0RGF0YS5sZW5ndGggPiAwKSB7CiAgICB1cHBlckxpbWl0ID0gY2hhcnREYXRhLmxlbmd0aCAtIDE7CiAgfQogIHZhciBjbGFtcGVkSW5kZXggPSBNYXRoLm1heChsb3dlckxpbWl0LCBNYXRoLm1pbihpbmRleEFzTnVtYmVyLCB1cHBlckxpbWl0KSk7CiAgdmFyIGVudHJ5ID0gY2hhcnREYXRhW2NsYW1wZWRJbmRleF07CiAgaWYgKGVudHJ5ID09IG51bGwpIHsKICAgIHJldHVybiBTdHJpbmcoY2xhbXBlZEluZGV4KTsKICB9CiAgaWYgKCFpc1ZhbHVlV2l0aGluRG9tYWluKGVudHJ5LCBheGlzRGF0YUtleSwgZG9tYWluKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBTdHJpbmcoY2xhbXBlZEluZGV4KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleC5qcwp2YXIgY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXggPSAod2lkdGgsIGhlaWdodCwgbGF5b3V0LCBvZmZzZXQsIHRvb2x0aXBUaWNrcywgZGVmYXVsdEluZGV4LCB0b29sdGlwQ29uZmlndXJhdGlvbnMsIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIpID0+IHsKICBpZiAoZGVmYXVsdEluZGV4ID09IG51bGwgfHwgdG9vbHRpcFBheWxvYWRTZWFyY2hlciA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZmlyc3RDb25maWd1cmF0aW9uID0gdG9vbHRpcENvbmZpZ3VyYXRpb25zWzBdOwogIHZhciBtYXliZVBvc2l0aW9uID0gZmlyc3RDb25maWd1cmF0aW9uID09IG51bGwgPyB2b2lkIDAgOiB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKGZpcnN0Q29uZmlndXJhdGlvbi5wb3NpdGlvbnMsIGRlZmF1bHRJbmRleCk7CiAgaWYgKG1heWJlUG9zaXRpb24gIT0gbnVsbCkgewogICAgcmV0dXJuIG1heWJlUG9zaXRpb247CiAgfQogIHZhciB0aWNrID0gdG9vbHRpcFRpY2tzID09PSBudWxsIHx8IHRvb2x0aXBUaWNrcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdG9vbHRpcFRpY2tzW051bWJlcihkZWZhdWx0SW5kZXgpXTsKICBpZiAoIXRpY2spIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHN3aXRjaCAobGF5b3V0KSB7CiAgICBjYXNlICJob3Jpem9udGFsIjogewogICAgICByZXR1cm4gewogICAgICAgIHg6IHRpY2suY29vcmRpbmF0ZSwKICAgICAgICB5OiAob2Zmc2V0LnRvcCArIGhlaWdodCkgLyAyCiAgICAgIH07CiAgICB9CiAgICBkZWZhdWx0OiB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogKG9mZnNldC5sZWZ0ICsgd2lkdGgpIC8gMiwKICAgICAgICB5OiB0aWNrLmNvb3JkaW5hdGUKICAgICAgfTsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMuanMKdmFyIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zID0gKHRvb2x0aXBTdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4KSA9PiB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzOwogIH0KICBpZiAodG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gW107CiAgfQogIHZhciBmaWx0ZXJCeURhdGFLZXk7CiAgaWYgKHRyaWdnZXIgPT09ICJob3ZlciIpIHsKICAgIGZpbHRlckJ5RGF0YUtleSA9IHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleTsKICB9IGVsc2UgewogICAgZmlsdGVyQnlEYXRhS2V5ID0gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5OwogIH0KICBpZiAoZmlsdGVyQnlEYXRhS2V5ID09IG51bGwgJiYgZGVmYXVsdEluZGV4ICE9IG51bGwpIHsKICAgIHJldHVybiBbdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHNbMF1dOwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMuZmlsdGVyKCh0cGMpID0+IHsKICAgIHZhciBfdHBjJHNldHRpbmdzOwogICAgcmV0dXJuICgoX3RwYyRzZXR0aW5ncyA9IHRwYy5zZXR0aW5ncykgPT09IG51bGwgfHwgX3RwYyRzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RwYyRzZXR0aW5ncy5kYXRhS2V5KSA9PT0gZmlsdGVyQnlEYXRhS2V5OwogIH0pOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlci5qcwp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy50b29sdGlwUGF5bG9hZFNlYXJjaGVyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcFN0YXRlLmpzCnZhciBzZWxlY3RUb29sdGlwU3RhdGUgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXA7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBQYXlsb2FkLmpzCmZ1bmN0aW9uIG93bktleXMxNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE2KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE2KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBzZWxlY3RGaW5hbERhdGEoZGF0YURlZmluZWRPbkl0ZW0sIGRhdGFEZWZpbmVkT25DaGFydCkgewogIGlmIChkYXRhRGVmaW5lZE9uSXRlbSAhPSBudWxsKSB7CiAgICByZXR1cm4gZGF0YURlZmluZWRPbkl0ZW07CiAgfQogIHJldHVybiBkYXRhRGVmaW5lZE9uQ2hhcnQ7Cn0KdmFyIGNvbWJpbmVUb29sdGlwUGF5bG9hZCA9ICh0b29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBhY3RpdmVJbmRleCwgY2hhcnREYXRhU3RhdGUsIHRvb2x0aXBBeGlzRGF0YUtleSwgYWN0aXZlTGFiZWwsIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHRvb2x0aXBFdmVudFR5cGUpID0+IHsKICBpZiAoYWN0aXZlSW5kZXggPT0gbnVsbCB8fCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBjaGFydERhdGEsCiAgICBjb21wdXRlZERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBjaGFydERhdGFTdGF0ZTsKICB2YXIgaW5pdCA9IFtdOwogIHJldHVybiB0b29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLnJlZHVjZSgoYWdnLCBfcmVmMikgPT4gewogICAgdmFyIF9zZXR0aW5ncyRkYXRhS2V5OwogICAgdmFyIHsKICAgICAgZGF0YURlZmluZWRPbkl0ZW0sCiAgICAgIHNldHRpbmdzCiAgICB9ID0gX3JlZjI7CiAgICB2YXIgZmluYWxEYXRhID0gc2VsZWN0RmluYWxEYXRhKGRhdGFEZWZpbmVkT25JdGVtLCBjaGFydERhdGEpOwogICAgdmFyIHNsaWNlZCA9IEFycmF5LmlzQXJyYXkoZmluYWxEYXRhKSA/IGdldFNsaWNlZChmaW5hbERhdGEsIGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXgpIDogZmluYWxEYXRhOwogICAgdmFyIGZpbmFsRGF0YUtleSA9IChfc2V0dGluZ3MkZGF0YUtleSA9IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy5kYXRhS2V5KSAhPT0gbnVsbCAmJiBfc2V0dGluZ3MkZGF0YUtleSAhPT0gdm9pZCAwID8gX3NldHRpbmdzJGRhdGFLZXkgOiB0b29sdGlwQXhpc0RhdGFLZXk7CiAgICB2YXIgZmluYWxOYW1lS2V5ID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLm5hbWVLZXk7CiAgICB2YXIgdG9vbHRpcFBheWxvYWQ7CiAgICBpZiAodG9vbHRpcEF4aXNEYXRhS2V5ICYmIEFycmF5LmlzQXJyYXkoc2xpY2VkKSAmJiAvKgogICAgICogZmluZEVudHJ5SW5BcnJheSB3b24ndCB3b3JrIGZvciBTY2F0dGVyIGJlY2F1c2UgU2NhdHRlciBwcm92aWRlcyBhbiBhcnJheSBvZiBhcnJheXMKICAgICAqIGFzIHRvb2x0aXAgcGF5bG9hZHMgYW5kIGZpbmRFbnRyeUluQXJyYXkgaXMgbm90IHByZXBhcmVkIHRvIGhhbmRsZSB0aGF0LgogICAgICogU2FkIGJ1dCBhbHNvIFNjYXR0ZXJDaGFydCBvbmx5IGFsbG93cyAnaXRlbScgdG9vbHRpcEV2ZW50VHlwZQogICAgICogYW5kIGFsc28gdGhpcyBpcyBvbmx5IGEgcHJvYmxlbSBpZiB0aGVyZSBhcmUgbXVsdGlwbGUgU2NhdHRlcnMgYW5kIGVhY2ggaGFzIGl0cyBvd24gZGF0YSBhcnJheQogICAgICogc28gbGV0J3MgZml4IHRoYXQgc29tZSBvdGhlciB0aW1lLgogICAgICovCiAgICAhQXJyYXkuaXNBcnJheShzbGljZWRbMF0pICYmIC8qCiAgICAgKiBJZiB0aGUgdG9vbHRpcEV2ZW50VHlwZSBpcyAnYXhpcycsIHdlIHNob3VsZCBzZWFyY2ggZm9yIHRoZSBkYXRhS2V5IGluIHRoZSBzbGljZWQgZGF0YQogICAgICogYmVjYXVzZSB0aGFua3MgdG8gYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk9ZmFsc2UsIHRoZSBvcmRlciBvZiBlbGVtZW50cyBpbiB0aGUgYXJyYXkKICAgICAqIG5vIGxvbmdlciBtYXRjaGVzIHRoZSBvcmRlciBvZiBlbGVtZW50cyBpbiB0aGUgb3JpZ2luYWwgZGF0YQogICAgICogYW5kIHNvIHdlIG5lZWQgdG8gc2VhcmNoIGJ5IHRoZSBhY3RpdmUgZGF0YUtleSArIGxhYmVsIHJhdGhlciB0aGFuIGJ5IGluZGV4LgogICAgICoKICAgICAqIFRoZSBzYW1lIGhhcHBlbnMgaWYgbXVsdGlwbGUgZ3JhcGhpY2FsIGl0ZW1zIGFyZSBwcmVzZW50IGluIHRoZSBjaGFydAogICAgICogYW5kIGVhY2ggb2YgdGhlbSBoYXMgaXRzIG93biBkYXRhIGFycmF5LiBUaG9zZSBhcnJheXMgZ2V0IGNvbmNhdGVuYXRlZAogICAgICogYW5kIGFnYWluIHRoZSB0b29sdGlwIGluZGV4IG5vIGxvbmdlciBtYXRjaGVzIHRoZSBvcmlnaW5hbCBkYXRhLgogICAgICoKICAgICAqIE9uIHRoZSBvdGhlciBoYW5kIHRoZSB0b29sdGlwRXZlbnRUeXBlICdpdGVtJyBzaG91bGQgYWx3YXlzIHNlYXJjaCBieSBpbmRleAogICAgICogYmVjYXVzZSB3ZSBnZXQgdGhlIGluZGV4IGZyb20gaW50ZXJhY3Rpbmcgb3ZlciB0aGUgaW5kaXZpZHVhbCBlbGVtZW50cwogICAgICogd2hpY2ggaXMgYWx3YXlzIGFjY3VyYXRlLCBpcnJlc3BlY3RpdmUgb2YgdGhlIGFsbG93RHVwbGljYXRlZENhdGVnb3J5IHNldHRpbmcuCiAgICAgKi8KICAgIHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgICB0b29sdGlwUGF5bG9hZCA9IGZpbmRFbnRyeUluQXJyYXkoc2xpY2VkLCB0b29sdGlwQXhpc0RhdGFLZXksIGFjdGl2ZUxhYmVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRvb2x0aXBQYXlsb2FkID0gdG9vbHRpcFBheWxvYWRTZWFyY2hlcihzbGljZWQsIGFjdGl2ZUluZGV4LCBjb21wdXRlZERhdGEsIGZpbmFsTmFtZUtleSk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0b29sdGlwUGF5bG9hZCkpIHsKICAgICAgdG9vbHRpcFBheWxvYWQuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICAgIHZhciBuZXdTZXR0aW5ncyA9IF9vYmplY3RTcHJlYWQxNihfb2JqZWN0U3ByZWFkMTYoe30sIHNldHRpbmdzKSwge30sIHsKICAgICAgICAgIG5hbWU6IGl0ZW0ubmFtZSwKICAgICAgICAgIHVuaXQ6IGl0ZW0udW5pdCwKICAgICAgICAgIC8vIGNvbG9yIGFuZCBmaWxsIGFyZSBlcmFzZWQgdG8ga2VlcCAxMDAlIHRoZSBpZGVudGljYWwgYmVoYXZpb3VyIHRvIHJlY2hhcnRzIDIueCAtIGJ1dCB0aGVyZSdzIG5vdGhpbmcgc3RvcHBpbmcgdXMgZnJvbSByZXR1cm5pbmcgdGhlbSBoZXJlLiBJdCdzIHRlY2huaWNhbGx5IGEgYnJlYWtpbmcgY2hhbmdlLgogICAgICAgICAgY29sb3I6IHZvaWQgMCwKICAgICAgICAgIC8vIGNvbG9yIGFuZCBmaWxsIGFyZSBlcmFzZWQgdG8ga2VlcCAxMDAlIHRoZSBpZGVudGljYWwgYmVoYXZpb3VyIHRvIHJlY2hhcnRzIDIueCAtIGJ1dCB0aGVyZSdzIG5vdGhpbmcgc3RvcHBpbmcgdXMgZnJvbSByZXR1cm5pbmcgdGhlbSBoZXJlLiBJdCdzIHRlY2huaWNhbGx5IGEgYnJlYWtpbmcgY2hhbmdlLgogICAgICAgICAgZmlsbDogdm9pZCAwCiAgICAgICAgfSk7CiAgICAgICAgYWdnLnB1c2goZ2V0VG9vbHRpcEVudHJ5KHsKICAgICAgICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzOiBuZXdTZXR0aW5ncywKICAgICAgICAgIGRhdGFLZXk6IGl0ZW0uZGF0YUtleSwKICAgICAgICAgIHBheWxvYWQ6IGl0ZW0ucGF5bG9hZCwKICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkoaXRlbS5wYXlsb2FkLCBpdGVtLmRhdGFLZXkpLAogICAgICAgICAgbmFtZTogaXRlbS5uYW1lCiAgICAgICAgfSkpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBfZ2V0VmFsdWVCeURhdGFLZXk7CiAgICAgIGFnZy5wdXNoKGdldFRvb2x0aXBFbnRyeSh7CiAgICAgICAgdG9vbHRpcEVudHJ5U2V0dGluZ3M6IHNldHRpbmdzLAogICAgICAgIGRhdGFLZXk6IGZpbmFsRGF0YUtleSwKICAgICAgICBwYXlsb2FkOiB0b29sdGlwUGF5bG9hZCwKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFZhbHVlQnlEYXRhS2V5IGRvZXMgbm90IHZhbGlkYXRlIHRoZSBvdXRwdXQgdHlwZQogICAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleSh0b29sdGlwUGF5bG9hZCwgZmluYWxEYXRhS2V5KSwKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFZhbHVlQnlEYXRhS2V5IGRvZXMgbm90IHZhbGlkYXRlIHRoZSBvdXRwdXQgdHlwZQogICAgICAgIG5hbWU6IChfZ2V0VmFsdWVCeURhdGFLZXkgPSBnZXRWYWx1ZUJ5RGF0YUtleSh0b29sdGlwUGF5bG9hZCwgZmluYWxOYW1lS2V5KSkgIT09IG51bGwgJiYgX2dldFZhbHVlQnlEYXRhS2V5ICE9PSB2b2lkIDAgPyBfZ2V0VmFsdWVCeURhdGFLZXkgOiBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MubmFtZQogICAgICB9KSk7CiAgICB9CiAgICByZXR1cm4gYWdnOwogIH0sIGluaXQpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvdG9vbHRpcFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0SGFzQmFyLCBzZWxlY3RDaGFydE5hbWUsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVSZWFsU2NhbGVUeXBlKTsKdmFyIHNlbGVjdEFsbFVuZmlsdGVyZWRHcmFwaGljYWxJdGVtcyA9IGNyZWF0ZVNlbGVjdG9yKFsoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zLCAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLnBvbGFySXRlbXNdLCAoY2FydGVzaWFuSXRlbXMsIHBvbGFySXRlbXMpID0+IFsuLi5jYXJ0ZXNpYW5JdGVtcywgLi4ucG9sYXJJdGVtc10pOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNQcmVkaWNhdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0lkXSwgaXRlbUF4aXNQcmVkaWNhdGUpOwp2YXIgc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxVbmZpbHRlcmVkR3JhcGhpY2FsSXRlbXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1ByZWRpY2F0ZV0sIGNvbWJpbmVHcmFwaGljYWxJdGVtc1NldHRpbmdzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgKGdyYXBoaWNhbEl0ZW1zKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoaXNTdGFja2VkKSk7CnZhciBzZWxlY3RUb29sdGlwR3JhcGhpY2FsSXRlbXNEYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNEYXRhLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwR3JhcGhpY2FsSXRlbXNEYXRhLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc10sIGNvbWJpbmVEaXNwbGF5ZWREYXRhKTsKdmFyIHNlbGVjdFRvb2x0aXBTdGFja2VkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzXSwgY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhKTsKdmFyIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGNvbWJpbmVBcHBsaWVkVmFsdWVzKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIGdldERvbWFpbkRlZmluaXRpb24pOwp2YXIgc2VsZWN0VG9vbHRpcERhdGFPdmVyZmxvdyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIChheGlzU2V0dGluZ3MpID0+IGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7CnZhciBzZWxlY3RUb29sdGlwRG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkRlZmluaXRpb24sIHNlbGVjdFRvb2x0aXBEYXRhT3ZlcmZsb3ddLCBudW1lcmljYWxEb21haW5TcGVjaWZpZWRXaXRob3V0UmVxdWlyaW5nRGF0YSk7CnZhciBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIChncmFwaGljYWxJdGVtcykgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKGlzU3RhY2tlZCkpOwp2YXIgc2VsZWN0VG9vbHRpcFN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGFja2VkRGF0YSwgc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHNlbGVjdFJldmVyc2VTdGFja09yZGVyXSwgY29tYmluZVN0YWNrR3JvdXBzKTsKdmFyIHNlbGVjdFRvb2x0aXBEb21haW5PZlN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGFja0dyb3Vwcywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXNdLCBjb21iaW5lRG9tYWluT2ZTdGFja0dyb3Vwcyk7CnZhciBzZWxlY3RUb29sdGlwSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyk7CnZhciBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlczIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNCeVRvb2x0aXBBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VEb3RzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHNCeVRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRG90c0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhc0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlQXJlYXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VBcmVhc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhc0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVBcmVhc0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VMaW5lc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lc0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVMaW5lc0RvbWFpbik7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlRWxlbWVudHNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFJlZmVyZW5jZURvdHNEb21haW4sIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VMaW5lc0RvbWFpbiwgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUFyZWFzRG9tYWluXSwgbWVyZ2VEb21haW5zKTsKdmFyIHNlbGVjdFRvb2x0aXBOdW1lcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXMsIHNlbGVjdFRvb2x0aXBEb21haW5PZlN0YWNrR3JvdXBzLCBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlczIsIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVOdW1lcmljYWxEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwTnVtZXJpY2FsRG9tYWluXSwgY29tYmluZUF4aXNEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcE5pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc0RvbWFpbiwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZV0sIGNvbWJpbmVOaWNlVGlja3MpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluLCBzZWxlY3RUb29sdGlwTmljZVRpY2tzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZSA9IChzdGF0ZSkgPT4gewogIHZhciBheGlzVHlwZSA9IHNlbGVjdFRvb2x0aXBBeGlzVHlwZShzdGF0ZSk7CiAgdmFyIGF4aXNJZCA9IHNlbGVjdFRvb2x0aXBBeGlzSWQoc3RhdGUpOwogIHZhciBpc1Bhbm9yYW1hID0gZmFsc2U7CiAgcmV0dXJuIHNlbGVjdEF4aXNSYW5nZShzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7Cn07CnZhciBzZWxlY3RUb29sdGlwQXhpc1JhbmdlV2l0aFJldmVyc2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcywgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlXSwgY29tYmluZVNjYWxlRnVuY3Rpb24pOwp2YXIgc2VsZWN0VG9vbHRpcER1cGxpY2F0ZURvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRHVwbGljYXRlRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBDYXRlZ29yaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4pOwp2YXIgY29tYmluZVRpY2tzT2ZUb29sdGlwQXhpcyA9IChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCByYW5nZTQsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKCFheGlzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgdHlwZQogIH0gPSBheGlzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKCFzY2FsZSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG9mZnNldEZvckJhbmQgPSByZWFsU2NhbGVUeXBlID09PSAic2NhbGVCYW5kIiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIHJhbmdlNCAhPSBudWxsICYmIChyYW5nZTQgPT09IG51bGwgfHwgcmFuZ2U0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByYW5nZTQubGVuZ3RoKSA+PSAyID8gbWF0aFNpZ24ocmFuZ2U0WzBdIC0gcmFuZ2U0WzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSwgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZSwgc2VsZWN0VG9vbHRpcER1cGxpY2F0ZURvbWFpbiwgc2VsZWN0VG9vbHRpcENhdGVnb3JpY2FsRG9tYWluLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lVGlja3NPZlRvb2x0aXBBeGlzKTsKdmFyIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCBzZWxlY3RWYWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLCBzZWxlY3RUb29sdGlwU2V0dGluZ3NdLCAoZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZSwgc2V0dGluZ3MpID0+IGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNldHRpbmdzLnNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZSkpOwp2YXIgc2VsZWN0VG9vbHRpcFRyaWdnZXIgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MudHJpZ2dlcjsKdmFyIHNlbGVjdERlZmF1bHRJbmRleCA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5kZWZhdWx0SW5kZXg7CnZhciBzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyLCBzZWxlY3RUb29sdGlwVHJpZ2dlciwgc2VsZWN0RGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5dLCBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KTsKdmFyIHNlbGVjdEFjdGl2ZUxhYmVsID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleF0sIGNvbWJpbmVBY3RpdmVMYWJlbCk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwRGF0YUtleSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb24pID0+IHsKICBpZiAoIXRvb2x0aXBJbnRlcmFjdGlvbikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvbi5kYXRhS2V5Owp9KTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBHcmFwaGljYWxJdGVtSWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGVdLCAodG9vbHRpcEludGVyYWN0aW9uKSA9PiB7CiAgaWYgKCF0b29sdGlwSW50ZXJhY3Rpb24pIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb24uZ3JhcGhpY2FsSXRlbUlkOwp9KTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMiwgc2VsZWN0VG9vbHRpcFRyaWdnZXIsIHNlbGVjdERlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zKTsKdmFyIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0RGVmYXVsdEluZGV4LCBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyXSwgY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcENvb3JkaW5hdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4XSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBkZWZhdWx0SW5kZXhDb29yZGluYXRlKSA9PiB7CiAgaWYgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlICE9PSBudWxsICYmIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlICE9PSB2b2lkIDAgJiYgdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuY29vcmRpbmF0ZSkgewogICAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmNvb3JkaW5hdGU7CiAgfQogIHJldHVybiBkZWZhdWx0SW5kZXhDb29yZGluYXRlOwp9KTsKdmFyIHNlbGVjdElzVG9vbHRpcEFjdGl2ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSkgPT4gdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuYWN0aXZlKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMsIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0QWN0aXZlTGFiZWwsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyXSwgY29tYmluZVRvb2x0aXBQYXlsb2FkKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFjdGl2ZVRvb2x0aXBQYXlsb2FkXSwgKHBheWxvYWQpID0+IHsKICBpZiAocGF5bG9hZCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZGF0YVBvaW50cyA9IHBheWxvYWQubWFwKChwKSA9PiBwLnBheWxvYWQpLmZpbHRlcigocCkgPT4gcCAhPSBudWxsKTsKICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KGRhdGFQb2ludHMpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvdXNlVG9vbHRpcEF4aXMuanMKZnVuY3Rpb24gb3duS2V5czE3KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTcoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTcoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTcoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE3KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTcocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTcodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTcodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTcodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciB1c2VUb29sdGlwQXhpcyA9ICgpID0+IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzKTsKdmFyIHVzZVRvb2x0aXBBeGlzQmFuZFNpemUgPSAoKSA9PiB7CiAgdmFyIHRvb2x0aXBBeGlzID0gdXNlVG9vbHRpcEF4aXMoKTsKICB2YXIgdG9vbHRpcFRpY2tzID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyk7CiAgdmFyIHRvb2x0aXBBeGlzU2NhbGUgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpc1NjYWxlKTsKICBpZiAoIXRvb2x0aXBBeGlzIHx8ICF0b29sdGlwQXhpc1NjYWxlKSB7CiAgICByZXR1cm4gZ2V0QmFuZFNpemVPZkF4aXModm9pZCAwLCB0b29sdGlwVGlja3MpOwogIH0KICByZXR1cm4gZ2V0QmFuZFNpemVPZkF4aXMoX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyh7fSwgdG9vbHRpcEF4aXMpLCB7fSwgewogICAgc2NhbGU6IHRvb2x0aXBBeGlzU2NhbGUKICB9KSwgdG9vbHRpcFRpY2tzKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3NvcnRCeTQgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRBY3RpdmVDb29yZGluYXRlLmpzCmZ1bmN0aW9uIG93bktleXMxOChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE4KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTgoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE4KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE4KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxOChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE4KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE4KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE4KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZ2V0QWN0aXZlQ2FydGVzaWFuQ29vcmRpbmF0ZSA9IChsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIHBvaW50ZXIpID0+IHsKICB2YXIgZW50cnkgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gdGljayAmJiB0aWNrLmluZGV4ID09PSBhY3RpdmVJbmRleCk7CiAgaWYgKGVudHJ5KSB7CiAgICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBlbnRyeS5jb29yZGluYXRlLAogICAgICAgIHk6IHBvaW50ZXIuY2hhcnRZCiAgICAgIH07CiAgICB9CiAgICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogcG9pbnRlci5jaGFydFgsCiAgICAgICAgeTogZW50cnkuY29vcmRpbmF0ZQogICAgICB9OwogICAgfQogIH0KICByZXR1cm4gewogICAgeDogMCwKICAgIHk6IDAKICB9Owp9Owp2YXIgZ2V0QWN0aXZlUG9sYXJDb29yZGluYXRlID0gKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgcmFuZ2VPYmopID0+IHsKICB2YXIgZW50cnkgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gdGljayAmJiB0aWNrLmluZGV4ID09PSBhY3RpdmVJbmRleCk7CiAgaWYgKGVudHJ5KSB7CiAgICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgICAgdmFyIF9hbmdsZSA9IGVudHJ5LmNvb3JkaW5hdGU7CiAgICAgIHZhciB7CiAgICAgICAgcmFkaXVzOiBfcmFkaXVzCiAgICAgIH0gPSByYW5nZU9iajsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxOChfb2JqZWN0U3ByZWFkMTgoX29iamVjdFNwcmVhZDE4KHt9LCByYW5nZU9iaiksIHBvbGFyVG9DYXJ0ZXNpYW4ocmFuZ2VPYmouY3gsIHJhbmdlT2JqLmN5LCBfcmFkaXVzLCBfYW5nbGUpKSwge30sIHsKICAgICAgICBhbmdsZTogX2FuZ2xlLAogICAgICAgIHJhZGl1czogX3JhZGl1cwogICAgICB9KTsKICAgIH0KICAgIHZhciByYWRpdXMgPSBlbnRyeS5jb29yZGluYXRlOwogICAgdmFyIHsKICAgICAgYW5nbGUKICAgIH0gPSByYW5nZU9iajsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTgoX29iamVjdFNwcmVhZDE4KF9vYmplY3RTcHJlYWQxOCh7fSwgcmFuZ2VPYmopLCBwb2xhclRvQ2FydGVzaWFuKHJhbmdlT2JqLmN4LCByYW5nZU9iai5jeSwgcmFkaXVzLCBhbmdsZSkpLCB7fSwgewogICAgICBhbmdsZSwKICAgICAgcmFkaXVzCiAgICB9KTsKICB9CiAgcmV0dXJuIHsKICAgIGFuZ2xlOiAwLAogICAgY2xvY2tXaXNlOiBmYWxzZSwKICAgIGN4OiAwLAogICAgY3k6IDAsCiAgICBlbmRBbmdsZTogMCwKICAgIGlubmVyUmFkaXVzOiAwLAogICAgb3V0ZXJSYWRpdXM6IDAsCiAgICByYWRpdXM6IDAsCiAgICBzdGFydEFuZ2xlOiAwLAogICAgeDogMCwKICAgIHk6IDAKICB9Owp9OwpmdW5jdGlvbiBpc0luQ2FydGVzaWFuUmFuZ2UocG9pbnRlciwgb2Zmc2V0KSB7CiAgdmFyIHsKICAgIGNoYXJ0WDogeDIsCiAgICBjaGFydFk6IHkyCiAgfSA9IHBvaW50ZXI7CiAgcmV0dXJuIHgyID49IG9mZnNldC5sZWZ0ICYmIHgyIDw9IG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoICYmIHkyID49IG9mZnNldC50b3AgJiYgeTIgPD0gb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQ7Cn0KdmFyIGNhbGN1bGF0ZUFjdGl2ZVRpY2tJbmRleCA9IChjb29yZGluYXRlLCB0aWNrczIsIHVuc29ydGVkVGlja3MsIGF4aXNUeXBlLCByYW5nZTQpID0+IHsKICB2YXIgX3RpY2tzJGxlbmd0aDsKICB2YXIgaW5kZXggPSAtMTsKICB2YXIgbGVuID0gKF90aWNrcyRsZW5ndGggPSB0aWNrczIgPT09IG51bGwgfHwgdGlja3MyID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0aWNrczIubGVuZ3RoKSAhPT0gbnVsbCAmJiBfdGlja3MkbGVuZ3RoICE9PSB2b2lkIDAgPyBfdGlja3MkbGVuZ3RoIDogMDsKICBpZiAobGVuIDw9IDEgfHwgY29vcmRpbmF0ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgIT0gbnVsbCAmJiBNYXRoLmFicyhNYXRoLmFicyhyYW5nZTRbMV0gLSByYW5nZTRbMF0pIC0gMzYwKSA8PSAxZS02KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBiZWZvcmUgPSBpID4gMCA/IHVuc29ydGVkVGlja3NbaSAtIDFdLmNvb3JkaW5hdGUgOiB1bnNvcnRlZFRpY2tzW2xlbiAtIDFdLmNvb3JkaW5hdGU7CiAgICAgIHZhciBjdXIgPSB1bnNvcnRlZFRpY2tzW2ldLmNvb3JkaW5hdGU7CiAgICAgIHZhciBhZnRlciA9IGkgPj0gbGVuIC0gMSA/IHVuc29ydGVkVGlja3NbMF0uY29vcmRpbmF0ZSA6IHVuc29ydGVkVGlja3NbaSArIDFdLmNvb3JkaW5hdGU7CiAgICAgIHZhciBzYW1lRGlyZWN0aW9uQ29vcmQgPSB2b2lkIDA7CiAgICAgIGlmIChtYXRoU2lnbihjdXIgLSBiZWZvcmUpICE9PSBtYXRoU2lnbihhZnRlciAtIGN1cikpIHsKICAgICAgICB2YXIgZGlmZkludGVydmFsID0gW107CiAgICAgICAgaWYgKG1hdGhTaWduKGFmdGVyIC0gY3VyKSA9PT0gbWF0aFNpZ24ocmFuZ2U0WzFdIC0gcmFuZ2U0WzBdKSkgewogICAgICAgICAgc2FtZURpcmVjdGlvbkNvb3JkID0gYWZ0ZXI7CiAgICAgICAgICB2YXIgY3VySW5SYW5nZSA9IGN1ciArIHJhbmdlNFsxXSAtIHJhbmdlNFswXTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFswXSA9IE1hdGgubWluKGN1ckluUmFuZ2UsIChjdXJJblJhbmdlICsgYmVmb3JlKSAvIDIpOwogICAgICAgICAgZGlmZkludGVydmFsWzFdID0gTWF0aC5tYXgoY3VySW5SYW5nZSwgKGN1ckluUmFuZ2UgKyBiZWZvcmUpIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNhbWVEaXJlY3Rpb25Db29yZCA9IGJlZm9yZTsKICAgICAgICAgIHZhciBhZnRlckluUmFuZ2UgPSBhZnRlciArIHJhbmdlNFsxXSAtIHJhbmdlNFswXTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFswXSA9IE1hdGgubWluKGN1ciwgKGFmdGVySW5SYW5nZSArIGN1cikgLyAyKTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFsxXSA9IE1hdGgubWF4KGN1ciwgKGFmdGVySW5SYW5nZSArIGN1cikgLyAyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNhbWVJbnRlcnZhbCA9IFtNYXRoLm1pbihjdXIsIChzYW1lRGlyZWN0aW9uQ29vcmQgKyBjdXIpIC8gMiksIE1hdGgubWF4KGN1ciwgKHNhbWVEaXJlY3Rpb25Db29yZCArIGN1cikgLyAyKV07CiAgICAgICAgaWYgKGNvb3JkaW5hdGUgPiBzYW1lSW50ZXJ2YWxbMF0gJiYgY29vcmRpbmF0ZSA8PSBzYW1lSW50ZXJ2YWxbMV0gfHwgY29vcmRpbmF0ZSA+PSBkaWZmSW50ZXJ2YWxbMF0gJiYgY29vcmRpbmF0ZSA8PSBkaWZmSW50ZXJ2YWxbMV0pIHsKICAgICAgICAgICh7CiAgICAgICAgICAgIGluZGV4CiAgICAgICAgICB9ID0gdW5zb3J0ZWRUaWNrc1tpXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG1pblZhbHVlID0gTWF0aC5taW4oYmVmb3JlLCBhZnRlcik7CiAgICAgICAgdmFyIG1heFZhbHVlID0gTWF0aC5tYXgoYmVmb3JlLCBhZnRlcik7CiAgICAgICAgaWYgKGNvb3JkaW5hdGUgPiAobWluVmFsdWUgKyBjdXIpIC8gMiAmJiBjb29yZGluYXRlIDw9IChtYXhWYWx1ZSArIGN1cikgLyAyKSB7CiAgICAgICAgICAoewogICAgICAgICAgICBpbmRleAogICAgICAgICAgfSA9IHVuc29ydGVkVGlja3NbaV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmICh0aWNrczIpIHsKICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBsZW47IF9pKyspIHsKICAgICAgaWYgKF9pID09PSAwICYmIGNvb3JkaW5hdGUgPD0gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSArIDFdLmNvb3JkaW5hdGUpIC8gMiB8fCBfaSA+IDAgJiYgX2kgPCBsZW4gLSAxICYmIGNvb3JkaW5hdGUgPiAodGlja3MyW19pXS5jb29yZGluYXRlICsgdGlja3MyW19pIC0gMV0uY29vcmRpbmF0ZSkgLyAyICYmIGNvb3JkaW5hdGUgPD0gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSArIDFdLmNvb3JkaW5hdGUpIC8gMiB8fCBfaSA9PT0gbGVuIC0gMSAmJiBjb29yZGluYXRlID4gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSAtIDFdLmNvb3JkaW5hdGUpIC8gMikgewogICAgICAgICh7CiAgICAgICAgICBpbmRleAogICAgICAgIH0gPSB0aWNrczJbX2ldKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gaW5kZXg7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RvcnMuanMKdmFyIHVzZUNoYXJ0TmFtZSA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnROYW1lKTsKfTsKdmFyIHBpY2tUb29sdGlwRXZlbnRUeXBlID0gKF9zdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSkgPT4gdG9vbHRpcEV2ZW50VHlwZTsKdmFyIHBpY2tUcmlnZ2VyID0gKF9zdGF0ZSwgX3Rvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpID0+IHRyaWdnZXI7CnZhciBwaWNrRGVmYXVsdEluZGV4ID0gKF9zdGF0ZSwgX3Rvb2x0aXBFdmVudFR5cGUsIF90cmlnZ2VyLCBkZWZhdWx0SW5kZXgpID0+IGRlZmF1bHRJbmRleDsKdmFyIHNlbGVjdE9yZGVyZWRUb29sdGlwVGlja3MgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCAodGlja3MyKSA9PiAoMCwgaW1wb3J0X3NvcnRCeTQuZGVmYXVsdCkodGlja3MyLCAobykgPT4gby5jb29yZGluYXRlKSk7CnZhciBzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZTIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBwaWNrVG9vbHRpcEV2ZW50VHlwZSwgcGlja1RyaWdnZXIsIHBpY2tEZWZhdWx0SW5kZXhdLCBjb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUpOwp2YXIgc2VsZWN0QWN0aXZlSW5kZXggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyLCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5LCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbl0sIGNvbWJpbmVBY3RpdmVUb29sdGlwSW5kZXgpOwp2YXIgc2VsZWN0VG9vbHRpcERhdGFLZXkgPSAoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpID0+IHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgdG9vbHRpcFN0YXRlID0gc2VsZWN0VG9vbHRpcFN0YXRlKHN0YXRlKTsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICBpZiAodHJpZ2dlciA9PT0gImhvdmVyIikgewogICAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5OwogICAgfQogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleTsKICB9CiAgaWYgKHRyaWdnZXIgPT09ICJob3ZlciIpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXk7CiAgfQogIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXk7Cn07CnZhciBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHBpY2tUb29sdGlwRXZlbnRUeXBlLCBwaWNrVHJpZ2dlciwgcGlja0RlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zKTsKdmFyIHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHQsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBwaWNrRGVmYXVsdEluZGV4LCBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zMiwgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlcl0sIGNvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KTsKdmFyIHNlbGVjdEFjdGl2ZUNvb3JkaW5hdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyLCBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4XSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBkZWZhdWx0SW5kZXhDb29yZGluYXRlKSA9PiB7CiAgdmFyIF90b29sdGlwSW50ZXJhY3Rpb25TdDsKICByZXR1cm4gKF90b29sdGlwSW50ZXJhY3Rpb25TdCA9IHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmNvb3JkaW5hdGUpICE9PSBudWxsICYmIF90b29sdGlwSW50ZXJhY3Rpb25TdCAhPT0gdm9pZCAwID8gX3Rvb2x0aXBJbnRlcmFjdGlvblN0IDogZGVmYXVsdEluZGV4Q29vcmRpbmF0ZTsKfSk7CnZhciBzZWxlY3RBY3RpdmVMYWJlbDIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0QWN0aXZlSW5kZXhdLCBjb21iaW5lQWN0aXZlTGFiZWwpOwp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uczIsIHNlbGVjdEFjdGl2ZUluZGV4LCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcywgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5LCBzZWxlY3RBY3RpdmVMYWJlbDIsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHBpY2tUb29sdGlwRXZlbnRUeXBlXSwgY29tYmluZVRvb2x0aXBQYXlsb2FkKTsKdmFyIHNlbGVjdElzVG9vbHRpcEFjdGl2ZTIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyLCBzZWxlY3RBY3RpdmVJbmRleF0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgYWN0aXZlSW5kZXgpID0+IHsKICByZXR1cm4gewogICAgaXNBY3RpdmU6IHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmFjdGl2ZSAmJiBhY3RpdmVJbmRleCAhPSBudWxsLAogICAgYWN0aXZlSW5kZXgKICB9Owp9KTsKdmFyIGNvbWJpbmVBY3RpdmVDYXJ0ZXNpYW5Qcm9wcyA9IChjaGFydEV2ZW50LCBsYXlvdXQsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCBvZmZzZXQpID0+IHsKICBpZiAoIWNoYXJ0RXZlbnQgfHwgIXRvb2x0aXBBeGlzVHlwZSB8fCAhdG9vbHRpcEF4aXNSYW5nZSB8fCAhdG9vbHRpcFRpY2tzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoIWlzSW5DYXJ0ZXNpYW5SYW5nZShjaGFydEV2ZW50LCBvZmZzZXQpKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgcG9zID0gY2FsY3VsYXRlQ2FydGVzaWFuVG9vbHRpcFBvcyhjaGFydEV2ZW50LCBsYXlvdXQpOwogIHZhciBhY3RpdmVJbmRleCA9IGNhbGN1bGF0ZUFjdGl2ZVRpY2tJbmRleChwb3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIHRvb2x0aXBUaWNrcywgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlKTsKICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IGdldEFjdGl2ZUNhcnRlc2lhbkNvb3JkaW5hdGUobGF5b3V0LCB0b29sdGlwVGlja3MsIGFjdGl2ZUluZGV4LCBjaGFydEV2ZW50KTsKICByZXR1cm4gewogICAgYWN0aXZlSW5kZXg6IFN0cmluZyhhY3RpdmVJbmRleCksCiAgICBhY3RpdmVDb29yZGluYXRlCiAgfTsKfTsKdmFyIGNvbWJpbmVBY3RpdmVQb2xhclByb3BzID0gKGNoYXJ0RXZlbnQsIGxheW91dCwgcG9sYXJWaWV3Qm94LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcykgPT4gewogIGlmICghY2hhcnRFdmVudCB8fCAhdG9vbHRpcEF4aXNUeXBlIHx8ICF0b29sdGlwQXhpc1JhbmdlIHx8ICF0b29sdGlwVGlja3MgfHwgIXBvbGFyVmlld0JveCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHJhbmdlT2JqID0gaW5SYW5nZU9mU2VjdG9yKGNoYXJ0RXZlbnQsIHBvbGFyVmlld0JveCk7CiAgaWYgKCFyYW5nZU9iaikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHBvcyA9IGNhbGN1bGF0ZVBvbGFyVG9vbHRpcFBvcyhyYW5nZU9iaiwgbGF5b3V0KTsKICB2YXIgYWN0aXZlSW5kZXggPSBjYWxjdWxhdGVBY3RpdmVUaWNrSW5kZXgocG9zLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCB0b29sdGlwVGlja3MsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSk7CiAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSBnZXRBY3RpdmVQb2xhckNvb3JkaW5hdGUobGF5b3V0LCB0b29sdGlwVGlja3MsIGFjdGl2ZUluZGV4LCByYW5nZU9iaik7CiAgcmV0dXJuIHsKICAgIGFjdGl2ZUluZGV4OiBTdHJpbmcoYWN0aXZlSW5kZXgpLAogICAgYWN0aXZlQ29vcmRpbmF0ZQogIH07Cn07CnZhciBjb21iaW5lQWN0aXZlUHJvcHMgPSAoY2hhcnRFdmVudCwgbGF5b3V0LCBwb2xhclZpZXdCb3gsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCBvZmZzZXQpID0+IHsKICBpZiAoIWNoYXJ0RXZlbnQgfHwgIWxheW91dCB8fCAhdG9vbHRpcEF4aXNUeXBlIHx8ICF0b29sdGlwQXhpc1JhbmdlIHx8ICF0b29sdGlwVGlja3MpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIiB8fCBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBjb21iaW5lQWN0aXZlQ2FydGVzaWFuUHJvcHMoY2hhcnRFdmVudCwgbGF5b3V0LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgb2Zmc2V0KTsKICB9CiAgcmV0dXJuIGNvbWJpbmVBY3RpdmVQb2xhclByb3BzKGNoYXJ0RXZlbnQsIGxheW91dCwgcG9sYXJWaWV3Qm94LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcyk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhMYXllci5qcwp2YXIgaW1wb3J0X3JlYWN0MjAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3RfZG9tID0gX190b0VTTShyZXF1aXJlX3JlYWN0X2RvbSgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L3pJbmRleFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0WkluZGV4UG9ydGFsSWQgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnpJbmRleC56SW5kZXhNYXAsIChfLCB6SW5kZXgpID0+IHpJbmRleCwgKF8sIF96SW5kZXgsIGlzUGFub3JhbWEpID0+IGlzUGFub3JhbWEsICh6SW5kZXhNYXAsIHpJbmRleCwgaXNQYW5vcmFtYSkgPT4gewogIGlmICh6SW5kZXggPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGVudHJ5ID0gekluZGV4TWFwW3pJbmRleF07CiAgaWYgKGVudHJ5ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gZW50cnkucGFub3JhbWFFbGVtZW50SWQ7CiAgfQogIHJldHVybiBlbnRyeS5lbGVtZW50SWQ7Cn0pOwp2YXIgc2VsZWN0QWxsUmVnaXN0ZXJlZFpJbmRleGVzID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS56SW5kZXguekluZGV4TWFwLCAoekluZGV4TWFwKSA9PiB7CiAgdmFyIGFsbE51bWJlcnMgPSBPYmplY3Qua2V5cyh6SW5kZXhNYXApLm1hcCgoekluZGV4U3RyKSA9PiBwYXJzZUludCh6SW5kZXhTdHIsIDEwKSkuY29uY2F0KE9iamVjdC52YWx1ZXMoRGVmYXVsdFpJbmRleGVzKSk7CiAgdmFyIHVuaXF1ZU51bWJlcnMgPSBBcnJheS5mcm9tKG5ldyBTZXQoYWxsTnVtYmVycykpOwogIHJldHVybiB1bmlxdWVOdW1iZXJzLnNvcnQoKGEyLCBiKSA9PiBhMiAtIGIpOwp9LCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGFycmF5Q29udGVudHNBcmVFcXVhbENoZWNrCiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvekluZGV4U2xpY2UuanMKZnVuY3Rpb24gb3duS2V5czE5KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTkoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxOShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTkoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTkodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBzZWVkID0ge307CnZhciBpbml0aWFsU3RhdGU0ID0gewogIHpJbmRleE1hcDogT2JqZWN0LnZhbHVlcyhEZWZhdWx0WkluZGV4ZXMpLnJlZHVjZSgoYWNjLCBjdXJyZW50MykgPT4gX29iamVjdFNwcmVhZDE5KF9vYmplY3RTcHJlYWQxOSh7fSwgYWNjKSwge30sIHsKICAgIFtjdXJyZW50M106IHsKICAgICAgZWxlbWVudElkOiB2b2lkIDAsCiAgICAgIHBhbm9yYW1hRWxlbWVudElkOiB2b2lkIDAsCiAgICAgIGNvbnN1bWVyczogMAogICAgfQogIH0pLCBzZWVkKQp9Owp2YXIgZGVmYXVsdFpJbmRleFNldCA9IG5ldyBTZXQoT2JqZWN0LnZhbHVlcyhEZWZhdWx0WkluZGV4ZXMpKTsKZnVuY3Rpb24gaXNEZWZhdWx0WkluZGV4KHpJbmRleCkgewogIHJldHVybiBkZWZhdWx0WkluZGV4U2V0Lmhhcyh6SW5kZXgpOwp9CnZhciB6SW5kZXhTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiekluZGV4IiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTQsCiAgcmVkdWNlcnM6IHsKICAgIHJlZ2lzdGVyWkluZGV4UG9ydGFsOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyArPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XSA9IHsKICAgICAgICAgICAgY29uc3VtZXJzOiAxLAogICAgICAgICAgICBlbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgICAgICAgcGFub3JhbWFFbGVtZW50SWQ6IHZvaWQgMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgdW5yZWdpc3RlclpJbmRleFBvcnRhbDogewogICAgICByZWR1Y2VyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB6SW5kZXgKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdKSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5jb25zdW1lcnMgLT0gMTsKICAgICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5jb25zdW1lcnMgPD0gMCAmJiAhaXNEZWZhdWx0WkluZGV4KHpJbmRleCkpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZWdpc3RlclpJbmRleFBvcnRhbElkOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleCwKICAgICAgICAgIGVsZW1lbnRJZCwKICAgICAgICAgIGlzUGFub3JhbWEKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdKSB7CiAgICAgICAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5wYW5vcmFtYUVsZW1lbnRJZCA9IGVsZW1lbnRJZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmVsZW1lbnRJZCA9IGVsZW1lbnRJZDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0gPSB7CiAgICAgICAgICAgIGNvbnN1bWVyczogMCwKICAgICAgICAgICAgZWxlbWVudElkOiBpc1Bhbm9yYW1hID8gdm9pZCAwIDogZWxlbWVudElkLAogICAgICAgICAgICBwYW5vcmFtYUVsZW1lbnRJZDogaXNQYW5vcmFtYSA/IGVsZW1lbnRJZCA6IHZvaWQgMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgdW5yZWdpc3RlclpJbmRleFBvcnRhbElkOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIGlmIChhY3Rpb24ucGF5bG9hZC5pc1Bhbm9yYW1hKSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLnBhbm9yYW1hRWxlbWVudElkID0gdm9pZCAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uZWxlbWVudElkID0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0KICB9Cn0pOwp2YXIgewogIHJlZ2lzdGVyWkluZGV4UG9ydGFsLAogIHVucmVnaXN0ZXJaSW5kZXhQb3J0YWwsCiAgcmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCwKICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsSWQKfSA9IHpJbmRleFNsaWNlLmFjdGlvbnM7CnZhciB6SW5kZXhSZWR1Y2VyID0gekluZGV4U2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L1pJbmRleExheWVyLmpzCmZ1bmN0aW9uIFpJbmRleExheWVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIHpJbmRleCwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBpc0luQ2hhcnRDb250ZXh0ID0gdXNlSXNJbkNoYXJ0Q29udGV4dCgpOwogIHZhciBzaG91bGRSZW5kZXJJblBvcnRhbCA9IGlzSW5DaGFydENvbnRleHQgJiYgekluZGV4ICE9PSB2b2lkIDAgJiYgekluZGV4ICE9PSAwOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFzaG91bGRSZW5kZXJJblBvcnRhbCkgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIGRpc3BhdGNoKHJlZ2lzdGVyWkluZGV4UG9ydGFsKHsKICAgICAgekluZGV4CiAgICB9KSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaCh1bnJlZ2lzdGVyWkluZGV4UG9ydGFsKHsKICAgICAgICB6SW5kZXgKICAgICAgfSkpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIHpJbmRleCwgc2hvdWxkUmVuZGVySW5Qb3J0YWxdKTsKICB2YXIgcG9ydGFsSWQgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFpJbmRleFBvcnRhbElkKHN0YXRlLCB6SW5kZXgsIGlzUGFub3JhbWEpKTsKICBpZiAoIXNob3VsZFJlbmRlckluUG9ydGFsKSB7CiAgICByZXR1cm4gY2hpbGRyZW47CiAgfQogIGlmICghcG9ydGFsSWQpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgekluZGV4UG9ydGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocG9ydGFsSWQpOwogIGlmICh6SW5kZXhQb3J0YWwpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdF9kb20uY3JlYXRlUG9ydGFsKShjaGlsZHJlbiwgekluZGV4UG9ydGFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0N1cnNvci5qcwpmdW5jdGlvbiBfZXh0ZW5kczEwKCkgewogIHJldHVybiBfZXh0ZW5kczEwID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXMyMChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjAoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTIwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIwKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBSZW5kZXJDdXJzb3IoX3JlZjIpIHsKICB2YXIgewogICAgY3Vyc29yLAogICAgY3Vyc29yQ29tcCwKICAgIGN1cnNvclByb3BzCiAgfSA9IF9yZWYyOwogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIxLmlzVmFsaWRFbGVtZW50KShjdXJzb3IpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMS5jbG9uZUVsZW1lbnQpKGN1cnNvciwgY3Vyc29yUHJvcHMpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMS5jcmVhdGVFbGVtZW50KShjdXJzb3JDb21wLCBjdXJzb3JQcm9wcyk7Cn0KZnVuY3Rpb24gQ3Vyc29ySW50ZXJuYWwocHJvcHMpIHsKICB2YXIgX3Byb3BzJHpJbmRleDsKICB2YXIgewogICAgY29vcmRpbmF0ZSwKICAgIHBheWxvYWQsCiAgICBpbmRleCwKICAgIG9mZnNldCwKICAgIHRvb2x0aXBBeGlzQmFuZFNpemUsCiAgICBsYXlvdXQsCiAgICBjdXJzb3IsCiAgICB0b29sdGlwRXZlbnRUeXBlLAogICAgY2hhcnROYW1lCiAgfSA9IHByb3BzOwogIHZhciBhY3RpdmVDb29yZGluYXRlID0gY29vcmRpbmF0ZTsKICB2YXIgYWN0aXZlUGF5bG9hZCA9IHBheWxvYWQ7CiAgdmFyIGFjdGl2ZVRvb2x0aXBJbmRleCA9IGluZGV4OwogIGlmICghY3Vyc29yIHx8ICFhY3RpdmVDb29yZGluYXRlIHx8IGNoYXJ0TmFtZSAhPT0gIlNjYXR0ZXJDaGFydCIgJiYgdG9vbHRpcEV2ZW50VHlwZSAhPT0gImF4aXMiKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJlc3RQcm9wcywgY3Vyc29yQ29tcCwgcHJlZmVycmVkWkluZGV4OwogIGlmIChjaGFydE5hbWUgPT09ICJTY2F0dGVyQ2hhcnQiKSB7CiAgICByZXN0UHJvcHMgPSBhY3RpdmVDb29yZGluYXRlOwogICAgY3Vyc29yQ29tcCA9IENyb3NzOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvckxpbmU7CiAgfSBlbHNlIGlmIChjaGFydE5hbWUgPT09ICJCYXJDaGFydCIpIHsKICAgIHJlc3RQcm9wcyA9IGdldEN1cnNvclJlY3RhbmdsZShsYXlvdXQsIGFjdGl2ZUNvb3JkaW5hdGUsIG9mZnNldCwgdG9vbHRpcEF4aXNCYW5kU2l6ZSk7CiAgICBjdXJzb3JDb21wID0gUmVjdGFuZ2xlOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvclJlY3RhbmdsZTsKICB9IGVsc2UgaWYgKGxheW91dCA9PT0gInJhZGlhbCIgJiYgaXNQb2xhckNvb3JkaW5hdGUoYWN0aXZlQ29vcmRpbmF0ZSkpIHsKICAgIHZhciB7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcmFkaXVzLAogICAgICBzdGFydEFuZ2xlLAogICAgICBlbmRBbmdsZQogICAgfSA9IGdldFJhZGlhbEN1cnNvclBvaW50cyhhY3RpdmVDb29yZGluYXRlKTsKICAgIHJlc3RQcm9wcyA9IHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBzdGFydEFuZ2xlLAogICAgICBlbmRBbmdsZSwKICAgICAgaW5uZXJSYWRpdXM6IHJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXM6IHJhZGl1cwogICAgfTsKICAgIGN1cnNvckNvbXAgPSBTZWN0b3I7CiAgICBwcmVmZXJyZWRaSW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuY3Vyc29yTGluZTsKICB9IGVsc2UgewogICAgcmVzdFByb3BzID0gewogICAgICBwb2ludHM6IGdldEN1cnNvclBvaW50cyhsYXlvdXQsIGFjdGl2ZUNvb3JkaW5hdGUsIG9mZnNldCkKICAgIH07CiAgICBjdXJzb3JDb21wID0gQ3VydmU7CiAgICBwcmVmZXJyZWRaSW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuY3Vyc29yTGluZTsKICB9CiAgdmFyIGV4dHJhQ2xhc3NOYW1lID0gdHlwZW9mIGN1cnNvciA9PT0gIm9iamVjdCIgJiYgImNsYXNzTmFtZSIgaW4gY3Vyc29yID8gY3Vyc29yLmNsYXNzTmFtZSA6IHZvaWQgMDsKICB2YXIgY3Vyc29yUHJvcHMgPSBfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKF9vYmplY3RTcHJlYWQyMChfb2JqZWN0U3ByZWFkMjAoewogICAgc3Ryb2tlOiAiI2NjYyIsCiAgICBwb2ludGVyRXZlbnRzOiAibm9uZSIKICB9LCBvZmZzZXQpLCByZXN0UHJvcHMpLCBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihjdXJzb3IpKSwge30sIHsKICAgIHBheWxvYWQ6IGFjdGl2ZVBheWxvYWQsCiAgICBwYXlsb2FkSW5kZXg6IGFjdGl2ZVRvb2x0aXBJbmRleCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtdG9vbHRpcC1jdXJzb3IiLCBleHRyYUNsYXNzTmFtZSkKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiAoX3Byb3BzJHpJbmRleCA9IHByb3BzLnpJbmRleCkgIT09IG51bGwgJiYgX3Byb3BzJHpJbmRleCAhPT0gdm9pZCAwID8gX3Byb3BzJHpJbmRleCA6IHByZWZlcnJlZFpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoUmVuZGVyQ3Vyc29yLCB7CiAgICBjdXJzb3IsCiAgICBjdXJzb3JDb21wLAogICAgY3Vyc29yUHJvcHMKICB9KSk7Cn0KZnVuY3Rpb24gQ3Vyc29yKHByb3BzKSB7CiAgdmFyIHRvb2x0aXBBeGlzQmFuZFNpemUgPSB1c2VUb29sdGlwQXhpc0JhbmRTaXplKCk7CiAgdmFyIG9mZnNldCA9IHVzZU9mZnNldEludGVybmFsKCk7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgdmFyIGNoYXJ0TmFtZSA9IHVzZUNoYXJ0TmFtZSgpOwogIGlmICh0b29sdGlwQXhpc0JhbmRTaXplID09IG51bGwgfHwgb2Zmc2V0ID09IG51bGwgfHwgbGF5b3V0ID09IG51bGwgfHwgY2hhcnROYW1lID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChDdXJzb3JJbnRlcm5hbCwgX2V4dGVuZHMxMCh7fSwgcHJvcHMsIHsKICAgIG9mZnNldCwKICAgIGxheW91dCwKICAgIHRvb2x0aXBBeGlzQmFuZFNpemUsCiAgICBjaGFydE5hbWUKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC90b29sdGlwUG9ydGFsQ29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0MjIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBUb29sdGlwUG9ydGFsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjIuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciB1c2VUb29sdGlwUG9ydGFsID0gKCkgPT4gKDAsIGltcG9ydF9yZWFjdDIyLnVzZUNvbnRleHQpKFRvb2x0aXBQb3J0YWxDb250ZXh0KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3luY2hyb25pc2F0aW9uL3VzZUNoYXJ0U3luY2hyb25pc2F0aW9uLmpzCnZhciBpbXBvcnRfcmVhY3QyMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9ldmVudGVtaXR0ZXIzL2luZGV4Lm1qcwp2YXIgaW1wb3J0X2luZGV4ID0gX190b0VTTShyZXF1aXJlX2V2ZW50ZW1pdHRlcjMoKSwgMSk7CnZhciBldmVudGVtaXR0ZXIzX2RlZmF1bHQgPSBpbXBvcnRfaW5kZXguZGVmYXVsdDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9FdmVudHMuanMKdmFyIGV2ZW50Q2VudGVyID0gbmV3IGV2ZW50ZW1pdHRlcjNfZGVmYXVsdCgpOwp2YXIgVE9PTFRJUF9TWU5DX0VWRU5UID0gInJlY2hhcnRzLnN5bmNFdmVudC50b29sdGlwIjsKdmFyIEJSVVNIX1NZTkNfRVZFTlQgPSAicmVjaGFydHMuc3luY0V2ZW50LmJydXNoIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvb3B0aW9uc1NsaWNlLmpzCmZ1bmN0aW9uIGFycmF5VG9vbHRpcFNlYXJjaGVyKGRhdGEsIHN0ckluZGV4KSB7CiAgaWYgKCFzdHJJbmRleCkgcmV0dXJuIHZvaWQgMDsKICB2YXIgbnVtSW5kZXggPSBOdW1iZXIucGFyc2VJbnQoc3RySW5kZXgsIDEwKTsKICBpZiAoaXNOYW4obnVtSW5kZXgpKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhW251bUluZGV4XTsKfQp2YXIgaW5pdGlhbFN0YXRlNSA9IHsKICBjaGFydE5hbWU6ICIiLAogIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXI6IHZvaWQgMCwKICBldmVudEVtaXR0ZXI6IHZvaWQgMCwKICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTogImF4aXMiCn07CnZhciBvcHRpb25zU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogIm9wdGlvbnMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNSwKICByZWR1Y2VyczogewogICAgY3JlYXRlRXZlbnRFbWl0dGVyOiAoc3RhdGUpID0+IHsKICAgICAgaWYgKHN0YXRlLmV2ZW50RW1pdHRlciA9PSBudWxsKSB7CiAgICAgICAgc3RhdGUuZXZlbnRFbWl0dGVyID0gU3ltYm9sKCJyZWNoYXJ0c0V2ZW50RW1pdHRlciIpOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIG9wdGlvbnNSZWR1Y2VyID0gb3B0aW9uc1NsaWNlLnJlZHVjZXI7CnZhciB7CiAgY3JlYXRlRXZlbnRFbWl0dGVyCn0gPSBvcHRpb25zU2xpY2UuYWN0aW9uczsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3luY2hyb25pc2F0aW9uL3N5bmNTZWxlY3RvcnMuanMKZnVuY3Rpb24gc2VsZWN0U3luY2hyb25pc2VkVG9vbHRpcFN0YXRlKHN0YXRlKSB7CiAgcmV0dXJuIHN0YXRlLnRvb2x0aXAuc3luY0ludGVyYWN0aW9uOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2NoYXJ0RGF0YVNsaWNlLmpzCnZhciBpbml0aWFsQ2hhcnREYXRhU3RhdGUgPSB7CiAgY2hhcnREYXRhOiB2b2lkIDAsCiAgY29tcHV0ZWREYXRhOiB2b2lkIDAsCiAgZGF0YVN0YXJ0SW5kZXg6IDAsCiAgZGF0YUVuZEluZGV4OiAwCn07CnZhciBjaGFydERhdGFTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiY2hhcnREYXRhIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxDaGFydERhdGFTdGF0ZSwKICByZWR1Y2VyczogewogICAgc2V0Q2hhcnREYXRhKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuY2hhcnREYXRhID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZCA9PSBudWxsKSB7CiAgICAgICAgc3RhdGUuZGF0YVN0YXJ0SW5kZXggPSAwOwogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IDA7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZC5sZW5ndGggPiAwICYmIHN0YXRlLmRhdGFFbmRJbmRleCAhPT0gYWN0aW9uLnBheWxvYWQubGVuZ3RoIC0gMSkgewogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IGFjdGlvbi5wYXlsb2FkLmxlbmd0aCAtIDE7CiAgICAgIH0KICAgIH0sCiAgICBzZXRDb21wdXRlZERhdGEoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5jb21wdXRlZERhdGEgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXREYXRhU3RhcnRFbmRJbmRleGVzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIHsKICAgICAgICBzdGFydEluZGV4LAogICAgICAgIGVuZEluZGV4CiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKHN0YXJ0SW5kZXggIT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFTdGFydEluZGV4ID0gc3RhcnRJbmRleDsKICAgICAgfQogICAgICBpZiAoZW5kSW5kZXggIT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IGVuZEluZGV4OwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRDaGFydERhdGEsCiAgc2V0RGF0YVN0YXJ0RW5kSW5kZXhlcywKICBzZXRDb21wdXRlZERhdGEKfSA9IGNoYXJ0RGF0YVNsaWNlLmFjdGlvbnM7CnZhciBjaGFydERhdGFSZWR1Y2VyID0gY2hhcnREYXRhU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3luY2hyb25pc2F0aW9uL3VzZUNoYXJ0U3luY2hyb25pc2F0aW9uLmpzCnZhciBfZXhjbHVkZWQ2ID0gWyJ4IiwgInkiXTsKZnVuY3Rpb24gb3duS2V5czIxKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjEoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIxKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczYoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTYoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTYocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIHVzZVRvb2x0aXBTeW5jRXZlbnRzTGlzdGVuZXIoKSB7CiAgdmFyIG15U3luY0lkID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY0lkKTsKICB2YXIgbXlFdmVudEVtaXR0ZXIgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RFdmVudEVtaXR0ZXIpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIHN5bmNNZXRob2QgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jTWV0aG9kKTsKICB2YXIgdG9vbHRpcFRpY2tzID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyk7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgdmFyIHZpZXdCb3ggPSB1c2VWaWV3Qm94KCk7CiAgdmFyIGNsYXNzTmFtZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLmNsYXNzTmFtZSk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKG15U3luY0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgbGlzdGVuZXIyID0gKGluY29taW5nU3luY0lkLCBhY3Rpb24sIGVtaXR0ZXIpID0+IHsKICAgICAgaWYgKG15RXZlbnRFbWl0dGVyID09PSBlbWl0dGVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChteVN5bmNJZCAhPT0gaW5jb21pbmdTeW5jSWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHN5bmNNZXRob2QgPT09ICJpbmRleCIpIHsKICAgICAgICB2YXIgX2FjdGlvbiRwYXlsb2FkOwogICAgICAgIGlmICh2aWV3Qm94ICYmIGFjdGlvbiAhPT0gbnVsbCAmJiBhY3Rpb24gIT09IHZvaWQgMCAmJiAoX2FjdGlvbiRwYXlsb2FkID0gYWN0aW9uLnBheWxvYWQpICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCAhPT0gdm9pZCAwICYmIF9hY3Rpb24kcGF5bG9hZC5jb29yZGluYXRlICYmIGFjdGlvbi5wYXlsb2FkLnNvdXJjZVZpZXdCb3gpIHsKICAgICAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkY29vcmQgPSBhY3Rpb24ucGF5bG9hZC5jb29yZGluYXRlLCB7CiAgICAgICAgICAgIHg6IF94LAogICAgICAgICAgICB5OiBfeQogICAgICAgICAgfSA9IF9hY3Rpb24kcGF5bG9hZCRjb29yZCwgb3RoZXJDb29yZGluYXRlUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM2KF9hY3Rpb24kcGF5bG9hZCRjb29yZCwgX2V4Y2x1ZGVkNik7CiAgICAgICAgICB2YXIgewogICAgICAgICAgICB4OiBzb3VyY2VYLAogICAgICAgICAgICB5OiBzb3VyY2VZLAogICAgICAgICAgICB3aWR0aDogc291cmNlV2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogc291cmNlSGVpZ2h0CiAgICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQuc291cmNlVmlld0JveDsKICAgICAgICAgIHZhciBzY2FsZWRDb29yZGluYXRlID0gX29iamVjdFNwcmVhZDIxKF9vYmplY3RTcHJlYWQyMSh7fSwgb3RoZXJDb29yZGluYXRlUHJvcHMpLCB7fSwgewogICAgICAgICAgICB4OiB2aWV3Qm94LnggKyAoc291cmNlV2lkdGggPyAoX3ggLSBzb3VyY2VYKSAvIHNvdXJjZVdpZHRoIDogMCkgKiB2aWV3Qm94LndpZHRoLAogICAgICAgICAgICB5OiB2aWV3Qm94LnkgKyAoc291cmNlSGVpZ2h0ID8gKF95IC0gc291cmNlWSkgLyBzb3VyY2VIZWlnaHQgOiAwKSAqIHZpZXdCb3guaGVpZ2h0CiAgICAgICAgICB9KTsKICAgICAgICAgIGRpc3BhdGNoKF9vYmplY3RTcHJlYWQyMShfb2JqZWN0U3ByZWFkMjEoe30sIGFjdGlvbiksIHt9LCB7CiAgICAgICAgICAgIHBheWxvYWQ6IF9vYmplY3RTcHJlYWQyMShfb2JqZWN0U3ByZWFkMjEoe30sIGFjdGlvbi5wYXlsb2FkKSwge30sIHsKICAgICAgICAgICAgICBjb29yZGluYXRlOiBzY2FsZWRDb29yZGluYXRlCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9KSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRpc3BhdGNoKGFjdGlvbik7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodG9vbHRpcFRpY2tzID09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGFjdGl2ZVRpY2s7CiAgICAgIGlmICh0eXBlb2Ygc3luY01ldGhvZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHZhciBzeW5jTWV0aG9kUGFyYW0gPSB7CiAgICAgICAgICBhY3RpdmVUb29sdGlwSW5kZXg6IGFjdGlvbi5wYXlsb2FkLmluZGV4ID09IG51bGwgPyB2b2lkIDAgOiBOdW1iZXIoYWN0aW9uLnBheWxvYWQuaW5kZXgpLAogICAgICAgICAgaXNUb29sdGlwQWN0aXZlOiBhY3Rpb24ucGF5bG9hZC5hY3RpdmUsCiAgICAgICAgICBhY3RpdmVJbmRleDogYWN0aW9uLnBheWxvYWQuaW5kZXggPT0gbnVsbCA/IHZvaWQgMCA6IE51bWJlcihhY3Rpb24ucGF5bG9hZC5pbmRleCksCiAgICAgICAgICBhY3RpdmVMYWJlbDogYWN0aW9uLnBheWxvYWQubGFiZWwsCiAgICAgICAgICBhY3RpdmVEYXRhS2V5OiBhY3Rpb24ucGF5bG9hZC5kYXRhS2V5LAogICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aW9uLnBheWxvYWQuY29vcmRpbmF0ZQogICAgICAgIH07CiAgICAgICAgdmFyIGFjdGl2ZVRvb2x0aXBJbmRleCA9IHN5bmNNZXRob2QodG9vbHRpcFRpY2tzLCBzeW5jTWV0aG9kUGFyYW0pOwogICAgICAgIGFjdGl2ZVRpY2sgPSB0b29sdGlwVGlja3NbYWN0aXZlVG9vbHRpcEluZGV4XTsKICAgICAgfSBlbHNlIGlmIChzeW5jTWV0aG9kID09PSAidmFsdWUiKSB7CiAgICAgICAgYWN0aXZlVGljayA9IHRvb2x0aXBUaWNrcy5maW5kKCh0aWNrKSA9PiBTdHJpbmcodGljay52YWx1ZSkgPT09IGFjdGlvbi5wYXlsb2FkLmxhYmVsKTsKICAgICAgfQogICAgICB2YXIgewogICAgICAgIGNvb3JkaW5hdGUKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoYWN0aXZlVGljayA9PSBudWxsIHx8IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZSA9PT0gZmFsc2UgfHwgY29vcmRpbmF0ZSA9PSBudWxsIHx8IHZpZXdCb3ggPT0gbnVsbCkgewogICAgICAgIGRpc3BhdGNoKHNldFN5bmNJbnRlcmFjdGlvbih7CiAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgY29vcmRpbmF0ZTogdm9pZCAwLAogICAgICAgICAgZGF0YUtleTogdm9pZCAwLAogICAgICAgICAgaW5kZXg6IG51bGwsCiAgICAgICAgICBsYWJlbDogdm9pZCAwLAogICAgICAgICAgc291cmNlVmlld0JveDogdm9pZCAwLAogICAgICAgICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICAgICAgICB9KSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciB7CiAgICAgICAgeDogeDIsCiAgICAgICAgeTogeTIKICAgICAgfSA9IGNvb3JkaW5hdGU7CiAgICAgIHZhciB2YWxpZGF0ZUNoYXJ0WCA9IE1hdGgubWluKHgyLCB2aWV3Qm94LnggKyB2aWV3Qm94LndpZHRoKTsKICAgICAgdmFyIHZhbGlkYXRlQ2hhcnRZID0gTWF0aC5taW4oeTIsIHZpZXdCb3gueSArIHZpZXdCb3guaGVpZ2h0KTsKICAgICAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSB7CiAgICAgICAgeDogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyBhY3RpdmVUaWNrLmNvb3JkaW5hdGUgOiB2YWxpZGF0ZUNoYXJ0WCwKICAgICAgICB5OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHZhbGlkYXRlQ2hhcnRZIDogYWN0aXZlVGljay5jb29yZGluYXRlCiAgICAgIH07CiAgICAgIHZhciBzeW5jQWN0aW9uID0gc2V0U3luY0ludGVyYWN0aW9uKHsKICAgICAgICBhY3RpdmU6IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZSwKICAgICAgICBjb29yZGluYXRlOiBhY3RpdmVDb29yZGluYXRlLAogICAgICAgIGRhdGFLZXk6IGFjdGlvbi5wYXlsb2FkLmRhdGFLZXksCiAgICAgICAgaW5kZXg6IFN0cmluZyhhY3RpdmVUaWNrLmluZGV4KSwKICAgICAgICBsYWJlbDogYWN0aW9uLnBheWxvYWQubGFiZWwsCiAgICAgICAgc291cmNlVmlld0JveDogYWN0aW9uLnBheWxvYWQuc291cmNlVmlld0JveCwKICAgICAgICBncmFwaGljYWxJdGVtSWQ6IGFjdGlvbi5wYXlsb2FkLmdyYXBoaWNhbEl0ZW1JZAogICAgICB9KTsKICAgICAgZGlzcGF0Y2goc3luY0FjdGlvbik7CiAgICB9OwogICAgZXZlbnRDZW50ZXIub24oVE9PTFRJUF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZXZlbnRDZW50ZXIub2ZmKFRPT0xUSVBfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIH07CiAgfSwgW2NsYXNzTmFtZSwgZGlzcGF0Y2gsIG15RXZlbnRFbWl0dGVyLCBteVN5bmNJZCwgc3luY01ldGhvZCwgdG9vbHRpcFRpY2tzLCBsYXlvdXQsIHZpZXdCb3hdKTsKfQpmdW5jdGlvbiB1c2VCcnVzaFN5bmNFdmVudHNMaXN0ZW5lcigpIHsKICB2YXIgbXlTeW5jSWQgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jSWQpOwogIHZhciBteUV2ZW50RW1pdHRlciA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEV2ZW50RW1pdHRlcik7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0MjMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAobXlTeW5jSWQgPT0gbnVsbCkgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBsaXN0ZW5lcjIgPSAoaW5jb21pbmdTeW5jSWQsIGFjdGlvbiwgZW1pdHRlcikgPT4gewogICAgICBpZiAobXlFdmVudEVtaXR0ZXIgPT09IGVtaXR0ZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKG15U3luY0lkID09PSBpbmNvbWluZ1N5bmNJZCkgewogICAgICAgIGRpc3BhdGNoKHNldERhdGFTdGFydEVuZEluZGV4ZXMoYWN0aW9uKSk7CiAgICAgIH0KICAgIH07CiAgICBldmVudENlbnRlci5vbihCUlVTSF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZXZlbnRDZW50ZXIub2ZmKEJSVVNIX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICB9OwogIH0sIFtkaXNwYXRjaCwgbXlFdmVudEVtaXR0ZXIsIG15U3luY0lkXSk7Cn0KZnVuY3Rpb24gdXNlU3luY2hyb25pc2VkRXZlbnRzRnJvbU90aGVyQ2hhcnRzKCkgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2goY3JlYXRlRXZlbnRFbWl0dGVyKCkpOwogIH0sIFtkaXNwYXRjaF0pOwogIHVzZVRvb2x0aXBTeW5jRXZlbnRzTGlzdGVuZXIoKTsKICB1c2VCcnVzaFN5bmNFdmVudHNMaXN0ZW5lcigpOwp9CmZ1bmN0aW9uIHVzZVRvb2x0aXBDaGFydFN5bmNocm9uaXNhdGlvbih0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBhY3RpdmVDb29yZGluYXRlLCBhY3RpdmVMYWJlbCwgYWN0aXZlSW5kZXgsIGlzVG9vbHRpcEFjdGl2ZSkgewogIHZhciBhY3RpdmVEYXRhS2V5ID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUb29sdGlwRGF0YUtleShzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcikpOwogIHZhciBldmVudEVtaXR0ZXJTeW1ib2wgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RFdmVudEVtaXR0ZXIpOwogIHZhciBzeW5jSWQgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jSWQpOwogIHZhciBzeW5jTWV0aG9kID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY01ldGhvZCk7CiAgdmFyIHRvb2x0aXBTdGF0ZSA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNocm9uaXNlZFRvb2x0aXBTdGF0ZSk7CiAgdmFyIGlzUmVjZWl2aW5nU3luY2hyb25pc2F0aW9uID0gdG9vbHRpcFN0YXRlID09PSBudWxsIHx8IHRvb2x0aXBTdGF0ZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdG9vbHRpcFN0YXRlLmFjdGl2ZTsKICB2YXIgdmlld0JveCA9IHVzZVZpZXdCb3goKTsKICAoMCwgaW1wb3J0X3JlYWN0MjMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNSZWNlaXZpbmdTeW5jaHJvbmlzYXRpb24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHN5bmNJZCA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChldmVudEVtaXR0ZXJTeW1ib2wgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc3luY0FjdGlvbiA9IHNldFN5bmNJbnRlcmFjdGlvbih7CiAgICAgIGFjdGl2ZTogaXNUb29sdGlwQWN0aXZlLAogICAgICBjb29yZGluYXRlOiBhY3RpdmVDb29yZGluYXRlLAogICAgICBkYXRhS2V5OiBhY3RpdmVEYXRhS2V5LAogICAgICBpbmRleDogYWN0aXZlSW5kZXgsCiAgICAgIGxhYmVsOiB0eXBlb2YgYWN0aXZlTGFiZWwgPT09ICJudW1iZXIiID8gU3RyaW5nKGFjdGl2ZUxhYmVsKSA6IGFjdGl2ZUxhYmVsLAogICAgICBzb3VyY2VWaWV3Qm94OiB2aWV3Qm94LAogICAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogICAgfSk7CiAgICBldmVudENlbnRlci5lbWl0KFRPT0xUSVBfU1lOQ19FVkVOVCwgc3luY0lkLCBzeW5jQWN0aW9uLCBldmVudEVtaXR0ZXJTeW1ib2wpOwogIH0sIFtpc1JlY2VpdmluZ1N5bmNocm9uaXNhdGlvbiwgYWN0aXZlQ29vcmRpbmF0ZSwgYWN0aXZlRGF0YUtleSwgYWN0aXZlSW5kZXgsIGFjdGl2ZUxhYmVsLCBldmVudEVtaXR0ZXJTeW1ib2wsIHN5bmNJZCwgc3luY01ldGhvZCwgaXNUb29sdGlwQWN0aXZlLCB2aWV3Qm94XSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXAuanMKZnVuY3Rpb24gb3duS2V5czIyKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjIoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIyKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjIocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjIodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjIodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjIodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGRlZmF1bHRVbmlxQnkoZW50cnkpIHsKICByZXR1cm4gZW50cnkuZGF0YUtleTsKfQpmdW5jdGlvbiByZW5kZXJDb250ZW50KGNvbnRlbnQsIHByb3BzKSB7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEzLmlzVmFsaWRFbGVtZW50KGNvbnRlbnQpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTMuY2xvbmVFbGVtZW50KGNvbnRlbnQsIHByb3BzKTsKICB9CiAgaWYgKHR5cGVvZiBjb250ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTMuY3JlYXRlRWxlbWVudChjb250ZW50LCBwcm9wcyk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMy5jcmVhdGVFbGVtZW50KERlZmF1bHRUb29sdGlwQ29udGVudCwgcHJvcHMpOwp9CnZhciBlbXB0eVBheWxvYWQgPSBbXTsKdmFyIGRlZmF1bHRUb29sdGlwUHJvcHMgPSB7CiAgYWxsb3dFc2NhcGVWaWV3Qm94OiB7CiAgICB4OiBmYWxzZSwKICAgIHk6IGZhbHNlCiAgfSwKICBhbmltYXRpb25EdXJhdGlvbjogNDAwLAogIGFuaW1hdGlvbkVhc2luZzogImVhc2UiLAogIGF4aXNJZDogMCwKICBjb250ZW50U3R5bGU6IHt9LAogIGN1cnNvcjogdHJ1ZSwKICBmaWx0ZXJOdWxsOiB0cnVlLAogIGlzQW5pbWF0aW9uQWN0aXZlOiAiYXV0byIsCiAgaXRlbVNvcnRlcjogIm5hbWUiLAogIGl0ZW1TdHlsZToge30sCiAgbGFiZWxTdHlsZToge30sCiAgb2Zmc2V0OiAxMCwKICByZXZlcnNlRGlyZWN0aW9uOiB7CiAgICB4OiBmYWxzZSwKICAgIHk6IGZhbHNlCiAgfSwKICBzZXBhcmF0b3I6ICIgOiAiLAogIHRyaWdnZXI6ICJob3ZlciIsCiAgdXNlVHJhbnNsYXRlM2Q6IGZhbHNlLAogIHdyYXBwZXJTdHlsZToge30KfTsKZnVuY3Rpb24gVG9vbHRpcChvdXRzaWRlUHJvcHMpIHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yLCBfcmVmMjsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgZGVmYXVsdFRvb2x0aXBQcm9wcyk7CiAgdmFyIHsKICAgIGFjdGl2ZTogYWN0aXZlRnJvbVByb3BzLAogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBjb250ZW50LAogICAgZmlsdGVyTnVsbCwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgb2Zmc2V0LAogICAgcGF5bG9hZFVuaXFCeSwKICAgIHBvc2l0aW9uLAogICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgd3JhcHBlclN0eWxlLAogICAgY3Vyc29yLAogICAgc2hhcmVkLAogICAgdHJpZ2dlciwKICAgIGRlZmF1bHRJbmRleCwKICAgIHBvcnRhbDogcG9ydGFsRnJvbVByb3BzLAogICAgYXhpc0lkCiAgfSA9IHByb3BzOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGRlZmF1bHRJbmRleEFzU3RyaW5nID0gdHlwZW9mIGRlZmF1bHRJbmRleCA9PT0gIm51bWJlciIgPyBTdHJpbmcoZGVmYXVsdEluZGV4KSA6IGRlZmF1bHRJbmRleDsKICAoMCwgaW1wb3J0X3JlYWN0MjQudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaChzZXRUb29sdGlwU2V0dGluZ3NTdGF0ZSh7CiAgICAgIHNoYXJlZCwKICAgICAgdHJpZ2dlciwKICAgICAgYXhpc0lkLAogICAgICBhY3RpdmU6IGFjdGl2ZUZyb21Qcm9wcywKICAgICAgZGVmYXVsdEluZGV4OiBkZWZhdWx0SW5kZXhBc1N0cmluZwogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgc2hhcmVkLCB0cmlnZ2VyLCBheGlzSWQsIGFjdGl2ZUZyb21Qcm9wcywgZGVmYXVsdEluZGV4QXNTdHJpbmddKTsKICB2YXIgdmlld0JveCA9IHVzZVZpZXdCb3goKTsKICB2YXIgYWNjZXNzaWJpbGl0eUxheWVyID0gdXNlQWNjZXNzaWJpbGl0eUxheWVyKCk7CiAgdmFyIHRvb2x0aXBFdmVudFR5cGUgPSB1c2VUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCk7CiAgdmFyIHsKICAgIGFjdGl2ZUluZGV4LAogICAgaXNBY3RpdmUKICB9ID0gKF91c2VBcHBTZWxlY3RvciA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0SXNUb29sdGlwQWN0aXZlMihzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IgOiB7fTsKICB2YXIgcGF5bG9hZEZyb21SZWR1eCA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcFBheWxvYWQoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIGxhYmVsRnJvbVJlZHV4ID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBY3RpdmVMYWJlbDIoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIGNvb3JkaW5hdGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFjdGl2ZUNvb3JkaW5hdGUoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIHBheWxvYWQgPSBwYXlsb2FkRnJvbVJlZHV4OwogIHZhciB0b29sdGlwUG9ydGFsRnJvbUNvbnRleHQgPSB1c2VUb29sdGlwUG9ydGFsKCk7CiAgdmFyIGZpbmFsSXNBY3RpdmUgPSAoX3JlZjIgPSBhY3RpdmVGcm9tUHJvcHMgIT09IG51bGwgJiYgYWN0aXZlRnJvbVByb3BzICE9PSB2b2lkIDAgPyBhY3RpdmVGcm9tUHJvcHMgOiBpc0FjdGl2ZSkgIT09IG51bGwgJiYgX3JlZjIgIT09IHZvaWQgMCA/IF9yZWYyIDogZmFsc2U7CiAgdmFyIFtsYXN0Qm91bmRpbmdCb3gsIHVwZGF0ZUJvdW5kaW5nQm94XSA9IHVzZUVsZW1lbnRPZmZzZXQoW3BheWxvYWQsIGZpbmFsSXNBY3RpdmVdKTsKICB2YXIgZmluYWxMYWJlbCA9IHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIiA/IGxhYmVsRnJvbVJlZHV4IDogdm9pZCAwOwogIHVzZVRvb2x0aXBDaGFydFN5bmNocm9uaXNhdGlvbih0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBjb29yZGluYXRlLCBmaW5hbExhYmVsLCBhY3RpdmVJbmRleCwgZmluYWxJc0FjdGl2ZSk7CiAgdmFyIHRvb2x0aXBQb3J0YWwgPSBwb3J0YWxGcm9tUHJvcHMgIT09IG51bGwgJiYgcG9ydGFsRnJvbVByb3BzICE9PSB2b2lkIDAgPyBwb3J0YWxGcm9tUHJvcHMgOiB0b29sdGlwUG9ydGFsRnJvbUNvbnRleHQ7CiAgaWYgKHRvb2x0aXBQb3J0YWwgPT0gbnVsbCB8fCB2aWV3Qm94ID09IG51bGwgfHwgdG9vbHRpcEV2ZW50VHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGZpbmFsUGF5bG9hZCA9IHBheWxvYWQgIT09IG51bGwgJiYgcGF5bG9hZCAhPT0gdm9pZCAwID8gcGF5bG9hZCA6IGVtcHR5UGF5bG9hZDsKICBpZiAoIWZpbmFsSXNBY3RpdmUpIHsKICAgIGZpbmFsUGF5bG9hZCA9IGVtcHR5UGF5bG9hZDsKICB9CiAgaWYgKGZpbHRlck51bGwgJiYgZmluYWxQYXlsb2FkLmxlbmd0aCkgewogICAgZmluYWxQYXlsb2FkID0gZ2V0VW5pcVBheWxvYWQoZmluYWxQYXlsb2FkLmZpbHRlcigoZW50cnkpID0+IGVudHJ5LnZhbHVlICE9IG51bGwgJiYgKGVudHJ5LmhpZGUgIT09IHRydWUgfHwgcHJvcHMuaW5jbHVkZUhpZGRlbikpLCBwYXlsb2FkVW5pcUJ5LCBkZWZhdWx0VW5pcUJ5KTsKICB9CiAgdmFyIGhhc1BheWxvYWQgPSBmaW5hbFBheWxvYWQubGVuZ3RoID4gMDsKICB2YXIgdG9vbHRpcEVsZW1lbnQgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QxMy5jcmVhdGVFbGVtZW50KFRvb2x0aXBCb3VuZGluZ0JveCwgewogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGFjdGl2ZTogZmluYWxJc0FjdGl2ZSwKICAgIGNvb3JkaW5hdGUsCiAgICBoYXNQYXlsb2FkLAogICAgb2Zmc2V0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdXNlVHJhbnNsYXRlM2QsCiAgICB2aWV3Qm94LAogICAgd3JhcHBlclN0eWxlLAogICAgbGFzdEJvdW5kaW5nQm94LAogICAgaW5uZXJSZWY6IHVwZGF0ZUJvdW5kaW5nQm94LAogICAgaGFzUG9ydGFsRnJvbVByb3BzOiBCb29sZWFuKHBvcnRhbEZyb21Qcm9wcykKICB9LCByZW5kZXJDb250ZW50KGNvbnRlbnQsIF9vYmplY3RTcHJlYWQyMihfb2JqZWN0U3ByZWFkMjIoe30sIHByb3BzKSwge30sIHsKICAgIHBheWxvYWQ6IGZpbmFsUGF5bG9hZCwKICAgIGxhYmVsOiBmaW5hbExhYmVsLAogICAgYWN0aXZlOiBmaW5hbElzQWN0aXZlLAogICAgYWN0aXZlSW5kZXgsCiAgICBjb29yZGluYXRlLAogICAgYWNjZXNzaWJpbGl0eUxheWVyCiAgfSkpKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTMuY3JlYXRlRWxlbWVudChSZWFjdDEzLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdF9kb20yLmNyZWF0ZVBvcnRhbCkodG9vbHRpcEVsZW1lbnQsIHRvb2x0aXBQb3J0YWwpLCBmaW5hbElzQWN0aXZlICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEzLmNyZWF0ZUVsZW1lbnQoQ3Vyc29yLCB7CiAgICBjdXJzb3IsCiAgICB0b29sdGlwRXZlbnRUeXBlLAogICAgY29vcmRpbmF0ZSwKICAgIHBheWxvYWQ6IGZpbmFsUGF5bG9hZCwKICAgIGluZGV4OiBhY3RpdmVJbmRleAogIH0pKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQ2VsbC5qcwp2YXIgQ2VsbCA9IChfcHJvcHMpID0+IG51bGw7CkNlbGwuZGlzcGxheU5hbWUgPSAiQ2VsbCI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9UZXh0LmpzCnZhciBSZWFjdDE0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvTFJVQ2FjaGUuanMKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjMoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIExSVUNhY2hlID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKG1heFNpemUpIHsKICAgIF9kZWZpbmVQcm9wZXJ0eTIzKHRoaXMsICJjYWNoZSIsIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogICAgdGhpcy5tYXhTaXplID0gbWF4U2l6ZTsKICB9CiAgZ2V0KGtleSkgewogICAgdmFyIHZhbHVlID0gdGhpcy5jYWNoZS5nZXQoa2V5KTsKICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKSB7CiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7CiAgICAgIHRoaXMuY2FjaGUuc2V0KGtleSwgdmFsdWUpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KICBzZXQoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMuY2FjaGUuaGFzKGtleSkpIHsKICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTsKICAgIH0gZWxzZSBpZiAodGhpcy5jYWNoZS5zaXplID49IHRoaXMubWF4U2l6ZSkgewogICAgICB2YXIgZmlyc3RLZXkgPSB0aGlzLmNhY2hlLmtleXMoKS5uZXh0KCkudmFsdWU7CiAgICAgIGlmIChmaXJzdEtleSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5jYWNoZS5kZWxldGUoZmlyc3RLZXkpOwogICAgICB9CiAgICB9CiAgICB0aGlzLmNhY2hlLnNldChrZXksIHZhbHVlKTsKICB9CiAgY2xlYXIoKSB7CiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7CiAgfQogIHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5jYWNoZS5zaXplOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9ET01VdGlscy5qcwpmdW5jdGlvbiBvd25LZXlzMjMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIzKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyNChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjQoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyNChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyNCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyNCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyNCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGRlZmF1bHRDb25maWcgPSB7CiAgY2FjaGVTaXplOiAyZTMsCiAgZW5hYmxlQ2FjaGU6IHRydWUKfTsKdmFyIGN1cnJlbnRDb25maWcgPSBfb2JqZWN0U3ByZWFkMjMoe30sIGRlZmF1bHRDb25maWcpOwp2YXIgc3RyaW5nQ2FjaGUgPSBuZXcgTFJVQ2FjaGUoY3VycmVudENvbmZpZy5jYWNoZVNpemUpOwp2YXIgU1BBTl9TVFlMRSA9IHsKICBwb3NpdGlvbjogImFic29sdXRlIiwKICB0b3A6ICItMjAwMDBweCIsCiAgbGVmdDogMCwKICBwYWRkaW5nOiAwLAogIG1hcmdpbjogMCwKICBib3JkZXI6ICJub25lIiwKICB3aGl0ZVNwYWNlOiAicHJlIgp9Owp2YXIgTUVBU1VSRU1FTlRfU1BBTl9JRCA9ICJyZWNoYXJ0c19tZWFzdXJlbWVudF9zcGFuIjsKZnVuY3Rpb24gY3JlYXRlQ2FjaGVLZXkodGV4dCwgc3R5bGUpIHsKICB2YXIgZm9udFNpemUgPSBzdHlsZS5mb250U2l6ZSB8fCAiIjsKICB2YXIgZm9udEZhbWlseSA9IHN0eWxlLmZvbnRGYW1pbHkgfHwgIiI7CiAgdmFyIGZvbnRXZWlnaHQgPSBzdHlsZS5mb250V2VpZ2h0IHx8ICIiOwogIHZhciBmb250U3R5bGUgPSBzdHlsZS5mb250U3R5bGUgfHwgIiI7CiAgdmFyIGxldHRlclNwYWNpbmcgPSBzdHlsZS5sZXR0ZXJTcGFjaW5nIHx8ICIiOwogIHZhciB0ZXh0VHJhbnNmb3JtID0gc3R5bGUudGV4dFRyYW5zZm9ybSB8fCAiIjsKICByZXR1cm4gIiIuY29uY2F0KHRleHQsICJ8IikuY29uY2F0KGZvbnRTaXplLCAifCIpLmNvbmNhdChmb250RmFtaWx5LCAifCIpLmNvbmNhdChmb250V2VpZ2h0LCAifCIpLmNvbmNhdChmb250U3R5bGUsICJ8IikuY29uY2F0KGxldHRlclNwYWNpbmcsICJ8IikuY29uY2F0KHRleHRUcmFuc2Zvcm0pOwp9CnZhciBtZWFzdXJlVGV4dFdpdGhET00gPSAodGV4dCwgc3R5bGUpID0+IHsKICB0cnkgewogICAgdmFyIG1lYXN1cmVtZW50U3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKE1FQVNVUkVNRU5UX1NQQU5fSUQpOwogICAgaWYgKCFtZWFzdXJlbWVudFNwYW4pIHsKICAgICAgbWVhc3VyZW1lbnRTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICBtZWFzdXJlbWVudFNwYW4uc2V0QXR0cmlidXRlKCJpZCIsIE1FQVNVUkVNRU5UX1NQQU5fSUQpOwogICAgICBtZWFzdXJlbWVudFNwYW4uc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsICJ0cnVlIik7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobWVhc3VyZW1lbnRTcGFuKTsKICAgIH0KICAgIE9iamVjdC5hc3NpZ24obWVhc3VyZW1lbnRTcGFuLnN0eWxlLCBTUEFOX1NUWUxFLCBzdHlsZSk7CiAgICBtZWFzdXJlbWVudFNwYW4udGV4dENvbnRlbnQgPSAiIi5jb25jYXQodGV4dCk7CiAgICB2YXIgcmVjdCA9IG1lYXN1cmVtZW50U3Bhbi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiByZWN0LndpZHRoLAogICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0CiAgICB9OwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgfQp9Owp2YXIgZ2V0U3RyaW5nU2l6ZSA9IGZ1bmN0aW9uIGdldFN0cmluZ1NpemUyKHRleHQpIHsKICB2YXIgc3R5bGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogIGlmICh0ZXh0ID09PSB2b2lkIDAgfHwgdGV4dCA9PT0gbnVsbCB8fCBHbG9iYWwuaXNTc3IpIHsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgfQogIGlmICghY3VycmVudENvbmZpZy5lbmFibGVDYWNoZSkgewogICAgcmV0dXJuIG1lYXN1cmVUZXh0V2l0aERPTSh0ZXh0LCBzdHlsZSk7CiAgfQogIHZhciBjYWNoZUtleSA9IGNyZWF0ZUNhY2hlS2V5KHRleHQsIHN0eWxlKTsKICB2YXIgY2FjaGVkUmVzdWx0ID0gc3RyaW5nQ2FjaGUuZ2V0KGNhY2hlS2V5KTsKICBpZiAoY2FjaGVkUmVzdWx0KSB7CiAgICByZXR1cm4gY2FjaGVkUmVzdWx0OwogIH0KICB2YXIgcmVzdWx0ID0gbWVhc3VyZVRleHRXaXRoRE9NKHRleHQsIHN0eWxlKTsKICBzdHJpbmdDYWNoZS5zZXQoY2FjaGVLZXksIHJlc3VsdCk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9SZWR1Y2VDU1NDYWxjLmpzCnZhciBNVUxUSVBMWV9PUl9ESVZJREVfUkVHRVggPSAvKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopKFsqL10pKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopLzsKdmFyIEFERF9PUl9TVUJUUkFDVF9SRUdFWCA9IC8oLT9cZCsoPzpcLlxkKyk/W2EtekEtWiVdKikoWystXSkoLT9cZCsoPzpcLlxkKyk/W2EtekEtWiVdKikvOwp2YXIgQ1NTX0xFTkdUSF9VTklUX1JFR0VYID0gL15weHxjbXx2aHx2d3xlbXxyZW18JXxtbXxpbnxwdHxwY3xleHxjaHx2bWlufHZtYXh8USQvOwp2YXIgTlVNX1NQTElUX1JFR0VYID0gLygtP1xkKyg/OlwuXGQrKT8pKFthLXpBLVolXSspPy87CnZhciBDT05WRVJTSU9OX1JBVEVTID0gewogIGNtOiA5NiAvIDIuNTQsCiAgbW06IDk2IC8gMjUuNCwKICBwdDogOTYgLyA3MiwKICBwYzogOTYgLyA2LAogIGluOiA5NiwKICBROiA5NiAvICgyLjU0ICogNDApLAogIHB4OiAxCn07CnZhciBGSVhFRF9DU1NfTEVOR1RIX1VOSVRTID0gT2JqZWN0LmtleXMoQ09OVkVSU0lPTl9SQVRFUyk7CnZhciBTVFJfTkFOID0gIk5hTiI7CmZ1bmN0aW9uIGNvbnZlcnRUb1B4KHZhbHVlLCB1bml0MikgewogIHJldHVybiB2YWx1ZSAqIENPTlZFUlNJT05fUkFURVNbdW5pdDJdOwp9CnZhciBEZWNpbWFsQ1NTID0gY2xhc3MgX0RlY2ltYWxDU1MgewogIHN0YXRpYyBwYXJzZShzdHIpIHsKICAgIHZhciBfTlVNX1NQTElUX1JFR0VYJGV4ZWM7CiAgICB2YXIgWywgbnVtU3RyLCB1bml0Ml0gPSAoX05VTV9TUExJVF9SRUdFWCRleGVjID0gTlVNX1NQTElUX1JFR0VYLmV4ZWMoc3RyKSkgIT09IG51bGwgJiYgX05VTV9TUExJVF9SRUdFWCRleGVjICE9PSB2b2lkIDAgPyBfTlVNX1NQTElUX1JFR0VYJGV4ZWMgOiBbXTsKICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MocGFyc2VGbG9hdChudW1TdHIpLCB1bml0MiAhPT0gbnVsbCAmJiB1bml0MiAhPT0gdm9pZCAwID8gdW5pdDIgOiAiIik7CiAgfQogIGNvbnN0cnVjdG9yKG51bSwgdW5pdDIpIHsKICAgIHRoaXMubnVtID0gbnVtOwogICAgdGhpcy51bml0ID0gdW5pdDI7CiAgICB0aGlzLm51bSA9IG51bTsKICAgIHRoaXMudW5pdCA9IHVuaXQyOwogICAgaWYgKGlzTmFuKG51bSkpIHsKICAgICAgdGhpcy51bml0ID0gIiI7CiAgICB9CiAgICBpZiAodW5pdDIgIT09ICIiICYmICFDU1NfTEVOR1RIX1VOSVRfUkVHRVgudGVzdCh1bml0MikpIHsKICAgICAgdGhpcy5udW0gPSBOYU47CiAgICAgIHRoaXMudW5pdCA9ICIiOwogICAgfQogICAgaWYgKEZJWEVEX0NTU19MRU5HVEhfVU5JVFMuaW5jbHVkZXModW5pdDIpKSB7CiAgICAgIHRoaXMubnVtID0gY29udmVydFRvUHgobnVtLCB1bml0Mik7CiAgICAgIHRoaXMudW5pdCA9ICJweCI7CiAgICB9CiAgfQogIGFkZChvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gb3RoZXIudW5pdCkgewogICAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKE5hTiwgIiIpOwogICAgfQogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyh0aGlzLm51bSArIG90aGVyLm51bSwgdGhpcy51bml0KTsKICB9CiAgc3VidHJhY3Qob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gLSBvdGhlci5udW0sIHRoaXMudW5pdCk7CiAgfQogIG11bHRpcGx5KG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSAiIiAmJiBvdGhlci51bml0ICE9PSAiIiAmJiB0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gKiBvdGhlci5udW0sIHRoaXMudW5pdCB8fCBvdGhlci51bml0KTsKICB9CiAgZGl2aWRlKG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSAiIiAmJiBvdGhlci51bml0ICE9PSAiIiAmJiB0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gLyBvdGhlci5udW0sIHRoaXMudW5pdCB8fCBvdGhlci51bml0KTsKICB9CiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gIiIuY29uY2F0KHRoaXMubnVtKS5jb25jYXQodGhpcy51bml0KTsKICB9CiAgaXNOYU4oKSB7CiAgICByZXR1cm4gaXNOYW4odGhpcy5udW0pOwogIH0KfTsKZnVuY3Rpb24gY2FsY3VsYXRlQXJpdGhtZXRpYyhleHByKSB7CiAgaWYgKGV4cHIuaW5jbHVkZXMoU1RSX05BTikpIHsKICAgIHJldHVybiBTVFJfTkFOOwogIH0KICB2YXIgbmV3RXhwciA9IGV4cHI7CiAgd2hpbGUgKG5ld0V4cHIuaW5jbHVkZXMoIioiKSB8fCBuZXdFeHByLmluY2x1ZGVzKCIvIikpIHsKICAgIHZhciBfTVVMVElQTFlfT1JfRElWSURFX1I7CiAgICB2YXIgWywgbGVmdE9wZXJhbmQsIG9wZXJhdG9yLCByaWdodE9wZXJhbmRdID0gKF9NVUxUSVBMWV9PUl9ESVZJREVfUiA9IE1VTFRJUExZX09SX0RJVklERV9SRUdFWC5leGVjKG5ld0V4cHIpKSAhPT0gbnVsbCAmJiBfTVVMVElQTFlfT1JfRElWSURFX1IgIT09IHZvaWQgMCA/IF9NVUxUSVBMWV9PUl9ESVZJREVfUiA6IFtdOwogICAgdmFyIGxUcyA9IERlY2ltYWxDU1MucGFyc2UobGVmdE9wZXJhbmQgIT09IG51bGwgJiYgbGVmdE9wZXJhbmQgIT09IHZvaWQgMCA/IGxlZnRPcGVyYW5kIDogIiIpOwogICAgdmFyIHJUcyA9IERlY2ltYWxDU1MucGFyc2UocmlnaHRPcGVyYW5kICE9PSBudWxsICYmIHJpZ2h0T3BlcmFuZCAhPT0gdm9pZCAwID8gcmlnaHRPcGVyYW5kIDogIiIpOwogICAgdmFyIHJlc3VsdCA9IG9wZXJhdG9yID09PSAiKiIgPyBsVHMubXVsdGlwbHkoclRzKSA6IGxUcy5kaXZpZGUoclRzKTsKICAgIGlmIChyZXN1bHQuaXNOYU4oKSkgewogICAgICByZXR1cm4gU1RSX05BTjsKICAgIH0KICAgIG5ld0V4cHIgPSBuZXdFeHByLnJlcGxhY2UoTVVMVElQTFlfT1JfRElWSURFX1JFR0VYLCByZXN1bHQudG9TdHJpbmcoKSk7CiAgfQogIHdoaWxlIChuZXdFeHByLmluY2x1ZGVzKCIrIikgfHwgLy4tXGQrKD86XC5cZCspPy8udGVzdChuZXdFeHByKSkgewogICAgdmFyIF9BRERfT1JfU1VCVFJBQ1RfUkVHRTsKICAgIHZhciBbLCBfbGVmdE9wZXJhbmQsIF9vcGVyYXRvciwgX3JpZ2h0T3BlcmFuZF0gPSAoX0FERF9PUl9TVUJUUkFDVF9SRUdFID0gQUREX09SX1NVQlRSQUNUX1JFR0VYLmV4ZWMobmV3RXhwcikpICE9PSBudWxsICYmIF9BRERfT1JfU1VCVFJBQ1RfUkVHRSAhPT0gdm9pZCAwID8gX0FERF9PUl9TVUJUUkFDVF9SRUdFIDogW107CiAgICB2YXIgX2xUcyA9IERlY2ltYWxDU1MucGFyc2UoX2xlZnRPcGVyYW5kICE9PSBudWxsICYmIF9sZWZ0T3BlcmFuZCAhPT0gdm9pZCAwID8gX2xlZnRPcGVyYW5kIDogIiIpOwogICAgdmFyIF9yVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKF9yaWdodE9wZXJhbmQgIT09IG51bGwgJiYgX3JpZ2h0T3BlcmFuZCAhPT0gdm9pZCAwID8gX3JpZ2h0T3BlcmFuZCA6ICIiKTsKICAgIHZhciBfcmVzdWx0ID0gX29wZXJhdG9yID09PSAiKyIgPyBfbFRzLmFkZChfclRzKSA6IF9sVHMuc3VidHJhY3QoX3JUcyk7CiAgICBpZiAoX3Jlc3VsdC5pc05hTigpKSB7CiAgICAgIHJldHVybiBTVFJfTkFOOwogICAgfQogICAgbmV3RXhwciA9IG5ld0V4cHIucmVwbGFjZShBRERfT1JfU1VCVFJBQ1RfUkVHRVgsIF9yZXN1bHQudG9TdHJpbmcoKSk7CiAgfQogIHJldHVybiBuZXdFeHByOwp9CnZhciBQQVJFTlRIRVNFU19SRUdFWCA9IC9cKChbXigpXSopXCkvOwpmdW5jdGlvbiBjYWxjdWxhdGVQYXJlbnRoZXNlcyhleHByKSB7CiAgdmFyIG5ld0V4cHIgPSBleHByOwogIHZhciBtYXRjaDsKICB3aGlsZSAoKG1hdGNoID0gUEFSRU5USEVTRVNfUkVHRVguZXhlYyhuZXdFeHByKSkgIT0gbnVsbCkgewogICAgdmFyIFssIHBhcmVudGhldGljYWxFeHByZXNzaW9uXSA9IG1hdGNoOwogICAgbmV3RXhwciA9IG5ld0V4cHIucmVwbGFjZShQQVJFTlRIRVNFU19SRUdFWCwgY2FsY3VsYXRlQXJpdGhtZXRpYyhwYXJlbnRoZXRpY2FsRXhwcmVzc2lvbikpOwogIH0KICByZXR1cm4gbmV3RXhwcjsKfQpmdW5jdGlvbiBldmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbikgewogIHZhciBuZXdFeHByID0gZXhwcmVzc2lvbi5yZXBsYWNlKC9ccysvZywgIiIpOwogIG5ld0V4cHIgPSBjYWxjdWxhdGVQYXJlbnRoZXNlcyhuZXdFeHByKTsKICBuZXdFeHByID0gY2FsY3VsYXRlQXJpdGhtZXRpYyhuZXdFeHByKTsKICByZXR1cm4gbmV3RXhwcjsKfQpmdW5jdGlvbiBzYWZlRXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24pIHsKICB0cnkgewogICAgcmV0dXJuIGV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uKTsKICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICByZXR1cm4gU1RSX05BTjsKICB9Cn0KZnVuY3Rpb24gcmVkdWNlQ1NTQ2FsYyhleHByZXNzaW9uKSB7CiAgdmFyIHJlc3VsdCA9IHNhZmVFdmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbi5zbGljZSg1LCAtMSkpOwogIGlmIChyZXN1bHQgPT09IFNUUl9OQU4pIHsKICAgIHJldHVybiAiIjsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVGV4dC5qcwp2YXIgX2V4Y2x1ZGVkNyA9IFsieCIsICJ5IiwgImxpbmVIZWlnaHQiLCAiY2FwSGVpZ2h0IiwgImZpbGwiLCAic2NhbGVUb0ZpdCIsICJ0ZXh0QW5jaG9yIiwgInZlcnRpY2FsQW5jaG9yIl07CnZhciBfZXhjbHVkZWQyMyA9IFsiZHgiLCAiZHkiLCAiYW5nbGUiLCAiY2xhc3NOYW1lIiwgImJyZWFrQWxsIl07CmZ1bmN0aW9uIF9leHRlbmRzMTEoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTEgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczExLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNyhlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIEJSRUFLSU5HX1NQQUNFUyA9IC9bIFxmXG5cclx0XHZcdTIwMjhcdTIwMjldKy87CnZhciBjYWxjdWxhdGVXb3JkV2lkdGhzID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgYnJlYWtBbGwsCiAgICBzdHlsZQogIH0gPSBfcmVmMjsKICB0cnkgewogICAgdmFyIHdvcmRzID0gW107CiAgICBpZiAoIWlzTnVsbGlzaChjaGlsZHJlbikpIHsKICAgICAgaWYgKGJyZWFrQWxsKSB7CiAgICAgICAgd29yZHMgPSBjaGlsZHJlbi50b1N0cmluZygpLnNwbGl0KCIiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3b3JkcyA9IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoQlJFQUtJTkdfU1BBQ0VTKTsKICAgICAgfQogICAgfQogICAgdmFyIHdvcmRzV2l0aENvbXB1dGVkV2lkdGggPSB3b3Jkcy5tYXAoKHdvcmQpID0+ICh7CiAgICAgIHdvcmQsCiAgICAgIHdpZHRoOiBnZXRTdHJpbmdTaXplKHdvcmQsIHN0eWxlKS53aWR0aAogICAgfSkpOwogICAgdmFyIHNwYWNlV2lkdGggPSBicmVha0FsbCA/IDAgOiBnZXRTdHJpbmdTaXplKCJceEEwIiwgc3R5bGUpLndpZHRoOwogICAgcmV0dXJuIHsKICAgICAgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwKICAgICAgc3BhY2VXaWR0aAogICAgfTsKICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn07CmZ1bmN0aW9uIGlzVmFsaWRUZXh0QW5jaG9yKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlID09PSAic3RhcnQiIHx8IHZhbHVlID09PSAibWlkZGxlIiB8fCB2YWx1ZSA9PT0gImVuZCIgfHwgdmFsdWUgPT09ICJpbmhlcml0IjsKfQp2YXIgY2FsY3VsYXRlID0gKHdvcmRzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpID0+IHdvcmRzLnJlZHVjZSgocmVzdWx0LCBfcmVmMikgPT4gewogIHZhciB7CiAgICB3b3JkLAogICAgd2lkdGgKICB9ID0gX3JlZjI7CiAgdmFyIGN1cnJlbnRMaW5lID0gcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXTsKICBpZiAoY3VycmVudExpbmUgJiYgd2lkdGggIT0gbnVsbCAmJiAobGluZVdpZHRoID09IG51bGwgfHwgc2NhbGVUb0ZpdCB8fCBjdXJyZW50TGluZS53aWR0aCArIHdpZHRoICsgc3BhY2VXaWR0aCA8IE51bWJlcihsaW5lV2lkdGgpKSkgewogICAgY3VycmVudExpbmUud29yZHMucHVzaCh3b3JkKTsKICAgIGN1cnJlbnRMaW5lLndpZHRoICs9IHdpZHRoICsgc3BhY2VXaWR0aDsKICB9IGVsc2UgewogICAgdmFyIG5ld0xpbmUgPSB7CiAgICAgIHdvcmRzOiBbd29yZF0sCiAgICAgIHdpZHRoCiAgICB9OwogICAgcmVzdWx0LnB1c2gobmV3TGluZSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0sIFtdKTsKdmFyIGZpbmRMb25nZXN0TGluZSA9ICh3b3JkcykgPT4gd29yZHMucmVkdWNlKChhMiwgYikgPT4gYTIud2lkdGggPiBiLndpZHRoID8gYTIgOiBiKTsKdmFyIHN1ZmZpeCA9ICJcdTIwMjYiOwp2YXIgY2hlY2tPdmVyZmxvdyA9ICh0ZXh0LCBpbmRleCwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KSA9PiB7CiAgdmFyIHRlbXBUZXh0ID0gdGV4dC5zbGljZSgwLCBpbmRleCk7CiAgdmFyIHdvcmRzID0gY2FsY3VsYXRlV29yZFdpZHRocyh7CiAgICBicmVha0FsbCwKICAgIHN0eWxlLAogICAgY2hpbGRyZW46IHRlbXBUZXh0ICsgc3VmZml4CiAgfSk7CiAgaWYgKCF3b3JkcykgewogICAgcmV0dXJuIFtmYWxzZSwgW11dOwogIH0KICB2YXIgcmVzdWx0ID0gY2FsY3VsYXRlKHdvcmRzLndvcmRzV2l0aENvbXB1dGVkV2lkdGgsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgdmFyIGRvZXNPdmVyZmxvdyA9IHJlc3VsdC5sZW5ndGggPiBtYXhMaW5lcyB8fCBmaW5kTG9uZ2VzdExpbmUocmVzdWx0KS53aWR0aCA+IE51bWJlcihsaW5lV2lkdGgpOwogIHJldHVybiBbZG9lc092ZXJmbG93LCByZXN1bHRdOwp9Owp2YXIgY2FsY3VsYXRlV29yZHNCeUxpbmVzID0gKF9yZWYzLCBpbml0aWFsV29yZHNXaXRoQ29tcHV0ZWRXaXRoLCBzcGFjZVdpZHRoLCBsaW5lV2lkdGgsIHNjYWxlVG9GaXQpID0+IHsKICB2YXIgewogICAgbWF4TGluZXMsCiAgICBjaGlsZHJlbiwKICAgIHN0eWxlLAogICAgYnJlYWtBbGwKICB9ID0gX3JlZjM7CiAgdmFyIHNob3VsZExpbWl0TGluZXMgPSBpc051bWJlcihtYXhMaW5lcyk7CiAgdmFyIHRleHQgPSBTdHJpbmcoY2hpbGRyZW4pOwogIHZhciBvcmlnaW5hbFJlc3VsdCA9IGNhbGN1bGF0ZShpbml0aWFsV29yZHNXaXRoQ29tcHV0ZWRXaXRoLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpOwogIGlmICghc2hvdWxkTGltaXRMaW5lcyB8fCBzY2FsZVRvRml0KSB7CiAgICByZXR1cm4gb3JpZ2luYWxSZXN1bHQ7CiAgfQogIHZhciBvdmVyZmxvd3MgPSBvcmlnaW5hbFJlc3VsdC5sZW5ndGggPiBtYXhMaW5lcyB8fCBmaW5kTG9uZ2VzdExpbmUob3JpZ2luYWxSZXN1bHQpLndpZHRoID4gTnVtYmVyKGxpbmVXaWR0aCk7CiAgaWYgKCFvdmVyZmxvd3MpIHsKICAgIHJldHVybiBvcmlnaW5hbFJlc3VsdDsKICB9CiAgdmFyIHN0YXJ0ID0gMDsKICB2YXIgZW5kID0gdGV4dC5sZW5ndGggLSAxOwogIHZhciBpdGVyYXRpb25zID0gMDsKICB2YXIgdHJpbW1lZFJlc3VsdDsKICB3aGlsZSAoc3RhcnQgPD0gZW5kICYmIGl0ZXJhdGlvbnMgPD0gdGV4dC5sZW5ndGggLSAxKSB7CiAgICB2YXIgbWlkZGxlID0gTWF0aC5mbG9vcigoc3RhcnQgKyBlbmQpIC8gMik7CiAgICB2YXIgcHJldiA9IG1pZGRsZSAtIDE7CiAgICB2YXIgW2RvZXNQcmV2T3ZlcmZsb3csIHJlc3VsdF0gPSBjaGVja092ZXJmbG93KHRleHQsIHByZXYsIGJyZWFrQWxsLCBzdHlsZSwgbWF4TGluZXMsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgICB2YXIgW2RvZXNNaWRkbGVPdmVyZmxvd10gPSBjaGVja092ZXJmbG93KHRleHQsIG1pZGRsZSwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICAgIGlmICghZG9lc1ByZXZPdmVyZmxvdyAmJiAhZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIHN0YXJ0ID0gbWlkZGxlICsgMTsKICAgIH0KICAgIGlmIChkb2VzUHJldk92ZXJmbG93ICYmIGRvZXNNaWRkbGVPdmVyZmxvdykgewogICAgICBlbmQgPSBtaWRkbGUgLSAxOwogICAgfQogICAgaWYgKCFkb2VzUHJldk92ZXJmbG93ICYmIGRvZXNNaWRkbGVPdmVyZmxvdykgewogICAgICB0cmltbWVkUmVzdWx0ID0gcmVzdWx0OwogICAgICBicmVhazsKICAgIH0KICAgIGl0ZXJhdGlvbnMrKzsKICB9CiAgcmV0dXJuIHRyaW1tZWRSZXN1bHQgfHwgb3JpZ2luYWxSZXN1bHQ7Cn07CnZhciBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUgPSAoY2hpbGRyZW4pID0+IHsKICB2YXIgd29yZHMgPSAhaXNOdWxsaXNoKGNoaWxkcmVuKSA/IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoQlJFQUtJTkdfU1BBQ0VTKSA6IFtdOwogIHJldHVybiBbewogICAgd29yZHMsCiAgICB3aWR0aDogdm9pZCAwCiAgfV07Cn07CnZhciBnZXRXb3Jkc0J5TGluZXMgPSAoX3JlZjQpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBzY2FsZVRvRml0LAogICAgY2hpbGRyZW4sCiAgICBzdHlsZSwKICAgIGJyZWFrQWxsLAogICAgbWF4TGluZXMKICB9ID0gX3JlZjQ7CiAgaWYgKCh3aWR0aCB8fCBzY2FsZVRvRml0KSAmJiAhR2xvYmFsLmlzU3NyKSB7CiAgICB2YXIgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwgc3BhY2VXaWR0aDsKICAgIHZhciB3b3JkV2lkdGhzID0gY2FsY3VsYXRlV29yZFdpZHRocyh7CiAgICAgIGJyZWFrQWxsLAogICAgICBjaGlsZHJlbiwKICAgICAgc3R5bGUKICAgIH0pOwogICAgaWYgKHdvcmRXaWR0aHMpIHsKICAgICAgdmFyIHsKICAgICAgICB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoOiB3Y3csCiAgICAgICAgc3BhY2VXaWR0aDogc3cKICAgICAgfSA9IHdvcmRXaWR0aHM7CiAgICAgIHdvcmRzV2l0aENvbXB1dGVkV2lkdGggPSB3Y3c7CiAgICAgIHNwYWNlV2lkdGggPSBzdzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUoY2hpbGRyZW4pOwogICAgfQogICAgcmV0dXJuIGNhbGN1bGF0ZVdvcmRzQnlMaW5lcyh7CiAgICAgIGJyZWFrQWxsLAogICAgICBjaGlsZHJlbiwKICAgICAgbWF4TGluZXMsCiAgICAgIHN0eWxlCiAgICB9LCB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLCBzcGFjZVdpZHRoLCB3aWR0aCwgQm9vbGVhbihzY2FsZVRvRml0KSk7CiAgfQogIHJldHVybiBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUoY2hpbGRyZW4pOwp9Owp2YXIgREVGQVVMVF9GSUxMID0gIiM4MDgwODAiOwp2YXIgdGV4dERlZmF1bHRQcm9wcyA9IHsKICBhbmdsZTogMCwKICBicmVha0FsbDogZmFsc2UsCiAgLy8gTWFnaWMgbnVtYmVyIGZyb20gZDMKICBjYXBIZWlnaHQ6ICIwLjcxZW0iLAogIGZpbGw6IERFRkFVTFRfRklMTCwKICBsaW5lSGVpZ2h0OiAiMWVtIiwKICBzY2FsZVRvRml0OiBmYWxzZSwKICB0ZXh0QW5jaG9yOiAic3RhcnQiLAogIC8vIE1haW50YWluIGNvbXBhdCB3aXRoIGV4aXN0aW5nIGNoYXJ0cyAvIGRlZmF1bHQgU1ZHIGJlaGF2aW9yCiAgdmVydGljYWxBbmNob3I6ICJlbmQiLAogIHg6IDAsCiAgeTogMAp9Owp2YXIgVGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjUuZm9yd2FyZFJlZikoKG91dHNpZGVQcm9wcywgcmVmKSA9PiB7CiAgdmFyIF9yZXNvbHZlRGVmYXVsdFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHRleHREZWZhdWx0UHJvcHMpLCB7CiAgICB4OiBwcm9wc1gsCiAgICB5OiBwcm9wc1ksCiAgICBsaW5lSGVpZ2h0LAogICAgY2FwSGVpZ2h0LAogICAgZmlsbCwKICAgIHNjYWxlVG9GaXQsCiAgICB0ZXh0QW5jaG9yLAogICAgdmVydGljYWxBbmNob3IKICB9ID0gX3Jlc29sdmVEZWZhdWx0UHJvcHMsIHByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNyhfcmVzb2x2ZURlZmF1bHRQcm9wcywgX2V4Y2x1ZGVkNyk7CiAgdmFyIHdvcmRzQnlMaW5lcyA9ICgwLCBpbXBvcnRfcmVhY3QyNS51c2VNZW1vKSgoKSA9PiB7CiAgICByZXR1cm4gZ2V0V29yZHNCeUxpbmVzKHsKICAgICAgYnJlYWtBbGw6IHByb3BzLmJyZWFrQWxsLAogICAgICBjaGlsZHJlbjogcHJvcHMuY2hpbGRyZW4sCiAgICAgIG1heExpbmVzOiBwcm9wcy5tYXhMaW5lcywKICAgICAgc2NhbGVUb0ZpdCwKICAgICAgc3R5bGU6IHByb3BzLnN0eWxlLAogICAgICB3aWR0aDogcHJvcHMud2lkdGgKICAgIH0pOwogIH0sIFtwcm9wcy5icmVha0FsbCwgcHJvcHMuY2hpbGRyZW4sIHByb3BzLm1heExpbmVzLCBzY2FsZVRvRml0LCBwcm9wcy5zdHlsZSwgcHJvcHMud2lkdGhdKTsKICB2YXIgewogICAgZHgsCiAgICBkeSwKICAgIGFuZ2xlLAogICAgY2xhc3NOYW1lLAogICAgYnJlYWtBbGwKICB9ID0gcHJvcHMsIHRleHRQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczcocHJvcHMsIF9leGNsdWRlZDIzKTsKICBpZiAoIWlzTnVtT3JTdHIocHJvcHNYKSB8fCAhaXNOdW1PclN0cihwcm9wc1kpIHx8IHdvcmRzQnlMaW5lcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgeDIgPSBOdW1iZXIocHJvcHNYKSArIChpc051bWJlcihkeCkgPyBkeCA6IDApOwogIHZhciB5MiA9IE51bWJlcihwcm9wc1kpICsgKGlzTnVtYmVyKGR5KSA/IGR5IDogMCk7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHgyKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcih5MikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgc3RhcnREeTsKICBzd2l0Y2ggKHZlcnRpY2FsQW5jaG9yKSB7CiAgICBjYXNlICJzdGFydCI6CiAgICAgIHN0YXJ0RHkgPSByZWR1Y2VDU1NDYWxjKCJjYWxjKCIuY29uY2F0KGNhcEhlaWdodCwgIikiKSk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAibWlkZGxlIjoKICAgICAgc3RhcnREeSA9IHJlZHVjZUNTU0NhbGMoImNhbGMoIi5jb25jYXQoKHdvcmRzQnlMaW5lcy5sZW5ndGggLSAxKSAvIDIsICIgKiAtIikuY29uY2F0KGxpbmVIZWlnaHQsICIgKyAoIikuY29uY2F0KGNhcEhlaWdodCwgIiAvIDIpKSIpKTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICBzdGFydER5ID0gcmVkdWNlQ1NTQ2FsYygiY2FsYygiLmNvbmNhdCh3b3Jkc0J5TGluZXMubGVuZ3RoIC0gMSwgIiAqIC0iKS5jb25jYXQobGluZUhlaWdodCwgIikiKSk7CiAgICAgIGJyZWFrOwogIH0KICB2YXIgdHJhbnNmb3JtcyA9IFtdOwogIGlmIChzY2FsZVRvRml0KSB7CiAgICB2YXIgbGluZVdpZHRoID0gd29yZHNCeUxpbmVzWzBdLndpZHRoOwogICAgdmFyIHsKICAgICAgd2lkdGgKICAgIH0gPSBwcm9wczsKICAgIHRyYW5zZm9ybXMucHVzaCgic2NhbGUoIi5jb25jYXQoaXNOdW1iZXIod2lkdGgpICYmIGlzTnVtYmVyKGxpbmVXaWR0aCkgPyB3aWR0aCAvIGxpbmVXaWR0aCA6IDEsICIpIikpOwogIH0KICBpZiAoYW5nbGUpIHsKICAgIHRyYW5zZm9ybXMucHVzaCgicm90YXRlKCIuY29uY2F0KGFuZ2xlLCAiLCAiKS5jb25jYXQoeDIsICIsICIpLmNvbmNhdCh5MiwgIikiKSk7CiAgfQogIGlmICh0cmFuc2Zvcm1zLmxlbmd0aCkgewogICAgdGV4dFByb3BzLnRyYW5zZm9ybSA9IHRyYW5zZm9ybXMuam9pbigiICIpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgidGV4dCIsIF9leHRlbmRzMTEoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHModGV4dFByb3BzKSwgewogICAgcmVmLAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtdGV4dCIsIGNsYXNzTmFtZSksCiAgICB0ZXh0QW5jaG9yLAogICAgZmlsbDogZmlsbC5pbmNsdWRlcygidXJsIikgPyBERUZBVUxUX0ZJTEwgOiBmaWxsCiAgfSksIHdvcmRzQnlMaW5lcy5tYXAoKGxpbmUsIGluZGV4KSA9PiB7CiAgICB2YXIgd29yZHMgPSBsaW5lLndvcmRzLmpvaW4oYnJlYWtBbGwgPyAiIiA6ICIgIik7CiAgICByZXR1cm4gKAogICAgICAvLyBkdXBsaWNhdGUgd29yZHMgd2lsbCBjYXVzZSBkdXBsaWNhdGUga2V5cyB3aGljaCBpcyB3aHkgd2UgYWRkIHRoZSBhcnJheSBpbmRleCBoZXJlCiAgICAgIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoInRzcGFuIiwgewogICAgICAgIHg6IHgyLAogICAgICAgIGR5OiBpbmRleCA9PT0gMCA/IHN0YXJ0RHkgOiBsaW5lSGVpZ2h0LAogICAgICAgIGtleTogIiIuY29uY2F0KHdvcmRzLCAiLSIpLmNvbmNhdChpbmRleCkKICAgICAgfSwgd29yZHMpCiAgICApOwogIH0pKTsKfSk7ClRleHQuZGlzcGxheU5hbWUgPSAiVGV4dCI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9MYWJlbC5qcwp2YXIgUmVhY3QxNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkOCA9IFsibGFiZWxSZWYiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gb3duS2V5czI0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyNChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjUoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjUocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjUodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjUodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTIoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczEyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIENhcnRlc2lhbkxhYmVsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciBDYXJ0ZXNpYW5MYWJlbENvbnRleHRQcm92aWRlciA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciB2aWV3Qm94ID0gKDAsIGltcG9ydF9yZWFjdDI2LnVzZU1lbW8pKCgpID0+ICh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCBbeDIsIHkyLCB1cHBlcldpZHRoLCBsb3dlcldpZHRoLCB3aWR0aCwgaGVpZ2h0XSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogdmlld0JveAogIH0sIGNoaWxkcmVuKTsKfTsKdmFyIHVzZUNhcnRlc2lhbkxhYmVsQ29udGV4dCA9ICgpID0+IHsKICB2YXIgbGFiZWxDaGlsZENvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0MjYudXNlQ29udGV4dCkoQ2FydGVzaWFuTGFiZWxDb250ZXh0KTsKICB2YXIgY2hhcnRDb250ZXh0ID0gdXNlVmlld0JveCgpOwogIHJldHVybiBsYWJlbENoaWxkQ29udGV4dCB8fCBjYXJ0ZXNpYW5WaWV3Qm94VG9UcmFwZXpvaWQoY2hhcnRDb250ZXh0KTsKfTsKdmFyIFBvbGFyTGFiZWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIHVzZVBvbGFyTGFiZWxDb250ZXh0ID0gKCkgPT4gewogIHZhciBsYWJlbENoaWxkQ29udGV4dCA9ICgwLCBpbXBvcnRfcmVhY3QyNi51c2VDb250ZXh0KShQb2xhckxhYmVsQ29udGV4dCk7CiAgdmFyIGNoYXJ0Q29udGV4dCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFBvbGFyVmlld0JveCk7CiAgcmV0dXJuIGxhYmVsQ2hpbGRDb250ZXh0IHx8IGNoYXJ0Q29udGV4dDsKfTsKdmFyIGdldExhYmVsID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHZhbHVlLAogICAgZm9ybWF0dGVyCiAgfSA9IHByb3BzOwogIHZhciBsYWJlbCA9IGlzTnVsbGlzaChwcm9wcy5jaGlsZHJlbikgPyB2YWx1ZSA6IHByb3BzLmNoaWxkcmVuOwogIGlmICh0eXBlb2YgZm9ybWF0dGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZm9ybWF0dGVyKGxhYmVsKTsKICB9CiAgcmV0dXJuIGxhYmVsOwp9Owp2YXIgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24gPSAoY29udGVudCkgPT4gewogIHJldHVybiBjb250ZW50ICE9IG51bGwgJiYgdHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiI7Cn07CnZhciBnZXREZWx0YUFuZ2xlMiA9IChzdGFydEFuZ2xlLCBlbmRBbmdsZSkgPT4gewogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBNYXRoLm1pbihNYXRoLmFicyhlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpLCAzNjApOwogIHJldHVybiBzaWduMiAqIGRlbHRhQW5nbGU7Cn07CnZhciByZW5kZXJSYWRpYWxMYWJlbCA9IChsYWJlbFByb3BzLCBwb3NpdGlvbiwgbGFiZWwsIGF0dHJzLCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIG9mZnNldCwKICAgIGNsYXNzTmFtZQogIH0gPSBsYWJlbFByb3BzOwogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZSwKICAgIGNsb2NrV2lzZQogIH0gPSB2aWV3Qm94OwogIHZhciByYWRpdXMgPSAoaW5uZXJSYWRpdXMgKyBvdXRlclJhZGl1cykgLyAyOwogIHZhciBkZWx0YUFuZ2xlID0gZ2V0RGVsdGFBbmdsZTIoc3RhcnRBbmdsZSwgZW5kQW5nbGUpOwogIHZhciBzaWduMiA9IGRlbHRhQW5nbGUgPj0gMCA/IDEgOiAtMTsKICB2YXIgbGFiZWxBbmdsZSwgZGlyZWN0aW9uOwogIHN3aXRjaCAocG9zaXRpb24pIHsKICAgIGNhc2UgImluc2lkZVN0YXJ0IjoKICAgICAgbGFiZWxBbmdsZSA9IHN0YXJ0QW5nbGUgKyBzaWduMiAqIG9mZnNldDsKICAgICAgZGlyZWN0aW9uID0gY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGNhc2UgImluc2lkZUVuZCI6CiAgICAgIGxhYmVsQW5nbGUgPSBlbmRBbmdsZSAtIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSAhY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGNhc2UgImVuZCI6CiAgICAgIGxhYmVsQW5nbGUgPSBlbmRBbmdsZSArIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSBjbG9ja1dpc2U7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCBwb3NpdGlvbiAiLmNvbmNhdChwb3NpdGlvbikpOwogIH0KICBkaXJlY3Rpb24gPSBkZWx0YUFuZ2xlIDw9IDAgPyBkaXJlY3Rpb24gOiAhZGlyZWN0aW9uOwogIHZhciBzdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgbGFiZWxBbmdsZSk7CiAgdmFyIGVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgbGFiZWxBbmdsZSArIChkaXJlY3Rpb24gPyAxIDogLTEpICogMzU5KTsKICB2YXIgcGF0aDIgPSAiTSIuY29uY2F0KHN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQoc3RhcnRQb2ludC55LCAiXG4gICAgQSIpLmNvbmNhdChyYWRpdXMsICIsIikuY29uY2F0KHJhZGl1cywgIiwwLDEsIikuY29uY2F0KGRpcmVjdGlvbiA/IDAgOiAxLCAiLFxuICAgICIpLmNvbmNhdChlbmRQb2ludC54LCAiLCIpLmNvbmNhdChlbmRQb2ludC55KTsKICB2YXIgaWQgPSBpc051bGxpc2gobGFiZWxQcm9wcy5pZCkgPyB1bmlxdWVJZCgicmVjaGFydHMtcmFkaWFsLWxpbmUtIikgOiBsYWJlbFByb3BzLmlkOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KCJ0ZXh0IiwgX2V4dGVuZHMxMih7fSwgYXR0cnMsIHsKICAgIGRvbWluYW50QmFzZWxpbmU6ICJjZW50cmFsIiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtcmFkaWFsLWJhci1sYWJlbCIsIGNsYXNzTmFtZSkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCB7CiAgICBpZCwKICAgIGQ6IHBhdGgyCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KCJ0ZXh0UGF0aCIsIHsKICAgIHhsaW5rSHJlZjogIiMiLmNvbmNhdChpZCkKICB9LCBsYWJlbCkpOwp9Owp2YXIgZ2V0QXR0cnNPZlBvbGFyTGFiZWwgPSAodmlld0JveCwgb2Zmc2V0LCBwb3NpdGlvbikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSB2aWV3Qm94OwogIHZhciBtaWRBbmdsZSA9IChzdGFydEFuZ2xlICsgZW5kQW5nbGUpIC8gMjsKICBpZiAocG9zaXRpb24gPT09ICJvdXRzaWRlIikgewogICAgdmFyIHsKICAgICAgeDogX3gsCiAgICAgIHk6IF95CiAgICB9ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzICsgb2Zmc2V0LCBtaWRBbmdsZSk7CiAgICByZXR1cm4gewogICAgICB4OiBfeCwKICAgICAgeTogX3ksCiAgICAgIHRleHRBbmNob3I6IF94ID49IGN4ID8gInN0YXJ0IiA6ICJlbmQiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlciIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiY2VudGVyVG9wIikgewogICAgcmV0dXJuIHsKICAgICAgeDogY3gsCiAgICAgIHk6IGN5LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJzdGFydCIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlckJvdHRvbSIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAiZW5kIgogICAgfTsKICB9CiAgdmFyIHIyID0gKGlubmVyUmFkaXVzICsgb3V0ZXJSYWRpdXMpIC8gMjsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MgogIH0gPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcjIsIG1pZEFuZ2xlKTsKICByZXR1cm4gewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgfTsKfTsKdmFyIGlzUG9sYXIgPSAodmlld0JveCkgPT4gImN4IiBpbiB2aWV3Qm94ICYmIGlzTnVtYmVyKHZpZXdCb3guY3gpOwp2YXIgZ2V0QXR0cnNPZkNhcnRlc2lhbkxhYmVsID0gKHByb3BzLCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIHBhcmVudFZpZXdCb3g6IHBhcmVudFZpZXdCb3hGcm9tUHJvcHMsCiAgICBvZmZzZXQsCiAgICBwb3NpdGlvbgogIH0gPSBwcm9wczsKICB2YXIgcGFyZW50Vmlld0JveDsKICBpZiAocGFyZW50Vmlld0JveEZyb21Qcm9wcyAhPSBudWxsICYmICFpc1BvbGFyKHBhcmVudFZpZXdCb3hGcm9tUHJvcHMpKSB7CiAgICBwYXJlbnRWaWV3Qm94ID0gcGFyZW50Vmlld0JveEZyb21Qcm9wczsKICB9CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB1cHBlcldpZHRoLAogICAgbG93ZXJXaWR0aCwKICAgIGhlaWdodAogIH0gPSB2aWV3Qm94OwogIHZhciB1cHBlclggPSB4MjsKICB2YXIgbG93ZXJYID0geDIgKyAodXBwZXJXaWR0aCAtIGxvd2VyV2lkdGgpIC8gMjsKICB2YXIgbWlkZGxlWCA9ICh1cHBlclggKyBsb3dlclgpIC8gMjsKICB2YXIgbWlkSGVpZ2h0V2lkdGggPSAodXBwZXJXaWR0aCArIGxvd2VyV2lkdGgpIC8gMjsKICB2YXIgY2VudGVyWCA9IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyOwogIHZhciB2ZXJ0aWNhbFNpZ24gPSBoZWlnaHQgPj0gMCA/IDEgOiAtMTsKICB2YXIgdmVydGljYWxPZmZzZXQgPSB2ZXJ0aWNhbFNpZ24gKiBvZmZzZXQ7CiAgdmFyIHZlcnRpY2FsRW5kID0gdmVydGljYWxTaWduID4gMCA/ICJlbmQiIDogInN0YXJ0IjsKICB2YXIgdmVydGljYWxTdGFydCA9IHZlcnRpY2FsU2lnbiA+IDAgPyAic3RhcnQiIDogImVuZCI7CiAgdmFyIGhvcml6b250YWxTaWduID0gdXBwZXJXaWR0aCA+PSAwID8gMSA6IC0xOwogIHZhciBob3Jpem9udGFsT2Zmc2V0ID0gaG9yaXpvbnRhbFNpZ24gKiBvZmZzZXQ7CiAgdmFyIGhvcml6b250YWxFbmQgPSBob3Jpem9udGFsU2lnbiA+IDAgPyAiZW5kIiA6ICJzdGFydCI7CiAgdmFyIGhvcml6b250YWxTdGFydCA9IGhvcml6b250YWxTaWduID4gMCA/ICJzdGFydCIgOiAiZW5kIjsKICBpZiAocG9zaXRpb24gPT09ICJ0b3AiKSB7CiAgICB2YXIgYXR0cnMgPSB7CiAgICAgIHg6IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyLAogICAgICB5OiB5MiAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyNChfb2JqZWN0U3ByZWFkMjQoe30sIGF0dHJzKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgaGVpZ2h0OiBNYXRoLm1heCh5MiAtIHBhcmVudFZpZXdCb3gueSwgMCksCiAgICAgIHdpZHRoOiB1cHBlcldpZHRoCiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJib3R0b20iKSB7CiAgICB2YXIgX2F0dHJzID0gewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyBoZWlnaHQgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyNChfb2JqZWN0U3ByZWFkMjQoe30sIF9hdHRycyksIHBhcmVudFZpZXdCb3ggPyB7CiAgICAgIGhlaWdodDogTWF0aC5tYXgocGFyZW50Vmlld0JveC55ICsgcGFyZW50Vmlld0JveC5oZWlnaHQgLSAoeTIgKyBoZWlnaHQpLCAwKSwKICAgICAgd2lkdGg6IGxvd2VyV2lkdGgKICAgIH0gOiB7fSk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImxlZnQiKSB7CiAgICB2YXIgX2F0dHJzMiA9IHsKICAgICAgeDogbWlkZGxlWCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyNChfb2JqZWN0U3ByZWFkMjQoe30sIF9hdHRyczIpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICB3aWR0aDogTWF0aC5tYXgoX2F0dHJzMi54IC0gcGFyZW50Vmlld0JveC54LCAwKSwKICAgICAgaGVpZ2h0CiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJyaWdodCIpIHsKICAgIHZhciBfYXR0cnMzID0gewogICAgICB4OiBtaWRkbGVYICsgbWlkSGVpZ2h0V2lkdGggKyBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyNChfb2JqZWN0U3ByZWFkMjQoe30sIF9hdHRyczMpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICB3aWR0aDogTWF0aC5tYXgocGFyZW50Vmlld0JveC54ICsgcGFyZW50Vmlld0JveC53aWR0aCAtIF9hdHRyczMueCwgMCksCiAgICAgIGhlaWdodAogICAgfSA6IHt9KTsKICB9CiAgdmFyIHNpemVBdHRycyA9IHBhcmVudFZpZXdCb3ggPyB7CiAgICB3aWR0aDogbWlkSGVpZ2h0V2lkdGgsCiAgICBoZWlnaHQKICB9IDoge307CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlTGVmdCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjQoewogICAgICB4OiBtaWRkbGVYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDI0KHsKICAgICAgeDogbWlkZGxlWCArIG1pZEhlaWdodFdpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsRW5kLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjQoewogICAgICB4OiB1cHBlclggKyB1cHBlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b20iKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDI0KHsKICAgICAgeDogbG93ZXJYICsgbG93ZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxFbmQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcExlZnQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDI0KHsKICAgICAgeDogdXBwZXJYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbFN0YXJ0LAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlVG9wUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDI0KHsKICAgICAgeDogdXBwZXJYICsgdXBwZXJXaWR0aCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b21MZWZ0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyNCh7CiAgICAgIHg6IGxvd2VyWCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b21SaWdodCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjQoewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLSB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAoISFwb3NpdGlvbiAmJiB0eXBlb2YgcG9zaXRpb24gPT09ICJvYmplY3QiICYmIChpc051bWJlcihwb3NpdGlvbi54KSB8fCBpc1BlcmNlbnQocG9zaXRpb24ueCkpICYmIChpc051bWJlcihwb3NpdGlvbi55KSB8fCBpc1BlcmNlbnQocG9zaXRpb24ueSkpKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDI0KHsKICAgICAgeDogeDIgKyBnZXRQZXJjZW50VmFsdWUocG9zaXRpb24ueCwgbWlkSGVpZ2h0V2lkdGgpLAogICAgICB5OiB5MiArIGdldFBlcmNlbnRWYWx1ZShwb3NpdGlvbi55LCBoZWlnaHQpLAogICAgICB0ZXh0QW5jaG9yOiAiZW5kIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJlbmQiCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICByZXR1cm4gX29iamVjdFNwcmVhZDI0KHsKICAgIHg6IGNlbnRlclgsCiAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogIH0sIHNpemVBdHRycyk7Cn07CnZhciBkZWZhdWx0TGFiZWxQcm9wcyA9IHsKICBhbmdsZTogMCwKICBvZmZzZXQ6IDUsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMubGFiZWwsCiAgcG9zaXRpb246ICJtaWRkbGUiLAogIHRleHRCcmVha0FsbDogZmFsc2UKfTsKZnVuY3Rpb24gTGFiZWwob3V0ZXJQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0ZXJQcm9wcywgZGVmYXVsdExhYmVsUHJvcHMpOwogIHZhciB7CiAgICB2aWV3Qm94OiB2aWV3Qm94RnJvbVByb3BzLAogICAgcG9zaXRpb24sCiAgICB2YWx1ZSwKICAgIGNoaWxkcmVuLAogICAgY29udGVudCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgdGV4dEJyZWFrQWxsLAogICAgbGFiZWxSZWYKICB9ID0gcHJvcHM7CiAgdmFyIHBvbGFyVmlld0JveCA9IHVzZVBvbGFyTGFiZWxDb250ZXh0KCk7CiAgdmFyIGNhcnRlc2lhblZpZXdCb3ggPSB1c2VDYXJ0ZXNpYW5MYWJlbENvbnRleHQoKTsKICB2YXIgcmVzb2x2ZWRWaWV3Qm94ID0gcG9zaXRpb24gPT09ICJjZW50ZXIiID8gY2FydGVzaWFuVmlld0JveCA6IHBvbGFyVmlld0JveCAhPT0gbnVsbCAmJiBwb2xhclZpZXdCb3ggIT09IHZvaWQgMCA/IHBvbGFyVmlld0JveCA6IGNhcnRlc2lhblZpZXdCb3g7CiAgdmFyIHZpZXdCb3gsIGxhYmVsLCBwb3NpdGlvbkF0dHJzOwogIGlmICh2aWV3Qm94RnJvbVByb3BzID09IG51bGwpIHsKICAgIHZpZXdCb3ggPSByZXNvbHZlZFZpZXdCb3g7CiAgfSBlbHNlIGlmIChpc1BvbGFyKHZpZXdCb3hGcm9tUHJvcHMpKSB7CiAgICB2aWV3Qm94ID0gdmlld0JveEZyb21Qcm9wczsKICB9IGVsc2UgewogICAgdmlld0JveCA9IGNhcnRlc2lhblZpZXdCb3hUb1RyYXBlem9pZCh2aWV3Qm94RnJvbVByb3BzKTsKICB9CiAgaWYgKCF2aWV3Qm94IHx8IGlzTnVsbGlzaCh2YWx1ZSkgJiYgaXNOdWxsaXNoKGNoaWxkcmVuKSAmJiAhLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkoY29udGVudCkgJiYgdHlwZW9mIGNvbnRlbnQgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcHJvcHNXaXRoVmlld0JveCA9IF9vYmplY3RTcHJlYWQyNChfb2JqZWN0U3ByZWFkMjQoe30sIHByb3BzKSwge30sIHsKICAgIHZpZXdCb3gKICB9KTsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkoY29udGVudCkpIHsKICAgIHZhciB7CiAgICAgIGxhYmVsUmVmOiBfCiAgICB9ID0gcHJvcHNXaXRoVmlld0JveCwgcHJvcHNXaXRob3V0TGFiZWxSZWYgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM4KHByb3BzV2l0aFZpZXdCb3gsIF9leGNsdWRlZDgpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY2xvbmVFbGVtZW50KShjb250ZW50LCBwcm9wc1dpdGhvdXRMYWJlbFJlZik7CiAgfQogIGlmICh0eXBlb2YgY29udGVudCA9PT0gImZ1bmN0aW9uIikgewogICAgbGFiZWwgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNyZWF0ZUVsZW1lbnQpKGNvbnRlbnQsIHByb3BzV2l0aFZpZXdCb3gpOwogICAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSkgewogICAgICByZXR1cm4gbGFiZWw7CiAgICB9CiAgfSBlbHNlIHsKICAgIGxhYmVsID0gZ2V0TGFiZWwocHJvcHMpOwogIH0KICB2YXIgYXR0cnMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKTsKICBpZiAoaXNQb2xhcih2aWV3Qm94KSkgewogICAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlU3RhcnQiIHx8IHBvc2l0aW9uID09PSAiaW5zaWRlRW5kIiB8fCBwb3NpdGlvbiA9PT0gImVuZCIpIHsKICAgICAgcmV0dXJuIHJlbmRlclJhZGlhbExhYmVsKHByb3BzLCBwb3NpdGlvbiwgbGFiZWwsIGF0dHJzLCB2aWV3Qm94KTsKICAgIH0KICAgIHBvc2l0aW9uQXR0cnMgPSBnZXRBdHRyc09mUG9sYXJMYWJlbCh2aWV3Qm94LCBwcm9wcy5vZmZzZXQsIHByb3BzLnBvc2l0aW9uKTsKICB9IGVsc2UgewogICAgcG9zaXRpb25BdHRycyA9IGdldEF0dHJzT2ZDYXJ0ZXNpYW5MYWJlbChwcm9wcywgdmlld0JveCk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoVGV4dCwgX2V4dGVuZHMxMih7CiAgICByZWY6IGxhYmVsUmVmLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1sYWJlbCIsIGNsYXNzTmFtZSkKICB9LCBhdHRycywgcG9zaXRpb25BdHRycywgewogICAgLyoKICAgICAqIHRleHRBbmNob3IgaXMgZGVjaWRlZCBieSBkZWZhdWx0IGJhc2VkIG9uIHRoZSBgcG9zaXRpb25gCiAgICAgKiBidXQgd2UgYWxsb3cgb3ZlcnJpZGluZyB2aWEgcHJvcHMgZm9yIHByZWNpc2UgY29udHJvbC4KICAgICAqLwogICAgdGV4dEFuY2hvcjogaXNWYWxpZFRleHRBbmNob3IoYXR0cnMudGV4dEFuY2hvcikgPyBhdHRycy50ZXh0QW5jaG9yIDogcG9zaXRpb25BdHRycy50ZXh0QW5jaG9yLAogICAgYnJlYWtBbGw6IHRleHRCcmVha0FsbAogIH0pLCBsYWJlbCkpOwp9CkxhYmVsLmRpc3BsYXlOYW1lID0gIkxhYmVsIjsKdmFyIHBhcnNlTGFiZWwgPSAobGFiZWwsIHZpZXdCb3gsIGxhYmVsUmVmKSA9PiB7CiAgaWYgKCFsYWJlbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBjb21tb25Qcm9wcyA9IHsKICAgIHZpZXdCb3gsCiAgICBsYWJlbFJlZgogIH07CiAgaWYgKGxhYmVsID09PSB0cnVlKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMih7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGlzTnVtT3JTdHIobGFiZWwpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMih7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IiwKICAgICAgdmFsdWU6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkobGFiZWwpKSB7CiAgICBpZiAobGFiZWwudHlwZSA9PT0gTGFiZWwpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY2xvbmVFbGVtZW50KShsYWJlbCwgX29iamVjdFNwcmVhZDI0KHsKICAgICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIKICAgICAgfSwgY29tbW9uUHJvcHMpKTsKICAgIH0KICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczEyKHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiLAogICAgICBjb250ZW50OiBsYWJlbAogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTIoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIsCiAgICAgIGNvbnRlbnQ6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAobGFiZWwgJiYgdHlwZW9mIGxhYmVsID09PSAib2JqZWN0IikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTIoe30sIGxhYmVsLCB7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CmZ1bmN0aW9uIENhcnRlc2lhbkxhYmVsRnJvbUxhYmVsUHJvcChfcmVmMykgewogIHZhciB7CiAgICBsYWJlbCwKICAgIGxhYmVsUmVmCiAgfSA9IF9yZWYzOwogIHZhciB2aWV3Qm94ID0gdXNlQ2FydGVzaWFuTGFiZWxDb250ZXh0KCk7CiAgcmV0dXJuIHBhcnNlTGFiZWwobGFiZWwsIHZpZXdCb3gsIGxhYmVsUmVmKSB8fCBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9MYWJlbExpc3QuanMKdmFyIFJlYWN0MTYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9sYXN0ID0gX190b0VTTShyZXF1aXJlX2xhc3QzKCkpOwp2YXIgX2V4Y2x1ZGVkOSA9IFsidmFsdWVBY2Nlc3NvciJdOwp2YXIgX2V4Y2x1ZGVkMjQgPSBbImRhdGFLZXkiLCAiY2xvY2tXaXNlIiwgImlkIiwgInRleHRCcmVha0FsbCIsICJ6SW5kZXgiXTsKZnVuY3Rpb24gX2V4dGVuZHMxMygpIHsKICByZXR1cm4gX2V4dGVuZHMxMyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM5KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U5KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U5KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgZGVmYXVsdEFjY2Vzc29yID0gKGVudHJ5KSA9PiBBcnJheS5pc0FycmF5KGVudHJ5LnZhbHVlKSA/ICgwLCBpbXBvcnRfbGFzdC5kZWZhdWx0KShlbnRyeS52YWx1ZSkgOiBlbnRyeS52YWx1ZTsKdmFyIENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI3LmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0UHJvdmlkZXIgPSBDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0LlByb3ZpZGVyOwp2YXIgUG9sYXJMYWJlbExpc3RDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNy5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgUG9sYXJMYWJlbExpc3RDb250ZXh0UHJvdmlkZXIgPSBQb2xhckxhYmVsTGlzdENvbnRleHQuUHJvdmlkZXI7CmZ1bmN0aW9uIHVzZUNhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQoKSB7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QyNy51c2VDb250ZXh0KShDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0KTsKfQpmdW5jdGlvbiB1c2VQb2xhckxhYmVsTGlzdENvbnRleHQoKSB7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QyNy51c2VDb250ZXh0KShQb2xhckxhYmVsTGlzdENvbnRleHQpOwp9CmZ1bmN0aW9uIExhYmVsTGlzdChfcmVmMikgewogIHZhciB7CiAgICB2YWx1ZUFjY2Vzc29yID0gZGVmYXVsdEFjY2Vzc29yCiAgfSA9IF9yZWYyLCByZXN0UHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM5KF9yZWYyLCBfZXhjbHVkZWQ5KTsKICB2YXIgewogICAgZGF0YUtleSwKICAgIGNsb2NrV2lzZSwKICAgIGlkLAogICAgdGV4dEJyZWFrQWxsLAogICAgekluZGV4CiAgfSA9IHJlc3RQcm9wcywgb3RoZXJzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOShyZXN0UHJvcHMsIF9leGNsdWRlZDI0KTsKICB2YXIgY2FydGVzaWFuRGF0YSA9IHVzZUNhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQoKTsKICB2YXIgcG9sYXJEYXRhID0gdXNlUG9sYXJMYWJlbExpc3RDb250ZXh0KCk7CiAgdmFyIGRhdGEgPSBjYXJ0ZXNpYW5EYXRhIHx8IHBvbGFyRGF0YTsKICBpZiAoIWRhdGEgfHwgIWRhdGEubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE2LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogekluZGV4ICE9PSBudWxsICYmIHpJbmRleCAhPT0gdm9pZCAwID8gekluZGV4IDogRGVmYXVsdFpJbmRleGVzLmxhYmVsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTYuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtbGFiZWwtbGlzdCIKICB9LCBkYXRhLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICB2YXIgX3Jlc3RQcm9wcyRmaWxsOwogICAgdmFyIHZhbHVlID0gaXNOdWxsaXNoKGRhdGFLZXkpID8gdmFsdWVBY2Nlc3NvcihlbnRyeSwgaW5kZXgpIDogZ2V0VmFsdWVCeURhdGFLZXkoZW50cnkgJiYgZW50cnkucGF5bG9hZCwgZGF0YUtleSk7CiAgICB2YXIgaWRQcm9wcyA9IGlzTnVsbGlzaChpZCkgPyB7fSA6IHsKICAgICAgaWQ6ICIiLmNvbmNhdChpZCwgIi0iKS5jb25jYXQoaW5kZXgpCiAgICB9OwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE2LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTMoewogICAgICBrZXk6ICJsYWJlbC0iLmNvbmNhdChpbmRleCkKICAgIH0sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMoZW50cnkpLCBvdGhlcnMsIGlkUHJvcHMsIHsKICAgICAgLyoKICAgICAgICogUHJlZmVyIHRvIHVzZSB0aGUgZXhwbGljaXQgZmlsbCBmcm9tIExhYmVsTGlzdCBwcm9wcy4KICAgICAgICogT25seSBpbiBhbiBhYnNlbmNlIG9mIHRoYXQsIGZhbGwgYmFjayB0byB0aGUgZmlsbCBvZiB0aGUgZW50cnkuCiAgICAgICAqIFRoZSBlbnRyeSBmaWxsIGNhbiBiZSBxdWl0ZSBkaWZmaWN1bHQgdG8gc2VlIGVzcGVjaWFsbHkgaW4gQmFyLCBQaWUsIFJhZGlhbEJhciBpbiBpbnNpZGUgcG9zaXRpb25zLgogICAgICAgKiBPbiB0aGUgb3RoZXIgaGFuZCBpdCdzIHF1aXRlIGNvbnZlbmllbnQgaW4gU2NhdHRlciwgTGluZSwgb3Igd2hlbiB0aGUgcG9zaXRpb24gaXMgb3V0c2lkZSB0aGUgQmFyLCBQaWUgZmlsbGVkIHNoYXBlcy4KICAgICAgICovCiAgICAgIGZpbGw6IChfcmVzdFByb3BzJGZpbGwgPSByZXN0UHJvcHMuZmlsbCkgIT09IG51bGwgJiYgX3Jlc3RQcm9wcyRmaWxsICE9PSB2b2lkIDAgPyBfcmVzdFByb3BzJGZpbGwgOiBlbnRyeS5maWxsLAogICAgICBwYXJlbnRWaWV3Qm94OiBlbnRyeS5wYXJlbnRWaWV3Qm94LAogICAgICB2YWx1ZSwKICAgICAgdGV4dEJyZWFrQWxsLAogICAgICB2aWV3Qm94OiBlbnRyeS52aWV3Qm94LAogICAgICBpbmRleCwKICAgICAgekluZGV4OiAwCiAgICB9KSk7CiAgfSkpKTsKfQpMYWJlbExpc3QuZGlzcGxheU5hbWUgPSAiTGFiZWxMaXN0IjsKZnVuY3Rpb24gTGFiZWxMaXN0RnJvbUxhYmVsUHJvcChfcmVmMikgewogIHZhciB7CiAgICBsYWJlbAogIH0gPSBfcmVmMjsKICBpZiAoIWxhYmVsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKGxhYmVsID09PSB0cnVlKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTYuY3JlYXRlRWxlbWVudChMYWJlbExpc3QsIHsKICAgICAga2V5OiAibGFiZWxMaXN0LWltcGxpY2l0IgogICAgfSk7CiAgfQogIGlmICgvKiBAX19QVVJFX18gKi8gUmVhY3QxNi5pc1ZhbGlkRWxlbWVudChsYWJlbCkgfHwgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24obGFiZWwpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTYuY3JlYXRlRWxlbWVudChMYWJlbExpc3QsIHsKICAgICAga2V5OiAibGFiZWxMaXN0LWltcGxpY2l0IiwKICAgICAgY29udGVudDogbGFiZWwKICAgIH0pOwogIH0KICBpZiAodHlwZW9mIGxhYmVsID09PSAib2JqZWN0IikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE2LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0LCBfZXh0ZW5kczEzKHsKICAgICAga2V5OiAibGFiZWxMaXN0LWltcGxpY2l0IgogICAgfSwgbGFiZWwsIHsKICAgICAgdHlwZTogU3RyaW5nKGxhYmVsLnR5cGUpCiAgICB9KSk7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL0RvdC5qcwp2YXIgUmVhY3QxNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gX2V4dGVuZHMxNCgpIHsKICByZXR1cm4gX2V4dGVuZHMxNCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRG90ID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICByOiByMiwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLWRvdCIsIGNsYXNzTmFtZSk7CiAgaWYgKGlzTnVtYmVyKGN4KSAmJiBpc051bWJlcihjeSkgJiYgaXNOdW1iZXIocjIpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTcuY3JlYXRlRWxlbWVudCgiY2lyY2xlIiwgX2V4dGVuZHMxNCh7fSwgc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKSwgYWRhcHRFdmVudEhhbmRsZXJzKHByb3BzKSwgewogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcjogcjIKICAgIH0pKTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9wb2xhclNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0VW5maWx0ZXJlZFBvbGFySXRlbXMgPSAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLnBvbGFySXRlbXM7CnZhciBzZWxlY3RBeGlzUHJlZGljYXRlMiA9IGNyZWF0ZVNlbGVjdG9yKFtwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBpdGVtQXhpc1ByZWRpY2F0ZSk7CnZhciBzZWxlY3RQb2xhckl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VW5maWx0ZXJlZFBvbGFySXRlbXMsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzUHJlZGljYXRlMl0sIGNvbWJpbmVHcmFwaGljYWxJdGVtc1NldHRpbmdzKTsKdmFyIHNlbGVjdFBvbGFyR3JhcGhpY2FsSXRlbXNEYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFBvbGFySXRlbXNTZXR0aW5nc10sIGNvbWJpbmVHcmFwaGljYWxJdGVtc0RhdGEpOwp2YXIgc2VsZWN0UG9sYXJEaXNwbGF5ZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFBvbGFyR3JhcGhpY2FsSXRlbXNEYXRhLCBzZWxlY3RDaGFydERhdGFBbmRBbHdheXNJZ25vcmVJbmRleGVzXSwgY29tYmluZURpc3BsYXllZERhdGEpOwp2YXIgc2VsZWN0UG9sYXJBcHBsaWVkVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFBvbGFyRGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdFBvbGFySXRlbXNTZXR0aW5nc10sIGNvbWJpbmVBcHBsaWVkVmFsdWVzKTsKdmFyIHNlbGVjdEFsbFBvbGFyQXBwbGllZE51bWVyaWNhbFZhbHVlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhckRpc3BsYXllZERhdGEsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RQb2xhckl0ZW1zU2V0dGluZ3NdLCAoZGF0YSwgYXhpc1NldHRpbmdzLCBpdGVtcykgPT4gewogIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gZGF0YS5mbGF0TWFwKChlbnRyeSkgPT4gewogICAgICByZXR1cm4gaXRlbXMuZmxhdE1hcCgoaXRlbSkgPT4gewogICAgICAgIHZhciBfYXhpc1NldHRpbmdzJGRhdGFLZXk7CiAgICAgICAgdmFyIHZhbHVlQnlEYXRhS2V5ID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIChfYXhpc1NldHRpbmdzJGRhdGFLZXkgPSBheGlzU2V0dGluZ3MuZGF0YUtleSkgIT09IG51bGwgJiYgX2F4aXNTZXR0aW5ncyRkYXRhS2V5ICE9PSB2b2lkIDAgPyBfYXhpc1NldHRpbmdzJGRhdGFLZXkgOiBpdGVtLmRhdGFLZXkpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB2YWx1ZTogdmFsdWVCeURhdGFLZXksCiAgICAgICAgICBlcnJvckRvbWFpbjogW10KICAgICAgICAgIC8vIHBvbGFyIGNoYXJ0cyBkbyBub3QgaGF2ZSBlcnJvciBiYXJzCiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9KS5maWx0ZXIoQm9vbGVhbik7CiAgfQogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9IG51bGwpIHsKICAgIHJldHVybiBkYXRhLm1hcCgoaXRlbSkgPT4gKHsKICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KGl0ZW0sIGF4aXNTZXR0aW5ncy5kYXRhS2V5KSwKICAgICAgZXJyb3JEb21haW46IFtdCiAgICB9KSk7CiAgfQogIHJldHVybiBkYXRhLm1hcCgoZW50cnkpID0+ICh7CiAgICB2YWx1ZTogZW50cnksCiAgICBlcnJvckRvbWFpbjogW10KICB9KSk7Cn0pOwp2YXIgdW5zdXBwb3J0ZWRJblBvbGFyQ2hhcnQgPSAoKSA9PiB2b2lkIDA7CnZhciBzZWxlY3REb21haW5PZkFsbFBvbGFyQXBwbGllZE51bWVyaWNhbFZhbHVlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhckRpc3BsYXllZERhdGEsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RQb2xhckl0ZW1zU2V0dGluZ3MsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcyk7CnZhciBzZWxlY3RQb2xhck51bWVyaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0RG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0RG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlLCB1bnN1cHBvcnRlZEluUG9sYXJDaGFydCwgc2VsZWN0RG9tYWluT2ZBbGxQb2xhckFwcGxpZWROdW1lcmljYWxWYWx1ZXMsIHVuc3VwcG9ydGVkSW5Qb2xhckNoYXJ0LCBzZWxlY3RDaGFydExheW91dCwgcGlja0F4aXNUeXBlXSwgY29tYmluZU51bWVyaWNhbERvbWFpbik7CnZhciBzZWxlY3RQb2xhckF4aXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RQb2xhckRpc3BsYXllZERhdGEsIHNlbGVjdFBvbGFyQXBwbGllZFZhbHVlcywgc2VsZWN0U3RhY2tPZmZzZXRUeXBlLCBwaWNrQXhpc1R5cGUsIHNlbGVjdFBvbGFyTnVtZXJpY2FsRG9tYWluXSwgY29tYmluZUF4aXNEb21haW4pOwp2YXIgc2VsZWN0UG9sYXJOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJBeGlzRG9tYWluLCBzZWxlY3RCYXNlQXhpcywgc2VsZWN0UmVhbFNjYWxlVHlwZV0sIGNvbWJpbmVOaWNlVGlja3MpOwp2YXIgc2VsZWN0UG9sYXJBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RQb2xhckF4aXNEb21haW4sIHNlbGVjdFBvbGFyTmljZVRpY2tzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9wb2xhckF4aXNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlNiA9IHsKICByYWRpdXNBeGlzOiB7fSwKICBhbmdsZUF4aXM6IHt9Cn07CnZhciBwb2xhckF4aXNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicG9sYXJBeGlzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTYsCiAgcmVkdWNlcnM6IHsKICAgIGFkZFJhZGl1c0F4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5yYWRpdXNBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICB9LAogICAgcmVtb3ZlUmFkaXVzQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5yYWRpdXNBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgIH0sCiAgICBhZGRBbmdsZUF4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5hbmdsZUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVBbmdsZUF4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBkZWxldGUgc3RhdGUuYW5nbGVBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZFJhZGl1c0F4aXMsCiAgcmVtb3ZlUmFkaXVzQXhpcywKICBhZGRBbmdsZUF4aXMsCiAgcmVtb3ZlQW5nbGVBeGlzCn0gPSBwb2xhckF4aXNTbGljZS5hY3Rpb25zOwp2YXIgcG9sYXJBeGlzUmVkdWNlciA9IHBvbGFyQXhpc1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL1BpZS5qcwp2YXIgUmVhY3QyMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X2dldDQgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3BpZVNlbGVjdG9ycy5qcwpmdW5jdGlvbiBvd25LZXlzMjUoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyNShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI1KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyNihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyNShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyNihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyNih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyNih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyNih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHBpY2tJZCA9IChfc3RhdGUsIGlkKSA9PiBpZDsKdmFyIHNlbGVjdFN5bmNocm9uaXNlZFBpZVNldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFVuZmlsdGVyZWRQb2xhckl0ZW1zLCBwaWNrSWRdLCAoZ3JhcGhpY2FsSXRlbXMsIGlkKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gInBpZSIpLmZpbmQoKGl0ZW0pID0+IGl0ZW0uaWQgPT09IGlkKSk7CnZhciBlbXB0eUFycmF5ID0gW107CnZhciBwaWNrQ2VsbHMgPSAoX3N0YXRlLCBfaWQsIGNlbGxzKSA9PiB7CiAgaWYgKChjZWxscyA9PT0gbnVsbCB8fCBjZWxscyA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2VsbHMubGVuZ3RoKSA9PT0gMCkgewogICAgcmV0dXJuIGVtcHR5QXJyYXk7CiAgfQogIHJldHVybiBjZWxsczsKfTsKdmFyIHNlbGVjdERpc3BsYXllZERhdGEyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0RGF0YUFuZEFsd2F5c0lnbm9yZUluZGV4ZXMsIHNlbGVjdFN5bmNocm9uaXNlZFBpZVNldHRpbmdzLCBwaWNrQ2VsbHNdLCAoX3JlZjIsIHBpZVNldHRpbmdzLCBjZWxscykgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEKICB9ID0gX3JlZjI7CiAgaWYgKHBpZVNldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBkaXNwbGF5ZWREYXRhOwogIGlmICgocGllU2V0dGluZ3MgPT09IG51bGwgfHwgcGllU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBpZVNldHRpbmdzLmRhdGEpICE9IG51bGwgJiYgcGllU2V0dGluZ3MuZGF0YS5sZW5ndGggPiAwKSB7CiAgICBkaXNwbGF5ZWREYXRhID0gcGllU2V0dGluZ3MuZGF0YTsKICB9IGVsc2UgewogICAgZGlzcGxheWVkRGF0YSA9IGNoYXJ0RGF0YTsKICB9CiAgaWYgKCghZGlzcGxheWVkRGF0YSB8fCAhZGlzcGxheWVkRGF0YS5sZW5ndGgpICYmIGNlbGxzICE9IG51bGwpIHsKICAgIGRpc3BsYXllZERhdGEgPSBjZWxscy5tYXAoKGNlbGwpID0+IF9vYmplY3RTcHJlYWQyNShfb2JqZWN0U3ByZWFkMjUoe30sIHBpZVNldHRpbmdzLnByZXNlbnRhdGlvblByb3BzKSwgY2VsbC5wcm9wcykpOwogIH0KICBpZiAoZGlzcGxheWVkRGF0YSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZGlzcGxheWVkRGF0YTsKfSk7CnZhciBzZWxlY3RQaWVMZWdlbmQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YTIsIHNlbGVjdFN5bmNocm9uaXNlZFBpZVNldHRpbmdzLCBwaWNrQ2VsbHNdLCAoZGlzcGxheWVkRGF0YSwgcGllU2V0dGluZ3MsIGNlbGxzKSA9PiB7CiAgaWYgKGRpc3BsYXllZERhdGEgPT0gbnVsbCB8fCBwaWVTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZGlzcGxheWVkRGF0YS5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgX2NlbGxzJGk7CiAgICB2YXIgbmFtZSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBwaWVTZXR0aW5ncy5uYW1lS2V5LCBwaWVTZXR0aW5ncy5uYW1lKTsKICAgIHZhciBjb2xvcjI7CiAgICBpZiAoY2VsbHMgIT09IG51bGwgJiYgY2VsbHMgIT09IHZvaWQgMCAmJiAoX2NlbGxzJGkgPSBjZWxsc1tpXSkgIT09IG51bGwgJiYgX2NlbGxzJGkgIT09IHZvaWQgMCAmJiAoX2NlbGxzJGkgPSBfY2VsbHMkaS5wcm9wcykgIT09IG51bGwgJiYgX2NlbGxzJGkgIT09IHZvaWQgMCAmJiBfY2VsbHMkaS5maWxsKSB7CiAgICAgIGNvbG9yMiA9IGNlbGxzW2ldLnByb3BzLmZpbGw7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbnRyeSA9PT0gIm9iamVjdCIgJiYgZW50cnkgIT0gbnVsbCAmJiAiZmlsbCIgaW4gZW50cnkpIHsKICAgICAgY29sb3IyID0gZW50cnkuZmlsbDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbG9yMiA9IHBpZVNldHRpbmdzLmZpbGw7CiAgICB9CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWUsIHBpZVNldHRpbmdzLmRhdGFLZXkpLAogICAgICBjb2xvcjogY29sb3IyLAogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHdlIG5lZWQgYSBiZXR0ZXIgdHlwaW5nIGZvciBvdXIgZGF0YSBpbnB1dHMKICAgICAgcGF5bG9hZDogZW50cnksCiAgICAgIHR5cGU6IHBpZVNldHRpbmdzLmxlZ2VuZFR5cGUKICAgIH07CiAgfSk7Cn0pOwp2YXIgc2VsZWN0UGllU2VjdG9ycyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REaXNwbGF5ZWREYXRhMiwgc2VsZWN0U3luY2hyb25pc2VkUGllU2V0dGluZ3MsIHBpY2tDZWxscywgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIChkaXNwbGF5ZWREYXRhLCBwaWVTZXR0aW5ncywgY2VsbHMsIG9mZnNldCkgPT4gewogIGlmIChwaWVTZXR0aW5ncyA9PSBudWxsIHx8IGRpc3BsYXllZERhdGEgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGNvbXB1dGVQaWVTZWN0b3JzKHsKICAgIG9mZnNldCwKICAgIHBpZVNldHRpbmdzLAogICAgZGlzcGxheWVkRGF0YSwKICAgIGNlbGxzCiAgfSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1JlYWN0VXRpbHMuanMKdmFyIGltcG9ydF9nZXQzID0gX190b0VTTShyZXF1aXJlX2dldDIoKSk7CnZhciBpbXBvcnRfcmVhY3QyOCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdF9pcyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdF9pcygpKTsKdmFyIGdldERpc3BsYXlOYW1lID0gKENvbXApID0+IHsKICBpZiAodHlwZW9mIENvbXAgPT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gQ29tcDsKICB9CiAgaWYgKCFDb21wKSB7CiAgICByZXR1cm4gIiI7CiAgfQogIHJldHVybiBDb21wLmRpc3BsYXlOYW1lIHx8IENvbXAubmFtZSB8fCAiQ29tcG9uZW50IjsKfTsKdmFyIGxhc3RDaGlsZHJlbiA9IG51bGw7CnZhciBsYXN0UmVzdWx0ID0gbnVsbDsKdmFyIHRvQXJyYXkgPSAoY2hpbGRyZW4pID0+IHsKICBpZiAoY2hpbGRyZW4gPT09IGxhc3RDaGlsZHJlbiAmJiBBcnJheS5pc0FycmF5KGxhc3RSZXN1bHQpKSB7CiAgICByZXR1cm4gbGFzdFJlc3VsdDsKICB9CiAgdmFyIHJlc3VsdCA9IFtdOwogIGltcG9ydF9yZWFjdDI4LkNoaWxkcmVuLmZvckVhY2goY2hpbGRyZW4sIChjaGlsZCkgPT4gewogICAgaWYgKGlzTnVsbGlzaChjaGlsZCkpIHJldHVybjsKICAgIGlmICgoMCwgaW1wb3J0X3JlYWN0X2lzLmlzRnJhZ21lbnQpKGNoaWxkKSkgewogICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KHRvQXJyYXkoY2hpbGQucHJvcHMuY2hpbGRyZW4pKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5wdXNoKGNoaWxkKTsKICAgIH0KICB9KTsKICBsYXN0UmVzdWx0ID0gcmVzdWx0OwogIGxhc3RDaGlsZHJlbiA9IGNoaWxkcmVuOwogIHJldHVybiByZXN1bHQ7Cn07CmZ1bmN0aW9uIGZpbmRBbGxCeVR5cGUoY2hpbGRyZW4sIHR5cGUpIHsKICB2YXIgcmVzdWx0ID0gW107CiAgdmFyIHR5cGVzID0gW107CiAgaWYgKEFycmF5LmlzQXJyYXkodHlwZSkpIHsKICAgIHR5cGVzID0gdHlwZS5tYXAoKHQpID0+IGdldERpc3BsYXlOYW1lKHQpKTsKICB9IGVsc2UgewogICAgdHlwZXMgPSBbZ2V0RGlzcGxheU5hbWUodHlwZSldOwogIH0KICB0b0FycmF5KGNoaWxkcmVuKS5mb3JFYWNoKChjaGlsZCkgPT4gewogICAgdmFyIGNoaWxkVHlwZSA9ICgwLCBpbXBvcnRfZ2V0My5kZWZhdWx0KShjaGlsZCwgInR5cGUuZGlzcGxheU5hbWUiKSB8fCAoMCwgaW1wb3J0X2dldDMuZGVmYXVsdCkoY2hpbGQsICJ0eXBlLm5hbWUiKTsKICAgIGlmIChjaGlsZFR5cGUgJiYgdHlwZXMuaW5kZXhPZihjaGlsZFR5cGUpICE9PSAtMSkgewogICAgICByZXN1bHQucHVzaChjaGlsZCk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfQp2YXIgaXNDbGlwRG90ID0gKGRvdCkgPT4gewogIGlmIChkb3QgJiYgdHlwZW9mIGRvdCA9PT0gIm9iamVjdCIgJiYgImNsaXBEb3QiIGluIGRvdCkgewogICAgcmV0dXJuIEJvb2xlYW4oZG90LmNsaXBEb3QpOwogIH0KICByZXR1cm4gdHJ1ZTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9BY3RpdmVTaGFwZVV0aWxzLmpzCnZhciBSZWFjdDE5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfaXNQbGFpbk9iamVjdCA9IF9fdG9FU00ocmVxdWlyZV9pc1BsYWluT2JqZWN0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvVHJhcGV6b2lkLmpzCnZhciBSZWFjdDE4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIG93bktleXMyNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI2KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI3KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI3KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI3KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI3KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE1KCkgewogIHJldHVybiBfZXh0ZW5kczE1ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBnZXRUcmFwZXpvaWRQYXRoID0gKHgyLCB5MiwgdXBwZXJXaWR0aCwgbG93ZXJXaWR0aCwgaGVpZ2h0KSA9PiB7CiAgdmFyIHdpZHRoR2FwID0gdXBwZXJXaWR0aCAtIGxvd2VyV2lkdGg7CiAgdmFyIHBhdGgyOwogIHBhdGgyID0gIk0gIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyKTsKICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHVwcGVyV2lkdGgsICIsIikuY29uY2F0KHkyKTsKICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHVwcGVyV2lkdGggLSB3aWR0aEdhcCAvIDIsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0KTsKICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHVwcGVyV2lkdGggLSB3aWR0aEdhcCAvIDIgLSBsb3dlcldpZHRoLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCk7CiAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyLCAiIFoiKTsKICByZXR1cm4gcGF0aDI7Cn07CnZhciBkZWZhdWx0VHJhcGV6b2lkUHJvcHMgPSB7CiAgeDogMCwKICB5OiAwLAogIHVwcGVyV2lkdGg6IDAsCiAgbG93ZXJXaWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgaXNVcGRhdGVBbmltYXRpb25BY3RpdmU6IGZhbHNlLAogIGFuaW1hdGlvbkJlZ2luOiAwLAogIGFuaW1hdGlvbkR1cmF0aW9uOiAxNTAwLAogIGFuaW1hdGlvbkVhc2luZzogImVhc2UiCn07CnZhciBUcmFwZXpvaWQgPSAob3V0c2lkZVByb3BzKSA9PiB7CiAgdmFyIHRyYXBlem9pZFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRUcmFwZXpvaWRQcm9wcyk7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB1cHBlcldpZHRoLAogICAgbG93ZXJXaWR0aCwKICAgIGhlaWdodCwKICAgIGNsYXNzTmFtZQogIH0gPSB0cmFwZXpvaWRQcm9wczsKICB2YXIgewogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlCiAgfSA9IHRyYXBlem9pZFByb3BzOwogIHZhciBwYXRoUmVmID0gKDAsIGltcG9ydF9yZWFjdDI5LnVzZVJlZikobnVsbCk7CiAgdmFyIFt0b3RhbExlbmd0aCwgc2V0VG90YWxMZW5ndGhdID0gKDAsIGltcG9ydF9yZWFjdDI5LnVzZVN0YXRlKSgtMSk7CiAgdmFyIHByZXZVcHBlcldpZHRoUmVmID0gKDAsIGltcG9ydF9yZWFjdDI5LnVzZVJlZikodXBwZXJXaWR0aCk7CiAgdmFyIHByZXZMb3dlcldpZHRoUmVmID0gKDAsIGltcG9ydF9yZWFjdDI5LnVzZVJlZikobG93ZXJXaWR0aCk7CiAgdmFyIHByZXZIZWlnaHRSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MjkudXNlUmVmKShoZWlnaHQpOwogIHZhciBwcmV2WFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QyOS51c2VSZWYpKHgyKTsKICB2YXIgcHJldllSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MjkudXNlUmVmKSh5Mik7CiAgdmFyIGFuaW1hdGlvbklkID0gdXNlQW5pbWF0aW9uSWQob3V0c2lkZVByb3BzLCAidHJhcGV6b2lkLSIpOwogICgwLCBpbXBvcnRfcmVhY3QyOS51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChwYXRoUmVmLmN1cnJlbnQgJiYgcGF0aFJlZi5jdXJyZW50LmdldFRvdGFsTGVuZ3RoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHBhdGhUb3RhbExlbmd0aCA9IHBhdGhSZWYuY3VycmVudC5nZXRUb3RhbExlbmd0aCgpOwogICAgICAgIGlmIChwYXRoVG90YWxMZW5ndGgpIHsKICAgICAgICAgIHNldFRvdGFsTGVuZ3RoKHBhdGhUb3RhbExlbmd0aCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICAgIH0KICAgIH0KICB9LCBbXSk7CiAgaWYgKHgyICE9PSAreDIgfHwgeTIgIT09ICt5MiB8fCB1cHBlcldpZHRoICE9PSArdXBwZXJXaWR0aCB8fCBsb3dlcldpZHRoICE9PSArbG93ZXJXaWR0aCB8fCBoZWlnaHQgIT09ICtoZWlnaHQgfHwgdXBwZXJXaWR0aCA9PT0gMCAmJiBsb3dlcldpZHRoID09PSAwIHx8IGhlaWdodCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtdHJhcGV6b2lkIiwgY2xhc3NOYW1lKTsKICBpZiAoIWlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTguY3JlYXRlRWxlbWVudCgiZyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE4LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczE1KHt9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHRyYXBlem9pZFByb3BzKSwgewogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICAgIGQ6IGdldFRyYXBlem9pZFBhdGgoeDIsIHkyLCB1cHBlcldpZHRoLCBsb3dlcldpZHRoLCBoZWlnaHQpCiAgICB9KSkpOwogIH0KICB2YXIgcHJldlVwcGVyV2lkdGggPSBwcmV2VXBwZXJXaWR0aFJlZi5jdXJyZW50OwogIHZhciBwcmV2TG93ZXJXaWR0aCA9IHByZXZMb3dlcldpZHRoUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZIZWlnaHQgPSBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZYID0gcHJldlhSZWYuY3VycmVudDsKICB2YXIgcHJldlkgPSBwcmV2WVJlZi5jdXJyZW50OwogIHZhciBmcm9tMiA9ICIwcHggIi5jb25jYXQodG90YWxMZW5ndGggPT09IC0xID8gMSA6IHRvdGFsTGVuZ3RoLCAicHgiKTsKICB2YXIgdG8yID0gIiIuY29uY2F0KHRvdGFsTGVuZ3RoLCAicHggMHB4Iik7CiAgdmFyIHRyYW5zaXRpb24gPSBnZXRUcmFuc2l0aW9uVmFsKFsic3Ryb2tlRGFzaGFycmF5Il0sIGFuaW1hdGlvbkR1cmF0aW9uLCBhbmltYXRpb25FYXNpbmcpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOC5jcmVhdGVFbGVtZW50KEphdmFzY3JpcHRBbmltYXRlLCB7CiAgICBhbmltYXRpb25JZCwKICAgIGtleTogYW5pbWF0aW9uSWQsCiAgICBjYW5CZWdpbjogdG90YWxMZW5ndGggPiAwLAogICAgZHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uLAogICAgZWFzaW5nOiBhbmltYXRpb25FYXNpbmcsCiAgICBpc0FjdGl2ZTogaXNVcGRhdGVBbmltYXRpb25BY3RpdmUsCiAgICBiZWdpbjogYW5pbWF0aW9uQmVnaW4KICB9LCAodCkgPT4gewogICAgdmFyIGN1cnJVcHBlcldpZHRoID0gaW50ZXJwb2xhdGUocHJldlVwcGVyV2lkdGgsIHVwcGVyV2lkdGgsIHQpOwogICAgdmFyIGN1cnJMb3dlcldpZHRoID0gaW50ZXJwb2xhdGUocHJldkxvd2VyV2lkdGgsIGxvd2VyV2lkdGgsIHQpOwogICAgdmFyIGN1cnJIZWlnaHQgPSBpbnRlcnBvbGF0ZShwcmV2SGVpZ2h0LCBoZWlnaHQsIHQpOwogICAgdmFyIGN1cnJYID0gaW50ZXJwb2xhdGUocHJldlgsIHgyLCB0KTsKICAgIHZhciBjdXJyWSA9IGludGVycG9sYXRlKHByZXZZLCB5MiwgdCk7CiAgICBpZiAocGF0aFJlZi5jdXJyZW50KSB7CiAgICAgIHByZXZVcHBlcldpZHRoUmVmLmN1cnJlbnQgPSBjdXJyVXBwZXJXaWR0aDsKICAgICAgcHJldkxvd2VyV2lkdGhSZWYuY3VycmVudCA9IGN1cnJMb3dlcldpZHRoOwogICAgICBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQgPSBjdXJySGVpZ2h0OwogICAgICBwcmV2WFJlZi5jdXJyZW50ID0gY3Vyclg7CiAgICAgIHByZXZZUmVmLmN1cnJlbnQgPSBjdXJyWTsKICAgIH0KICAgIHZhciBhbmltYXRpb25TdHlsZSA9IHQgPiAwID8gewogICAgICB0cmFuc2l0aW9uLAogICAgICBzdHJva2VEYXNoYXJyYXk6IHRvMgogICAgfSA6IHsKICAgICAgc3Ryb2tlRGFzaGFycmF5OiBmcm9tMgogICAgfTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOC5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHMxNSh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyh0cmFwZXpvaWRQcm9wcyksIHsKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgICBkOiBnZXRUcmFwZXpvaWRQYXRoKGN1cnJYLCBjdXJyWSwgY3VyclVwcGVyV2lkdGgsIGN1cnJMb3dlcldpZHRoLCBjdXJySGVpZ2h0KSwKICAgICAgcmVmOiBwYXRoUmVmLAogICAgICBzdHlsZTogX29iamVjdFNwcmVhZDI2KF9vYmplY3RTcHJlYWQyNih7fSwgYW5pbWF0aW9uU3R5bGUpLCB0cmFwZXpvaWRQcm9wcy5zdHlsZSkKICAgIH0pKTsKICB9KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9BY3RpdmVTaGFwZVV0aWxzLmpzCnZhciBfZXhjbHVkZWQxMCA9IFsib3B0aW9uIiwgInNoYXBlVHlwZSIsICJwcm9wVHJhbnNmb3JtZXIiLCAiYWN0aXZlQ2xhc3NOYW1lIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczEwKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTAocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIG93bktleXMyNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI4KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyOChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI4KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI4KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI4KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBkZWZhdWx0UHJvcFRyYW5zZm9ybWVyKG9wdGlvbiwgcHJvcHMpIHsKICByZXR1cm4gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgcHJvcHMpLCBvcHRpb24pOwp9CmZ1bmN0aW9uIGlzU3ltYm9sc1Byb3BzKHNoYXBlVHlwZSwgX2VsZW1lbnRQcm9wcykgewogIHJldHVybiBzaGFwZVR5cGUgPT09ICJzeW1ib2xzIjsKfQpmdW5jdGlvbiBTaGFwZVNlbGVjdG9yKF9yZWYyKSB7CiAgdmFyIHsKICAgIHNoYXBlVHlwZSwKICAgIGVsZW1lbnRQcm9wcwogIH0gPSBfcmVmMjsKICBzd2l0Y2ggKHNoYXBlVHlwZSkgewogICAgY2FzZSAicmVjdGFuZ2xlIjoKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoUmVjdGFuZ2xlLCBlbGVtZW50UHJvcHMpOwogICAgY2FzZSAidHJhcGV6b2lkIjoKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoVHJhcGV6b2lkLCBlbGVtZW50UHJvcHMpOwogICAgY2FzZSAic2VjdG9yIjoKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoU2VjdG9yLCBlbGVtZW50UHJvcHMpOwogICAgY2FzZSAic3ltYm9scyI6CiAgICAgIGlmIChpc1N5bWJvbHNQcm9wcyhzaGFwZVR5cGUsIGVsZW1lbnRQcm9wcykpIHsKICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChTeW1ib2xzLCBlbGVtZW50UHJvcHMpOwogICAgICB9CiAgICAgIGJyZWFrOwogICAgY2FzZSAiY3VydmUiOgogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChDdXJ2ZSwgZWxlbWVudFByb3BzKTsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBudWxsOwogIH0KfQpmdW5jdGlvbiBnZXRQcm9wc0Zyb21TaGFwZU9wdGlvbihvcHRpb24pIHsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMC5pc1ZhbGlkRWxlbWVudCkob3B0aW9uKSkgewogICAgcmV0dXJuIG9wdGlvbi5wcm9wczsKICB9CiAgcmV0dXJuIG9wdGlvbjsKfQpmdW5jdGlvbiBTaGFwZShfcmVmMikgewogIHZhciB7CiAgICBvcHRpb24sCiAgICBzaGFwZVR5cGUsCiAgICBwcm9wVHJhbnNmb3JtZXIgPSBkZWZhdWx0UHJvcFRyYW5zZm9ybWVyLAogICAgYWN0aXZlQ2xhc3NOYW1lID0gInJlY2hhcnRzLWFjdGl2ZS1zaGFwZSIKICB9ID0gX3JlZjIsIHByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTAoX3JlZjIsIF9leGNsdWRlZDEwKTsKICB2YXIgc2hhcGU7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzAuaXNWYWxpZEVsZW1lbnQpKG9wdGlvbikpIHsKICAgIHNoYXBlID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMC5jbG9uZUVsZW1lbnQpKG9wdGlvbiwgX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgcHJvcHMpLCBnZXRQcm9wc0Zyb21TaGFwZU9wdGlvbihvcHRpb24pKSk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICBzaGFwZSA9IG9wdGlvbihwcm9wcywgcHJvcHMuaW5kZXgpOwogIH0gZWxzZSBpZiAoKDAsIGltcG9ydF9pc1BsYWluT2JqZWN0LmRlZmF1bHQpKG9wdGlvbikgJiYgdHlwZW9mIG9wdGlvbiAhPT0gImJvb2xlYW4iKSB7CiAgICB2YXIgbmV4dFByb3BzID0gcHJvcFRyYW5zZm9ybWVyKG9wdGlvbiwgcHJvcHMpOwogICAgc2hhcGUgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KFNoYXBlU2VsZWN0b3IsIHsKICAgICAgc2hhcGVUeXBlLAogICAgICBlbGVtZW50UHJvcHM6IG5leHRQcm9wcwogICAgfSk7CiAgfSBlbHNlIHsKICAgIHZhciBlbGVtZW50UHJvcHMgPSBwcm9wczsKICAgIHNoYXBlID0gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChTaGFwZVNlbGVjdG9yLCB7CiAgICAgIHNoYXBlVHlwZSwKICAgICAgZWxlbWVudFByb3BzCiAgICB9KTsKICB9CiAgaWYgKHByb3BzLmlzQWN0aXZlKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgICBjbGFzc05hbWU6IGFjdGl2ZUNsYXNzTmFtZQogICAgfSwgc2hhcGUpOwogIH0KICByZXR1cm4gc2hhcGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC90b29sdGlwQ29udGV4dC5qcwp2YXIgdXNlTW91c2VFbnRlckl0ZW1EaXNwYXRjaCA9IChvbk1vdXNlRW50ZXJGcm9tUHJvcHMsIGRhdGFLZXksIGdyYXBoaWNhbEl0ZW1JZCkgPT4gewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgcmV0dXJuIChkYXRhLCBpbmRleCkgPT4gKGV2ZW50KSA9PiB7CiAgICBvbk1vdXNlRW50ZXJGcm9tUHJvcHMgPT09IG51bGwgfHwgb25Nb3VzZUVudGVyRnJvbVByb3BzID09PSB2b2lkIDAgfHwgb25Nb3VzZUVudGVyRnJvbVByb3BzKGRhdGEsIGluZGV4LCBldmVudCk7CiAgICBkaXNwYXRjaChzZXRBY3RpdmVNb3VzZU92ZXJJdGVtSW5kZXgoewogICAgICBhY3RpdmVJbmRleDogU3RyaW5nKGluZGV4KSwKICAgICAgYWN0aXZlRGF0YUtleTogZGF0YUtleSwKICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogZGF0YS50b29sdGlwUG9zaXRpb24sCiAgICAgIGFjdGl2ZUdyYXBoaWNhbEl0ZW1JZDogZ3JhcGhpY2FsSXRlbUlkCiAgICB9KSk7CiAgfTsKfTsKdmFyIHVzZU1vdXNlTGVhdmVJdGVtRGlzcGF0Y2ggPSAob25Nb3VzZUxlYXZlRnJvbVByb3BzKSA9PiB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICByZXR1cm4gKGRhdGEsIGluZGV4KSA9PiAoZXZlbnQpID0+IHsKICAgIG9uTW91c2VMZWF2ZUZyb21Qcm9wcyA9PT0gbnVsbCB8fCBvbk1vdXNlTGVhdmVGcm9tUHJvcHMgPT09IHZvaWQgMCB8fCBvbk1vdXNlTGVhdmVGcm9tUHJvcHMoZGF0YSwgaW5kZXgsIGV2ZW50KTsKICAgIGRpc3BhdGNoKG1vdXNlTGVhdmVJdGVtKCkpOwogIH07Cn07CnZhciB1c2VNb3VzZUNsaWNrSXRlbURpc3BhdGNoID0gKG9uTW91c2VDbGlja0Zyb21Qcm9wcywgZGF0YUtleSwgZ3JhcGhpY2FsSXRlbUlkKSA9PiB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICByZXR1cm4gKGRhdGEsIGluZGV4KSA9PiAoZXZlbnQpID0+IHsKICAgIG9uTW91c2VDbGlja0Zyb21Qcm9wcyA9PT0gbnVsbCB8fCBvbk1vdXNlQ2xpY2tGcm9tUHJvcHMgPT09IHZvaWQgMCB8fCBvbk1vdXNlQ2xpY2tGcm9tUHJvcHMoZGF0YSwgaW5kZXgsIGV2ZW50KTsKICAgIGRpc3BhdGNoKHNldEFjdGl2ZUNsaWNrSXRlbUluZGV4KHsKICAgICAgYWN0aXZlSW5kZXg6IFN0cmluZyhpbmRleCksCiAgICAgIGFjdGl2ZURhdGFLZXk6IGRhdGFLZXksCiAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGRhdGEudG9vbHRpcFBvc2l0aW9uLAogICAgICBhY3RpdmVHcmFwaGljYWxJdGVtSWQ6IGdyYXBoaWNhbEl0ZW1JZAogICAgfSkpOwogIH07Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldFRvb2x0aXBFbnRyeVNldHRpbmdzLmpzCnZhciBpbXBvcnRfcmVhY3QzMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MoX3JlZjIpIHsKICB2YXIgewogICAgdG9vbHRpcEVudHJ5U2V0dGluZ3MKICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDMxLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDMxLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFRvb2x0aXBFbnRyeVNldHRpbmdzKHRvb2x0aXBFbnRyeVNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSB0b29sdGlwRW50cnlTZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlVG9vbHRpcEVudHJ5U2V0dGluZ3MoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHRvb2x0aXBFbnRyeVNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gdG9vbHRpcEVudHJ5U2V0dGluZ3M7CiAgfSwgW3Rvb2x0aXBFbnRyeVNldHRpbmdzLCBkaXNwYXRjaCwgaXNQYW5vcmFtYV0pOwogICgwLCBpbXBvcnRfcmVhY3QzMS51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVRvb2x0aXBFbnRyeVNldHRpbmdzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldExlZ2VuZFBheWxvYWQuanMKdmFyIGltcG9ydF9yZWFjdDMyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBTZXRMZWdlbmRQYXlsb2FkKF9yZWYyKSB7CiAgdmFyIHsKICAgIGxlZ2VuZFBheWxvYWQKICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcHJldlBheWxvYWRSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzIudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzIudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCA9PT0gbnVsbCkgewogICAgICBkaXNwYXRjaChhZGRMZWdlbmRQYXlsb2FkKGxlZ2VuZFBheWxvYWQpKTsKICAgIH0gZWxzZSBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCAhPT0gbGVnZW5kUGF5bG9hZCkgewogICAgICBkaXNwYXRjaChyZXBsYWNlTGVnZW5kUGF5bG9hZCh7CiAgICAgICAgcHJldjogcHJldlBheWxvYWRSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiBsZWdlbmRQYXlsb2FkCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPSBsZWdlbmRQYXlsb2FkOwogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgbGVnZW5kUGF5bG9hZF0pOwogICgwLCBpbXBvcnRfcmVhY3QzMi51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2UGF5bG9hZFJlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlTGVnZW5kUGF5bG9hZChwcmV2UGF5bG9hZFJlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlBheWxvYWRSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gU2V0UG9sYXJMZWdlbmRQYXlsb2FkKF9yZWYyKSB7CiAgdmFyIHsKICAgIGxlZ2VuZFBheWxvYWQKICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgbGF5b3V0ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRMYXlvdXQpOwogIHZhciBwcmV2UGF5bG9hZFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QzMi51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QzMi51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGlmIChsYXlvdXQgIT09ICJjZW50cmljIiAmJiBsYXlvdXQgIT09ICJyYWRpYWwiKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwcmV2UGF5bG9hZFJlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZExlZ2VuZFBheWxvYWQobGVnZW5kUGF5bG9hZCkpOwogICAgfSBlbHNlIGlmIChwcmV2UGF5bG9hZFJlZi5jdXJyZW50ICE9PSBsZWdlbmRQYXlsb2FkKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VMZWdlbmRQYXlsb2FkKHsKICAgICAgICBwcmV2OiBwcmV2UGF5bG9hZFJlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IGxlZ2VuZFBheWxvYWQKICAgICAgfSkpOwogICAgfQogICAgcHJldlBheWxvYWRSZWYuY3VycmVudCA9IGxlZ2VuZFBheWxvYWQ7CiAgfSwgW2Rpc3BhdGNoLCBsYXlvdXQsIGxlZ2VuZFBheWxvYWRdKTsKICAoMCwgaW1wb3J0X3JlYWN0MzIudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZUxlZ2VuZFBheWxvYWQocHJldlBheWxvYWRSZWYuY3VycmVudCkpOwogICAgICAgIHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQuanMKdmFyIFJlYWN0MjEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VJZC5qcwp2YXIgUmVhY3QyMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9yZWY7CnZhciB1c2VJZEZhbGxiYWNrID0gKCkgPT4gewogIHZhciBbaWRdID0gUmVhY3QyMC51c2VTdGF0ZSgoKSA9PiB1bmlxdWVJZCgidWlkLSIpKTsKICByZXR1cm4gaWQ7Cn07CnZhciB1c2VJZCA9IChfcmVmID0gUmVhY3QyMFsidXNlSWQiLnRvU3RyaW5nKCldKSAhPT0gbnVsbCAmJiBfcmVmICE9PSB2b2lkIDAgPyBfcmVmIDogdXNlSWRGYWxsYmFjazsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VVbmlxdWVJZC5qcwpmdW5jdGlvbiB1c2VVbmlxdWVJZChwcmVmaXgsIGN1c3RvbUlkKSB7CiAgdmFyIGdlbmVyYXRlZElkID0gdXNlSWQoKTsKICBpZiAoY3VzdG9tSWQpIHsKICAgIHJldHVybiBjdXN0b21JZDsKICB9CiAgcmV0dXJuIHByZWZpeCA/ICIiLmNvbmNhdChwcmVmaXgsICItIikuY29uY2F0KGdlbmVyYXRlZElkKSA6IGdlbmVyYXRlZElkOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQuanMKdmFyIEdyYXBoaWNhbEl0ZW1JZENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMzLmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBSZWdpc3RlckdyYXBoaWNhbEl0ZW1JZCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBpZCwKICAgIHR5cGUsCiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgcmVzb2x2ZWRJZCA9IHVzZVVuaXF1ZUlkKCJyZWNoYXJ0cy0iLmNvbmNhdCh0eXBlKSwgaWQpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMS5jcmVhdGVFbGVtZW50KEdyYXBoaWNhbEl0ZW1JZENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiByZXNvbHZlZElkCiAgfSwgY2hpbGRyZW4ocmVzb2x2ZWRJZCkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9TZXRHcmFwaGljYWxJdGVtLmpzCnZhciBpbXBvcnRfcmVhY3QzNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvZ3JhcGhpY2FsSXRlbXNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlNyA9IHsKICBjYXJ0ZXNpYW5JdGVtczogW10sCiAgcG9sYXJJdGVtczogW10KfTsKdmFyIGdyYXBoaWNhbEl0ZW1zU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImdyYXBoaWNhbEl0ZW1zIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTcsCiAgcmVkdWNlcnM6IHsKICAgIGFkZENhcnRlc2lhbkdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUuY2FydGVzaWFuSXRlbXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuY2FydGVzaWFuSXRlbXMuaW5kZXhPZihjYXN0RHJhZnQocHJldikpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtc1tpbmRleF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuY2FydGVzaWFuSXRlbXMuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUuY2FydGVzaWFuSXRlbXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgYWRkUG9sYXJHcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnBvbGFySXRlbXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVQb2xhckdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkucG9sYXJJdGVtcy5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5wb2xhckl0ZW1zLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbSwKICByZXBsYWNlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbSwKICByZW1vdmVDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIGFkZFBvbGFyR3JhcGhpY2FsSXRlbSwKICByZW1vdmVQb2xhckdyYXBoaWNhbEl0ZW0KfSA9IGdyYXBoaWNhbEl0ZW1zU2xpY2UuYWN0aW9uczsKdmFyIGdyYXBoaWNhbEl0ZW1zUmVkdWNlciA9IGdyYXBoaWNhbEl0ZW1zU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0R3JhcGhpY2FsSXRlbS5qcwp2YXIgU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbUltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2UHJvcHNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzQudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzQudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlByb3BzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbShwcm9wcykpOwogICAgfSBlbHNlIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCAhPT0gcHJvcHMpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0oewogICAgICAgIHByZXY6IHByZXZQcm9wc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHByb3BzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZQcm9wc1JlZi5jdXJyZW50ID0gcHJvcHM7CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogICgwLCBpbXBvcnRfcmVhY3QzNC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0ocHJldlByb3BzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2UHJvcHNSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn07CnZhciBTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNC5tZW1vKShTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtSW1wbCk7CmZ1bmN0aW9uIFNldFBvbGFyR3JhcGhpY2FsSXRlbShwcm9wcykgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDM0LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2goYWRkUG9sYXJHcmFwaGljYWxJdGVtKHByb3BzKSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaChyZW1vdmVQb2xhckdyYXBoaWNhbEl0ZW0ocHJvcHMpKTsKICAgIH07CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL1BpZS5qcwp2YXIgX2V4Y2x1ZGVkMTEgPSBbImtleSJdOwp2YXIgX2V4Y2x1ZGVkMjUgPSBbIm9uTW91c2VFbnRlciIsICJvbkNsaWNrIiwgIm9uTW91c2VMZWF2ZSJdOwp2YXIgX2V4Y2x1ZGVkMzIgPSBbImlkIl07CnZhciBfZXhjbHVkZWQ0MiA9IFsiaWQiXTsKZnVuY3Rpb24gb3duS2V5czI4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjgoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyOChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjgoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjkodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTYoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTYgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE2LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTExKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gU2V0UGllUGF5bG9hZExlZ2VuZChwcm9wcykgewogIHZhciBjZWxscyA9ICgwLCBpbXBvcnRfcmVhY3QzNS51c2VNZW1vKSgoKSA9PiBmaW5kQWxsQnlUeXBlKHByb3BzLmNoaWxkcmVuLCBDZWxsKSwgW3Byb3BzLmNoaWxkcmVuXSk7CiAgdmFyIGxlZ2VuZFBheWxvYWQgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFBpZUxlZ2VuZChzdGF0ZSwgcHJvcHMuaWQsIGNlbGxzKSk7CiAgaWYgKGxlZ2VuZFBheWxvYWQgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KFNldFBvbGFyTGVnZW5kUGF5bG9hZCwgewogICAgbGVnZW5kUGF5bG9hZAogIH0pOwp9CnZhciBTZXRQaWVUb29sdGlwRW50cnlTZXR0aW5ncyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLm1lbW8oKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBuYW1lS2V5LAogICAgc2VjdG9ycywKICAgIHN0cm9rZSwKICAgIHN0cm9rZVdpZHRoLAogICAgZmlsbCwKICAgIG5hbWUsCiAgICBoaWRlLAogICAgdG9vbHRpcFR5cGUKICB9ID0gX3JlZjI7CiAgdmFyIHRvb2x0aXBFbnRyeVNldHRpbmdzID0gewogICAgZGF0YURlZmluZWRPbkl0ZW06IHNlY3RvcnMubWFwKChwKSA9PiBwLnRvb2x0aXBQYXlsb2FkKSwKICAgIHBvc2l0aW9uczogc2VjdG9ycy5tYXAoKHApID0+IHAudG9vbHRpcFBvc2l0aW9uKSwKICAgIHNldHRpbmdzOiB7CiAgICAgIHN0cm9rZSwKICAgICAgc3Ryb2tlV2lkdGgsCiAgICAgIGZpbGwsCiAgICAgIGRhdGFLZXksCiAgICAgIG5hbWVLZXksCiAgICAgIG5hbWU6IGdldFRvb2x0aXBOYW1lUHJvcChuYW1lLCBkYXRhS2V5KSwKICAgICAgaGlkZSwKICAgICAgdHlwZTogdG9vbHRpcFR5cGUsCiAgICAgIGNvbG9yOiBmaWxsLAogICAgICB1bml0OiAiIgogICAgICAvLyB3aHkgZG9lc24ndCBQaWUgc3VwcG9ydCB1bml0PwogICAgfQogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MsIHsKICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzCiAgfSk7Cn0pOwp2YXIgZ2V0VGV4dEFuY2hvciA9ICh4MiwgY3gpID0+IHsKICBpZiAoeDIgPiBjeCkgewogICAgcmV0dXJuICJzdGFydCI7CiAgfQogIGlmICh4MiA8IGN4KSB7CiAgICByZXR1cm4gImVuZCI7CiAgfQogIHJldHVybiAibWlkZGxlIjsKfTsKdmFyIGdldE91dGVyUmFkaXVzID0gKGRhdGFQb2ludCwgb3V0ZXJSYWRpdXMsIG1heFBpZVJhZGl1cykgPT4gewogIGlmICh0eXBlb2Ygb3V0ZXJSYWRpdXMgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBnZXRQZXJjZW50VmFsdWUob3V0ZXJSYWRpdXMoZGF0YVBvaW50KSwgbWF4UGllUmFkaXVzLCBtYXhQaWVSYWRpdXMgKiAwLjgpOwogIH0KICByZXR1cm4gZ2V0UGVyY2VudFZhbHVlKG91dGVyUmFkaXVzLCBtYXhQaWVSYWRpdXMsIG1heFBpZVJhZGl1cyAqIDAuOCk7Cn07CnZhciBwYXJzZUNvb3JkaW5hdGVPZlBpZSA9IChwaWVTZXR0aW5ncywgb2Zmc2V0LCBkYXRhUG9pbnQpID0+IHsKICB2YXIgewogICAgdG9wLAogICAgbGVmdCwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IG9mZnNldDsKICB2YXIgbWF4UGllUmFkaXVzID0gZ2V0TWF4UmFkaXVzKHdpZHRoLCBoZWlnaHQpOwogIHZhciBjeCA9IGxlZnQgKyBnZXRQZXJjZW50VmFsdWUocGllU2V0dGluZ3MuY3gsIHdpZHRoLCB3aWR0aCAvIDIpOwogIHZhciBjeSA9IHRvcCArIGdldFBlcmNlbnRWYWx1ZShwaWVTZXR0aW5ncy5jeSwgaGVpZ2h0LCBoZWlnaHQgLyAyKTsKICB2YXIgaW5uZXJSYWRpdXMgPSBnZXRQZXJjZW50VmFsdWUocGllU2V0dGluZ3MuaW5uZXJSYWRpdXMsIG1heFBpZVJhZGl1cywgMCk7CiAgdmFyIG91dGVyUmFkaXVzID0gZ2V0T3V0ZXJSYWRpdXMoZGF0YVBvaW50LCBwaWVTZXR0aW5ncy5vdXRlclJhZGl1cywgbWF4UGllUmFkaXVzKTsKICB2YXIgbWF4UmFkaXVzID0gcGllU2V0dGluZ3MubWF4UmFkaXVzIHx8IE1hdGguc3FydCh3aWR0aCAqIHdpZHRoICsgaGVpZ2h0ICogaGVpZ2h0KSAvIDI7CiAgcmV0dXJuIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgbWF4UmFkaXVzCiAgfTsKfTsKdmFyIHBhcnNlRGVsdGFBbmdsZSA9IChzdGFydEFuZ2xlLCBlbmRBbmdsZSkgPT4gewogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBNYXRoLm1pbihNYXRoLmFicyhlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpLCAzNjApOwogIHJldHVybiBzaWduMiAqIGRlbHRhQW5nbGU7Cn07CmZ1bmN0aW9uIGdldENsYXNzTmFtZVByb3BlcnR5SWZFeGlzdHModSkgewogIGlmICh1ICYmIHR5cGVvZiB1ID09PSAib2JqZWN0IiAmJiAiY2xhc3NOYW1lIiBpbiB1ICYmIHR5cGVvZiB1LmNsYXNzTmFtZSA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB1LmNsYXNzTmFtZTsKICB9CiAgcmV0dXJuICIiOwp9CnZhciByZW5kZXJMYWJlbExpbmVJdGVtID0gKG9wdGlvbiwgcHJvcHMpID0+IHsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjIuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNsb25lRWxlbWVudChvcHRpb24sIHByb3BzKTsKICB9CiAgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBvcHRpb24ocHJvcHMpOwogIH0KICB2YXIgY2xhc3NOYW1lID0gY2xzeCgicmVjaGFydHMtcGllLWxhYmVsLWxpbmUiLCB0eXBlb2Ygb3B0aW9uICE9PSAiYm9vbGVhbiIgPyBvcHRpb24uY2xhc3NOYW1lIDogIiIpOwogIHZhciB7CiAgICBrZXkKICB9ID0gcHJvcHMsIG90aGVyUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShwcm9wcywgX2V4Y2x1ZGVkMTEpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KEN1cnZlLCBfZXh0ZW5kczE2KHt9LCBvdGhlclByb3BzLCB7CiAgICB0eXBlOiAibGluZWFyIiwKICAgIGNsYXNzTmFtZQogIH0pKTsKfTsKdmFyIHJlbmRlckxhYmVsSXRlbSA9IChvcHRpb24sIHByb3BzLCB2YWx1ZSkgPT4gewogIGlmICgvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5pc1ZhbGlkRWxlbWVudChvcHRpb24pKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY2xvbmVFbGVtZW50KG9wdGlvbiwgcHJvcHMpOwogIH0KICB2YXIgbGFiZWwgPSB2YWx1ZTsKICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgbGFiZWwgPSBvcHRpb24ocHJvcHMpOwogICAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmlzVmFsaWRFbGVtZW50KGxhYmVsKSkgewogICAgICByZXR1cm4gbGFiZWw7CiAgICB9CiAgfQogIHZhciBjbGFzc05hbWUgPSBjbHN4KCJyZWNoYXJ0cy1waWUtbGFiZWwtdGV4dCIsIGdldENsYXNzTmFtZVByb3BlcnR5SWZFeGlzdHMob3B0aW9uKSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoVGV4dCwgX2V4dGVuZHMxNih7fSwgcHJvcHMsIHsKICAgIGFsaWdubWVudEJhc2VsaW5lOiAibWlkZGxlIiwKICAgIGNsYXNzTmFtZQogIH0pLCBsYWJlbCk7Cn07CmZ1bmN0aW9uIFBpZUxhYmVscyhfcmVmMikgewogIHZhciB7CiAgICBzZWN0b3JzLAogICAgcHJvcHMsCiAgICBzaG93TGFiZWxzCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBsYWJlbCwKICAgIGxhYmVsTGluZSwKICAgIGRhdGFLZXkKICB9ID0gcHJvcHM7CiAgaWYgKCFzaG93TGFiZWxzIHx8ICFsYWJlbCB8fCAhc2VjdG9ycykgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBwaWVQcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wcyk7CiAgdmFyIGN1c3RvbUxhYmVsUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihsYWJlbCk7CiAgdmFyIGN1c3RvbUxhYmVsTGluZVByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24obGFiZWxMaW5lKTsKICB2YXIgb2Zmc2V0UmFkaXVzID0gdHlwZW9mIGxhYmVsID09PSAib2JqZWN0IiAmJiAib2Zmc2V0UmFkaXVzIiBpbiBsYWJlbCAmJiB0eXBlb2YgbGFiZWwub2Zmc2V0UmFkaXVzID09PSAibnVtYmVyIiAmJiBsYWJlbC5vZmZzZXRSYWRpdXMgfHwgMjA7CiAgdmFyIGxhYmVscyA9IHNlY3RvcnMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIG1pZEFuZ2xlID0gKGVudHJ5LnN0YXJ0QW5nbGUgKyBlbnRyeS5lbmRBbmdsZSkgLyAyOwogICAgdmFyIGVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihlbnRyeS5jeCwgZW50cnkuY3ksIGVudHJ5Lm91dGVyUmFkaXVzICsgb2Zmc2V0UmFkaXVzLCBtaWRBbmdsZSk7CiAgICB2YXIgbGFiZWxQcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgcGllUHJvcHMpLCBlbnRyeSksIHt9LCB7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgY3VzdG9tTGFiZWxQcm9wcyBpcyBjb250cmlidXRpbmcgdW5rbm93biBwcm9wcwogICAgICBzdHJva2U6ICJub25lIgogICAgfSwgY3VzdG9tTGFiZWxQcm9wcyksIHt9LCB7CiAgICAgIGluZGV4OiBpLAogICAgICB0ZXh0QW5jaG9yOiBnZXRUZXh0QW5jaG9yKGVuZFBvaW50LngsIGVudHJ5LmN4KQogICAgfSwgZW5kUG9pbnQpOwogICAgdmFyIGxpbmVQcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgcGllUHJvcHMpLCBlbnRyeSksIHt9LCB7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgY3VzdG9tTGFiZWxMaW5lUHJvcHMgaXMgY29udHJpYnV0aW5nIHVua25vd24gcHJvcHMKICAgICAgZmlsbDogIm5vbmUiLAogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGN1c3RvbUxhYmVsTGluZVByb3BzIGlzIGNvbnRyaWJ1dGluZyB1bmtub3duIHByb3BzCiAgICAgIHN0cm9rZTogZW50cnkuZmlsbAogICAgfSwgY3VzdG9tTGFiZWxMaW5lUHJvcHMpLCB7fSwgewogICAgICBpbmRleDogaSwKICAgICAgcG9pbnRzOiBbcG9sYXJUb0NhcnRlc2lhbihlbnRyeS5jeCwgZW50cnkuY3ksIGVudHJ5Lm91dGVyUmFkaXVzLCBtaWRBbmdsZSksIGVuZFBvaW50XSwKICAgICAga2V5OiAibGluZSIKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgICAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMubGFiZWwsCiAgICAgIGtleTogImxhYmVsLSIuY29uY2F0KGVudHJ5LnN0YXJ0QW5nbGUsICItIikuY29uY2F0KGVudHJ5LmVuZEFuZ2xlLCAiLSIpLmNvbmNhdChlbnRyeS5taWRBbmdsZSwgIi0iKS5jb25jYXQoaSkKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIG51bGwsIGxhYmVsTGluZSAmJiByZW5kZXJMYWJlbExpbmVJdGVtKGxhYmVsTGluZSwgbGluZVByb3BzKSwgcmVuZGVyTGFiZWxJdGVtKGxhYmVsLCBsYWJlbFByb3BzLCBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSkpKSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXBpZS1sYWJlbHMiCiAgfSwgbGFiZWxzKTsKfQpmdW5jdGlvbiBQaWVMYWJlbExpc3QoX3JlZjMpIHsKICB2YXIgewogICAgc2VjdG9ycywKICAgIHByb3BzLAogICAgc2hvd0xhYmVscwogIH0gPSBfcmVmMzsKICB2YXIgewogICAgbGFiZWwKICB9ID0gcHJvcHM7CiAgaWYgKHR5cGVvZiBsYWJlbCA9PT0gIm9iamVjdCIgJiYgbGFiZWwgIT0gbnVsbCAmJiAicG9zaXRpb24iIGluIGxhYmVsKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY3JlYXRlRWxlbWVudChMYWJlbExpc3RGcm9tTGFiZWxQcm9wLCB7CiAgICAgIGxhYmVsCiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoUGllTGFiZWxzLCB7CiAgICBzZWN0b3JzLAogICAgcHJvcHMsCiAgICBzaG93TGFiZWxzCiAgfSk7Cn0KZnVuY3Rpb24gUGllU2VjdG9ycyhwcm9wcykgewogIHZhciB7CiAgICBzZWN0b3JzLAogICAgYWN0aXZlU2hhcGUsCiAgICBpbmFjdGl2ZVNoYXBlOiBpbmFjdGl2ZVNoYXBlUHJvcCwKICAgIGFsbE90aGVyUGllUHJvcHMsCiAgICBzaGFwZSwKICAgIGlkCiAgfSA9IHByb3BzOwogIHZhciBhY3RpdmVJbmRleCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCk7CiAgdmFyIGFjdGl2ZURhdGFLZXkgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RBY3RpdmVUb29sdGlwRGF0YUtleSk7CiAgdmFyIGFjdGl2ZUdyYXBoaWNhbEl0ZW1JZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFjdGl2ZVRvb2x0aXBHcmFwaGljYWxJdGVtSWQpOwogIHZhciB7CiAgICBvbk1vdXNlRW50ZXI6IG9uTW91c2VFbnRlckZyb21Qcm9wcywKICAgIG9uQ2xpY2s6IG9uSXRlbUNsaWNrRnJvbVByb3BzLAogICAgb25Nb3VzZUxlYXZlOiBvbk1vdXNlTGVhdmVGcm9tUHJvcHMKICB9ID0gYWxsT3RoZXJQaWVQcm9wcywgcmVzdE9mQWxsT3RoZXJQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGFsbE90aGVyUGllUHJvcHMsIF9leGNsdWRlZDI1KTsKICB2YXIgb25Nb3VzZUVudGVyRnJvbUNvbnRleHQgPSB1c2VNb3VzZUVudGVySXRlbURpc3BhdGNoKG9uTW91c2VFbnRlckZyb21Qcm9wcywgYWxsT3RoZXJQaWVQcm9wcy5kYXRhS2V5LCBpZCk7CiAgdmFyIG9uTW91c2VMZWF2ZUZyb21Db250ZXh0ID0gdXNlTW91c2VMZWF2ZUl0ZW1EaXNwYXRjaChvbk1vdXNlTGVhdmVGcm9tUHJvcHMpOwogIHZhciBvbkNsaWNrRnJvbUNvbnRleHQgPSB1c2VNb3VzZUNsaWNrSXRlbURpc3BhdGNoKG9uSXRlbUNsaWNrRnJvbVByb3BzLCBhbGxPdGhlclBpZVByb3BzLmRhdGFLZXksIGlkKTsKICBpZiAoc2VjdG9ycyA9PSBudWxsIHx8IHNlY3RvcnMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoUmVhY3QyMi5GcmFnbWVudCwgbnVsbCwgc2VjdG9ycy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICBpZiAoKGVudHJ5ID09PSBudWxsIHx8IGVudHJ5ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBlbnRyeS5zdGFydEFuZ2xlKSA9PT0gMCAmJiAoZW50cnkgPT09IG51bGwgfHwgZW50cnkgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGVudHJ5LmVuZEFuZ2xlKSA9PT0gMCAmJiBzZWN0b3JzLmxlbmd0aCAhPT0gMSkgcmV0dXJuIG51bGw7CiAgICB2YXIgZ3JhcGhpY2FsSXRlbU1hdGNoZXMgPSBhY3RpdmVHcmFwaGljYWxJdGVtSWQgPT0gbnVsbCB8fCBhY3RpdmVHcmFwaGljYWxJdGVtSWQgPT09IGlkOwogICAgdmFyIGlzQWN0aXZlID0gU3RyaW5nKGkpID09PSBhY3RpdmVJbmRleCAmJiAoYWN0aXZlRGF0YUtleSA9PSBudWxsIHx8IGFsbE90aGVyUGllUHJvcHMuZGF0YUtleSA9PT0gYWN0aXZlRGF0YUtleSkgJiYgZ3JhcGhpY2FsSXRlbU1hdGNoZXM7CiAgICB2YXIgaW5hY3RpdmVTaGFwZSA9IGFjdGl2ZUluZGV4ID8gaW5hY3RpdmVTaGFwZVByb3AgOiBudWxsOwogICAgdmFyIHNlY3Rvck9wdGlvbnMgPSBhY3RpdmVTaGFwZSAmJiBpc0FjdGl2ZSA/IGFjdGl2ZVNoYXBlIDogaW5hY3RpdmVTaGFwZTsKICAgIHZhciBzZWN0b3JQcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIGVudHJ5KSwge30sIHsKICAgICAgc3Ryb2tlOiBlbnRyeS5zdHJva2UsCiAgICAgIHRhYkluZGV4OiAtMSwKICAgICAgW0RBVEFfSVRFTV9JTkRFWF9BVFRSSUJVVEVfTkFNRV06IGksCiAgICAgIFtEQVRBX0lURU1fREFUQUtFWV9BVFRSSUJVVEVfTkFNRV06IGFsbE90aGVyUGllUHJvcHMuZGF0YUtleQogICAgfSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY3JlYXRlRWxlbWVudChMYXllciwgX2V4dGVuZHMxNih7CiAgICAgIGtleTogInNlY3Rvci0iLmNvbmNhdChlbnRyeSA9PT0gbnVsbCB8fCBlbnRyeSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZW50cnkuc3RhcnRBbmdsZSwgIi0iKS5jb25jYXQoZW50cnkgPT09IG51bGwgfHwgZW50cnkgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGVudHJ5LmVuZEFuZ2xlLCAiLSIpLmNvbmNhdChlbnRyeS5taWRBbmdsZSwgIi0iKS5jb25jYXQoaSksCiAgICAgIHRhYkluZGV4OiAtMSwKICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtcGllLXNlY3RvciIKICAgIH0sIGFkYXB0RXZlbnRzT2ZDaGlsZChyZXN0T2ZBbGxPdGhlclByb3BzLCBlbnRyeSwgaSksIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0aGUgdHlwZXMgbmVlZCBhIGJpdCBvZiBhdHRlbnRpb24KICAgICAgb25Nb3VzZUVudGVyOiBvbk1vdXNlRW50ZXJGcm9tQ29udGV4dChlbnRyeSwgaSksCiAgICAgIG9uTW91c2VMZWF2ZTogb25Nb3VzZUxlYXZlRnJvbUNvbnRleHQoZW50cnksIGkpLAogICAgICBvbkNsaWNrOiBvbkNsaWNrRnJvbUNvbnRleHQoZW50cnksIGkpCiAgICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY3JlYXRlRWxlbWVudChTaGFwZSwgX2V4dGVuZHMxNih7CiAgICAgIG9wdGlvbjogc2hhcGUgIT09IG51bGwgJiYgc2hhcGUgIT09IHZvaWQgMCA/IHNoYXBlIDogc2VjdG9yT3B0aW9ucywKICAgICAgaW5kZXg6IGksCiAgICAgIHNoYXBlVHlwZTogInNlY3RvciIsCiAgICAgIGlzQWN0aXZlCiAgICB9LCBzZWN0b3JQcm9wcykpKTsKICB9KSk7Cn0KZnVuY3Rpb24gY29tcHV0ZVBpZVNlY3RvcnMoX3JlZjQpIHsKICB2YXIgX3BpZVNldHRpbmdzJHBhZGRpbmdBOwogIHZhciB7CiAgICBwaWVTZXR0aW5ncywKICAgIGRpc3BsYXllZERhdGEsCiAgICBjZWxscywKICAgIG9mZnNldAogIH0gPSBfcmVmNDsKICB2YXIgewogICAgY29ybmVyUmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlLAogICAgZGF0YUtleSwKICAgIG5hbWVLZXksCiAgICB0b29sdGlwVHlwZQogIH0gPSBwaWVTZXR0aW5nczsKICB2YXIgbWluQW5nbGUgPSBNYXRoLmFicyhwaWVTZXR0aW5ncy5taW5BbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBwYXJzZURlbHRhQW5nbGUoc3RhcnRBbmdsZSwgZW5kQW5nbGUpOwogIHZhciBhYnNEZWx0YUFuZ2xlID0gTWF0aC5hYnMoZGVsdGFBbmdsZSk7CiAgdmFyIHBhZGRpbmdBbmdsZSA9IGRpc3BsYXllZERhdGEubGVuZ3RoIDw9IDEgPyAwIDogKF9waWVTZXR0aW5ncyRwYWRkaW5nQSA9IHBpZVNldHRpbmdzLnBhZGRpbmdBbmdsZSkgIT09IG51bGwgJiYgX3BpZVNldHRpbmdzJHBhZGRpbmdBICE9PSB2b2lkIDAgPyBfcGllU2V0dGluZ3MkcGFkZGluZ0EgOiAwOwogIHZhciBub3RaZXJvSXRlbUNvdW50ID0gZGlzcGxheWVkRGF0YS5maWx0ZXIoKGVudHJ5KSA9PiBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSwgMCkgIT09IDApLmxlbmd0aDsKICB2YXIgdG90YWxQYWRkaW5nQW5nbGUgPSAoYWJzRGVsdGFBbmdsZSA+PSAzNjAgPyBub3RaZXJvSXRlbUNvdW50IDogbm90WmVyb0l0ZW1Db3VudCAtIDEpICogcGFkZGluZ0FuZ2xlOwogIHZhciByZWFsVG90YWxBbmdsZSA9IGFic0RlbHRhQW5nbGUgLSBub3RaZXJvSXRlbUNvdW50ICogbWluQW5nbGUgLSB0b3RhbFBhZGRpbmdBbmdsZTsKICB2YXIgc3VtID0gZGlzcGxheWVkRGF0YS5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIHZhciB2YWwgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSwgMCk7CiAgICByZXR1cm4gcmVzdWx0ICsgKGlzTnVtYmVyKHZhbCkgPyB2YWwgOiAwKTsKICB9LCAwKTsKICB2YXIgc2VjdG9yczsKICBpZiAoc3VtID4gMCkgewogICAgdmFyIHByZXY7CiAgICBzZWN0b3JzID0gZGlzcGxheWVkRGF0YS5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICAgIHZhciB2YWwgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSwgMCk7CiAgICAgIHZhciBuYW1lID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIG5hbWVLZXksIGkpOwogICAgICB2YXIgY29vcmRpbmF0ZSA9IHBhcnNlQ29vcmRpbmF0ZU9mUGllKHBpZVNldHRpbmdzLCBvZmZzZXQsIGVudHJ5KTsKICAgICAgdmFyIHBlcmNlbnQgPSAoaXNOdW1iZXIodmFsKSA/IHZhbCA6IDApIC8gc3VtOwogICAgICB2YXIgdGVtcFN0YXJ0QW5nbGU7CiAgICAgIHZhciBlbnRyeVdpdGhDZWxsSW5mbyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIGVudHJ5KSwgY2VsbHMgJiYgY2VsbHNbaV0gJiYgY2VsbHNbaV0ucHJvcHMpOwogICAgICBpZiAoaSkgewogICAgICAgIHRlbXBTdGFydEFuZ2xlID0gcHJldi5lbmRBbmdsZSArIG1hdGhTaWduKGRlbHRhQW5nbGUpICogcGFkZGluZ0FuZ2xlICogKHZhbCAhPT0gMCA/IDEgOiAwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0ZW1wU3RhcnRBbmdsZSA9IHN0YXJ0QW5nbGU7CiAgICAgIH0KICAgICAgdmFyIHRlbXBFbmRBbmdsZSA9IHRlbXBTdGFydEFuZ2xlICsgbWF0aFNpZ24oZGVsdGFBbmdsZSkgKiAoKHZhbCAhPT0gMCA/IG1pbkFuZ2xlIDogMCkgKyBwZXJjZW50ICogcmVhbFRvdGFsQW5nbGUpOwogICAgICB2YXIgbWlkQW5nbGUgPSAodGVtcFN0YXJ0QW5nbGUgKyB0ZW1wRW5kQW5nbGUpIC8gMjsKICAgICAgdmFyIG1pZGRsZVJhZGl1cyA9IChjb29yZGluYXRlLmlubmVyUmFkaXVzICsgY29vcmRpbmF0ZS5vdXRlclJhZGl1cykgLyAyOwogICAgICB2YXIgdG9vbHRpcFBheWxvYWQgPSBbewogICAgICAgIG5hbWUsCiAgICAgICAgdmFsdWU6IHZhbCwKICAgICAgICBwYXlsb2FkOiBlbnRyeVdpdGhDZWxsSW5mbywKICAgICAgICBkYXRhS2V5LAogICAgICAgIHR5cGU6IHRvb2x0aXBUeXBlCiAgICAgIH1dOwogICAgICB2YXIgdG9vbHRpcFBvc2l0aW9uID0gcG9sYXJUb0NhcnRlc2lhbihjb29yZGluYXRlLmN4LCBjb29yZGluYXRlLmN5LCBtaWRkbGVSYWRpdXMsIG1pZEFuZ2xlKTsKICAgICAgcHJldiA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgcGllU2V0dGluZ3MucHJlc2VudGF0aW9uUHJvcHMpLCB7fSwgewogICAgICAgIHBlcmNlbnQsCiAgICAgICAgY29ybmVyUmFkaXVzOiB0eXBlb2YgY29ybmVyUmFkaXVzID09PSAic3RyaW5nIiA/IHBhcnNlRmxvYXQoY29ybmVyUmFkaXVzKSA6IGNvcm5lclJhZGl1cywKICAgICAgICBuYW1lLAogICAgICAgIHRvb2x0aXBQYXlsb2FkLAogICAgICAgIG1pZEFuZ2xlLAogICAgICAgIG1pZGRsZVJhZGl1cywKICAgICAgICB0b29sdGlwUG9zaXRpb24KICAgICAgfSwgZW50cnlXaXRoQ2VsbEluZm8pLCBjb29yZGluYXRlKSwge30sIHsKICAgICAgICB2YWx1ZTogdmFsLAogICAgICAgIGRhdGFLZXksCiAgICAgICAgc3RhcnRBbmdsZTogdGVtcFN0YXJ0QW5nbGUsCiAgICAgICAgZW5kQW5nbGU6IHRlbXBFbmRBbmdsZSwKICAgICAgICBwYXlsb2FkOiBlbnRyeVdpdGhDZWxsSW5mbywKICAgICAgICBwYWRkaW5nQW5nbGU6IG1hdGhTaWduKGRlbHRhQW5nbGUpICogcGFkZGluZ0FuZ2xlCiAgICAgIH0pOwogICAgICByZXR1cm4gcHJldjsKICAgIH0pOwogIH0KICByZXR1cm4gc2VjdG9yczsKfQpmdW5jdGlvbiBQaWVMYWJlbExpc3RQcm92aWRlcihfcmVmNSkgewogIHZhciB7CiAgICBzaG93TGFiZWxzLAogICAgc2VjdG9ycywKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWY1OwogIHZhciBsYWJlbExpc3RFbnRyaWVzID0gKDAsIGltcG9ydF9yZWFjdDM1LnVzZU1lbW8pKCgpID0+IHsKICAgIGlmICghc2hvd0xhYmVscyB8fCAhc2VjdG9ycykgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICByZXR1cm4gc2VjdG9ycy5tYXAoKGVudHJ5KSA9PiAoewogICAgICB2YWx1ZTogZW50cnkudmFsdWUsCiAgICAgIHBheWxvYWQ6IGVudHJ5LnBheWxvYWQsCiAgICAgIGNsb2NrV2lzZTogZmFsc2UsCiAgICAgIHBhcmVudFZpZXdCb3g6IHZvaWQgMCwKICAgICAgdmlld0JveDogewogICAgICAgIGN4OiBlbnRyeS5jeCwKICAgICAgICBjeTogZW50cnkuY3ksCiAgICAgICAgaW5uZXJSYWRpdXM6IGVudHJ5LmlubmVyUmFkaXVzLAogICAgICAgIG91dGVyUmFkaXVzOiBlbnRyeS5vdXRlclJhZGl1cywKICAgICAgICBzdGFydEFuZ2xlOiBlbnRyeS5zdGFydEFuZ2xlLAogICAgICAgIGVuZEFuZ2xlOiBlbnRyeS5lbmRBbmdsZSwKICAgICAgICBjbG9ja1dpc2U6IGZhbHNlCiAgICAgIH0sCiAgICAgIGZpbGw6IGVudHJ5LmZpbGwKICAgIH0pKTsKICB9LCBbc2VjdG9ycywgc2hvd0xhYmVsc10pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KFBvbGFyTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyLCB7CiAgICB2YWx1ZTogc2hvd0xhYmVscyA/IGxhYmVsTGlzdEVudHJpZXMgOiB2b2lkIDAKICB9LCBjaGlsZHJlbik7Cn0KZnVuY3Rpb24gU2VjdG9yc1dpdGhBbmltYXRpb24oX3JlZjYpIHsKICB2YXIgewogICAgcHJvcHMsCiAgICBwcmV2aW91c1NlY3RvcnNSZWYsCiAgICBpZAogIH0gPSBfcmVmNjsKICB2YXIgewogICAgc2VjdG9ycywKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGFjdGl2ZVNoYXBlLAogICAgaW5hY3RpdmVTaGFwZSwKICAgIG9uQW5pbWF0aW9uU3RhcnQsCiAgICBvbkFuaW1hdGlvbkVuZAogIH0gPSBwcm9wczsKICB2YXIgYW5pbWF0aW9uSWQgPSB1c2VBbmltYXRpb25JZChwcm9wcywgInJlY2hhcnRzLXBpZS0iKTsKICB2YXIgcHJldlNlY3RvcnMgPSBwcmV2aW91c1NlY3RvcnNSZWYuY3VycmVudDsKICB2YXIgW2lzQW5pbWF0aW5nLCBzZXRJc0FuaW1hdGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0MzUudXNlU3RhdGUpKGZhbHNlKTsKICB2YXIgaGFuZGxlQW5pbWF0aW9uRW5kID0gKDAsIGltcG9ydF9yZWFjdDM1LnVzZUNhbGxiYWNrKSgoKSA9PiB7CiAgICBpZiAodHlwZW9mIG9uQW5pbWF0aW9uRW5kID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIG9uQW5pbWF0aW9uRW5kKCk7CiAgICB9CiAgICBzZXRJc0FuaW1hdGluZyhmYWxzZSk7CiAgfSwgW29uQW5pbWF0aW9uRW5kXSk7CiAgdmFyIGhhbmRsZUFuaW1hdGlvblN0YXJ0ID0gKDAsIGltcG9ydF9yZWFjdDM1LnVzZUNhbGxiYWNrKSgoKSA9PiB7CiAgICBpZiAodHlwZW9mIG9uQW5pbWF0aW9uU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgb25BbmltYXRpb25TdGFydCgpOwogICAgfQogICAgc2V0SXNBbmltYXRpbmcodHJ1ZSk7CiAgfSwgW29uQW5pbWF0aW9uU3RhcnRdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY3JlYXRlRWxlbWVudChQaWVMYWJlbExpc3RQcm92aWRlciwgewogICAgc2hvd0xhYmVsczogIWlzQW5pbWF0aW5nLAogICAgc2VjdG9ycwogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoSmF2YXNjcmlwdEFuaW1hdGUsIHsKICAgIGFuaW1hdGlvbklkLAogICAgYmVnaW46IGFuaW1hdGlvbkJlZ2luLAogICAgZHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uLAogICAgaXNBY3RpdmU6IGlzQW5pbWF0aW9uQWN0aXZlLAogICAgZWFzaW5nOiBhbmltYXRpb25FYXNpbmcsCiAgICBvbkFuaW1hdGlvblN0YXJ0OiBoYW5kbGVBbmltYXRpb25TdGFydCwKICAgIG9uQW5pbWF0aW9uRW5kOiBoYW5kbGVBbmltYXRpb25FbmQsCiAgICBrZXk6IGFuaW1hdGlvbklkCiAgfSwgKHQpID0+IHsKICAgIHZhciBzdGVwRGF0YSA9IFtdOwogICAgdmFyIGZpcnN0ID0gc2VjdG9ycyAmJiBzZWN0b3JzWzBdOwogICAgdmFyIGN1ckFuZ2xlID0gZmlyc3QgPT09IG51bGwgfHwgZmlyc3QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpcnN0LnN0YXJ0QW5nbGU7CiAgICBzZWN0b3JzID09PSBudWxsIHx8IHNlY3RvcnMgPT09IHZvaWQgMCB8fCBzZWN0b3JzLmZvckVhY2goKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgcHJldiA9IHByZXZTZWN0b3JzICYmIHByZXZTZWN0b3JzW2luZGV4XTsKICAgICAgdmFyIHBhZGRpbmdBbmdsZSA9IGluZGV4ID4gMCA/ICgwLCBpbXBvcnRfZ2V0NC5kZWZhdWx0KShlbnRyeSwgInBhZGRpbmdBbmdsZSIsIDApIDogMDsKICAgICAgaWYgKHByZXYpIHsKICAgICAgICB2YXIgYW5nbGUgPSBpbnRlcnBvbGF0ZShwcmV2LmVuZEFuZ2xlIC0gcHJldi5zdGFydEFuZ2xlLCBlbnRyeS5lbmRBbmdsZSAtIGVudHJ5LnN0YXJ0QW5nbGUsIHQpOwogICAgICAgIHZhciBsYXRlc3QzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgc3RhcnRBbmdsZTogY3VyQW5nbGUgKyBwYWRkaW5nQW5nbGUsCiAgICAgICAgICBlbmRBbmdsZTogY3VyQW5nbGUgKyBhbmdsZSArIHBhZGRpbmdBbmdsZQogICAgICAgIH0pOwogICAgICAgIHN0ZXBEYXRhLnB1c2gobGF0ZXN0Myk7CiAgICAgICAgY3VyQW5nbGUgPSBsYXRlc3QzLmVuZEFuZ2xlOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciB7CiAgICAgICAgICBlbmRBbmdsZSwKICAgICAgICAgIHN0YXJ0QW5nbGUKICAgICAgICB9ID0gZW50cnk7CiAgICAgICAgdmFyIGRlbHRhQW5nbGUgPSBpbnRlcnBvbGF0ZSgwLCBlbmRBbmdsZSAtIHN0YXJ0QW5nbGUsIHQpOwogICAgICAgIHZhciBfbGF0ZXN0ID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgc3RhcnRBbmdsZTogY3VyQW5nbGUgKyBwYWRkaW5nQW5nbGUsCiAgICAgICAgICBlbmRBbmdsZTogY3VyQW5nbGUgKyBkZWx0YUFuZ2xlICsgcGFkZGluZ0FuZ2xlCiAgICAgICAgfSk7CiAgICAgICAgc3RlcERhdGEucHVzaChfbGF0ZXN0KTsKICAgICAgICBjdXJBbmdsZSA9IF9sYXRlc3QuZW5kQW5nbGU7CiAgICAgIH0KICAgIH0pOwogICAgcHJldmlvdXNTZWN0b3JzUmVmLmN1cnJlbnQgPSBzdGVwRGF0YTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KExheWVyLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KFBpZVNlY3RvcnMsIHsKICAgICAgc2VjdG9yczogc3RlcERhdGEsCiAgICAgIGFjdGl2ZVNoYXBlLAogICAgICBpbmFjdGl2ZVNoYXBlLAogICAgICBhbGxPdGhlclBpZVByb3BzOiBwcm9wcywKICAgICAgc2hhcGU6IHByb3BzLnNoYXBlLAogICAgICBpZAogICAgfSkpOwogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KFBpZUxhYmVsTGlzdCwgewogICAgc2hvd0xhYmVsczogIWlzQW5pbWF0aW5nLAogICAgc2VjdG9ycywKICAgIHByb3BzCiAgfSksIHByb3BzLmNoaWxkcmVuKTsKfQp2YXIgZGVmYXVsdFBpZVByb3BzID0gewogIGFuaW1hdGlvbkJlZ2luOiA0MDAsCiAgYW5pbWF0aW9uRHVyYXRpb246IDE1MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIsCiAgY3g6ICI1MCUiLAogIGN5OiAiNTAlIiwKICBkYXRhS2V5OiAidmFsdWUiLAogIGVuZEFuZ2xlOiAzNjAsCiAgZmlsbDogIiM4MDgwODAiLAogIGhpZGU6IGZhbHNlLAogIGlubmVyUmFkaXVzOiAwLAogIGlzQW5pbWF0aW9uQWN0aXZlOiAiYXV0byIsCiAgbGFiZWw6IGZhbHNlLAogIGxhYmVsTGluZTogdHJ1ZSwKICBsZWdlbmRUeXBlOiAicmVjdCIsCiAgbWluQW5nbGU6IDAsCiAgbmFtZUtleTogIm5hbWUiLAogIG91dGVyUmFkaXVzOiAiODAlIiwKICBwYWRkaW5nQW5nbGU6IDAsCiAgcm9vdFRhYkluZGV4OiAwLAogIHN0YXJ0QW5nbGU6IDAsCiAgc3Ryb2tlOiAiI2ZmZiIsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXJlYQp9OwpmdW5jdGlvbiBQaWVJbXBsKHByb3BzKSB7CiAgdmFyIHsKICAgIGlkCiAgfSA9IHByb3BzLCBwcm9wc1dpdGhvdXRJZCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKHByb3BzLCBfZXhjbHVkZWQzMik7CiAgdmFyIHsKICAgIGhpZGUsCiAgICBjbGFzc05hbWUsCiAgICByb290VGFiSW5kZXgKICB9ID0gcHJvcHM7CiAgdmFyIGNlbGxzID0gKDAsIGltcG9ydF9yZWFjdDM1LnVzZU1lbW8pKCgpID0+IGZpbmRBbGxCeVR5cGUocHJvcHMuY2hpbGRyZW4sIENlbGwpLCBbcHJvcHMuY2hpbGRyZW5dKTsKICB2YXIgc2VjdG9ycyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0UGllU2VjdG9ycyhzdGF0ZSwgaWQsIGNlbGxzKSk7CiAgdmFyIHByZXZpb3VzU2VjdG9yc1JlZiA9ICgwLCBpbXBvcnRfcmVhY3QzNS51c2VSZWYpKG51bGwpOwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtcGllIiwgY2xhc3NOYW1lKTsKICBpZiAoaGlkZSB8fCBzZWN0b3JzID09IG51bGwpIHsKICAgIHByZXZpb3VzU2VjdG9yc1JlZi5jdXJyZW50ID0gbnVsbDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICAgIHRhYkluZGV4OiByb290VGFiSW5kZXgsCiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcwogICAgfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoU2V0UGllVG9vbHRpcEVudHJ5U2V0dGluZ3MsIHsKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBuYW1lS2V5OiBwcm9wcy5uYW1lS2V5LAogICAgc2VjdG9ycywKICAgIHN0cm9rZTogcHJvcHMuc3Ryb2tlLAogICAgc3Ryb2tlV2lkdGg6IHByb3BzLnN0cm9rZVdpZHRoLAogICAgZmlsbDogcHJvcHMuZmlsbCwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgdG9vbHRpcFR5cGU6IHByb3BzLnRvb2x0aXBUeXBlCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIHRhYkluZGV4OiByb290VGFiSW5kZXgsCiAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KFNlY3RvcnNXaXRoQW5pbWF0aW9uLCB7CiAgICBwcm9wczogX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgcHJvcHNXaXRob3V0SWQpLCB7fSwgewogICAgICBzZWN0b3JzCiAgICB9KSwKICAgIHByZXZpb3VzU2VjdG9yc1JlZiwKICAgIGlkCiAgfSkpKTsKfQpmdW5jdGlvbiBQaWUob3V0c2lkZVByb3BzKSB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRQaWVQcm9wcyk7CiAgdmFyIHsKICAgIGlkOiBleHRlcm5hbElkCiAgfSA9IHByb3BzLCBwcm9wc1dpdGhvdXRJZCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKHByb3BzLCBfZXhjbHVkZWQ0Mik7CiAgdmFyIHByZXNlbnRhdGlvblByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzV2l0aG91dElkKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY3JlYXRlRWxlbWVudChSZWdpc3RlckdyYXBoaWNhbEl0ZW1JZCwgewogICAgaWQ6IGV4dGVybmFsSWQsCiAgICB0eXBlOiAicGllIgogIH0sIChpZCkgPT4gLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY3JlYXRlRWxlbWVudChSZWFjdDIyLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KFNldFBvbGFyR3JhcGhpY2FsSXRlbSwgewogICAgdHlwZTogInBpZSIsCiAgICBpZCwKICAgIGRhdGE6IHByb3BzV2l0aG91dElkLmRhdGEsCiAgICBkYXRhS2V5OiBwcm9wc1dpdGhvdXRJZC5kYXRhS2V5LAogICAgaGlkZTogcHJvcHNXaXRob3V0SWQuaGlkZSwKICAgIGFuZ2xlQXhpc0lkOiAwLAogICAgcmFkaXVzQXhpc0lkOiAwLAogICAgbmFtZTogcHJvcHNXaXRob3V0SWQubmFtZSwKICAgIG5hbWVLZXk6IHByb3BzV2l0aG91dElkLm5hbWVLZXksCiAgICB0b29sdGlwVHlwZTogcHJvcHNXaXRob3V0SWQudG9vbHRpcFR5cGUsCiAgICBsZWdlbmRUeXBlOiBwcm9wc1dpdGhvdXRJZC5sZWdlbmRUeXBlLAogICAgZmlsbDogcHJvcHNXaXRob3V0SWQuZmlsbCwKICAgIGN4OiBwcm9wc1dpdGhvdXRJZC5jeCwKICAgIGN5OiBwcm9wc1dpdGhvdXRJZC5jeSwKICAgIHN0YXJ0QW5nbGU6IHByb3BzV2l0aG91dElkLnN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZTogcHJvcHNXaXRob3V0SWQuZW5kQW5nbGUsCiAgICBwYWRkaW5nQW5nbGU6IHByb3BzV2l0aG91dElkLnBhZGRpbmdBbmdsZSwKICAgIG1pbkFuZ2xlOiBwcm9wc1dpdGhvdXRJZC5taW5BbmdsZSwKICAgIGlubmVyUmFkaXVzOiBwcm9wc1dpdGhvdXRJZC5pbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzOiBwcm9wc1dpdGhvdXRJZC5vdXRlclJhZGl1cywKICAgIGNvcm5lclJhZGl1czogcHJvcHNXaXRob3V0SWQuY29ybmVyUmFkaXVzLAogICAgcHJlc2VudGF0aW9uUHJvcHMsCiAgICBtYXhSYWRpdXM6IHByb3BzLm1heFJhZGl1cwogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KFNldFBpZVBheWxvYWRMZWdlbmQsIF9leHRlbmRzMTYoe30sIHByb3BzV2l0aG91dElkLCB7CiAgICBpZAogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjIuY3JlYXRlRWxlbWVudChQaWVJbXBsLCBfZXh0ZW5kczE2KHt9LCBwcm9wc1dpdGhvdXRJZCwgewogICAgaWQKICB9KSkpKTsKfQpQaWUuZGlzcGxheU5hbWUgPSAiUGllIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0RvdHMuanMKdmFyIFJlYWN0MjMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9leGNsdWRlZDEyID0gWyJwb2ludHMiXTsKZnVuY3Rpb24gb3duS2V5czI5KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjkoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyOShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzAoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjkoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMwKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzAocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzAodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzAodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzAodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTcoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTcgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE3LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTIoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEyKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gRG90SXRlbShfcmVmMikgewogIHZhciB7CiAgICBvcHRpb24sCiAgICBkb3RQcm9wcywKICAgIGNsYXNzTmFtZQogIH0gPSBfcmVmMjsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNi5pc1ZhbGlkRWxlbWVudCkob3B0aW9uKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzYuY2xvbmVFbGVtZW50KShvcHRpb24sIGRvdFByb3BzKTsKICB9CiAgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBvcHRpb24oZG90UHJvcHMpOwogIH0KICB2YXIgZmluYWxDbGFzc05hbWUgPSBjbHN4KGNsYXNzTmFtZSwgdHlwZW9mIG9wdGlvbiAhPT0gImJvb2xlYW4iID8gb3B0aW9uLmNsYXNzTmFtZSA6ICIiKTsKICB2YXIgX3JlZjIyID0gZG90UHJvcHMgIT09IG51bGwgJiYgZG90UHJvcHMgIT09IHZvaWQgMCA/IGRvdFByb3BzIDoge30sIHsKICAgIHBvaW50cwogIH0gPSBfcmVmMjIsIHByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTIoX3JlZjIyLCBfZXhjbHVkZWQxMik7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIzLmNyZWF0ZUVsZW1lbnQoRG90LCBfZXh0ZW5kczE3KHt9LCBwcm9wcywgewogICAgY2xhc3NOYW1lOiBmaW5hbENsYXNzTmFtZQogIH0pKTsKfQpmdW5jdGlvbiBzaG91bGRSZW5kZXJEb3RzKHBvaW50cywgZG90KSB7CiAgaWYgKHBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChkb3QpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gcG9pbnRzLmxlbmd0aCA9PT0gMTsKfQpmdW5jdGlvbiBEb3RzKF9yZWYzKSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGRvdCwKICAgIGNsYXNzTmFtZSwKICAgIGRvdENsYXNzTmFtZSwKICAgIGRhdGFLZXksCiAgICBiYXNlUHJvcHMsCiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICB6SW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuc2NhdHRlcgogIH0gPSBfcmVmMzsKICBpZiAoIXNob3VsZFJlbmRlckRvdHMocG9pbnRzLCBkb3QpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGNsaXBEb3QgPSBpc0NsaXBEb3QoZG90KTsKICB2YXIgY3VzdG9tRG90UHJvcHMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzRnJvbVVua25vd24oZG90KTsKICB2YXIgZG90cyA9IHBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgX2VudHJ5JHgsIF9lbnRyeSR5OwogICAgdmFyIGRvdFByb3BzID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoewogICAgICByOiAzCiAgICB9LCBiYXNlUHJvcHMpLCBjdXN0b21Eb3RQcm9wcyksIHt9LCB7CiAgICAgIGluZGV4OiBpLAogICAgICBjeDogKF9lbnRyeSR4ID0gZW50cnkueCkgIT09IG51bGwgJiYgX2VudHJ5JHggIT09IHZvaWQgMCA/IF9lbnRyeSR4IDogdm9pZCAwLAogICAgICBjeTogKF9lbnRyeSR5ID0gZW50cnkueSkgIT09IG51bGwgJiYgX2VudHJ5JHkgIT09IHZvaWQgMCA/IF9lbnRyeSR5IDogdm9pZCAwLAogICAgICBkYXRhS2V5LAogICAgICB2YWx1ZTogZW50cnkudmFsdWUsCiAgICAgIHBheWxvYWQ6IGVudHJ5LnBheWxvYWQsCiAgICAgIHBvaW50cwogICAgfSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudChEb3RJdGVtLCB7CiAgICAgIGtleTogImRvdC0iLmNvbmNhdChpKSwKICAgICAgb3B0aW9uOiBkb3QsCiAgICAgIGRvdFByb3BzLAogICAgICBjbGFzc05hbWU6IGRvdENsYXNzTmFtZQogICAgfSk7CiAgfSk7CiAgdmFyIGxheWVyUHJvcHMgPSB7fTsKICBpZiAobmVlZENsaXAgJiYgY2xpcFBhdGhJZCAhPSBudWxsKSB7CiAgICBsYXllclByb3BzLmNsaXBQYXRoID0gInVybCgjY2xpcFBhdGgtIi5jb25jYXQoY2xpcERvdCA/ICIiIDogImRvdHMtIikuY29uY2F0KGNsaXBQYXRoSWQsICIpIik7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KExheWVyLCBfZXh0ZW5kczE3KHsKICAgIGNsYXNzTmFtZQogIH0sIGxheWVyUHJvcHMpLCBkb3RzKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0FjdGl2ZVBvaW50cy5qcwp2YXIgUmVhY3QyNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9jYXJ0ZXNpYW5BeGlzU2xpY2UuanMKZnVuY3Rpb24gb3duS2V5czMwKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMzAoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMzMChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMzAoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMxKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBpbml0aWFsU3RhdGU4ID0gewogIHhBeGlzOiB7fSwKICB5QXhpczoge30sCiAgekF4aXM6IHt9Cn07CnZhciBjYXJ0ZXNpYW5BeGlzU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImNhcnRlc2lhbkF4aXMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlOCwKICByZWR1Y2VyczogewogICAgYWRkWEF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUueEF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlWEF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS54QXhpc1twcmV2LmlkXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAocHJldi5pZCAhPT0gbmV4dC5pZCkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUueEF4aXNbcHJldi5pZF07CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS54QXhpc1tuZXh0LmlkXSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlWEF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlLnhBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBhZGRZQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS55QXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VZQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnlBeGlzW3ByZXYuaWRdICE9PSB2b2lkIDApIHsKICAgICAgICAgIGlmIChwcmV2LmlkICE9PSBuZXh0LmlkKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS55QXhpc1twcmV2LmlkXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlLnlBeGlzW25leHQuaWRdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVZQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBkZWxldGUgc3RhdGUueUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIGFkZFpBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnpBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVpBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekF4aXNbcHJldi5pZF0gIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHByZXYuaWQgIT09IG5leHQuaWQpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnpBeGlzW3ByZXYuaWRdOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUuekF4aXNbbmV4dC5pZF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVpBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIGRlbGV0ZSBzdGF0ZS56QXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgdXBkYXRlWUF4aXNXaWR0aChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHZhciB7CiAgICAgICAgaWQsCiAgICAgICAgd2lkdGgKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICB2YXIgYXhpcyA9IHN0YXRlLnlBeGlzW2lkXTsKICAgICAgaWYgKGF4aXMpIHsKICAgICAgICB2YXIgaGlzdG9yeSA9IGF4aXMud2lkdGhIaXN0b3J5IHx8IFtdOwogICAgICAgIGlmIChoaXN0b3J5Lmxlbmd0aCA9PT0gMyAmJiBoaXN0b3J5WzBdID09PSBoaXN0b3J5WzJdICYmIHdpZHRoID09PSBoaXN0b3J5WzFdICYmIHdpZHRoICE9PSBheGlzLndpZHRoICYmIE1hdGguYWJzKHdpZHRoIC0gaGlzdG9yeVswXSkgPD0gMSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgbmV3SGlzdG9yeSA9IFsuLi5oaXN0b3J5LCB3aWR0aF0uc2xpY2UoLTMpOwogICAgICAgIHN0YXRlLnlBeGlzW2lkXSA9IF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoe30sIHN0YXRlLnlBeGlzW2lkXSksIHt9LCB7CiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIHdpZHRoSGlzdG9yeTogbmV3SGlzdG9yeQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRYQXhpcywKICByZXBsYWNlWEF4aXMsCiAgcmVtb3ZlWEF4aXMsCiAgYWRkWUF4aXMsCiAgcmVwbGFjZVlBeGlzLAogIHJlbW92ZVlBeGlzLAogIGFkZFpBeGlzLAogIHJlcGxhY2VaQXhpcywKICByZW1vdmVaQXhpcywKICB1cGRhdGVZQXhpc1dpZHRoCn0gPSBjYXJ0ZXNpYW5BeGlzU2xpY2UuYWN0aW9uczsKdmFyIGNhcnRlc2lhbkF4aXNSZWR1Y2VyID0gY2FydGVzaWFuQXhpc1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RDaGFydE9mZnNldC5qcwp2YXIgc2VsZWN0Q2hhcnRPZmZzZXQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIChvZmZzZXRJbnRlcm5hbCkgPT4gewogIHJldHVybiB7CiAgICB0b3A6IG9mZnNldEludGVybmFsLnRvcCwKICAgIGJvdHRvbTogb2Zmc2V0SW50ZXJuYWwuYm90dG9tLAogICAgbGVmdDogb2Zmc2V0SW50ZXJuYWwubGVmdCwKICAgIHJpZ2h0OiBvZmZzZXRJbnRlcm5hbC5yaWdodAogIH07Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0UGxvdEFyZWEuanMKdmFyIHNlbGVjdFBsb3RBcmVhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0LCBzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodF0sIChvZmZzZXQsIGNoYXJ0V2lkdGgsIGNoYXJ0SGVpZ2h0KSA9PiB7CiAgaWYgKCFvZmZzZXQgfHwgY2hhcnRXaWR0aCA9PSBudWxsIHx8IGNoYXJ0SGVpZ2h0ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB7CiAgICB4OiBvZmZzZXQubGVmdCwKICAgIHk6IG9mZnNldC50b3AsCiAgICB3aWR0aDogTWF0aC5tYXgoMCwgY2hhcnRXaWR0aCAtIG9mZnNldC5sZWZ0IC0gb2Zmc2V0LnJpZ2h0KSwKICAgIGhlaWdodDogTWF0aC5tYXgoMCwgY2hhcnRIZWlnaHQgLSBvZmZzZXQudG9wIC0gb2Zmc2V0LmJvdHRvbSkKICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvaG9va3MuanMKdmFyIHVzZVBsb3RBcmVhID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RQbG90QXJlYSk7Cn07CnZhciB1c2VBY3RpdmVUb29sdGlwRGF0YVBvaW50cyA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QWN0aXZlVG9vbHRpcERhdGFQb2ludHMpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQWN0aXZlUG9pbnRzLmpzCmZ1bmN0aW9uIG93bktleXMzMShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMxKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzEoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMyKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMxKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgQWN0aXZlUG9pbnQgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgcG9pbnQ6IHBvaW50NCwKICAgIGNoaWxkSW5kZXgsCiAgICBtYWluQ29sb3IsCiAgICBhY3RpdmVEb3QsCiAgICBkYXRhS2V5LAogICAgY2xpcFBhdGgKICB9ID0gX3JlZjI7CiAgaWYgKGFjdGl2ZURvdCA9PT0gZmFsc2UgfHwgcG9pbnQ0LnggPT0gbnVsbCB8fCBwb2ludDQueSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGRvdFByb3BzVHlwZWQgPSB7CiAgICBpbmRleDogY2hpbGRJbmRleCwKICAgIGRhdGFLZXksCiAgICBjeDogcG9pbnQ0LngsCiAgICBjeTogcG9pbnQ0LnksCiAgICByOiA0LAogICAgZmlsbDogbWFpbkNvbG9yICE9PSBudWxsICYmIG1haW5Db2xvciAhPT0gdm9pZCAwID8gbWFpbkNvbG9yIDogIm5vbmUiLAogICAgc3Ryb2tlV2lkdGg6IDIsCiAgICBzdHJva2U6ICIjZmZmIiwKICAgIHBheWxvYWQ6IHBvaW50NC5wYXlsb2FkLAogICAgdmFsdWU6IHBvaW50NC52YWx1ZQogIH07CiAgdmFyIGRvdFByb3BzID0gX29iamVjdFNwcmVhZDMxKF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIGRvdFByb3BzVHlwZWQpLCBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihhY3RpdmVEb3QpKSwgYWRhcHRFdmVudEhhbmRsZXJzKGFjdGl2ZURvdCkpOwogIHZhciBkb3Q7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzcuaXNWYWxpZEVsZW1lbnQpKGFjdGl2ZURvdCkpIHsKICAgIGRvdCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzcuY2xvbmVFbGVtZW50KShhY3RpdmVEb3QsIGRvdFByb3BzKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBhY3RpdmVEb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgIGRvdCA9IGFjdGl2ZURvdChkb3RQcm9wcyk7CiAgfSBlbHNlIHsKICAgIGRvdCA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoRG90LCBkb3RQcm9wcyk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hY3RpdmUtZG90IiwKICAgIGNsaXBQYXRoCiAgfSwgZG90KTsKfTsKZnVuY3Rpb24gQWN0aXZlUG9pbnRzKF9yZWYyKSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIG1haW5Db2xvciwKICAgIGFjdGl2ZURvdCwKICAgIGl0ZW1EYXRhS2V5LAogICAgY2xpcFBhdGgsCiAgICB6SW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuYWN0aXZlRG90CiAgfSA9IF9yZWYyOwogIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgpOwogIHZhciBhY3RpdmVEYXRhUG9pbnRzID0gdXNlQWN0aXZlVG9vbHRpcERhdGFQb2ludHMoKTsKICBpZiAocG9pbnRzID09IG51bGwgfHwgYWN0aXZlRGF0YVBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGFjdGl2ZVBvaW50ID0gcG9pbnRzLmZpbmQoKHApID0+IGFjdGl2ZURhdGFQb2ludHMuaW5jbHVkZXMocC5wYXlsb2FkKSk7CiAgaWYgKGlzTnVsbGlzaChhY3RpdmVQb2ludCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChBY3RpdmVQb2ludCwgewogICAgcG9pbnQ6IGFjdGl2ZVBvaW50LAogICAgY2hpbGRJbmRleDogTnVtYmVyKGFjdGl2ZVRvb2x0aXBJbmRleCksCiAgICBtYWluQ29sb3IsCiAgICBkYXRhS2V5OiBpdGVtRGF0YUtleSwKICAgIGFjdGl2ZURvdCwKICAgIGNsaXBQYXRoCiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2Vycm9yQmFyU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTkgPSB7fTsKdmFyIGVycm9yQmFyU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImVycm9yQmFycyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU5LAogIHJlZHVjZXJzOiB7CiAgICBhZGRFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgZXJyb3JCYXIKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoIXN0YXRlW2l0ZW1JZF0pIHsKICAgICAgICBzdGF0ZVtpdGVtSWRdID0gW107CiAgICAgIH0KICAgICAgc3RhdGVbaXRlbUlkXS5wdXNoKGVycm9yQmFyKTsKICAgIH0sCiAgICByZXBsYWNlRXJyb3JCYXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciB7CiAgICAgICAgaXRlbUlkLAogICAgICAgIHByZXYsCiAgICAgICAgbmV4dAogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChzdGF0ZVtpdGVtSWRdKSB7CiAgICAgICAgc3RhdGVbaXRlbUlkXSA9IHN0YXRlW2l0ZW1JZF0ubWFwKChlKSA9PiBlLmRhdGFLZXkgPT09IHByZXYuZGF0YUtleSAmJiBlLmRpcmVjdGlvbiA9PT0gcHJldi5kaXJlY3Rpb24gPyBuZXh0IDogZSk7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgZXJyb3JCYXIKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoc3RhdGVbaXRlbUlkXSkgewogICAgICAgIHN0YXRlW2l0ZW1JZF0gPSBzdGF0ZVtpdGVtSWRdLmZpbHRlcigoZSkgPT4gZS5kYXRhS2V5ICE9PSBlcnJvckJhci5kYXRhS2V5IHx8IGUuZGlyZWN0aW9uICE9PSBlcnJvckJhci5kaXJlY3Rpb24pOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRFcnJvckJhciwKICByZXBsYWNlRXJyb3JCYXIsCiAgcmVtb3ZlRXJyb3JCYXIKfSA9IGVycm9yQmFyU2xpY2UuYWN0aW9uczsKdmFyIGVycm9yQmFyUmVkdWNlciA9IGVycm9yQmFyU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0dyYXBoaWNhbEl0ZW1DbGlwUGF0aC5qcwp2YXIgUmVhY3QyNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gdXNlTmVlZHNDbGlwKHhBeGlzSWQsIHlBeGlzSWQpIHsKICB2YXIgX3hBeGlzJGFsbG93RGF0YU92ZXJmLCBfeUF4aXMkYWxsb3dEYXRhT3ZlcmY7CiAgdmFyIHhBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCB4QXhpc0lkKSk7CiAgdmFyIHlBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCB5QXhpc0lkKSk7CiAgdmFyIG5lZWRDbGlwWCA9IChfeEF4aXMkYWxsb3dEYXRhT3ZlcmYgPSB4QXhpcyA9PT0gbnVsbCB8fCB4QXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogeEF4aXMuYWxsb3dEYXRhT3ZlcmZsb3cpICE9PSBudWxsICYmIF94QXhpcyRhbGxvd0RhdGFPdmVyZiAhPT0gdm9pZCAwID8gX3hBeGlzJGFsbG93RGF0YU92ZXJmIDogaW1wbGljaXRYQXhpcy5hbGxvd0RhdGFPdmVyZmxvdzsKICB2YXIgbmVlZENsaXBZID0gKF95QXhpcyRhbGxvd0RhdGFPdmVyZiA9IHlBeGlzID09PSBudWxsIHx8IHlBeGlzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB5QXhpcy5hbGxvd0RhdGFPdmVyZmxvdykgIT09IG51bGwgJiYgX3lBeGlzJGFsbG93RGF0YU92ZXJmICE9PSB2b2lkIDAgPyBfeUF4aXMkYWxsb3dEYXRhT3ZlcmYgOiBpbXBsaWNpdFlBeGlzLmFsbG93RGF0YU92ZXJmbG93OwogIHZhciBuZWVkQ2xpcCA9IG5lZWRDbGlwWCB8fCBuZWVkQ2xpcFk7CiAgcmV0dXJuIHsKICAgIG5lZWRDbGlwLAogICAgbmVlZENsaXBYLAogICAgbmVlZENsaXBZCiAgfTsKfQpmdW5jdGlvbiBHcmFwaGljYWxJdGVtQ2xpcFBhdGgoX3JlZjIpIHsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQsCiAgICBjbGlwUGF0aElkCiAgfSA9IF9yZWYyOwogIHZhciBwbG90QXJlYSA9IHVzZVBsb3RBcmVhKCk7CiAgdmFyIHsKICAgIG5lZWRDbGlwWCwKICAgIG5lZWRDbGlwWSwKICAgIG5lZWRDbGlwCiAgfSA9IHVzZU5lZWRzQ2xpcCh4QXhpc0lkLCB5QXhpc0lkKTsKICBpZiAoIW5lZWRDbGlwIHx8ICFwbG90QXJlYSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcGxvdEFyZWE7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIiwgewogICAgaWQ6ICJjbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkKQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICB4OiBuZWVkQ2xpcFggPyB4MiA6IHgyIC0gd2lkdGggLyAyLAogICAgeTogbmVlZENsaXBZID8geTIgOiB5MiAtIGhlaWdodCAvIDIsCiAgICB3aWR0aDogbmVlZENsaXBYID8gd2lkdGggOiB3aWR0aCAqIDIsCiAgICBoZWlnaHQ6IG5lZWRDbGlwWSA/IGhlaWdodCA6IGhlaWdodCAqIDIKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1yZWR1eC9kaXN0L3JlYWN0LXJlZHV4Lm1qcwp2YXIgUmVhY3QyNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKdmFyIGltcG9ydF93aXRoX3NlbGVjdG9yMiA9IF9fdG9FU00ocmVxdWlyZV93aXRoX3NlbGVjdG9yMigpLCAxKTsKdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKdmFyIFJFQUNUX01FTU9fVFlQRSA9IC8qIEBfX1BVUkVfXyAqLyBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CnZhciBGb3J3YXJkUmVmID0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTsKdmFyIE1lbW8gPSBSRUFDVF9NRU1PX1RZUEU7CmZ1bmN0aW9uIGRlZmF1bHROb29wQmF0Y2goY2FsbGJhY2spIHsKICBjYWxsYmFjaygpOwp9CmZ1bmN0aW9uIGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpIHsKICBsZXQgZmlyc3QgPSBudWxsOwogIGxldCBsYXN0MiA9IG51bGw7CiAgcmV0dXJuIHsKICAgIGNsZWFyKCkgewogICAgICBmaXJzdCA9IG51bGw7CiAgICAgIGxhc3QyID0gbnVsbDsKICAgIH0sCiAgICBub3RpZnkoKSB7CiAgICAgIGRlZmF1bHROb29wQmF0Y2goKCkgPT4gewogICAgICAgIGxldCBsaXN0ZW5lcjIgPSBmaXJzdDsKICAgICAgICB3aGlsZSAobGlzdGVuZXIyKSB7CiAgICAgICAgICBsaXN0ZW5lcjIuY2FsbGJhY2soKTsKICAgICAgICAgIGxpc3RlbmVyMiA9IGxpc3RlbmVyMi5uZXh0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZ2V0KCkgewogICAgICBjb25zdCBsaXN0ZW5lcnMgPSBbXTsKICAgICAgbGV0IGxpc3RlbmVyMiA9IGZpcnN0OwogICAgICB3aGlsZSAobGlzdGVuZXIyKSB7CiAgICAgICAgbGlzdGVuZXJzLnB1c2gobGlzdGVuZXIyKTsKICAgICAgICBsaXN0ZW5lcjIgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfSwKICAgIHN1YnNjcmliZShjYWxsYmFjaykgewogICAgICBsZXQgaXNTdWJzY3JpYmVkID0gdHJ1ZTsKICAgICAgY29uc3QgbGlzdGVuZXIyID0gbGFzdDIgPSB7CiAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgbmV4dDogbnVsbCwKICAgICAgICBwcmV2OiBsYXN0MgogICAgICB9OwogICAgICBpZiAobGlzdGVuZXIyLnByZXYpIHsKICAgICAgICBsaXN0ZW5lcjIucHJldi5uZXh0ID0gbGlzdGVuZXIyOwogICAgICB9IGVsc2UgewogICAgICAgIGZpcnN0ID0gbGlzdGVuZXIyOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbiB1bnN1YnNjcmliZSgpIHsKICAgICAgICBpZiAoIWlzU3Vic2NyaWJlZCB8fCBmaXJzdCA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgIGlzU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICAgIGlmIChsaXN0ZW5lcjIubmV4dCkgewogICAgICAgICAgbGlzdGVuZXIyLm5leHQucHJldiA9IGxpc3RlbmVyMi5wcmV2OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsYXN0MiA9IGxpc3RlbmVyMi5wcmV2OwogICAgICAgIH0KICAgICAgICBpZiAobGlzdGVuZXIyLnByZXYpIHsKICAgICAgICAgIGxpc3RlbmVyMi5wcmV2Lm5leHQgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmlyc3QgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKfQp2YXIgbnVsbExpc3RlbmVycyA9IHsKICBub3RpZnkoKSB7CiAgfSwKICBnZXQ6ICgpID0+IFtdCn07CmZ1bmN0aW9uIGNyZWF0ZVN1YnNjcmlwdGlvbihzdG9yZSwgcGFyZW50U3ViKSB7CiAgbGV0IHVuc3Vic2NyaWJlOwogIGxldCBsaXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzOwogIGxldCBzdWJzY3JpcHRpb25zQW1vdW50ID0gMDsKICBsZXQgc2VsZlN1YnNjcmliZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBhZGROZXN0ZWRTdWIobGlzdGVuZXIyKSB7CiAgICB0cnlTdWJzY3JpYmUoKTsKICAgIGNvbnN0IGNsZWFudXBMaXN0ZW5lciA9IGxpc3RlbmVycy5zdWJzY3JpYmUobGlzdGVuZXIyKTsKICAgIGxldCByZW1vdmVkID0gZmFsc2U7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAoIXJlbW92ZWQpIHsKICAgICAgICByZW1vdmVkID0gdHJ1ZTsKICAgICAgICBjbGVhbnVwTGlzdGVuZXIoKTsKICAgICAgICB0cnlVbnN1YnNjcmliZSgpOwogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBub3RpZnlOZXN0ZWRTdWJzKCkgewogICAgbGlzdGVuZXJzLm5vdGlmeSgpOwogIH0KICBmdW5jdGlvbiBoYW5kbGVDaGFuZ2VXcmFwcGVyKCkgewogICAgaWYgKHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKSB7CiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzU3Vic2NyaWJlZCgpIHsKICAgIHJldHVybiBzZWxmU3Vic2NyaWJlZDsKICB9CiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlKCkgewogICAgc3Vic2NyaXB0aW9uc0Ftb3VudCsrOwogICAgaWYgKCF1bnN1YnNjcmliZSkgewogICAgICB1bnN1YnNjcmliZSA9IHBhcmVudFN1YiA/IHBhcmVudFN1Yi5hZGROZXN0ZWRTdWIoaGFuZGxlQ2hhbmdlV3JhcHBlcikgOiBzdG9yZS5zdWJzY3JpYmUoaGFuZGxlQ2hhbmdlV3JhcHBlcik7CiAgICAgIGxpc3RlbmVycyA9IGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpOwogICAgfQogIH0KICBmdW5jdGlvbiB0cnlVbnN1YnNjcmliZSgpIHsKICAgIHN1YnNjcmlwdGlvbnNBbW91bnQtLTsKICAgIGlmICh1bnN1YnNjcmliZSAmJiBzdWJzY3JpcHRpb25zQW1vdW50ID09PSAwKSB7CiAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICAgIHVuc3Vic2NyaWJlID0gdm9pZCAwOwogICAgICBsaXN0ZW5lcnMuY2xlYXIoKTsKICAgICAgbGlzdGVuZXJzID0gbnVsbExpc3RlbmVyczsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlU2VsZigpIHsKICAgIGlmICghc2VsZlN1YnNjcmliZWQpIHsKICAgICAgc2VsZlN1YnNjcmliZWQgPSB0cnVlOwogICAgICB0cnlTdWJzY3JpYmUoKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5VW5zdWJzY3JpYmVTZWxmKCkgewogICAgaWYgKHNlbGZTdWJzY3JpYmVkKSB7CiAgICAgIHNlbGZTdWJzY3JpYmVkID0gZmFsc2U7CiAgICAgIHRyeVVuc3Vic2NyaWJlKCk7CiAgICB9CiAgfQogIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHsKICAgIGFkZE5lc3RlZFN1YiwKICAgIG5vdGlmeU5lc3RlZFN1YnMsCiAgICBoYW5kbGVDaGFuZ2VXcmFwcGVyLAogICAgaXNTdWJzY3JpYmVkLAogICAgdHJ5U3Vic2NyaWJlOiB0cnlTdWJzY3JpYmVTZWxmLAogICAgdHJ5VW5zdWJzY3JpYmU6IHRyeVVuc3Vic2NyaWJlU2VsZiwKICAgIGdldExpc3RlbmVyczogKCkgPT4gbGlzdGVuZXJzCiAgfTsKICByZXR1cm4gc3Vic2NyaXB0aW9uOwp9CnZhciBjYW5Vc2VET00gPSAoKSA9PiAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKdmFyIGlzRE9NID0gLyogQF9fUFVSRV9fICovIGNhblVzZURPTSgpOwp2YXIgaXNSdW5uaW5nSW5SZWFjdE5hdGl2ZSA9ICgpID0+IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5wcm9kdWN0ID09PSAiUmVhY3ROYXRpdmUiOwp2YXIgaXNSZWFjdE5hdGl2ZSA9IC8qIEBfX1BVUkVfXyAqLyBpc1J1bm5pbmdJblJlYWN0TmF0aXZlKCk7CnZhciBnZXRVc2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gKCkgPT4gaXNET00gfHwgaXNSZWFjdE5hdGl2ZSA/IFJlYWN0MjYudXNlTGF5b3V0RWZmZWN0IDogUmVhY3QyNi51c2VFZmZlY3Q7CnZhciB1c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gLyogQF9fUFVSRV9fICovIGdldFVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoKTsKZnVuY3Rpb24gaXMzKHgyLCB5MikgewogIGlmICh4MiA9PT0geTIpIHsKICAgIHJldHVybiB4MiAhPT0gMCB8fCB5MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MjsKICB9IGVsc2UgewogICAgcmV0dXJuIHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQp9CmZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgaWYgKGlzMyhvYmpBLCBvYmpCKSkgcmV0dXJuIHRydWU7CiAgaWYgKHR5cGVvZiBvYmpBICE9PSAib2JqZWN0IiB8fCBvYmpBID09PSBudWxsIHx8IHR5cGVvZiBvYmpCICE9PSAib2JqZWN0IiB8fCBvYmpCID09PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbnN0IGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgY29uc3Qga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICBpZiAoa2V5c0EubGVuZ3RoICE9PSBrZXlzQi5sZW5ndGgpIHJldHVybiBmYWxzZTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBrZXlzQVtpXSkgfHwgIWlzMyhvYmpBW2tleXNBW2ldXSwgb2JqQltrZXlzQVtpXV0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KdmFyIEZPUldBUkRfUkVGX1NUQVRJQ1MgPSB7CiAgJCR0eXBlb2Y6IHRydWUsCiAgcmVuZGVyOiB0cnVlLAogIGRlZmF1bHRQcm9wczogdHJ1ZSwKICBkaXNwbGF5TmFtZTogdHJ1ZSwKICBwcm9wVHlwZXM6IHRydWUKfTsKdmFyIE1FTU9fU1RBVElDUyA9IHsKICAkJHR5cGVvZjogdHJ1ZSwKICBjb21wYXJlOiB0cnVlLAogIGRlZmF1bHRQcm9wczogdHJ1ZSwKICBkaXNwbGF5TmFtZTogdHJ1ZSwKICBwcm9wVHlwZXM6IHRydWUsCiAgdHlwZTogdHJ1ZQp9Owp2YXIgVFlQRV9TVEFUSUNTID0gewogIFtGb3J3YXJkUmVmXTogRk9SV0FSRF9SRUZfU1RBVElDUywKICBbTWVtb106IE1FTU9fU1RBVElDUwp9Owp2YXIgb2JqZWN0UHJvdG90eXBlID0gT2JqZWN0LnByb3RvdHlwZTsKdmFyIENvbnRleHRLZXkgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcihgcmVhY3QtcmVkdXgtY29udGV4dGApOwp2YXIgZ1QgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWxUaGlzIDogKAogIC8qIGZhbGwgYmFjayB0byBhIHBlci1tb2R1bGUgc2NvcGUgKHByZS04LjEgYmVoYXZpb3VyKSBpZiBgZ2xvYmFsVGhpc2AgaXMgbm90IGF2YWlsYWJsZSAqLwogIHt9Cik7CmZ1bmN0aW9uIGdldENvbnRleHQoKSB7CiAgaWYgKCFSZWFjdDI2LmNyZWF0ZUNvbnRleHQpIHJldHVybiB7fTsKICBjb25zdCBjb250ZXh0TWFwID0gZ1RbQ29udGV4dEtleV0gPz89IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgbGV0IHJlYWxDb250ZXh0ID0gY29udGV4dE1hcC5nZXQoUmVhY3QyNi5jcmVhdGVDb250ZXh0KTsKICBpZiAoIXJlYWxDb250ZXh0KSB7CiAgICByZWFsQ29udGV4dCA9IFJlYWN0MjYuY3JlYXRlQ29udGV4dCgKICAgICAgbnVsbAogICAgKTsKICAgIGlmICh0cnVlKSB7CiAgICAgIHJlYWxDb250ZXh0LmRpc3BsYXlOYW1lID0gIlJlYWN0UmVkdXgiOwogICAgfQogICAgY29udGV4dE1hcC5zZXQoUmVhY3QyNi5jcmVhdGVDb250ZXh0LCByZWFsQ29udGV4dCk7CiAgfQogIHJldHVybiByZWFsQ29udGV4dDsKfQp2YXIgUmVhY3RSZWR1eENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gZ2V0Q29udGV4dCgpOwpmdW5jdGlvbiBQcm92aWRlcihwcm92aWRlclByb3BzKSB7CiAgY29uc3QgeyBjaGlsZHJlbiwgY29udGV4dCwgc2VydmVyU3RhdGUsIHN0b3JlIH0gPSBwcm92aWRlclByb3BzOwogIGNvbnN0IGNvbnRleHRWYWx1ZSA9IFJlYWN0MjYudXNlTWVtbygoKSA9PiB7CiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBjcmVhdGVTdWJzY3JpcHRpb24oc3RvcmUpOwogICAgY29uc3QgYmFzZUNvbnRleHRWYWx1ZSA9IHsKICAgICAgc3RvcmUsCiAgICAgIHN1YnNjcmlwdGlvbiwKICAgICAgZ2V0U2VydmVyU3RhdGU6IHNlcnZlclN0YXRlID8gKCkgPT4gc2VydmVyU3RhdGUgOiB2b2lkIDAKICAgIH07CiAgICBpZiAoZmFsc2UpIHsKICAgICAgcmV0dXJuIGJhc2VDb250ZXh0VmFsdWU7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9ICJvbmNlIiwgc3RhYmlsaXR5Q2hlY2sgPSAib25jZSIgfSA9IHByb3ZpZGVyUHJvcHM7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmFzc2lnbihiYXNlQ29udGV4dFZhbHVlLCB7CiAgICAgICAgc3RhYmlsaXR5Q2hlY2ssCiAgICAgICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrCiAgICAgIH0pOwogICAgfQogIH0sIFtzdG9yZSwgc2VydmVyU3RhdGVdKTsKICBjb25zdCBwcmV2aW91c1N0YXRlID0gUmVhY3QyNi51c2VNZW1vKCgpID0+IHN0b3JlLmdldFN0YXRlKCksIFtzdG9yZV0pOwogIHVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoKCkgPT4gewogICAgY29uc3QgeyBzdWJzY3JpcHRpb24gfSA9IGNvbnRleHRWYWx1ZTsKICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gc3Vic2NyaXB0aW9uLm5vdGlmeU5lc3RlZFN1YnM7CiAgICBzdWJzY3JpcHRpb24udHJ5U3Vic2NyaWJlKCk7CiAgICBpZiAocHJldmlvdXNTdGF0ZSAhPT0gc3RvcmUuZ2V0U3RhdGUoKSkgewogICAgICBzdWJzY3JpcHRpb24ubm90aWZ5TmVzdGVkU3VicygpOwogICAgfQogICAgcmV0dXJuICgpID0+IHsKICAgICAgc3Vic2NyaXB0aW9uLnRyeVVuc3Vic2NyaWJlKCk7CiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gdm9pZCAwOwogICAgfTsKICB9LCBbY29udGV4dFZhbHVlLCBwcmV2aW91c1N0YXRlXSk7CiAgY29uc3QgQ29udGV4dCA9IGNvbnRleHQgfHwgUmVhY3RSZWR1eENvbnRleHQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQ29udGV4dC5Qcm92aWRlciwgeyB2YWx1ZTogY29udGV4dFZhbHVlIH0sIGNoaWxkcmVuKTsKfQp2YXIgUHJvdmlkZXJfZGVmYXVsdCA9IFByb3ZpZGVyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3Byb3BzQXJlRXF1YWwuanMKdmFyIHByb3BzVG9TaGFsbG93Q29tcGFyZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsiYXhpc0xpbmUiLCAidGlja0xpbmUiLCAiYWN0aXZlQmFyIiwgImFjdGl2ZURvdCIsICJhY3RpdmVMYWJlbCIsICJhY3RpdmVTaGFwZSIsICJhbGxvd0VzY2FwZVZpZXdCb3giLCAiYmFja2dyb3VuZCIsICJjdXJzb3IiLCAiZG90IiwgImxhYmVsIiwgImxpbmUiLCAibWFyZ2luIiwgInBhZGRpbmciLCAicG9zaXRpb24iLCAic2hhcGUiLCAic3R5bGUiLCAidGljayIsICJ3cmFwcGVyU3R5bGUiXSk7CmZ1bmN0aW9uIHNhbWVWYWx1ZVplcm8oeDIsIHkyKSB7CiAgaWYgKHgyID09IG51bGwgJiYgeTIgPT0gbnVsbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmICh0eXBlb2YgeDIgPT09ICJudW1iZXIiICYmIHR5cGVvZiB5MiA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiB4MiA9PT0geTIgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9CiAgcmV0dXJuIHgyID09PSB5MjsKfQpmdW5jdGlvbiBwcm9wc0FyZUVxdWFsKHByZXZQcm9wcywgbmV4dFByb3BzKSB7CiAgdmFyIGFsbEtleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbLi4uT2JqZWN0LmtleXMocHJldlByb3BzKSwgLi4uT2JqZWN0LmtleXMobmV4dFByb3BzKV0pOwogIGZvciAodmFyIGtleSBvZiBhbGxLZXlzKSB7CiAgICBpZiAocHJvcHNUb1NoYWxsb3dDb21wYXJlLmhhcyhrZXkpKSB7CiAgICAgIGlmIChwcmV2UHJvcHNba2V5XSA9PSBudWxsICYmIG5leHRQcm9wc1trZXldID09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoIXNoYWxsb3dFcXVhbChwcmV2UHJvcHNba2V5XSwgbmV4dFByb3BzW2tleV0pKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCFzYW1lVmFsdWVaZXJvKHByZXZQcm9wc1trZXldLCBuZXh0UHJvcHNba2V5XSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2NoYXJ0RGF0YUNvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDM4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgQ2hhcnREYXRhQ29udGV4dFByb3ZpZGVyID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YQogIH0gPSBwcm9wczsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogICgwLCBpbXBvcnRfcmVhY3QzOC51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChpc1Bhbm9yYW1hKSB7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgIH07CiAgICB9CiAgICBkaXNwYXRjaChzZXRDaGFydERhdGEoY2hhcnREYXRhKSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaChzZXRDaGFydERhdGEodm9pZCAwKSk7CiAgICB9OwogIH0sIFtjaGFydERhdGEsIGRpc3BhdGNoLCBpc1Bhbm9yYW1hXSk7CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2JydXNoU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTEwID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgcGFkZGluZzogewogICAgdG9wOiAwLAogICAgcmlnaHQ6IDAsCiAgICBib3R0b206IDAsCiAgICBsZWZ0OiAwCiAgfQp9Owp2YXIgYnJ1c2hTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiYnJ1c2giLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTAsCiAgcmVkdWNlcnM6IHsKICAgIHNldEJydXNoU2V0dGluZ3MoX3N0YXRlLCBhY3Rpb24pIHsKICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkID09IG51bGwpIHsKICAgICAgICByZXR1cm4gaW5pdGlhbFN0YXRlMTA7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0QnJ1c2hTZXR0aW5ncwp9ID0gYnJ1c2hTbGljZS5hY3Rpb25zOwp2YXIgYnJ1c2hSZWR1Y2VyID0gYnJ1c2hTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NhcnRlc2lhblV0aWxzLmpzCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBTY2FsZUhlbHBlciA9IGNsYXNzIF9TY2FsZUhlbHBlciB7CiAgc3RhdGljIGNyZWF0ZShvYmopIHsKICAgIHJldHVybiBuZXcgX1NjYWxlSGVscGVyKG9iaik7CiAgfQogIGNvbnN0cnVjdG9yKHNjYWxlKSB7CiAgICB0aGlzLnNjYWxlID0gc2NhbGU7CiAgfQogIGdldCBkb21haW4oKSB7CiAgICByZXR1cm4gdGhpcy5zY2FsZS5kb21haW47CiAgfQogIGdldCByYW5nZSgpIHsKICAgIHJldHVybiB0aGlzLnNjYWxlLnJhbmdlOwogIH0KICBnZXQgcmFuZ2VNaW4oKSB7CiAgICByZXR1cm4gdGhpcy5yYW5nZSgpWzBdOwogIH0KICBnZXQgcmFuZ2VNYXgoKSB7CiAgICByZXR1cm4gdGhpcy5yYW5nZSgpWzFdOwogIH0KICBnZXQgYmFuZHdpZHRoKCkgewogICAgcmV0dXJuIHRoaXMuc2NhbGUuYmFuZHdpZHRoOwogIH0KICBhcHBseSh2YWx1ZSkgewogICAgdmFyIHsKICAgICAgYmFuZEF3YXJlLAogICAgICBwb3NpdGlvbgogICAgfSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDoge307CiAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgaWYgKHBvc2l0aW9uKSB7CiAgICAgIHN3aXRjaCAocG9zaXRpb24pIHsKICAgICAgICBjYXNlICJzdGFydCI6IHsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgY2FzZSAibWlkZGxlIjogewogICAgICAgICAgdmFyIG9mZnNldCA9IHRoaXMuYmFuZHdpZHRoID8gdGhpcy5iYW5kd2lkdGgoKSAvIDIgOiAwOwogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpICsgb2Zmc2V0OwogICAgICAgIH0KICAgICAgICBjYXNlICJlbmQiOiB7CiAgICAgICAgICB2YXIgX29mZnNldCA9IHRoaXMuYmFuZHdpZHRoID8gdGhpcy5iYW5kd2lkdGgoKSA6IDA7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSkgKyBfb2Zmc2V0OwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoYmFuZEF3YXJlKSB7CiAgICAgIHZhciBfb2Zmc2V0MiA9IHRoaXMuYmFuZHdpZHRoID8gdGhpcy5iYW5kd2lkdGgoKSAvIDIgOiAwOwogICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSkgKyBfb2Zmc2V0MjsKICAgIH0KICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKTsKICB9CiAgaXNJblJhbmdlKHZhbHVlKSB7CiAgICB2YXIgcmFuZ2U0ID0gdGhpcy5yYW5nZSgpOwogICAgdmFyIGZpcnN0ID0gcmFuZ2U0WzBdOwogICAgdmFyIGxhc3QyID0gcmFuZ2U0W3JhbmdlNC5sZW5ndGggLSAxXTsKICAgIHJldHVybiBmaXJzdCA8PSBsYXN0MiA/IHZhbHVlID49IGZpcnN0ICYmIHZhbHVlIDw9IGxhc3QyIDogdmFsdWUgPj0gbGFzdDIgJiYgdmFsdWUgPD0gZmlyc3Q7CiAgfQp9OwpfZGVmaW5lUHJvcGVydHkzMyhTY2FsZUhlbHBlciwgIkVQUyIsIDFlLTQpOwpmdW5jdGlvbiBub3JtYWxpemVBbmdsZShhbmdsZSkgewogIHJldHVybiAoYW5nbGUgJSAxODAgKyAxODApICUgMTgwOwp9CnZhciBnZXRBbmdsZWRSZWN0YW5nbGVXaWR0aCA9IGZ1bmN0aW9uIGdldEFuZ2xlZFJlY3RhbmdsZVdpZHRoMihfcmVmNSkgewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBfcmVmNTsKICB2YXIgYW5nbGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IDA7CiAgdmFyIG5vcm1hbGl6ZWRBbmdsZSA9IG5vcm1hbGl6ZUFuZ2xlKGFuZ2xlKTsKICB2YXIgYW5nbGVSYWRpYW5zID0gbm9ybWFsaXplZEFuZ2xlICogTWF0aC5QSSAvIDE4MDsKICB2YXIgYW5nbGVUaHJlc2hvbGQgPSBNYXRoLmF0YW4oaGVpZ2h0IC8gd2lkdGgpOwogIHZhciBhbmdsZWRXaWR0aCA9IGFuZ2xlUmFkaWFucyA+IGFuZ2xlVGhyZXNob2xkICYmIGFuZ2xlUmFkaWFucyA8IE1hdGguUEkgLSBhbmdsZVRocmVzaG9sZCA/IGhlaWdodCAvIE1hdGguc2luKGFuZ2xlUmFkaWFucykgOiB3aWR0aCAvIE1hdGguY29zKGFuZ2xlUmFkaWFucyk7CiAgcmV0dXJuIE1hdGguYWJzKGFuZ2xlZFdpZHRoKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcmVmZXJlbmNlRWxlbWVudHNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlMTEgPSB7CiAgZG90czogW10sCiAgYXJlYXM6IFtdLAogIGxpbmVzOiBbXQp9Owp2YXIgcmVmZXJlbmNlRWxlbWVudHNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicmVmZXJlbmNlRWxlbWVudHMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTEsCiAgcmVkdWNlcnM6IHsKICAgIGFkZERvdDogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUuZG90cy5wdXNoKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVEb3Q6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmRvdHMuZmluZEluZGV4KChkb3QpID0+IGRvdCA9PT0gYWN0aW9uLnBheWxvYWQpOwogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgc3RhdGUuZG90cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9LAogICAgYWRkQXJlYTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUuYXJlYXMucHVzaChhY3Rpb24ucGF5bG9hZCk7CiAgICB9LAogICAgcmVtb3ZlQXJlYTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuYXJlYXMuZmluZEluZGV4KChhcmVhKSA9PiBhcmVhID09PSBhY3Rpb24ucGF5bG9hZCk7CiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICBzdGF0ZS5hcmVhcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9LAogICAgYWRkTGluZTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUubGluZXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgIH0sCiAgICByZW1vdmVMaW5lOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5saW5lcy5maW5kSW5kZXgoKGxpbmUpID0+IGxpbmUgPT09IGFjdGlvbi5wYXlsb2FkKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHN0YXRlLmxpbmVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZERvdCwKICByZW1vdmVEb3QsCiAgYWRkQXJlYSwKICByZW1vdmVBcmVhLAogIGFkZExpbmUsCiAgcmVtb3ZlTGluZQp9ID0gcmVmZXJlbmNlRWxlbWVudHNTbGljZS5hY3Rpb25zOwp2YXIgcmVmZXJlbmNlRWxlbWVudHNSZWR1Y2VyID0gcmVmZXJlbmNlRWxlbWVudHNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvQ2xpcFBhdGhQcm92aWRlci5qcwp2YXIgUmVhY3QyNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgQ2xpcFBhdGhJZENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM5LmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBDbGlwUGF0aFByb3ZpZGVyID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBbY2xpcFBhdGhJZF0gPSAoMCwgaW1wb3J0X3JlYWN0MzkudXNlU3RhdGUpKCIiLmNvbmNhdCh1bmlxdWVJZCgicmVjaGFydHMiKSwgIi1jbGlwIikpOwogIHZhciBwbG90QXJlYSA9IHVzZVBsb3RBcmVhKCk7CiAgaWYgKHBsb3RBcmVhID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHBsb3RBcmVhOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KENsaXBQYXRoSWRDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogY2xpcFBhdGhJZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgIGlkOiBjbGlwUGF0aElkCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICBoZWlnaHQsCiAgICB3aWR0aAogIH0pKSksIGNoaWxkcmVuKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0NhcnRlc2lhbkF4aXMuanMKdmFyIFJlYWN0MjggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0MCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9nZXQ1ID0gX190b0VTTShyZXF1aXJlX2dldDIoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uLmpzCmZ1bmN0aW9uIGdldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbihhcnJheSwgbikgewogIGlmIChuIDwgMSkgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAobiA9PT0gMSkgewogICAgcmV0dXJuIGFycmF5OwogIH0KICB2YXIgcmVzdWx0ID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkgKz0gbikgewogICAgcmVzdWx0LnB1c2goYXJyYXlbaV0pOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvVGlja1V0aWxzLmpzCmZ1bmN0aW9uIGdldEFuZ2xlZFRpY2tXaWR0aChjb250ZW50U2l6ZSwgdW5pdFNpemUsIGFuZ2xlKSB7CiAgdmFyIHNpemUgPSB7CiAgICB3aWR0aDogY29udGVudFNpemUud2lkdGggKyB1bml0U2l6ZS53aWR0aCwKICAgIGhlaWdodDogY29udGVudFNpemUuaGVpZ2h0ICsgdW5pdFNpemUuaGVpZ2h0CiAgfTsKICByZXR1cm4gZ2V0QW5nbGVkUmVjdGFuZ2xlV2lkdGgoc2l6ZSwgYW5nbGUpOwp9CmZ1bmN0aW9uIGdldFRpY2tCb3VuZGFyaWVzKHZpZXdCb3gsIHNpZ24yLCBzaXplS2V5KSB7CiAgdmFyIGlzV2lkdGggPSBzaXplS2V5ID09PSAid2lkdGgiOwogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gdmlld0JveDsKICBpZiAoc2lnbjIgPT09IDEpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBpc1dpZHRoID8geDIgOiB5MiwKICAgICAgZW5kOiBpc1dpZHRoID8geDIgKyB3aWR0aCA6IHkyICsgaGVpZ2h0CiAgICB9OwogIH0KICByZXR1cm4gewogICAgc3RhcnQ6IGlzV2lkdGggPyB4MiArIHdpZHRoIDogeTIgKyBoZWlnaHQsCiAgICBlbmQ6IGlzV2lkdGggPyB4MiA6IHkyCiAgfTsKfQpmdW5jdGlvbiBpc1Zpc2libGUoc2lnbjIsIHRpY2tQb3NpdGlvbiwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCkgewogIGlmIChzaWduMiAqIHRpY2tQb3NpdGlvbiA8IHNpZ24yICogc3RhcnQgfHwgc2lnbjIgKiB0aWNrUG9zaXRpb24gPiBzaWduMiAqIGVuZCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgc2l6ZSA9IGdldFNpemUoKTsKICByZXR1cm4gc2lnbjIgKiAodGlja1Bvc2l0aW9uIC0gc2lnbjIgKiBzaXplIC8gMiAtIHN0YXJ0KSA+PSAwICYmIHNpZ24yICogKHRpY2tQb3NpdGlvbiArIHNpZ24yICogc2l6ZSAvIDIgLSBlbmQpIDw9IDA7Cn0KZnVuY3Rpb24gZ2V0TnVtYmVySW50ZXJ2YWxUaWNrcyh0aWNrczIsIGludGVydmFsKSB7CiAgcmV0dXJuIGdldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbih0aWNrczIsIGludGVydmFsICsgMSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL2dldEVxdWlkaXN0YW50VGlja3MuanMKZnVuY3Rpb24gZ2V0RXF1aWRpc3RhbnRUaWNrcyhzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCkgewogIHZhciByZXN1bHQgPSAodGlja3MyIHx8IFtdKS5zbGljZSgpOwogIHZhciB7CiAgICBzdGFydDogaW5pdGlhbFN0YXJ0LAogICAgZW5kCiAgfSA9IGJvdW5kYXJpZXM7CiAgdmFyIGluZGV4ID0gMDsKICB2YXIgc3RlcHNpemUgPSAxOwogIHZhciBzdGFydCA9IGluaXRpYWxTdGFydDsKICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcDIoKSB7CiAgICB2YXIgZW50cnkgPSB0aWNrczIgPT09IG51bGwgfHwgdGlja3MyID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0aWNrczJbaW5kZXhdOwogICAgaWYgKGVudHJ5ID09PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2OiBnZXRFdmVyeU50aFdpdGhDb25kaXRpb24odGlja3MyLCBzdGVwc2l6ZSkKICAgICAgfTsKICAgIH0KICAgIHZhciBpID0gaW5kZXg7CiAgICB2YXIgc2l6ZTsKICAgIHZhciBnZXRTaXplID0gKCkgPT4gewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IGdldFRpY2tTaXplKGVudHJ5LCBpKTsKICAgICAgfQogICAgICByZXR1cm4gc2l6ZTsKICAgIH07CiAgICB2YXIgdGlja0Nvb3JkID0gZW50cnkuY29vcmRpbmF0ZTsKICAgIHZhciBpc1Nob3cgPSBpbmRleCA9PT0gMCB8fCBpc1Zpc2libGUoc2lnbjIsIHRpY2tDb29yZCwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCk7CiAgICBpZiAoIWlzU2hvdykgewogICAgICBpbmRleCA9IDA7CiAgICAgIHN0YXJ0ID0gaW5pdGlhbFN0YXJ0OwogICAgICBzdGVwc2l6ZSArPSAxOwogICAgfQogICAgaWYgKGlzU2hvdykgewogICAgICBzdGFydCA9IHRpY2tDb29yZCArIHNpZ24yICogKGdldFNpemUoKSAvIDIgKyBtaW5UaWNrR2FwKTsKICAgICAgaW5kZXggKz0gc3RlcHNpemU7CiAgICB9CiAgfSwgX3JldDsKICB3aGlsZSAoc3RlcHNpemUgPD0gcmVzdWx0Lmxlbmd0aCkgewogICAgX3JldCA9IF9sb29wKCk7CiAgICBpZiAoX3JldCkgcmV0dXJuIF9yZXQudjsKICB9CiAgcmV0dXJuIFtdOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9nZXRUaWNrcy5qcwpmdW5jdGlvbiBvd25LZXlzMzIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzNChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzQoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzNChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzNCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzNCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzNCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZ2V0VGlja3NFbmQoc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXApIHsKICB2YXIgcmVzdWx0ID0gKHRpY2tzMiB8fCBbXSkuc2xpY2UoKTsKICB2YXIgbGVuID0gcmVzdWx0Lmxlbmd0aDsKICB2YXIgewogICAgc3RhcnQKICB9ID0gYm91bmRhcmllczsKICB2YXIgewogICAgZW5kCiAgfSA9IGJvdW5kYXJpZXM7CiAgdmFyIF9sb29wID0gZnVuY3Rpb24gX2xvb3AyKGkyKSB7CiAgICB2YXIgZW50cnkgPSByZXN1bHRbaTJdOwogICAgdmFyIHNpemU7CiAgICB2YXIgZ2V0U2l6ZSA9ICgpID0+IHsKICAgICAgaWYgKHNpemUgPT09IHZvaWQgMCkgewogICAgICAgIHNpemUgPSBnZXRUaWNrU2l6ZShlbnRyeSwgaTIpOwogICAgICB9CiAgICAgIHJldHVybiBzaXplOwogICAgfTsKICAgIGlmIChpMiA9PT0gbGVuIC0gMSkgewogICAgICB2YXIgZ2FwID0gc2lnbjIgKiAoZW50cnkuY29vcmRpbmF0ZSArIHNpZ24yICogZ2V0U2l6ZSgpIC8gMiAtIGVuZCk7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQzMihfb2JqZWN0U3ByZWFkMzIoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGdhcCA+IDAgPyBlbnRyeS5jb29yZGluYXRlIC0gZ2FwICogc2lnbjIgOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDMyKF9vYmplY3RTcHJlYWQzMih7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0KICAgIGlmIChlbnRyeS50aWNrQ29vcmQgIT0gbnVsbCkgewogICAgICB2YXIgaXNTaG93ID0gaXNWaXNpYmxlKHNpZ24yLCBlbnRyeS50aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaXNTaG93KSB7CiAgICAgICAgZW5kID0gZW50cnkudGlja0Nvb3JkIC0gc2lnbjIgKiAoZ2V0U2l6ZSgpIC8gMiArIG1pblRpY2tHYXApOwogICAgICAgIHJlc3VsdFtpMl0gPSBfb2JqZWN0U3ByZWFkMzIoX29iamVjdFNwcmVhZDMyKHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICBpc1Nob3c6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CiAgZm9yICh2YXIgaSA9IGxlbiAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICBfbG9vcChpKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBnZXRUaWNrc1N0YXJ0KHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwLCBwcmVzZXJ2ZUVuZCkgewogIHZhciByZXN1bHQgPSAodGlja3MyIHx8IFtdKS5zbGljZSgpOwogIHZhciBsZW4gPSByZXN1bHQubGVuZ3RoOwogIHZhciB7CiAgICBzdGFydCwKICAgIGVuZAogIH0gPSBib3VuZGFyaWVzOwogIGlmIChwcmVzZXJ2ZUVuZCkgewogICAgdmFyIHRhaWwgPSB0aWNrczJbbGVuIC0gMV07CiAgICB2YXIgdGFpbFNpemUgPSBnZXRUaWNrU2l6ZSh0YWlsLCBsZW4gLSAxKTsKICAgIHZhciB0YWlsR2FwID0gc2lnbjIgKiAodGFpbC5jb29yZGluYXRlICsgc2lnbjIgKiB0YWlsU2l6ZSAvIDIgLSBlbmQpOwogICAgcmVzdWx0W2xlbiAtIDFdID0gdGFpbCA9IF9vYmplY3RTcHJlYWQzMihfb2JqZWN0U3ByZWFkMzIoe30sIHRhaWwpLCB7fSwgewogICAgICB0aWNrQ29vcmQ6IHRhaWxHYXAgPiAwID8gdGFpbC5jb29yZGluYXRlIC0gdGFpbEdhcCAqIHNpZ24yIDogdGFpbC5jb29yZGluYXRlCiAgICB9KTsKICAgIGlmICh0YWlsLnRpY2tDb29yZCAhPSBudWxsKSB7CiAgICAgIHZhciBpc1RhaWxTaG93ID0gaXNWaXNpYmxlKHNpZ24yLCB0YWlsLnRpY2tDb29yZCwgKCkgPT4gdGFpbFNpemUsIHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaXNUYWlsU2hvdykgewogICAgICAgIGVuZCA9IHRhaWwudGlja0Nvb3JkIC0gc2lnbjIgKiAodGFpbFNpemUgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2xlbiAtIDFdID0gX29iamVjdFNwcmVhZDMyKF9vYmplY3RTcHJlYWQzMih7fSwgdGFpbCksIHt9LCB7CiAgICAgICAgICBpc1Nob3c6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0KICB2YXIgY291bnQgPSBwcmVzZXJ2ZUVuZCA/IGxlbiAtIDEgOiBsZW47CiAgdmFyIF9sb29wMiA9IGZ1bmN0aW9uIF9sb29wMjIoaTIpIHsKICAgIHZhciBlbnRyeSA9IHJlc3VsdFtpMl07CiAgICB2YXIgc2l6ZTsKICAgIHZhciBnZXRTaXplID0gKCkgPT4gewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IGdldFRpY2tTaXplKGVudHJ5LCBpMik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgaWYgKGkyID09PSAwKSB7CiAgICAgIHZhciBnYXAgPSBzaWduMiAqIChlbnRyeS5jb29yZGluYXRlIC0gc2lnbjIgKiBnZXRTaXplKCkgLyAyIC0gc3RhcnQpOwogICAgICByZXN1bHRbaTJdID0gZW50cnkgPSBfb2JqZWN0U3ByZWFkMzIoX29iamVjdFNwcmVhZDMyKHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgdGlja0Nvb3JkOiBnYXAgPCAwID8gZW50cnkuY29vcmRpbmF0ZSAtIGdhcCAqIHNpZ24yIDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQzMihfb2JqZWN0U3ByZWFkMzIoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZW50cnkudGlja0Nvb3JkICE9IG51bGwpIHsKICAgICAgdmFyIGlzU2hvdyA9IGlzVmlzaWJsZShzaWduMiwgZW50cnkudGlja0Nvb3JkLCBnZXRTaXplLCBzdGFydCwgZW5kKTsKICAgICAgaWYgKGlzU2hvdykgewogICAgICAgIHN0YXJ0ID0gZW50cnkudGlja0Nvb3JkICsgc2lnbjIgKiAoZ2V0U2l6ZSgpIC8gMiArIG1pblRpY2tHYXApOwogICAgICAgIHJlc3VsdFtpMl0gPSBfb2JqZWN0U3ByZWFkMzIoX29iamVjdFNwcmVhZDMyKHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICBpc1Nob3c6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICBfbG9vcDIoaSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gZ2V0VGlja3MocHJvcHMsIGZvbnRTaXplLCBsZXR0ZXJTcGFjaW5nKSB7CiAgdmFyIHsKICAgIHRpY2ssCiAgICB0aWNrczogdGlja3MyLAogICAgdmlld0JveCwKICAgIG1pblRpY2tHYXAsCiAgICBvcmllbnRhdGlvbiwKICAgIGludGVydmFsLAogICAgdGlja0Zvcm1hdHRlciwKICAgIHVuaXQ6IHVuaXQyLAogICAgYW5nbGUKICB9ID0gcHJvcHM7CiAgaWYgKCF0aWNrczIgfHwgIXRpY2tzMi5sZW5ndGggfHwgIXRpY2spIHsKICAgIHJldHVybiBbXTsKICB9CiAgaWYgKGlzTnVtYmVyKGludGVydmFsKSB8fCBHbG9iYWwuaXNTc3IpIHsKICAgIHZhciBfZ2V0TnVtYmVySW50ZXJ2YWxUaWM7CiAgICByZXR1cm4gKF9nZXROdW1iZXJJbnRlcnZhbFRpYyA9IGdldE51bWJlckludGVydmFsVGlja3ModGlja3MyLCBpc051bWJlcihpbnRlcnZhbCkgPyBpbnRlcnZhbCA6IDApKSAhPT0gbnVsbCAmJiBfZ2V0TnVtYmVySW50ZXJ2YWxUaWMgIT09IHZvaWQgMCA/IF9nZXROdW1iZXJJbnRlcnZhbFRpYyA6IFtdOwogIH0KICB2YXIgY2FuZGlkYXRlcyA9IFtdOwogIHZhciBzaXplS2V5ID0gb3JpZW50YXRpb24gPT09ICJ0b3AiIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiA/ICJ3aWR0aCIgOiAiaGVpZ2h0IjsKICB2YXIgdW5pdFNpemUgPSB1bml0MiAmJiBzaXplS2V5ID09PSAid2lkdGgiID8gZ2V0U3RyaW5nU2l6ZSh1bml0MiwgewogICAgZm9udFNpemUsCiAgICBsZXR0ZXJTcGFjaW5nCiAgfSkgOiB7CiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMAogIH07CiAgdmFyIGdldFRpY2tTaXplID0gKGNvbnRlbnQsIGluZGV4KSA9PiB7CiAgICB2YXIgdmFsdWUgPSB0eXBlb2YgdGlja0Zvcm1hdHRlciA9PT0gImZ1bmN0aW9uIiA/IHRpY2tGb3JtYXR0ZXIoY29udGVudC52YWx1ZSwgaW5kZXgpIDogY29udGVudC52YWx1ZTsKICAgIHJldHVybiBzaXplS2V5ID09PSAid2lkdGgiID8gZ2V0QW5nbGVkVGlja1dpZHRoKGdldFN0cmluZ1NpemUodmFsdWUsIHsKICAgICAgZm9udFNpemUsCiAgICAgIGxldHRlclNwYWNpbmcKICAgIH0pLCB1bml0U2l6ZSwgYW5nbGUpIDogZ2V0U3RyaW5nU2l6ZSh2YWx1ZSwgewogICAgICBmb250U2l6ZSwKICAgICAgbGV0dGVyU3BhY2luZwogICAgfSlbc2l6ZUtleV07CiAgfTsKICB2YXIgc2lnbjIgPSB0aWNrczIubGVuZ3RoID49IDIgPyBtYXRoU2lnbih0aWNrczJbMV0uY29vcmRpbmF0ZSAtIHRpY2tzMlswXS5jb29yZGluYXRlKSA6IDE7CiAgdmFyIGJvdW5kYXJpZXMgPSBnZXRUaWNrQm91bmRhcmllcyh2aWV3Qm94LCBzaWduMiwgc2l6ZUtleSk7CiAgaWYgKGludGVydmFsID09PSAiZXF1aWRpc3RhbnRQcmVzZXJ2ZVN0YXJ0IikgewogICAgcmV0dXJuIGdldEVxdWlkaXN0YW50VGlja3Moc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXApOwogIH0KICBpZiAoaW50ZXJ2YWwgPT09ICJwcmVzZXJ2ZVN0YXJ0IiB8fCBpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnRFbmQiKSB7CiAgICBjYW5kaWRhdGVzID0gZ2V0VGlja3NTdGFydChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCwgaW50ZXJ2YWwgPT09ICJwcmVzZXJ2ZVN0YXJ0RW5kIik7CiAgfSBlbHNlIHsKICAgIGNhbmRpZGF0ZXMgPSBnZXRUaWNrc0VuZChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCk7CiAgfQogIHJldHVybiBjYW5kaWRhdGVzLmZpbHRlcigoZW50cnkpID0+IGVudHJ5LmlzU2hvdyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9ZQXhpc1V0aWxzLmpzCnZhciBnZXRDYWxjdWxhdGVkWUF4aXNXaWR0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB0aWNrczogdGlja3MyLAogICAgbGFiZWwsCiAgICBsYWJlbEdhcFdpdGhUaWNrID0gNSwKICAgIC8vIERlZmF1bHQgZ2FwIGJldHdlZW4gbGFiZWwgYW5kIHRpY2sKICAgIHRpY2tTaXplID0gMCwKICAgIHRpY2tNYXJnaW4gPSAwCiAgfSA9IF9yZWYyOwogIHZhciBtYXhUaWNrV2lkdGggPSAwOwogIGlmICh0aWNrczIpIHsKICAgIEFycmF5LmZyb20odGlja3MyKS5mb3JFYWNoKCh0aWNrTm9kZSkgPT4gewogICAgICBpZiAodGlja05vZGUpIHsKICAgICAgICB2YXIgYmJveCA9IHRpY2tOb2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIGlmIChiYm94LndpZHRoID4gbWF4VGlja1dpZHRoKSB7CiAgICAgICAgICBtYXhUaWNrV2lkdGggPSBiYm94LndpZHRoOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgbGFiZWxXaWR0aCA9IGxhYmVsID8gbGFiZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggOiAwOwogICAgdmFyIHRpY2tXaWR0aCA9IHRpY2tTaXplICsgdGlja01hcmdpbjsKICAgIHZhciB1cGRhdGVkWUF4aXNXaWR0aCA9IG1heFRpY2tXaWR0aCArIHRpY2tXaWR0aCArIGxhYmVsV2lkdGggKyAobGFiZWwgPyBsYWJlbEdhcFdpdGhUaWNrIDogMCk7CiAgICByZXR1cm4gTWF0aC5yb3VuZCh1cGRhdGVkWUF4aXNXaWR0aCk7CiAgfQogIHJldHVybiAwOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQ2FydGVzaWFuQXhpcy5qcwp2YXIgX2V4Y2x1ZGVkMTMgPSBbImF4aXNMaW5lIiwgIndpZHRoIiwgImhlaWdodCIsICJjbGFzc05hbWUiLCAiaGlkZSIsICJ0aWNrcyIsICJheGlzVHlwZSJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEzKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfZXh0ZW5kczE4KCkgewogIHJldHVybiBfZXh0ZW5kczE4ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxOC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXMzMyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTM1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzNShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTM1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTM1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTM1KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTM1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcyA9IHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIHZpZXdCb3g6IHsKICAgIHg6IDAsCiAgICB5OiAwLAogICAgd2lkdGg6IDAsCiAgICBoZWlnaHQ6IDAKICB9LAogIC8vIFRoZSBvcmllbnRhdGlvbiBvZiBheGlzCiAgb3JpZW50YXRpb246ICJib3R0b20iLAogIC8vIFRoZSB0aWNrcwogIHRpY2tzOiBbXSwKICBzdHJva2U6ICIjNjY2IiwKICB0aWNrTGluZTogdHJ1ZSwKICBheGlzTGluZTogdHJ1ZSwKICB0aWNrOiB0cnVlLAogIG1pcnJvcjogZmFsc2UsCiAgbWluVGlja0dhcDogNSwKICAvLyBUaGUgd2lkdGggb3IgaGVpZ2h0IG9mIHRpY2sKICB0aWNrU2l6ZTogNiwKICB0aWNrTWFyZ2luOiAyLAogIGludGVydmFsOiAicHJlc2VydmVFbmQiLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmF4aXMKfTsKZnVuY3Rpb24gQXhpc0xpbmUoYXhpc0xpbmVQcm9wcykgewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBvcmllbnRhdGlvbiwKICAgIG1pcnJvciwKICAgIGF4aXNMaW5lLAogICAgb3RoZXJTdmdQcm9wcwogIH0gPSBheGlzTGluZVByb3BzOwogIGlmICghYXhpc0xpbmUpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcHJvcHMgPSBfb2JqZWN0U3ByZWFkMzMoX29iamVjdFNwcmVhZDMzKF9vYmplY3RTcHJlYWQzMyh7fSwgb3RoZXJTdmdQcm9wcyksIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhheGlzTGluZSkpLCB7fSwgewogICAgZmlsbDogIm5vbmUiCiAgfSk7CiAgaWYgKG9yaWVudGF0aW9uID09PSAidG9wIiB8fCBvcmllbnRhdGlvbiA9PT0gImJvdHRvbSIpIHsKICAgIHZhciBuZWVkSGVpZ2h0ID0gKyhvcmllbnRhdGlvbiA9PT0gInRvcCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gImJvdHRvbSIgJiYgbWlycm9yKTsKICAgIHByb3BzID0gX29iamVjdFNwcmVhZDMzKF9vYmplY3RTcHJlYWQzMyh7fSwgcHJvcHMpLCB7fSwgewogICAgICB4MTogeDIsCiAgICAgIHkxOiB5MiArIG5lZWRIZWlnaHQgKiBoZWlnaHQsCiAgICAgIHgyOiB4MiArIHdpZHRoLAogICAgICB5MjogeTIgKyBuZWVkSGVpZ2h0ICogaGVpZ2h0CiAgICB9KTsKICB9IGVsc2UgewogICAgdmFyIG5lZWRXaWR0aCA9ICsob3JpZW50YXRpb24gPT09ICJsZWZ0IiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAicmlnaHQiICYmIG1pcnJvcik7CiAgICBwcm9wcyA9IF9vYmplY3RTcHJlYWQzMyhfb2JqZWN0U3ByZWFkMzMoe30sIHByb3BzKSwge30sIHsKICAgICAgeDE6IHgyICsgbmVlZFdpZHRoICogd2lkdGgsCiAgICAgIHkxOiB5MiwKICAgICAgeDI6IHgyICsgbmVlZFdpZHRoICogd2lkdGgsCiAgICAgIHkyOiB5MiArIGhlaWdodAogICAgfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KCJsaW5lIiwgX2V4dGVuZHMxOCh7fSwgcHJvcHMsIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtbGluZSIsICgwLCBpbXBvcnRfZ2V0NS5kZWZhdWx0KShheGlzTGluZSwgImNsYXNzTmFtZSIpKQogIH0pKTsKfQpmdW5jdGlvbiBnZXRUaWNrTGluZUNvb3JkKGRhdGEsIHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgb3JpZW50YXRpb24sIHRpY2tTaXplLCBtaXJyb3IsIHRpY2tNYXJnaW4pIHsKICB2YXIgeDEsIHgyMiwgeTEsIHkyMiwgdHgsIHR5OwogIHZhciBzaWduMiA9IG1pcnJvciA/IC0xIDogMTsKICB2YXIgZmluYWxUaWNrU2l6ZSA9IGRhdGEudGlja1NpemUgfHwgdGlja1NpemU7CiAgdmFyIHRpY2tDb29yZCA9IGlzTnVtYmVyKGRhdGEudGlja0Nvb3JkKSA/IGRhdGEudGlja0Nvb3JkIDogZGF0YS5jb29yZGluYXRlOwogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgInRvcCI6CiAgICAgIHgxID0geDIyID0gZGF0YS5jb29yZGluYXRlOwogICAgICB5MjIgPSB5MiArICshbWlycm9yICogaGVpZ2h0OwogICAgICB5MSA9IHkyMiAtIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHkgPSB5MSAtIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHggPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogICAgY2FzZSAibGVmdCI6CiAgICAgIHkxID0geTIyID0gZGF0YS5jb29yZGluYXRlOwogICAgICB4MjIgPSB4MiArICshbWlycm9yICogd2lkdGg7CiAgICAgIHgxID0geDIyIC0gc2lnbjIgKiBmaW5hbFRpY2tTaXplOwogICAgICB0eCA9IHgxIC0gc2lnbjIgKiB0aWNrTWFyZ2luOwogICAgICB0eSA9IHRpY2tDb29yZDsKICAgICAgYnJlYWs7CiAgICBjYXNlICJyaWdodCI6CiAgICAgIHkxID0geTIyID0gZGF0YS5jb29yZGluYXRlOwogICAgICB4MjIgPSB4MiArICttaXJyb3IgKiB3aWR0aDsKICAgICAgeDEgPSB4MjIgKyBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR4ID0geDEgKyBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR5ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHgxID0geDIyID0gZGF0YS5jb29yZGluYXRlOwogICAgICB5MjIgPSB5MiArICttaXJyb3IgKiBoZWlnaHQ7CiAgICAgIHkxID0geTIyICsgc2lnbjIgKiBmaW5hbFRpY2tTaXplOwogICAgICB0eSA9IHkxICsgc2lnbjIgKiB0aWNrTWFyZ2luOwogICAgICB0eCA9IHRpY2tDb29yZDsKICAgICAgYnJlYWs7CiAgfQogIHJldHVybiB7CiAgICBsaW5lOiB7CiAgICAgIHgxLAogICAgICB5MSwKICAgICAgeDI6IHgyMiwKICAgICAgeTI6IHkyMgogICAgfSwKICAgIHRpY2s6IHsKICAgICAgeDogdHgsCiAgICAgIHk6IHR5CiAgICB9CiAgfTsKfQpmdW5jdGlvbiBnZXRUaWNrVGV4dEFuY2hvcihvcmllbnRhdGlvbiwgbWlycm9yKSB7CiAgc3dpdGNoIChvcmllbnRhdGlvbikgewogICAgY2FzZSAibGVmdCI6CiAgICAgIHJldHVybiBtaXJyb3IgPyAic3RhcnQiIDogImVuZCI7CiAgICBjYXNlICJyaWdodCI6CiAgICAgIHJldHVybiBtaXJyb3IgPyAiZW5kIiA6ICJzdGFydCI7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gIm1pZGRsZSI7CiAgfQp9CmZ1bmN0aW9uIGdldFRpY2tWZXJ0aWNhbEFuY2hvcihvcmllbnRhdGlvbiwgbWlycm9yKSB7CiAgc3dpdGNoIChvcmllbnRhdGlvbikgewogICAgY2FzZSAibGVmdCI6CiAgICBjYXNlICJyaWdodCI6CiAgICAgIHJldHVybiAibWlkZGxlIjsKICAgIGNhc2UgInRvcCI6CiAgICAgIHJldHVybiBtaXJyb3IgPyAic3RhcnQiIDogImVuZCI7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gbWlycm9yID8gImVuZCIgOiAic3RhcnQiOwogIH0KfQpmdW5jdGlvbiBUaWNrSXRlbShwcm9wcykgewogIHZhciB7CiAgICBvcHRpb24sCiAgICB0aWNrUHJvcHMsCiAgICB2YWx1ZQogIH0gPSBwcm9wczsKICB2YXIgdGlja0l0ZW07CiAgdmFyIGNvbWJpbmVkQ2xhc3NOYW1lID0gY2xzeCh0aWNrUHJvcHMuY2xhc3NOYW1lLCAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay12YWx1ZSIpOwogIGlmICgvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5pc1ZhbGlkRWxlbWVudChvcHRpb24pKSB7CiAgICB0aWNrSXRlbSA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNsb25lRWxlbWVudChvcHRpb24sIF9vYmplY3RTcHJlYWQzMyhfb2JqZWN0U3ByZWFkMzMoe30sIHRpY2tQcm9wcyksIHt9LCB7CiAgICAgIGNsYXNzTmFtZTogY29tYmluZWRDbGFzc05hbWUKICAgIH0pKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIHRpY2tJdGVtID0gb3B0aW9uKF9vYmplY3RTcHJlYWQzMyhfb2JqZWN0U3ByZWFkMzMoe30sIHRpY2tQcm9wcyksIHt9LCB7CiAgICAgIGNsYXNzTmFtZTogY29tYmluZWRDbGFzc05hbWUKICAgIH0pKTsKICB9IGVsc2UgewogICAgdmFyIGNsYXNzTmFtZSA9ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLXZhbHVlIjsKICAgIGlmICh0eXBlb2Ygb3B0aW9uICE9PSAiYm9vbGVhbiIpIHsKICAgICAgY2xhc3NOYW1lID0gY2xzeChjbGFzc05hbWUsIG9wdGlvbiA9PT0gbnVsbCB8fCBvcHRpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbi5jbGFzc05hbWUpOwogICAgfQogICAgdGlja0l0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KFRleHQsIF9leHRlbmRzMTgoe30sIHRpY2tQcm9wcywgewogICAgICBjbGFzc05hbWUKICAgIH0pLCB2YWx1ZSk7CiAgfQogIHJldHVybiB0aWNrSXRlbTsKfQp2YXIgVGlja3MgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQwLmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHRpY2tzOiB0aWNrczIgPSBbXSwKICAgIHRpY2ssCiAgICB0aWNrTGluZSwKICAgIHN0cm9rZSwKICAgIHRpY2tGb3JtYXR0ZXIsCiAgICB1bml0OiB1bml0MiwKICAgIHBhZGRpbmcsCiAgICB0aWNrVGV4dFByb3BzLAogICAgb3JpZW50YXRpb24sCiAgICBtaXJyb3IsCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB0aWNrU2l6ZSwKICAgIHRpY2tNYXJnaW4sCiAgICBmb250U2l6ZSwKICAgIGxldHRlclNwYWNpbmcsCiAgICBnZXRUaWNrc0NvbmZpZywKICAgIGV2ZW50cywKICAgIGF4aXNUeXBlCiAgfSA9IHByb3BzOwogIHZhciBmaW5hbFRpY2tzID0gZ2V0VGlja3MoX29iamVjdFNwcmVhZDMzKF9vYmplY3RTcHJlYWQzMyh7fSwgZ2V0VGlja3NDb25maWcpLCB7fSwgewogICAgdGlja3M6IHRpY2tzMgogIH0pLCBmb250U2l6ZSwgbGV0dGVyU3BhY2luZyk7CiAgdmFyIHRleHRBbmNob3IgPSBnZXRUaWNrVGV4dEFuY2hvcihvcmllbnRhdGlvbiwgbWlycm9yKTsKICB2YXIgdmVydGljYWxBbmNob3IgPSBnZXRUaWNrVmVydGljYWxBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcik7CiAgdmFyIGF4aXNQcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhnZXRUaWNrc0NvbmZpZyk7CiAgdmFyIGN1c3RvbVRpY2tQcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKHRpY2spOwogIHZhciB0aWNrTGluZVByb3BzT2JqZWN0ID0ge307CiAgaWYgKHR5cGVvZiB0aWNrTGluZSA9PT0gIm9iamVjdCIpIHsKICAgIHRpY2tMaW5lUHJvcHNPYmplY3QgPSB0aWNrTGluZTsKICB9CiAgdmFyIHRpY2tMaW5lUHJvcHMgPSBfb2JqZWN0U3ByZWFkMzMoX29iamVjdFNwcmVhZDMzKHt9LCBheGlzUHJvcHMpLCB7fSwgewogICAgZmlsbDogIm5vbmUiCiAgfSwgdGlja0xpbmVQcm9wc09iamVjdCk7CiAgdmFyIHRpY2tMaW5lQ29vcmRzID0gZmluYWxUaWNrcy5tYXAoKGVudHJ5KSA9PiBfb2JqZWN0U3ByZWFkMzMoewogICAgZW50cnkKICB9LCBnZXRUaWNrTGluZUNvb3JkKGVudHJ5LCB4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIG9yaWVudGF0aW9uLCB0aWNrU2l6ZSwgbWlycm9yLCB0aWNrTWFyZ2luKSkpOwogIHZhciB0aWNrTGluZXMgPSB0aWNrTGluZUNvb3Jkcy5tYXAoKF9yZWYyKSA9PiB7CiAgICB2YXIgewogICAgICBlbnRyeSwKICAgICAgbGluZTogbGluZUNvb3JkCiAgICB9ID0gX3JlZjI7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChMYXllciwgewogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrIiwKICAgICAga2V5OiAidGljay0iLmNvbmNhdChlbnRyeS52YWx1ZSwgIi0iKS5jb25jYXQoZW50cnkuY29vcmRpbmF0ZSwgIi0iKS5jb25jYXQoZW50cnkudGlja0Nvb3JkKQogICAgfSwgdGlja0xpbmUgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudCgibGluZSIsIF9leHRlbmRzMTgoe30sIHRpY2tMaW5lUHJvcHMsIGxpbmVDb29yZCwgewogICAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stbGluZSIsICgwLCBpbXBvcnRfZ2V0NS5kZWZhdWx0KSh0aWNrTGluZSwgImNsYXNzTmFtZSIpKQogICAgfSkpKTsKICB9KTsKICB2YXIgdGlja0xhYmVscyA9IHRpY2tMaW5lQ29vcmRzLm1hcCgoX3JlZjIsIGkpID0+IHsKICAgIHZhciB7CiAgICAgIGVudHJ5LAogICAgICB0aWNrOiB0aWNrQ29vcmQKICAgIH0gPSBfcmVmMjsKICAgIHZhciB0aWNrUHJvcHMgPSBfb2JqZWN0U3ByZWFkMzMoX29iamVjdFNwcmVhZDMzKF9vYmplY3RTcHJlYWQzMyhfb2JqZWN0U3ByZWFkMzMoewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHRleHRBbmNob3IgZnJvbSBheGlzUHJvcHMgaXMgdHlwZWQgYXMgYHN0cmluZ2AgYnV0IFRleHQgd2FudHMgdHlwZSBgVGV4dEFuY2hvcmAKICAgICAgdGV4dEFuY2hvciwKICAgICAgdmVydGljYWxBbmNob3IKICAgIH0sIGF4aXNQcm9wcyksIHt9LCB7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgY3VzdG9tVGlja1Byb3BzIGlzIGNvbnRyaWJ1dGluZyB1bmtub3duIHByb3BzCiAgICAgIHN0cm9rZTogIm5vbmUiLAogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGN1c3RvbVRpY2tQcm9wcyBpcyBjb250cmlidXRpbmcgdW5rbm93biBwcm9wcwogICAgICBmaWxsOiBzdHJva2UKICAgIH0sIGN1c3RvbVRpY2tQcm9wcyksIHRpY2tDb29yZCksIHt9LCB7CiAgICAgIGluZGV4OiBpLAogICAgICBwYXlsb2FkOiBlbnRyeSwKICAgICAgdmlzaWJsZVRpY2tzQ291bnQ6IGZpbmFsVGlja3MubGVuZ3RoLAogICAgICB0aWNrRm9ybWF0dGVyLAogICAgICBwYWRkaW5nCiAgICB9LCB0aWNrVGV4dFByb3BzKTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KExheWVyLCBfZXh0ZW5kczE4KHsKICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay1sYWJlbCIsCiAgICAgIGtleTogInRpY2stbGFiZWwtIi5jb25jYXQoZW50cnkudmFsdWUsICItIikuY29uY2F0KGVudHJ5LmNvb3JkaW5hdGUsICItIikuY29uY2F0KGVudHJ5LnRpY2tDb29yZCkKICAgIH0sIGFkYXB0RXZlbnRzT2ZDaGlsZChldmVudHMsIGVudHJ5LCBpKSksIHRpY2sgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChUaWNrSXRlbSwgewogICAgICBvcHRpb246IHRpY2ssCiAgICAgIHRpY2tQcm9wcywKICAgICAgdmFsdWU6ICIiLmNvbmNhdCh0eXBlb2YgdGlja0Zvcm1hdHRlciA9PT0gImZ1bmN0aW9uIiA/IHRpY2tGb3JtYXR0ZXIoZW50cnkudmFsdWUsIGkpIDogZW50cnkudmFsdWUpLmNvbmNhdCh1bml0MiB8fCAiIikKICAgIH0pKTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2tzIHJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiLXRpY2tzIikKICB9LCB0aWNrTGFiZWxzLmxlbmd0aCA+IDAgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMubGFiZWwKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay1sYWJlbHMgcmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICItdGljay1sYWJlbHMiKSwKICAgIHJlZgogIH0sIHRpY2tMYWJlbHMpKSwgdGlja0xpbmVzLmxlbmd0aCA+IDAgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stbGluZXMgcmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICItdGljay1saW5lcyIpCiAgfSwgdGlja0xpbmVzKSk7Cn0pOwp2YXIgQ2FydGVzaWFuQXhpc0NvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDAuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgYXhpc0xpbmUsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGNsYXNzTmFtZSwKICAgIGhpZGUsCiAgICB0aWNrczogdGlja3MyLAogICAgYXhpc1R5cGUKICB9ID0gcHJvcHMsIHJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhwcm9wcywgX2V4Y2x1ZGVkMTMpOwogIHZhciBbZm9udFNpemUsIHNldEZvbnRTaXplXSA9ICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VTdGF0ZSkoIiIpOwogIHZhciBbbGV0dGVyU3BhY2luZywgc2V0TGV0dGVyU3BhY2luZ10gPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlU3RhdGUpKCIiKTsKICB2YXIgdGlja1JlZnMgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0NDAudXNlSW1wZXJhdGl2ZUhhbmRsZSkocmVmLCAoKSA9PiAoewogICAgZ2V0Q2FsY3VsYXRlZFdpZHRoOiAoKSA9PiB7CiAgICAgIHZhciBfcHJvcHMkbGFiZWxSZWY7CiAgICAgIHJldHVybiBnZXRDYWxjdWxhdGVkWUF4aXNXaWR0aCh7CiAgICAgICAgdGlja3M6IHRpY2tSZWZzLmN1cnJlbnQsCiAgICAgICAgbGFiZWw6IChfcHJvcHMkbGFiZWxSZWYgPSBwcm9wcy5sYWJlbFJlZikgPT09IG51bGwgfHwgX3Byb3BzJGxhYmVsUmVmID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfcHJvcHMkbGFiZWxSZWYuY3VycmVudCwKICAgICAgICBsYWJlbEdhcFdpdGhUaWNrOiA1LAogICAgICAgIHRpY2tTaXplOiBwcm9wcy50aWNrU2l6ZSwKICAgICAgICB0aWNrTWFyZ2luOiBwcm9wcy50aWNrTWFyZ2luCiAgICAgIH0pOwogICAgfQogIH0pKTsKICB2YXIgbGF5ZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlQ2FsbGJhY2spKChlbCkgPT4gewogICAgaWYgKGVsKSB7CiAgICAgIHZhciB0aWNrTm9kZXMgPSBlbC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLXZhbHVlIik7CiAgICAgIHRpY2tSZWZzLmN1cnJlbnQgPSB0aWNrTm9kZXM7CiAgICAgIHZhciB0aWNrID0gdGlja05vZGVzWzBdOwogICAgICBpZiAodGljaykgewogICAgICAgIHZhciBjb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGljayk7CiAgICAgICAgdmFyIGNhbGN1bGF0ZWRGb250U2l6ZSA9IGNvbXB1dGVkU3R5bGUuZm9udFNpemU7CiAgICAgICAgdmFyIGNhbGN1bGF0ZWRMZXR0ZXJTcGFjaW5nID0gY29tcHV0ZWRTdHlsZS5sZXR0ZXJTcGFjaW5nOwogICAgICAgIGlmIChjYWxjdWxhdGVkRm9udFNpemUgIT09IGZvbnRTaXplIHx8IGNhbGN1bGF0ZWRMZXR0ZXJTcGFjaW5nICE9PSBsZXR0ZXJTcGFjaW5nKSB7CiAgICAgICAgICBzZXRGb250U2l6ZShjYWxjdWxhdGVkRm9udFNpemUpOwogICAgICAgICAgc2V0TGV0dGVyU3BhY2luZyhjYWxjdWxhdGVkTGV0dGVyU3BhY2luZyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgW2ZvbnRTaXplLCBsZXR0ZXJTcGFjaW5nXSk7CiAgaWYgKGhpZGUpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAod2lkdGggIT0gbnVsbCAmJiB3aWR0aCA8PSAwIHx8IGhlaWdodCAhPSBudWxsICYmIGhlaWdodCA8PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogcHJvcHMuekluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChMYXllciwgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcyIsIGNsYXNzTmFtZSkKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KEF4aXNMaW5lLCB7CiAgICB4OiBwcm9wcy54LAogICAgeTogcHJvcHMueSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBheGlzTGluZSwKICAgIG90aGVyU3ZnUHJvcHM6IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wcykKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChUaWNrcywgewogICAgcmVmOiBsYXllclJlZiwKICAgIGF4aXNUeXBlLAogICAgZXZlbnRzOiByZXN0LAogICAgZm9udFNpemUsCiAgICBnZXRUaWNrc0NvbmZpZzogcHJvcHMsCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGxldHRlclNwYWNpbmcsCiAgICBtaXJyb3I6IHByb3BzLm1pcnJvciwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIHBhZGRpbmc6IHByb3BzLnBhZGRpbmcsCiAgICBzdHJva2U6IHByb3BzLnN0cm9rZSwKICAgIHRpY2s6IHByb3BzLnRpY2ssCiAgICB0aWNrRm9ybWF0dGVyOiBwcm9wcy50aWNrRm9ybWF0dGVyLAogICAgdGlja0xpbmU6IHByb3BzLnRpY2tMaW5lLAogICAgdGlja01hcmdpbjogcHJvcHMudGlja01hcmdpbiwKICAgIHRpY2tTaXplOiBwcm9wcy50aWNrU2l6ZSwKICAgIHRpY2tUZXh0UHJvcHM6IHByb3BzLnRpY2tUZXh0UHJvcHMsCiAgICB0aWNrczogdGlja3MyLAogICAgdW5pdDogcHJvcHMudW5pdCwKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIHg6IHByb3BzLngsCiAgICB5OiBwcm9wcy55CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxDb250ZXh0UHJvdmlkZXIsIHsKICAgIHg6IHByb3BzLngsCiAgICB5OiBwcm9wcy55LAogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgaGVpZ2h0OiBwcm9wcy5oZWlnaHQsCiAgICBsb3dlcldpZHRoOiBwcm9wcy53aWR0aCwKICAgIHVwcGVyV2lkdGg6IHByb3BzLndpZHRoCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbEZyb21MYWJlbFByb3AsIHsKICAgIGxhYmVsOiBwcm9wcy5sYWJlbCwKICAgIGxhYmVsUmVmOiBwcm9wcy5sYWJlbFJlZgogIH0pLCBwcm9wcy5jaGlsZHJlbikpKTsKfSk7CnZhciBDYXJ0ZXNpYW5BeGlzID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjguZm9yd2FyZFJlZigob3V0c2lkZVByb3BzLCByZWYpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuQXhpc0NvbXBvbmVudCwgX2V4dGVuZHMxOCh7fSwgcHJvcHMsIHsKICAgIHJlZgogIH0pKTsKfSk7CkNhcnRlc2lhbkF4aXMuZGlzcGxheU5hbWUgPSAiQ2FydGVzaWFuQXhpcyI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9DYXJ0ZXNpYW5HcmlkLmpzCnZhciBSZWFjdDI5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMTQgPSBbIngxIiwgInkxIiwgIngyIiwgInkyIiwgImtleSJdOwp2YXIgX2V4Y2x1ZGVkMjYgPSBbIm9mZnNldCJdOwp2YXIgX2V4Y2x1ZGVkMzMgPSBbInhBeGlzSWQiLCAieUF4aXNJZCJdOwp2YXIgX2V4Y2x1ZGVkNDMgPSBbInhBeGlzSWQiLCAieUF4aXNJZCJdOwpmdW5jdGlvbiBvd25LZXlzMzQoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzNChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czM0KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzNihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzNChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzNihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzNih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzNih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzNih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHMxOSgpIHsKICByZXR1cm4gX2V4dGVuZHMxOSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTQoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE0KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgQmFja2dyb3VuZCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBmaWxsCiAgfSA9IHByb3BzOwogIGlmICghZmlsbCB8fCBmaWxsID09PSAibm9uZSIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgZmlsbE9wYWNpdHksCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByeQogIH0gPSBwcm9wczsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICByeSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgc3Ryb2tlOiAibm9uZSIsCiAgICBmaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICB9KTsKfTsKZnVuY3Rpb24gTGluZUl0ZW0oX3JlZjIpIHsKICB2YXIgewogICAgb3B0aW9uLAogICAgbGluZUl0ZW1Qcm9wcwogIH0gPSBfcmVmMjsKICB2YXIgbGluZUl0ZW07CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmlzVmFsaWRFbGVtZW50KG9wdGlvbikpIHsKICAgIGxpbmVJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY2xvbmVFbGVtZW50KG9wdGlvbiwgbGluZUl0ZW1Qcm9wcyk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICBsaW5lSXRlbSA9IG9wdGlvbihsaW5lSXRlbVByb3BzKTsKICB9IGVsc2UgewogICAgdmFyIF9zdmdQcm9wZXJ0aWVzTm9FdmVudDsKICAgIHZhciB7CiAgICAgIHgxLAogICAgICB5MSwKICAgICAgeDIsCiAgICAgIHkyLAogICAgICBrZXkKICAgIH0gPSBsaW5lSXRlbVByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChsaW5lSXRlbVByb3BzLCBfZXhjbHVkZWQxNCk7CiAgICB2YXIgX3JlZjIyID0gKF9zdmdQcm9wZXJ0aWVzTm9FdmVudCA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhvdGhlcnMpKSAhPT0gbnVsbCAmJiBfc3ZnUHJvcGVydGllc05vRXZlbnQgIT09IHZvaWQgMCA/IF9zdmdQcm9wZXJ0aWVzTm9FdmVudCA6IHt9LCB7CiAgICAgIG9mZnNldDogX18KICAgIH0gPSBfcmVmMjIsIHJlc3RPZkZpbHRlcmVkUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChfcmVmMjIsIF9leGNsdWRlZDI2KTsKICAgIGxpbmVJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudCgibGluZSIsIF9leHRlbmRzMTkoe30sIHJlc3RPZkZpbHRlcmVkUHJvcHMsIHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MiwKICAgICAgeTIsCiAgICAgIGZpbGw6ICJub25lIiwKICAgICAga2V5CiAgICB9KSk7CiAgfQogIHJldHVybiBsaW5lSXRlbTsKfQpmdW5jdGlvbiBIb3Jpem9udGFsR3JpZExpbmVzKHByb3BzKSB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgd2lkdGgsCiAgICBob3Jpem9udGFsID0gdHJ1ZSwKICAgIGhvcml6b250YWxQb2ludHMKICB9ID0gcHJvcHM7CiAgaWYgKCFob3Jpem9udGFsIHx8ICFob3Jpem9udGFsUG9pbnRzIHx8ICFob3Jpem9udGFsUG9pbnRzLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0gPSBwcm9wcywgb3RoZXJMaW5lSXRlbVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTQocHJvcHMsIF9leGNsdWRlZDMzKTsKICB2YXIgaXRlbXMgPSBob3Jpem9udGFsUG9pbnRzLm1hcCgoZW50cnksIGkpID0+IHsKICAgIHZhciBsaW5lSXRlbVByb3BzID0gX29iamVjdFNwcmVhZDM0KF9vYmplY3RTcHJlYWQzNCh7fSwgb3RoZXJMaW5lSXRlbVByb3BzKSwge30sIHsKICAgICAgeDE6IHgyLAogICAgICB5MTogZW50cnksCiAgICAgIHgyOiB4MiArIHdpZHRoLAogICAgICB5MjogZW50cnksCiAgICAgIGtleTogImxpbmUtIi5jb25jYXQoaSksCiAgICAgIGluZGV4OiBpCiAgICB9KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KExpbmVJdGVtLCB7CiAgICAgIGtleTogImxpbmUtIi5jb25jYXQoaSksCiAgICAgIG9wdGlvbjogaG9yaXpvbnRhbCwKICAgICAgbGluZUl0ZW1Qcm9wcwogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1ob3Jpem9udGFsIgogIH0sIGl0ZW1zKTsKfQpmdW5jdGlvbiBWZXJ0aWNhbEdyaWRMaW5lcyhwcm9wcykgewogIHZhciB7CiAgICB5OiB5MiwKICAgIGhlaWdodCwKICAgIHZlcnRpY2FsID0gdHJ1ZSwKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzOwogIGlmICghdmVydGljYWwgfHwgIXZlcnRpY2FsUG9pbnRzIHx8ICF2ZXJ0aWNhbFBvaW50cy5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQKICB9ID0gcHJvcHMsIG90aGVyTGluZUl0ZW1Qcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE0KHByb3BzLCBfZXhjbHVkZWQ0Myk7CiAgdmFyIGl0ZW1zID0gdmVydGljYWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0U3ByZWFkMzQoX29iamVjdFNwcmVhZDM0KHt9LCBvdGhlckxpbmVJdGVtUHJvcHMpLCB7fSwgewogICAgICB4MTogZW50cnksCiAgICAgIHkxOiB5MiwKICAgICAgeDI6IGVudHJ5LAogICAgICB5MjogeTIgKyBoZWlnaHQsCiAgICAgIGtleTogImxpbmUtIi5jb25jYXQoaSksCiAgICAgIGluZGV4OiBpCiAgICB9KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KExpbmVJdGVtLCB7CiAgICAgIG9wdGlvbjogdmVydGljYWwsCiAgICAgIGxpbmVJdGVtUHJvcHMsCiAgICAgIGtleTogImxpbmUtIi5jb25jYXQoaSkKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQtdmVydGljYWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIEhvcml6b250YWxTdHJpcGVzKHByb3BzKSB7CiAgdmFyIHsKICAgIGhvcml6b250YWxGaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBob3Jpem9udGFsUG9pbnRzLAogICAgaG9yaXpvbnRhbCA9IHRydWUKICB9ID0gcHJvcHM7CiAgaWYgKCFob3Jpem9udGFsIHx8ICFob3Jpem9udGFsRmlsbCB8fCAhaG9yaXpvbnRhbEZpbGwubGVuZ3RoIHx8IGhvcml6b250YWxQb2ludHMgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50cyA9IGhvcml6b250YWxQb2ludHMubWFwKChlKSA9PiBNYXRoLnJvdW5kKGUgKyB5MiAtIHkyKSkuc29ydCgoYTIsIGIpID0+IGEyIC0gYik7CiAgaWYgKHkyICE9PSByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50c1swXSkgewogICAgcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMudW5zaGlmdCgwKTsKICB9CiAgdmFyIGl0ZW1zID0gcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHNbaSArIDFdOwogICAgdmFyIGxpbmVIZWlnaHQgPSBsYXN0U3RyaXBlID8geTIgKyBoZWlnaHQgLSBlbnRyeSA6IHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVIZWlnaHQgPD0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBjb2xvckluZGV4ID0gaSAlIGhvcml6b250YWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeTogZW50cnksCiAgICAgIHg6IHgyLAogICAgICBoZWlnaHQ6IGxpbmVIZWlnaHQsCiAgICAgIHdpZHRoLAogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgZmlsbDogaG9yaXpvbnRhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsU3RyaXBlcyhwcm9wcykgewogIHZhciB7CiAgICB2ZXJ0aWNhbCA9IHRydWUsCiAgICB2ZXJ0aWNhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzOwogIGlmICghdmVydGljYWwgfHwgIXZlcnRpY2FsRmlsbCB8fCAhdmVydGljYWxGaWxsLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHgyIC0geDIpKS5zb3J0KChhMiwgYikgPT4gYTIgLSBiKTsKICBpZiAoeDIgIT09IHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50c1swXSkgewogICAgcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzLnVuc2hpZnQoMCk7CiAgfQogIHZhciBpdGVtcyA9IHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgbGFzdFN0cmlwZSA9ICFyb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHNbaSArIDFdOwogICAgdmFyIGxpbmVXaWR0aCA9IGxhc3RTdHJpcGUgPyB4MiArIHdpZHRoIC0gZW50cnkgOiByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHNbaSArIDFdIC0gZW50cnk7CiAgICBpZiAobGluZVdpZHRoIDw9IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB2YXIgY29sb3JJbmRleCA9IGkgJSB2ZXJ0aWNhbEZpbGwubGVuZ3RoOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIGtleTogInJlYWN0LSIuY29uY2F0KGkpLAogICAgICB4OiBlbnRyeSwKICAgICAgeTogeTIsCiAgICAgIHdpZHRoOiBsaW5lV2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgc3Ryb2tlOiAibm9uZSIsCiAgICAgIGZpbGw6IHZlcnRpY2FsRmlsbFtjb2xvckluZGV4XSwKICAgICAgZmlsbE9wYWNpdHksCiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWJnIgogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZHN0cmlwZXMtdmVydGljYWwiCiAgfSwgaXRlbXMpOwp9CnZhciBkZWZhdWx0VmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9IChfcmVmMywgc3luY1dpdGhUaWNrcykgPT4gewogIHZhciB7CiAgICB4QXhpcywKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb2Zmc2V0CiAgfSA9IF9yZWYzOwogIHJldHVybiBnZXRDb29yZGluYXRlc09mR3JpZChnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMzQoX29iamVjdFNwcmVhZDM0KF9vYmplY3RTcHJlYWQzNCh7fSwgZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcyksIHhBeGlzKSwge30sIHsKICAgIHRpY2tzOiBnZXRUaWNrc09mQXhpcyh4QXhpcywgdHJ1ZSksCiAgICB2aWV3Qm94OiB7CiAgICAgIHg6IDAsCiAgICAgIHk6IDAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0KICB9KSksIG9mZnNldC5sZWZ0LCBvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCwgc3luY1dpdGhUaWNrcyk7Cn07CnZhciBkZWZhdWx0SG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gKF9yZWY0LCBzeW5jV2l0aFRpY2tzKSA9PiB7CiAgdmFyIHsKICAgIHlBeGlzLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBvZmZzZXQKICB9ID0gX3JlZjQ7CiAgcmV0dXJuIGdldENvb3JkaW5hdGVzT2ZHcmlkKGdldFRpY2tzKF9vYmplY3RTcHJlYWQzNChfb2JqZWN0U3ByZWFkMzQoX29iamVjdFNwcmVhZDM0KHt9LCBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzKSwgeUF4aXMpLCB7fSwgewogICAgdGlja3M6IGdldFRpY2tzT2ZBeGlzKHlBeGlzLCB0cnVlKSwKICAgIHZpZXdCb3g6IHsKICAgICAgeDogMCwKICAgICAgeTogMCwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfQogIH0pKSwgb2Zmc2V0LnRvcCwgb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQsIHN5bmNXaXRoVGlja3MpOwp9Owp2YXIgZGVmYXVsdENhcnRlc2lhbkdyaWRQcm9wcyA9IHsKICBob3Jpem9udGFsOiB0cnVlLAogIHZlcnRpY2FsOiB0cnVlLAogIC8vIFRoZSBvcmRpbmF0ZXMgb2YgaG9yaXpvbnRhbCBncmlkIGxpbmVzCiAgaG9yaXpvbnRhbFBvaW50czogW10sCiAgLy8gVGhlIGFic2Npc3NhcyBvZiB2ZXJ0aWNhbCBncmlkIGxpbmVzCiAgdmVydGljYWxQb2ludHM6IFtdLAogIHN0cm9rZTogIiNjY2MiLAogIGZpbGw6ICJub25lIiwKICAvLyBUaGUgZmlsbCBvZiBjb2xvcnMgb2YgZ3JpZCBsaW5lcwogIHZlcnRpY2FsRmlsbDogW10sCiAgaG9yaXpvbnRhbEZpbGw6IFtdLAogIHhBeGlzSWQ6IDAsCiAgeUF4aXNJZDogMCwKICBzeW5jV2l0aFRpY2tzOiBmYWxzZSwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5ncmlkCn07CmZ1bmN0aW9uIENhcnRlc2lhbkdyaWQocHJvcHMpIHsKICB2YXIgY2hhcnRXaWR0aCA9IHVzZUNoYXJ0V2lkdGgoKTsKICB2YXIgY2hhcnRIZWlnaHQgPSB1c2VDaGFydEhlaWdodCgpOwogIHZhciBvZmZzZXQgPSB1c2VPZmZzZXRJbnRlcm5hbCgpOwogIHZhciBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzID0gX29iamVjdFNwcmVhZDM0KF9vYmplY3RTcHJlYWQzNCh7fSwgcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcywgZGVmYXVsdENhcnRlc2lhbkdyaWRQcm9wcykpLCB7fSwgewogICAgeDogaXNOdW1iZXIocHJvcHMueCkgPyBwcm9wcy54IDogb2Zmc2V0LmxlZnQsCiAgICB5OiBpc051bWJlcihwcm9wcy55KSA/IHByb3BzLnkgOiBvZmZzZXQudG9wLAogICAgd2lkdGg6IGlzTnVtYmVyKHByb3BzLndpZHRoKSA/IHByb3BzLndpZHRoIDogb2Zmc2V0LndpZHRoLAogICAgaGVpZ2h0OiBpc051bWJlcihwcm9wcy5oZWlnaHQpID8gcHJvcHMuaGVpZ2h0IDogb2Zmc2V0LmhlaWdodAogIH0pOwogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZCwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHN5bmNXaXRoVGlja3MsCiAgICBob3Jpem9udGFsVmFsdWVzLAogICAgdmVydGljYWxWYWx1ZXMKICB9ID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0czsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgeEF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNQcm9wc05lZWRlZEZvckNhcnRlc2lhbkdyaWRUaWNrc0dlbmVyYXRvcihzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciB5QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXhpc1Byb3BzTmVlZGVkRm9yQ2FydGVzaWFuR3JpZFRpY2tzR2VuZXJhdG9yKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgaWYgKCFpc1Bvc2l0aXZlTnVtYmVyKHdpZHRoKSB8fCAhaXNQb3NpdGl2ZU51bWJlcihoZWlnaHQpIHx8ICFpc051bWJlcih4MikgfHwgIWlzTnVtYmVyKHkyKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy52ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHx8IGRlZmF1bHRWZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yOwogIHZhciBob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPSBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciB8fCBkZWZhdWx0SG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yOwogIHZhciB7CiAgICBob3Jpem9udGFsUG9pbnRzLAogICAgdmVydGljYWxQb2ludHMKICB9ID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0czsKICBpZiAoKCFob3Jpem9udGFsUG9pbnRzIHx8ICFob3Jpem9udGFsUG9pbnRzLmxlbmd0aCkgJiYgdHlwZW9mIGhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgdmFyIGlzSG9yaXpvbnRhbFZhbHVlcyA9IGhvcml6b250YWxWYWx1ZXMgJiYgaG9yaXpvbnRhbFZhbHVlcy5sZW5ndGg7CiAgICB2YXIgZ2VuZXJhdG9yUmVzdWx0ID0gaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yKHsKICAgICAgeUF4aXM6IHlBeGlzID8gX29iamVjdFNwcmVhZDM0KF9vYmplY3RTcHJlYWQzNCh7fSwgeUF4aXMpLCB7fSwgewogICAgICAgIHRpY2tzOiBpc0hvcml6b250YWxWYWx1ZXMgPyBob3Jpem9udGFsVmFsdWVzIDogeUF4aXMudGlja3MKICAgICAgfSkgOiB2b2lkIDAsCiAgICAgIHdpZHRoOiBjaGFydFdpZHRoICE9PSBudWxsICYmIGNoYXJ0V2lkdGggIT09IHZvaWQgMCA/IGNoYXJ0V2lkdGggOiB3aWR0aCwKICAgICAgaGVpZ2h0OiBjaGFydEhlaWdodCAhPT0gbnVsbCAmJiBjaGFydEhlaWdodCAhPT0gdm9pZCAwID8gY2hhcnRIZWlnaHQgOiBoZWlnaHQsCiAgICAgIG9mZnNldAogICAgfSwgaXNIb3Jpem9udGFsVmFsdWVzID8gdHJ1ZSA6IHN5bmNXaXRoVGlja3MpOwogICAgd2FybihBcnJheS5pc0FycmF5KGdlbmVyYXRvclJlc3VsdCksICJob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3Igc2hvdWxkIHJldHVybiBBcnJheSBidXQgaW5zdGVhZCBpdCByZXR1cm5lZCBbIi5jb25jYXQodHlwZW9mIGdlbmVyYXRvclJlc3VsdCwgIl0iKSk7CiAgICBpZiAoQXJyYXkuaXNBcnJheShnZW5lcmF0b3JSZXN1bHQpKSB7CiAgICAgIGhvcml6b250YWxQb2ludHMgPSBnZW5lcmF0b3JSZXN1bHQ7CiAgICB9CiAgfQogIGlmICgoIXZlcnRpY2FsUG9pbnRzIHx8ICF2ZXJ0aWNhbFBvaW50cy5sZW5ndGgpICYmIHR5cGVvZiB2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICB2YXIgaXNWZXJ0aWNhbFZhbHVlcyA9IHZlcnRpY2FsVmFsdWVzICYmIHZlcnRpY2FsVmFsdWVzLmxlbmd0aDsKICAgIHZhciBfZ2VuZXJhdG9yUmVzdWx0ID0gdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvcih7CiAgICAgIHhBeGlzOiB4QXhpcyA/IF9vYmplY3RTcHJlYWQzNChfb2JqZWN0U3ByZWFkMzQoe30sIHhBeGlzKSwge30sIHsKICAgICAgICB0aWNrczogaXNWZXJ0aWNhbFZhbHVlcyA/IHZlcnRpY2FsVmFsdWVzIDogeEF4aXMudGlja3MKICAgICAgfSkgOiB2b2lkIDAsCiAgICAgIHdpZHRoOiBjaGFydFdpZHRoICE9PSBudWxsICYmIGNoYXJ0V2lkdGggIT09IHZvaWQgMCA/IGNoYXJ0V2lkdGggOiB3aWR0aCwKICAgICAgaGVpZ2h0OiBjaGFydEhlaWdodCAhPT0gbnVsbCAmJiBjaGFydEhlaWdodCAhPT0gdm9pZCAwID8gY2hhcnRIZWlnaHQgOiBoZWlnaHQsCiAgICAgIG9mZnNldAogICAgfSwgaXNWZXJ0aWNhbFZhbHVlcyA/IHRydWUgOiBzeW5jV2l0aFRpY2tzKTsKICAgIHdhcm4oQXJyYXkuaXNBcnJheShfZ2VuZXJhdG9yUmVzdWx0KSwgInZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3Igc2hvdWxkIHJldHVybiBBcnJheSBidXQgaW5zdGVhZCBpdCByZXR1cm5lZCBbIi5jb25jYXQodHlwZW9mIF9nZW5lcmF0b3JSZXN1bHQsICJdIikpOwogICAgaWYgKEFycmF5LmlzQXJyYXkoX2dlbmVyYXRvclJlc3VsdCkpIHsKICAgICAgdmVydGljYWxQb2ludHMgPSBfZ2VuZXJhdG9yUmVzdWx0OwogICAgfQogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZCIKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KEJhY2tncm91bmQsIHsKICAgIGZpbGw6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMuZmlsbCwKICAgIGZpbGxPcGFjaXR5OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmZpbGxPcGFjaXR5LAogICAgeDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy54LAogICAgeTogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy55LAogICAgd2lkdGg6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMud2lkdGgsCiAgICBoZWlnaHQ6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMuaGVpZ2h0LAogICAgcnk6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMucnkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudChIb3Jpem9udGFsU3RyaXBlcywgX2V4dGVuZHMxOSh7fSwgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cywgewogICAgaG9yaXpvbnRhbFBvaW50cwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudChWZXJ0aWNhbFN0cmlwZXMsIF9leHRlbmRzMTkoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KEhvcml6b250YWxHcmlkTGluZXMsIF9leHRlbmRzMTkoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIG9mZnNldCwKICAgIGhvcml6b250YWxQb2ludHMsCiAgICB4QXhpcywKICAgIHlBeGlzCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KFZlcnRpY2FsR3JpZExpbmVzLCBfZXh0ZW5kczE5KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICBvZmZzZXQsCiAgICB2ZXJ0aWNhbFBvaW50cywKICAgIHhBeGlzLAogICAgeUF4aXMKICB9KSkpKTsKfQpDYXJ0ZXNpYW5HcmlkLmRpc3BsYXlOYW1lID0gIkNhcnRlc2lhbkdyaWQiOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldFJhZGl1c0FuZFN0cm9rZVdpZHRoRnJvbURvdC5qcwpmdW5jdGlvbiBnZXRSYWRpdXNBbmRTdHJva2VXaWR0aEZyb21Eb3QoZG90KSB7CiAgdmFyIHByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oZG90KTsKICB2YXIgZGVmYXVsdFIgPSAzOwogIHZhciBkZWZhdWx0U3Ryb2tlV2lkdGggPSAyOwogIGlmIChwcm9wcyAhPSBudWxsKSB7CiAgICB2YXIgewogICAgICByOiByMiwKICAgICAgc3Ryb2tlV2lkdGgKICAgIH0gPSBwcm9wczsKICAgIHZhciByZWFsUiA9IE51bWJlcihyMik7CiAgICB2YXIgcmVhbFN0cm9rZVdpZHRoID0gTnVtYmVyKHN0cm9rZVdpZHRoKTsKICAgIGlmIChOdW1iZXIuaXNOYU4ocmVhbFIpIHx8IHJlYWxSIDwgMCkgewogICAgICByZWFsUiA9IGRlZmF1bHRSOwogICAgfQogICAgaWYgKE51bWJlci5pc05hTihyZWFsU3Ryb2tlV2lkdGgpIHx8IHJlYWxTdHJva2VXaWR0aCA8IDApIHsKICAgICAgcmVhbFN0cm9rZVdpZHRoID0gZGVmYXVsdFN0cm9rZVdpZHRoOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcjogcmVhbFIsCiAgICAgIHN0cm9rZVdpZHRoOiByZWFsU3Ryb2tlV2lkdGgKICAgIH07CiAgfQogIHJldHVybiB7CiAgICByOiBkZWZhdWx0UiwKICAgIHN0cm9rZVdpZHRoOiBkZWZhdWx0U3Ryb2tlV2lkdGgKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9BcmVhLmpzCnZhciBSZWFjdDMwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9hcmVhU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RYQXhpc1dpdGhTY2FsZSA9IChzdGF0ZSwgeEF4aXNJZCwgX3lBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdEF4aXNXaXRoU2NhbGUoc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0WEF4aXNUaWNrcyA9IChzdGF0ZSwgeEF4aXNJZCwgX3lBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdFlBeGlzV2l0aFNjYWxlID0gKHN0YXRlLCBfeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSkgPT4gc2VsZWN0QXhpc1dpdGhTY2FsZShzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSk7CnZhciBzZWxlY3RZQXhpc1RpY2tzID0gKHN0YXRlLCBfeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSkgPT4gc2VsZWN0VGlja3NPZkdyYXBoaWNhbEl0ZW0oc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0QmFuZFNpemUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFhBeGlzV2l0aFNjYWxlLCBzZWxlY3RZQXhpc1dpdGhTY2FsZSwgc2VsZWN0WEF4aXNUaWNrcywgc2VsZWN0WUF4aXNUaWNrc10sIChsYXlvdXQsIHhBeGlzLCB5QXhpcywgeEF4aXNUaWNrcywgeUF4aXNUaWNrcykgPT4gewogIGlmIChpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsICJ4QXhpcyIpKSB7CiAgICByZXR1cm4gZ2V0QmFuZFNpemVPZkF4aXMoeEF4aXMsIHhBeGlzVGlja3MsIGZhbHNlKTsKICB9CiAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHlBeGlzLCB5QXhpc1RpY2tzLCBmYWxzZSk7Cn0pOwp2YXIgcGlja0FyZWFJZCA9IChfc3RhdGUsIF94QXhpc0lkLCBfeUF4aXNJZCwgX2lzUGFub3JhbWEsIGlkKSA9PiBpZDsKdmFyIHNlbGVjdFN5bmNocm9uaXNlZEFyZWFTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RVbmZpbHRlcmVkQ2FydGVzaWFuSXRlbXMsIHBpY2tBcmVhSWRdLCAoZ3JhcGhpY2FsSXRlbXMsIGlkKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gImFyZWEiKS5maW5kKChpdGVtKSA9PiBpdGVtLmlkID09PSBpZCkpOwp2YXIgc2VsZWN0R3JhcGhpY2FsSXRlbVN0YWNrZWREYXRhID0gKHN0YXRlLCB4QXhpc0lkLCB5QXhpc0lkLCBpc1Bhbm9yYW1hLCBpZCkgPT4gewogIHZhciBfc3RhY2tHcm91cHMkc3RhY2tJZDsKICB2YXIgYXJlYVNldHRpbmdzID0gc2VsZWN0U3luY2hyb25pc2VkQXJlYVNldHRpbmdzKHN0YXRlLCB4QXhpc0lkLCB5QXhpc0lkLCBpc1Bhbm9yYW1hLCBpZCk7CiAgaWYgKGFyZWFTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgbGF5b3V0ID0gc2VsZWN0Q2hhcnRMYXlvdXQoc3RhdGUpOwogIHZhciBpc1hBeGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsICJ4QXhpcyIpOwogIHZhciBzdGFja0dyb3VwczsKICBpZiAoaXNYQXhpc0NhdGVnb3JpY2FsKSB7CiAgICBzdGFja0dyb3VwcyA9IHNlbGVjdFN0YWNrR3JvdXBzKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKTsKICB9IGVsc2UgewogICAgc3RhY2tHcm91cHMgPSBzZWxlY3RTdGFja0dyb3VwcyhzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgfQogIGlmIChzdGFja0dyb3VwcyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgc3RhY2tJZAogIH0gPSBhcmVhU2V0dGluZ3M7CiAgdmFyIHN0YWNrU2VyaWVzSWRlbnRpZmllciA9IGdldFN0YWNrU2VyaWVzSWRlbnRpZmllcihhcmVhU2V0dGluZ3MpOwogIGlmIChzdGFja0lkID09IG51bGwgfHwgc3RhY2tTZXJpZXNJZGVudGlmaWVyID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBncm91cHMgPSAoX3N0YWNrR3JvdXBzJHN0YWNrSWQgPSBzdGFja0dyb3Vwc1tzdGFja0lkXSkgPT09IG51bGwgfHwgX3N0YWNrR3JvdXBzJHN0YWNrSWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9zdGFja0dyb3VwcyRzdGFja0lkLnN0YWNrZWREYXRhOwogIHJldHVybiBncm91cHMgPT09IG51bGwgfHwgZ3JvdXBzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBncm91cHMuZmluZCgodikgPT4gdi5rZXkgPT09IHN0YWNrU2VyaWVzSWRlbnRpZmllcik7Cn07CnZhciBzZWxlY3RBcmVhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RYQXhpc1dpdGhTY2FsZSwgc2VsZWN0WUF4aXNXaXRoU2NhbGUsIHNlbGVjdFhBeGlzVGlja3MsIHNlbGVjdFlBeGlzVGlja3MsIHNlbGVjdEdyYXBoaWNhbEl0ZW1TdGFja2VkRGF0YSwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWEsIHNlbGVjdEJhbmRTaXplLCBzZWxlY3RTeW5jaHJvbmlzZWRBcmVhU2V0dGluZ3MsIHNlbGVjdENoYXJ0QmFzZVZhbHVlXSwgKGxheW91dCwgeEF4aXMsIHlBeGlzLCB4QXhpc1RpY2tzLCB5QXhpc1RpY2tzLCBzdGFja2VkRGF0YSwgX3JlZjIsIGJhbmRTaXplLCBhcmVhU2V0dGluZ3MsIGNoYXJ0QmFzZVZhbHVlKSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYyOwogIGlmIChhcmVhU2V0dGluZ3MgPT0gbnVsbCB8fCBsYXlvdXQgIT09ICJob3Jpem9udGFsIiAmJiBsYXlvdXQgIT09ICJ2ZXJ0aWNhbCIgfHwgeEF4aXMgPT0gbnVsbCB8fCB5QXhpcyA9PSBudWxsIHx8IHhBeGlzVGlja3MgPT0gbnVsbCB8fCB5QXhpc1RpY2tzID09IG51bGwgfHwgeEF4aXNUaWNrcy5sZW5ndGggPT09IDAgfHwgeUF4aXNUaWNrcy5sZW5ndGggPT09IDAgfHwgYmFuZFNpemUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGRhdGEKICB9ID0gYXJlYVNldHRpbmdzOwogIHZhciBkaXNwbGF5ZWREYXRhOwogIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoID4gMCkgewogICAgZGlzcGxheWVkRGF0YSA9IGRhdGE7CiAgfSBlbHNlIHsKICAgIGRpc3BsYXllZERhdGEgPSBjaGFydERhdGEgPT09IG51bGwgfHwgY2hhcnREYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjaGFydERhdGEuc2xpY2UoZGF0YVN0YXJ0SW5kZXgsIGRhdGFFbmRJbmRleCArIDEpOwogIH0KICBpZiAoZGlzcGxheWVkRGF0YSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gY29tcHV0ZUFyZWEoewogICAgbGF5b3V0LAogICAgeEF4aXMsCiAgICB5QXhpcywKICAgIHhBeGlzVGlja3MsCiAgICB5QXhpc1RpY2tzLAogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICBhcmVhU2V0dGluZ3MsCiAgICBzdGFja2VkRGF0YSwKICAgIGRpc3BsYXllZERhdGEsCiAgICBjaGFydEJhc2VWYWx1ZSwKICAgIGJhbmRTaXplCiAgfSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQXJlYS5qcwp2YXIgX2V4Y2x1ZGVkMTUgPSBbImlkIl07CnZhciBfZXhjbHVkZWQyNyA9IFsiYWN0aXZlRG90IiwgImFuaW1hdGlvbkJlZ2luIiwgImFuaW1hdGlvbkR1cmF0aW9uIiwgImFuaW1hdGlvbkVhc2luZyIsICJjb25uZWN0TnVsbHMiLCAiZG90IiwgImZpbGwiLCAiZmlsbE9wYWNpdHkiLCAiaGlkZSIsICJpc0FuaW1hdGlvbkFjdGl2ZSIsICJsZWdlbmRUeXBlIiwgInN0cm9rZSIsICJ4QXhpc0lkIiwgInlBeGlzSWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMyMCgpIHsKICByZXR1cm4gX2V4dGVuZHMyMCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjAuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTUoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE1KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBvd25LZXlzMzUoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzNShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czM1KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzNyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzNShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzcoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzNyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzNyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzNyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzNyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZ2V0TGVnZW5kSXRlbUNvbG9yKHN0cm9rZSwgZmlsbCkgewogIHJldHVybiBzdHJva2UgJiYgc3Ryb2tlICE9PSAibm9uZSIgPyBzdHJva2UgOiBmaWxsOwp9CnZhciBjb21wdXRlTGVnZW5kUGF5bG9hZEZyb21BcmVhRGF0YSA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBkYXRhS2V5LAogICAgbmFtZSwKICAgIHN0cm9rZSwKICAgIGZpbGwsCiAgICBsZWdlbmRUeXBlLAogICAgaGlkZQogIH0gPSBwcm9wczsKICByZXR1cm4gW3sKICAgIGluYWN0aXZlOiBoaWRlLAogICAgZGF0YUtleSwKICAgIHR5cGU6IGxlZ2VuZFR5cGUsCiAgICBjb2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHN0cm9rZSwgZmlsbCksCiAgICB2YWx1ZTogZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWUsIGRhdGFLZXkpLAogICAgcGF5bG9hZDogcHJvcHMKICB9XTsKfTsKdmFyIFNldEFyZWFUb29sdGlwRW50cnlTZXR0aW5ncyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLm1lbW8oKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBkYXRhLAogICAgc3Ryb2tlLAogICAgc3Ryb2tlV2lkdGgsCiAgICBmaWxsLAogICAgbmFtZSwKICAgIGhpZGUsCiAgICB1bml0OiB1bml0MiwKICAgIHRvb2x0aXBUeXBlCiAgfSA9IF9yZWYyOwogIHZhciB0b29sdGlwRW50cnlTZXR0aW5ncyA9IHsKICAgIGRhdGFEZWZpbmVkT25JdGVtOiBkYXRhLAogICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICBzZXR0aW5nczogewogICAgICBzdHJva2UsCiAgICAgIHN0cm9rZVdpZHRoLAogICAgICBmaWxsLAogICAgICBkYXRhS2V5LAogICAgICBuYW1lS2V5OiB2b2lkIDAsCiAgICAgIG5hbWU6IGdldFRvb2x0aXBOYW1lUHJvcChuYW1lLCBkYXRhS2V5KSwKICAgICAgaGlkZSwKICAgICAgdHlwZTogdG9vbHRpcFR5cGUsCiAgICAgIGNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3Ioc3Ryb2tlLCBmaWxsKSwKICAgICAgdW5pdDogdW5pdDIKICAgIH0KICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFNldFRvb2x0aXBFbnRyeVNldHRpbmdzLCB7CiAgICB0b29sdGlwRW50cnlTZXR0aW5ncwogIH0pOwp9KTsKZnVuY3Rpb24gQXJlYURvdHNXcmFwcGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNsaXBQYXRoSWQsCiAgICBwb2ludHMsCiAgICBwcm9wcwogIH0gPSBfcmVmMjsKICB2YXIgewogICAgbmVlZENsaXAsCiAgICBkb3QsCiAgICBkYXRhS2V5CiAgfSA9IHByb3BzOwogIHZhciBhcmVhUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KERvdHMsIHsKICAgIHBvaW50cywKICAgIGRvdCwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtZG90cyIsCiAgICBkb3RDbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWRvdCIsCiAgICBkYXRhS2V5LAogICAgYmFzZVByb3BzOiBhcmVhUHJvcHMsCiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQKICB9KTsKfQpmdW5jdGlvbiBBcmVhTGFiZWxMaXN0UHJvdmlkZXIoX3JlZjMpIHsKICB2YXIgewogICAgc2hvd0xhYmVscywKICAgIGNoaWxkcmVuLAogICAgcG9pbnRzCiAgfSA9IF9yZWYzOwogIHZhciBsYWJlbExpc3RFbnRyaWVzID0gcG9pbnRzLm1hcCgocG9pbnQ0KSA9PiB7CiAgICB2YXIgX3BvaW50JHgsIF9wb2ludCR5OwogICAgdmFyIHZpZXdCb3ggPSB7CiAgICAgIHg6IChfcG9pbnQkeCA9IHBvaW50NC54KSAhPT0gbnVsbCAmJiBfcG9pbnQkeCAhPT0gdm9pZCAwID8gX3BvaW50JHggOiAwLAogICAgICB5OiAoX3BvaW50JHkgPSBwb2ludDQueSkgIT09IG51bGwgJiYgX3BvaW50JHkgIT09IHZvaWQgMCA/IF9wb2ludCR5IDogMCwKICAgICAgd2lkdGg6IDAsCiAgICAgIGxvd2VyV2lkdGg6IDAsCiAgICAgIHVwcGVyV2lkdGg6IDAsCiAgICAgIGhlaWdodDogMAogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMzUoX29iamVjdFNwcmVhZDM1KHt9LCB2aWV3Qm94KSwge30sIHsKICAgICAgdmFsdWU6IHBvaW50NC52YWx1ZSwKICAgICAgcGF5bG9hZDogcG9pbnQ0LnBheWxvYWQsCiAgICAgIHBhcmVudFZpZXdCb3g6IHZvaWQgMCwKICAgICAgdmlld0JveCwKICAgICAgZmlsbDogdm9pZCAwCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0UHJvdmlkZXIsIHsKICAgIHZhbHVlOiBzaG93TGFiZWxzID8gbGFiZWxMaXN0RW50cmllcyA6IHZvaWQgMAogIH0sIGNoaWxkcmVuKTsKfQpmdW5jdGlvbiBTdGF0aWNBcmVhKF9yZWY0KSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMKICB9ID0gX3JlZjQ7CiAgdmFyIHsKICAgIGxheW91dCwKICAgIHR5cGUsCiAgICBzdHJva2UsCiAgICBjb25uZWN0TnVsbHMsCiAgICBpc1JhbmdlCiAgfSA9IHByb3BzOwogIHZhciB7CiAgICBpZAogIH0gPSBwcm9wcywgcHJvcHNXaXRob3V0SWQgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShwcm9wcywgX2V4Y2x1ZGVkMTUpOwogIHZhciBhbGxPdGhlclByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzV2l0aG91dElkKTsKICB2YXIgcHJvcHNXaXRoRXZlbnRzID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wc1dpdGhvdXRJZCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoUmVhY3QzMC5GcmFnbWVudCwgbnVsbCwgKHBvaW50cyA9PT0gbnVsbCB8fCBwb2ludHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBvaW50cy5sZW5ndGgpID4gMSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGlwUGF0aDogbmVlZENsaXAgPyAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpIDogdm9pZCAwCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChDdXJ2ZSwgX2V4dGVuZHMyMCh7fSwgcHJvcHNXaXRoRXZlbnRzLCB7CiAgICBpZCwKICAgIHBvaW50cywKICAgIGNvbm5lY3ROdWxscywKICAgIHR5cGUsCiAgICBiYXNlTGluZSwKICAgIGxheW91dCwKICAgIHN0cm9rZTogIm5vbmUiLAogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1hcmVhIgogIH0pKSwgc3Ryb2tlICE9PSAibm9uZSIgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChDdXJ2ZSwgX2V4dGVuZHMyMCh7fSwgYWxsT3RoZXJQcm9wcywgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1jdXJ2ZSIsCiAgICBsYXlvdXQsCiAgICB0eXBlLAogICAgY29ubmVjdE51bGxzLAogICAgZmlsbDogIm5vbmUiLAogICAgcG9pbnRzCiAgfSkpLCBzdHJva2UgIT09ICJub25lIiAmJiBpc1JhbmdlICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoQ3VydmUsIF9leHRlbmRzMjAoe30sIGFsbE90aGVyUHJvcHMsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtY3VydmUiLAogICAgbGF5b3V0LAogICAgdHlwZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGZpbGw6ICJub25lIiwKICAgIHBvaW50czogYmFzZUxpbmUKICB9KSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KEFyZWFEb3RzV3JhcHBlciwgewogICAgcG9pbnRzLAogICAgcHJvcHM6IHByb3BzV2l0aG91dElkLAogICAgY2xpcFBhdGhJZAogIH0pKTsKfQpmdW5jdGlvbiBWZXJ0aWNhbFJlY3QoX3JlZjUpIHsKICB2YXIgewogICAgYWxwaGE6IGFscGhhMiwKICAgIGJhc2VMaW5lLAogICAgcG9pbnRzLAogICAgc3Ryb2tlV2lkdGgKICB9ID0gX3JlZjU7CiAgdmFyIHN0YXJ0WSA9IHBvaW50c1swXS55OwogIHZhciBlbmRZID0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXS55OwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihzdGFydFkpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGVuZFkpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGhlaWdodCA9IGFscGhhMiAqIE1hdGguYWJzKHN0YXJ0WSAtIGVuZFkpOwogIHZhciBtYXhYID0gTWF0aC5tYXgoLi4ucG9pbnRzLm1hcCgoZW50cnkpID0+IGVudHJ5LnggfHwgMCkpOwogIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgIG1heFggPSBNYXRoLm1heChiYXNlTGluZSwgbWF4WCk7CiAgfSBlbHNlIGlmIChiYXNlTGluZSAmJiBBcnJheS5pc0FycmF5KGJhc2VMaW5lKSAmJiBiYXNlTGluZS5sZW5ndGgpIHsKICAgIG1heFggPSBNYXRoLm1heCguLi5iYXNlTGluZS5tYXAoKGVudHJ5KSA9PiBlbnRyeS54IHx8IDApLCBtYXhYKTsKICB9CiAgaWYgKGlzTnVtYmVyKG1heFgpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAgeDogMCwKICAgICAgeTogc3RhcnRZIDwgZW5kWSA/IHN0YXJ0WSA6IHN0YXJ0WSAtIGhlaWdodCwKICAgICAgd2lkdGg6IG1heFggKyAoc3Ryb2tlV2lkdGggPyBwYXJzZUludCgiIi5jb25jYXQoc3Ryb2tlV2lkdGgpLCAxMCkgOiAxKSwKICAgICAgaGVpZ2h0OiBNYXRoLmZsb29yKGhlaWdodCkKICAgIH0pOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBIb3Jpem9udGFsUmVjdChfcmVmNikgewogIHZhciB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgYmFzZUxpbmUsCiAgICBwb2ludHMsCiAgICBzdHJva2VXaWR0aAogIH0gPSBfcmVmNjsKICB2YXIgc3RhcnRYID0gcG9pbnRzWzBdLng7CiAgdmFyIGVuZFggPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdLng7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHN0YXJ0WCkgfHwgIWlzV2VsbEJlaGF2ZWROdW1iZXIoZW5kWCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgd2lkdGggPSBhbHBoYTIgKiBNYXRoLmFicyhzdGFydFggLSBlbmRYKTsKICB2YXIgbWF4WSA9IE1hdGgubWF4KC4uLnBvaW50cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS55IHx8IDApKTsKICBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBtYXhZID0gTWF0aC5tYXgoYmFzZUxpbmUsIG1heFkpOwogIH0gZWxzZSBpZiAoYmFzZUxpbmUgJiYgQXJyYXkuaXNBcnJheShiYXNlTGluZSkgJiYgYmFzZUxpbmUubGVuZ3RoKSB7CiAgICBtYXhZID0gTWF0aC5tYXgoLi4uYmFzZUxpbmUubWFwKChlbnRyeSkgPT4gZW50cnkueSB8fCAwKSwgbWF4WSk7CiAgfQogIGlmIChpc051bWJlcihtYXhZKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIHg6IHN0YXJ0WCA8IGVuZFggPyBzdGFydFggOiBzdGFydFggLSB3aWR0aCwKICAgICAgeTogMCwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodDogTWF0aC5mbG9vcihtYXhZICsgKHN0cm9rZVdpZHRoID8gcGFyc2VJbnQoIiIuY29uY2F0KHN0cm9rZVdpZHRoKSwgMTApIDogMSkpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gQ2xpcFJlY3QoX3JlZjcpIHsKICB2YXIgewogICAgYWxwaGE6IGFscGhhMiwKICAgIGxheW91dCwKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgc3Ryb2tlV2lkdGgKICB9ID0gX3JlZjc7CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoVmVydGljYWxSZWN0LCB7CiAgICAgIGFscGhhOiBhbHBoYTIsCiAgICAgIHBvaW50cywKICAgICAgYmFzZUxpbmUsCiAgICAgIHN0cm9rZVdpZHRoCiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoSG9yaXpvbnRhbFJlY3QsIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIHN0cm9rZVdpZHRoCiAgfSk7Cn0KZnVuY3Rpb24gQXJlYVdpdGhBbmltYXRpb24oX3JlZjgpIHsKICB2YXIgewogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMsCiAgICBwcmV2aW91c1BvaW50c1JlZiwKICAgIHByZXZpb3VzQmFzZWxpbmVSZWYKICB9ID0gX3JlZjg7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgb25BbmltYXRpb25TdGFydCwKICAgIG9uQW5pbWF0aW9uRW5kCiAgfSA9IHByb3BzOwogIHZhciBhbmltYXRpb25JbnB1dCA9ICgwLCBpbXBvcnRfcmVhY3Q0MS51c2VNZW1vKSgoKSA9PiAoewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUKICB9KSwgW3BvaW50cywgYmFzZUxpbmVdKTsKICB2YXIgYW5pbWF0aW9uSWQgPSB1c2VBbmltYXRpb25JZChhbmltYXRpb25JbnB1dCwgInJlY2hhcnRzLWFyZWEtIik7CiAgdmFyIGxheW91dCA9IHVzZUNhcnRlc2lhbkNoYXJ0TGF5b3V0KCk7CiAgdmFyIFtpc0FuaW1hdGluZywgc2V0SXNBbmltYXRpbmddID0gKDAsIGltcG9ydF9yZWFjdDQxLnVzZVN0YXRlKShmYWxzZSk7CiAgdmFyIHNob3dMYWJlbHMgPSAhaXNBbmltYXRpbmc7CiAgdmFyIGhhbmRsZUFuaW1hdGlvbkVuZCA9ICgwLCBpbXBvcnRfcmVhY3Q0MS51c2VDYWxsYmFjaykoKCkgPT4gewogICAgaWYgKHR5cGVvZiBvbkFuaW1hdGlvbkVuZCA9PT0gImZ1bmN0aW9uIikgewogICAgICBvbkFuaW1hdGlvbkVuZCgpOwogICAgfQogICAgc2V0SXNBbmltYXRpbmcoZmFsc2UpOwogIH0sIFtvbkFuaW1hdGlvbkVuZF0pOwogIHZhciBoYW5kbGVBbmltYXRpb25TdGFydCA9ICgwLCBpbXBvcnRfcmVhY3Q0MS51c2VDYWxsYmFjaykoKCkgPT4gewogICAgaWYgKHR5cGVvZiBvbkFuaW1hdGlvblN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIG9uQW5pbWF0aW9uU3RhcnQoKTsKICAgIH0KICAgIHNldElzQW5pbWF0aW5nKHRydWUpOwogIH0sIFtvbkFuaW1hdGlvblN0YXJ0XSk7CiAgaWYgKGxheW91dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHByZXZQb2ludHMgPSBwcmV2aW91c1BvaW50c1JlZi5jdXJyZW50OwogIHZhciBwcmV2QmFzZUxpbmUgPSBwcmV2aW91c0Jhc2VsaW5lUmVmLmN1cnJlbnQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoQXJlYUxhYmVsTGlzdFByb3ZpZGVyLCB7CiAgICBzaG93TGFiZWxzLAogICAgcG9pbnRzCiAgfSwgcHJvcHMuY2hpbGRyZW4sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoSmF2YXNjcmlwdEFuaW1hdGUsIHsKICAgIGFuaW1hdGlvbklkLAogICAgYmVnaW46IGFuaW1hdGlvbkJlZ2luLAogICAgZHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uLAogICAgaXNBY3RpdmU6IGlzQW5pbWF0aW9uQWN0aXZlLAogICAgZWFzaW5nOiBhbmltYXRpb25FYXNpbmcsCiAgICBvbkFuaW1hdGlvbkVuZDogaGFuZGxlQW5pbWF0aW9uRW5kLAogICAgb25BbmltYXRpb25TdGFydDogaGFuZGxlQW5pbWF0aW9uU3RhcnQsCiAgICBrZXk6IGFuaW1hdGlvbklkCiAgfSwgKHQpID0+IHsKICAgIGlmIChwcmV2UG9pbnRzKSB7CiAgICAgIHZhciBwcmV2UG9pbnRzRGlmZkZhY3RvciA9IHByZXZQb2ludHMubGVuZ3RoIC8gcG9pbnRzLmxlbmd0aDsKICAgICAgdmFyIHN0ZXBQb2ludHMgPSAoCiAgICAgICAgLyoKICAgICAgICAgKiBIZXJlIGl0IGlzIGltcG9ydGFudCB0aGF0IGF0IHRoZSB2ZXJ5IGVuZCBvZiB0aGUgYW5pbWF0aW9uLCBvbiB0aGUgbGFzdCBmcmFtZSwKICAgICAgICAgKiB3ZSByZW5kZXIgdGhlIG9yaWdpbmFsIHBvaW50cyB3aXRob3V0IGFueSBpbnRlcnBvbGF0aW9uLgogICAgICAgICAqIFRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgdGhlIGNvZGUgYWJvdmUgaXMgY2hlY2tpbmcgZm9yIHJlZmVyZW5jZSBlcXVhbGl0eSB0byBkZWNpZGUgaWYgdGhlIGFuaW1hdGlvbiBzaG91bGQgcnVuCiAgICAgICAgICogYW5kIGlmIHdlIGNyZWF0ZSBhIG5ldyBhcnJheSBpbnN0YW5jZSAoZXZlbiBpZiB0aGUgbnVtYmVycyB3ZXJlIHRoZSBzYW1lKQogICAgICAgICAqIHRoZW4gd2Ugd291bGQgYnJlYWsgYW5pbWF0aW9ucy4KICAgICAgICAgKi8KICAgICAgICB0ID09PSAxID8gcG9pbnRzIDogcG9pbnRzLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgICAgICB2YXIgcHJldlBvaW50SW5kZXggPSBNYXRoLmZsb29yKGluZGV4ICogcHJldlBvaW50c0RpZmZGYWN0b3IpOwogICAgICAgICAgaWYgKHByZXZQb2ludHNbcHJldlBvaW50SW5kZXhdKSB7CiAgICAgICAgICAgIHZhciBwcmV2ID0gcHJldlBvaW50c1twcmV2UG9pbnRJbmRleF07CiAgICAgICAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMzUoX29iamVjdFNwcmVhZDM1KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICAgICAgeDogaW50ZXJwb2xhdGUocHJldi54LCBlbnRyeS54LCB0KSwKICAgICAgICAgICAgICB5OiBpbnRlcnBvbGF0ZShwcmV2LnksIGVudHJ5LnksIHQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVudHJ5OwogICAgICAgIH0pCiAgICAgICk7CiAgICAgIHZhciBzdGVwQmFzZUxpbmU7CiAgICAgIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgICAgICBzdGVwQmFzZUxpbmUgPSBpbnRlcnBvbGF0ZShwcmV2QmFzZUxpbmUsIGJhc2VMaW5lLCB0KTsKICAgICAgfSBlbHNlIGlmIChpc051bGxpc2goYmFzZUxpbmUpIHx8IGlzTmFuKGJhc2VMaW5lKSkgewogICAgICAgIHN0ZXBCYXNlTGluZSA9IGludGVycG9sYXRlKHByZXZCYXNlTGluZSwgMCwgdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RlcEJhc2VMaW5lID0gYmFzZUxpbmUubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgICAgIHZhciBwcmV2UG9pbnRJbmRleCA9IE1hdGguZmxvb3IoaW5kZXggKiBwcmV2UG9pbnRzRGlmZkZhY3Rvcik7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwcmV2QmFzZUxpbmUpICYmIHByZXZCYXNlTGluZVtwcmV2UG9pbnRJbmRleF0pIHsKICAgICAgICAgICAgdmFyIHByZXYgPSBwcmV2QmFzZUxpbmVbcHJldlBvaW50SW5kZXhdOwogICAgICAgICAgICByZXR1cm4gX29iamVjdFNwcmVhZDM1KF9vYmplY3RTcHJlYWQzNSh7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgICAgIHg6IGludGVycG9sYXRlKHByZXYueCwgZW50cnkueCwgdCksCiAgICAgICAgICAgICAgeTogaW50ZXJwb2xhdGUocHJldi55LCBlbnRyeS55LCB0KQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnRyeTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodCA+IDApIHsKICAgICAgICBwcmV2aW91c1BvaW50c1JlZi5jdXJyZW50ID0gc3RlcFBvaW50czsKICAgICAgICBwcmV2aW91c0Jhc2VsaW5lUmVmLmN1cnJlbnQgPSBzdGVwQmFzZUxpbmU7CiAgICAgIH0KICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoU3RhdGljQXJlYSwgewogICAgICAgIHBvaW50czogc3RlcFBvaW50cywKICAgICAgICBiYXNlTGluZTogc3RlcEJhc2VMaW5lLAogICAgICAgIG5lZWRDbGlwLAogICAgICAgIGNsaXBQYXRoSWQsCiAgICAgICAgcHJvcHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodCA+IDApIHsKICAgICAgcHJldmlvdXNQb2ludHNSZWYuY3VycmVudCA9IHBvaW50czsKICAgICAgcHJldmlvdXNCYXNlbGluZVJlZi5jdXJyZW50ID0gYmFzZUxpbmU7CiAgICB9CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChMYXllciwgbnVsbCwgaXNBbmltYXRpb25BY3RpdmUgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIiwgewogICAgICBpZDogImFuaW1hdGlvbkNsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQpCiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KENsaXBSZWN0LCB7CiAgICAgIGFscGhhOiB0LAogICAgICBwb2ludHMsCiAgICAgIGJhc2VMaW5lLAogICAgICBsYXlvdXQsCiAgICAgIHN0cm9rZVdpZHRoOiBwcm9wcy5zdHJva2VXaWR0aAogICAgfSkpKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgICBjbGlwUGF0aDogInVybCgjYW5pbWF0aW9uQ2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCwgIikiKQogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChTdGF0aWNBcmVhLCB7CiAgICAgIHBvaW50cywKICAgICAgYmFzZUxpbmUsCiAgICAgIG5lZWRDbGlwLAogICAgICBjbGlwUGF0aElkLAogICAgICBwcm9wcwogICAgfSkpKTsKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChMYWJlbExpc3RGcm9tTGFiZWxQcm9wLCB7CiAgICBsYWJlbDogcHJvcHMubGFiZWwKICB9KSk7Cn0KZnVuY3Rpb24gUmVuZGVyQXJlYShfcmVmOSkgewogIHZhciB7CiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcwogIH0gPSBfcmVmOTsKICB2YXIgcHJldmlvdXNQb2ludHNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDEudXNlUmVmKShudWxsKTsKICB2YXIgcHJldmlvdXNCYXNlbGluZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MS51c2VSZWYpKCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoQXJlYVdpdGhBbmltYXRpb24sIHsKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzLAogICAgcHJldmlvdXNQb2ludHNSZWYsCiAgICBwcmV2aW91c0Jhc2VsaW5lUmVmCiAgfSk7Cn0KdmFyIEFyZWFXaXRoU3RhdGUgPSBjbGFzcyBleHRlbmRzIGltcG9ydF9yZWFjdDQxLlB1cmVDb21wb25lbnQgewogIHJlbmRlcigpIHsKICAgIHZhciB7CiAgICAgIGhpZGUsCiAgICAgIGRvdCwKICAgICAgcG9pbnRzLAogICAgICBjbGFzc05hbWUsCiAgICAgIHRvcCwKICAgICAgbGVmdCwKICAgICAgbmVlZENsaXAsCiAgICAgIHhBeGlzSWQsCiAgICAgIHlBeGlzSWQsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIGlkLAogICAgICBiYXNlTGluZSwKICAgICAgekluZGV4CiAgICB9ID0gdGhpcy5wcm9wczsKICAgIGlmIChoaWRlKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1hcmVhIiwgY2xhc3NOYW1lKTsKICAgIHZhciBjbGlwUGF0aElkID0gaWQ7CiAgICB2YXIgewogICAgICByOiByMiwKICAgICAgc3Ryb2tlV2lkdGgKICAgIH0gPSBnZXRSYWRpdXNBbmRTdHJva2VXaWR0aEZyb21Eb3QoZG90KTsKICAgIHZhciBjbGlwRG90ID0gaXNDbGlwRG90KGRvdCk7CiAgICB2YXIgZG90U2l6ZSA9IHIyICogMiArIHN0cm9rZVdpZHRoOwogICAgdmFyIGFjdGl2ZVBvaW50c0NsaXBQYXRoID0gbmVlZENsaXAgPyAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwRG90ID8gIiIgOiAiZG90cy0iKS5jb25jYXQoY2xpcFBhdGhJZCwgIikiKSA6IHZvaWQgMDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICAgIHpJbmRleAogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MKICAgIH0sIG5lZWRDbGlwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KEdyYXBoaWNhbEl0ZW1DbGlwUGF0aCwgewogICAgICBjbGlwUGF0aElkLAogICAgICB4QXhpc0lkLAogICAgICB5QXhpc0lkCiAgICB9KSwgIWNsaXBEb3QgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICAgIGlkOiAiY2xpcFBhdGgtZG90cy0iLmNvbmNhdChjbGlwUGF0aElkKQogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAgeDogbGVmdCAtIGRvdFNpemUgLyAyLAogICAgICB5OiB0b3AgLSBkb3RTaXplIC8gMiwKICAgICAgd2lkdGg6IHdpZHRoICsgZG90U2l6ZSwKICAgICAgaGVpZ2h0OiBoZWlnaHQgKyBkb3RTaXplCiAgICB9KSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFJlbmRlckFyZWEsIHsKICAgICAgbmVlZENsaXAsCiAgICAgIGNsaXBQYXRoSWQsCiAgICAgIHByb3BzOiB0aGlzLnByb3BzCiAgICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoQWN0aXZlUG9pbnRzLCB7CiAgICAgIHBvaW50cywKICAgICAgbWFpbkNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3IodGhpcy5wcm9wcy5zdHJva2UsIHRoaXMucHJvcHMuZmlsbCksCiAgICAgIGl0ZW1EYXRhS2V5OiB0aGlzLnByb3BzLmRhdGFLZXksCiAgICAgIGFjdGl2ZURvdDogdGhpcy5wcm9wcy5hY3RpdmVEb3QsCiAgICAgIGNsaXBQYXRoOiBhY3RpdmVQb2ludHNDbGlwUGF0aAogICAgfSksIHRoaXMucHJvcHMuaXNSYW5nZSAmJiBBcnJheS5pc0FycmF5KGJhc2VMaW5lKSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KEFjdGl2ZVBvaW50cywgewogICAgICBwb2ludHM6IGJhc2VMaW5lLAogICAgICBtYWluQ29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcih0aGlzLnByb3BzLnN0cm9rZSwgdGhpcy5wcm9wcy5maWxsKSwKICAgICAgaXRlbURhdGFLZXk6IHRoaXMucHJvcHMuZGF0YUtleSwKICAgICAgYWN0aXZlRG90OiB0aGlzLnByb3BzLmFjdGl2ZURvdCwKICAgICAgY2xpcFBhdGg6IGFjdGl2ZVBvaW50c0NsaXBQYXRoCiAgICB9KSk7CiAgfQp9Owp2YXIgZGVmYXVsdEFyZWFQcm9wcyA9IHsKICBhY3RpdmVEb3Q6IHRydWUsCiAgYW5pbWF0aW9uQmVnaW46IDAsCiAgYW5pbWF0aW9uRHVyYXRpb246IDE1MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIsCiAgY29ubmVjdE51bGxzOiBmYWxzZSwKICBkb3Q6IGZhbHNlLAogIGZpbGw6ICIjMzE4MmJkIiwKICBmaWxsT3BhY2l0eTogMC42LAogIGhpZGU6IGZhbHNlLAogIGlzQW5pbWF0aW9uQWN0aXZlOiAiYXV0byIsCiAgbGVnZW5kVHlwZTogImxpbmUiLAogIHN0cm9rZTogIiMzMTgyYmQiLAogIHN0cm9rZVdpZHRoOiAxLAogIHR5cGU6ICJsaW5lYXIiLAogIGxhYmVsOiBmYWxzZSwKICB4QXhpc0lkOiAwLAogIHlBeGlzSWQ6IDAsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXJlYQp9OwpmdW5jdGlvbiBBcmVhSW1wbChwcm9wcykgewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgdmFyIF9yZXNvbHZlRGVmYXVsdFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcywgZGVmYXVsdEFyZWFQcm9wcyksIHsKICAgIGFjdGl2ZURvdCwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBjb25uZWN0TnVsbHMsCiAgICBkb3QsCiAgICBmaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICBoaWRlLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBsZWdlbmRUeXBlLAogICAgc3Ryb2tlLAogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQKICB9ID0gX3Jlc29sdmVEZWZhdWx0UHJvcHMsIGV2ZXJ5dGhpbmdFbHNlID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTUoX3Jlc29sdmVEZWZhdWx0UHJvcHMsIF9leGNsdWRlZDI3KTsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICB2YXIgY2hhcnROYW1lID0gdXNlQ2hhcnROYW1lKCk7CiAgdmFyIHsKICAgIG5lZWRDbGlwCiAgfSA9IHVzZU5lZWRzQ2xpcCh4QXhpc0lkLCB5QXhpc0lkKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgewogICAgcG9pbnRzLAogICAgaXNSYW5nZSwKICAgIGJhc2VMaW5lCiAgfSA9IChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFyZWEoc3RhdGUsIHhBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEsIHByb3BzLmlkKSkpICE9PSBudWxsICYmIF91c2VBcHBTZWxlY3RvciAhPT0gdm9pZCAwID8gX3VzZUFwcFNlbGVjdG9yIDoge307CiAgdmFyIHBsb3RBcmVhID0gdXNlUGxvdEFyZWEoKTsKICBpZiAobGF5b3V0ICE9PSAiaG9yaXpvbnRhbCIgJiYgbGF5b3V0ICE9PSAidmVydGljYWwiIHx8IHBsb3RBcmVhID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAoY2hhcnROYW1lICE9PSAiQXJlYUNoYXJ0IiAmJiBjaGFydE5hbWUgIT09ICJDb21wb3NlZENoYXJ0IikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBoZWlnaHQsCiAgICB3aWR0aCwKICAgIHg6IGxlZnQsCiAgICB5OiB0b3AKICB9ID0gcGxvdEFyZWE7CiAgaWYgKCFwb2ludHMgfHwgIXBvaW50cy5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChBcmVhV2l0aFN0YXRlLCBfZXh0ZW5kczIwKHt9LCBldmVyeXRoaW5nRWxzZSwgewogICAgYWN0aXZlRG90LAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGJhc2VMaW5lLAogICAgY29ubmVjdE51bGxzLAogICAgZG90LAogICAgZmlsbCwKICAgIGZpbGxPcGFjaXR5LAogICAgaGVpZ2h0LAogICAgaGlkZSwKICAgIGxheW91dCwKICAgIGlzQW5pbWF0aW9uQWN0aXZlOiBpc0FuaW1hdGlvbkFjdGl2ZSA9PT0gImF1dG8iID8gIUdsb2JhbC5pc1NzciA6IGlzQW5pbWF0aW9uQWN0aXZlLAogICAgaXNSYW5nZSwKICAgIGxlZ2VuZFR5cGUsCiAgICBuZWVkQ2xpcCwKICAgIHBvaW50cywKICAgIHN0cm9rZSwKICAgIHdpZHRoLAogICAgbGVmdCwKICAgIHRvcCwKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSkpOwp9CnZhciBnZXRCYXNlVmFsdWUgPSAobGF5b3V0LCBjaGFydEJhc2VWYWx1ZSwgaXRlbUJhc2VWYWx1ZSwgeEF4aXMsIHlBeGlzKSA9PiB7CiAgdmFyIGJhc2VWYWx1ZSA9IGl0ZW1CYXNlVmFsdWUgIT09IG51bGwgJiYgaXRlbUJhc2VWYWx1ZSAhPT0gdm9pZCAwID8gaXRlbUJhc2VWYWx1ZSA6IGNoYXJ0QmFzZVZhbHVlOwogIGlmIChpc051bWJlcihiYXNlVmFsdWUpKSB7CiAgICByZXR1cm4gYmFzZVZhbHVlOwogIH0KICB2YXIgbnVtZXJpY0F4aXMgPSBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHlBeGlzIDogeEF4aXM7CiAgdmFyIGRvbWFpbiA9IG51bWVyaWNBeGlzLnNjYWxlLmRvbWFpbigpOwogIGlmIChudW1lcmljQXhpcy50eXBlID09PSAibnVtYmVyIikgewogICAgdmFyIGRvbWFpbk1heCA9IE1hdGgubWF4KGRvbWFpblswXSwgZG9tYWluWzFdKTsKICAgIHZhciBkb21haW5NaW4gPSBNYXRoLm1pbihkb21haW5bMF0sIGRvbWFpblsxXSk7CiAgICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1pbiIpIHsKICAgICAgcmV0dXJuIGRvbWFpbk1pbjsKICAgIH0KICAgIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWF4IikgewogICAgICByZXR1cm4gZG9tYWluTWF4OwogICAgfQogICAgcmV0dXJuIGRvbWFpbk1heCA8IDAgPyBkb21haW5NYXggOiBNYXRoLm1heChNYXRoLm1pbihkb21haW5bMF0sIGRvbWFpblsxXSksIDApOwogIH0KICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1pbiIpIHsKICAgIHJldHVybiBkb21haW5bMF07CiAgfQogIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWF4IikgewogICAgcmV0dXJuIGRvbWFpblsxXTsKICB9CiAgcmV0dXJuIGRvbWFpblswXTsKfTsKZnVuY3Rpb24gY29tcHV0ZUFyZWEoX3JlZjApIHsKICB2YXIgewogICAgYXJlYVNldHRpbmdzOiB7CiAgICAgIGNvbm5lY3ROdWxscywKICAgICAgYmFzZVZhbHVlOiBpdGVtQmFzZVZhbHVlLAogICAgICBkYXRhS2V5CiAgICB9LAogICAgc3RhY2tlZERhdGEsCiAgICBsYXlvdXQsCiAgICBjaGFydEJhc2VWYWx1ZSwKICAgIHhBeGlzLAogICAgeUF4aXMsCiAgICBkaXNwbGF5ZWREYXRhLAogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICB4QXhpc1RpY2tzLAogICAgeUF4aXNUaWNrcywKICAgIGJhbmRTaXplCiAgfSA9IF9yZWYwOwogIHZhciBoYXNTdGFjayA9IHN0YWNrZWREYXRhICYmIHN0YWNrZWREYXRhLmxlbmd0aDsKICB2YXIgYmFzZVZhbHVlID0gZ2V0QmFzZVZhbHVlKGxheW91dCwgY2hhcnRCYXNlVmFsdWUsIGl0ZW1CYXNlVmFsdWUsIHhBeGlzLCB5QXhpcyk7CiAgdmFyIGlzSG9yaXpvbnRhbExheW91dCA9IGxheW91dCA9PT0gImhvcml6b250YWwiOwogIHZhciBpc1JhbmdlID0gZmFsc2U7CiAgdmFyIHBvaW50cyA9IGRpc3BsYXllZERhdGEubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgIHZhciB2YWx1ZTsKICAgIGlmIChoYXNTdGFjaykgewogICAgICB2YWx1ZSA9IHN0YWNrZWREYXRhW2RhdGFTdGFydEluZGV4ICsgaW5kZXhdOwogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSk7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IFtiYXNlVmFsdWUsIHZhbHVlXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpc1JhbmdlID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgdmFyIGlzQnJlYWtQb2ludCA9IHZhbHVlWzFdID09IG51bGwgfHwgaGFzU3RhY2sgJiYgIWNvbm5lY3ROdWxscyAmJiBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSkgPT0gbnVsbDsKICAgIGlmIChpc0hvcml6b250YWxMYXlvdXQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBnZXRDYXRlQ29vcmRpbmF0ZU9mTGluZSh7CiAgICAgICAgICBheGlzOiB4QXhpcywKICAgICAgICAgIHRpY2tzOiB4QXhpc1RpY2tzLAogICAgICAgICAgYmFuZFNpemUsCiAgICAgICAgICBlbnRyeSwKICAgICAgICAgIGluZGV4CiAgICAgICAgfSksCiAgICAgICAgeTogaXNCcmVha1BvaW50ID8gbnVsbCA6IHlBeGlzLnNjYWxlKHZhbHVlWzFdKSwKICAgICAgICB2YWx1ZSwKICAgICAgICBwYXlsb2FkOiBlbnRyeQogICAgICB9OwogICAgfQogICAgcmV0dXJuIHsKICAgICAgeDogaXNCcmVha1BvaW50ID8gbnVsbCA6IHhBeGlzLnNjYWxlKHZhbHVlWzFdKSwKICAgICAgeTogZ2V0Q2F0ZUNvb3JkaW5hdGVPZkxpbmUoewogICAgICAgIGF4aXM6IHlBeGlzLAogICAgICAgIHRpY2tzOiB5QXhpc1RpY2tzLAogICAgICAgIGJhbmRTaXplLAogICAgICAgIGVudHJ5LAogICAgICAgIGluZGV4CiAgICAgIH0pLAogICAgICB2YWx1ZSwKICAgICAgcGF5bG9hZDogZW50cnkKICAgIH07CiAgfSk7CiAgdmFyIGJhc2VMaW5lOwogIGlmIChoYXNTdGFjayB8fCBpc1JhbmdlKSB7CiAgICBiYXNlTGluZSA9IHBvaW50cy5tYXAoKGVudHJ5KSA9PiB7CiAgICAgIHZhciB4MiA9IEFycmF5LmlzQXJyYXkoZW50cnkudmFsdWUpID8gZW50cnkudmFsdWVbMF0gOiBudWxsOwogICAgICBpZiAoaXNIb3Jpem9udGFsTGF5b3V0KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHg6IGVudHJ5LngsCiAgICAgICAgICB5OiB4MiAhPSBudWxsICYmIGVudHJ5LnkgIT0gbnVsbCA/IHlBeGlzLnNjYWxlKHgyKSA6IG51bGwsCiAgICAgICAgICBwYXlsb2FkOiBlbnRyeS5wYXlsb2FkCiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHg6IHgyICE9IG51bGwgPyB4QXhpcy5zY2FsZSh4MikgOiBudWxsLAogICAgICAgIHk6IGVudHJ5LnksCiAgICAgICAgcGF5bG9hZDogZW50cnkucGF5bG9hZAogICAgICB9OwogICAgfSk7CiAgfSBlbHNlIHsKICAgIGJhc2VMaW5lID0gaXNIb3Jpem9udGFsTGF5b3V0ID8geUF4aXMuc2NhbGUoYmFzZVZhbHVlKSA6IHhBeGlzLnNjYWxlKGJhc2VWYWx1ZSk7CiAgfQogIHJldHVybiB7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIGlzUmFuZ2UKICB9Owp9CmZ1bmN0aW9uIEFyZWFGbihvdXRzaWRlUHJvcHMpIHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgZGVmYXVsdEFyZWFQcm9wcyk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQsIHsKICAgIGlkOiBwcm9wcy5pZCwKICAgIHR5cGU6ICJhcmVhIgogIH0sIChpZCkgPT4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChSZWFjdDMwLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFNldExlZ2VuZFBheWxvYWQsIHsKICAgIGxlZ2VuZFBheWxvYWQ6IGNvbXB1dGVMZWdlbmRQYXlsb2FkRnJvbUFyZWFEYXRhKHByb3BzKQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFNldEFyZWFUb29sdGlwRW50cnlTZXR0aW5ncywgewogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIGRhdGE6IHByb3BzLmRhdGEsCiAgICBzdHJva2U6IHByb3BzLnN0cm9rZSwKICAgIHN0cm9rZVdpZHRoOiBwcm9wcy5zdHJva2VXaWR0aCwKICAgIGZpbGw6IHByb3BzLmZpbGwsCiAgICBuYW1lOiBwcm9wcy5uYW1lLAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICB0b29sdGlwVHlwZTogcHJvcHMudG9vbHRpcFR5cGUKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLCB7CiAgICB0eXBlOiAiYXJlYSIsCiAgICBpZCwKICAgIGRhdGE6IHByb3BzLmRhdGEsCiAgICBkYXRhS2V5OiBwcm9wcy5kYXRhS2V5LAogICAgeEF4aXNJZDogcHJvcHMueEF4aXNJZCwKICAgIHlBeGlzSWQ6IHByb3BzLnlBeGlzSWQsCiAgICB6QXhpc0lkOiAwLAogICAgc3RhY2tJZDogZ2V0Tm9ybWFsaXplZFN0YWNrSWQocHJvcHMuc3RhY2tJZCksCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgYmFyU2l6ZTogdm9pZCAwLAogICAgYmFzZVZhbHVlOiBwcm9wcy5iYXNlVmFsdWUsCiAgICBpc1Bhbm9yYW1hLAogICAgY29ubmVjdE51bGxzOiBwcm9wcy5jb25uZWN0TnVsbHMKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChBcmVhSW1wbCwgX2V4dGVuZHMyMCh7fSwgcHJvcHMsIHsKICAgIGlkCiAgfSkpKSk7Cn0KdmFyIEFyZWEgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5tZW1vKEFyZWFGbiwgcHJvcHNBcmVFcXVhbCk7CkFyZWEuZGlzcGxheU5hbWUgPSAiQXJlYSI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9YQXhpcy5qcwp2YXIgUmVhY3QzMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2F4aXNQcm9wc0FyZUVxdWFsLmpzCnZhciBfZXhjbHVkZWQxNiA9IFsiZG9tYWluIiwgInJhbmdlIl07CnZhciBfZXhjbHVkZWQyOCA9IFsiZG9tYWluIiwgInJhbmdlIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczE2KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTYocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIHNob3J0QXJyYXlzQXJlRXF1YWwoYXJyMSwgYXJyMikgewogIGlmIChhcnIxID09PSBhcnIyKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKEFycmF5LmlzQXJyYXkoYXJyMSkgJiYgYXJyMS5sZW5ndGggPT09IDIgJiYgQXJyYXkuaXNBcnJheShhcnIyKSAmJiBhcnIyLmxlbmd0aCA9PT0gMikgewogICAgcmV0dXJuIGFycjFbMF0gPT09IGFycjJbMF0gJiYgYXJyMVsxXSA9PT0gYXJyMlsxXTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGF4aXNQcm9wc0FyZUVxdWFsKHByZXZQcm9wcywgbmV4dFByb3BzKSB7CiAgaWYgKHByZXZQcm9wcyA9PT0gbmV4dFByb3BzKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdmFyIHsKICAgIGRvbWFpbjogcHJldkRvbWFpbiwKICAgIHJhbmdlOiBwcmV2UmFuZ2UKICB9ID0gcHJldlByb3BzLCBwcmV2UmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE2KHByZXZQcm9wcywgX2V4Y2x1ZGVkMTYpOwogIHZhciB7CiAgICBkb21haW46IG5leHREb21haW4sCiAgICByYW5nZTogbmV4dFJhbmdlCiAgfSA9IG5leHRQcm9wcywgbmV4dFJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNihuZXh0UHJvcHMsIF9leGNsdWRlZDI4KTsKICBpZiAoIXNob3J0QXJyYXlzQXJlRXF1YWwocHJldkRvbWFpbiwgbmV4dERvbWFpbikpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKCFzaG9ydEFycmF5c0FyZUVxdWFsKHByZXZSYW5nZSwgbmV4dFJhbmdlKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gcHJvcHNBcmVFcXVhbChwcmV2UmVzdCwgbmV4dFJlc3QpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9YQXhpcy5qcwp2YXIgX2V4Y2x1ZGVkMTcgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgInRpY2tzIl07CnZhciBfZXhjbHVkZWQyOSA9IFsiaWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMyMSgpIHsKICByZXR1cm4gX2V4dGVuZHMyMSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjEuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTcoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE3KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBTZXRYQXhpc1NldHRpbmdzKHNldHRpbmdzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDQyLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDQyLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFhBeGlzKHNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSBzZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlWEF4aXMoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gc2V0dGluZ3M7CiAgfSwgW3NldHRpbmdzLCBkaXNwYXRjaF0pOwogICgwLCBpbXBvcnRfcmVhY3Q0Mi51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVhBeGlzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CnZhciBYQXhpc0ltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICB2YXIgdmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEF4aXNWaWV3Qm94KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgYXhpc1R5cGUgPSAieEF4aXMiOwogIHZhciBzY2FsZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXhpc1NjYWxlKHN0YXRlLCBheGlzVHlwZSwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBjYXJ0ZXNpYW5UaWNrSXRlbXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRpY2tzT2ZBeGlzKHN0YXRlLCBheGlzVHlwZSwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBheGlzU2l6ZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNTaXplKHN0YXRlLCB4QXhpc0lkKSk7CiAgdmFyIHBvc2l0aW9uID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1Bvc2l0aW9uKHN0YXRlLCB4QXhpc0lkKSk7CiAgdmFyIHN5bmNocm9uaXplZFNldHRpbmdzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgeEF4aXNJZCkpOwogIGlmIChheGlzU2l6ZSA9PSBudWxsIHx8IHBvc2l0aW9uID09IG51bGwgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBkYW5nZXJvdXNseVNldElubmVySFRNTCwKICAgIHRpY2tzOiB0aWNrczIKICB9ID0gcHJvcHMsIGFsbE90aGVyUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNyhwcm9wcywgX2V4Y2x1ZGVkMTcpOwogIHZhciB7CiAgICBpZAogIH0gPSBzeW5jaHJvbml6ZWRTZXR0aW5ncywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTcoc3luY2hyb25pemVkU2V0dGluZ3MsIF9leGNsdWRlZDI5KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzEuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzLCBfZXh0ZW5kczIxKHt9LCBhbGxPdGhlclByb3BzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MsIHsKICAgIHNjYWxlLAogICAgeDogcG9zaXRpb24ueCwKICAgIHk6IHBvc2l0aW9uLnksCiAgICB3aWR0aDogYXhpc1NpemUud2lkdGgsCiAgICBoZWlnaHQ6IGF4aXNTaXplLmhlaWdodCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICIgIikuY29uY2F0KGF4aXNUeXBlKSwgY2xhc3NOYW1lKSwKICAgIHZpZXdCb3gsCiAgICB0aWNrczogY2FydGVzaWFuVGlja0l0ZW1zLAogICAgYXhpc1R5cGUKICB9KSk7Cn07CnZhciB4QXhpc0RlZmF1bHRQcm9wcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogaW1wbGljaXRYQXhpcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBpbXBsaWNpdFhBeGlzLmFsbG93RGVjaW1hbHMsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGltcGxpY2l0WEF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgYW5nbGU6IGltcGxpY2l0WEF4aXMuYW5nbGUsCiAgYXhpc0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMuYXhpc0xpbmUsCiAgaGVpZ2h0OiBpbXBsaWNpdFhBeGlzLmhlaWdodCwKICBoaWRlOiBmYWxzZSwKICBpbmNsdWRlSGlkZGVuOiBpbXBsaWNpdFhBeGlzLmluY2x1ZGVIaWRkZW4sCiAgaW50ZXJ2YWw6IGltcGxpY2l0WEF4aXMuaW50ZXJ2YWwsCiAgbWluVGlja0dhcDogaW1wbGljaXRYQXhpcy5taW5UaWNrR2FwLAogIG1pcnJvcjogaW1wbGljaXRYQXhpcy5taXJyb3IsCiAgb3JpZW50YXRpb246IGltcGxpY2l0WEF4aXMub3JpZW50YXRpb24sCiAgcGFkZGluZzogaW1wbGljaXRYQXhpcy5wYWRkaW5nLAogIHJldmVyc2VkOiBpbXBsaWNpdFhBeGlzLnJldmVyc2VkLAogIHNjYWxlOiBpbXBsaWNpdFhBeGlzLnNjYWxlLAogIHRpY2s6IGltcGxpY2l0WEF4aXMudGljaywKICB0aWNrQ291bnQ6IGltcGxpY2l0WEF4aXMudGlja0NvdW50LAogIHRpY2tMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLnRpY2tMaW5lLAogIHRpY2tTaXplOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLnRpY2tTaXplLAogIHR5cGU6IGltcGxpY2l0WEF4aXMudHlwZSwKICB4QXhpc0lkOiAwCn07CnZhciBYQXhpc1NldHRpbmdzRGlzcGF0Y2hlciA9IChvdXRzaWRlUHJvcHMpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgeEF4aXNEZWZhdWx0UHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KFJlYWN0MzEuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoU2V0WEF4aXNTZXR0aW5ncywgewogICAgYWxsb3dEYXRhT3ZlcmZsb3c6IHByb3BzLmFsbG93RGF0YU92ZXJmbG93LAogICAgYWxsb3dEZWNpbWFsczogcHJvcHMuYWxsb3dEZWNpbWFscywKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBwcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGFuZ2xlOiBwcm9wcy5hbmdsZSwKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBkb21haW46IHByb3BzLmRvbWFpbiwKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIGlkOiBwcm9wcy54QXhpc0lkLAogICAgaW5jbHVkZUhpZGRlbjogcHJvcHMuaW5jbHVkZUhpZGRlbiwKICAgIGludGVydmFsOiBwcm9wcy5pbnRlcnZhbCwKICAgIG1pblRpY2tHYXA6IHByb3BzLm1pblRpY2tHYXAsCiAgICBtaXJyb3I6IHByb3BzLm1pcnJvciwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgcmV2ZXJzZWQ6IHByb3BzLnJldmVyc2VkLAogICAgc2NhbGU6IHByb3BzLnNjYWxlLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tDb3VudDogcHJvcHMudGlja0NvdW50LAogICAgdGlja0Zvcm1hdHRlcjogcHJvcHMudGlja0Zvcm1hdHRlciwKICAgIHRpY2tzOiBwcm9wcy50aWNrcywKICAgIHR5cGU6IHByb3BzLnR5cGUsCiAgICB1bml0OiBwcm9wcy51bml0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoWEF4aXNJbXBsLCBwcm9wcykpOwp9Owp2YXIgWEF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5tZW1vKFhBeGlzU2V0dGluZ3NEaXNwYXRjaGVyLCBheGlzUHJvcHNBcmVFcXVhbCk7ClhBeGlzLmRpc3BsYXlOYW1lID0gIlhBeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL1lBeGlzLmpzCnZhciBSZWFjdDMyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQxOCA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAidGlja3MiXTsKdmFyIF9leGNsdWRlZDIxMCA9IFsiaWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMyMigpIHsKICByZXR1cm4gX2V4dGVuZHMyMiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxOChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTgoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE4KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBTZXRZQXhpc1NldHRpbmdzKHNldHRpbmdzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDQzLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDQzLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFlBeGlzKHNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSBzZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlWUF4aXMoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gc2V0dGluZ3M7CiAgfSwgW3NldHRpbmdzLCBkaXNwYXRjaF0pOwogICgwLCBpbXBvcnRfcmVhY3Q0My51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVlBeGlzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CnZhciBZQXhpc0ltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgeUF4aXNJZCwKICAgIGNsYXNzTmFtZSwKICAgIHdpZHRoLAogICAgbGFiZWwKICB9ID0gcHJvcHM7CiAgdmFyIGNhcnRlc2lhbkF4aXNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDMudXNlUmVmKShudWxsKTsKICB2YXIgbGFiZWxSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDMudXNlUmVmKShudWxsKTsKICB2YXIgdmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEF4aXNWaWV3Qm94KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBheGlzVHlwZSA9ICJ5QXhpcyI7CiAgdmFyIHNjYWxlID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzU2NhbGUoc3RhdGUsIGF4aXNUeXBlLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIGF4aXNTaXplID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RZQXhpc1NpemUoc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgcG9zaXRpb24gPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzUG9zaXRpb24oc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgY2FydGVzaWFuVGlja0l0ZW1zID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUaWNrc09mQXhpcyhzdGF0ZSwgYXhpc1R5cGUsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgc3luY2hyb25pemVkU2V0dGluZ3MgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCB5QXhpc0lkKSk7CiAgKDAsIGltcG9ydF9yZWFjdDQzLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHdpZHRoICE9PSAiYXV0byIgfHwgIWF4aXNTaXplIHx8IGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSB8fCAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQzLmlzVmFsaWRFbGVtZW50KShsYWJlbCkgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgYXhpc0NvbXBvbmVudCA9IGNhcnRlc2lhbkF4aXNSZWYuY3VycmVudDsKICAgIGlmICghYXhpc0NvbXBvbmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdXBkYXRlZFlBeGlzV2lkdGggPSBheGlzQ29tcG9uZW50LmdldENhbGN1bGF0ZWRXaWR0aCgpOwogICAgaWYgKE1hdGgucm91bmQoYXhpc1NpemUud2lkdGgpICE9PSBNYXRoLnJvdW5kKHVwZGF0ZWRZQXhpc1dpZHRoKSkgewogICAgICBkaXNwYXRjaCh1cGRhdGVZQXhpc1dpZHRoKHsKICAgICAgICBpZDogeUF4aXNJZCwKICAgICAgICB3aWR0aDogdXBkYXRlZFlBeGlzV2lkdGgKICAgICAgfSkpOwogICAgfQogIH0sIFsKICAgIC8vIFRoZSBkZXBlbmRlbmN5IG9uIGNhcnRlc2lhbkF4aXNSZWYuY3VycmVudCBpcyBub3QgbmVlZGVkIGJlY2F1c2UgdXNlTGF5b3V0RWZmZWN0IHdpbGwgcnVuIGFmdGVyIGV2ZXJ5IHJlbmRlci4KICAgIC8vIFRoZSByZWYgd2lsbCBiZSBwb3B1bGF0ZWQgYnkgdGhlbi4KICAgIC8vIFRvIHJlLXJ1biB0aGlzIGVmZmVjdCB3aGVuIHRpY2tzIGNoYW5nZSwgd2UgY2FuIGRlcGVuZCBvbiB0aGUgdGlja3MgYXJyYXkgZnJvbSB0aGUgc3RvcmUuCiAgICBjYXJ0ZXNpYW5UaWNrSXRlbXMsCiAgICBheGlzU2l6ZSwKICAgIGRpc3BhdGNoLAogICAgbGFiZWwsCiAgICB5QXhpc0lkLAogICAgd2lkdGgsCiAgICBzeW5jaHJvbml6ZWRTZXR0aW5ncwogIF0pOwogIGlmIChheGlzU2l6ZSA9PSBudWxsIHx8IHBvc2l0aW9uID09IG51bGwgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBkYW5nZXJvdXNseVNldElubmVySFRNTCwKICAgIHRpY2tzOiB0aWNrczIKICB9ID0gcHJvcHMsIGFsbE90aGVyUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxOChwcm9wcywgX2V4Y2x1ZGVkMTgpOwogIHZhciB7CiAgICBpZAogIH0gPSBzeW5jaHJvbml6ZWRTZXR0aW5ncywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTgoc3luY2hyb25pemVkU2V0dGluZ3MsIF9leGNsdWRlZDIxMCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuQXhpcywgX2V4dGVuZHMyMih7fSwgYWxsT3RoZXJQcm9wcywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzLCB7CiAgICByZWY6IGNhcnRlc2lhbkF4aXNSZWYsCiAgICBsYWJlbFJlZiwKICAgIHNjYWxlLAogICAgeDogcG9zaXRpb24ueCwKICAgIHk6IHBvc2l0aW9uLnksCiAgICB0aWNrVGV4dFByb3BzOiB3aWR0aCA9PT0gImF1dG8iID8gewogICAgICB3aWR0aDogdm9pZCAwCiAgICB9IDogewogICAgICB3aWR0aAogICAgfSwKICAgIHdpZHRoOiBheGlzU2l6ZS53aWR0aCwKICAgIGhlaWdodDogYXhpc1NpemUuaGVpZ2h0LAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIiAiKS5jb25jYXQoYXhpc1R5cGUpLCBjbGFzc05hbWUpLAogICAgdmlld0JveCwKICAgIHRpY2tzOiBjYXJ0ZXNpYW5UaWNrSXRlbXMsCiAgICBheGlzVHlwZQogIH0pKTsKfTsKdmFyIHlBeGlzRGVmYXVsdFByb3BzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBpbXBsaWNpdFlBeGlzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGltcGxpY2l0WUF4aXMuYWxsb3dEZWNpbWFscywKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogaW1wbGljaXRZQXhpcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBhbmdsZTogaW1wbGljaXRZQXhpcy5hbmdsZSwKICBheGlzTGluZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy5heGlzTGluZSwKICBoaWRlOiBmYWxzZSwKICBpbmNsdWRlSGlkZGVuOiBpbXBsaWNpdFlBeGlzLmluY2x1ZGVIaWRkZW4sCiAgaW50ZXJ2YWw6IGltcGxpY2l0WUF4aXMuaW50ZXJ2YWwsCiAgbWluVGlja0dhcDogaW1wbGljaXRZQXhpcy5taW5UaWNrR2FwLAogIG1pcnJvcjogaW1wbGljaXRZQXhpcy5taXJyb3IsCiAgb3JpZW50YXRpb246IGltcGxpY2l0WUF4aXMub3JpZW50YXRpb24sCiAgcGFkZGluZzogaW1wbGljaXRZQXhpcy5wYWRkaW5nLAogIHJldmVyc2VkOiBpbXBsaWNpdFlBeGlzLnJldmVyc2VkLAogIHNjYWxlOiBpbXBsaWNpdFlBeGlzLnNjYWxlLAogIHRpY2s6IGltcGxpY2l0WUF4aXMudGljaywKICB0aWNrQ291bnQ6IGltcGxpY2l0WUF4aXMudGlja0NvdW50LAogIHRpY2tMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLnRpY2tMaW5lLAogIHRpY2tTaXplOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLnRpY2tTaXplLAogIHR5cGU6IGltcGxpY2l0WUF4aXMudHlwZSwKICB3aWR0aDogaW1wbGljaXRZQXhpcy53aWR0aCwKICB5QXhpc0lkOiAwCn07CnZhciBZQXhpc1NldHRpbmdzRGlzcGF0Y2hlciA9IChvdXRzaWRlUHJvcHMpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgeUF4aXNEZWZhdWx0UHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlYWN0MzIuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoU2V0WUF4aXNTZXR0aW5ncywgewogICAgaW50ZXJ2YWw6IHByb3BzLmludGVydmFsLAogICAgaWQ6IHByb3BzLnlBeGlzSWQsCiAgICBzY2FsZTogcHJvcHMuc2NhbGUsCiAgICB0eXBlOiBwcm9wcy50eXBlLAogICAgZG9tYWluOiBwcm9wcy5kb21haW4sCiAgICBhbGxvd0RhdGFPdmVyZmxvdzogcHJvcHMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgICBkYXRhS2V5OiBwcm9wcy5kYXRhS2V5LAogICAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHByb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgYWxsb3dEZWNpbWFsczogcHJvcHMuYWxsb3dEZWNpbWFscywKICAgIHRpY2tDb3VudDogcHJvcHMudGlja0NvdW50LAogICAgcGFkZGluZzogcHJvcHMucGFkZGluZywKICAgIGluY2x1ZGVIaWRkZW46IHByb3BzLmluY2x1ZGVIaWRkZW4sCiAgICByZXZlcnNlZDogcHJvcHMucmV2ZXJzZWQsCiAgICB0aWNrczogcHJvcHMudGlja3MsCiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBtaXJyb3I6IHByb3BzLm1pcnJvciwKICAgIGhpZGU6IHByb3BzLmhpZGUsCiAgICB1bml0OiBwcm9wcy51bml0LAogICAgbmFtZTogcHJvcHMubmFtZSwKICAgIGFuZ2xlOiBwcm9wcy5hbmdsZSwKICAgIG1pblRpY2tHYXA6IHByb3BzLm1pblRpY2tHYXAsCiAgICB0aWNrOiBwcm9wcy50aWNrLAogICAgdGlja0Zvcm1hdHRlcjogcHJvcHMudGlja0Zvcm1hdHRlcgogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFlBeGlzSW1wbCwgcHJvcHMpKTsKfTsKdmFyIFlBeGlzID0gLyogQF9fUFVSRV9fICovIFJlYWN0MzIubWVtbyhZQXhpc1NldHRpbmdzRGlzcGF0Y2hlciwgYXhpc1Byb3BzQXJlRXF1YWwpOwpZQXhpcy5kaXNwbGF5TmFtZSA9ICJZQXhpcyI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhcnRlc2lhbkNoYXJ0LmpzCnZhciBSZWFjdDM4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlY2hhcnRzU3RvcmVQcm92aWRlci5qcwp2YXIgUmVhY3QzMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyLmpzCnZhciBwaWNrQ2hhcnRQb2ludGVyID0gKF9zdGF0ZSwgY2hhcnRQb2ludGVyKSA9PiBjaGFydFBvaW50ZXI7CnZhciBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIgPSBjcmVhdGVTZWxlY3RvcihbcGlja0NoYXJ0UG9pbnRlciwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFBvbGFyVmlld0JveCwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwQXhpc1JhbmdlV2l0aFJldmVyc2UsIHNlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdE9yZGVyZWRUb29sdGlwVGlja3MsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWxdLCBjb21iaW5lQWN0aXZlUHJvcHMpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldENoYXJ0UG9pbnRlci5qcwp2YXIgZ2V0Q2hhcnRQb2ludGVyID0gKGV2ZW50KSA9PiB7CiAgdmFyIHJlY3QgPSBldmVudC5jdXJyZW50VGFyZ2V0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIHZhciBzY2FsZVggPSByZWN0LndpZHRoIC8gZXZlbnQuY3VycmVudFRhcmdldC5vZmZzZXRXaWR0aDsKICB2YXIgc2NhbGVZID0gcmVjdC5oZWlnaHQgLyBldmVudC5jdXJyZW50VGFyZ2V0Lm9mZnNldEhlaWdodDsKICByZXR1cm4gewogICAgLyoKICAgICAqIEhlcmUgaXQncyBpbXBvcnRhbnQgdG8gdXNlOgogICAgICogLSBldmVudC5jbGllbnRYIGFuZCBldmVudC5jbGllbnRZIHRvIGdldCB0aGUgbW91c2UgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0LCBpbmNsdWRpbmcgc2Nyb2xsLgogICAgICogLSBwYWdlWCBhbmQgcGFnZVkgYXJlIG5vdCB1c2VkIGJlY2F1c2UgdGhleSBhcmUgcmVsYXRpdmUgdG8gdGhlIHdob2xlIGRvY3VtZW50LCBhbmQgaWdub3JlIHNjcm9sbC4KICAgICAqIC0gcmVjdC5sZWZ0IGFuZCByZWN0LnRvcCBhcmUgdXNlZCB0byBnZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBjaGFydCByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQuCiAgICAgKiAtIG9mZnNldFggYW5kIG9mZnNldFkgYXJlIG5vdCB1c2VkIGJlY2F1c2UgdGhleSBhcmUgcmVsYXRpdmUgdG8gdGhlIG9mZnNldCBwYXJlbnQKICAgICAqICB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSB0aGUgc2FtZSBhcyB0aGUgY2xpZW50WCBhbmQgY2xpZW50WSwgZGVwZW5kaW5nIG9uIHRoZSBwb3NpdGlvbiBvZiB0aGUgY2hhcnQgaW4gdGhlIERPTQogICAgICogIGFuZCBzdXJyb3VuZGluZyBlbGVtZW50IHN0eWxlcy4gQ1NTIHBvc2l0aW9uOiByZWxhdGl2ZSwgYWJzb2x1dGUsIGZpeGVkLCB3aWxsIGNoYW5nZSB0aGUgb2Zmc2V0IHBhcmVudC4KICAgICAqIC0gc2NhbGVYIGFuZCBzY2FsZVkgYXJlIG5lY2Vzc2FyeSBmb3Igd2hlbiB0aGUgY2hhcnQgZWxlbWVudCBpcyBzY2FsZWQgdXNpbmcgQ1NTIGB0cmFuc2Zvcm06IHNjYWxlKE4pYC4KICAgICAqLwogICAgY2hhcnRYOiBNYXRoLnJvdW5kKChldmVudC5jbGllbnRYIC0gcmVjdC5sZWZ0KSAvIHNjYWxlWCksCiAgICBjaGFydFk6IE1hdGgucm91bmQoKGV2ZW50LmNsaWVudFkgLSByZWN0LnRvcCkgLyBzY2FsZVkpCiAgfTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvbW91c2VFdmVudHNNaWRkbGV3YXJlLmpzCnZhciBtb3VzZUNsaWNrQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJtb3VzZUNsaWNrIik7CnZhciBtb3VzZUNsaWNrTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwptb3VzZUNsaWNrTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogbW91c2VDbGlja0FjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgbW91c2VQb2ludGVyID0gYWN0aW9uLnBheWxvYWQ7CiAgICB2YXIgYWN0aXZlUHJvcHMgPSBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIobGlzdGVuZXJBcGkuZ2V0U3RhdGUoKSwgZ2V0Q2hhcnRQb2ludGVyKG1vdXNlUG9pbnRlcikpOwogICAgaWYgKChhY3RpdmVQcm9wcyA9PT0gbnVsbCB8fCBhY3RpdmVQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgpICE9IG51bGwpIHsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0TW91c2VDbGlja0F4aXNJbmRleCh7CiAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4LAogICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3RpdmVQcm9wcy5hY3RpdmVDb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwp2YXIgbW91c2VNb3ZlQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJtb3VzZU1vdmUiKTsKdmFyIG1vdXNlTW92ZU1pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKdmFyIHJhZklkID0gbnVsbDsKbW91c2VNb3ZlTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogbW91c2VNb3ZlQWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBtb3VzZVBvaW50ZXIgPSBhY3Rpb24ucGF5bG9hZDsKICAgIGlmIChyYWZJZCAhPT0gbnVsbCkgewogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyYWZJZCk7CiAgICB9CiAgICB2YXIgY2hhcnRQb2ludGVyID0gZ2V0Q2hhcnRQb2ludGVyKG1vdXNlUG9pbnRlcik7CiAgICByYWZJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICAgIHZhciB0b29sdGlwRXZlbnRUeXBlID0gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5zaGFyZWQpOwogICAgICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgICAgdmFyIGFjdGl2ZVByb3BzID0gc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyKHN0YXRlLCBjaGFydFBvaW50ZXIpOwogICAgICAgIGlmICgoYWN0aXZlUHJvcHMgPT09IG51bGwgfHwgYWN0aXZlUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4KSAhPSBudWxsKSB7CiAgICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRNb3VzZU92ZXJBeGlzSW5kZXgoewogICAgICAgICAgICBhY3RpdmVJbmRleDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgsCiAgICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aXZlUHJvcHMuYWN0aXZlQ29vcmRpbmF0ZQogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChtb3VzZUxlYXZlQ2hhcnQoKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJhZklkID0gbnVsbDsKICAgIH0pOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3JlZHV4RGV2dG9vbHNKc29uU3RyaW5naWZ5UmVwbGFjZXIuanMKZnVuY3Rpb24gcmVkdXhEZXZ0b29sc0pzb25TdHJpbmdpZnlSZXBsYWNlcihrZXksIHZhbHVlKSB7CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgIHJldHVybiAiSFRNTEVsZW1lbnQgPCIuY29uY2F0KHZhbHVlLnRhZ05hbWUsICcgY2xhc3M9IicpLmNvbmNhdCh2YWx1ZS5jbGFzc05hbWUsICciPicpOwogIH0KICBpZiAodmFsdWUgPT09IHdpbmRvdykgewogICAgcmV0dXJuICJnbG9iYWwud2luZG93IjsKICB9CiAgaWYgKGtleSA9PT0gImNoaWxkcmVuIiAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICByZXR1cm4gIjw8Q0hJTERSRU4+PiI7CiAgfQogIHJldHVybiB2YWx1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9yb290UHJvcHNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlMTIgPSB7CiAgYWNjZXNzaWJpbGl0eUxheWVyOiB0cnVlLAogIGJhckNhdGVnb3J5R2FwOiAiMTAlIiwKICBiYXJHYXA6IDQsCiAgYmFyU2l6ZTogdm9pZCAwLAogIGNsYXNzTmFtZTogdm9pZCAwLAogIG1heEJhclNpemU6IHZvaWQgMCwKICBzdGFja09mZnNldDogIm5vbmUiLAogIHN5bmNJZDogdm9pZCAwLAogIHN5bmNNZXRob2Q6ICJpbmRleCIsCiAgYmFzZVZhbHVlOiB2b2lkIDAsCiAgcmV2ZXJzZVN0YWNrT3JkZXI6IGZhbHNlCn07CnZhciByb290UHJvcHNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicm9vdFByb3BzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTEyLAogIHJlZHVjZXJzOiB7CiAgICB1cGRhdGVPcHRpb25zOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgX2FjdGlvbiRwYXlsb2FkJGJhckdhOwogICAgICBzdGF0ZS5hY2Nlc3NpYmlsaXR5TGF5ZXIgPSBhY3Rpb24ucGF5bG9hZC5hY2Nlc3NpYmlsaXR5TGF5ZXI7CiAgICAgIHN0YXRlLmJhckNhdGVnb3J5R2FwID0gYWN0aW9uLnBheWxvYWQuYmFyQ2F0ZWdvcnlHYXA7CiAgICAgIHN0YXRlLmJhckdhcCA9IChfYWN0aW9uJHBheWxvYWQkYmFyR2EgPSBhY3Rpb24ucGF5bG9hZC5iYXJHYXApICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCRiYXJHYSAhPT0gdm9pZCAwID8gX2FjdGlvbiRwYXlsb2FkJGJhckdhIDogaW5pdGlhbFN0YXRlMTIuYmFyR2FwOwogICAgICBzdGF0ZS5iYXJTaXplID0gYWN0aW9uLnBheWxvYWQuYmFyU2l6ZTsKICAgICAgc3RhdGUubWF4QmFyU2l6ZSA9IGFjdGlvbi5wYXlsb2FkLm1heEJhclNpemU7CiAgICAgIHN0YXRlLnN0YWNrT2Zmc2V0ID0gYWN0aW9uLnBheWxvYWQuc3RhY2tPZmZzZXQ7CiAgICAgIHN0YXRlLnN5bmNJZCA9IGFjdGlvbi5wYXlsb2FkLnN5bmNJZDsKICAgICAgc3RhdGUuc3luY01ldGhvZCA9IGFjdGlvbi5wYXlsb2FkLnN5bmNNZXRob2Q7CiAgICAgIHN0YXRlLmNsYXNzTmFtZSA9IGFjdGlvbi5wYXlsb2FkLmNsYXNzTmFtZTsKICAgICAgc3RhdGUuYmFzZVZhbHVlID0gYWN0aW9uLnBheWxvYWQuYmFzZVZhbHVlOwogICAgICBzdGF0ZS5yZXZlcnNlU3RhY2tPcmRlciA9IGFjdGlvbi5wYXlsb2FkLnJldmVyc2VTdGFja09yZGVyOwogICAgfQogIH0KfSk7CnZhciByb290UHJvcHNSZWR1Y2VyID0gcm9vdFByb3BzU2xpY2UucmVkdWNlcjsKdmFyIHsKICB1cGRhdGVPcHRpb25zCn0gPSByb290UHJvcHNTbGljZS5hY3Rpb25zOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9wb2xhck9wdGlvbnNTbGljZS5qcwp2YXIgcG9sYXJPcHRpb25zU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInBvbGFyT3B0aW9ucyIsCiAgaW5pdGlhbFN0YXRlOiBudWxsLAogIHJlZHVjZXJzOiB7CiAgICB1cGRhdGVQb2xhck9wdGlvbnM6IChfc3RhdGUsIGFjdGlvbikgPT4gewogICAgICByZXR1cm4gYWN0aW9uLnBheWxvYWQ7CiAgICB9CiAgfQp9KTsKdmFyIHsKICB1cGRhdGVQb2xhck9wdGlvbnMKfSA9IHBvbGFyT3B0aW9uc1NsaWNlLmFjdGlvbnM7CnZhciBwb2xhck9wdGlvbnNSZWR1Y2VyID0gcG9sYXJPcHRpb25zU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUva2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlLmpzCnZhciBrZXlEb3duQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJrZXlEb3duIik7CnZhciBmb2N1c0FjdGlvbiA9IGNyZWF0ZUFjdGlvbigiZm9jdXMiKTsKdmFyIGtleWJvYXJkRXZlbnRzTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwprZXlib2FyZEV2ZW50c01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IGtleURvd25BY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgIHZhciBhY2Nlc3NpYmlsaXR5TGF5ZXJJc0FjdGl2ZSA9IHN0YXRlLnJvb3RQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIgIT09IGZhbHNlOwogICAgaWYgKCFhY2Nlc3NpYmlsaXR5TGF5ZXJJc0FjdGl2ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgewogICAgICBrZXlib2FyZEludGVyYWN0aW9uCiAgICB9ID0gc3RhdGUudG9vbHRpcDsKICAgIHZhciBrZXkgPSBhY3Rpb24ucGF5bG9hZDsKICAgIGlmIChrZXkgIT09ICJBcnJvd1JpZ2h0IiAmJiBrZXkgIT09ICJBcnJvd0xlZnQiICYmIGtleSAhPT0gIkVudGVyIikgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgcmVzb2x2ZWRJbmRleCA9IGNvbWJpbmVBY3RpdmVUb29sdGlwSW5kZXgoa2V5Ym9hcmRJbnRlcmFjdGlvbiwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEoc3RhdGUpLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXkoc3RhdGUpLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbihzdGF0ZSkpOwogICAgdmFyIGN1cnJlbnRJbmRleCA9IHJlc29sdmVkSW5kZXggPT0gbnVsbCA/IC0xIDogTnVtYmVyKHJlc29sdmVkSW5kZXgpOwogICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUoY3VycmVudEluZGV4KSB8fCBjdXJyZW50SW5kZXggPCAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB0b29sdGlwVGlja3MgPSBzZWxlY3RUb29sdGlwQXhpc1RpY2tzKHN0YXRlKTsKICAgIGlmIChrZXkgPT09ICJFbnRlciIpIHsKICAgICAgdmFyIF9jb29yZGluYXRlID0gc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleChzdGF0ZSwgImF4aXMiLCAiaG92ZXIiLCBTdHJpbmcoa2V5Ym9hcmRJbnRlcmFjdGlvbi5pbmRleCkpOwogICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRLZXlib2FyZEludGVyYWN0aW9uKHsKICAgICAgICBhY3RpdmU6ICFrZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSwKICAgICAgICBhY3RpdmVJbmRleDoga2V5Ym9hcmRJbnRlcmFjdGlvbi5pbmRleCwKICAgICAgICBhY3RpdmVEYXRhS2V5OiBrZXlib2FyZEludGVyYWN0aW9uLmRhdGFLZXksCiAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogX2Nvb3JkaW5hdGUKICAgICAgfSkpOwogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGlyZWN0aW9uID0gc2VsZWN0Q2hhcnREaXJlY3Rpb24oc3RhdGUpOwogICAgdmFyIGRpcmVjdGlvbk11bHRpcGxpZXIgPSBkaXJlY3Rpb24gPT09ICJsZWZ0LXRvLXJpZ2h0IiA/IDEgOiAtMTsKICAgIHZhciBtb3ZlbWVudCA9IGtleSA9PT0gIkFycm93UmlnaHQiID8gMSA6IC0xOwogICAgdmFyIG5leHRJbmRleCA9IGN1cnJlbnRJbmRleCArIG1vdmVtZW50ICogZGlyZWN0aW9uTXVsdGlwbGllcjsKICAgIGlmICh0b29sdGlwVGlja3MgPT0gbnVsbCB8fCBuZXh0SW5kZXggPj0gdG9vbHRpcFRpY2tzLmxlbmd0aCB8fCBuZXh0SW5kZXggPCAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBjb29yZGluYXRlID0gc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleChzdGF0ZSwgImF4aXMiLCAiaG92ZXIiLCBTdHJpbmcobmV4dEluZGV4KSk7CiAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRLZXlib2FyZEludGVyYWN0aW9uKHsKICAgICAgYWN0aXZlOiB0cnVlLAogICAgICBhY3RpdmVJbmRleDogbmV4dEluZGV4LnRvU3RyaW5nKCksCiAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogY29vcmRpbmF0ZQogICAgfSkpOwogIH0KfSk7CmtleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogZm9jdXNBY3Rpb24sCiAgZWZmZWN0OiAoX2FjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICB2YXIgYWNjZXNzaWJpbGl0eUxheWVySXNBY3RpdmUgPSBzdGF0ZS5yb290UHJvcHMuYWNjZXNzaWJpbGl0eUxheWVyICE9PSBmYWxzZTsKICAgIGlmICghYWNjZXNzaWJpbGl0eUxheWVySXNBY3RpdmUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHsKICAgICAga2V5Ym9hcmRJbnRlcmFjdGlvbgogICAgfSA9IHN0YXRlLnRvb2x0aXA7CiAgICBpZiAoa2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXggPT0gbnVsbCkgewogICAgICB2YXIgbmV4dEluZGV4ID0gIjAiOwogICAgICB2YXIgY29vcmRpbmF0ZSA9IHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgoc3RhdGUsICJheGlzIiwgImhvdmVyIiwgU3RyaW5nKG5leHRJbmRleCkpOwogICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRLZXlib2FyZEludGVyYWN0aW9uKHsKICAgICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgYWN0aXZlOiB0cnVlLAogICAgICAgIGFjdGl2ZUluZGV4OiBuZXh0SW5kZXgsCiAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogY29vcmRpbmF0ZQogICAgICB9KSk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvZXh0ZXJuYWxFdmVudHNNaWRkbGV3YXJlLmpzCnZhciBleHRlcm5hbEV2ZW50QWN0aW9uID0gY3JlYXRlQWN0aW9uKCJleHRlcm5hbEV2ZW50Iik7CnZhciBleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKdmFyIHJhZklkTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKZXh0ZXJuYWxFdmVudHNNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBleHRlcm5hbEV2ZW50QWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciB7CiAgICAgIGhhbmRsZXIsCiAgICAgIHJlYWN0RXZlbnQKICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgIGlmIChoYW5kbGVyID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmVhY3RFdmVudC5wZXJzaXN0KCk7CiAgICB2YXIgZXZlbnRUeXBlID0gcmVhY3RFdmVudC50eXBlOwogICAgdmFyIGV4aXN0aW5nUmFmSWQgPSByYWZJZE1hcC5nZXQoZXZlbnRUeXBlKTsKICAgIGlmIChleGlzdGluZ1JhZklkICE9PSB2b2lkIDApIHsKICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoZXhpc3RpbmdSYWZJZCk7CiAgICB9CiAgICB2YXIgcmFmSWQyID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgICAgIHZhciBuZXh0U3RhdGUgPSB7CiAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBzZWxlY3RBY3RpdmVUb29sdGlwQ29vcmRpbmF0ZShzdGF0ZSksCiAgICAgICAgICBhY3RpdmVEYXRhS2V5OiBzZWxlY3RBY3RpdmVUb29sdGlwRGF0YUtleShzdGF0ZSksCiAgICAgICAgICBhY3RpdmVJbmRleDogc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4KHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZUxhYmVsOiBzZWxlY3RBY3RpdmVMYWJlbChzdGF0ZSksCiAgICAgICAgICBhY3RpdmVUb29sdGlwSW5kZXg6IHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleChzdGF0ZSksCiAgICAgICAgICBpc1Rvb2x0aXBBY3RpdmU6IHNlbGVjdElzVG9vbHRpcEFjdGl2ZShzdGF0ZSkKICAgICAgICB9OwogICAgICAgIGhhbmRsZXIobmV4dFN0YXRlLCByZWFjdEV2ZW50KTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICByYWZJZE1hcC5kZWxldGUoZXZlbnRUeXBlKTsKICAgICAgfQogICAgfSk7CiAgICByYWZJZE1hcC5zZXQoZXZlbnRUeXBlLCByYWZJZDIpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy90b3VjaFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0QWxsVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZV0sICh0b29sdGlwU3RhdGUpID0+IHRvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzKTsKdmFyIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbiwgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciwgKF9zdGF0ZSwgdG9vbHRpcEluZGV4LCBfZGF0YUtleSkgPT4gdG9vbHRpcEluZGV4LCAoX3N0YXRlLCBfdG9vbHRpcEluZGV4LCBkYXRhS2V5KSA9PiBkYXRhS2V5XSwgKGFsbFRvb2x0aXBDb25maWd1cmF0aW9ucywgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwgdG9vbHRpcEluZGV4LCBkYXRhS2V5KSA9PiB7CiAgdmFyIG1vc3RSZWxldmFudFRvb2x0aXBDb25maWd1cmF0aW9uID0gYWxsVG9vbHRpcENvbmZpZ3VyYXRpb25zLmZpbmQoKHRvb2x0aXBDb25maWd1cmF0aW9uKSA9PiB7CiAgICByZXR1cm4gdG9vbHRpcENvbmZpZ3VyYXRpb24uc2V0dGluZ3MuZGF0YUtleSA9PT0gZGF0YUtleTsKICB9KTsKICBpZiAobW9zdFJlbGV2YW50VG9vbHRpcENvbmZpZ3VyYXRpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHBvc2l0aW9ucwogIH0gPSBtb3N0UmVsZXZhbnRUb29sdGlwQ29uZmlndXJhdGlvbjsKICBpZiAocG9zaXRpb25zID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBtYXliZVBvc2l0aW9uID0gdG9vbHRpcFBheWxvYWRTZWFyY2hlcihwb3NpdGlvbnMsIHRvb2x0aXBJbmRleCk7CiAgcmV0dXJuIG1heWJlUG9zaXRpb247Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS90b3VjaEV2ZW50c01pZGRsZXdhcmUuanMKdmFyIHRvdWNoRXZlbnRBY3Rpb24gPSBjcmVhdGVBY3Rpb24oInRvdWNoTW92ZSIpOwp2YXIgdG91Y2hFdmVudE1pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKdG91Y2hFdmVudE1pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IHRvdWNoRXZlbnRBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHRvdWNoRXZlbnQgPSBhY3Rpb24ucGF5bG9hZDsKICAgIGlmICh0b3VjaEV2ZW50LnRvdWNoZXMgPT0gbnVsbCB8fCB0b3VjaEV2ZW50LnRvdWNoZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICB2YXIgdG9vbHRpcEV2ZW50VHlwZSA9IHNlbGVjdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUsIHN0YXRlLnRvb2x0aXAuc2V0dGluZ3Muc2hhcmVkKTsKICAgIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIpIHsKICAgICAgdmFyIGFjdGl2ZVByb3BzID0gc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyKHN0YXRlLCBnZXRDaGFydFBvaW50ZXIoewogICAgICAgIGNsaWVudFg6IHRvdWNoRXZlbnQudG91Y2hlc1swXS5jbGllbnRYLAogICAgICAgIGNsaWVudFk6IHRvdWNoRXZlbnQudG91Y2hlc1swXS5jbGllbnRZLAogICAgICAgIGN1cnJlbnRUYXJnZXQ6IHRvdWNoRXZlbnQuY3VycmVudFRhcmdldAogICAgICB9KSk7CiAgICAgIGlmICgoYWN0aXZlUHJvcHMgPT09IG51bGwgfHwgYWN0aXZlUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4KSAhPSBudWxsKSB7CiAgICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0TW91c2VPdmVyQXhpc0luZGV4KHsKICAgICAgICAgIGFjdGl2ZUluZGV4OiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCwKICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGFjdGl2ZVByb3BzLmFjdGl2ZUNvb3JkaW5hdGUKICAgICAgICB9KSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gIml0ZW0iKSB7CiAgICAgIHZhciBfdGFyZ2V0JGdldEF0dHJpYnV0ZTsKICAgICAgdmFyIHRvdWNoID0gdG91Y2hFdmVudC50b3VjaGVzWzBdOwogICAgICBpZiAoZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciB0YXJnZXQgPSBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KHRvdWNoLmNsaWVudFgsIHRvdWNoLmNsaWVudFkpOwogICAgICBpZiAoIXRhcmdldCB8fCAhdGFyZ2V0LmdldEF0dHJpYnV0ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgaXRlbUluZGV4ID0gdGFyZ2V0LmdldEF0dHJpYnV0ZShEQVRBX0lURU1fSU5ERVhfQVRUUklCVVRFX05BTUUpOwogICAgICB2YXIgZGF0YUtleSA9IChfdGFyZ2V0JGdldEF0dHJpYnV0ZSA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoREFUQV9JVEVNX0RBVEFLRVlfQVRUUklCVVRFX05BTUUpKSAhPT0gbnVsbCAmJiBfdGFyZ2V0JGdldEF0dHJpYnV0ZSAhPT0gdm9pZCAwID8gX3RhcmdldCRnZXRBdHRyaWJ1dGUgOiB2b2lkIDA7CiAgICAgIHZhciBjb29yZGluYXRlID0gc2VsZWN0VG9vbHRpcENvb3JkaW5hdGUobGlzdGVuZXJBcGkuZ2V0U3RhdGUoKSwgaXRlbUluZGV4LCBkYXRhS2V5KTsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0QWN0aXZlTW91c2VPdmVySXRlbUluZGV4KHsKICAgICAgICBhY3RpdmVEYXRhS2V5OiBkYXRhS2V5LAogICAgICAgIGFjdGl2ZUluZGV4OiBpdGVtSW5kZXgsCiAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogY29vcmRpbmF0ZQogICAgICB9KSk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc3RvcmUuanMKdmFyIHJvb3RSZWR1Y2VyID0gY29tYmluZVJlZHVjZXJzKHsKICBicnVzaDogYnJ1c2hSZWR1Y2VyLAogIGNhcnRlc2lhbkF4aXM6IGNhcnRlc2lhbkF4aXNSZWR1Y2VyLAogIGNoYXJ0RGF0YTogY2hhcnREYXRhUmVkdWNlciwKICBlcnJvckJhcnM6IGVycm9yQmFyUmVkdWNlciwKICBncmFwaGljYWxJdGVtczogZ3JhcGhpY2FsSXRlbXNSZWR1Y2VyLAogIGxheW91dDogY2hhcnRMYXlvdXRSZWR1Y2VyLAogIGxlZ2VuZDogbGVnZW5kUmVkdWNlciwKICBvcHRpb25zOiBvcHRpb25zUmVkdWNlciwKICBwb2xhckF4aXM6IHBvbGFyQXhpc1JlZHVjZXIsCiAgcG9sYXJPcHRpb25zOiBwb2xhck9wdGlvbnNSZWR1Y2VyLAogIHJlZmVyZW5jZUVsZW1lbnRzOiByZWZlcmVuY2VFbGVtZW50c1JlZHVjZXIsCiAgcm9vdFByb3BzOiByb290UHJvcHNSZWR1Y2VyLAogIHRvb2x0aXA6IHRvb2x0aXBSZWR1Y2VyLAogIHpJbmRleDogekluZGV4UmVkdWNlcgp9KTsKdmFyIGNyZWF0ZVJlY2hhcnRzU3RvcmUgPSBmdW5jdGlvbiBjcmVhdGVSZWNoYXJ0c1N0b3JlMihwcmVsb2FkZWRTdGF0ZSkgewogIHZhciBjaGFydE5hbWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6ICJDaGFydCI7CiAgcmV0dXJuIGNvbmZpZ3VyZVN0b3JlKHsKICAgIHJlZHVjZXI6IHJvb3RSZWR1Y2VyLAogICAgLy8gcmVkdXgtdG9vbGtpdCB2MSB0eXBlcyBhcmUgdW5oYXBweSB3aXRoIHRoZSBwcmVsb2FkZWRTdGF0ZSB0eXBlLiBSZW1vdmUgdGhlIGBhcyBhbnlgIHdoZW4gYnVtcGluZyB0byB2MgogICAgcHJlbG9hZGVkU3RhdGUsCiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHJlZHV4LXRvb2xraXQgdjEgdHlwZXMgYXJlIHVuaGFwcHkgd2l0aCB0aGUgbWlkZGxld2FyZSBhcnJheS4gUmVtb3ZlIHRoaXMgY29tbWVudCB3aGVuIGJ1bXBpbmcgdG8gdjIKICAgIG1pZGRsZXdhcmU6IChnZXREZWZhdWx0TWlkZGxld2FyZSkgPT4gewogICAgICB2YXIgX3Byb2Nlc3MkZW52JE5PREVfRU5WOwogICAgICByZXR1cm4gZ2V0RGVmYXVsdE1pZGRsZXdhcmUoewogICAgICAgIHNlcmlhbGl6YWJsZUNoZWNrOiBmYWxzZSwKICAgICAgICBpbW11dGFibGVDaGVjazogIVsiY29tbW9uanMiLCAiZXM2IiwgInByb2R1Y3Rpb24iXS5pbmNsdWRlcygoX3Byb2Nlc3MkZW52JE5PREVfRU5WID0gImVzNiIpICE9PSBudWxsICYmIF9wcm9jZXNzJGVudiROT0RFX0VOViAhPT0gdm9pZCAwID8gX3Byb2Nlc3MkZW52JE5PREVfRU5WIDogIiIpCiAgICAgIH0pLmNvbmNhdChbbW91c2VDbGlja01pZGRsZXdhcmUubWlkZGxld2FyZSwgbW91c2VNb3ZlTWlkZGxld2FyZS5taWRkbGV3YXJlLCBrZXlib2FyZEV2ZW50c01pZGRsZXdhcmUubWlkZGxld2FyZSwgZXh0ZXJuYWxFdmVudHNNaWRkbGV3YXJlLm1pZGRsZXdhcmUsIHRvdWNoRXZlbnRNaWRkbGV3YXJlLm1pZGRsZXdhcmVdKTsKICAgIH0sCiAgICAvKgogICAgICogSSBjYW4ndCBmaW5kIG91dCBob3cgdG8gc2F0aXNmeSB0eXBlc2NyaXB0IGhlcmUuCiAgICAgKiBXZSByZXR1cm4gYEVuaGFuY2VyQXJyYXk8W1N0b3JlRW5oYW5jZXI8e30sIHt9PiwgU3RvcmVFbmhhbmNlcl0+YCBmcm9tIHRoaXMgZnVuY3Rpb24sCiAgICAgKiBidXQgdGhlIHR5cGVzIHNheSB3ZSBzaG91bGQgcmV0dXJuIGBFbmhhbmNlckFycmF5PFN0b3JlRW5oYW5jZXI8e30sIHt9PmAuCiAgICAgKiBMb29rcyBsaWtlIGl0J3MgYmFkbHkgaW5mZXJyZWQgZ2VuZXJpY3MsIGJ1dCBpdCB3b24ndCBhbGxvdyBtZSB0byBwcm92aWRlIHRoZSBjb3JyZWN0IHR5cGUgbWFudWFsbHkgZWl0aGVyLgogICAgICogU28gbGV0J3MganVzdCBpZ25vcmUgdGhlIGVycm9yIGZvciBub3cuCiAgICAgKi8KICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgbWlzbWF0Y2hlZCBnZW5lcmljcwogICAgZW5oYW5jZXJzOiAoZ2V0RGVmYXVsdEVuaGFuY2VycykgPT4gewogICAgICB2YXIgZW5oYW5jZXJzID0gZ2V0RGVmYXVsdEVuaGFuY2VyczsKICAgICAgaWYgKHR5cGVvZiBnZXREZWZhdWx0RW5oYW5jZXJzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgZW5oYW5jZXJzID0gZ2V0RGVmYXVsdEVuaGFuY2VycygpOwogICAgICB9CiAgICAgIHJldHVybiBlbmhhbmNlcnMuY29uY2F0KGF1dG9CYXRjaEVuaGFuY2VyKHsKICAgICAgICB0eXBlOiAicmFmIgogICAgICB9KSk7CiAgICB9LAogICAgZGV2VG9vbHM6IEdsb2JhbC5kZXZUb29sc0VuYWJsZWQgJiYgewogICAgICBzZXJpYWxpemU6IHsKICAgICAgICByZXBsYWNlcjogcmVkdXhEZXZ0b29sc0pzb25TdHJpbmdpZnlSZXBsYWNlcgogICAgICB9LAogICAgICBuYW1lOiAicmVjaGFydHMtIi5jb25jYXQoY2hhcnROYW1lKQogICAgfQogIH0pOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1N0b3JlUHJvdmlkZXIuanMKZnVuY3Rpb24gUmVjaGFydHNTdG9yZVByb3ZpZGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIHByZWxvYWRlZFN0YXRlLAogICAgY2hpbGRyZW4sCiAgICByZWR1eFN0b3JlTmFtZQogIH0gPSBfcmVmMjsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgc3RvcmVSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDQudXNlUmVmKShudWxsKTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICBpZiAoc3RvcmVSZWYuY3VycmVudCA9PSBudWxsKSB7CiAgICBzdG9yZVJlZi5jdXJyZW50ID0gY3JlYXRlUmVjaGFydHNTdG9yZShwcmVsb2FkZWRTdGF0ZSwgcmVkdXhTdG9yZU5hbWUpOwogIH0KICB2YXIgbm9uTnVsbENvbnRleHQgPSBSZWNoYXJ0c1JlZHV4Q29udGV4dDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChQcm92aWRlcl9kZWZhdWx0LCB7CiAgICBjb250ZXh0OiBub25OdWxsQ29udGV4dCwKICAgIHN0b3JlOiBzdG9yZVJlZi5jdXJyZW50CiAgfSwgY2hpbGRyZW4pOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlcG9ydE1haW5DaGFydFByb3BzLmpzCnZhciBpbXBvcnRfcmVhY3Q0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gUmVwb3J0TWFpbkNoYXJ0UHJvcHNJbXBsKF9yZWYyKSB7CiAgdmFyIHsKICAgIGxheW91dCwKICAgIG1hcmdpbgogIH0gPSBfcmVmMjsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogICgwLCBpbXBvcnRfcmVhY3Q0NS51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmICghaXNQYW5vcmFtYSkgewogICAgICBkaXNwYXRjaChzZXRMYXlvdXQobGF5b3V0KSk7CiAgICAgIGRpc3BhdGNoKHNldE1hcmdpbihtYXJnaW4pKTsKICAgIH0KICB9LCBbZGlzcGF0Y2gsIGlzUGFub3JhbWEsIGxheW91dCwgbWFyZ2luXSk7CiAgcmV0dXJuIG51bGw7Cn0KdmFyIFJlcG9ydE1haW5DaGFydFByb3BzID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0NS5tZW1vKShSZXBvcnRNYWluQ2hhcnRQcm9wc0ltcGwsIHByb3BzQXJlRXF1YWwpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZXBvcnRDaGFydFByb3BzLmpzCnZhciBpbXBvcnRfcmVhY3Q0NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gUmVwb3J0Q2hhcnRQcm9wcyhwcm9wcykgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQ2LnVzZUVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2godXBkYXRlT3B0aW9ucyhwcm9wcykpOwogIH0sIFtkaXNwYXRjaCwgcHJvcHNdKTsKICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXRlZ29yaWNhbENoYXJ0LmpzCnZhciBSZWFjdDM3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NTEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9Sb290U3VyZmFjZS5qcwp2YXIgUmVhY3QzNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi96SW5kZXgvWkluZGV4UG9ydGFsLmpzCnZhciBSZWFjdDM0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIFpJbmRleFN2Z1BvcnRhbChfcmVmMikgewogIHZhciB7CiAgICB6SW5kZXgsCiAgICBpc1Bhbm9yYW1hCiAgfSA9IF9yZWYyOwogIHZhciBwcmVmaXggPSBpc1Bhbm9yYW1hID8gInJlY2hhcnRzLXppbmRleC1wYW5vcmFtYS0iIDogInJlY2hhcnRzLXppbmRleC0iOwogIHZhciBwb3J0YWxJZCA9IHVzZVVuaXF1ZUlkKCIiLmNvbmNhdChwcmVmaXgpLmNvbmNhdCh6SW5kZXgpKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKHJlZ2lzdGVyWkluZGV4UG9ydGFsSWQoewogICAgICB6SW5kZXgsCiAgICAgIGVsZW1lbnRJZDogcG9ydGFsSWQsCiAgICAgIGlzUGFub3JhbWEKICAgIH0pKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGRpc3BhdGNoKHVucmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCh7CiAgICAgICAgekluZGV4LAogICAgICAgIGlzUGFub3JhbWEKICAgICAgfSkpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIHpJbmRleCwgcG9ydGFsSWQsIGlzUGFub3JhbWFdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIHRhYkluZGV4OiAtMSwKICAgIGlkOiBwb3J0YWxJZAogIH0pOwp9CmZ1bmN0aW9uIEFsbFpJbmRleFBvcnRhbHMoX3JlZjIpIHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBpc1Bhbm9yYW1hCiAgfSA9IF9yZWYyOwogIHZhciBhbGxSZWdpc3RlcmVkWkluZGV4ZXMgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RBbGxSZWdpc3RlcmVkWkluZGV4ZXMpOwogIGlmICghYWxsUmVnaXN0ZXJlZFpJbmRleGVzIHx8IGFsbFJlZ2lzdGVyZWRaSW5kZXhlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9CiAgdmFyIGFsbE5lZ2F0aXZlWkluZGV4ZXMgPSBhbGxSZWdpc3RlcmVkWkluZGV4ZXMuZmlsdGVyKCh6SW5kZXgpID0+IHpJbmRleCA8IDApOwogIHZhciBhbGxQb3NpdGl2ZVpJbmRleGVzID0gYWxsUmVnaXN0ZXJlZFpJbmRleGVzLmZpbHRlcigoekluZGV4KSA9PiB6SW5kZXggPiAwKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChSZWFjdDM0LkZyYWdtZW50LCBudWxsLCBhbGxOZWdhdGl2ZVpJbmRleGVzLm1hcCgoekluZGV4KSA9PiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFpJbmRleFN2Z1BvcnRhbCwgewogICAga2V5OiB6SW5kZXgsCiAgICB6SW5kZXgsCiAgICBpc1Bhbm9yYW1hCiAgfSkpLCBjaGlsZHJlbiwgYWxsUG9zaXRpdmVaSW5kZXhlcy5tYXAoKHpJbmRleCkgPT4gLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChaSW5kZXhTdmdQb3J0YWwsIHsKICAgIGtleTogekluZGV4LAogICAgekluZGV4LAogICAgaXNQYW5vcmFtYQogIH0pKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1Jvb3RTdXJmYWNlLmpzCnZhciBfZXhjbHVkZWQxOSA9IFsiY2hpbGRyZW4iXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTkoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE5KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxOShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX2V4dGVuZHMyMygpIHsKICByZXR1cm4gX2V4dGVuZHMyMyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRlVMTF9XSURUSF9BTkRfSEVJR0hUID0gewogIHdpZHRoOiAiMTAwJSIsCiAgaGVpZ2h0OiAiMTAwJSIsCiAgLyoKICAgKiBkaXNwbGF5OiBibG9jayBpcyBuZWNlc3NhcnkgaGVyZSBiZWNhdXNlIHRoZSBkZWZhdWx0IGZvciBhbiBTVkcgaXMgZGlzcGxheTogaW5saW5lLAogICAqIHdoaWNoIGluIHNvbWUgYnJvd3NlcnMgKENocm9tZSkgYWRkcyBhIGxpdHRsZSBiaXQgb2YgZXh0cmEgc3BhY2UgYWJvdmUgYW5kIGJlbG93IHRoZSBTVkcKICAgKiB0byBtYWtlIHNwYWNlIGZvciB0aGUgZGVzY2VuZGVyIG9mIGxldHRlcnMgbGlrZSAiZyIgYW5kICJ5Ii4gVGhpcyB0aHJvd3Mgb2ZmIHRoZSBoZWlnaHQgY2FsY3VsYXRpb24KICAgKiBhbmQgY2F1c2VzIHRoZSBjb250YWluZXIgdG8gZ3JvdyBpbmRlZmluaXRlbHkgb24gZWFjaCByZW5kZXIgd2l0aCByZXNwb25zaXZlPXRydWUuCiAgICogRGlzcGxheTogYmxvY2sgcmVtb3ZlcyB0aGF0IGV4dHJhIHNwYWNlLgogICAqCiAgICogSW50ZXJlc3RpbmdseSwgRmlyZWZveCBkb2VzIG5vdCBoYXZlIHRoaXMgcHJvYmxlbSwgYnV0IGl0IGRvZXNuJ3QgaHVydCB0byBhZGQgdGhlIHN0eWxlIGFueXdheS4KICAgKi8KICBkaXNwbGF5OiAiYmxvY2siCn07CnZhciBNYWluQ2hhcnRTdXJmYWNlID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0OC5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB3aWR0aCA9IHVzZUNoYXJ0V2lkdGgoKTsKICB2YXIgaGVpZ2h0ID0gdXNlQ2hhcnRIZWlnaHQoKTsKICB2YXIgaGFzQWNjZXNzaWJpbGl0eUxheWVyID0gdXNlQWNjZXNzaWJpbGl0eUxheWVyKCk7CiAgaWYgKCFpc1Bvc2l0aXZlTnVtYmVyKHdpZHRoKSB8fCAhaXNQb3NpdGl2ZU51bWJlcihoZWlnaHQpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgb3RoZXJBdHRyaWJ1dGVzLAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzOwogIHZhciB0YWJJbmRleCwgcm9sZTsKICBpZiAob3RoZXJBdHRyaWJ1dGVzICE9IG51bGwpIHsKICAgIGlmICh0eXBlb2Ygb3RoZXJBdHRyaWJ1dGVzLnRhYkluZGV4ID09PSAibnVtYmVyIikgewogICAgICB0YWJJbmRleCA9IG90aGVyQXR0cmlidXRlcy50YWJJbmRleDsKICAgIH0gZWxzZSB7CiAgICAgIHRhYkluZGV4ID0gaGFzQWNjZXNzaWJpbGl0eUxheWVyID8gMCA6IHZvaWQgMDsKICAgIH0KICAgIGlmICh0eXBlb2Ygb3RoZXJBdHRyaWJ1dGVzLnJvbGUgPT09ICJzdHJpbmciKSB7CiAgICAgIHJvbGUgPSBvdGhlckF0dHJpYnV0ZXMucm9sZTsKICAgIH0gZWxzZSB7CiAgICAgIHJvbGUgPSBoYXNBY2Nlc3NpYmlsaXR5TGF5ZXIgPyAiYXBwbGljYXRpb24iIDogdm9pZCAwOwogICAgfQogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzUuY3JlYXRlRWxlbWVudChTdXJmYWNlLCBfZXh0ZW5kczIzKHt9LCBvdGhlckF0dHJpYnV0ZXMsIHsKICAgIHRpdGxlLAogICAgZGVzYywKICAgIHJvbGUsCiAgICB0YWJJbmRleCwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgc3R5bGU6IEZVTExfV0lEVEhfQU5EX0hFSUdIVCwKICAgIHJlZgogIH0pLCBjaGlsZHJlbik7Cn0pOwp2YXIgQnJ1c2hQYW5vcmFtYVN1cmZhY2UgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4KICB9ID0gX3JlZjI7CiAgdmFyIGJydXNoRGltZW5zaW9ucyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEJydXNoRGltZW5zaW9ucyk7CiAgaWYgKCFicnVzaERpbWVuc2lvbnMpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB5OiB5MiwKICAgIHg6IHgyCiAgfSA9IGJydXNoRGltZW5zaW9uczsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzUuY3JlYXRlRWxlbWVudChTdXJmYWNlLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHg6IHgyLAogICAgeTogeTIKICB9LCBjaGlsZHJlbik7Cn07CnZhciBSb290U3VyZmFjZSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDguZm9yd2FyZFJlZikoKF9yZWYyLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4KICB9ID0gX3JlZjIsIHJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxOShfcmVmMiwgX2V4Y2x1ZGVkMTkpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzUuY3JlYXRlRWxlbWVudChCcnVzaFBhbm9yYW1hU3VyZmFjZSwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzUuY3JlYXRlRWxlbWVudChBbGxaSW5kZXhQb3J0YWxzLCB7CiAgICAgIGlzUGFub3JhbWE6IHRydWUKICAgIH0sIGNoaWxkcmVuKSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNS5jcmVhdGVFbGVtZW50KE1haW5DaGFydFN1cmZhY2UsIF9leHRlbmRzMjMoewogICAgcmVmCiAgfSwgcmVzdCksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM1LmNyZWF0ZUVsZW1lbnQoQWxsWkluZGV4UG9ydGFscywgewogICAgaXNQYW5vcmFtYTogZmFsc2UKICB9LCBjaGlsZHJlbikpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvUmVjaGFydHNXcmFwcGVyLmpzCnZhciBSZWFjdDM2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NTAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlUmVwb3J0U2NhbGUuanMKdmFyIGltcG9ydF9yZWFjdDQ5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiB1c2VSZXBvcnRTY2FsZSgpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBbcmVmLCBzZXRSZWZdID0gKDAsIGltcG9ydF9yZWFjdDQ5LnVzZVN0YXRlKShudWxsKTsKICB2YXIgc2NhbGUgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RDb250YWluZXJTY2FsZSk7CiAgKDAsIGltcG9ydF9yZWFjdDQ5LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKHJlZiA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciByZWN0ID0gcmVmLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgdmFyIG5ld1NjYWxlID0gcmVjdC53aWR0aCAvIHJlZi5vZmZzZXRXaWR0aDsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKG5ld1NjYWxlKSAmJiBuZXdTY2FsZSAhPT0gc2NhbGUpIHsKICAgICAgZGlzcGF0Y2goc2V0U2NhbGUobmV3U2NhbGUpKTsKICAgIH0KICB9LCBbcmVmLCBkaXNwYXRjaCwgc2NhbGVdKTsKICByZXR1cm4gc2V0UmVmOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L1JlY2hhcnRzV3JhcHBlci5qcwpmdW5jdGlvbiBvd25LZXlzMzYoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzNihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czM2KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzOChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzNihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzOChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzOCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHMyNCgpIHsKICByZXR1cm4gX2V4dGVuZHMyNCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRXZlbnRTeW5jaHJvbml6ZXIgPSAoKSA9PiB7CiAgdXNlU3luY2hyb25pc2VkRXZlbnRzRnJvbU90aGVyQ2hhcnRzKCk7CiAgcmV0dXJuIG51bGw7Cn07CmZ1bmN0aW9uIGdldE51bWJlck9yWmVybyh2YWx1ZSkgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICB2YXIgcGFyc2VkID0gcGFyc2VGbG9hdCh2YWx1ZSk7CiAgICBpZiAoIU51bWJlci5pc05hTihwYXJzZWQpKSB7CiAgICAgIHJldHVybiBwYXJzZWQ7CiAgICB9CiAgfQogIHJldHVybiAwOwp9CnZhciBSZXNwb25zaXZlRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q1MC5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciBfcHJvcHMkc3R5bGUsIF9wcm9wcyRzdHlsZTI7CiAgdmFyIG9ic2VydmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDUwLnVzZVJlZikobnVsbCk7CiAgdmFyIFtzaXplcywgc2V0U2l6ZXNdID0gKDAsIGltcG9ydF9yZWFjdDUwLnVzZVN0YXRlKSh7CiAgICBjb250YWluZXJXaWR0aDogZ2V0TnVtYmVyT3JaZXJvKChfcHJvcHMkc3R5bGUgPSBwcm9wcy5zdHlsZSkgPT09IG51bGwgfHwgX3Byb3BzJHN0eWxlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfcHJvcHMkc3R5bGUud2lkdGgpLAogICAgY29udGFpbmVySGVpZ2h0OiBnZXROdW1iZXJPclplcm8oKF9wcm9wcyRzdHlsZTIgPSBwcm9wcy5zdHlsZSkgPT09IG51bGwgfHwgX3Byb3BzJHN0eWxlMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Byb3BzJHN0eWxlMi5oZWlnaHQpCiAgfSk7CiAgdmFyIHNldENvbnRhaW5lclNpemUgPSAoMCwgaW1wb3J0X3JlYWN0NTAudXNlQ2FsbGJhY2spKChuZXdXaWR0aCwgbmV3SGVpZ2h0KSA9PiB7CiAgICBzZXRTaXplcygocHJldlN0YXRlKSA9PiB7CiAgICAgIHZhciByb3VuZGVkV2lkdGggPSBNYXRoLnJvdW5kKG5ld1dpZHRoKTsKICAgICAgdmFyIHJvdW5kZWRIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCk7CiAgICAgIGlmIChwcmV2U3RhdGUuY29udGFpbmVyV2lkdGggPT09IHJvdW5kZWRXaWR0aCAmJiBwcmV2U3RhdGUuY29udGFpbmVySGVpZ2h0ID09PSByb3VuZGVkSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGNvbnRhaW5lcldpZHRoOiByb3VuZGVkV2lkdGgsCiAgICAgICAgY29udGFpbmVySGVpZ2h0OiByb3VuZGVkSGVpZ2h0CiAgICAgIH07CiAgICB9KTsKICB9LCBbXSk7CiAgdmFyIGlubmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDUwLnVzZUNhbGxiYWNrKSgobm9kZSkgPT4gewogICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVmKG5vZGUpOwogICAgfQogICAgaWYgKG5vZGUgIT0gbnVsbCAmJiB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHZhciB7CiAgICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoLAogICAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0CiAgICAgIH0gPSBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQpOwogICAgICB2YXIgY2FsbGJhY2sgPSAoZW50cmllcykgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGhlaWdodAogICAgICAgIH0gPSBlbnRyaWVzWzBdLmNvbnRlbnRSZWN0OwogICAgICAgIHNldENvbnRhaW5lclNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgIH07CiAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcihjYWxsYmFjayk7CiAgICAgIG9ic2VydmVyLm9ic2VydmUobm9kZSk7CiAgICAgIG9ic2VydmVyUmVmLmN1cnJlbnQgPSBvYnNlcnZlcjsKICAgIH0KICB9LCBbcmVmLCBzZXRDb250YWluZXJTaXplXSk7CiAgKDAsIGltcG9ydF9yZWFjdDUwLnVzZUVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgdmFyIG9ic2VydmVyID0gb2JzZXJ2ZXJSZWYuY3VycmVudDsKICAgICAgaWYgKG9ic2VydmVyICE9IG51bGwpIHsKICAgICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICAgIH0KICAgIH07CiAgfSwgW3NldENvbnRhaW5lclNpemVdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzYuY3JlYXRlRWxlbWVudChSZWFjdDM2LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNi5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgd2lkdGg6IHNpemVzLmNvbnRhaW5lcldpZHRoLAogICAgaGVpZ2h0OiBzaXplcy5jb250YWluZXJIZWlnaHQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzYuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHMyNCh7CiAgICByZWY6IGlubmVyUmVmCiAgfSwgcHJvcHMpKSk7Cn0pOwp2YXIgUmVhZFNpemVPbmNlRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q1MC5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICB2YXIgW3NpemVzLCBzZXRTaXplc10gPSAoMCwgaW1wb3J0X3JlYWN0NTAudXNlU3RhdGUpKHsKICAgIGNvbnRhaW5lcldpZHRoOiBnZXROdW1iZXJPclplcm8od2lkdGgpLAogICAgY29udGFpbmVySGVpZ2h0OiBnZXROdW1iZXJPclplcm8oaGVpZ2h0KQogIH0pOwogIHZhciBzZXRDb250YWluZXJTaXplID0gKDAsIGltcG9ydF9yZWFjdDUwLnVzZUNhbGxiYWNrKSgobmV3V2lkdGgsIG5ld0hlaWdodCkgPT4gewogICAgc2V0U2l6ZXMoKHByZXZTdGF0ZSkgPT4gewogICAgICB2YXIgcm91bmRlZFdpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCk7CiAgICAgIHZhciByb3VuZGVkSGVpZ2h0ID0gTWF0aC5yb3VuZChuZXdIZWlnaHQpOwogICAgICBpZiAocHJldlN0YXRlLmNvbnRhaW5lcldpZHRoID09PSByb3VuZGVkV2lkdGggJiYgcHJldlN0YXRlLmNvbnRhaW5lckhlaWdodCA9PT0gcm91bmRlZEhlaWdodCkgewogICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjb250YWluZXJXaWR0aDogcm91bmRlZFdpZHRoLAogICAgICAgIGNvbnRhaW5lckhlaWdodDogcm91bmRlZEhlaWdodAogICAgICB9OwogICAgfSk7CiAgfSwgW10pOwogIHZhciBpbm5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1MC51c2VDYWxsYmFjaykoKG5vZGUpID0+IHsKICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlZihub2RlKTsKICAgIH0KICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgdmFyIHsKICAgICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgsCiAgICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQKICAgICAgfSA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCk7CiAgICB9CiAgfSwgW3JlZiwgc2V0Q29udGFpbmVyU2l6ZV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNi5jcmVhdGVFbGVtZW50KFJlYWN0MzYuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM2LmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICB3aWR0aDogc2l6ZXMuY29udGFpbmVyV2lkdGgsCiAgICBoZWlnaHQ6IHNpemVzLmNvbnRhaW5lckhlaWdodAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNi5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczI0KHsKICAgIHJlZjogaW5uZXJSZWYKICB9LCBwcm9wcykpKTsKfSk7CnZhciBTdGF0aWNEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUwLmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNi5jcmVhdGVFbGVtZW50KFJlYWN0MzYuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM2LmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNi5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczI0KHsKICAgIHJlZgogIH0sIHByb3BzKSkpOwp9KTsKdmFyIE5vblJlc3BvbnNpdmVEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUwLmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIGlmIChpc1BlcmNlbnQod2lkdGgpIHx8IGlzUGVyY2VudChoZWlnaHQpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzYuY3JlYXRlRWxlbWVudChSZWFkU2l6ZU9uY2VEaXYsIF9leHRlbmRzMjQoe30sIHByb3BzLCB7CiAgICAgIHJlZgogICAgfSkpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzYuY3JlYXRlRWxlbWVudChTdGF0aWNEaXYsIF9leHRlbmRzMjQoe30sIHByb3BzLCB7CiAgICByZWYKICB9KSk7Cn0pOwpmdW5jdGlvbiBnZXRXcmFwcGVyRGl2Q29tcG9uZW50KHJlc3BvbnNpdmUpIHsKICByZXR1cm4gcmVzcG9uc2l2ZSA9PT0gdHJ1ZSA/IFJlc3BvbnNpdmVEaXYgOiBOb25SZXNwb25zaXZlRGl2Owp9CnZhciBSZWNoYXJ0c1dyYXBwZXIgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUwLmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgY2xhc3NOYW1lLAogICAgaGVpZ2h0OiBoZWlnaHRGcm9tUHJvcHMsCiAgICBvbkNsaWNrLAogICAgb25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2ssCiAgICBvbk1vdXNlRG93biwKICAgIG9uTW91c2VFbnRlciwKICAgIG9uTW91c2VMZWF2ZSwKICAgIG9uTW91c2VNb3ZlLAogICAgb25Nb3VzZVVwLAogICAgb25Ub3VjaEVuZCwKICAgIG9uVG91Y2hNb3ZlLAogICAgb25Ub3VjaFN0YXJ0LAogICAgc3R5bGUsCiAgICB3aWR0aDogd2lkdGhGcm9tUHJvcHMsCiAgICByZXNwb25zaXZlLAogICAgZGlzcGF0Y2hUb3VjaEV2ZW50cyA9IHRydWUKICB9ID0gcHJvcHM7CiAgdmFyIGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1MC51c2VSZWYpKG51bGwpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIFt0b29sdGlwUG9ydGFsLCBzZXRUb29sdGlwUG9ydGFsXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MC51c2VTdGF0ZSkobnVsbCk7CiAgdmFyIFtsZWdlbmRQb3J0YWwsIHNldExlZ2VuZFBvcnRhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTAudXNlU3RhdGUpKG51bGwpOwogIHZhciBzZXRTY2FsZVJlZiA9IHVzZVJlcG9ydFNjYWxlKCk7CiAgdmFyIHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIHZhciB3aWR0aCA9IChyZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSBudWxsIHx8IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGgpID4gMCA/IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGggOiB3aWR0aEZyb21Qcm9wczsKICB2YXIgaGVpZ2h0ID0gKHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IG51bGwgfHwgcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQpID4gMCA/IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMuaGVpZ2h0IDogaGVpZ2h0RnJvbVByb3BzOwogIHZhciBpbm5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1MC51c2VDYWxsYmFjaykoKG5vZGUpID0+IHsKICAgIHNldFNjYWxlUmVmKG5vZGUpOwogICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVmKG5vZGUpOwogICAgfQogICAgc2V0VG9vbHRpcFBvcnRhbChub2RlKTsKICAgIHNldExlZ2VuZFBvcnRhbChub2RlKTsKICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgY29udGFpbmVyUmVmLmN1cnJlbnQgPSBub2RlOwogICAgfQogIH0sIFtzZXRTY2FsZVJlZiwgcmVmLCBzZXRUb29sdGlwUG9ydGFsLCBzZXRMZWdlbmRQb3J0YWxdKTsKICB2YXIgbXlPbkNsaWNrID0gKDAsIGltcG9ydF9yZWFjdDUwLnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VDbGlja0FjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25DbGljaywKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25DbGlja10pOwogIHZhciBteU9uTW91c2VFbnRlciA9ICgwLCBpbXBvcnRfcmVhY3Q1MC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlTW92ZUFjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZUVudGVyLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlRW50ZXJdKTsKICB2YXIgbXlPbk1vdXNlTGVhdmUgPSAoMCwgaW1wb3J0X3JlYWN0NTAudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZUxlYXZlQ2hhcnQoKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZUxlYXZlLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlTGVhdmVdKTsKICB2YXIgbXlPbk1vdXNlTW92ZSA9ICgwLCBpbXBvcnRfcmVhY3Q1MC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlTW92ZUFjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZU1vdmUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VNb3ZlXSk7CiAgdmFyIG9uRm9jdXMgPSAoMCwgaW1wb3J0X3JlYWN0NTAudXNlQ2FsbGJhY2spKCgpID0+IHsKICAgIGRpc3BhdGNoKGZvY3VzQWN0aW9uKCkpOwogIH0sIFtkaXNwYXRjaF0pOwogIHZhciBvbktleURvd24gPSAoMCwgaW1wb3J0X3JlYWN0NTAudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChrZXlEb3duQWN0aW9uKGUua2V5KSk7CiAgfSwgW2Rpc3BhdGNoXSk7CiAgdmFyIG15T25Db250ZXh0TWVudSA9ICgwLCBpbXBvcnRfcmVhY3Q1MC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbkNvbnRleHRNZW51LAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbkNvbnRleHRNZW51XSk7CiAgdmFyIG15T25Eb3VibGVDbGljayA9ICgwLCBpbXBvcnRfcmVhY3Q1MC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbkRvdWJsZUNsaWNrLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbkRvdWJsZUNsaWNrXSk7CiAgdmFyIG15T25Nb3VzZURvd24gPSAoMCwgaW1wb3J0X3JlYWN0NTAudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZURvd24sCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VEb3duXSk7CiAgdmFyIG15T25Nb3VzZVVwID0gKDAsIGltcG9ydF9yZWFjdDUwLnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VVcCwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZVVwXSk7CiAgdmFyIG15T25Ub3VjaFN0YXJ0ID0gKDAsIGltcG9ydF9yZWFjdDUwLnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uVG91Y2hTdGFydCwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Ub3VjaFN0YXJ0XSk7CiAgdmFyIG15T25Ub3VjaE1vdmUgPSAoMCwgaW1wb3J0X3JlYWN0NTAudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBpZiAoZGlzcGF0Y2hUb3VjaEV2ZW50cykgewogICAgICBkaXNwYXRjaCh0b3VjaEV2ZW50QWN0aW9uKGUpKTsKICAgIH0KICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvblRvdWNoTW92ZSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgZGlzcGF0Y2hUb3VjaEV2ZW50cywgb25Ub3VjaE1vdmVdKTsKICB2YXIgbXlPblRvdWNoRW5kID0gKDAsIGltcG9ydF9yZWFjdDUwLnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uVG91Y2hFbmQsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uVG91Y2hFbmRdKTsKICB2YXIgV3JhcHBlckRpdiA9IGdldFdyYXBwZXJEaXZDb21wb25lbnQocmVzcG9uc2l2ZSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM2LmNyZWF0ZUVsZW1lbnQoVG9vbHRpcFBvcnRhbENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiB0b29sdGlwUG9ydGFsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzYuY3JlYXRlRWxlbWVudChMZWdlbmRQb3J0YWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogbGVnZW5kUG9ydGFsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzYuY3JlYXRlRWxlbWVudChXcmFwcGVyRGl2LCB7CiAgICB3aWR0aDogd2lkdGggIT09IG51bGwgJiYgd2lkdGggIT09IHZvaWQgMCA/IHdpZHRoIDogc3R5bGUgPT09IG51bGwgfHwgc3R5bGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHN0eWxlLndpZHRoLAogICAgaGVpZ2h0OiBoZWlnaHQgIT09IG51bGwgJiYgaGVpZ2h0ICE9PSB2b2lkIDAgPyBoZWlnaHQgOiBzdHlsZSA9PT0gbnVsbCB8fCBzdHlsZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3R5bGUuaGVpZ2h0LAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy13cmFwcGVyIiwgY2xhc3NOYW1lKSwKICAgIHN0eWxlOiBfb2JqZWN0U3ByZWFkMzYoewogICAgICBwb3NpdGlvbjogInJlbGF0aXZlIiwKICAgICAgY3Vyc29yOiAiZGVmYXVsdCIsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0sIHN0eWxlKSwKICAgIG9uQ2xpY2s6IG15T25DbGljaywKICAgIG9uQ29udGV4dE1lbnU6IG15T25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2s6IG15T25Eb3VibGVDbGljaywKICAgIG9uRm9jdXMsCiAgICBvbktleURvd24sCiAgICBvbk1vdXNlRG93bjogbXlPbk1vdXNlRG93biwKICAgIG9uTW91c2VFbnRlcjogbXlPbk1vdXNlRW50ZXIsCiAgICBvbk1vdXNlTGVhdmU6IG15T25Nb3VzZUxlYXZlLAogICAgb25Nb3VzZU1vdmU6IG15T25Nb3VzZU1vdmUsCiAgICBvbk1vdXNlVXA6IG15T25Nb3VzZVVwLAogICAgb25Ub3VjaEVuZDogbXlPblRvdWNoRW5kLAogICAgb25Ub3VjaE1vdmU6IG15T25Ub3VjaE1vdmUsCiAgICBvblRvdWNoU3RhcnQ6IG15T25Ub3VjaFN0YXJ0LAogICAgcmVmOiBpbm5lclJlZgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM2LmNyZWF0ZUVsZW1lbnQoRXZlbnRTeW5jaHJvbml6ZXIsIG51bGwpLCBjaGlsZHJlbikpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhdGVnb3JpY2FsQ2hhcnQuanMKdmFyIF9leGNsdWRlZDIwID0gWyJ3aWR0aCIsICJoZWlnaHQiLCAicmVzcG9uc2l2ZSIsICJjaGlsZHJlbiIsICJjbGFzc05hbWUiLCAic3R5bGUiLCAiY29tcGFjdCIsICJ0aXRsZSIsICJkZXNjIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczIwKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyMChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMjAocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBDYXRlZ29yaWNhbENoYXJ0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q1MS5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJlc3BvbnNpdmUsCiAgICBjaGlsZHJlbiwKICAgIGNsYXNzTmFtZSwKICAgIHN0eWxlLAogICAgY29tcGFjdCwKICAgIHRpdGxlLAogICAgZGVzYwogIH0gPSBwcm9wcywgb3RoZXJzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMjAocHJvcHMsIF9leGNsdWRlZDIwKTsKICB2YXIgYXR0cnMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMob3RoZXJzKTsKICBpZiAoY29tcGFjdCkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM3LmNyZWF0ZUVsZW1lbnQoUmVhY3QzNy5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzcuY3JlYXRlRWxlbWVudChSZXBvcnRDaGFydFNpemUsIHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM3LmNyZWF0ZUVsZW1lbnQoUm9vdFN1cmZhY2UsIHsKICAgICAgb3RoZXJBdHRyaWJ1dGVzOiBhdHRycywKICAgICAgdGl0bGUsCiAgICAgIGRlc2MKICAgIH0sIGNoaWxkcmVuKSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNy5jcmVhdGVFbGVtZW50KFJlY2hhcnRzV3JhcHBlciwgewogICAgY2xhc3NOYW1lLAogICAgc3R5bGUsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJlc3BvbnNpdmU6IHJlc3BvbnNpdmUgIT09IG51bGwgJiYgcmVzcG9uc2l2ZSAhPT0gdm9pZCAwID8gcmVzcG9uc2l2ZSA6IGZhbHNlLAogICAgb25DbGljazogcHJvcHMub25DbGljaywKICAgIG9uTW91c2VMZWF2ZTogcHJvcHMub25Nb3VzZUxlYXZlLAogICAgb25Nb3VzZUVudGVyOiBwcm9wcy5vbk1vdXNlRW50ZXIsCiAgICBvbk1vdXNlTW92ZTogcHJvcHMub25Nb3VzZU1vdmUsCiAgICBvbk1vdXNlRG93bjogcHJvcHMub25Nb3VzZURvd24sCiAgICBvbk1vdXNlVXA6IHByb3BzLm9uTW91c2VVcCwKICAgIG9uQ29udGV4dE1lbnU6IHByb3BzLm9uQ29udGV4dE1lbnUsCiAgICBvbkRvdWJsZUNsaWNrOiBwcm9wcy5vbkRvdWJsZUNsaWNrLAogICAgb25Ub3VjaFN0YXJ0OiBwcm9wcy5vblRvdWNoU3RhcnQsCiAgICBvblRvdWNoTW92ZTogcHJvcHMub25Ub3VjaE1vdmUsCiAgICBvblRvdWNoRW5kOiBwcm9wcy5vblRvdWNoRW5kCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzcuY3JlYXRlRWxlbWVudChSb290U3VyZmFjZSwgewogICAgb3RoZXJBdHRyaWJ1dGVzOiBhdHRycywKICAgIHRpdGxlLAogICAgZGVzYywKICAgIHJlZgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM3LmNyZWF0ZUVsZW1lbnQoQ2xpcFBhdGhQcm92aWRlciwgbnVsbCwgY2hpbGRyZW4pKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXJ0ZXNpYW5DaGFydC5qcwpmdW5jdGlvbiBfZXh0ZW5kczI1KCkgewogIHJldHVybiBfZXh0ZW5kczI1ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyNS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBkZWZhdWx0TWFyZ2luID0gewogIHRvcDogNSwKICByaWdodDogNSwKICBib3R0b206IDUsCiAgbGVmdDogNQp9Owp2YXIgZGVmYXVsdENhcnRlc2lhbkNoYXJ0UHJvcHMgPSB7CiAgYWNjZXNzaWJpbGl0eUxheWVyOiB0cnVlLAogIGJhckNhdGVnb3J5R2FwOiAiMTAlIiwKICBiYXJHYXA6IDQsCiAgbGF5b3V0OiAiaG9yaXpvbnRhbCIsCiAgbWFyZ2luOiBkZWZhdWx0TWFyZ2luLAogIHJlc3BvbnNpdmU6IGZhbHNlLAogIHJldmVyc2VTdGFja09yZGVyOiBmYWxzZSwKICBzdGFja09mZnNldDogIm5vbmUiLAogIHN5bmNNZXRob2Q6ICJpbmRleCIKfTsKdmFyIENhcnRlc2lhbkNoYXJ0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q1Mi5mb3J3YXJkUmVmKShmdW5jdGlvbiBDYXJ0ZXNpYW5DaGFydDIocHJvcHMsIHJlZikgewogIHZhciBfY2F0ZWdvcmljYWxDaGFydFByb3A7CiAgdmFyIHJvb3RDaGFydFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcy5jYXRlZ29yaWNhbENoYXJ0UHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5DaGFydFByb3BzKTsKICB2YXIgewogICAgY2hhcnROYW1lLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwKICAgIGNhdGVnb3JpY2FsQ2hhcnRQcm9wcwogIH0gPSBwcm9wczsKICB2YXIgb3B0aW9ucyA9IHsKICAgIGNoYXJ0TmFtZSwKICAgIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLAogICAgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcywKICAgIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsCiAgICBldmVudEVtaXR0ZXI6IHZvaWQgMAogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM4LmNyZWF0ZUVsZW1lbnQoUmVjaGFydHNTdG9yZVByb3ZpZGVyLCB7CiAgICBwcmVsb2FkZWRTdGF0ZTogewogICAgICBvcHRpb25zCiAgICB9LAogICAgcmVkdXhTdG9yZU5hbWU6IChfY2F0ZWdvcmljYWxDaGFydFByb3AgPSBjYXRlZ29yaWNhbENoYXJ0UHJvcHMuaWQpICE9PSBudWxsICYmIF9jYXRlZ29yaWNhbENoYXJ0UHJvcCAhPT0gdm9pZCAwID8gX2NhdGVnb3JpY2FsQ2hhcnRQcm9wIDogY2hhcnROYW1lCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzguY3JlYXRlRWxlbWVudChDaGFydERhdGFDb250ZXh0UHJvdmlkZXIsIHsKICAgIGNoYXJ0RGF0YTogY2F0ZWdvcmljYWxDaGFydFByb3BzLmRhdGEKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzguY3JlYXRlRWxlbWVudChSZXBvcnRNYWluQ2hhcnRQcm9wcywgewogICAgbGF5b3V0OiByb290Q2hhcnRQcm9wcy5sYXlvdXQsCiAgICBtYXJnaW46IHJvb3RDaGFydFByb3BzLm1hcmdpbgogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzOC5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0UHJvcHMsIHsKICAgIGJhc2VWYWx1ZTogcm9vdENoYXJ0UHJvcHMuYmFzZVZhbHVlLAogICAgYWNjZXNzaWJpbGl0eUxheWVyOiByb290Q2hhcnRQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIsCiAgICBiYXJDYXRlZ29yeUdhcDogcm9vdENoYXJ0UHJvcHMuYmFyQ2F0ZWdvcnlHYXAsCiAgICBtYXhCYXJTaXplOiByb290Q2hhcnRQcm9wcy5tYXhCYXJTaXplLAogICAgc3RhY2tPZmZzZXQ6IHJvb3RDaGFydFByb3BzLnN0YWNrT2Zmc2V0LAogICAgYmFyR2FwOiByb290Q2hhcnRQcm9wcy5iYXJHYXAsCiAgICBiYXJTaXplOiByb290Q2hhcnRQcm9wcy5iYXJTaXplLAogICAgc3luY0lkOiByb290Q2hhcnRQcm9wcy5zeW5jSWQsCiAgICBzeW5jTWV0aG9kOiByb290Q2hhcnRQcm9wcy5zeW5jTWV0aG9kLAogICAgY2xhc3NOYW1lOiByb290Q2hhcnRQcm9wcy5jbGFzc05hbWUsCiAgICByZXZlcnNlU3RhY2tPcmRlcjogcm9vdENoYXJ0UHJvcHMucmV2ZXJzZVN0YWNrT3JkZXIKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzguY3JlYXRlRWxlbWVudChDYXRlZ29yaWNhbENoYXJ0LCBfZXh0ZW5kczI1KHt9LCByb290Q2hhcnRQcm9wcywgewogICAgcmVmCiAgfSkpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L1BpZUNoYXJ0LmpzCnZhciBSZWFjdDQwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NTUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L1BvbGFyQ2hhcnQuanMKdmFyIGltcG9ydF9yZWFjdDU0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgUmVhY3QzOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVwb3J0UG9sYXJPcHRpb25zLmpzCnZhciBpbXBvcnRfcmVhY3Q1MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gUmVwb3J0UG9sYXJPcHRpb25zKHByb3BzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0NTMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaCh1cGRhdGVQb2xhck9wdGlvbnMocHJvcHMpKTsKICB9LCBbZGlzcGF0Y2gsIHByb3BzXSk7CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvUG9sYXJDaGFydC5qcwp2YXIgX2V4Y2x1ZGVkMjEgPSBbImxheW91dCJdOwpmdW5jdGlvbiBfZXh0ZW5kczI2KCkgewogIHJldHVybiBfZXh0ZW5kczI2ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyNi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczIxKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyMShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMjEocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBkZWZhdWx0TWFyZ2luMiA9IHsKICB0b3A6IDUsCiAgcmlnaHQ6IDUsCiAgYm90dG9tOiA1LAogIGxlZnQ6IDUKfTsKdmFyIGRlZmF1bHRQb2xhckNoYXJ0UHJvcHMgPSB7CiAgYWNjZXNzaWJpbGl0eUxheWVyOiB0cnVlLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBtYXJnaW46IGRlZmF1bHRNYXJnaW4yLAogIHJldmVyc2VTdGFja09yZGVyOiBmYWxzZSwKICBzeW5jTWV0aG9kOiAiaW5kZXgiLAogIGxheW91dDogInJhZGlhbCIsCiAgcmVzcG9uc2l2ZTogZmFsc2UsCiAgY3g6ICI1MCUiLAogIGN5OiAiNTAlIiwKICBpbm5lclJhZGl1czogMCwKICBvdXRlclJhZGl1czogIjgwJSIKfTsKdmFyIFBvbGFyQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDU0LmZvcndhcmRSZWYpKGZ1bmN0aW9uIFBvbGFyQ2hhcnQyKHByb3BzLCByZWYpIHsKICB2YXIgX3BvbGFyQ2hhcnRQcm9wcyRpZDsKICB2YXIgcG9sYXJDaGFydFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcy5jYXRlZ29yaWNhbENoYXJ0UHJvcHMsIGRlZmF1bHRQb2xhckNoYXJ0UHJvcHMpOwogIHZhciB7CiAgICBsYXlvdXQKICB9ID0gcG9sYXJDaGFydFByb3BzLCBvdGhlckNhdGVnb3JpY2FsUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMyMShwb2xhckNoYXJ0UHJvcHMsIF9leGNsdWRlZDIxKTsKICB2YXIgewogICAgY2hhcnROYW1lLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlcgogIH0gPSBwcm9wczsKICB2YXIgb3B0aW9ucyA9IHsKICAgIGNoYXJ0TmFtZSwKICAgIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLAogICAgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcywKICAgIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsCiAgICBldmVudEVtaXR0ZXI6IHZvaWQgMAogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM5LmNyZWF0ZUVsZW1lbnQoUmVjaGFydHNTdG9yZVByb3ZpZGVyLCB7CiAgICBwcmVsb2FkZWRTdGF0ZTogewogICAgICBvcHRpb25zCiAgICB9LAogICAgcmVkdXhTdG9yZU5hbWU6IChfcG9sYXJDaGFydFByb3BzJGlkID0gcG9sYXJDaGFydFByb3BzLmlkKSAhPT0gbnVsbCAmJiBfcG9sYXJDaGFydFByb3BzJGlkICE9PSB2b2lkIDAgPyBfcG9sYXJDaGFydFByb3BzJGlkIDogY2hhcnROYW1lCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzkuY3JlYXRlRWxlbWVudChDaGFydERhdGFDb250ZXh0UHJvdmlkZXIsIHsKICAgIGNoYXJ0RGF0YTogcG9sYXJDaGFydFByb3BzLmRhdGEKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzkuY3JlYXRlRWxlbWVudChSZXBvcnRNYWluQ2hhcnRQcm9wcywgewogICAgbGF5b3V0LAogICAgbWFyZ2luOiBwb2xhckNoYXJ0UHJvcHMubWFyZ2luCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM5LmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRQcm9wcywgewogICAgYmFzZVZhbHVlOiB2b2lkIDAsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHBvbGFyQ2hhcnRQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIsCiAgICBiYXJDYXRlZ29yeUdhcDogcG9sYXJDaGFydFByb3BzLmJhckNhdGVnb3J5R2FwLAogICAgbWF4QmFyU2l6ZTogcG9sYXJDaGFydFByb3BzLm1heEJhclNpemUsCiAgICBzdGFja09mZnNldDogcG9sYXJDaGFydFByb3BzLnN0YWNrT2Zmc2V0LAogICAgYmFyR2FwOiBwb2xhckNoYXJ0UHJvcHMuYmFyR2FwLAogICAgYmFyU2l6ZTogcG9sYXJDaGFydFByb3BzLmJhclNpemUsCiAgICBzeW5jSWQ6IHBvbGFyQ2hhcnRQcm9wcy5zeW5jSWQsCiAgICBzeW5jTWV0aG9kOiBwb2xhckNoYXJ0UHJvcHMuc3luY01ldGhvZCwKICAgIGNsYXNzTmFtZTogcG9sYXJDaGFydFByb3BzLmNsYXNzTmFtZSwKICAgIHJldmVyc2VTdGFja09yZGVyOiBwb2xhckNoYXJ0UHJvcHMucmV2ZXJzZVN0YWNrT3JkZXIKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzkuY3JlYXRlRWxlbWVudChSZXBvcnRQb2xhck9wdGlvbnMsIHsKICAgIGN4OiBwb2xhckNoYXJ0UHJvcHMuY3gsCiAgICBjeTogcG9sYXJDaGFydFByb3BzLmN5LAogICAgc3RhcnRBbmdsZTogcG9sYXJDaGFydFByb3BzLnN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZTogcG9sYXJDaGFydFByb3BzLmVuZEFuZ2xlLAogICAgaW5uZXJSYWRpdXM6IHBvbGFyQ2hhcnRQcm9wcy5pbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzOiBwb2xhckNoYXJ0UHJvcHMub3V0ZXJSYWRpdXMKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzkuY3JlYXRlRWxlbWVudChDYXRlZ29yaWNhbENoYXJ0LCBfZXh0ZW5kczI2KHt9LCBvdGhlckNhdGVnb3JpY2FsUHJvcHMsIHsKICAgIHJlZgogIH0pKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9QaWVDaGFydC5qcwpmdW5jdGlvbiBvd25LZXlzMzcoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzNyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czM3KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzOShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzNyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzOShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzOSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzOSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzOSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGFsbG93ZWRUb29sdGlwVHlwZXMgPSBbIml0ZW0iXTsKdmFyIGRlZmF1bHRQaWVDaGFydFByb3BzID0gX29iamVjdFNwcmVhZDM3KF9vYmplY3RTcHJlYWQzNyh7fSwgZGVmYXVsdFBvbGFyQ2hhcnRQcm9wcyksIHt9LCB7CiAgbGF5b3V0OiAiY2VudHJpYyIsCiAgc3RhcnRBbmdsZTogMCwKICBlbmRBbmdsZTogMzYwCn0pOwp2YXIgUGllQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDU1LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHByb3BzV2l0aERlZmF1bHRzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcywgZGVmYXVsdFBpZUNoYXJ0UHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q0MC5jcmVhdGVFbGVtZW50KFBvbGFyQ2hhcnQsIHsKICAgIGNoYXJ0TmFtZTogIlBpZUNoYXJ0IiwKICAgIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOiAiaXRlbSIsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzOiBhbGxvd2VkVG9vbHRpcFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlcjogYXJyYXlUb29sdGlwU2VhcmNoZXIsCiAgICBjYXRlZ29yaWNhbENoYXJ0UHJvcHM6IHByb3BzV2l0aERlZmF1bHRzLAogICAgcmVmCiAgfSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9BcmVhQ2hhcnQuanMKdmFyIFJlYWN0NDEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGFsbG93ZWRUb29sdGlwVHlwZXMyID0gWyJheGlzIl07CnZhciBBcmVhQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDU2LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQxLmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuQ2hhcnQsIHsKICAgIGNoYXJ0TmFtZTogIkFyZWFDaGFydCIsCiAgICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTogImF4aXMiLAogICAgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlczogYWxsb3dlZFRvb2x0aXBUeXBlczIsCiAgICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyOiBhcnJheVRvb2x0aXBTZWFyY2hlciwKICAgIGNhdGVnb3JpY2FsQ2hhcnRQcm9wczogcHJvcHMsCiAgICByZWYKICB9KTsKfSk7CgovLyBzcmMvUG9ydGZvbGlvU2ltdWxhdG9yLnRzeAp2YXIgaW1wb3J0X2pzeF9ydW50aW1lID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgQ09MT1JTID0gewogIHByaW1hcnk6ICIjNTZDNTk2IiwKICBwcmltYXJ5RGFyazogIiMzYWE4N2IiLAogIGJnOiAiI0ZBRkFGQSIsCiAgY2FyZDogIiNGRkZGRkYiLAogIHRleHRNYWluOiAiIzFBMUExQSIsCiAgdGV4dFNlY29uZGFyeTogIiM5Q0EzQUYiLAogIGJvcmRlcjogIiNGM0Y0RjYiLAogIGlucHV0Qmc6ICIjRjlGQUZCIiwKICBhY2NlbnRMaWdodDogIiNFNkY3RjAiLAogIGJsdWU6ICIjNUQ5Q0VDIiwKICB5ZWxsb3c6ICIjRjU5RTBCIiwKICByZWQ6ICIjRkY2QjZCIiwKICBvcmFuZ2U6ICIjRjI5OTRBIiwKICBvcmFuZ2VMaWdodDogIiNGRkY3RUQiLAogIHB1cnBsZTogIiM4QjVDRjYiCn07CnZhciBBTExPQ0FUSU9OX0NPTE9SUyA9IFsiIzU2QzU5NiIsICIjNUQ5Q0VDIiwgIiNGNTlFMEIiLCAiI0YyOTk0QSIsICIjOEI1Q0Y2IiwgIiNFQzQ4OTkiLCAiIzE0QjhBNiIsICIjNjM2NkYxIiwgIiNBODU1RjciXTsKdmFyIEFTU0VUX0FTU1VNUFRJT05TID0gewogIHN0b2NrczogeyBtZWFuOiAwLjEsIHN0ZERldjogMC4xOCwgbmFtZTogIlN0b2NrcyIgfSwKICBib25kczogeyBtZWFuOiAwLjA1LCBzdGREZXY6IDAuMDYsIG5hbWU6ICJCb25kcyIgfSwKICBjYXNoOiB7IG1lYW46IDAuMDIsIHN0ZERldjogMC4wMSwgbmFtZTogIkNhc2giIH0sCiAgcmVhbEVzdGF0ZTogeyBtZWFuOiAwLjA4LCBzdGREZXY6IDAuMTIsIG5hbWU6ICJSZWFsIEVzdGF0ZSIgfSwKICBjcnlwdG86IHsgbWVhbjogMC4xNSwgc3RkRGV2OiAwLjYsIG5hbWU6ICJDcnlwdG8iIH0sCiAgZm91ck9oT25lSzogeyBtZWFuOiAwLjA4LCBzdGREZXY6IDAuMTQsIG5hbWU6ICI0MDFrIiB9LAogIGFsdEludmVzdG1lbnRzOiB7IG1lYW46IDAuMDksIHN0ZERldjogMC4yLCBuYW1lOiAiQWx0ZXJuYXRpdmUgSW52ZXN0bWVudHMiIH0sCiAgc3RhcnR1cHM6IHsgbWVhbjogMC4yLCBzdGREZXY6IDAuNywgbmFtZTogIlN0YXJ0dXAgSW52ZXN0bWVudHMiIH0sCiAgb3RoZXI6IHsgbWVhbjogMC4wNiwgc3RkRGV2OiAwLjE1LCBuYW1lOiAiT3RoZXIiIH0KfTsKdmFyIFNUT1JBR0VfS0VZID0gIlBPUlRGT0xJT19PUFRJTUlaRVJfREFUQSI7CnZhciBCQU5ORVJfU1RPUkFHRV9LRVkgPSAiUE9SVEZPTElPX0JBTk5FUl9ESVNNSVNTRUQiOwp2YXIgRVhQSVJBVElPTl9IT1VSUyA9IDcyOwp2YXIgREVGQVVMVF9EQVRBID0gewogIGFsbG9jYXRpb246IHsgc3RvY2tzOiAiNjAiLCBib25kczogIjI1IiwgY2FzaDogIjUiLCByZWFsRXN0YXRlOiAiNSIsIGNyeXB0bzogIjAiLCBmb3VyT2hPbmVLOiAiMCIsIGFsdEludmVzdG1lbnRzOiAiMCIsIHN0YXJ0dXBzOiAiMCIsIG90aGVyOiAiNSIgfSwKICB0aW1lSG9yaXpvbjogIjEwIiwKICBpbnB1dE1vZGU6ICJwZXJjZW50IiwKICBhbm51YWxDb250cmlidXRpb246ICI2MDAwIiwKICBpbml0aWFsSW52ZXN0bWVudDogIjEwMDAwIiwKICBpbnZlc3RtZW50R29hbDogImdyb3d0aCIsCiAgYWN0aXZlUHJlc2V0OiAiYmFsYW5jZWQiCn07CnZhciBsb2FkU2F2ZWREYXRhID0gKCkgPT4gewogIHRyeSB7CiAgICBjb25zdCBzYXZlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUT1JBR0VfS0VZKTsKICAgIGlmIChzYXZlZCkgewogICAgICBjb25zdCB7IGRhdGEsIHRpbWVzdGFtcCB9ID0gSlNPTi5wYXJzZShzYXZlZCk7CiAgICAgIGNvbnN0IG5vdyA9ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkuZ2V0VGltZSgpOwogICAgICBjb25zdCBob3Vyc0RpZmYgPSAobm93IC0gdGltZXN0YW1wKSAvICgxZTMgKiA2MCAqIDYwKTsKICAgICAgaWYgKGhvdXJzRGlmZiA8IEVYUElSQVRJT05fSE9VUlMpIHsKICAgICAgICByZXR1cm4geyAuLi5ERUZBVUxUX0RBVEEsIC4uLmRhdGEgfTsKICAgICAgfQogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIHNhdmVkIHBvcnRmb2xpbyBkYXRhIiwgZSk7CiAgfQogIHJldHVybiBERUZBVUxUX0RBVEE7Cn07CnZhciBzYXZlRGF0YSA9IChkYXRhKSA9PiB7CiAgdHJ5IHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZLCBKU09OLnN0cmluZ2lmeSh7CiAgICAgIGRhdGEsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS5nZXRUaW1lKCkKICAgIH0pKTsKICB9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gc2F2ZSBwb3J0Zm9saW8gZGF0YSIsIGUpOwogIH0KfTsKdmFyIGNsZWFyU2F2ZWREYXRhID0gKCkgPT4gewogIHRyeSB7CiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShTVE9SQUdFX0tFWSk7CiAgfSBjYXRjaCAoZSkgewogICAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIGNsZWFyIHNhdmVkIGRhdGEiLCBlKTsKICB9Cn07CnZhciBOdW1iZXJDb250cm9sID0gKHsgdmFsdWUsIG9uQ2hhbmdlLCBtaW46IG1pbjIgPSAwLCBtYXg6IG1heDIgPSAxZTcsIHN0ZXAgPSAxLCBzdWZmaXg6IHN1ZmZpeDIsIHByZWZpeCwgZGlzYWJsZWQgPSBmYWxzZSB9KSA9PiB7CiAgY29uc3QgaGFuZGxlRGVjID0gKCkgPT4gewogICAgaWYgKGRpc2FibGVkKSByZXR1cm47CiAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHZhbHVlKSB8fCAwOwogICAgaWYgKG51bSAtIHN0ZXAgPj0gbWluMikgb25DaGFuZ2UoTWF0aC5yb3VuZCgobnVtIC0gc3RlcCkgKiAxMDApIC8gMTAwICsgIiIpOwogIH07CiAgY29uc3QgaGFuZGxlSW5jID0gKCkgPT4gewogICAgaWYgKGRpc2FibGVkKSByZXR1cm47CiAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHZhbHVlKSB8fCAwOwogICAgaWYgKG51bSArIHN0ZXAgPD0gbWF4Mikgb25DaGFuZ2UoTWF0aC5yb3VuZCgobnVtICsgc3RlcCkgKiAxMDApIC8gMTAwICsgIiIpOwogIH07CiAgY29uc3QgaGFuZGxlQ2hhbmdlID0gKGUpID0+IHsKICAgIGlmIChkaXNhYmxlZCkgcmV0dXJuOwogICAgY29uc3QgdmFsID0gZS50YXJnZXQudmFsdWUucmVwbGFjZSgvLC9nLCAiIikucmVwbGFjZSgvW14wLTkuXS9nLCAiIik7CiAgICBvbkNoYW5nZSh2YWwpOwogIH07CiAgY29uc3QgYnRuU3R5bGUgPSB7IHdpZHRoOiAiMzJweCIsIGhlaWdodDogIjMycHgiLCBib3JkZXJSYWRpdXM6ICI4cHgiLCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBkaXNhYmxlZCA/IENPTE9SUy5ib3JkZXIgOiAid2hpdGUiLCBjb2xvcjogZGlzYWJsZWQgPyBDT0xPUlMudGV4dFNlY29uZGFyeSA6IENPTE9SUy5wcmltYXJ5LCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGN1cnNvcjogZGlzYWJsZWQgPyAibm90LWFsbG93ZWQiIDogInBvaW50ZXIiLCBib3hTaGFkb3c6ICIwIDJweCA0cHggcmdiYSgwLDAsMCwwLjA1KSIgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgYm9yZGVyUmFkaXVzOiAiMTJweCIsIHBhZGRpbmc6ICI2cHgiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBnYXA6ICI4cHgiLCBoZWlnaHQ6ICI0NHB4Iiwgb3BhY2l0eTogZGlzYWJsZWQgPyAwLjYgOiAxIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZURlYywgc3R5bGU6IGJ0blN0eWxlLCBkaXNhYmxlZCwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTWludXMsIHsgc2l6ZTogMTYsIHN0cm9rZVdpZHRoOiAzIH0pIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgdGV4dEFsaWduOiAiY2VudGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCBnYXA6ICI0cHgiIH0sIGNoaWxkcmVuOiBbCiAgICAgIHByZWZpeCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjE2cHgiLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IHByZWZpeCB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaW5wdXQiLCB7IHR5cGU6ICJ0ZXh0IiwgdmFsdWU6IHZhbHVlID8gTnVtYmVyKHZhbHVlKS50b0xvY2FsZVN0cmluZygpIDogIiIsIG9uQ2hhbmdlOiBoYW5kbGVDaGFuZ2UsIGRpc2FibGVkLCBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogInRyYW5zcGFyZW50IiwgdGV4dEFsaWduOiAiY2VudGVyIiwgZm9udFNpemU6ICIxNnB4IiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBvdXRsaW5lOiAibm9uZSIgfSB9KSwKICAgICAgc3VmZml4MiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjE0cHgiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRXZWlnaHQ6IDUwMCB9LCBjaGlsZHJlbjogc3VmZml4MiB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogaGFuZGxlSW5jLCBzdHlsZTogYnRuU3R5bGUsIGRpc2FibGVkLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQbHVzLCB7IHNpemU6IDE2LCBzdHJva2VXaWR0aDogMyB9KSB9KQogIF0gfSk7Cn07CnZhciBBU1NFVF9UT09MVElQUyA9IHsKICBzdG9ja3M6ICJQdWJsaWNseSB0cmFkZWQgY29tcGFueSBzaGFyZXMgKEVURnMsIGluZGV4IGZ1bmRzLCBpbmRpdmlkdWFsIHN0b2NrcykiLAogIGJvbmRzOiAiRml4ZWQtaW5jb21lIHNlY3VyaXRpZXMgKGdvdmVybm1lbnQsIGNvcnBvcmF0ZSwgbXVuaWNpcGFsIGJvbmRzKSIsCiAgY2FzaDogIkxpcXVpZCBhc3NldHMgKHNhdmluZ3MgYWNjb3VudHMsIG1vbmV5IG1hcmtldCwgQ0RzKSIsCiAgcmVhbEVzdGF0ZTogIlRvdGFsIHZhbHVlIG9mIHJlYWwgZXN0YXRlIGhvbGRpbmdzIChwcm9wZXJ0eSwgUkVJVHMpIiwKICBjcnlwdG86ICJDcnlwdG9jdXJyZW5jeSBob2xkaW5ncyAoQml0Y29pbiwgRXRoZXJldW0sIGV0Yy4pIiwKICBmb3VyT2hPbmVLOiAiRW1wbG95ZXItc3BvbnNvcmVkIHJldGlyZW1lbnQgYWNjb3VudCBiYWxhbmNlIiwKICBhbHRJbnZlc3RtZW50czogIkFsdGVybmF0aXZlIGludmVzdG1lbnRzIChjb21tb2RpdGllcywgaGVkZ2UgZnVuZHMsIHByaXZhdGUgZXF1aXR5KSIsCiAgc3RhcnR1cHM6ICJFYXJseS1zdGFnZSBjb21wYW55IGludmVzdG1lbnRzIChhbmdlbCwgdmVudHVyZSwgZXF1aXR5IGNyb3dkZnVuZGluZykiLAogIG90aGVyOiAiQW55IG90aGVyIGludmVzdG1lbnRzIG5vdCBsaXN0ZWQgYWJvdmUiCn07CnZhciBBU1NFVF9MSU5LUyA9IHsKICBzdG9ja3M6ICJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TdG9jayIsCiAgYm9uZHM6ICJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Cb25kXyhmaW5hbmNlKSIsCiAgY2FzaDogImh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Nhc2hfYW5kX2Nhc2hfZXF1aXZhbGVudHMiLAogIHJlYWxFc3RhdGU6ICJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9SZWFsX2VzdGF0ZV9pbnZlc3RpbmciLAogIGNyeXB0bzogImh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NyeXB0b2N1cnJlbmN5IiwKICBmb3VyT2hPbmVLOiAiaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvNDAxKGspIiwKICBhbHRJbnZlc3RtZW50czogImh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0FsdGVybmF0aXZlX2ludmVzdG1lbnQiLAogIHN0YXJ0dXBzOiAiaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3RhcnR1cF9jb21wYW55IiwKICBvdGhlcjogImh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0ludmVzdG1lbnQiCn07CnZhciBJbmZvVG9vbHRpcCA9ICh7IHRleHQsIGxpbmssIGNoaWxkcmVuIH0pID0+IHsKICBjb25zdCBbc2hvdywgc2V0U2hvd10gPSBpbXBvcnRfcmVhY3Q1Ny5kZWZhdWx0LnVzZVN0YXRlKGZhbHNlKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIsIGRpc3BsYXk6ICJpbmxpbmUtZmxleCIgfSwgb25Nb3VzZUVudGVyOiAoKSA9PiBzZXRTaG93KHRydWUpLCBvbk1vdXNlTGVhdmU6ICgpID0+IHNldFNob3coZmFsc2UpLCBjaGlsZHJlbjogWwogICAgY2hpbGRyZW4sCiAgICBzaG93ICYmIHRleHQgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIGJvdHRvbTogIjEwMCUiLCBsZWZ0OiAiNTAlIiwgdHJhbnNmb3JtOiAidHJhbnNsYXRlWCgtNTAlKSIsIG1hcmdpbkJvdHRvbTogNiwgcGFkZGluZzogIjhweCAxMnB4IiwgYmFja2dyb3VuZENvbG9yOiAiIzMzMyIsIGNvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTEsIGJvcmRlclJhZGl1czogOCwgd2hpdGVTcGFjZTogIm5vcm1hbCIsIHpJbmRleDogMWUzLCB3aWR0aDogMjAwLCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBib3hTaGFkb3c6ICIwIDRweCAxMnB4IHJnYmEoMCwwLDAsMC4yKSIgfSwgb25Nb3VzZUVudGVyOiAoKSA9PiBzZXRTaG93KHRydWUpLCBvbk1vdXNlTGVhdmU6ICgpID0+IHNldFNob3coZmFsc2UpLCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogbGluayA/IDggOiAwIH0sIGNoaWxkcmVuOiB0ZXh0IH0pLAogICAgICBsaW5rICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImEiLCB7IGhyZWY6IGxpbmssIHRhcmdldDogIl9ibGFuayIsIHJlbDogIm5vb3BlbmVyIG5vcmVmZXJyZXIiLCBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRTaXplOiAxMCwgZm9udFdlaWdodDogNzAwLCB0ZXh0RGVjb3JhdGlvbjogIm5vbmUiLCBkaXNwbGF5OiAiaW5saW5lLWJsb2NrIiwgcGFkZGluZzogIjRweCA4cHgiLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiLCBib3JkZXJSYWRpdXM6IDQgfSwgY2hpbGRyZW46ICJMRUFSTiBNT1JFIiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogImFic29sdXRlIiwgdG9wOiAiMTAwJSIsIGxlZnQ6ICI1MCUiLCB0cmFuc2Zvcm06ICJ0cmFuc2xhdGVYKC01MCUpIiwgYm9yZGVyTGVmdDogIjZweCBzb2xpZCB0cmFuc3BhcmVudCIsIGJvcmRlclJpZ2h0OiAiNnB4IHNvbGlkIHRyYW5zcGFyZW50IiwgYm9yZGVyVG9wOiAiNnB4IHNvbGlkICMzMzMiIH0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHdpZHRoOiAiMTAwJSIsIGhlaWdodDogIjIwcHgiLCB0b3A6ICIxMDAlIiwgbGVmdDogMCB9IH0pCiAgICBdIH0pCiAgXSB9KTsKfTsKdmFyIEFsbG9jYXRpb25TbGlkZXIgPSAoeyBsYWJlbCwgdmFsdWUsIG9uQ2hhbmdlLCBjb2xvcjogY29sb3IyLCBpbnB1dE1vZGUgPSAicGVyY2VudCIsIGZpZWxkS2V5LCBtYXhEb2xsYXIgPSAxZTUgfSkgPT4gewogIGNvbnN0IG51bVZhbCA9IHBhcnNlRmxvYXQodmFsdWUpIHx8IDA7CiAgY29uc3Qgc2xpZGVyUGVyY2VudCA9IGlucHV0TW9kZSA9PT0gInBlcmNlbnQiID8gbnVtVmFsIDogTWF0aC5taW4obnVtVmFsIC8gbWF4RG9sbGFyICogMTAwLCAxMDApOwogIGNvbnN0IHRvb2x0aXBUZXh0ID0gZmllbGRLZXkgPyBBU1NFVF9UT09MVElQU1tmaWVsZEtleV0gOiAiIjsKICBjb25zdCB0b29sdGlwTGluayA9IGZpZWxkS2V5ID8gQVNTRVRfTElOS1NbZmllbGRLZXldIDogIiI7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAiY2FsYyg1MCUgLSA4cHgpIiwgZmxleFNocmluazogMCwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgbWFyZ2luQm90dG9tOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNSwgbWluV2lkdGg6IDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIGZvbnRTaXplOiAxMywgd2hpdGVTcGFjZTogIm5vd3JhcCIsIG92ZXJmbG93OiAiaGlkZGVuIiwgdGV4dE92ZXJmbG93OiAiZWxsaXBzaXMiIH0sIGNoaWxkcmVuOiBsYWJlbCB9KSwKICAgICAgICB0b29sdGlwVGV4dCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEluZm9Ub29sdGlwLCB7IHRleHQ6IHRvb2x0aXBUZXh0LCBsaW5rOiB0b29sdGlwTGluaywgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDE0LCBoZWlnaHQ6IDE0LCBib3JkZXJSYWRpdXM6ICI1MCUiLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5ib3JkZXIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgY3Vyc29yOiAicG9pbnRlciIsIGZvbnRTaXplOiA5LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZmxleFNocmluazogMCB9LCBjaGlsZHJlbjogImkiIH0pIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgcGFkZGluZzogIjZweCAxMHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXJMZWZ0OiAibm9uZSIsIHdpZHRoOiBpbnB1dE1vZGUgPT09ICJkb2xsYXIiID8gMTEwIDogNjUsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgZmxleFNocmluazogMCB9LCBjaGlsZHJlbjogWwogICAgICAgIGlucHV0TW9kZSA9PT0gImRvbGxhciIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250V2VpZ2h0OiA2MDAsIGZvbnRTaXplOiAxMyB9LCBjaGlsZHJlbjogIiQiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyB0eXBlOiAidGV4dCIsIHZhbHVlOiBpbnB1dE1vZGUgPT09ICJkb2xsYXIiID8gbnVtVmFsID4gMCA/IG51bVZhbC50b0xvY2FsZVN0cmluZygpIDogdmFsdWUgOiB2YWx1ZSwgb25DaGFuZ2U6IChlKSA9PiBvbkNoYW5nZShlLnRhcmdldC52YWx1ZS5yZXBsYWNlKC8sL2csICIiKS5yZXBsYWNlKC9bXjAtOV0vZywgIiIpKSwgcGxhY2Vob2xkZXI6ICIwIiwgc3R5bGU6IHsgd2lkdGg6IGlucHV0TW9kZSA9PT0gImRvbGxhciIgPyA3NSA6IDMyLCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogInRyYW5zcGFyZW50IiwgdGV4dEFsaWduOiAicmlnaHQiLCBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgb3V0bGluZTogIm5vbmUiIH0gfSksCiAgICAgICAgaW5wdXRNb2RlID09PSAicGVyY2VudCIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250V2VpZ2h0OiA2MDAsIGZvbnRTaXplOiAxMyB9LCBjaGlsZHJlbjogIiUiIH0pCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJpbnB1dCIsIHsgdHlwZTogInJhbmdlIiwgbWluOiAwLCBtYXg6IGlucHV0TW9kZSA9PT0gInBlcmNlbnQiID8gMTAwIDogbWF4RG9sbGFyLCB2YWx1ZTogbnVtVmFsLCBvbkNoYW5nZTogKGUpID0+IG9uQ2hhbmdlKGUudGFyZ2V0LnZhbHVlKSwgc3R5bGU6IHsgd2lkdGg6ICIxMDAlIiwgaGVpZ2h0OiA2LCBib3JkZXJSYWRpdXM6IDMsIGFwcGVhcmFuY2U6ICJub25lIiwgYmFja2dyb3VuZDogYGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgJHtjb2xvcjJ9IDAlLCAke2NvbG9yMn0gJHtzbGlkZXJQZXJjZW50fSUsICR7Q09MT1JTLmJvcmRlcn0gJHtzbGlkZXJQZXJjZW50fSUsICR7Q09MT1JTLmJvcmRlcn0gMTAwJSlgLCBjdXJzb3I6ICJwb2ludGVyIiB9IH0pCiAgXSB9KTsKfTsKZnVuY3Rpb24gcnVuTW9udGVDYXJsb1NpbXVsYXRpb24oYWxsb2NhdGlvbiwgdGltZUhvcml6b24sIGFubnVhbENvbnRyaWJ1dGlvbiwgaW5pdGlhbEludmVzdG1lbnQsIGlucHV0TW9kZSwgaW52ZXN0bWVudEdvYWwsIG51bVNpbXVsYXRpb25zID0gNTAwKSB7CiAgY29uc3QgZ29hbE1vZGlmaWVycyA9IHsKICAgIHByZXNlcnZhdGlvbjogeyByZXR1cm5NdWx0OiAwLjg1LCByaXNrTXVsdDogMC43IH0sCiAgICBpbmNvbWU6IHsgcmV0dXJuTXVsdDogMC45NSwgcmlza011bHQ6IDAuODUgfSwKICAgIGdyb3d0aDogeyByZXR1cm5NdWx0OiAxLCByaXNrTXVsdDogMSB9CiAgfTsKICBjb25zdCBnb2FsTW9kID0gZ29hbE1vZGlmaWVyc1tpbnZlc3RtZW50R29hbF0gfHwgZ29hbE1vZGlmaWVycy5ncm93dGg7CiAgbGV0IGFsbG9jYXRpb25WYWx1ZXM7CiAgbGV0IGNvbXB1dGVkSW5pdGlhbEludmVzdG1lbnQgPSBpbml0aWFsSW52ZXN0bWVudDsKICBpZiAoaW5wdXRNb2RlID09PSAiZG9sbGFyIikgewogICAgY29uc3QgdG90YWwgPSAocGFyc2VGbG9hdChhbGxvY2F0aW9uLnN0b2NrcykgfHwgMCkgKyAocGFyc2VGbG9hdChhbGxvY2F0aW9uLmJvbmRzKSB8fCAwKSArIChwYXJzZUZsb2F0KGFsbG9jYXRpb24uY2FzaCkgfHwgMCkgKyAocGFyc2VGbG9hdChhbGxvY2F0aW9uLnJlYWxFc3RhdGUpIHx8IDApICsgKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5jcnlwdG8pIHx8IDApICsgKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5mb3VyT2hPbmVLKSB8fCAwKSArIChwYXJzZUZsb2F0KGFsbG9jYXRpb24uYWx0SW52ZXN0bWVudHMpIHx8IDApICsgKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5zdGFydHVwcykgfHwgMCkgKyAocGFyc2VGbG9hdChhbGxvY2F0aW9uLm90aGVyKSB8fCAwKTsKICAgIGNvbXB1dGVkSW5pdGlhbEludmVzdG1lbnQgPSB0b3RhbDsKICAgIGFsbG9jYXRpb25WYWx1ZXMgPSB7CiAgICAgIHN0b2NrczogdG90YWwgPiAwID8gKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5zdG9ja3MpIHx8IDApIC8gdG90YWwgOiAwLAogICAgICBib25kczogdG90YWwgPiAwID8gKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5ib25kcykgfHwgMCkgLyB0b3RhbCA6IDAsCiAgICAgIGNhc2g6IHRvdGFsID4gMCA/IChwYXJzZUZsb2F0KGFsbG9jYXRpb24uY2FzaCkgfHwgMCkgLyB0b3RhbCA6IDAsCiAgICAgIHJlYWxFc3RhdGU6IHRvdGFsID4gMCA/IChwYXJzZUZsb2F0KGFsbG9jYXRpb24ucmVhbEVzdGF0ZSkgfHwgMCkgLyB0b3RhbCA6IDAsCiAgICAgIGNyeXB0bzogdG90YWwgPiAwID8gKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5jcnlwdG8pIHx8IDApIC8gdG90YWwgOiAwLAogICAgICBmb3VyT2hPbmVLOiB0b3RhbCA+IDAgPyAocGFyc2VGbG9hdChhbGxvY2F0aW9uLmZvdXJPaE9uZUspIHx8IDApIC8gdG90YWwgOiAwLAogICAgICBhbHRJbnZlc3RtZW50czogdG90YWwgPiAwID8gKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5hbHRJbnZlc3RtZW50cykgfHwgMCkgLyB0b3RhbCA6IDAsCiAgICAgIHN0YXJ0dXBzOiB0b3RhbCA+IDAgPyAocGFyc2VGbG9hdChhbGxvY2F0aW9uLnN0YXJ0dXBzKSB8fCAwKSAvIHRvdGFsIDogMCwKICAgICAgb3RoZXI6IHRvdGFsID4gMCA/IChwYXJzZUZsb2F0KGFsbG9jYXRpb24ub3RoZXIpIHx8IDApIC8gdG90YWwgOiAwCiAgICB9OwogIH0gZWxzZSB7CiAgICBhbGxvY2F0aW9uVmFsdWVzID0gewogICAgICBzdG9ja3M6IChwYXJzZUZsb2F0KGFsbG9jYXRpb24uc3RvY2tzKSB8fCAwKSAvIDEwMCwKICAgICAgYm9uZHM6IChwYXJzZUZsb2F0KGFsbG9jYXRpb24uYm9uZHMpIHx8IDApIC8gMTAwLAogICAgICBjYXNoOiAocGFyc2VGbG9hdChhbGxvY2F0aW9uLmNhc2gpIHx8IDApIC8gMTAwLAogICAgICByZWFsRXN0YXRlOiAocGFyc2VGbG9hdChhbGxvY2F0aW9uLnJlYWxFc3RhdGUpIHx8IDApIC8gMTAwLAogICAgICBjcnlwdG86IChwYXJzZUZsb2F0KGFsbG9jYXRpb24uY3J5cHRvKSB8fCAwKSAvIDEwMCwKICAgICAgZm91ck9oT25lSzogKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5mb3VyT2hPbmVLKSB8fCAwKSAvIDEwMCwKICAgICAgYWx0SW52ZXN0bWVudHM6IChwYXJzZUZsb2F0KGFsbG9jYXRpb24uYWx0SW52ZXN0bWVudHMpIHx8IDApIC8gMTAwLAogICAgICBzdGFydHVwczogKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5zdGFydHVwcykgfHwgMCkgLyAxMDAsCiAgICAgIG90aGVyOiAocGFyc2VGbG9hdChhbGxvY2F0aW9uLm90aGVyKSB8fCAwKSAvIDEwMAogICAgfTsKICB9CiAgbGV0IHBvcnRmb2xpb1JldHVybiA9IDA7CiAgbGV0IHdlaWdodGVkVm9sID0gMDsKICBsZXQgdmFyaWFuY2VTdW0gPSAwOwogIGZvciAoY29uc3QgW2Fzc2V0LCB3ZWlnaHRdIG9mIE9iamVjdC5lbnRyaWVzKGFsbG9jYXRpb25WYWx1ZXMpKSB7CiAgICBjb25zdCBhc3N1bXB0aW9ucyA9IEFTU0VUX0FTU1VNUFRJT05TW2Fzc2V0XTsKICAgIGlmIChhc3N1bXB0aW9ucykgewogICAgICBjb25zdCB3ZWlnaHRlZE1lYW4gPSB3ZWlnaHQgKiBhc3N1bXB0aW9ucy5tZWFuICogZ29hbE1vZC5yZXR1cm5NdWx0OwogICAgICBjb25zdCB3ZWlnaHRlZFN0ZCA9IHdlaWdodCAqIGFzc3VtcHRpb25zLnN0ZERldiAqIGdvYWxNb2Qucmlza011bHQ7CiAgICAgIHBvcnRmb2xpb1JldHVybiArPSB3ZWlnaHRlZE1lYW47CiAgICAgIHdlaWdodGVkVm9sICs9IHdlaWdodGVkU3RkOwogICAgICB2YXJpYW5jZVN1bSArPSBNYXRoLnBvdyh3ZWlnaHRlZFN0ZCwgMik7CiAgICB9CiAgfQogIGNvbnN0IHVuY29ycmVsYXRlZFZvbCA9IE1hdGguc3FydCh2YXJpYW5jZVN1bSk7CiAgY29uc3QgcG9ydGZvbGlvU3RkRGV2ID0gKHdlaWdodGVkVm9sICsgdW5jb3JyZWxhdGVkVm9sKSAvIDI7CiAgY29uc3QgbW9udGhseVJldHVybiA9IHBvcnRmb2xpb1JldHVybiAvIDEyOwogIGNvbnN0IG1vbnRobHlTdGREZXYgPSBwb3J0Zm9saW9TdGREZXYgLyBNYXRoLnNxcnQoMTIpOwogIGNvbnN0IG1vbnRobHlDb250cmlidXRpb24gPSBhbm51YWxDb250cmlidXRpb24gLyAxMjsKICBjb25zdCBhbGxQYXRocyA9IFtdOwogIGZvciAobGV0IHNpbSA9IDA7IHNpbSA8IG51bVNpbXVsYXRpb25zOyBzaW0rKykgewogICAgY29uc3QgcGF0aDIgPSBbY29tcHV0ZWRJbml0aWFsSW52ZXN0bWVudF07CiAgICBsZXQgdmFsdWUgPSBjb21wdXRlZEluaXRpYWxJbnZlc3RtZW50OwogICAgZm9yIChsZXQgbW9udGggPSAxOyBtb250aCA8PSB0aW1lSG9yaXpvbiAqIDEyOyBtb250aCsrKSB7CiAgICAgIGNvbnN0IHUxID0gTWF0aC5yYW5kb20oKSwgdTIgPSBNYXRoLnJhbmRvbSgpOwogICAgICBjb25zdCB6ID0gTWF0aC5zcXJ0KC0yICogTWF0aC5sb2codTEpKSAqIE1hdGguY29zKDIgKiBNYXRoLlBJICogdTIpOwogICAgICBjb25zdCBtb250aFJldHVybiA9IG1vbnRobHlSZXR1cm4gKyBtb250aGx5U3RkRGV2ICogejsKICAgICAgdmFsdWUgPSBNYXRoLm1heCgwLCB2YWx1ZSAqICgxICsgbW9udGhSZXR1cm4pICsgbW9udGhseUNvbnRyaWJ1dGlvbik7CiAgICAgIGlmIChtb250aCAlIDEyID09PSAwKSBwYXRoMi5wdXNoKHZhbHVlKTsKICAgIH0KICAgIGFsbFBhdGhzLnB1c2gocGF0aDIpOwogIH0KICBjb25zdCByZXN1bHRzID0gW107CiAgZm9yIChsZXQgeWVhciA9IDA7IHllYXIgPD0gdGltZUhvcml6b247IHllYXIrKykgewogICAgY29uc3QgeWVhclZhbHVlcyA9IGFsbFBhdGhzLm1hcCgocGF0aDIpID0+IHBhdGgyW3llYXJdKS5zb3J0KChhMiwgYikgPT4gYTIgLSBiKTsKICAgIGNvbnN0IHBlcmNlbnRpbGUgPSAocCkgPT4geWVhclZhbHVlc1tNYXRoLm1pbihNYXRoLmZsb29yKHAgKiB5ZWFyVmFsdWVzLmxlbmd0aCksIHllYXJWYWx1ZXMubGVuZ3RoIC0gMSldOwogICAgY29uc3QgZXhwZWN0ZWQgPSB5ZWFyVmFsdWVzLnJlZHVjZSgoYTIsIGIpID0+IGEyICsgYiwgMCkgLyB5ZWFyVmFsdWVzLmxlbmd0aDsKICAgIHJlc3VsdHMucHVzaCh7IHllYXIsIHAxMDogTWF0aC5yb3VuZChwZXJjZW50aWxlKDAuMSkpLCBwMjU6IE1hdGgucm91bmQocGVyY2VudGlsZSgwLjI1KSksIG1lZGlhbjogTWF0aC5yb3VuZChwZXJjZW50aWxlKDAuNSkpLCBwNzU6IE1hdGgucm91bmQocGVyY2VudGlsZSgwLjc1KSksIHA5MDogTWF0aC5yb3VuZChwZXJjZW50aWxlKDAuOSkpLCBleHBlY3RlZDogTWF0aC5yb3VuZChleHBlY3RlZCkgfSk7CiAgfQogIGNvbnN0IGZpbmFsVmFsdWVzID0gYWxsUGF0aHMubWFwKChwYXRoMikgPT4gcGF0aDJbcGF0aDIubGVuZ3RoIC0gMV0pLnNvcnQoKGEyLCBiKSA9PiBhMiAtIGIpOwogIGxldCBtYXhEcmF3ZG93biA9IDA7CiAgZm9yIChjb25zdCBwYXRoMiBvZiBhbGxQYXRocy5zbGljZSgwLCAxMDApKSB7CiAgICBsZXQgcGVhayA9IHBhdGgyWzBdOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiBwYXRoMikgewogICAgICBpZiAodmFsdWUgPiBwZWFrKSBwZWFrID0gdmFsdWU7CiAgICAgIG1heERyYXdkb3duID0gTWF0aC5tYXgobWF4RHJhd2Rvd24sIChwZWFrIC0gdmFsdWUpIC8gcGVhayk7CiAgICB9CiAgfQogIGNvbnN0IHN0YXRzID0geyBleHBlY3RlZFJldHVybjogcG9ydGZvbGlvUmV0dXJuLCB2b2xhdGlsaXR5OiBwb3J0Zm9saW9TdGREZXYsIHNoYXJwZVJhdGlvOiAocG9ydGZvbGlvUmV0dXJuIC0gMC4wMikgLyBwb3J0Zm9saW9TdGREZXYsIG1heERyYXdkb3duLCBmaW5hbE1lZGlhbjogZmluYWxWYWx1ZXNbTWF0aC5mbG9vcihmaW5hbFZhbHVlcy5sZW5ndGggKiAwLjUpXSwgZmluYWxQMTA6IGZpbmFsVmFsdWVzW01hdGguZmxvb3IoZmluYWxWYWx1ZXMubGVuZ3RoICogMC4xKV0sIGZpbmFsUDkwOiBmaW5hbFZhbHVlc1tNYXRoLmZsb29yKGZpbmFsVmFsdWVzLmxlbmd0aCAqIDAuOSldLCBmaW5hbEV4cGVjdGVkOiBmaW5hbFZhbHVlcy5yZWR1Y2UoKGEyLCBiKSA9PiBhMiArIGIsIDApIC8gZmluYWxWYWx1ZXMubGVuZ3RoIH07CiAgcmV0dXJuIHsgcmVzdWx0cywgc3RhdHMgfTsKfQpmdW5jdGlvbiBQb3J0Zm9saW9TaW11bGF0b3IoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICBjb25zdCBzYXZlZERhdGEgPSBsb2FkU2F2ZWREYXRhKCk7CiAgY29uc3QgaGFzSW5pdGlhbCA9IChrZXkpID0+IGluaXRpYWxEYXRhMiAmJiBpbml0aWFsRGF0YTJba2V5XSAhPT0gdm9pZCAwOwogIGNvbnN0IGhhc0FsbG9jYXRpb25EYXRhID0gKCkgPT4gewogICAgaWYgKCFpbml0aWFsRGF0YTIpIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IGFsbG9jYXRpb25LZXlzID0gWyJzdG9ja3MiLCAiYm9uZHMiLCAiY2FzaCIsICJyZWFsX2VzdGF0ZSIsICJjcnlwdG8iLCAiZm91cl9vaF9vbmVfayIsICJhbHRfaW52ZXN0bWVudHMiLCAic3RhcnR1cHMiLCAib3RoZXIiXTsKICAgIHJldHVybiBhbGxvY2F0aW9uS2V5cy5zb21lKChrZXkpID0+IGluaXRpYWxEYXRhMltrZXldICE9PSB2b2lkIDAgJiYgaW5pdGlhbERhdGEyW2tleV0gPiAwKTsKICB9OwogIGNvbnN0IFthbGxvY2F0aW9uLCBzZXRBbGxvY2F0aW9uXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Ny51c2VTdGF0ZSkoKCkgPT4gewogICAgaWYgKGhhc0FsbG9jYXRpb25EYXRhKCkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBzdG9ja3M6IFN0cmluZyhpbml0aWFsRGF0YTIuc3RvY2tzIHx8IDApLAogICAgICAgIGJvbmRzOiBTdHJpbmcoaW5pdGlhbERhdGEyLmJvbmRzIHx8IDApLAogICAgICAgIGNhc2g6IFN0cmluZyhpbml0aWFsRGF0YTIuY2FzaCB8fCAwKSwKICAgICAgICByZWFsRXN0YXRlOiBTdHJpbmcoaW5pdGlhbERhdGEyLnJlYWxfZXN0YXRlIHx8IDApLAogICAgICAgIGNyeXB0bzogU3RyaW5nKGluaXRpYWxEYXRhMi5jcnlwdG8gfHwgMCksCiAgICAgICAgZm91ck9oT25lSzogU3RyaW5nKGluaXRpYWxEYXRhMi5mb3VyX29oX29uZV9rIHx8IDApLAogICAgICAgIGFsdEludmVzdG1lbnRzOiBTdHJpbmcoaW5pdGlhbERhdGEyLmFsdF9pbnZlc3RtZW50cyB8fCAwKSwKICAgICAgICBzdGFydHVwczogU3RyaW5nKGluaXRpYWxEYXRhMi5zdGFydHVwcyB8fCAwKSwKICAgICAgICBvdGhlcjogU3RyaW5nKGluaXRpYWxEYXRhMi5vdGhlciB8fCAwKQogICAgICB9OwogICAgfQogICAgcmV0dXJuIHNhdmVkRGF0YS5hbGxvY2F0aW9uOwogIH0pOwogIGNvbnN0IFt0aW1lSG9yaXpvbiwgc2V0VGltZUhvcml6b25dID0gKDAsIGltcG9ydF9yZWFjdDU3LnVzZVN0YXRlKSgoKSA9PiB7CiAgICBpZiAoaGFzSW5pdGlhbCgidGltZV9ob3Jpem9uIikpIHJldHVybiBTdHJpbmcoaW5pdGlhbERhdGEyLnRpbWVfaG9yaXpvbik7CiAgICBpZiAoaGFzSW5pdGlhbCgicmV0aXJlbWVudF9hZ2UiKSAmJiBoYXNJbml0aWFsKCJjdXJyZW50X2FnZSIpKSB7CiAgICAgIHJldHVybiBTdHJpbmcoTWF0aC5tYXgoMSwgaW5pdGlhbERhdGEyLnJldGlyZW1lbnRfYWdlIC0gaW5pdGlhbERhdGEyLmN1cnJlbnRfYWdlKSk7CiAgICB9CiAgICByZXR1cm4gc2F2ZWREYXRhLnRpbWVIb3Jpem9uOwogIH0pOwogIGNvbnN0IFtpbnB1dE1vZGUsIHNldElucHV0TW9kZV0gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKCgpID0+IHsKICAgIGlmIChoYXNBbGxvY2F0aW9uRGF0YSgpKSByZXR1cm4gImRvbGxhciI7CiAgICByZXR1cm4gc2F2ZWREYXRhLmlucHV0TW9kZTsKICB9KTsKICBjb25zdCBbYW5udWFsQ29udHJpYnV0aW9uLCBzZXRBbm51YWxDb250cmlidXRpb25dID0gKDAsIGltcG9ydF9yZWFjdDU3LnVzZVN0YXRlKSgoKSA9PiB7CiAgICBpZiAoaGFzSW5pdGlhbCgiYW5udWFsX2NvbnRyaWJ1dGlvbiIpKSByZXR1cm4gU3RyaW5nKGluaXRpYWxEYXRhMi5hbm51YWxfY29udHJpYnV0aW9uKTsKICAgIGlmIChoYXNJbml0aWFsKCJtb250aGx5X2NvbnRyaWJ1dGlvbiIpKSByZXR1cm4gU3RyaW5nKGluaXRpYWxEYXRhMi5tb250aGx5X2NvbnRyaWJ1dGlvbiAqIDEyKTsKICAgIGlmIChoYXNJbml0aWFsKCJtb250aGx5X2NvbnRyaWJ1dGlvbnMiKSkgcmV0dXJuIFN0cmluZyhpbml0aWFsRGF0YTIubW9udGhseV9jb250cmlidXRpb25zICogMTIpOwogICAgcmV0dXJuIHNhdmVkRGF0YS5hbm51YWxDb250cmlidXRpb247CiAgfSk7CiAgY29uc3QgW2luaXRpYWxJbnZlc3RtZW50LCBzZXRJbml0aWFsSW52ZXN0bWVudF0gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKCgpID0+IHsKICAgIGlmIChoYXNJbml0aWFsKCJpbml0aWFsX2ludmVzdG1lbnQiKSkgcmV0dXJuIFN0cmluZyhpbml0aWFsRGF0YTIuaW5pdGlhbF9pbnZlc3RtZW50KTsKICAgIGlmIChoYXNJbml0aWFsKCJjdXJyZW50X3JldGlyZW1lbnRfc2F2aW5ncyIpKSByZXR1cm4gU3RyaW5nKGluaXRpYWxEYXRhMi5jdXJyZW50X3JldGlyZW1lbnRfc2F2aW5ncyk7CiAgICByZXR1cm4gc2F2ZWREYXRhLmluaXRpYWxJbnZlc3RtZW50OwogIH0pOwogIGNvbnN0IFtpbnZlc3RtZW50R29hbCwgc2V0SW52ZXN0bWVudEdvYWxdID0gKDAsIGltcG9ydF9yZWFjdDU3LnVzZVN0YXRlKSgoKSA9PiB7CiAgICBpZiAoaGFzSW5pdGlhbCgiaW52ZXN0bWVudF9nb2FsIikpIHJldHVybiBpbml0aWFsRGF0YTIuaW52ZXN0bWVudF9nb2FsOwogICAgcmV0dXJuIHNhdmVkRGF0YS5pbnZlc3RtZW50R29hbDsKICB9KTsKICBjb25zdCBbYWN0aXZlUHJlc2V0LCBzZXRBY3RpdmVQcmVzZXRdID0gKDAsIGltcG9ydF9yZWFjdDU3LnVzZVN0YXRlKSgoKSA9PiB7CiAgICBpZiAoaGFzSW5pdGlhbCgicmlza190b2xlcmFuY2UiKSkgcmV0dXJuIGluaXRpYWxEYXRhMi5yaXNrX3RvbGVyYW5jZTsKICAgIHJldHVybiBzYXZlZERhdGEuYWN0aXZlUHJlc2V0OwogIH0pOwogIGNvbnN0IFtpc1NpbXVsYXRpbmcsIHNldElzU2ltdWxhdGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbc2ltdWxhdGlvblJlc3VsdCwgc2V0U2ltdWxhdGlvblJlc3VsdF0gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IFtzaG93QWR2YW5jZWQsIHNldFNob3dBZHZhbmNlZF0gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbcmVzdWx0Vmlldywgc2V0UmVzdWx0Vmlld10gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKCJwcm9qZWN0aW9uIik7CiAgKDAsIGltcG9ydF9yZWFjdDU3LnVzZUVmZmVjdCkoKCkgPT4gewogICAgc2F2ZURhdGEoewogICAgICBhbGxvY2F0aW9uLAogICAgICB0aW1lSG9yaXpvbiwKICAgICAgaW5wdXRNb2RlLAogICAgICBhbm51YWxDb250cmlidXRpb24sCiAgICAgIGluaXRpYWxJbnZlc3RtZW50LAogICAgICBpbnZlc3RtZW50R29hbCwKICAgICAgYWN0aXZlUHJlc2V0CiAgICB9KTsKICB9LCBbYWxsb2NhdGlvbiwgdGltZUhvcml6b24sIGlucHV0TW9kZSwgYW5udWFsQ29udHJpYnV0aW9uLCBpbml0aWFsSW52ZXN0bWVudCwgaW52ZXN0bWVudEdvYWwsIGFjdGl2ZVByZXNldF0pOwogIGNvbnN0IFtzaG93U3Vic2NyaWJlTW9kYWwsIHNldFNob3dTdWJzY3JpYmVNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbZW1haWwsIHNldEVtYWlsXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Ny51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtzdWJzY3JpYmVTdGF0dXMsIHNldFN1YnNjcmliZVN0YXR1c10gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKCJpZGxlIik7CiAgY29uc3QgW3N1YnNjcmliZU1lc3NhZ2UsIHNldFN1YnNjcmliZU1lc3NhZ2VdID0gKDAsIGltcG9ydF9yZWFjdDU3LnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3Nob3dCYW5uZXIsIHNldFNob3dCYW5uZXJdID0gKDAsIGltcG9ydF9yZWFjdDU3LnVzZVN0YXRlKSgoKSA9PiB7CiAgICB0cnkgewogICAgICBjb25zdCBkaXNtaXNzZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShCQU5ORVJfU1RPUkFHRV9LRVkpOwogICAgICBpZiAoZGlzbWlzc2VkKSB7CiAgICAgICAgY29uc3QgdGltZXN0YW1wID0gcGFyc2VJbnQoZGlzbWlzc2VkLCAxMCk7CiAgICAgICAgY29uc3Qgbm93ID0gKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CiAgICAgICAgaWYgKG5vdyAtIHRpbWVzdGFtcCA8IDI0ICogNjAgKiA2MCAqIDFlMykgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfSk7CiAgY29uc3QgaGFuZGxlRGlzbWlzc0Jhbm5lciA9ICgpID0+IHsKICAgIHNldFNob3dCYW5uZXIoZmFsc2UpOwogICAgdHJ5IHsKICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oQkFOTkVSX1NUT1JBR0VfS0VZLCAoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLmdldFRpbWUoKS50b1N0cmluZygpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHNhdmUgYmFubmVyIGRpc21pc3NhbCIsIGUpOwogICAgfQogIH07CiAgY29uc3QgaGFuZGxlU3Vic2NyaWJlID0gYXN5bmMgKCkgPT4gewogICAgaWYgKCFlbWFpbCB8fCAhZW1haWwuaW5jbHVkZXMoIkAiKSkgewogICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCJQbGVhc2UgZW50ZXIgYSB2YWxpZCBlbWFpbC4iKTsKICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJlcnJvciIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImxvYWRpbmciKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goIi9hcGkvc3Vic2NyaWJlIiwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGVtYWlsLAogICAgICAgICAgdG9waWNJZDogInBvcnRmb2xpby1vcHRpbWl6ZXIiLAogICAgICAgICAgdG9waWNOYW1lOiAiUG9ydGZvbGlvIE9wdGltaXplciBDYWxjdWxhdG9yIgogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICBpZiAocmVzcG9uc2Uub2sgJiYgZGF0YS5zdWNjZXNzKSB7CiAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZShkYXRhLm1lc3NhZ2UpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldEVtYWlsKCIiKTsKICAgICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiaWRsZSIpOwogICAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiIik7CiAgICAgICAgfSwgM2UzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZShkYXRhLmVycm9yIHx8ICJGYWlsZWQgdG8gc3Vic2NyaWJlLiIpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlN1YnNjcmliZSBlcnJvcjoiLCBlKTsKICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJlcnJvciIpOwogICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCJOZXR3b3JrIGVycm9yLiBQbGVhc2UgdHJ5IGFnYWluLiIpOwogICAgfQogIH07CiAgY29uc3QgW3Nob3dGZWVkYmFja01vZGFsLCBzZXRTaG93RmVlZGJhY2tNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbZmVlZGJhY2tUZXh0LCBzZXRGZWVkYmFja1RleHRdID0gKDAsIGltcG9ydF9yZWFjdDU3LnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW2ZlZWRiYWNrU3RhdHVzLCBzZXRGZWVkYmFja1N0YXR1c10gPSAoMCwgaW1wb3J0X3JlYWN0NTcudXNlU3RhdGUpKCJpZGxlIik7CiAgY29uc3QgaGFuZGxlRmVlZGJhY2tTdWJtaXQgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIWZlZWRiYWNrVGV4dC50cmltKCkpIHJldHVybjsKICAgIHNldEZlZWRiYWNrU3RhdHVzKCJzdWJtaXR0aW5nIik7CiAgICB0cnkgewogICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKCIvYXBpL3RyYWNrIiwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGV2ZW50OiAidXNlcl9mZWVkYmFjayIsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGZlZWRiYWNrOiBmZWVkYmFja1RleHQsCiAgICAgICAgICAgIGNhbGN1bGF0b3JUeXBlOiAiUG9ydGZvbGlvIE9wdGltaXplciIKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KTsKICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoInN1Y2Nlc3MiKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldEZlZWRiYWNrVGV4dCgiIik7CiAgICAgICAgICBzZXRGZWVkYmFja1N0YXR1cygiaWRsZSIpOwogICAgICAgIH0sIDJlMyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImVycm9yIik7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcigiRmVlZGJhY2sgZXJyb3I6IiwgZSk7CiAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJlcnJvciIpOwogICAgfQogIH07CiAgY29uc3QgdG90YWxBbGxvY2F0aW9uID0gKDAsIGltcG9ydF9yZWFjdDU3LnVzZU1lbW8pKCgpID0+IChwYXJzZUZsb2F0KGFsbG9jYXRpb24uc3RvY2tzKSB8fCAwKSArIChwYXJzZUZsb2F0KGFsbG9jYXRpb24uYm9uZHMpIHx8IDApICsgKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5jYXNoKSB8fCAwKSArIChwYXJzZUZsb2F0KGFsbG9jYXRpb24ucmVhbEVzdGF0ZSkgfHwgMCkgKyAocGFyc2VGbG9hdChhbGxvY2F0aW9uLmNyeXB0bykgfHwgMCkgKyAocGFyc2VGbG9hdChhbGxvY2F0aW9uLmZvdXJPaE9uZUspIHx8IDApICsgKHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5hbHRJbnZlc3RtZW50cykgfHwgMCkgKyAocGFyc2VGbG9hdChhbGxvY2F0aW9uLnN0YXJ0dXBzKSB8fCAwKSArIChwYXJzZUZsb2F0KGFsbG9jYXRpb24ub3RoZXIpIHx8IDApLCBbYWxsb2NhdGlvbl0pOwogIGNvbnN0IGFsbG9jYXRpb25WYWxpZCA9IGlucHV0TW9kZSA9PT0gImRvbGxhciIgPyB0b3RhbEFsbG9jYXRpb24gPiAwIDogdG90YWxBbGxvY2F0aW9uID09PSAxMDA7CiAgKDAsIGltcG9ydF9yZWFjdDU3LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGFsbG9jYXRpb25WYWxpZCkgcnVuU2ltdWxhdGlvbigpOwogIH0sIFthbGxvY2F0aW9uLCB0aW1lSG9yaXpvbiwgYW5udWFsQ29udHJpYnV0aW9uLCBpbml0aWFsSW52ZXN0bWVudCwgaW5wdXRNb2RlLCBpbnZlc3RtZW50R29hbF0pOwogIGNvbnN0IHJ1blNpbXVsYXRpb24gPSAoKSA9PiB7CiAgICBzZXRJc1NpbXVsYXRpbmcodHJ1ZSk7CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgY29uc3QgcmVzdWx0ID0gcnVuTW9udGVDYXJsb1NpbXVsYXRpb24oYWxsb2NhdGlvbiwgcGFyc2VJbnQodGltZUhvcml6b24pIHx8IDEwLCBwYXJzZUZsb2F0KGFubnVhbENvbnRyaWJ1dGlvbikgfHwgMCwgcGFyc2VGbG9hdChpbml0aWFsSW52ZXN0bWVudCkgfHwgMCwgaW5wdXRNb2RlLCBpbnZlc3RtZW50R29hbCwgNTAwKTsKICAgICAgc2V0U2ltdWxhdGlvblJlc3VsdChyZXN1bHQpOwogICAgICBzZXRJc1NpbXVsYXRpbmcoZmFsc2UpOwogICAgfSwgMTAwKTsKICB9OwogIGNvbnN0IGhhbmRsZUFsbG9jYXRpb25DaGFuZ2UgPSAoZmllbGQsIHZhbHVlKSA9PiB7CiAgICBzZXRBbGxvY2F0aW9uKChwcmV2KSA9PiAoeyAuLi5wcmV2LCBbZmllbGRdOiB2YWx1ZSB9KSk7CiAgICBzZXRBY3RpdmVQcmVzZXQobnVsbCk7CiAgfTsKICBjb25zdCBoYW5kbGVNb2RlU3dpdGNoID0gKG5ld01vZGUpID0+IHsKICAgIGlmIChuZXdNb2RlID09PSBpbnB1dE1vZGUpIHJldHVybjsKICAgIGlmIChuZXdNb2RlID09PSAicGVyY2VudCIpIHsKICAgICAgc2V0QWxsb2NhdGlvbih7IHN0b2NrczogIjYwIiwgYm9uZHM6ICIyNSIsIGNhc2g6ICI1IiwgcmVhbEVzdGF0ZTogIjUiLCBjcnlwdG86ICIwIiwgZm91ck9oT25lSzogIjAiLCBhbHRJbnZlc3RtZW50czogIjAiLCBzdGFydHVwczogIjAiLCBvdGhlcjogIjUiIH0pOwogICAgICBzZXRBY3RpdmVQcmVzZXQoImJhbGFuY2VkIik7CiAgICB9IGVsc2UgewogICAgICBzZXRBbGxvY2F0aW9uKHsgc3RvY2tzOiAiMCIsIGJvbmRzOiAiMCIsIGNhc2g6ICIwIiwgcmVhbEVzdGF0ZTogIjAiLCBjcnlwdG86ICIwIiwgZm91ck9oT25lSzogIjAiLCBhbHRJbnZlc3RtZW50czogIjAiLCBzdGFydHVwczogIjAiLCBvdGhlcjogIjAiIH0pOwogICAgICBzZXRBY3RpdmVQcmVzZXQobnVsbCk7CiAgICB9CiAgICBzZXRJbnB1dE1vZGUobmV3TW9kZSk7CiAgfTsKICBjb25zdCBhcHBseVBlcmNlbnRQcmVzZXQgPSAocHJlc2V0KSA9PiB7CiAgICBzZXRBY3RpdmVQcmVzZXQocHJlc2V0KTsKICAgIGlmIChwcmVzZXQgPT09ICJjb25zZXJ2YXRpdmUiKSB7CiAgICAgIHNldEFsbG9jYXRpb24oeyBzdG9ja3M6ICIzMCIsIGJvbmRzOiAiNTAiLCBjYXNoOiAiMTUiLCByZWFsRXN0YXRlOiAiNSIsIGNyeXB0bzogIjAiLCBmb3VyT2hPbmVLOiAiMCIsIGFsdEludmVzdG1lbnRzOiAiMCIsIHN0YXJ0dXBzOiAiMCIsIG90aGVyOiAiMCIgfSk7CiAgICB9IGVsc2UgaWYgKHByZXNldCA9PT0gImJhbGFuY2VkIikgewogICAgICBzZXRBbGxvY2F0aW9uKHsgc3RvY2tzOiAiNjAiLCBib25kczogIjI1IiwgY2FzaDogIjUiLCByZWFsRXN0YXRlOiAiNSIsIGNyeXB0bzogIjAiLCBmb3VyT2hPbmVLOiAiMCIsIGFsdEludmVzdG1lbnRzOiAiMCIsIHN0YXJ0dXBzOiAiMCIsIG90aGVyOiAiNSIgfSk7CiAgICB9IGVsc2UgewogICAgICBzZXRBbGxvY2F0aW9uKHsgc3RvY2tzOiAiODAiLCBib25kczogIjEwIiwgY2FzaDogIjIiLCByZWFsRXN0YXRlOiAiNSIsIGNyeXB0bzogIjAiLCBmb3VyT2hPbmVLOiAiMCIsIGFsdEludmVzdG1lbnRzOiAiMCIsIHN0YXJ0dXBzOiAiMCIsIG90aGVyOiAiMyIgfSk7CiAgICB9CiAgfTsKICBjb25zdCBhcHBseURvbGxhclByZXNldCA9IChwcmVzZXQpID0+IHsKICAgIHNldEFjdGl2ZVByZXNldChwcmVzZXQpOwogICAgaWYgKHByZXNldCA9PT0gImVhcmx5IikgewogICAgICBzZXRBbGxvY2F0aW9uKHsgc3RvY2tzOiAiNjUwMDAiLCBib25kczogIjUwMDAiLCBjYXNoOiAiMzAwMCIsIHJlYWxFc3RhdGU6ICI1MDAwIiwgY3J5cHRvOiAiNTAwMCIsIGZvdXJPaE9uZUs6ICIxMDAwMCIsIGFsdEludmVzdG1lbnRzOiAiMjAwMCIsIHN0YXJ0dXBzOiAiMzAwMCIsIG90aGVyOiAiMjAwMCIgfSk7CiAgICB9IGVsc2UgaWYgKHByZXNldCA9PT0gIm1pZCIpIHsKICAgICAgc2V0QWxsb2NhdGlvbih7IHN0b2NrczogIjUwMDAwIiwgYm9uZHM6ICIyMDAwMCIsIGNhc2g6ICI1MDAwIiwgcmVhbEVzdGF0ZTogIjUwMDAiLCBjcnlwdG86ICIwIiwgZm91ck9oT25lSzogIjE1MDAwIiwgYWx0SW52ZXN0bWVudHM6ICIwIiwgc3RhcnR1cHM6ICIwIiwgb3RoZXI6ICI1MDAwIiB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHNldEFsbG9jYXRpb24oeyBzdG9ja3M6ICIyNTAwMCIsIGJvbmRzOiAiNDUwMDAiLCBjYXNoOiAiMTUwMDAiLCByZWFsRXN0YXRlOiAiNTAwMCIsIGNyeXB0bzogIjAiLCBmb3VyT2hPbmVLOiAiMTAwMDAiLCBhbHRJbnZlc3RtZW50czogIjAiLCBzdGFydHVwczogIjAiLCBvdGhlcjogIjAiIH0pOwogICAgfQogIH07CiAgY29uc3QgcmVzZXRUb0RlZmF1bHRzID0gKCkgPT4gewogICAgY2xlYXJTYXZlZERhdGEoKTsKICAgIHNldEFsbG9jYXRpb24oREVGQVVMVF9EQVRBLmFsbG9jYXRpb24pOwogICAgc2V0VGltZUhvcml6b24oREVGQVVMVF9EQVRBLnRpbWVIb3Jpem9uKTsKICAgIHNldEFubnVhbENvbnRyaWJ1dGlvbihERUZBVUxUX0RBVEEuYW5udWFsQ29udHJpYnV0aW9uKTsKICAgIHNldEluaXRpYWxJbnZlc3RtZW50KERFRkFVTFRfREFUQS5pbml0aWFsSW52ZXN0bWVudCk7CiAgICBzZXRJbnZlc3RtZW50R29hbChERUZBVUxUX0RBVEEuaW52ZXN0bWVudEdvYWwpOwogICAgc2V0SW5wdXRNb2RlKERFRkFVTFRfREFUQS5pbnB1dE1vZGUpOwogICAgc2V0QWN0aXZlUHJlc2V0KERFRkFVTFRfREFUQS5hY3RpdmVQcmVzZXQpOwogICAgc2V0U2ltdWxhdGlvblJlc3VsdChudWxsKTsKICB9OwogIGNvbnN0IHBpZURhdGEgPSBbCiAgICB7IG5hbWU6ICJTdG9ja3MiLCB2YWx1ZTogcGFyc2VGbG9hdChhbGxvY2F0aW9uLnN0b2NrcykgfHwgMCwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzBdIH0sCiAgICB7IG5hbWU6ICJCb25kcyIsIHZhbHVlOiBwYXJzZUZsb2F0KGFsbG9jYXRpb24uYm9uZHMpIHx8IDAsIGNvbG9yOiBBTExPQ0FUSU9OX0NPTE9SU1sxXSB9LAogICAgeyBuYW1lOiAiQ2FzaCIsIHZhbHVlOiBwYXJzZUZsb2F0KGFsbG9jYXRpb24uY2FzaCkgfHwgMCwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzJdIH0sCiAgICB7IG5hbWU6ICJSZWFsIEVzdGF0ZSIsIHZhbHVlOiBwYXJzZUZsb2F0KGFsbG9jYXRpb24ucmVhbEVzdGF0ZSkgfHwgMCwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzNdIH0sCiAgICB7IG5hbWU6ICJDcnlwdG8iLCB2YWx1ZTogcGFyc2VGbG9hdChhbGxvY2F0aW9uLmNyeXB0bykgfHwgMCwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzRdIH0sCiAgICB7IG5hbWU6ICI0MDFrIiwgdmFsdWU6IHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5mb3VyT2hPbmVLKSB8fCAwLCBjb2xvcjogQUxMT0NBVElPTl9DT0xPUlNbNV0gfSwKICAgIHsgbmFtZTogIkFsdCBJbnZlc3RtZW50cyIsIHZhbHVlOiBwYXJzZUZsb2F0KGFsbG9jYXRpb24uYWx0SW52ZXN0bWVudHMpIHx8IDAsIGNvbG9yOiBBTExPQ0FUSU9OX0NPTE9SU1s2XSB9LAogICAgeyBuYW1lOiAiU3RhcnR1cHMiLCB2YWx1ZTogcGFyc2VGbG9hdChhbGxvY2F0aW9uLnN0YXJ0dXBzKSB8fCAwLCBjb2xvcjogQUxMT0NBVElPTl9DT0xPUlNbN10gfSwKICAgIHsgbmFtZTogIk90aGVyIiwgdmFsdWU6IHBhcnNlRmxvYXQoYWxsb2NhdGlvbi5vdGhlcikgfHwgMCwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzhdIH0KICBdLmZpbHRlcigoZCkgPT4gZC52YWx1ZSA+IDApOwogIGNvbnN0IGdldFN1Z2dlc3RlZEFsbG9jYXRpb24gPSAoKSA9PiB7CiAgICBjb25zdCB5ZWFycyA9IHBhcnNlSW50KHRpbWVIb3Jpem9uKSB8fCAxMDsKICAgIGlmIChpbnZlc3RtZW50R29hbCA9PT0gInByZXNlcnZhdGlvbiIgfHwgeWVhcnMgPD0gMykgcmV0dXJuIHsgc3RvY2tzOiAxNSwgYm9uZHM6IDUwLCBjYXNoOiAyMCwgcmVhbEVzdGF0ZTogNSwgY3J5cHRvOiAwLCBmb3VyT2hPbmVLOiAxMCwgYWx0SW52ZXN0bWVudHM6IDAsIHN0YXJ0dXBzOiAwLCBvdGhlcjogMCB9OwogICAgaWYgKGludmVzdG1lbnRHb2FsID09PSAiaW5jb21lIiB8fCB5ZWFycyA8PSA3KSByZXR1cm4geyBzdG9ja3M6IDM1LCBib25kczogMzAsIGNhc2g6IDUsIHJlYWxFc3RhdGU6IDEwLCBjcnlwdG86IDAsIGZvdXJPaE9uZUs6IDE1LCBhbHRJbnZlc3RtZW50czogNSwgc3RhcnR1cHM6IDAsIG90aGVyOiAwIH07CiAgICByZXR1cm4geyBzdG9ja3M6IDUwLCBib25kczogMTAsIGNhc2g6IDMsIHJlYWxFc3RhdGU6IDcsIGNyeXB0bzogNSwgZm91ck9oT25lSzogMTUsIGFsdEludmVzdG1lbnRzOiA1LCBzdGFydHVwczogMywgb3RoZXI6IDIgfTsKICB9OwogIGNvbnN0IHN1Z2dlc3RlZEFsbG9jYXRpb24gPSBnZXRTdWdnZXN0ZWRBbGxvY2F0aW9uKCk7CiAgY29uc3Qgc3VnZ2VzdGVkUGllRGF0YSA9IFsKICAgIHsgbmFtZTogIlN0b2NrcyIsIHZhbHVlOiBzdWdnZXN0ZWRBbGxvY2F0aW9uLnN0b2NrcywgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzBdIH0sCiAgICB7IG5hbWU6ICJCb25kcyIsIHZhbHVlOiBzdWdnZXN0ZWRBbGxvY2F0aW9uLmJvbmRzLCBjb2xvcjogQUxMT0NBVElPTl9DT0xPUlNbMV0gfSwKICAgIHsgbmFtZTogIkNhc2giLCB2YWx1ZTogc3VnZ2VzdGVkQWxsb2NhdGlvbi5jYXNoLCBjb2xvcjogQUxMT0NBVElPTl9DT0xPUlNbMl0gfSwKICAgIHsgbmFtZTogIlJlYWwgRXN0YXRlIiwgdmFsdWU6IHN1Z2dlc3RlZEFsbG9jYXRpb24ucmVhbEVzdGF0ZSwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzNdIH0sCiAgICB7IG5hbWU6ICJDcnlwdG8iLCB2YWx1ZTogc3VnZ2VzdGVkQWxsb2NhdGlvbi5jcnlwdG8sIGNvbG9yOiBBTExPQ0FUSU9OX0NPTE9SU1s0XSB9LAogICAgeyBuYW1lOiAiNDAxayIsIHZhbHVlOiBzdWdnZXN0ZWRBbGxvY2F0aW9uLmZvdXJPaE9uZUssIGNvbG9yOiBBTExPQ0FUSU9OX0NPTE9SU1s1XSB9LAogICAgeyBuYW1lOiAiQWx0IEludmVzdG1lbnRzIiwgdmFsdWU6IHN1Z2dlc3RlZEFsbG9jYXRpb24uYWx0SW52ZXN0bWVudHMsIGNvbG9yOiBBTExPQ0FUSU9OX0NPTE9SU1s2XSB9LAogICAgeyBuYW1lOiAiU3RhcnR1cHMiLCB2YWx1ZTogc3VnZ2VzdGVkQWxsb2NhdGlvbi5zdGFydHVwcywgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzddIH0sCiAgICB7IG5hbWU6ICJPdGhlciIsIHZhbHVlOiBzdWdnZXN0ZWRBbGxvY2F0aW9uLm90aGVyLCBjb2xvcjogQUxMT0NBVElPTl9DT0xPUlNbOF0gfQogIF0uZmlsdGVyKChkKSA9PiBkLnZhbHVlID4gMCk7CiAgY29uc3Qgc3R5bGVzID0gewogICAgY29udGFpbmVyOiB7IHdpZHRoOiAiMTAwJSIsIG1heFdpZHRoOiAiNjAwcHgiLCBtYXJnaW46ICIwIGF1dG8iLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5iZywgZm9udEZhbWlseTogIidJbnRlcicsIHNhbnMtc2VyaWYiLCBwYWRkaW5nOiAiMjBweCIsIGJveFNpemluZzogImJvcmRlci1ib3giIH0sCiAgICBjYXJkOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIGJvcmRlclJhZGl1czogIjI0cHgiLCBwYWRkaW5nOiAiMjRweCIsIGJveFNoYWRvdzogIjAgMTBweCA0MHB4IC0xMHB4IHJnYmEoMCwwLDAsMC4wOCkiLCBtYXJnaW5Cb3R0b206ICIyMHB4Iiwgd2lkdGg6ICIxMDAlIiwgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIgfSwKICAgIHJvdzogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJmbGV4LXN0YXJ0IiwgbWFyZ2luQm90dG9tOiAiMjBweCIsIGdhcDogIjE2cHgiIH0sCiAgICBjb2x1bW46IHsgZmxleDogMSwgZGlzcGxheTogImZsZXgiLCBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiB9LAogICAgbGFiZWw6IHsgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBmb250U2l6ZTogIjE1cHgiLCBtYXJnaW5Cb3R0b206ICIwcHgiIH0sCiAgICBzdWJoZWFkZXJMYWJlbDogeyBmb250U2l6ZTogIjEycHgiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRXZWlnaHQ6IDQwMCwgbWFyZ2luVG9wOiAiMHB4IiwgbWFyZ2luQm90dG9tOiAiOHB4IiwgbGluZUhlaWdodDogIjEuMyIgfSwKICAgIGNhbGNCdXR0b246IHsgZmxleDogMSwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwgY29sb3I6ICJ3aGl0ZSIsIGJvcmRlcjogIm5vbmUiLCBwYWRkaW5nOiAiMTRweCIsIGJvcmRlclJhZGl1czogIjE2cHgiLCBmb250U2l6ZTogIjE2cHgiLCBmb250V2VpZ2h0OiA3MDAsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGdhcDogIjhweCIsIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSg4NiwgMTk3LCAxNTAsIDAuMikiIH0sCiAgICBzdHJhdGVneUJ0bjogKGFjdGl2ZSkgPT4gKHsgZmxleDogMSwgcGFkZGluZzogIjhweCIsIGJvcmRlclJhZGl1czogIjhweCIsIGJvcmRlcjogYWN0aXZlID8gYDJweCBzb2xpZCAke0NPTE9SUy5wcmltYXJ5fWAgOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IGFjdGl2ZSA/IENPTE9SUy5hY2NlbnRMaWdodCA6ICJ3aGl0ZSIsIGNvbG9yOiBhY3RpdmUgPyBDT0xPUlMucHJpbWFyeURhcmsgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFdlaWdodDogNzAwLCBmb250U2l6ZTogIjEycHgiLCBjdXJzb3I6ICJwb2ludGVyIiwgdGV4dEFsaWduOiAiY2VudGVyIiB9KSwKICAgIHJlc3VsdENhcmQ6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgYm9yZGVyUmFkaXVzOiAiMjRweCIsIHBhZGRpbmc6ICIyNHB4IiwgYm94U2hhZG93OiAiMCAxMHB4IDQwcHggLTEwcHggcmdiYSgwLDAsMCwwLjA4KSIsIG1hcmdpblRvcDogIjI0cHgiIH0sCiAgICBmb290ZXI6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGdhcDogIjI0cHgiLCBtYXJnaW5Ub3A6ICI0MHB4IiwgcGFkZGluZ1RvcDogIjI0cHgiLCBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAgfSwKICAgIGZvb3RlckJ0bjogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6ICI4cHgiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGJvcmRlcjogIm5vbmUiLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogIjE0cHgiLCBmb250V2VpZ2h0OiA2MDAsIHBhZGRpbmc6ICI4cHgiIH0sCiAgICBtb2RhbE92ZXJsYXk6IHsgcG9zaXRpb246ICJmaXhlZCIsIHRvcDogMCwgbGVmdDogMCwgcmlnaHQ6IDAsIGJvdHRvbTogMCwgYmFja2dyb3VuZENvbG9yOiAicmdiYSgwLDAsMCwwLjUpIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMsIHBhZGRpbmc6ICIyMHB4IiwgcGFkZGluZ1RvcDogIjQwcHgiLCBvdmVyZmxvd1k6ICJhdXRvIiB9LAogICAgbW9kYWxDb250ZW50OiB7IGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgYm9yZGVyUmFkaXVzOiAiMjRweCIsIHBhZGRpbmc6ICIyNHB4Iiwgd2lkdGg6ICIxMDAlIiwgbWF4V2lkdGg6ICI1NjBweCIsIGJveFNoYWRvdzogIjAgMjBweCA2MHB4IC0xMHB4IHJnYmEoMCwwLDAsMC4yKSIsIHBvc2l0aW9uOiAicmVsYXRpdmUiIH0sCiAgICBtb2RhbENsb3NlOiB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB0b3A6ICIxNnB4IiwgcmlnaHQ6ICIxNnB4IiwgYmFja2dyb3VuZDogIm5vbmUiLCBib3JkZXI6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgcGFkZGluZzogIjhweCIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiB9LAogICAgaW5wdXQ6IHsgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogIjEycHggMTZweCIsIGJvcmRlclJhZGl1czogIjEycHgiLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGZvbnRTaXplOiAiMTZweCIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogIjE2cHgiLCBib3hTaXppbmc6ICJib3JkZXItYm94Iiwgb3V0bGluZTogIm5vbmUiIH0KICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbnRhaW5lciwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6ICIyOHB4IiwgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206ICIxMHB4IiB9LCBjaGlsZHJlbjogIlRoZSBTdHJhdGVnaWMgUG9ydGZvbGlvIFNpbXVsYXRvciIgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjE0cHgiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogIjIwcHgiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaGVjaywgeyBzaXplOiAxNiwgY29sb3I6IENPTE9SUy5wcmltYXJ5IH0pLAogICAgICAiIEFsaWduZWQgd2l0aCBNb2Rlcm4gUG9ydGZvbGlvIFRoZW9yeSAoTVBUKSAmIEhpc3RvcmljYWwgTWFya2V0IERhdGFcdTIxMjIiCiAgICBdIH0pLAogICAgc2hvd0Jhbm5lciAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5hY2NlbnRMaWdodCwKICAgICAgYm9yZGVyUmFkaXVzOiAiMTZweCIsCiAgICAgIHBhZGRpbmc6ICIxNnB4IiwKICAgICAgbWFyZ2luQm90dG9tOiAiMjRweCIsCiAgICAgIG1hcmdpblRvcDogIjE2cHgiLAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLAogICAgICBmbGV4V3JhcDogIndyYXAiLAogICAgICBnYXA6ICIxMnB4IiwKICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6ICIxNHB4IiwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnByaW1hcnlEYXJrLCBwYWRkaW5nUmlnaHQ6ICIyNHB4IiB9LCBjaGlsZHJlbjogIldhbnQgZXhwZXJ0IHRpcHMgdG8gcmVhY2ggeW91ciBnb2FscyBmYXN0ZXI/IiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsIG9uQ2xpY2s6ICgpID0+IHNldFNob3dTdWJzY3JpYmVNb2RhbCh0cnVlKSwgc3R5bGU6IHsKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiAiOHB4IiwKICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDE2cHgiLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiAiMjRweCIsCiAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgIGZvbnRTaXplOiAiMTNweCIsCiAgICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSg4NiwgMTk3LCAxNTAsIDAuMjUpIiwKICAgICAgICAgIG1hcmdpblJpZ2h0OiAyNAogICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1haWwsIHsgc2l6ZTogMTQgfSksCiAgICAgICAgICAiU3Vic2NyaWJlIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJkaXYiLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBjdXJzb3I6ICJwb2ludGVyIiwgcGFkZGluZzogNCwgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHRvcDogOCwgcmlnaHQ6IDgsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LAogICAgICAgICAgICBvbkNsaWNrOiBoYW5kbGVEaXNtaXNzQmFubmVyLAogICAgICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShYLCB7IHNpemU6IDE2IH0pCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5jYXJkLCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIllvdXIgUG9ydGZvbGlvIEFsbG9jYXRpb24iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA0LCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBib3JkZXJSYWRpdXM6IDgsIHBhZGRpbmc6IDIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgLi4uc3R5bGVzLnN0cmF0ZWd5QnRuKGlucHV0TW9kZSA9PT0gInBlcmNlbnQiKSwgcGFkZGluZzogIjZweCAxMnB4IiwgZm9udFNpemU6IDEzIH0sIG9uQ2xpY2s6ICgpID0+IGhhbmRsZU1vZGVTd2l0Y2goInBlcmNlbnQiKSwgY2hpbGRyZW46ICIlIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgLi4uc3R5bGVzLnN0cmF0ZWd5QnRuKGlucHV0TW9kZSA9PT0gImRvbGxhciIpLCBwYWRkaW5nOiAiNnB4IDEycHgiLCBmb250U2l6ZTogMTMgfSwgb25DbGljazogKCkgPT4gaGFuZGxlTW9kZVN3aXRjaCgiZG9sbGFyIiksIGNoaWxkcmVuOiAiJCIgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogMjAsIHBhZGRpbmc6IDEyLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBib3JkZXJSYWRpdXM6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luQm90dG9tOiA4LCBmb250V2VpZ2h0OiA2MDAgfSwgY2hpbGRyZW46ICJcdTI2QTEgQ2hvb3NlIGEgc3RhcnRpbmcgYWxsb2NhdGlvbiBwcmVzZXQ6IiB9KSwKICAgICAgICBpbnB1dE1vZGUgPT09ICJwZXJjZW50IiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKGFjdGl2ZVByZXNldCA9PT0gImNvbnNlcnZhdGl2ZSIpLCBvbkNsaWNrOiAoKSA9PiBhcHBseVBlcmNlbnRQcmVzZXQoImNvbnNlcnZhdGl2ZSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiQ29uc2VydmF0aXZlIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGZvbnRXZWlnaHQ6IDQwMCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiAiTG93IHJpc2siIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5zdHJhdGVneUJ0bihhY3RpdmVQcmVzZXQgPT09ICJiYWxhbmNlZCIpLCBvbkNsaWNrOiAoKSA9PiBhcHBseVBlcmNlbnRQcmVzZXQoImJhbGFuY2VkIiksIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgY2hpbGRyZW46ICJCYWxhbmNlZCIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIk1vZGVyYXRlIiB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3RyYXRlZ3lCdG4oYWN0aXZlUHJlc2V0ID09PSAiYWdncmVzc2l2ZSIpLCBvbkNsaWNrOiAoKSA9PiBhcHBseVBlcmNlbnRQcmVzZXQoImFnZ3Jlc3NpdmUiKSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBjaGlsZHJlbjogIkFnZ3Jlc3NpdmUiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgZm9udFdlaWdodDogNDAwLCBtYXJnaW5Ub3A6IDIgfSwgY2hpbGRyZW46ICJIaWdoIHJpc2siIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKGFjdGl2ZVByZXNldCA9PT0gImVhcmx5IiksIG9uQ2xpY2s6ICgpID0+IGFwcGx5RG9sbGFyUHJlc2V0KCJlYXJseSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiRWFybHkgTGlmZSIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIjIwcy0zMHMiIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5zdHJhdGVneUJ0bihhY3RpdmVQcmVzZXQgPT09ICJtaWQiKSwgb25DbGljazogKCkgPT4gYXBwbHlEb2xsYXJQcmVzZXQoIm1pZCIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiTWlkIExpZmUiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgZm9udFdlaWdodDogNDAwLCBtYXJnaW5Ub3A6IDIgfSwgY2hpbGRyZW46ICI0MHMtNTBzIiB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3RyYXRlZ3lCdG4oYWN0aXZlUHJlc2V0ID09PSAibGF0ZSIpLCBvbkNsaWNrOiAoKSA9PiBhcHBseURvbGxhclByZXNldCgibGF0ZSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiTGF0ZSBMaWZlIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGZvbnRXZWlnaHQ6IDQwMCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiAiNjBzKyIgfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZmxleFdyYXA6ICJ3cmFwIiwgZ2FwOiAxNiwgd2lkdGg6ICIxMDAlIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQWxsb2NhdGlvblNsaWRlciwgeyBsYWJlbDogIlN0b2NrcyIsIHZhbHVlOiBhbGxvY2F0aW9uLnN0b2Nrcywgb25DaGFuZ2U6ICh2KSA9PiBoYW5kbGVBbGxvY2F0aW9uQ2hhbmdlKCJzdG9ja3MiLCB2KSwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzBdLCBpbnB1dE1vZGUsIGZpZWxkS2V5OiAic3RvY2tzIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFsbG9jYXRpb25TbGlkZXIsIHsgbGFiZWw6ICJCb25kcyIsIHZhbHVlOiBhbGxvY2F0aW9uLmJvbmRzLCBvbkNoYW5nZTogKHYpID0+IGhhbmRsZUFsbG9jYXRpb25DaGFuZ2UoImJvbmRzIiwgdiksIGNvbG9yOiBBTExPQ0FUSU9OX0NPTE9SU1sxXSwgaW5wdXRNb2RlLCBmaWVsZEtleTogImJvbmRzIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFsbG9jYXRpb25TbGlkZXIsIHsgbGFiZWw6ICI0MDFrIiwgdmFsdWU6IGFsbG9jYXRpb24uZm91ck9oT25lSywgb25DaGFuZ2U6ICh2KSA9PiBoYW5kbGVBbGxvY2F0aW9uQ2hhbmdlKCJmb3VyT2hPbmVLIiwgdiksIGNvbG9yOiBBTExPQ0FUSU9OX0NPTE9SU1s1XSwgaW5wdXRNb2RlLCBmaWVsZEtleTogImZvdXJPaE9uZUsiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQWxsb2NhdGlvblNsaWRlciwgeyBsYWJlbDogIkNhc2giLCB2YWx1ZTogYWxsb2NhdGlvbi5jYXNoLCBvbkNoYW5nZTogKHYpID0+IGhhbmRsZUFsbG9jYXRpb25DaGFuZ2UoImNhc2giLCB2KSwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzJdLCBpbnB1dE1vZGUsIGZpZWxkS2V5OiAiY2FzaCIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBbGxvY2F0aW9uU2xpZGVyLCB7IGxhYmVsOiAiUmVhbCBFc3RhdGUiLCB2YWx1ZTogYWxsb2NhdGlvbi5yZWFsRXN0YXRlLCBvbkNoYW5nZTogKHYpID0+IGhhbmRsZUFsbG9jYXRpb25DaGFuZ2UoInJlYWxFc3RhdGUiLCB2KSwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzNdLCBpbnB1dE1vZGUsIGZpZWxkS2V5OiAicmVhbEVzdGF0ZSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBbGxvY2F0aW9uU2xpZGVyLCB7IGxhYmVsOiAiQ3J5cHRvIiwgdmFsdWU6IGFsbG9jYXRpb24uY3J5cHRvLCBvbkNoYW5nZTogKHYpID0+IGhhbmRsZUFsbG9jYXRpb25DaGFuZ2UoImNyeXB0byIsIHYpLCBjb2xvcjogQUxMT0NBVElPTl9DT0xPUlNbNF0sIGlucHV0TW9kZSwgZmllbGRLZXk6ICJjcnlwdG8iIH0pLAogICAgICAgIGlucHV0TW9kZSA9PT0gImRvbGxhciIgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQWxsb2NhdGlvblNsaWRlciwgeyBsYWJlbDogIk90aGVyIiwgdmFsdWU6IGFsbG9jYXRpb24ub3RoZXIsIG9uQ2hhbmdlOiAodikgPT4gaGFuZGxlQWxsb2NhdGlvbkNoYW5nZSgib3RoZXIiLCB2KSwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzhdLCBpbnB1dE1vZGUsIGZpZWxkS2V5OiAib3RoZXIiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBbGxvY2F0aW9uU2xpZGVyLCB7IGxhYmVsOiAiQWx0IEludmVzdG1lbnRzIiwgdmFsdWU6IGFsbG9jYXRpb24uYWx0SW52ZXN0bWVudHMsIG9uQ2hhbmdlOiAodikgPT4gaGFuZGxlQWxsb2NhdGlvbkNoYW5nZSgiYWx0SW52ZXN0bWVudHMiLCB2KSwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzZdLCBpbnB1dE1vZGUsIGZpZWxkS2V5OiAiYWx0SW52ZXN0bWVudHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBbGxvY2F0aW9uU2xpZGVyLCB7IGxhYmVsOiAiU3RhcnR1cHMiLCB2YWx1ZTogYWxsb2NhdGlvbi5zdGFydHVwcywgb25DaGFuZ2U6ICh2KSA9PiBoYW5kbGVBbGxvY2F0aW9uQ2hhbmdlKCJzdGFydHVwcyIsIHYpLCBjb2xvcjogQUxMT0NBVElPTl9DT0xPUlNbN10sIGlucHV0TW9kZSwgZmllbGRLZXk6ICJzdGFydHVwcyIgfSkKICAgICAgICBdIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoaW1wb3J0X2pzeF9ydW50aW1lLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFsbG9jYXRpb25TbGlkZXIsIHsgbGFiZWw6ICJBbHQgSW52ZXN0bWVudHMiLCB2YWx1ZTogYWxsb2NhdGlvbi5hbHRJbnZlc3RtZW50cywgb25DaGFuZ2U6ICh2KSA9PiBoYW5kbGVBbGxvY2F0aW9uQ2hhbmdlKCJhbHRJbnZlc3RtZW50cyIsIHYpLCBjb2xvcjogQUxMT0NBVElPTl9DT0xPUlNbNl0sIGlucHV0TW9kZSwgZmllbGRLZXk6ICJhbHRJbnZlc3RtZW50cyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFsbG9jYXRpb25TbGlkZXIsIHsgbGFiZWw6ICJTdGFydHVwcyIsIHZhbHVlOiBhbGxvY2F0aW9uLnN0YXJ0dXBzLCBvbkNoYW5nZTogKHYpID0+IGhhbmRsZUFsbG9jYXRpb25DaGFuZ2UoInN0YXJ0dXBzIiwgdiksIGNvbG9yOiBBTExPQ0FUSU9OX0NPTE9SU1s3XSwgaW5wdXRNb2RlLCBmaWVsZEtleTogInN0YXJ0dXBzIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQWxsb2NhdGlvblNsaWRlciwgeyBsYWJlbDogIk90aGVyIiwgdmFsdWU6IGFsbG9jYXRpb24ub3RoZXIsIG9uQ2hhbmdlOiAodikgPT4gaGFuZGxlQWxsb2NhdGlvbkNoYW5nZSgib3RoZXIiLCB2KSwgY29sb3I6IEFMTE9DQVRJT05fQ09MT1JTWzhdLCBpbnB1dE1vZGUsIGZpZWxkS2V5OiAib3RoZXIiIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBwYWRkaW5nOiAiMTJweCAxNnB4IiwgYmFja2dyb3VuZENvbG9yOiBhbGxvY2F0aW9uVmFsaWQgPyBDT0xPUlMuYWNjZW50TGlnaHQgOiBDT0xPUlMub3JhbmdlTGlnaHQsIGJvcmRlclJhZGl1czogMTIsIG1hcmdpblRvcDogMTYsIG1hcmdpbkJvdHRvbTogMjAgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNjAwLCBjb2xvcjogYWxsb2NhdGlvblZhbGlkID8gQ09MT1JTLnByaW1hcnlEYXJrIDogQ09MT1JTLm9yYW5nZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgIlRvdGFsICIsCiAgICAgICAgICBpbnB1dE1vZGUgPT09ICJwZXJjZW50IiA/ICJBbGxvY2F0aW9uIiA6ICJQb3J0Zm9saW8iCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogODAwLCBmb250U2l6ZTogMTgsIGNvbG9yOiBhbGxvY2F0aW9uVmFsaWQgPyBDT0xPUlMucHJpbWFyeSA6IENPTE9SUy5vcmFuZ2UgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIGlucHV0TW9kZSA9PT0gInBlcmNlbnQiID8gYCR7dG90YWxBbGxvY2F0aW9ufSVgIDogYCQke3RvdGFsQWxsb2NhdGlvbi50b0xvY2FsZVN0cmluZygpfWAsCiAgICAgICAgICBpbnB1dE1vZGUgPT09ICJwZXJjZW50IiAmJiAhYWxsb2NhdGlvblZhbGlkICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNDAwLCBtYXJnaW5MZWZ0OiA4IH0sIGNoaWxkcmVuOiAiKG11c3QgZXF1YWwgMTAwJSkiIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJvdywgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5sYWJlbCwgY2hpbGRyZW46ICJUaW1lIEhvcml6b24iIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN1YmhlYWRlckxhYmVsLCBjaGlsZHJlbjogIlllYXJzIHVudGlsIHlvdSBuZWVkIHRoZSBtb25leSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE51bWJlckNvbnRyb2wsIHsgdmFsdWU6IHRpbWVIb3Jpem9uLCBvbkNoYW5nZTogc2V0VGltZUhvcml6b24sIG1pbjogMSwgbWF4OiA1MCwgc3VmZml4OiAieWVhcnMiIH0pCiAgICAgICAgXSB9KSwKICAgICAgICBpbnB1dE1vZGUgPT09ICJwZXJjZW50IiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5sYWJlbCwgY2hpbGRyZW46ICJJbml0aWFsIEludmVzdG1lbnQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN1YmhlYWRlckxhYmVsLCBjaGlsZHJlbjogIlN0YXJ0aW5nIHBvcnRmb2xpbyB2YWx1ZSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE51bWJlckNvbnRyb2wsIHsgdmFsdWU6IGluaXRpYWxJbnZlc3RtZW50LCBvbkNoYW5nZTogc2V0SW5pdGlhbEludmVzdG1lbnQsIG1pbjogMCwgbWF4OiAxZTgsIHN0ZXA6IDFlMywgcHJlZml4OiAiJCIgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogOCwgY3Vyc29yOiAicG9pbnRlciIsIG1hcmdpblRvcDogMTAsIG1hcmdpbkJvdHRvbTogMTAsIGNvbG9yOiBDT0xPUlMuYmx1ZSwgZm9udFdlaWdodDogNzAwLCBmb250U2l6ZTogMTQgfSwgb25DbGljazogKCkgPT4gc2V0U2hvd0FkdmFuY2VkKCFzaG93QWR2YW5jZWQpLCBjaGlsZHJlbjogWwogICAgICAgIHNob3dBZHZhbmNlZCA/ICJISURFIEFEVkFOQ0VEIE9QVElPTlMiIDogIkFEVkFOQ0VEIE9QVElPTlMiLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hldnJvbkRvd24sIHsgc2l6ZTogMTYsIHN0eWxlOiB7IHRyYW5zZm9ybTogc2hvd0FkdmFuY2VkID8gInJvdGF0ZSgxODBkZWcpIiA6ICJub25lIiwgdHJhbnNpdGlvbjogInRyYW5zZm9ybSAwLjJzIiB9IH0pCiAgICAgIF0gfSksCiAgICAgIHNob3dBZHZhbmNlZCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiQW5udWFsIENvbnRyaWJ1dGlvbiIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3ViaGVhZGVyTGFiZWwsIGNoaWxkcmVuOiAiQW1vdW50IHlvdSBwbGFuIHRvIGFkZCBlYWNoIHllYXIiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShOdW1iZXJDb250cm9sLCB7IHZhbHVlOiBhbm51YWxDb250cmlidXRpb24sIG9uQ2hhbmdlOiBzZXRBbm51YWxDb250cmlidXRpb24sIG1pbjogMCwgbWF4OiAxZTYsIHN0ZXA6IDUwMCwgcHJlZml4OiAiJCIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIkludmVzdG1lbnQgR29hbCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKGludmVzdG1lbnRHb2FsID09PSAicHJlc2VydmF0aW9uIiksIG9uQ2xpY2s6ICgpID0+IHNldEludmVzdG1lbnRHb2FsKCJwcmVzZXJ2YXRpb24iKSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiUHJlc2VydmF0aW9uIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgZm9udFdlaWdodDogNDAwLCBtYXJnaW5Ub3A6IDIgfSwgY2hpbGRyZW46ICJQcm90ZWN0IGNhcGl0YWwiIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3RyYXRlZ3lCdG4oaW52ZXN0bWVudEdvYWwgPT09ICJpbmNvbWUiKSwgb25DbGljazogKCkgPT4gc2V0SW52ZXN0bWVudEdvYWwoImluY29tZSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgY2hpbGRyZW46ICJJbmNvbWUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIlN0ZWFkeSByZXR1cm5zIiB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKGludmVzdG1lbnRHb2FsID09PSAiZ3Jvd3RoIiksIG9uQ2xpY2s6ICgpID0+IHNldEludmVzdG1lbnRHb2FsKCJncm93dGgiKSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiR3Jvd3RoIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgZm9udFdlaWdodDogNDAwLCBtYXJnaW5Ub3A6IDIgfSwgY2hpbGRyZW46ICJNYXhpbWl6ZSB2YWx1ZSIgfSkKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTIsIG1hcmdpblRvcDogMjAgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwgc3R5bGU6IHsgLi4uc3R5bGVzLmNhbGNCdXR0b24sIG9wYWNpdHk6IGFsbG9jYXRpb25WYWxpZCA/IDEgOiAwLjUgfSwgb25DbGljazogcnVuU2ltdWxhdGlvbiwgZGlzYWJsZWQ6ICFhbGxvY2F0aW9uVmFsaWQgfHwgaXNTaW11bGF0aW5nLCBjaGlsZHJlbjogaXNTaW11bGF0aW5nID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShMb2FkZXIsIHsgc2l6ZTogMjAsIGNsYXNzTmFtZTogInNwaW4iIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoaW1wb3J0X2pzeF9ydW50aW1lLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgIlJ1biBTaW11bGF0aW9uICIsCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQbGF5LCB7IHNpemU6IDIwLCBmaWxsOiAid2hpdGUiIH0pCiAgICAgIF0gfSkgfSkgfSkKICAgIF0gfSksCiAgICBzaW11bGF0aW9uUmVzdWx0ICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMucmVzdWx0Q2FyZCwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206ICIyMHB4IiwgYm9yZGVyQm90dG9tOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBwYWRkaW5nQm90dG9tOiAiMTZweCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMThweCIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIlNpbXVsYXRpb24gUmVzdWx0cyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShJbmZvVG9vbHRpcCwgeyB0ZXh0OiAiQmFzZWQgb24gNTAwIE1vbnRlIENhcmxvIHNpbXVsYXRpb25zLiAnRXhwZWN0ZWQnIGlzIHRoZSBhdmVyYWdlIG91dGNvbWUuICdQb3NzaWJsZSBSYW5nZScgc2hvd3MgdGhlIDEwdGggKFdvcnN0IENhc2UpIHRvIDkwdGggKEJlc3QgQ2FzZSkgcGVyY2VudGlsZSBvdXRjb21lcy4gVm9sYXRpbGl0eSBjYWxjdWxhdGlvbnMgYXNzdW1lIG1vZGVyYXRlIGNvcnJlbGF0aW9uIGJldHdlZW4gYXNzZXQgY2xhc3Nlcy4iLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaXJjbGVRdWVzdGlvbk1hcmssIHsgc2l6ZTogMTYsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgc3R5bGU6IHsgY3Vyc29yOiAicG9pbnRlciIgfSB9KSB9KQogICAgICBdIH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIG1hcmdpbkJvdHRvbTogMjQsIGdhcDogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgbWFyZ2luQm90dG9tOiA0IH0sIGNoaWxkcmVuOiAiRXhwZWN0ZWQgVmFsdWUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMucHJpbWFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAiJCIsCiAgICAgICAgICAgIE1hdGgucm91bmQoc2ltdWxhdGlvblJlc3VsdC5zdGF0cy5maW5hbEV4cGVjdGVkKS50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAiTWVkaWFuOiAkIiwKICAgICAgICAgICAgTWF0aC5yb3VuZChzaW11bGF0aW9uUmVzdWx0LnN0YXRzLmZpbmFsTWVkaWFuKS50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxLCBib3JkZXJMZWZ0OiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBwYWRkaW5nTGVmdDogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46ICJQb3NzaWJsZSBSYW5nZSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAiJCIsCiAgICAgICAgICAgIE1hdGgucm91bmQoc2ltdWxhdGlvblJlc3VsdC5zdGF0cy5maW5hbFAxMCkudG9Mb2NhbGVTdHJpbmcoKSwKICAgICAgICAgICAgIiAtICQiLAogICAgICAgICAgICBNYXRoLnJvdW5kKHNpbXVsYXRpb25SZXN1bHQuc3RhdHMuZmluYWxQOTApLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Ub3A6IDQgfSwgY2hpbGRyZW46ICIxMHRoIHRvIDkwdGggcGVyY2VudGlsZSIgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYm9yZGVyQm90dG9tOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBtYXJnaW5Cb3R0b206IDI0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE2cHgiLCBib3JkZXJCb3R0b206IHJlc3VsdFZpZXcgPT09ICJwcm9qZWN0aW9uIiA/IGAycHggc29saWQgJHtDT0xPUlMucHJpbWFyeX1gIDogIm5vbmUiLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiByZXN1bHRWaWV3ID09PSAicHJvamVjdGlvbiIgPyBDT0xPUlMucHJpbWFyeSA6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBjdXJzb3I6ICJwb2ludGVyIiwgZm9udFNpemU6IDEyLCBsZXR0ZXJTcGFjaW5nOiAxIH0sIG9uQ2xpY2s6ICgpID0+IHNldFJlc3VsdFZpZXcoInByb2plY3Rpb24iKSwgY2hpbGRyZW46ICJQUk9KRUNUSU9OIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlckJvdHRvbTogcmVzdWx0VmlldyA9PT0gImFsbG9jYXRpb24iID8gYDJweCBzb2xpZCAke0NPTE9SUy5wcmltYXJ5fWAgOiAibm9uZSIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IHJlc3VsdFZpZXcgPT09ICJhbGxvY2F0aW9uIiA/IENPTE9SUy5wcmltYXJ5IDogQ09MT1JTLnRleHRTZWNvbmRhcnksIGN1cnNvcjogInBvaW50ZXIiLCBmb250U2l6ZTogMTIsIGxldHRlclNwYWNpbmc6IDEgfSwgb25DbGljazogKCkgPT4gc2V0UmVzdWx0VmlldygiYWxsb2NhdGlvbiIpLCBjaGlsZHJlbjogIkFMTE9DQVRJT04iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyQm90dG9tOiByZXN1bHRWaWV3ID09PSAic3VtbWFyeSIgPyBgMnB4IHNvbGlkICR7Q09MT1JTLnByaW1hcnl9YCA6ICJub25lIiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogcmVzdWx0VmlldyA9PT0gInN1bW1hcnkiID8gQ09MT1JTLnByaW1hcnkgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgY3Vyc29yOiAicG9pbnRlciIsIGZvbnRTaXplOiAxMiwgbGV0dGVyU3BhY2luZzogMSB9LCBvbkNsaWNrOiAoKSA9PiBzZXRSZXN1bHRWaWV3KCJzdW1tYXJ5IiksIGNoaWxkcmVuOiAiU1VNTUFSWSIgfSkKICAgICAgXSB9KSwKICAgICAgcmVzdWx0VmlldyA9PT0gInByb2plY3Rpb24iICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGhlaWdodDogMzAwLCB3aWR0aDogIjEwMCUiLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlc3BvbnNpdmVDb250YWluZXIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKEFyZWFDaGFydCwgeyBkYXRhOiBzaW11bGF0aW9uUmVzdWx0LnJlc3VsdHMsIG1hcmdpbjogeyB0b3A6IDEwLCByaWdodDogMTAsIGxlZnQ6IC0yMCwgYm90dG9tOiAwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkZWZzIiwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImxpbmVhckdyYWRpZW50IiwgeyBpZDogImNvbG9yUDkwIiwgeDE6ICIwIiwgeTE6ICIwIiwgeDI6ICIwIiwgeTI6ICIxIiwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiNSUiLCBzdG9wQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBzdG9wT3BhY2l0eTogMC4xIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI5NSUiLCBzdG9wQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBzdG9wT3BhY2l0eTogMCB9KQogICAgICAgICAgXSB9KSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2FydGVzaWFuR3JpZCwgeyBzdHJva2VEYXNoYXJyYXk6ICIzIDMiLCB2ZXJ0aWNhbDogZmFsc2UsIHN0cm9rZTogQ09MT1JTLmJvcmRlciB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoWEF4aXMsIHsgZGF0YUtleTogInllYXIiLCB0aWNrOiB7IGZpbGw6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIHRpY2tMaW5lOiBmYWxzZSwgYXhpc0xpbmU6IHsgc3Ryb2tlOiBDT0xPUlMuYm9yZGVyIH0sIHRpY2tGb3JtYXR0ZXI6ICh2YWwpID0+IGBZciAke3ZhbH1gIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShZQXhpcywgeyB0aWNrOiB7IGZpbGw6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIHRpY2tGb3JtYXR0ZXI6ICh2YWwpID0+IHZhbCA+PSAxZTYgPyBgJCR7KHZhbCAvIDFlNikudG9GaXhlZCgxKX1NYCA6IGAkJHsodmFsIC8gMWUzKS50b0ZpeGVkKDApfUtgLCB0aWNrTGluZTogZmFsc2UsIGF4aXNMaW5lOiBmYWxzZSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVG9vbHRpcCwgeyBjb250ZW50OiAoeyBhY3RpdmUsIHBheWxvYWQsIGxhYmVsIH0pID0+IHsKICAgICAgICAgICAgaWYgKGFjdGl2ZSAmJiBwYXlsb2FkICYmIHBheWxvYWQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHBheWxvYWRbMF0ucGF5bG9hZDsKICAgICAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiA4LCBib3hTaGFkb3c6ICIwIDRweCAxMnB4IHJnYmEoMCwwLDAsMC4xKSIsIGJvcmRlcjogIjFweCBzb2xpZCAjRTVFN0VCIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNjAwLCBtYXJnaW5Cb3R0b206IDgsIGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICJZZWFyICIsCiAgICAgICAgICAgICAgICAgIGxhYmVsCiAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMucHJpbWFyeSwgZm9udFdlaWdodDogNjAwLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46ICJCZXN0IENhc2U6IiB9KSwKICAgICAgICAgICAgICAgICAgIiAiLAogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgICAgIGRhdGEucDkwLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLmJsdWUsIGZvbnRXZWlnaHQ6IDYwMCwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiAiTWVkaWFuOiIgfSksCiAgICAgICAgICAgICAgICAgICIgIiwKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgICAgICBkYXRhLm1lZGlhbi50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnJlZCwgZm9udFdlaWdodDogNjAwLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46ICJXb3JzdCBDYXNlOiIgfSksCiAgICAgICAgICAgICAgICAgICIgIiwKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgICAgICBkYXRhLnAxMC50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICBdIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAicDkwIiwgc3Ryb2tlOiBDT0xPUlMucHJpbWFyeSwgc3Ryb2tlRGFzaGFycmF5OiAiMyAzIiwgc3Ryb2tlV2lkdGg6IDEsIGZpbGw6ICJ1cmwoI2NvbG9yUDkwKSIsIG5hbWU6ICI5MHRoIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAicDEwIiwgc3Ryb2tlOiBDT0xPUlMucmVkLCBzdHJva2VEYXNoYXJyYXk6ICIzIDMiLCBmaWxsOiAidHJhbnNwYXJlbnQiLCBzdHJva2VXaWR0aDogMSwgbmFtZTogIjEwdGgiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBcmVhLCB7IHR5cGU6ICJtb25vdG9uZSIsIGRhdGFLZXk6ICJtZWRpYW4iLCBzdHJva2U6IENPTE9SUy5ibHVlLCBmaWxsOiAidHJhbnNwYXJlbnQiLCBzdHJva2VXaWR0aDogMiwgbmFtZTogIk1lZGlhbiIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFyZWEsIHsgdHlwZTogIm1vbm90b25lIiwgZGF0YUtleTogImV4cGVjdGVkIiwgc3Ryb2tlOiBDT0xPUlMucHJpbWFyeSwgZmlsbDogInRyYW5zcGFyZW50Iiwgc3Ryb2tlV2lkdGg6IDIsIG5hbWU6ICJFeHBlY3RlZCIgfSkKICAgICAgICBdIH0pIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCBnYXA6IDE2LCBtYXJnaW5Ub3A6IDgsIGZsZXhXcmFwOiAid3JhcCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAxMiwgaGVpZ2h0OiAyLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5IH0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDExIH0sIGNoaWxkcmVuOiAiRXhwZWN0ZWQiIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDEyLCBoZWlnaHQ6IDIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksIGJvcmRlclN0eWxlOiAiZGFzaGVkIiB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMSB9LCBjaGlsZHJlbjogIkJlc3QgQ2FzZSIgfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogMTIsIGhlaWdodDogMiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYmx1ZSB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMSB9LCBjaGlsZHJlbjogIk1lZGlhbiIgfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogMTIsIGhlaWdodDogMiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucmVkLCBib3JkZXJTdHlsZTogImRhc2hlZCIgfSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTEgfSwgY2hpbGRyZW46ICJXb3JzdCBDYXNlIiB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgcmVzdWx0VmlldyA9PT0gImFsbG9jYXRpb24iICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgcGFkZGluZzogIjAgMTZweCIsIG1hcmdpbkJvdHRvbTogMjQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMS4yIH0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxLCBkaXNwbGF5OiAiZmxleCIsIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIkN1cnJlbnQiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAxMjAsIGhlaWdodDogMTIwIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlc3BvbnNpdmVDb250YWluZXIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGllQ2hhcnQsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGllLCB7IGRhdGE6IHBpZURhdGEsIGN4OiAiNTAlIiwgY3k6ICI1MCUiLCBpbm5lclJhZGl1czogMzAsIG91dGVyUmFkaXVzOiA1MCwgZGF0YUtleTogInZhbHVlIiwgc3Ryb2tlOiAibm9uZSIsIGNoaWxkcmVuOiBwaWVEYXRhLm1hcCgoZW50cnksIGluZGV4KSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENlbGwsIHsgZmlsbDogZW50cnkuY29sb3IgfSwgYGNlbGwtJHtpbmRleH1gKSkgfSkgfSkgfSkgfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiA0MCwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJyb3dSaWdodCwgeyBzaXplOiAyMCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBzdHJva2VXaWR0aDogMi41IH0pIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgZGlzcGxheTogImZsZXgiLCBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJPcHRpbWl6ZWQiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAxMjAsIGhlaWdodDogMTIwIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlc3BvbnNpdmVDb250YWluZXIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGllQ2hhcnQsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGllLCB7IGRhdGE6IHN1Z2dlc3RlZFBpZURhdGEsIGN4OiAiNTAlIiwgY3k6ICI1MCUiLCBpbm5lclJhZGl1czogMzAsIG91dGVyUmFkaXVzOiA1MCwgZGF0YUtleTogInZhbHVlIiwgc3Ryb2tlOiAibm9uZSIsIGNoaWxkcmVuOiBzdWdnZXN0ZWRQaWVEYXRhLm1hcCgoZW50cnksIGluZGV4KSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENlbGwsIHsgZmlsbDogZW50cnkuY29sb3IgfSwgYGNlbGwtJHtpbmRleH1gKSkgfSkgfSkgfSkgfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIGJvcmRlclJhZGl1czogMTIsIG92ZXJmbG93OiAiaGlkZGVuIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBwYWRkaW5nOiAiMTJweCAxNnB4IiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgYm9yZGVyQm90dG9tOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMS4yIH0sIGNoaWxkcmVuOiAiQXNzZXQgQ2xhc3MiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46ICJZb3VyIEFsbG9jYXRpb24iIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiA0MCB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46ICJJZGVhbCBBbGxvY2F0aW9uIiB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjAgMTZweCIgfSwgY2hpbGRyZW46IHN1Z2dlc3RlZFBpZURhdGEubWFwKChpdGVtLCBpZHgpID0+IHsKICAgICAgICAgICAgY29uc3QgdXNlckl0ZW0gPSBwaWVEYXRhLmZpbmQoKHApID0+IHAubmFtZSA9PT0gaXRlbS5uYW1lKTsKICAgICAgICAgICAgY29uc3QgdXNlclZhbHVlID0gdXNlckl0ZW0gPyB1c2VySXRlbS52YWx1ZSA6IDA7CiAgICAgICAgICAgIGNvbnN0IHVzZXJUb3RhbCA9IGlucHV0TW9kZSA9PT0gImRvbGxhciIgPyB0b3RhbEFsbG9jYXRpb24gOiAxMDA7CiAgICAgICAgICAgIGNvbnN0IHVzZXJQY3QgPSBpbnB1dE1vZGUgPT09ICJkb2xsYXIiICYmIHVzZXJUb3RhbCA+IDAgPyB1c2VyVmFsdWUgLyB1c2VyVG90YWwgKiAxMDAgOiB1c2VyVmFsdWU7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldFBjdCA9IGl0ZW0udmFsdWU7CiAgICAgICAgICAgIGNvbnN0IGRpZmYgPSB0YXJnZXRQY3QgLSB1c2VyUGN0OwogICAgICAgICAgICBjb25zdCBpc0RpZmYgPSBNYXRoLmFicyhkaWZmKSA+PSAxOwogICAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgcGFkZGluZzogIjEycHggMCIsIGJvcmRlckJvdHRvbTogaWR4ID09PSBzdWdnZXN0ZWRQaWVEYXRhLmxlbmd0aCAtIDEgPyAibm9uZSIgOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMS4yLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDEwLCBoZWlnaHQ6IDEwLCBib3JkZXJSYWRpdXM6IDMsIGJhY2tncm91bmRDb2xvcjogaXRlbS5jb2xvciwgZmxleFNocmluazogMCB9IH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IGl0ZW0ubmFtZSB9KQogICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxLCB0ZXh0QWxpZ246ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIE1hdGgucm91bmQodXNlclBjdCksCiAgICAgICAgICAgICAgICAiJSIKICAgICAgICAgICAgICBdIH0pIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDQwLCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiB9LCBjaGlsZHJlbjogaXNEaWZmICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJyb3dSaWdodCwgeyBzaXplOiAxNiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBzdHJva2VXaWR0aDogMi41IH0pIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgdGV4dEFsaWduOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNzAwLCBjb2xvcjogaXNEaWZmID8gQ09MT1JTLnByaW1hcnkgOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIHRhcmdldFBjdCwKICAgICAgICAgICAgICAgICIlIgogICAgICAgICAgICAgIF0gfSkgfSkKICAgICAgICAgICAgXSB9LCBpZHgpOwogICAgICAgICAgfSkgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMTYsIHBhZGRpbmc6IDEyLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBib3JkZXJSYWRpdXM6IDEyLCBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbGluZUhlaWdodDogMS41IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46ICJOb3RlOiIgfSksCiAgICAgICAgICAnICJJZGVhbCBBbGxvY2F0aW9uIiBpcyBkZXJpdmVkIGZyb20gTW9kZXJuIFBvcnRmb2xpbyBUaGVvcnkgKE1QVCkgYW5kIGhpc3RvcmljYWwgbWFya2V0IGRhdGEsIHRhaWxvcmVkIHRvIHlvdXIgZ29hbCAoJywKICAgICAgICAgIGludmVzdG1lbnRHb2FsLAogICAgICAgICAgIikgYW5kIHRpbWUgaG9yaXpvbiAoIiwKICAgICAgICAgIHRpbWVIb3Jpem9uLAogICAgICAgICAgIiB5ZWFycykuIFRoaXMgaXMgYSBnZW5lcmFsIGd1aWRlbGluZSwgbm90IHBlcnNvbmFsaXplZCBmaW5hbmNpYWwgYWR2aWNlLiIKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIHJlc3VsdFZpZXcgPT09ICJzdW1tYXJ5IiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBwYWRkaW5nOiAxNiwgYm9yZGVyUmFkaXVzOiAxNiwgZm9udFNpemU6IDE0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAyMCwgYm9yZGVyQm90dG9tOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBwYWRkaW5nQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIGZvbnRTaXplOiAxNiB9LCBjaGlsZHJlbjogIlBvcnRmb2xpbyBTdGF0aXN0aWNzIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJCYXNlZCBvbiA1MDAgTW9udGUgQ2FybG8gc2ltdWxhdGlvbnMiIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIgMWZyIiwgZ2FwOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBwYWRkaW5nOiAxNiwgYm9yZGVyUmFkaXVzOiAxMiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogIkV4cGVjdGVkIEFubnVhbCBSZXR1cm4iIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjQsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IENPTE9SUy5wcmltYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgKHNpbXVsYXRpb25SZXN1bHQuc3RhdHMuZXhwZWN0ZWRSZXR1cm4gKiAxMDApLnRvRml4ZWQoMSksCiAgICAgICAgICAgICAgIiUiCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIHBhZGRpbmc6IDE2LCBib3JkZXJSYWRpdXM6IDEyLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luQm90dG9tOiA0IH0sIGNoaWxkcmVuOiAiVm9sYXRpbGl0eSAoU3RkIERldikiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjQsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IENPTE9SUy5vcmFuZ2UgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAoc2ltdWxhdGlvblJlc3VsdC5zdGF0cy52b2xhdGlsaXR5ICogMTAwKS50b0ZpeGVkKDEpLAogICAgICAgICAgICAgICIlIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBwYWRkaW5nOiAxNiwgYm9yZGVyUmFkaXVzOiAxMiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogIlNoYXJwZSBSYXRpbyIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI0LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMuYmx1ZSB9LCBjaGlsZHJlbjogc2ltdWxhdGlvblJlc3VsdC5zdGF0cy5zaGFycGVSYXRpby50b0ZpeGVkKDIpIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiUmlzay1hZGp1c3RlZCByZXR1cm4iIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBwYWRkaW5nOiAxNiwgYm9yZGVyUmFkaXVzOiAxMiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogIk1heCBEcmF3ZG93biIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyNCwgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTLnJlZCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICItIiwKICAgICAgICAgICAgICAoc2ltdWxhdGlvblJlc3VsdC5zdGF0cy5tYXhEcmF3ZG93biAqIDEwMCkudG9GaXhlZCgwKSwKICAgICAgICAgICAgICAiJSIKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIldvcnN0IHBlYWstdG8tdHJvdWdoIiB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAyNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBmb250U2l6ZTogMTQsIG1hcmdpbkJvdHRvbTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIlBvc3NpYmxlIE91dGNvbWVzIEFmdGVyICIsCiAgICAgICAgICAgIHRpbWVIb3Jpem9uLAogICAgICAgICAgICAiIFllYXJzIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgYm9yZGVyUmFkaXVzOiAxMiwgb3ZlcmZsb3c6ICJoaWRkZW4iLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsIHBhZGRpbmc6ICIxMnB4IDE2cHgiLCBmb250V2VpZ2h0OiA3MDAsIGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBjaGlsZHJlbjogIlNjZW5hcmlvIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogInJpZ2h0IiB9LCBjaGlsZHJlbjogIlBvcnRmb2xpbyBWYWx1ZSIgfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIHBhZGRpbmc6ICIxMnB4IDE2cHgiLCBib3JkZXJCb3R0b206IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMucHJpbWFyeSwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiQmVzdCBDYXNlICg5MHRoKSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAicmlnaHQiLCBmb250V2VpZ2h0OiA3MDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgIE1hdGgucm91bmQoc2ltdWxhdGlvblJlc3VsdC5zdGF0cy5maW5hbFA5MCkudG9Mb2NhbGVTdHJpbmcoKQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIHBhZGRpbmc6ICIxMnB4IDE2cHgiLCBib3JkZXJCb3R0b206IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMuYmx1ZSwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiTWVkaWFuIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB0ZXh0QWxpZ246ICJyaWdodCIsIGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgTWF0aC5yb3VuZChzaW11bGF0aW9uUmVzdWx0LnN0YXRzLmZpbmFsTWVkaWFuKS50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIgMWZyIiwgcGFkZGluZzogIjEycHggMTZweCIsIGJvcmRlckJvdHRvbTogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5vcmFuZ2UsIGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogIkV4cGVjdGVkIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB0ZXh0QWxpZ246ICJyaWdodCIsIGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgTWF0aC5yb3VuZChzaW11bGF0aW9uUmVzdWx0LnN0YXRzLmZpbmFsRXhwZWN0ZWQpLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBwYWRkaW5nOiAiMTJweCAxNnB4IiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5yZWQsIGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogIldvcnN0IENhc2UgKDEwdGgpIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB0ZXh0QWxpZ246ICJyaWdodCIsIGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgTWF0aC5yb3VuZChzaW11bGF0aW9uUmVzdWx0LnN0YXRzLmZpbmFsUDEwKS50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDI0LCBwYWRkaW5nOiAxNiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBib3JkZXJSYWRpdXM6IDEyLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgZm9udFNpemU6IDE0LCBtYXJnaW5Cb3R0b206IDgsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENpcmNsZVF1ZXN0aW9uTWFyaywgeyBzaXplOiAxNiwgY29sb3I6IENPTE9SUy5ibHVlIH0pLAogICAgICAgICAgICAiV2hhdCBUaGlzIE1lYW5zIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBsaW5lSGVpZ2h0OiAxLjcgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIkJhc2VkIG9uIHlvdXIgaW5wdXRzLCBpZiB5b3UgaW52ZXN0ICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgaW5wdXRNb2RlID09PSAiZG9sbGFyIiA/IHRvdGFsQWxsb2NhdGlvbi50b0xvY2FsZVN0cmluZygpIDogcGFyc2VJbnQoaW5pdGlhbEludmVzdG1lbnQpLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgIiB0b2RheSBhbmQgY29udHJpYnV0ZSAiLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3Ryb25nIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgIHBhcnNlSW50KGFubnVhbENvbnRyaWJ1dGlvbikudG9Mb2NhbGVTdHJpbmcoKSwKICAgICAgICAgICAgICAiL3llYXIiCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICIsIHlvdXIgcG9ydGZvbGlvICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImVtIiwgeyBjaGlsZHJlbjogIm1pZ2h0IiB9KSwKICAgICAgICAgICAgIiBncm93IHRvIGFwcHJveGltYXRlbHkgIiwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInN0cm9uZyIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5wcmltYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgIE1hdGgucm91bmQoc2ltdWxhdGlvblJlc3VsdC5zdGF0cy5maW5hbEV4cGVjdGVkKS50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICIgb3ZlciAiLAogICAgICAgICAgICB0aW1lSG9yaXpvbiwKICAgICAgICAgICAgIiB5ZWFycy4gRHVlIHRvIG1hcmtldCB2b2xhdGlsaXR5LCBhY3R1YWwgcmVzdWx0cyBjb3VsZCByYW5nZSBmcm9tICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMucmVkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgIE1hdGgucm91bmQoc2ltdWxhdGlvblJlc3VsdC5zdGF0cy5maW5hbFAxMCkudG9Mb2NhbGVTdHJpbmcoKQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAiIHRvICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMucHJpbWFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICBNYXRoLnJvdW5kKHNpbXVsYXRpb25SZXN1bHQuc3RhdHMuZmluYWxQOTApLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgIi4iCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMub3JhbmdlTGlnaHQsIGJvcmRlclJhZGl1czogIjE2cHgiLCBwYWRkaW5nOiAiMTZweCIsIG1hcmdpblRvcDogIjI0cHgiLCBkaXNwbGF5OiAiZmxleCIsIGdhcDogIjEycHgiLCBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShJbmZvLCB7IHNpemU6IDIwLCBjb2xvcjogQ09MT1JTLm9yYW5nZSwgc3R5bGU6IHsgZmxleFNocmluazogMCwgbWFyZ2luVG9wOiAyIH0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMTJweCIsIGNvbG9yOiBDT0xPUlMub3JhbmdlLCBsaW5lSGVpZ2h0OiAxLjYgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IGNoaWxkcmVuOiAiSW1wb3J0YW50IERpc2NsYWltZXI6IiB9KSwKICAgICAgICAiIFRoaXMgc2ltdWxhdGlvbiBpcyBmb3IgZWR1Y2F0aW9uYWwgcHVycG9zZXMgb25seSBhbmQgZG9lcyBub3QgY29uc3RpdHV0ZSBmaW5hbmNpYWwgYWR2aWNlLiBSZXN1bHRzIGFyZSBoeXBvdGhldGljYWwgcHJvamVjdGlvbnMgYmFzZWQgb24gaGlzdG9yaWNhbCByZXR1cm4gYXNzdW1wdGlvbnMuIEFjdHVhbCBtYXJrZXQgcGVyZm9ybWFuY2UgdmFyaWVzIHNpZ25pZmljYW50bHksIHBhc3QgcGVyZm9ybWFuY2UgZG9lcyBub3QgZ3VhcmFudGVlIGZ1dHVyZSByZXN1bHRzLCBhbmQgeW91IG1heSBsb3NlIG1vbmV5LiBDb25zdWx0IGEgbGljZW5zZWQgZmluYW5jaWFsIGFkdmlzb3IgYmVmb3JlIG1ha2luZyBpbnZlc3RtZW50IGRlY2lzaW9ucy4iCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgIHBhZGRpbmc6ICIyMHB4IiwKICAgICAgYm9yZGVyUmFkaXVzOiAiMjRweCIsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDEycHggLTRweCByZ2JhKDAsMCwwLDAuMDUpIiwKICAgICAgbWFyZ2luQm90dG9tOiAiMjBweCIsCiAgICAgIG1hcmdpblRvcDogIjI0cHgiCiAgICB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgZm9udFNpemU6ICIxNHB4IiwKICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICAgIG1hcmdpbkJvdHRvbTogIjEycHgiLAogICAgICAgIHRleHRBbGlnbjogImNlbnRlciIKICAgICAgfSwgY2hpbGRyZW46ICJSZWxhdGVkIENhbGN1bGF0b3JzIiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgZmxleERpcmVjdGlvbjogImNvbHVtbiIsCiAgICAgICAgZ2FwOiAiOHB4IiwKICAgICAgICB3aWR0aDogIjEwMCUiCiAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6ICI4cHgiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJhIiwgeyBocmVmOiAiLyIsIHN0eWxlOiB7IHRleHREZWNvcmF0aW9uOiAibm9uZSIsIGZsZXg6IDEgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsCiAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAiMTJweCAxMHB4IiwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsCiAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICIxMHB4IiwKICAgICAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAiMTRweCIsCiAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgZ2FwOiAiNnB4IgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUVudGVyOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUy5hY2NlbnRMaWdodDsKICAgICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5ib3JkZXJDb2xvciA9IENPTE9SUy5wcmltYXJ5OwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUy5pbnB1dEJnOwogICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJvcmRlckNvbG9yID0gQ09MT1JTLmJvcmRlcjsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRyZW5kaW5nVXAsIHsgc2l6ZTogMTYgfSksCiAgICAgICAgICAgICAgICAiUG9ydGZvbGlvIE9wdGltaXplciIKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0KICAgICAgICAgICkgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJhIiwgeyBocmVmOiAiLyIsIHN0eWxlOiB7IHRleHREZWNvcmF0aW9uOiAibm9uZSIsIGZsZXg6IDEgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsCiAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAiMTJweCAxMHB4IiwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsCiAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6ICIxMHB4IiwKICAgICAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAiMTRweCIsCiAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgZ2FwOiAiNnB4IgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUVudGVyOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUy5hY2NlbnRMaWdodDsKICAgICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5ib3JkZXJDb2xvciA9IENPTE9SUy5wcmltYXJ5OwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUy5pbnB1dEJnOwogICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJvcmRlckNvbG9yID0gQ09MT1JTLmJvcmRlcjsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRhcmdldCwgeyBzaXplOiAxNiB9KSwKICAgICAgICAgICAgICAgICJNb3J0Z2FnZSBDYWxjdWxhdG9yIgogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfQogICAgICAgICAgKSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwKICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICBmbGV4OiAiMCAxIDUwJSIsCiAgICAgICAgICAgICAgcGFkZGluZzogIjEycHggMTBweCIsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAiMTBweCIsCiAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICBmb250U2l6ZTogIjE0cHgiLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICAgICAgZ2FwOiAiNnB4IgogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hlY2ssIHsgc2l6ZTogMTYgfSksCiAgICAgICAgICAgICAgIlBvcnRmb2xpbyBBbmFseXplciIKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICkgfSkKICAgICAgXSB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuZm9vdGVyLCBjbGFzc05hbWU6ICJuby1wcmludCIsIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMuZm9vdGVyQnRuLCBvbkNsaWNrOiAoKSA9PiBzZXRTaG93U3Vic2NyaWJlTW9kYWwodHJ1ZSksIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShNYWlsLCB7IHNpemU6IDE2IH0pLAogICAgICAgICIgU3Vic2NyaWJlIgogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLmZvb3RlckJ0biwgb25DbGljazogcmVzZXRUb0RlZmF1bHRzLCBjbGFzc05hbWU6ICJidG4tcHJlc3MiLCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUm90YXRlQ2N3LCB7IHNpemU6IDE2IH0pLAogICAgICAgICIgUmVzZXQiCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMuZm9vdGVyQnRuLCBjbGFzc05hbWU6ICJidG4tcHJlc3MiLCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoSGVhcnQsIHsgc2l6ZTogMTYgfSksCiAgICAgICAgIiBEb25hdGUiCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMuZm9vdGVyQnRuLCBvbkNsaWNrOiAoKSA9PiBzZXRTaG93RmVlZGJhY2tNb2RhbCh0cnVlKSwgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1lc3NhZ2VTcXVhcmUsIHsgc2l6ZTogMTYgfSksCiAgICAgICAgIiBGZWVkYmFjayIKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImJ1dHRvbiIsIHsgc3R5bGU6IHN0eWxlcy5mb290ZXJCdG4sIG9uQ2xpY2s6ICgpID0+IHdpbmRvdy5wcmludCgpLCBjbGFzc05hbWU6ICJidG4tcHJlc3MiLCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUHJpbnRlciwgeyBzaXplOiAxNiB9KSwKICAgICAgICAiIFByaW50IgogICAgICBdIH0pCiAgICBdIH0pLAogICAgc2hvd0ZlZWRiYWNrTW9kYWwgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsT3ZlcmxheSwgb25DbGljazogKCkgPT4gc2V0U2hvd0ZlZWRiYWNrTW9kYWwoZmFsc2UpLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5tb2RhbENvbnRlbnQsIG9uQ2xpY2s6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMubW9kYWxDbG9zZSwgb25DbGljazogKCkgPT4gc2V0U2hvd0ZlZWRiYWNrTW9kYWwoZmFsc2UpLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShYLCB7IHNpemU6IDIwIH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMjRweCIsIGZvbnRXZWlnaHQ6IDgwMCwgbWFyZ2luQm90dG9tOiAiOHB4IiwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIkZlZWRiYWNrIiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjE0cHgiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogIjI0cHgiIH0sIGNoaWxkcmVuOiAiSGVscCB1cyBpbXByb3ZlIHRoZSBjYWxjdWxhdG9yLiIgfSksCiAgICAgIGZlZWRiYWNrU3RhdHVzID09PSAic3VjY2VzcyIgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogImNlbnRlciIsIHBhZGRpbmc6ICIyMHB4IiwgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250V2VpZ2h0OiA2MDAgfSwgY2hpbGRyZW46ICJUaGFua3MgZm9yIHlvdXIgZmVlZGJhY2shIiB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZS5GcmFnbWVudCwgeyBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAidGV4dGFyZWEiLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyAuLi5zdHlsZXMuaW5wdXQsIGhlaWdodDogIjEyMHB4IiwgcmVzaXplOiAibm9uZSIsIGZvbnRGYW1pbHk6ICJpbmhlcml0IiB9LAogICAgICAgICAgICBwbGFjZWhvbGRlcjogIlRlbGwgdXMgd2hhdCB5b3UgdGhpbmsuLi4iLAogICAgICAgICAgICB2YWx1ZTogZmVlZGJhY2tUZXh0LAogICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEZlZWRiYWNrVGV4dChlLnRhcmdldC52YWx1ZSkKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIGZlZWRiYWNrU3RhdHVzID09PSAiZXJyb3IiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5yZWQsIGZvbnRTaXplOiAiMTRweCIsIG1hcmdpbkJvdHRvbTogIjEwcHgiIH0sIGNoaWxkcmVuOiAiRmFpbGVkIHRvIHNlbmQuIFBsZWFzZSB0cnkgYWdhaW4uIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IC4uLnN0eWxlcy5jYWxjQnV0dG9uLCB3aWR0aDogIjEwMCUiIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IGhhbmRsZUZlZWRiYWNrU3VibWl0LAogICAgICAgICAgICBkaXNhYmxlZDogZmVlZGJhY2tTdGF0dXMgPT09ICJzdWJtaXR0aW5nIiB8fCAhZmVlZGJhY2tUZXh0LnRyaW0oKSwKICAgICAgICAgICAgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwKICAgICAgICAgICAgY2hpbGRyZW46IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgPyAiU2VuZGluZy4uLiIgOiAiU2VuZCBGZWVkYmFjayIKICAgICAgICAgIH0KICAgICAgICApCiAgICAgIF0gfSkKICAgIF0gfSkgfSksCiAgICBzaG93U3Vic2NyaWJlTW9kYWwgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsT3ZlcmxheSwgb25DbGljazogKCkgPT4gc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubW9kYWxDb250ZW50LCBvbkNsaWNrOiAoZSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ2xvc2UsIG9uQ2xpY2s6ICgpID0+IHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSksIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFgsIHsgc2l6ZTogMjAgfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6ICIyNHB4IiwgZm9udFdlaWdodDogODAwLCBtYXJnaW5Cb3R0b206ICI4cHgiLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiU2lnbiBVcCBGb3IgUG9ydGZvbGlvIFRpcHMiIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMTRweCIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luQm90dG9tOiAiMjRweCIgfSwgY2hpbGRyZW46ICJHZXQgcGVyc29uYWxpemVkIHJlY29tbWVuZGF0aW9ucyB0byBpbXByb3ZlIHlvdXIgaW52ZXN0bWVudCBzdHJhdGVneS4iIH0pLAogICAgICBzdWJzY3JpYmVTdGF0dXMgPT09ICJzdWNjZXNzIiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogImNlbnRlciIsIHBhZGRpbmc6ICIyMHB4IiwgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250V2VpZ2h0OiA2MDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiNDBweCIsIG1hcmdpbkJvdHRvbTogIjEwcHgiIH0sIGNoaWxkcmVuOiAiXHV7MUYzODl9IiB9KSwKICAgICAgICBzdWJzY3JpYmVNZXNzYWdlCiAgICAgIF0gfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206ICIxNnB4IiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJibG9jayIsIGZvbnRTaXplOiAiMTRweCIsIGZvbnRXZWlnaHQ6IDYwMCwgbWFyZ2luQm90dG9tOiAiOHB4IiwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIkVtYWlsIEFkZHJlc3MiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuaW5wdXQsCiAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJ5b3VAZXhhbXBsZS5jb20iLAogICAgICAgICAgICAgIHZhbHVlOiBlbWFpbCwKICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEVtYWlsKGUudGFyZ2V0LnZhbHVlKQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KSwKICAgICAgICBzdWJzY3JpYmVTdGF0dXMgPT09ICJlcnJvciIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnJlZCwgZm9udFNpemU6ICIxNHB4IiwgbWFyZ2luQm90dG9tOiAiMTZweCIsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46IHN1YnNjcmliZU1lc3NhZ2UgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyAuLi5zdHlsZXMuY2FsY0J1dHRvbiwgd2lkdGg6ICIxMDAlIiB9LAogICAgICAgICAgICBvbkNsaWNrOiBoYW5kbGVTdWJzY3JpYmUsCiAgICAgICAgICAgIGRpc2FibGVkOiBzdWJzY3JpYmVTdGF0dXMgPT09ICJsb2FkaW5nIiwKICAgICAgICAgICAgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwKICAgICAgICAgICAgY2hpbGRyZW46IHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciID8gIlN1YnNjcmliaW5nLi4uIiA6ICJTdWJzY3JpYmUiCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMTFweCIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgdGV4dEFsaWduOiAiY2VudGVyIiwgbWFyZ2luVG9wOiAiMTJweCIsIGxpbmVIZWlnaHQ6IDEuNCB9LCBjaGlsZHJlbjogIkJ5IHN1YnNjcmliaW5nLCB5b3UgYWdyZWUgdG8gcmVjZWl2ZSBlbWFpbHMuIFVuc3Vic2NyaWJlIGFueXRpbWUuIFdlIHJldGFpbiB5b3VyIGVtYWlsIHVudGlsIHlvdSB1bnN1YnNjcmliZS4iIH0pCiAgICAgIF0gfSkKICAgIF0gfSkgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHlsZSIsIHsgY2hpbGRyZW46IGBpbnB1dFt0eXBlPW51bWJlcl06Oi13ZWJraXQtaW5uZXItc3Bpbi1idXR0b24sIGlucHV0W3R5cGU9bnVtYmVyXTo6LXdlYmtpdC1vdXRlci1zcGluLWJ1dHRvbiB7IC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsgbWFyZ2luOiAwOyB9IGlucHV0W3R5cGU9cmFuZ2VdOjotd2Via2l0LXNsaWRlci10aHVtYiB7IC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsgaGVpZ2h0OiAyMHB4OyB3aWR0aDogMjBweDsgYm9yZGVyLXJhZGl1czogNTAlOyBiYWNrZ3JvdW5kOiAke0NPTE9SUy5wcmltYXJ5fTsgY3Vyc29yOiBwb2ludGVyOyBib3JkZXI6IDJweCBzb2xpZCB3aGl0ZTsgYm94LXNoYWRvdzogMCAycHggNnB4IHJnYmEoMCwwLDAsMC4yKTsgbWFyZ2luLXRvcDogLTZweDsgfSAuYnRuLXByZXNzIHsgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMgZWFzZSwgb3BhY2l0eSAwLjJzOyB9IC5idG4tcHJlc3M6YWN0aXZlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsgfSAuYnRuLXByZXNzOmhvdmVyIHsgb3BhY2l0eTogMC43OyB9IEBrZXlmcmFtZXMgc3BpbiB7IGZyb20geyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsgfSB0byB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0gfSAuc3BpbiB7IGFuaW1hdGlvbjogc3BpbiAxcyBsaW5lYXIgaW5maW5pdGU7IH0gQG1lZGlhIHByaW50IHsgLm5vLXByaW50IHsgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OyB9IH1gIH0pCiAgXSB9KTsKfQoKLy8gc3JjL21haW4udHN4CnZhciBpbXBvcnRfanN4X3J1bnRpbWUyID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgRXJyb3JCb3VuZGFyeSA9IGNsYXNzIGV4dGVuZHMgaW1wb3J0X3JlYWN0NTguZGVmYXVsdC5Db21wb25lbnQgewogIGNvbnN0cnVjdG9yKHByb3BzKSB7CiAgICBzdXBlcihwcm9wcyk7CiAgICB0aGlzLnN0YXRlID0geyBoYXNFcnJvcjogZmFsc2UgfTsKICB9CiAgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcihlcnJvcikgewogICAgcmV0dXJuIHsgaGFzRXJyb3I6IHRydWUsIGVycm9yIH07CiAgfQogIGNvbXBvbmVudERpZENhdGNoKGVycm9yLCBlcnJvckluZm8pIHsKICAgIGNvbnNvbGUuZXJyb3IoIldpZGdldCBFcnJvciBCb3VuZGFyeSBjYXVnaHQgZXJyb3I6IiwgZXJyb3IsIGVycm9ySW5mbyk7CiAgICB0cnkgewogICAgICBmZXRjaCgiL2FwaS90cmFjayIsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBldmVudDogImNyYXNoIiwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgZXJyb3I6IGVycm9yPy5tZXNzYWdlIHx8ICJVbmtub3duIGVycm9yIiwKICAgICAgICAgICAgc3RhY2s6IGVycm9yPy5zdGFjaywKICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IGVycm9ySW5mbz8uY29tcG9uZW50U3RhY2sKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KS5jYXRjaCgoZSkgPT4gY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHJlcG9ydCBjcmFzaCIsIGUpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuc3RhdGUuaGFzRXJyb3IpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCwgdGV4dEFsaWduOiAiY2VudGVyIiwgZm9udEZhbWlseTogInNhbnMtc2VyaWYiLCBjb2xvcjogIiNEQzI2MjYiLCB3b3JkQnJlYWs6ICJicmVhay13b3JkIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJoMyIsIHsgY2hpbGRyZW46ICJTb21ldGhpbmcgd2VudCB3cm9uZy4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJwIiwgeyBjaGlsZHJlbjogIlBsZWFzZSB0cnkgcmVmcmVzaGluZyB0aGUgcGFnZS4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGV0YWlscyIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxMCwgdGV4dEFsaWduOiAibGVmdCIsIGZvbnRTaXplOiAiMTJweCIsIGNvbG9yOiAiIzY2NiIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdW1tYXJ5IiwgeyBjaGlsZHJlbjogIkRlYnVnIEVycm9yIERldGFpbHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJwcmUiLCB7IHN0eWxlOiB7IHdoaXRlU3BhY2U6ICJwcmUtd3JhcCIsIGJhY2tncm91bmQ6ICIjZjVmNWY1IiwgcGFkZGluZzogMTAsIGJvcmRlclJhZGl1czogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy50b1N0cmluZygpLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnIiLCB7fSksCiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXJyb3I/LnN0YWNrCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvcHMuY2hpbGRyZW47CiAgfQp9Owp2YXIgZ2V0SHlkcmF0aW9uRGF0YSA9ICgpID0+IHsKICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gU3RhcnRpbmcgaHlkcmF0aW9uIGNoZWNrLi4uIik7CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gV2luZG93IGlzIHVuZGVmaW5lZCIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zdCBvYSA9IHdpbmRvdy5vcGVuYWk7CiAgaWYgKCFvYSkgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgbm90IGZvdW5kLCByZW5kZXJpbmcgd2l0aCBkZWZhdWx0cyIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gd2luZG93Lm9wZW5haSBmb3VuZDoiLCBPYmplY3Qua2V5cyhvYSkpOwogIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICBvYS50b29sT3V0cHV0LAogICAgb2Euc3RydWN0dXJlZENvbnRlbnQsCiAgICBvYS5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EudG9vbElucHV0CiAgXTsKICBmb3IgKGNvbnN0IGNhbmRpZGF0ZSBvZiBjYW5kaWRhdGVzKSB7CiAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gRm91bmQgZGF0YToiLCBjYW5kaWRhdGUpOwogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfQogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTm8gZGF0YSBmb3VuZCBpbiBhbnkgY2FuZGlkYXRlIHNvdXJjZSIpOwogIHJldHVybiB7fTsKfTsKY29uc29sZS5sb2coIltNYWluXSBQb3J0Zm9saW8gT3B0aW1pemVyIG1haW4udHN4IGxvYWRpbmcuLi4iKTsKdmFyIENPTE9SUzIgPSB7CiAgcHJpbWFyeTogIiM1NkM1OTYiLAogIHByaW1hcnlEYXJrOiAiIzNhYTg3YiIsCiAgYmc6ICIjRkFGQUZBIiwKICB0ZXh0TWFpbjogIiMxQTFBMUEiLAogIHRleHRTZWNvbmRhcnk6ICIjOUNBM0FGIiwKICBib3JkZXI6ICIjRjNGNEY2IiwKICBhY2NlbnRMaWdodDogIiNFNkY3RjAiLAogIGJsdWU6ICIjNUQ5Q0VDIgp9OwpmdW5jdGlvbiBBcHAoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmJnIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShQb3J0Zm9saW9TaW11bGF0b3IsIHsgaW5pdGlhbERhdGE6IGluaXRpYWxEYXRhMiB9KSB9KTsKfQp2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBvcnRmb2xpby1vcHRpbWl6ZXItcm9vdCIpOwppZiAoIWNvbnRhaW5lcikgewogIHRocm93IG5ldyBFcnJvcigicG9ydGZvbGlvLW9wdGltaXplci1yb290IGVsZW1lbnQgbm90IGZvdW5kIik7Cn0KdmFyIHJvb3QgPSAoMCwgaW1wb3J0X2NsaWVudC5jcmVhdGVSb290KShjb250YWluZXIpOwp2YXIgcmVuZGVyQXBwID0gKGRhdGEpID0+IHsKICByb290LnJlbmRlcigKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKGltcG9ydF9yZWFjdDU4LmRlZmF1bHQuU3RyaWN0TW9kZSwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoRXJyb3JCb3VuZGFyeSwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQXBwLCB7IGluaXRpYWxEYXRhOiBkYXRhIH0sIERhdGUubm93KCkpIH0pIH0pCiAgKTsKfTsKdmFyIGluaXRpYWxEYXRhID0gZ2V0SHlkcmF0aW9uRGF0YSgpOwpyZW5kZXJBcHAoaW5pdGlhbERhdGEpOwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigib3BlbmFpOnNldF9nbG9iYWxzIiwgKGV2KSA9PiB7CiAgY29uc3QgZ2xvYmFscyA9IGV2Py5kZXRhaWw/Lmdsb2JhbHM7CiAgaWYgKGdsb2JhbHMpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBMYXRlIGV2ZW50IHJlY2VpdmVkOiIsIGdsb2JhbHMpOwogICAgY29uc3QgY2FuZGlkYXRlcyA9IFsKICAgICAgZ2xvYmFscy50b29sT3V0cHV0LAogICAgICBnbG9iYWxzLnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQsCiAgICAgIGdsb2JhbHMudG9vbElucHV0CiAgICBdOwogICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykgewogICAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBSZS1yZW5kZXJpbmcgd2l0aCBsYXRlIGRhdGE6IiwgY2FuZGlkYXRlKTsKICAgICAgICByZW5kZXJBcHAoY2FuZGlkYXRlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9Cn0pOwovKiEgQnVuZGxlZCBsaWNlbnNlIGluZm9ybWF0aW9uOgoKcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiBzY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKcmVhY3QtZG9tL2Nqcy9yZWFjdC1kb20uZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiByZWFjdC1kb20uZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQogICgqKgogICAqIENoZWNrcyBpZiBhbiBldmVudCBpcyBzdXBwb3J0ZWQgaW4gdGhlIGN1cnJlbnQgZXhlY3V0aW9uIGVudmlyb25tZW50LgogICAqCiAgICogTk9URTogVGhpcyB3aWxsIG5vdCB3b3JrIGNvcnJlY3RseSBmb3Igbm9uLWdlbmVyaWMgZXZlbnRzIHN1Y2ggYXMgYGNoYW5nZWAsCiAgICogYHJlc2V0YCwgYGxvYWRgLCBgZXJyb3JgLCBhbmQgYHNlbGVjdGAuCiAgICoKICAgKiBCb3Jyb3dzIGZyb20gTW9kZXJuaXpyLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZVN1ZmZpeCBFdmVudCBuYW1lLCBlLmcuICJjbGljayIuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkLgogICAqIEBpbnRlcm5hbAogICAqIEBsaWNlbnNlIE1vZGVybml6ciAzLjAuMHByZSAoQ3VzdG9tIEJ1aWxkKSB8IE1JVAogICAqKQoKdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiB1c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0vd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHVzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0vd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmRlY2ltYWwuanMtbGlnaHQvZGVjaW1hbC5qczoKICAoKiEgZGVjaW1hbC5qcy1saWdodCB2Mi41LjEgaHR0cHM6Ly9naXRodWIuY29tL01pa2VNY2wvZGVjaW1hbC5qcy1saWdodC9MSUNFTkNFICopCgpyZWFjdC1pcy9janMvcmVhY3QtaXMuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiByZWFjdC1pcy5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Fycm93LXJpZ2h0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLWRvd24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaXJjbGUtcXVlc3Rpb24tbWFyay5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2hlYXJ0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaW5mby5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvYWRlci5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21haWwuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tZXNzYWdlLXNxdWFyZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21pbnVzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGxheS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsdXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wcmludGVyLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcm90YXRlLWNjdy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RhcmdldC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyZW5kaW5nLXVwLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMveC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2x1Y2lkZS1yZWFjdC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoqLwo=";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[Portfolio Optimizer] Failed to load:', err);
          const root = document.getElementById('portfolio-optimizer-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load calculator</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
