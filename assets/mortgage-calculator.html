<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mortgage Calculator Widget</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --nav-offset: clamp(6px, 2vw, 14px);
        --app-pad-x: clamp(12px, 4vw, 24px);
      }

      body {
        margin: 0;
        padding: 24px 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        background: transparent;
        color: #e2e8f0;
        overflow-x: hidden;
      }

      .app {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding: 0 var(--app-pad-x) 32px;
        display: grid;
        gap: 18px;
        background: linear-gradient(135deg, rgba(25, 28, 48, 0.9), rgba(20, 23, 42, 0.95));
        border: none;
        border-radius: 0;
        box-shadow: none;
        box-sizing: border-box;
      }

      header h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      header p {
        margin: 8px 0 0;
        color: rgba(226, 232, 240, 0.75);
        font-size: 14px;
      }

      .section-title {
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.16em;
        color: rgba(148, 163, 184, 0.65);
        text-transform: uppercase;
        margin-bottom: 14px;
      }

      .section-summary {
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.16em;
        color: rgba(148, 163, 184, 0.75);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 18px;
        line-height: 1;
      }

      .section-summary::after {
        content: "";
        width: 9px;
        height: 9px;
        border-right: 2px solid rgba(148, 163, 184, 0.6);
        border-bottom: 2px solid rgba(148, 163, 184, 0.6);
        transform: rotate(45deg);
        margin-left: auto;
        transition: transform 0.24s ease, border-color 0.24s ease;
      }

      details[open] .section-summary::after {
        transform: rotate(-135deg);
      }

      .section-summary:hover::after,
      .section-summary:focus-visible::after {
        border-color: #0ea5e9;
      }

      .collapsible-content {
        padding: 14px 16px;
        margin-top: 0;
      }

      .collapsible-content .grid + .grid {
        margin-top: 12px;
      }

      .field-group {
        padding: 16px 0 12px;
      }

      .field-group + .field-group {
        border-top: 1px solid rgba(148, 163, 184, 0.08);
        padding-top: 20px;
      }

      .field-group-label {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.7);
        margin: 0 0 14px;
      }

      .field-group-label .icon {
        width: 18px;
        height: 18px;
        border-radius: 6px;
        background: linear-gradient(135deg, rgba(14, 165, 233, 0.45), rgba(99, 102, 241, 0.35));
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: rgba(15, 23, 42, 0.92);
        font-size: 12px;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.25);
      }

      .section-block {
        border-radius: 12px;
        border: 1px solid rgba(71, 85, 105, 0.3);
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.85), rgba(25, 28, 48, 0.9));
        padding: 16px;
        display: grid;
        gap: 12px;
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.4);
        touch-action: pan-y;
      }

      details.section-block {
        padding: 0;
      }

      details.section-block > summary {
        padding: 0;
      }

      details.section-block > summary.section-summary {
        padding: 14px 18px;
      }

      details.section-block > .collapsible-content {
        padding-bottom: 14px;
      }

      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      }

      .grid.duo-columns {
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 16px 18px;
      }

      .grid.trio-columns {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px 18px;
      }

      .is-hidden {
        display: none !important;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 10px;
        color: rgba(226, 232, 240, 0.68);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      label .field-helper {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.6);
        text-transform: none;
        letter-spacing: 0;
        font-weight: 400;
        margin-top: -2px;
      }

      label.has-error input,
      label.has-error select {
        border-bottom-color: #f87171;
      }

      label .field-message {
        font-size: 10px;
        color: #fca5a5;
        text-transform: none;
        letter-spacing: 0;
        font-weight: 400;
      }

      .percent-field {
        position: relative;
      }

      .percent-field input[type="number"] {
        padding-right: 32px;
      }

      .percent-field::after {
        content: "%";
        position: absolute;
        right: 4px;
        top: 34px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.5);
        pointer-events: none;
      }

      input[type="number"],
      input[type="text"],
      select {
        border: none;
        border-bottom: 1px solid rgba(100, 116, 139, 0.4);
        border-radius: 0;
        background: transparent;
        color: #e2e8f0;
        font-size: 15px;
        padding: 6px 4px;
        transition: border-color 0.2s ease, color 0.2s ease;
      }

      input::placeholder {
        color: rgba(226, 232, 240, 0.38);
      }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-bottom-color: #0ea5e9;
        color: #f1f5f9;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0;
        margin-top: 10px;
      }

      .checkbox-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin: 0;
      }

      .checkbox-row span {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.75);
        text-transform: none;
        letter-spacing: 0;
      }

      .result-stack {
        display: grid;
        gap: 10px;
      }

      .quick-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px 12px;
      }

      .result-carousel {
        position: relative;
        padding: 0;
      }

      .carousel-nav {
        position: fixed;
        top: 50vh;
        transform: translateY(-50%);
        width: 42px;
        height: 42px;
        border-radius: 999px;
        border: 1.5px solid rgba(14, 165, 233, 0.35);
        background: rgba(14, 165, 233, 0.12);
        color: #0ea5e9;
        display: grid;
        place-items: center;
        cursor: pointer;
        box-shadow: 0 6px 24px rgba(14, 165, 233, 0.25);
        transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        z-index: 100;
        font-size: 24px;
        backdrop-filter: blur(2px);
      }

      .carousel-nav[disabled] {
        opacity: 0.35;
        cursor: default;
      }

      .carousel-nav:not([disabled]):hover,
      .carousel-nav:not([disabled]):focus-visible {
        background: rgba(14, 165, 233, 0.22);
        border-color: #0ea5e9;
        color: #0ea5e9;
        box-shadow: 0 10px 28px rgba(14, 165, 233, 0.35);
        outline: none;
        transform: translateY(-50%) scale(1.06);
      }

      #cardPrev {
        left: var(--nav-offset);
        right: auto;
        bottom: auto;
      }

      #cardNext {
        right: var(--nav-offset);
        left: auto;
        bottom: auto;
      }

      .carousel-window {
        width: 100%;
        overflow: hidden;
        touch-action: pan-y;
      }

      .carousel-track {
        display: flex;
        transition: transform 0.35s ease-in-out;
        will-change: transform;
      }

      .carousel-slide {
        min-width: 100%;
        flex: 0 0 100%;
        padding: 4px 0;
        display: flex;
        justify-content: center;
        box-sizing: border-box;
      }

      .slide-content {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        display: grid;
        gap: 16px;
      }

      .slide-content.tight {
        gap: 16px;
      }

      .slide-content.breakdown {
        gap: 12px;
      }

      .breakdown-card {
        display: grid;
        gap: 24px;
        grid-template-columns: minmax(0, 1fr);
      }

      .breakdown-layout {
        display: grid;
        grid-template-columns: 0.9fr 1.1fr;
        gap: 16px;
        align-items: stretch;
      }

      .breakdown-panel {
        position: relative;
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.8), rgba(25, 28, 48, 0.85));
        border: 1px solid rgba(71, 85, 105, 0.3);
        border-radius: 12px;
        padding: 12px 16px 16px;
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.35);
        touch-action: pan-y;
      }

      .breakdown-chart {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        background: transparent;
        border: none;
        box-shadow: none;
      }

      .breakdown-chart canvas {
        width: 100%;
        height: auto;
        aspect-ratio: 1 / 1;
        display: block;
      }

      .breakdown-chart .chart-value {
        position: absolute;
        text-align: center;
        color: #f1f5f9;
        font-weight: 700;
        font-size: 24px;
        letter-spacing: -0.01em;
        pointer-events: none;
      }

      .breakdown-chart .chart-value span {
        display: block;
        margin-top: 4px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.65);
      }

      .breakdown-list {
        display: grid;
        gap: 8px;
        align-content: stretch;
        overflow: hidden;
        grid-template-rows: repeat(var(--rows, 5), 1fr);
        touch-action: pan-y;
      }

      .breakdown-row {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.75), rgba(25, 28, 48, 0.82));
        border: 1px solid rgba(71, 85, 105, 0.25);
        box-shadow: 0 2px 8px rgba(10, 13, 28, 0.28);
        min-height: 0;
      }

      .breakdown-pill {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        font-size: 14px;
        font-weight: 600;
        color: #0f172a;
      }

      .breakdown-pill.primary {
        background: linear-gradient(150deg, rgba(14, 165, 233, 0.95), rgba(14, 165, 233, 0.65));
      }

      .breakdown-pill.accent {
        background: linear-gradient(150deg, rgba(99, 102, 241, 0.9), rgba(59, 130, 246, 0.7));
      }

      .breakdown-pill.subtle {
        background: linear-gradient(150deg, rgba(16, 185, 129, 0.9), rgba(45, 212, 191, 0.7));
      }

      .breakdown-details {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .breakdown-details .label {
        font-size: 10px;
        color: #e2e8f0;
        font-weight: 600;
      }

      .breakdown-details .hint {
        font-size: 9px;
        color: rgba(148, 163, 184, 0.65);
        letter-spacing: 0;
        line-height: 1.25;
      }

      .breakdown-row input[type="number"] {
        width: 100px;
        text-align: right;
        font-size: 15px;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(100, 116, 139, 0.4);
        background: rgba(15, 23, 42, 0.5);
        color: #e2e8f0;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      .breakdown-row input[type="number"]:focus {
        border-color: #0ea5e9;
        background: rgba(14, 165, 233, 0.1);
        outline: none;
        color: #f1f5f9;
      }

      .breakdown-row .value {
        font-size: 13px;
        font-weight: 700;
        color: #f1f5f9;
        text-align: right;
        letter-spacing: -0.01em;
      }

      .breakdown-footnote {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.6);
        letter-spacing: 0;
        line-height: 1.4;
        margin-top: 4px;
      }

      .slide-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        letter-spacing: -0.02em;
        color: #f1f5f9;
      }

      .slide-header p {
        margin: 6px 0 0;
        color: rgba(148, 163, 184, 0.75);
        font-size: 13px;
        line-height: 1.5;
      }

      .slide-header {
        position: relative;
        padding-right: 200px;
      }

      .notify-btn {
        position: absolute;
        top: 0;
        right: 0;
        border-radius: 999px;
        border: 1.5px solid rgba(14, 165, 233, 0.4);
        background: rgba(14, 165, 233, 0.14);
        color: #0ea5e9;
        padding: 8px 12px;
        font: inherit;
        font-size: 12px;
        letter-spacing: 0.04em;
        text-transform: none;
        cursor: pointer;
        box-shadow: 0 4px 14px rgba(14, 165, 233, 0.25);
        transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, transform 0.15s ease;
      }

      .notify-btn:hover,
      .notify-btn:focus-visible {
        background: rgba(14, 165, 233, 0.22);
        border-color: #0ea5e9;
        box-shadow: 0 8px 22px rgba(14, 165, 233, 0.35);
        outline: none;
        transform: translateY(-1px);
      }

      .header-cta {
        position: absolute;
        top: 0;
        right: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        max-width: 220px;
      }

      .rate-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1.5px solid rgba(148, 163, 184, 0.28);
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.9), rgba(25, 28, 48, 0.92));
        color: #e2e8f0;
        font-weight: 600;
        font-size: 13px;
        letter-spacing: 0.02em;
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.35);
        white-space: nowrap;
      }

      .rate-badge .value {
        color: #0ea5e9;
        font-weight: 700;
      }

      .totals-list {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px 18px;
        font-size: 13px;
        color: rgba(148, 163, 184, 0.9);
      }

      .totals-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .totals-item .label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(148, 163, 184, 0.7);
      }

      .totals-item .value {
        color: #e2e8f0;
        font-weight: 600;
      }

      .result-card {
        border-radius: 12px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.8), rgba(25, 28, 48, 0.85));
        border: 1px solid rgba(71, 85, 105, 0.3);
        display: grid;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.35);
      }

      .result-card .label {
        font-size: 10px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.65);
        font-weight: 600;
      }

      .result-card .value {
        font-size: 26px;
        font-weight: 700;
        color: #f1f5f9;
        letter-spacing: -0.01em;
      }

      .result-card .hint {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.6);
        line-height: 1.4;
      }

      .result-card.primary {
        padding: 24px 20px;
        background: linear-gradient(140deg, rgba(14, 165, 233, 0.18), rgba(20, 23, 42, 0.95));
        border: 1px solid rgba(14, 165, 233, 0.4);
        box-shadow: 0 8px 24px rgba(14, 165, 233, 0.2), 0 0 80px rgba(14, 165, 233, 0.08);
        gap: 10px;
      }

      .result-card.primary .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .result-card.primary .label {
        color: rgba(148, 163, 184, 0.85);
        font-size: 11px;
        letter-spacing: 0.14em;
        font-weight: 600;
      }

      .result-card.primary .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #0ea5e9;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(14, 165, 233, 0.4);
        background: rgba(14, 165, 233, 0.15);
      }

      .result-card.primary .value {
        font-size: 48px;
        font-weight: 700;
        line-height: 1;
        color: #f1f5f9;
        letter-spacing: -0.02em;
      }

      .result-card.secondary {
        background: linear-gradient(135deg, rgba(25, 28, 48, 0.7), rgba(20, 23, 42, 0.75));
        border-color: rgba(71, 85, 105, 0.25);
        padding: 14px;
      }

      .result-card.secondary .value,
      .result-card.secondary .hint {
        font-size: 13px;
        font-weight: 400;
      }

      .result-card.secondary .value {
        color: #f1f5f9;
        font-size: 22px;
      }

      .actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        color: rgba(148, 163, 184, 0.75);
        gap: 8px;
      }

      .actions button {
        background: rgba(37, 40, 65, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.35);
        color: rgba(148, 163, 184, 0.9);
        padding: 8px 14px;
        font: inherit;
        font-size: 11px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .actions button:hover,
      .actions button:focus-visible {
        color: #0ea5e9;
        border-color: #0ea5e9;
        background: rgba(14, 165, 233, 0.15);
        box-shadow: 0 4px 14px rgba(14, 165, 233, 0.25);
        outline: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        font-size: 13px;
      }

      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        text-align: right;
      }

      th {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.6);
      }

      td.label {
        text-align: left;
      }

      .schedule-note {
        margin-top: 10px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.6);
      }

      /* Amortization schedule container: rely on section-block for chrome */
      #schedulePreview {
        overflow: auto;
      }

      @keyframes glow {
        0% {
          box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
        40% {
          box-shadow: 0 0 48px rgba(56, 189, 248, 0.45);
        }
        100% {
          box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
      }

      .glow-animate {
        animation: glow 1s ease-in-out;
      }

      @media (prefers-reduced-motion: reduce) {
        .glow-animate {
          animation: none !important;
        }
        .carousel-track,
        .carousel-nav {
          transition: none !important;
        }
      }

      @media (max-width: 700px) {
        .breakdown-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }

      @media (max-width: 560px) {
        body {
          padding: 18px;
        }

        .app {
          padding: 22px;
        }

        button {
          flex: 1 1 100%;
        }

        #cardPrev {
          left: 6px;
        }

        #cardNext {
          right: 6px;
        }

        .breakdown-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .breakdown-chart {
          padding: 24px;
        }

        .breakdown-chart canvas {
          width: 180px;
          height: 180px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <section class="result-carousel" role="region" aria-roledescription="carousel" aria-label="Mortgage calculator">
        <button class="carousel-nav" id="cardPrev" aria-label="Previous card" aria-controls="resultTrack">&#x2039;</button>
        <div class="carousel-window" tabindex="0">
          <div class="carousel-track" id="resultTrack">
            <div class="carousel-slide" data-card="summary" role="group" aria-roledescription="slide" aria-label="Summary" aria-hidden="false">
              <div class="slide-content">
                <header class="slide-header">
                  <h2>Mortgage Calculator</h2>
                  <div class="header-cta">
                    <div id="avgRateBadge" class="rate-badge">Today's Average Rate ‚Äî <span class="value" id="avgRateValue">‚Äî</span></div>
                    <button id="ratesNotifyBtn" class="notify-btn" type="button">Notify Me When Rates Drop</button>
                  </div>
                  <p>Compare loan programs, see monthly costs, and preview payoff timing.<br>Adjust the inputs to explore scenarios.</p>
                </header>

                <section class="section-block">
                  <div class="section-title">Loan basics</div>
                  <div class="grid">
                    <label>
                      Loan program
                      <select id="loan_type">
                        <option value="conventional">Conventional</option>
                        <option value="FHA">FHA</option>
                        <option value="VA">VA</option>
                        <option value="USDA">USDA</option>
                      </select>
                    </label>
                    <label>
                      Home value ($)
                      <input type="number" id="home_value" min="0" step="1000" />
                      <span class="field-message" data-field-error="home_value"></span>
                    </label>
                    <label>
                      Down payment ($)
                      <input type="number" id="down_payment_value" min="0" step="1000" />
                      <span class="field-message" data-field-error="down_payment_value"></span>
                    </label>
                    <label class="percent-field">
                      Rate (APR %)
                      <input type="number" id="rate_apr" min="0" step="0.01" />
                      <span class="field-message" data-field-error="rate_apr"></span>
                    </label>
                    <label>
                      Term (years)
                      <input type="number" id="term_years" min="1" step="1" />
                      <span class="field-message" data-field-error="term_years"></span>
                    </label>
                  </div>
                </section>

                <details class="section-block collapsible" id="propertyMortgageFees">
                  <summary class="section-summary">Property, mortgage, and fees</summary>
                  <div class="collapsible-content">
                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">üè†</span> My information</p>
                      <div class="grid duo-columns">
                        <label>
                          ZIP code
                          <span class="field-helper">Location for tax estimates</span>
                          <input type="text" id="zip_code" inputmode="numeric" pattern="\d*" maxlength="9" placeholder="e.g. 94043" />
                        </label>
                        <label>
                          Credit score
                          <span class="field-helper">Affects interest rate</span>
                          <select id="credit_score">
                            <option value="">Select</option>
                            <option value="760+">760+</option>
                            <option value="720-759">720-759</option>
                            <option value="680-719">680-719</option>
                            <option value="640-679">640-679</option>
                            <option value="600-639">600-639</option>
                            <option value="<600">Below 600</option>
                          </select>
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">üìç</span> Property information</p>
                      <div class="grid trio-columns">
                        <label class="percent-field">
                          Property tax
                          <span class="field-helper">Annual % of assessed value</span>
                          <input type="number" id="property_tax_input" min="0" step="0.01" />
                        </label>
                        <label>
                          Homeowners insurance
                          <span class="field-helper">Annual cost in dollars</span>
                          <input type="number" id="homeowners_insurance_yearly" min="0" step="50" />
                        </label>
                        <label>
                          HOA dues
                          <span class="field-helper">Monthly cost in dollars</span>
                          <input type="number" id="hoa_monthly" min="0" step="10" />
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">üí≥</span> Mortgage insurance & fees</p>
                      <div class="grid trio-columns">
                        <label class="percent-field">
                          PMI
                          <span class="field-helper">Annual % (conventional only)</span>
                          <input type="number" id="pmi_pct" min="0" step="0.01" />
                        </label>
                        <label class="percent-field" data-mi-only>
                          Annual MI fee
                          <span class="field-helper">% of remaining balance</span>
                          <input type="number" id="annual_mi_pct" min="0" step="0.01" />
                        </label>
                        <label class="percent-field">
                          Upfront fee
                          <span class="field-helper">% of base loan amount</span>
                          <input type="number" id="upfront_fee_pct" min="0" step="0.01" />
                          <div class="checkbox-row">
                            <input type="checkbox" id="finance_upfront_fee" />
                            <span>Add fee to principal balance</span>
                          </div>
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">‚öôÔ∏è</span> Advanced options</p>
                      <div class="grid duo-columns">
                        <label>
                          First payment month
                          <span class="field-helper">1-12 for Jan-Dec</span>
                          <input type="number" id="start_month" min="1" max="12" step="1" />
                          <span class="field-message" data-field-error="start_month"></span>
                        </label>
                        <label>
                          First payment year
                          <span class="field-helper">Year of first payment</span>
                          <input type="number" id="start_year" min="2024" step="1" />
                          <span class="field-message" data-field-error="start_year"></span>
                        </label>
                        <label>
                          Extra payment
                          <span class="field-helper">Additional monthly principal</span>
                          <input type="number" id="extra_principal_monthly" min="0" step="50" />
                        </label>
                        <label>
                          Extra starts at month
                          <span class="field-helper">Month index when extra begins</span>
                          <input type="number" id="extra_start_month_index" min="0" step="1" />
                        </label>
                      </div>
                    </div>
                  </div>
                </details>

                <div class="result-stack">
                  <div class="result-card primary" id="monthlyPaymentCard">
                    <div class="card-header">
                      <span class="label">Monthly payment (month 0)</span>
                      <span class="badge">All-in payment</span>
                    </div>
                    <span class="value" id="total_monthly_0" aria-live="polite">$0</span>
                    <span class="hint">Includes P&I, MI, taxes, insurance, HOA (excludes extra principal).</span>
                  </div>
                  <div class="quick-metrics">
                    <div class="result-card secondary">
                      <span class="label">Scheduled principal & interest</span>
                      <span class="value" id="p_and_i">$0</span>
                      <span class="hint">Level payment before extra principal or add-ons.</span>
                    </div>
                    <div class="result-card secondary">
                      <span class="label">Total interest over loan</span>
                      <span class="value" id="total_interest">$0</span>
                      <span class="hint" id="interest_hint"></span>
                    </div>
                    <div class="result-card secondary">
                      <span class="label">Estimated payoff date</span>
                      <span class="value" id="payoff_date">‚Äî</span>
                      <span class="hint" id="term_hint"></span>
                    </div>
                  </div>

                  <div class="actions">
                    <span>Updates automatically as you edit.</span>
                    <button class="secondary" id="resetBtn" type="button">Reset defaults</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="carousel-slide" data-card="breakdown" role="group" aria-roledescription="slide" aria-label="Monthly breakdown" aria-hidden="true">
              <div class="slide-content breakdown">
                <header class="slide-header">
                  <h2>Monthly payment breakdown</h2>
                  <p>Visualize the components of your monthly payment.</p>
                </header>
                <div class="breakdown-card">
                  <div class="breakdown-panel breakdown-layout">
                    <div class="breakdown-chart">
                      <canvas id="breakdownChart"></canvas>
                      <div class="chart-value" id="chartTotal">
                        $0<span>/mo</span>
                      </div>
                    </div>
                    <div class="breakdown-list" id="breakdown_list">
                      <div class="breakdown-row">
                        <div class="breakdown-pill primary">üí∞</div>
                        <div class="breakdown-details">
                          <span class="label">Principal & interest</span>
                          <span class="hint">Scheduled P&I payment</span>
                        </div>
                        <span class="value" id="breakdown_p_and_i">$0</span>
                      </div>
                      <div class="breakdown-row">
                        <div class="breakdown-pill accent">üè°</div>
                        <div class="breakdown-details">
                          <span class="label">Property tax</span>
                          <span class="hint">Monthly property tax</span>
                        </div>
                        <span class="value" id="breakdown_tax">$0</span>
                      </div>
                      <div class="breakdown-row">
                        <div class="breakdown-pill accent">üõ°Ô∏è</div>
                        <div class="breakdown-details">
                          <span class="label">Homeowner's insurance</span>
                          <span class="hint">Monthly insurance cost</span>
                        </div>
                        <span class="value" id="breakdown_ins">$0</span>
                      </div>
                      <div class="breakdown-row">
                        <div class="breakdown-pill subtle">üèòÔ∏è</div>
                        <div class="breakdown-details">
                          <span class="label">HOA dues</span>
                          <span class="hint">Monthly association fees</span>
                        </div>
                        <span class="value" id="breakdown_hoa">$0</span>
                      </div>
                      <div class="breakdown-row" id="breakdown_mi_row">
                        <div class="breakdown-pill subtle">üîí</div>
                        <div class="breakdown-details">
                          <span class="label">Mortgage insurance</span>
                          <span class="hint">Monthly MI/PMI payment</span>
                        </div>
                        <span class="value" id="breakdown_mi">$0</span>
                      </div>
                    </div>
                  </div>
                  <p class="breakdown-footnote">Adjust tax, insurance, and HOA values above to update your monthly payment across all slides.</p>
                </div>
              </div>
            </div>
            <div class="carousel-slide" data-card="amortization" role="group" aria-roledescription="slide" aria-label="Amortization & totals" aria-hidden="true">
              <div class="slide-content tight">
                <header class="slide-header">
                  <h2>Amortization & totals</h2>
                  <p>Review lifetime costs and the first year of payments at a glance.</p>
                </header>
                <section class="section-block">
                  <div class="section-title">Lifetime totals</div>
                  <div class="totals-list" id="totalsBreakdown"></div>
                </section>
                <section class="section-block">
                  <div class="section-title">Schedule preview</div>
                  <div id="schedulePreview"></div>
                  <div class="schedule-note" id="scheduleNote"></div>
                </section>
              </div>
            </div>
          </div>
        </div>
        <button class="carousel-nav" id="cardNext" aria-label="Next card" aria-controls="resultTrack">&#x203A;</button>
      </section>
    </div>

    <script type="module">
      (function () {
        const MONTHS_IN_YEAR = 12;
        const ZERO_TOLERANCE = 1e-8;

        const toNumber = (value) => {
          const num = Number(value);
          return Number.isFinite(num) ? num : 0;
        };

        const clampNonNegative = (value) => {
          const num = toNumber(value);
          return num < 0 ? 0 : num;
        };

        const normalizeMonth = (month) => {
          const m = Math.round(toNumber(month));
          if (Number.isNaN(m) || m <= 0) return 1;
          if (m > 12) {
            return ((m - 1) % 12) + 1;
          }
          return m;
        };

        const normalizeYear = (year) => {
          const y = Math.round(toNumber(year));
          return y > 0 ? y : new Date().getFullYear();
        };

        function compute_base_loan_amount(home_value, down_payment_value, down_payment_pct) {
          const hv = clampNonNegative(home_value);
          const dpValueInput = toNumber(down_payment_value);
          const dpPctInput = clampNonNegative(down_payment_pct);

          let loan_amount_base;
          let effectiveDpValue;
          let effectiveDpPct;

          // If both down payment fields provided, prefer down_payment_value
          if (dpValueInput > 0) {
            effectiveDpValue = Math.min(dpValueInput, hv); // Don't allow down payment > home value
            loan_amount_base = hv - effectiveDpValue;
            effectiveDpPct = hv > 0 ? effectiveDpValue / hv : 0;
          } else {
            effectiveDpPct = Math.min(dpPctInput, 1.0); // Don't allow down payment % > 100%
            effectiveDpValue = hv * effectiveDpPct;
            loan_amount_base = hv * (1 - effectiveDpPct);
          }

          return {
            loan_amount_base: clampNonNegative(loan_amount_base),
            down_payment_value: effectiveDpValue,
            down_payment_pct: effectiveDpPct,
          };
        }

        function apply_upfront_fee(loan_amount_base, upfront_fee_pct, finance_upfront_fee) {
          const base = clampNonNegative(loan_amount_base);
          const feePct = clampNonNegative(upfront_fee_pct);
          const upfront_fee = base * feePct;
          const financed = Boolean(finance_upfront_fee);
          const principal_0 = financed ? base + upfront_fee : base;
          const cash_at_close_upfront_fee = financed ? 0 : upfront_fee;

          return {
            principal_0,
            upfront_fee,
            cash_at_close_upfront_fee,
          };
        }

        function normalize_property_tax(property_tax_input, home_value) {
          const hv = clampNonNegative(home_value);
          const input = clampNonNegative(property_tax_input);

          if (input <= 20) {
            return {
              property_tax_yearly: hv * (input / 100),
              property_tax_mode: "percent",
            };
          }

          return {
            property_tax_yearly: input,
            property_tax_mode: "absolute",
          };
        }

        function monthly_p_and_i(principal_0, rate_apr, term_years) {
          const principal = clampNonNegative(principal_0);
          const termYears = clampNonNegative(term_years);
          const n = Math.max(Math.round(termYears * MONTHS_IN_YEAR), 0);

          if (n === 0 || principal === 0) {
            return 0;
          }

          const yearlyRate = clampNonNegative(rate_apr);
          const i_m = yearlyRate / MONTHS_IN_YEAR;

          if (i_m > 0) {
            const denominator = 1 - Math.pow(1 + i_m, -n);
            if (denominator === 0) {
              return principal / n;
            }
            return principal * i_m / denominator;
          } else {
            return principal / n;
          }
        }

        function monthly_mi(principal_t, loan_type, home_value, pmi_pct, annual_mi_pct) {
          const principal = clampNonNegative(principal_t);
          const hv = clampNonNegative(home_value);

          switch (loan_type) {
            case "conventional":
              if (hv === 0) return 0;
              const ltv = principal / hv;
              if (ltv <= 0.8) return 0;
              return (clampNonNegative(pmi_pct) / MONTHS_IN_YEAR) * principal;

            case "FHA":
              return (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR) * principal;

            case "VA":
              return 0;

            case "USDA":
              return (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR) * principal;

            default:
              return 0;
          }
        }

        const createStartDate = (start_month, start_year) =>
          new Date(normalizeYear(start_year), normalizeMonth(start_month) - 1, 1);

        const advanceOneMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 1);

        function amortize_monthly(
          principal_0,
          i_m,
          n,
          start_month,
          start_year,
          tax_monthly,
          ins_monthly,
          hoa_monthly,
          home_value,
          loan_type,
          pmi_pct,
          annual_mi_pct,
          p_and_i,
          extra_principal_monthly = 0,
          extra_start_month_index = 0
        ) {
          let principal = clampNonNegative(principal_0);
          let currentDate = createStartDate(start_month, start_year);
          const totalPeriods = Math.max(Math.round(toNumber(n)), 0);
          const extraStartIndex = Math.max(Math.round(toNumber(extra_start_month_index)), 0);

          const totals = {
            interest: 0,
            tax: 0,
            ins: 0,
            hoa: 0,
            mi: 0,
            principal: 0,
            payments: 0,
          };

          const schedule = [];

          for (let t = 0; t < totalPeriods && principal > ZERO_TOLERANCE; t += 1) {
            const interest = principal * clampNonNegative(i_m);
            const principal_sched = Math.max(p_and_i - interest, 0);

            const mi = monthly_mi(principal, loan_type, home_value, pmi_pct, annual_mi_pct);

            const tax = clampNonNegative(tax_monthly);
            const ins = clampNonNegative(ins_monthly);
            const hoa_v = clampNonNegative(hoa_monthly);

            const extra = t >= extraStartIndex ? clampNonNegative(extra_principal_monthly) : 0;

            const principal_reduction = principal_sched + extra;
            const principal_next = Math.max(principal - principal_reduction, 0);

            totals.interest += interest;
            totals.tax += tax;
            totals.ins += ins;
            totals.hoa += hoa_v;
            totals.mi += mi;
            totals.principal += principal_reduction;
            totals.payments += p_and_i + mi + tax + ins + hoa_v + extra;

            schedule.push({
              index: t,
              date: {
                year: currentDate.getFullYear(),
                month: currentDate.getMonth() + 1,
              },
              opening_balance: principal,
              p_and_i,
              interest,
              principal_scheduled: principal_sched,
              extra_principal: extra,
              mi,
              tax,
              ins,
              hoa: hoa_v,
              total_payment: p_and_i + mi + tax + ins + hoa_v + extra,
              closing_balance: principal_next,
            });

            principal = principal_next;
            currentDate = advanceOneMonth(currentDate);

            if (principal <= ZERO_TOLERANCE) {
              principal = 0;
              break;
            }
          }

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : {
                year: normalizeYear(start_year),
                month: normalizeMonth(start_month),
              };

          return { schedule, payoff_date, totals };
        }

        function summarize_outputs(schedule, totals, p_and_i, tax_monthly, ins_monthly, hoa, principal_0, mi0) {
          const total_monthly_0 = p_and_i + tax_monthly + ins_monthly + hoa + mi0;

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : null;

          return {
            total_monthly_0,
            payoff_date,
            total_interest: totals.interest,
            total_tax: totals.tax,
            total_ins: totals.ins,
            total_hoa: totals.hoa,
            total_mi: totals.mi,
            total_of_payments: totals.payments,
            total_principal: totals.principal,
            payments_made: schedule.length,
            schedule,
          };
        }

        function calculate_mortgage(params) {
          const {
            loan_type,
            home_value,
            down_payment_value,
            down_payment_pct,
            rate_apr,
            term_years,
            start_month,
            start_year,
            property_tax_input,
            homeowners_insurance_yearly,
            hoa_monthly,
            upfront_fee_pct,
            annual_mi_pct,
            finance_upfront_fee,
            extra_principal_monthly,
            extra_start_month_index,
            pmi_pct,
          } = params;

          const baseLoan = compute_base_loan_amount(home_value, down_payment_value, down_payment_pct);
          const feeResult = apply_upfront_fee(
            baseLoan.loan_amount_base,
            clampNonNegative(upfront_fee_pct),
            finance_upfront_fee
          );
          const taxInfo = normalize_property_tax(property_tax_input, home_value);

          const tax_monthly = taxInfo.property_tax_yearly / MONTHS_IN_YEAR;
          const ins_monthly = clampNonNegative(homeowners_insurance_yearly) / MONTHS_IN_YEAR;
          const hoa = clampNonNegative(hoa_monthly);
          const n = Math.max(Math.round(clampNonNegative(term_years) * MONTHS_IN_YEAR), 0);
          const i_m = clampNonNegative(rate_apr) / MONTHS_IN_YEAR;
          const p_and_i = monthly_p_and_i(feeResult.principal_0, rate_apr, term_years);

          const loanType = typeof loan_type === "string" ? loan_type : "conventional";
          const pmiPct = clampNonNegative(pmi_pct);
          const annualMiPct = clampNonNegative(annual_mi_pct);

          const amortization = amortize_monthly(
            feeResult.principal_0,
            i_m,
            n,
            start_month,
            start_year,
            tax_monthly,
            ins_monthly,
            hoa,
            home_value,
            loanType,
            pmiPct,
            annualMiPct,
            p_and_i,
            extra_principal_monthly,
            extra_start_month_index
          );

          const monthly_mi_initial = monthly_mi(feeResult.principal_0, loanType, home_value, pmiPct, annualMiPct);

          const totalsSummary = summarize_outputs(
            amortization.schedule,
            amortization.totals,
            p_and_i,
            tax_monthly,
            ins_monthly,
            hoa,
            feeResult.principal_0,
            monthly_mi_initial
          );

          return {
            inputs: {
              loan_type: loanType,
              home_value: clampNonNegative(home_value),
              down_payment_value: baseLoan.down_payment_value,
              down_payment_pct: baseLoan.down_payment_pct,
              rate_apr: clampNonNegative(rate_apr),
              term_years: clampNonNegative(term_years),
              start_month: normalizeMonth(start_month),
              start_year: normalizeYear(start_year),
              property_tax_input: clampNonNegative(property_tax_input),
              homeowners_insurance_yearly: clampNonNegative(homeowners_insurance_yearly),
              hoa_monthly: hoa,
              upfront_fee_pct: clampNonNegative(upfront_fee_pct),
              annual_mi_pct: annualMiPct,
              finance_upfront_fee: Boolean(finance_upfront_fee),
              extra_principal_monthly: clampNonNegative(extra_principal_monthly),
              extra_start_month_index: Math.max(Math.round(toNumber(extra_start_month_index)), 0),
              pmi_pct: pmiPct,
            },
            derived: {
              loan_amount_base: baseLoan.loan_amount_base,
              principal_0: feeResult.principal_0,
              upfront_fee: feeResult.upfront_fee,
              cash_at_close_upfront_fee: feeResult.cash_at_close_upfront_fee,
              property_tax_yearly: taxInfo.property_tax_yearly,
              property_tax_mode: taxInfo.property_tax_mode,
              tax_monthly,
              ins_monthly,
              hoa_monthly: hoa,
              p_and_i,
              monthly_mi_initial,
              total_monthly_0: totalsSummary.total_monthly_0,
            },
            payoff_date: totalsSummary.payoff_date,
            totals: {
              total_interest: totalsSummary.total_interest,
              total_tax: totalsSummary.total_tax,
              total_ins: totalsSummary.total_ins,
              total_hoa: totalsSummary.total_hoa,
              total_mi: totalsSummary.total_mi,
              total_of_payments: totalsSummary.total_of_payments,
              total_principal: totalsSummary.total_principal,
              payments_made: totalsSummary.payments_made,
            },
            schedule: totalsSummary.schedule,
          };
        }

        const mortgageCalculator = Object.freeze({
          compute_base_loan_amount,
          apply_upfront_fee,
          normalize_property_tax,
          monthly_p_and_i,
          monthly_mi,
          amortize_monthly,
          summarize_outputs,
          calculate_mortgage,
        });

        globalThis.mortgageCalculator = mortgageCalculator;

        const $ = (id) => document.getElementById(id);
        const formatCurrency = (value) =>
          clampNonNegative(value).toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
          });

        const formatCompactCurrency = (value) =>
          clampNonNegative(value).toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
            notation: "compact",
          });

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        const baseDefaults = {
          loan_type: "conventional",
          home_value: 450000,
          down_payment_value: 90000,
          rate_apr: 6.75,
          term_years: 30,
          start_month: 2,
          start_year: new Date().getFullYear(),
          property_tax_input: 1.05,
          homeowners_insurance_yearly: 1500,
          hoa_monthly: 0,
          upfront_fee_pct: 0,
          annual_mi_pct: 0,
          finance_upfront_fee: false,
          extra_principal_monthly: 0,
          extra_start_month_index: 0,
          pmi_pct: 0.5,
        };

        const programDefaults = {
          conventional: { pmi_pct: 0.5, upfront_fee_pct: 0, annual_mi_pct: 0, finance_upfront_fee: false },
          FHA: { pmi_pct: 0, upfront_fee_pct: 1.75, annual_mi_pct: 0.85, finance_upfront_fee: true },
          VA: { pmi_pct: 0, upfront_fee_pct: 2.3, annual_mi_pct: 0, finance_upfront_fee: true },
          USDA: { pmi_pct: 0, upfront_fee_pct: 1.0, annual_mi_pct: 0.35, finance_upfront_fee: true },
        };

        const inputs = {
          loan_type: $("loan_type"),
          home_value: $("home_value"),
          down_payment_value: $("down_payment_value"),
          rate_apr: $("rate_apr"),
          term_years: $("term_years"),
          start_month: $("start_month"),
          start_year: $("start_year"),
          property_tax_input: $("property_tax_input"),
          homeowners_insurance_yearly: $("homeowners_insurance_yearly"),
          hoa_monthly: $("hoa_monthly"),
          pmi_pct: $("pmi_pct"),
          upfront_fee_pct: $("upfront_fee_pct"),
          annual_mi_pct: $("annual_mi_pct"),
          finance_upfront_fee: $("finance_upfront_fee"),
          extra_principal_monthly: $("extra_principal_monthly"),
          extra_start_month_index: $("extra_start_month_index"),
        };

        const miVisibilityPrograms = new Set(["FHA", "USDA"]);
        const miOnlyElements = Array.from(document.querySelectorAll("[data-mi-only]"));

        const updateMiVisibility = () => {
          const program = inputs.loan_type.value;
          const show = miVisibilityPrograms.has(program);
          miOnlyElements.forEach((el) => {
            el.classList.toggle("is-hidden", !show);
          });
        };

        const percentInputIds = ["rate_apr", "pmi_pct", "upfront_fee_pct", "annual_mi_pct"];
        const percentInputSet = new Set(percentInputIds);

        const formatPercentValue = (value) => {
          const num = toNumber(value);
          if (!Number.isFinite(num)) return "";
          return num.toFixed(2);
        };

        const normalizePercentInput = (el) => {
          if (!el) return;
          const formatted = formatPercentValue(el.value);
          if (formatted !== "") {
            el.value = formatted;
          }
        };

        const normalizePercentInputs = () => {
          percentInputIds.forEach((id) => normalizePercentInput(inputs[id]));
        };

        const outputs = {
          total_monthly_0: $("total_monthly_0"),
          p_and_i: $("p_and_i"),
          total_interest: $("total_interest"),
          payoff_date: $("payoff_date"),
          interest_hint: $("interest_hint"),
          term_hint: $("term_hint"),
          totalsBreakdown: $("totalsBreakdown"),
          schedulePreview: $("schedulePreview"),
          scheduleNote: $("scheduleNote"),
        };
        const monthlyPaymentCard = $("monthlyPaymentCard");
        const carousel = {
          track: $("resultTrack"),
          prev: $("cardPrev"),
          next: $("cardNext"),
          slides: Array.from(document.querySelectorAll(".carousel-slide")),
          index: 0,
        };
        const fieldMessages = Array.from(document.querySelectorAll(".field-message"));

        const clearFieldErrors = () => {
          fieldMessages.forEach((span) => {
            span.textContent = "";
            const label = span.closest("label");
            if (label) label.classList.remove("has-error");
          });
        };

        const setFieldError = (fieldId, message) => {
          const span = document.querySelector(`[data-field-error="${fieldId}"]`);
          if (!span) return;
          span.textContent = message;
          const label = span.closest("label");
          if (label) label.classList.add("has-error");
        };

        const emitTelemetry = (event, detail = {}) => {
          try {
            if (window?.openai?.trackEvent) {
              window.openai.trackEvent(event, detail);
              return;
            }
          } catch (err) {
            console.debug("trackEvent failed", err);
          }
          console.debug(`[mortgage-telemetry] ${event}`, detail);
        };

        const validateInputs = () => {
          clearFieldErrors();
          const issues = [];

          const homeValue = toNumber(inputs.home_value.value);
          if (homeValue <= 0) {
            setFieldError("home_value", "Enter a home value above 0");
            issues.push("home_value");
          }

          const downPaymentValue = toNumber(inputs.down_payment_value.value);
          if (downPaymentValue < 0) {
            setFieldError("down_payment_value", "Cannot be negative");
            issues.push("down_payment_value");
          } else if (homeValue > 0 && downPaymentValue > homeValue) {
            setFieldError("down_payment_value", "Cannot exceed home value");
            issues.push("down_payment_value");
          }

          const rateApr = toNumber(inputs.rate_apr.value);
          if (rateApr < 0) {
            setFieldError("rate_apr", "Rate cannot be negative");
            issues.push("rate_apr");
          }

          const termYears = toNumber(inputs.term_years.value);
          if (termYears < 1) {
            setFieldError("term_years", "Must be at least 1 year");
            issues.push("term_years");
          }

          const startMonth = toNumber(inputs.start_month.value);
          if (startMonth && (startMonth < 1 || startMonth > 12)) {
            setFieldError("start_month", "Use a month between 1 and 12");
            issues.push("start_month");
          }

          const startYear = toNumber(inputs.start_year.value);
          if (startYear && startYear < 1900) {
            setFieldError("start_year", "Year looks too early");
            issues.push("start_year");
          }

          if (issues.length) {
            emitTelemetry("validation_error", { fields: issues });
            return false;
          }

          return true;
        };

        const setDefaults = (preset = baseDefaults) => {
          Object.entries(preset).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          normalizePercentInputs();
          updateMiVisibility();
          clearFieldErrors();
        };

        const mergeProgramDefaults = () => {
          const program = inputs.loan_type.value;
          const defaults = programDefaults[program];
          if (!defaults) return;
          Object.entries(defaults).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              // Always update program-specific fields (pmi_pct, upfront_fee_pct, annual_mi_pct)
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          normalizePercentInputs();
        };

        const readParams = () => ({
          loan_type: inputs.loan_type.value,
          home_value: toNumber(inputs.home_value.value),
          down_payment_value: toNumber(inputs.down_payment_value.value),
          down_payment_pct: 0,
          rate_apr: toNumber(inputs.rate_apr.value) / 100,
          term_years: toNumber(inputs.term_years.value),
          start_month: toNumber(inputs.start_month.value),
          start_year: toNumber(inputs.start_year.value),
          property_tax_input: toNumber(inputs.property_tax_input.value),
          homeowners_insurance_yearly: toNumber(inputs.homeowners_insurance_yearly.value),
          hoa_monthly: toNumber(inputs.hoa_monthly.value),
          upfront_fee_pct: toNumber(inputs.upfront_fee_pct.value) / 100,
          annual_mi_pct: toNumber(inputs.annual_mi_pct.value) / 100,
          finance_upfront_fee: Boolean(inputs.finance_upfront_fee.checked),
          extra_principal_monthly: toNumber(inputs.extra_principal_monthly.value),
          extra_start_month_index: toNumber(inputs.extra_start_month_index.value),
          pmi_pct: toNumber(inputs.pmi_pct.value) / 100,
        });

        const divideSafe = (numerator, denominator) =>
          denominator === 0 ? 0 : numerator / denominator;

        const renderSummary = (calc) => {
          const { inputs: normalized, derived, totals, payoff_date } = calc;
          const monthsElapsed = totals.payments_made || 0;
          const yearsElapsed = divideSafe(monthsElapsed, 12);
          const payoffLabel = payoff_date
            ? `${monthNames[normalizeMonth(payoff_date.month) - 1]} ${payoff_date.year}`
            : "‚Äî";

          const monthlyPaymentEl = outputs.total_monthly_0;
          monthlyPaymentEl.textContent = formatCurrency(derived.total_monthly_0);
          if (monthlyPaymentCard) {
            monthlyPaymentCard.classList.remove("glow-animate");
            void monthlyPaymentCard.offsetWidth;
            monthlyPaymentCard.classList.add("glow-animate");
          }
          outputs.p_and_i.textContent = formatCurrency(derived.p_and_i);
          outputs.total_interest.textContent = formatCurrency(totals.total_interest);
          outputs.payoff_date.textContent = payoffLabel;

          const totalExtraPrincipal = calc.schedule.reduce((sum, row) => sum + row.extra_principal, 0);

          outputs.interest_hint.textContent = `Totals include ${formatCurrency(
            totals.total_principal - totalExtraPrincipal
          )} scheduled principal and ${formatCurrency(totalExtraPrincipal)} extra payments.`;

          outputs.term_hint.textContent = `Original term ${normalized.term_years} yrs ‚Äî paid off in ${yearsElapsed.toFixed(
            1
          )} yrs (${monthsElapsed} months).`;

          outputs.totalsBreakdown.innerHTML = `
            <div class="totals-item">
              <span class="label">Tax & insurance</span>
              <span class="value">${formatCurrency(totals.total_tax + totals.total_ins)}</span>
            </div>
            <div class="totals-item">
              <span class="label">Mortgage insurance</span>
              <span class="value">${formatCurrency(totals.total_mi)}</span>
            </div>
            <div class="totals-item">
              <span class="label">HOA dues</span>
              <span class="value">${formatCurrency(totals.total_hoa)}</span>
            </div>
            <div class="totals-item">
              <span class="label">Total paid</span>
              <span class="value">${formatCurrency(totals.total_of_payments)}</span>
            </div>
          `;

          const previewRows = calc.schedule.slice(0, 12);
          if (previewRows.length) {
            const rows = previewRows
              .map((row) => {
                const monthLabel = `${monthNames[row.date.month - 1].slice(0, 3)} ${row.date.year}`;
                return `
                  <tr>
                    <td class="label">${row.index + 1}</td>
                    <td>${monthLabel}</td>
                    <td>${formatCurrency(row.total_payment)}</td>
                    <td>${formatCurrency(row.principal_scheduled + row.extra_principal)}</td>
                    <td>${formatCurrency(row.interest)}</td>
                    <td>${formatCurrency(row.closing_balance)}</td>
                  </tr>`;
              })
              .join("");

            outputs.schedulePreview.innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th class="label">Month</th>
                    <th>Payment</th>
                    <th>Principal</th>
                    <th>Interest</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            `;
            outputs.scheduleNote.textContent = `Showing first ${previewRows.length} of ${calc.schedule.length} months.`;
          } else {
            outputs.schedulePreview.innerHTML = "";
            outputs.scheduleNote.textContent = "Enter loan details to view amortization.";
          }
        };

        const breakdownInputs = {
          tax: $("breakdown_tax_input"),
          ins: $("breakdown_ins_input"),
          hoa: $("breakdown_hoa_input"),
        };

        const breakdownOutputs = {
          p_and_i: $("breakdown_p_and_i"),
          tax: $("breakdown_tax"),
          ins: $("breakdown_ins"),
          hoa: $("breakdown_hoa"),
          mi: $("breakdown_mi"),
          mi_row: $("breakdown_mi_row"),
          chartTotal: $("chartTotal"),
          canvas: $("breakdownChart"),
        };

        const fitCanvasToParent = (canvas) => {
          const rect = canvas.getBoundingClientRect();
          const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
          const size = Math.max(140, Math.round(rect.width * dpr));
          if (canvas.width !== size || canvas.height !== size) {
            canvas.width = size;
            canvas.height = size;
          }
        };

        const drawDonutChart = (ctx, data, colors) => {
          const canvas = ctx.canvas;
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2;
          const radius = Math.min(canvas.width, canvas.height) * 0.42;
          const holeRadius = radius * 0.76;

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          const total = data.reduce((sum, val) => sum + val, 0);
          if (total === 0) return;

          let currentAngle = -Math.PI / 2;

          data.forEach((value, index) => {
            const sliceAngle = (value / total) * 2 * Math.PI;
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
            ctx.arc(centerX, centerY, holeRadius, currentAngle + sliceAngle, currentAngle, true);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(centerX - radius, centerY - radius, centerX + radius, centerY + radius);
            gradient.addColorStop(0, colors[index][0]);
            gradient.addColorStop(1, colors[index][1]);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            currentAngle += sliceAngle;
          });
        };

        const renderBreakdown = (calc) => {
          const { derived } = calc;
          
          if (!breakdownOutputs.canvas) return;
          
          const tax_monthly = derived.tax_monthly;
          const ins_monthly = derived.ins_monthly;
          const hoa_monthly = derived.hoa_monthly;
          const p_and_i = derived.p_and_i;
          const mi = derived.monthly_mi_initial;
          
          const total = p_and_i + tax_monthly + ins_monthly + hoa_monthly + mi;
          
          if (breakdownOutputs.p_and_i) {
            breakdownOutputs.p_and_i.textContent = formatCurrency(p_and_i);
          }
          
          if (breakdownOutputs.tax) {
            breakdownOutputs.tax.textContent = formatCurrency(tax_monthly);
          }
          if (breakdownOutputs.ins) {
            breakdownOutputs.ins.textContent = formatCurrency(ins_monthly);
          }
          if (breakdownOutputs.hoa) {
            breakdownOutputs.hoa.textContent = formatCurrency(hoa_monthly);
          }
          if (breakdownOutputs.mi) {
            breakdownOutputs.mi.textContent = formatCurrency(mi);
          }
          if (breakdownOutputs.mi_row) {
            const miHidden = mi <= 0;
            breakdownOutputs.mi_row.classList.toggle("is-hidden", miHidden);
            const listEl = document.getElementById("breakdown_list");
            if (listEl) {
              const rows = miHidden ? 4 : 5;
              listEl.style.setProperty("--rows", String(rows));
            }
          }
          
          if (breakdownOutputs.chartTotal) {
            breakdownOutputs.chartTotal.innerHTML = `${formatCurrency(total)}<span>/mo</span>`;
          }
          
          fitCanvasToParent(breakdownOutputs.canvas);
          const ctx = breakdownOutputs.canvas.getContext("2d");
          const data = [p_and_i, tax_monthly, ins_monthly, hoa_monthly];
          if (mi > 0) data.push(mi);
          
          const colors = [
            // P&I ‚Äî cyan
            ["rgba(14, 165, 233, 0.95)", "rgba(56, 189, 248, 0.85)"],
            // Tax ‚Äî indigo/violet
            ["rgba(99, 102, 241, 0.95)", "rgba(139, 92, 246, 0.85)"],
            // Insurance ‚Äî fuchsia/purple (distinct from tax)
            ["rgba(168, 85, 247, 0.95)", "rgba(217, 70, 239, 0.85)"],
            // HOA ‚Äî teal/emerald
            ["rgba(20, 184, 166, 0.95)", "rgba(45, 212, 191, 0.85)"],
            // MI (optional) ‚Äî blue
            ["rgba(59, 130, 246, 0.95)", "rgba(96, 165, 250, 0.85)"],
          ];
          
          drawDonutChart(ctx, data, colors);
          // Constrain list to match chart height (fluid, computed per render)
          const listEl = document.getElementById("breakdown_list");
          if (listEl) {
            const chartH = breakdownOutputs.canvas.getBoundingClientRect().height;
            listEl.style.height = `${Math.max(160, Math.round(chartH))}px`;
          }
        };

        const syncBreakdownToMain = () => {
          if (breakdownInputs.tax && inputs.property_tax_input) {
            const monthlyTax = toNumber(breakdownInputs.tax.value);
            const yearlyTax = monthlyTax * 12;
            inputs.property_tax_input.value = yearlyTax.toFixed(2);
          }
          
          if (breakdownInputs.ins && inputs.homeowners_insurance_yearly) {
            const monthlyIns = toNumber(breakdownInputs.ins.value);
            const yearlyIns = monthlyIns * 12;
            inputs.homeowners_insurance_yearly.value = Math.round(yearlyIns);
          }
          
          if (breakdownInputs.hoa && inputs.hoa_monthly) {
            inputs.hoa_monthly.value = Math.round(toNumber(breakdownInputs.hoa.value));
          }
        };

        const calculateAndRender = () => {
          if (!validateInputs()) {
            return;
          }
          const params = readParams();
          const calc = mortgageCalculator.calculate_mortgage(params);
          renderSummary(calc);
          renderBreakdown(calc);
        };

        const CAROUSEL_STORAGE_KEY = "mortgage-carousel-index";
        const persistCarouselIndex = () => {
          try {
            sessionStorage.setItem(CAROUSEL_STORAGE_KEY, String(carousel.index));
          } catch (err) {
            console.debug("Unable to persist carousel index", err);
          }
        };

        const loadCarouselIndex = () => {
          try {
            const stored = sessionStorage.getItem(CAROUSEL_STORAGE_KEY);
            if (stored !== null) {
              const parsed = Number(stored);
              if (!Number.isNaN(parsed)) {
                carousel.index = parsed;
              }
            }
          } catch (err) {
            console.debug("Unable to load carousel index", err);
          }
        };

        let lastCarouselIndex = carousel.index;
        let isInitialCarouselSync = true;
        const updateCarousel = () => {
          if (!carousel.track) return;
          const clamped = Math.max(0, Math.min(carousel.index, carousel.slides.length - 1));
          const changed = clamped !== lastCarouselIndex;
          carousel.index = clamped;
          const viewportWidth = carousel.track.parentElement ? carousel.track.parentElement.getBoundingClientRect().width : 0;
          carousel.track.style.transform = `translateX(${-(clamped * viewportWidth)}px)`;

          if (carousel.prev) {
            const disabled = clamped === 0;
            carousel.prev.disabled = disabled;
            carousel.prev.setAttribute("aria-disabled", String(disabled));
          }
          if (carousel.next) {
            const disabled = clamped === carousel.slides.length - 1;
            carousel.next.disabled = disabled;
            carousel.next.setAttribute("aria-disabled", String(disabled));
          }

          // Reflect visible slide for screen readers
          carousel.slides.forEach((slide, idx) => {
            const isCurrent = idx === clamped;
            slide.setAttribute("aria-hidden", String(!isCurrent));
            if (isCurrent) slide.setAttribute("aria-current", "true");
            else slide.removeAttribute("aria-current");
          });

          persistCarouselIndex();

          // Persist widget state in host if available
          try {
            if (window?.openai?.setWidgetState) {
              window.openai.setWidgetState({ carouselIndex: clamped });
            }
          } catch (_) {
            /* ignore */
          }

          if (!isInitialCarouselSync && changed) {
            const cardId = carousel.slides[clamped]?.dataset.card || "unknown";
            emitTelemetry("carousel_navigated", { index: clamped, card: cardId });
          }
          lastCarouselIndex = clamped;
          if (isInitialCarouselSync) {
            isInitialCarouselSync = false;
          }
        };

        const moveCarousel = (delta) => {
          carousel.index += delta;
          updateCarousel();
        };

        if (carousel.prev) {
          carousel.prev.addEventListener("click", () => moveCarousel(-1));
        }

        if (carousel.next) {
          carousel.next.addEventListener("click", () => moveCarousel(1));
        }

        const resetButton = $("resetBtn");
        if (resetButton) {
          resetButton.addEventListener("click", () => {
            setDefaults(baseDefaults);
            mergeProgramDefaults();
            calculateAndRender();
          });
        }

        const recalcButton = $("calculateBtn");
        if (recalcButton) {
          recalcButton.addEventListener("click", calculateAndRender);
        }

        const notifyBtn = $("ratesNotifyBtn");
        if (notifyBtn) {
          notifyBtn.addEventListener("click", async () => {
            emitTelemetry("rates_notify_clicked");
            const email = window.prompt("Enter your email to get rate‚Äëdrop alerts:");
            if (!email) return;
            try {
              const res = await fetch("/api/subscribe", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email,
                  settlementId: "mortgage_rates",
                  settlementName: "Mortgage Rates",
                  deadline: null,
                  turnstileToken: "auto-verified-fallback",
                }),
              });
              const data = await res.json().catch(() => ({}));
              if (res.ok && data && data.success) {
                emitTelemetry("rates_notify_subscribed", { email_domain: email.split("@")[1] || "unknown" });
                window.alert(data.message || "You are subscribed.");
              } else {
                const msg = (data && (data.error || data.message)) || "Subscription failed.";
                emitTelemetry("rates_notify_failed", { error: msg });
                window.alert(msg);
              }
            } catch (e) {
              emitTelemetry("rates_notify_failed", { error: String(e) });
              window.alert("Subscription failed.");
            }
          });
        }

        async function loadAvgRate() {
          const valueEl = $("avgRateValue");
          if (!valueEl) return;
          try {
            const res = await fetch("/api/avg-rate", { method: "GET" });
            const data = await res.json().catch(() => ({}));
            const rate = data && typeof data.rate === "number" && isFinite(data.rate) ? data.rate : null;
            if (rate !== null) {
              const pct = (Math.round(rate * 10) / 10).toFixed(1) + "%";
              valueEl.textContent = pct;
              emitTelemetry("avg_rate_loaded", { rate, series: data.series || "MORTGAGE30US", date: data.date || null });
            } else {
              valueEl.textContent = "‚Äî";
              emitTelemetry("avg_rate_unavailable");
            }
          } catch (err) {
            emitTelemetry("avg_rate_unavailable", { error: String(err) });
          }
        }

        inputs.loan_type.addEventListener("change", () => {
          mergeProgramDefaults();
          calculateAndRender();
        });

        loadCarouselIndex();
        updateMiVisibility();
        updateCarousel();
        let resizeRaf = 0;
        loadAvgRate();
        window.addEventListener("resize", () => {
          if (resizeRaf) cancelAnimationFrame(resizeRaf);
          resizeRaf = requestAnimationFrame(() => {
            updateCarousel();
            const breakdownSlide = document.querySelector('.carousel-slide[data-card="breakdown"]');
            const isBreakdownVisible = breakdownSlide && breakdownSlide.getAttribute('aria-hidden') === 'false';
            if (isBreakdownVisible) {
              if (breakdownOutputs.canvas) fitCanvasToParent(breakdownOutputs.canvas);
              const params = readParams();
              const calc = mortgageCalculator.calculate_mortgage(params);
              renderBreakdown(calc);
            }
          });
        });

        const carouselWindowEl = document.querySelector(".carousel-window");
        let pointerStartX = null;
        const SWIPE_THRESHOLD = 30;

        if (carouselWindowEl) {
          carouselWindowEl.addEventListener("pointerdown", (event) => {
            if (event.pointerType === "touch" || event.pointerType === "pen") {
              pointerStartX = event.clientX;
            }
          });

          const handlePointerEnd = (event) => {
            if (pointerStartX === null) return;
            const deltaX = event.clientX - pointerStartX;
            if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
              moveCarousel(deltaX < 0 ? 1 : -1);
            }
            pointerStartX = null;
          };

          carouselWindowEl.addEventListener("pointerup", handlePointerEnd);
          carouselWindowEl.addEventListener("pointercancel", () => {
            pointerStartX = null;
          });
        }

        document.addEventListener("keydown", (event) => {
          const target = event.target;
          if (target && ["INPUT", "SELECT", "TEXTAREA"].includes(target.tagName)) {
            return;
          }

          if (event.key === "ArrowLeft") {
            event.preventDefault();
            moveCarousel(-1);
          } else if (event.key === "ArrowRight") {
            event.preventDefault();
            moveCarousel(1);
          }
        });

        Object.values(inputs).forEach((el) => {
          const handler = () => {
            if (percentInputSet.has(el.id)) {
              normalizePercentInput(el);
            }
            calculateAndRender();
          };
          el.addEventListener("change", handler);
          if (el.tagName === "INPUT" && el.type === "number") {
            el.addEventListener("keyup", (evt) => {
              if (evt.key === "Enter") handler();
            });
          }
        });

        // Breakdown list is read-only; no input listeners needed.

        setDefaults(baseDefaults);
        mergeProgramDefaults();
        calculateAndRender();

        // Component loaded telemetry (Apps SDK guidance)
        emitTelemetry("component_loaded", { slides: carousel.slides.length });
      })();
    </script>
  </body>
</html>
