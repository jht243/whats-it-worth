<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mortgage Calculator Widget</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      body {
        margin: 0;
        padding: 28px;
        display: flex;
        justify-content: center;
        background: radial-gradient(circle at top, #1f2937, #090d16 70%);
        color: #f9fafb;
      }

      .app {
        width: min(900px, 100%);
        background: rgba(13, 20, 34, 0.92);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 18px;
        padding: 28px;
        box-shadow: 0 24px 70px rgba(8, 12, 23, 0.6);
        backdrop-filter: blur(14px);
        display: grid;
        gap: 24px;
      }

      header h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      header p {
        margin: 8px 0 0;
        color: rgba(226, 232, 240, 0.75);
        font-size: 14px;
      }

      .section-title {
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.16em;
        color: rgba(226, 232, 240, 0.72);
        text-transform: uppercase;
        margin-bottom: 16px;
      }

      .section-summary {
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.16em;
        color: rgba(226, 232, 240, 0.72);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .section-summary::after {
        content: "";
        width: 10px;
        height: 10px;
        border-right: 2px solid rgba(226, 232, 240, 0.58);
        border-bottom: 2px solid rgba(226, 232, 240, 0.58);
        transform: rotate(45deg);
        margin-left: auto;
        transition: transform 0.24s ease, border-color 0.24s ease;
      }

      details[open] .section-summary::after {
        transform: rotate(-135deg);
      }

      .section-summary:hover::after,
      .section-summary:focus-visible::after {
        border-color: #38bdf8;
      }

      .collapsible-content {
        padding: 0 20px 20px;
        margin-top: 0;
      }

      .section-block {
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.24);
        background: rgba(10, 16, 28, 0.58);
        padding: 20px;
        display: grid;
        gap: 16px;
      }

      details.section-block {
        padding: 0;
      }

      details.section-block > summary {
        padding: 20px;
      }

      details.section-block > .collapsible-content {
        padding-bottom: 20px;
      }

      .grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .is-hidden {
        display: none !important;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.68);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .percent-field {
        position: relative;
      }

      .percent-field input[type="number"] {
        padding-right: 32px;
      }

      .percent-field::after {
        content: "%";
        position: absolute;
        right: 4px;
        top: 34px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.5);
        pointer-events: none;
      }

      input[type="number"],
      input[type="text"],
      select {
        border: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 0;
        background: transparent;
        color: #f9fafb;
        font-size: 16px;
        padding: 8px 4px;
        transition: border-color 0.2s ease, color 0.2s ease;
      }

      input::placeholder {
        color: rgba(226, 232, 240, 0.38);
      }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-bottom-color: #38bdf8;
        color: #f9fafb;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.24);
        background: rgba(11, 18, 32, 0.35);
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        row-gap: 20px;
      }

      .result-carousel {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: stretch;
        gap: 16px;
      }

      .carousel-nav {
        width: 36px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.24);
        background: rgba(10, 16, 28, 0.65);
        color: rgba(226, 232, 240, 0.72);
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
      }

      .carousel-nav[disabled] {
        opacity: 0.35;
        cursor: default;
      }

      .carousel-nav:not([disabled]):hover,
      .carousel-nav:not([disabled]):focus-visible {
        background: rgba(30, 64, 175, 0.35);
        border-color: rgba(56, 189, 248, 0.45);
        color: #38bdf8;
        outline: none;
      }

      .carousel-window {
        overflow: hidden;
        border-radius: 18px;
      }

      .carousel-track {
        display: flex;
        width: 100%;
        transition: transform 0.35s ease-in-out;
      }

      .carousel-slide {
        min-width: 100%;
        padding: 6px 0;
        display: flex;
        justify-content: center;
      }

      .slide-content {
        width: 100%;
        display: grid;
        gap: 24px;
      }

      .slide-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      .slide-header p {
        margin: 8px 0 0;
        color: rgba(226, 232, 240, 0.65);
        font-size: 14px;
      }

      .result-card {
        border-radius: 14px;
        padding: 18px;
        background: rgba(11, 18, 32, 0.65);
        border: 1px solid rgba(148, 163, 184, 0.18);
        display: grid;
        gap: 8px;
      }

      .result-card .label {
        font-size: 11px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(226, 232, 240, 0.5);
      }

      .result-card .value {
        font-size: 20px;
        font-weight: 500;
      }

      .result-card .hint {
        font-size: 13px;
        color: rgba(226, 232, 240, 0.5);
      }

      .result-card.primary {
        grid-column: 1 / -1;
        padding: 26px;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.28), rgba(17, 24, 39, 0.85));
        border: 1px solid rgba(37, 99, 235, 0.35);
        box-shadow: 0 18px 48px rgba(30, 64, 175, 0.3);
      }

      .result-card.primary .label {
        color: rgba(226, 232, 240, 0.78);
        font-size: 12px;
        letter-spacing: 0.12em;
      }

      .result-card.primary .value {
        font-size: 44px;
        font-weight: 700;
        line-height: 1.1;
      }

      .result-card.secondary {
        background: rgba(11, 18, 32, 0.5);
        border-color: rgba(148, 163, 184, 0.15);
        padding: 16px;
      }

      .result-card.secondary .value,
      .result-card.secondary .hint {
        font-size: 13px;
        font-weight: 400;
      }

      .result-card.secondary .value {
        color: rgba(226, 232, 240, 0.8);
      }

      .actions {
        display: flex;
        justify-content: flex-end;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.5);
        gap: 12px;
      }

      .actions button {
        background: none;
        border: none;
        color: inherit;
        padding: 0;
        font: inherit;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      #calculateBtn {
        display: none;
      }

      .summary {
        border-radius: 14px;
        padding: 18px;
        border: 1px solid rgba(148, 163, 184, 0.16);
        background: rgba(11, 18, 32, 0.55);
        color: rgba(226, 232, 240, 0.82);
        font-size: 14px;
        line-height: 1.7;
      }

      .summary strong {
        color: #f9fafb;
      }

      details summary {
        cursor: pointer;
        outline: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        font-size: 13px;
      }

      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        text-align: right;
      }

      th {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.6);
      }

      td.label {
        text-align: left;
      }

      .schedule-note {
        margin-top: 10px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.6);
      }

      @keyframes glow {
        0% {
          box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
        40% {
          box-shadow: 0 0 48px rgba(56, 189, 248, 0.45);
        }
        100% {
          box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
      }

      .glow-animate {
        animation: glow 1s ease-in-out;
      }

      @media (max-width: 560px) {
        body {
          padding: 18px;
        }

        .app {
          padding: 22px;
        }

        button {
          flex: 1 1 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <section class="result-carousel">
        <button class="carousel-nav" id="cardPrev" aria-label="Previous card">&#x2039;</button>
        <div class="carousel-window">
          <div class="carousel-track" id="resultTrack">
            <div class="carousel-slide" data-card="summary">
              <div class="slide-content">
                <header class="slide-header">
                  <h2>Mortgage Calculator</h2>
                  <p>Compare loan programs, see monthly costs, and preview payoff timing. Adjust the inputs to explore scenarios.</p>
                </header>

                <section class="section-block">
                  <div class="section-title">Loan basics</div>
                  <div class="grid">
                    <label>
                      Loan program
                      <select id="loan_type">
                        <option value="conventional">Conventional</option>
                        <option value="FHA">FHA</option>
                        <option value="VA">VA</option>
                        <option value="USDA">USDA</option>
                      </select>
                    </label>
                    <label>
                      Home value ($)
                      <input type="number" id="home_value" min="0" step="1000" />
                    </label>
                    <label>
                      Down payment ($)
                      <input type="number" id="down_payment_value" min="0" step="1000" />
                    </label>
                    <label class="percent-field">
                      Rate (APR %)
                      <input type="number" id="rate_apr" min="0" step="0.01" />
                    </label>
                    <label>
                      Term (years)
                      <input type="number" id="term_years" min="1" step="1" />
                    </label>
                  </div>
                </section>

                <details class="section-block collapsible" id="myInformation">
                  <summary class="section-summary">My information</summary>
                  <div class="collapsible-content">
                    <div class="grid">
                      <label>
                        ZIP code
                        <input type="text" id="zip_code" inputmode="numeric" pattern="\d*" maxlength="9" placeholder="e.g. 94043" />
                      </label>
                      <label>
                        Credit score
                        <select id="credit_score">
                          <option value="">Select</option>
                          <option value="760+">760+</option>
                          <option value="720-759">720-759</option>
                          <option value="680-719">680-719</option>
                          <option value="640-679">640-679</option>
                          <option value="600-639">600-639</option>
                          <option value="<600">Below 600</option>
                        </select>
                      </label>
                    </div>
                  </div>
                </details>

                <details class="section-block collapsible">
                  <summary class="section-summary">Property information</summary>
                  <div class="collapsible-content">
                    <div class="grid">
                      <label class="percent-field">
                        Property tax (% of value)
                        <input type="number" id="property_tax_input" min="0" step="0.01" />
                      </label>
                      <label>
                        Homeowners insurance ($/yr)
                        <input type="number" id="homeowners_insurance_yearly" min="0" step="50" />
                      </label>
                      <label>
                        HOA dues ($/mo)
                        <input type="number" id="hoa_monthly" min="0" step="10" />
                      </label>
                    </div>
                  </div>
                </details>

                <details class="section-block collapsible">
                  <summary class="section-summary">Mortgage insurance & fees</summary>
                  <div class="collapsible-content">
                    <div class="grid">
                      <label class="percent-field">
                        PMI (% annual, conventional)
                        <input type="number" id="pmi_pct" min="0" step="0.01" />
                      </label>
                      <label class="percent-field" data-mi-only>
                        Annual MI fee (% of balance)
                        <input type="number" id="annual_mi_pct" min="0" step="0.01" />
                      </label>
                      <label class="percent-field">
                        Upfront fee (% base loan)
                        <input type="number" id="upfront_fee_pct" min="0" step="0.01" />
                        <div class="checkbox-row" style="margin-top: 8px;">
                          <input type="checkbox" id="finance_upfront_fee" />
                          <span style="font-size: 12px; color: rgba(226, 232, 240, 0.72);">Add fee to principal balance</span>
                        </div>
                      </label>
                    </div>
                  </div>
                </details>

                <details class="section-block advanced-options">
                  <summary class="section-summary">Advanced options</summary>
                  <div class="collapsible-content">
                    <div class="grid">
                      <label>
                        First payment month
                        <input type="number" id="start_month" min="1" max="12" step="1" />
                      </label>
                      <label>
                        First payment year
                        <input type="number" id="start_year" min="2024" step="1" />
                      </label>
                      <label>
                        Extra payment ($/mo)
                        <input type="number" id="extra_principal_monthly" min="0" step="50" />
                      </label>
                      <label>
                        Extra starts at month index
                        <input type="number" id="extra_start_month_index" min="0" step="1" />
                      </label>
                    </div>
                  </div>
                </details>

                <div class="actions">
                  <span>Updates automatically as you edit.</span>
                  <button class="secondary" id="resetBtn" type="button">Reset defaults</button>
                </div>

                <div class="cards">
                  <div class="result-card primary" id="monthlyPaymentCard">
                    <span class="label">Monthly payment (month 0)</span>
                    <span class="value" id="total_monthly_0">$0</span>
                    <span class="hint">Includes P&I, MI, taxes, insurance, HOA (excludes extra principal).</span>
                  </div>
                  <div class="result-card secondary">
                    <span class="label">Scheduled principal & interest</span>
                    <span class="value" id="p_and_i">$0</span>
                    <span class="hint">Level payment before extra principal or add-ons.</span>
                  </div>
                  <div class="result-card secondary">
                    <span class="label">Total interest over loan</span>
                    <span class="value" id="total_interest">$0</span>
                    <span class="hint" id="interest_hint"></span>
                  </div>
                  <div class="result-card secondary">
                    <span class="label">Estimated payoff date</span>
                    <span class="value" id="payoff_date">—</span>
                    <span class="hint" id="term_hint"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="carousel-slide" data-card="amortization">
              <div class="slide-content">
                <header class="slide-header">
                  <h2>Amortization & totals</h2>
                  <p>Dig into the lifetime cost breakdown and the first year of the schedule.</p>
                </header>
                <details class="section-block" open>
                  <summary>Lifetime totals</summary>
                  <div id="totalsBreakdown" style="margin-top: 14px; font-size: 13px; line-height: 1.8;"></div>
                </details>
                <details class="section-block" open>
                  <summary>Schedule preview</summary>
                  <div id="schedulePreview"></div>
                  <div class="schedule-note" id="scheduleNote"></div>
                </details>
              </div>
            </div>
          </div>
        </div>
        <button class="carousel-nav" id="cardNext" aria-label="Next card">&#x203A;</button>
      </section>
    </div>

    <script type="module">
      (function () {
        const MONTHS_IN_YEAR = 12;
        const ZERO_TOLERANCE = 1e-8;

        const toNumber = (value) => {
          const num = Number(value);
          return Number.isFinite(num) ? num : 0;
        };

        const clampNonNegative = (value) => {
          const num = toNumber(value);
          return num < 0 ? 0 : num;
        };

        const normalizeMonth = (month) => {
          const m = Math.round(toNumber(month));
          if (Number.isNaN(m) || m <= 0) return 1;
          if (m > 12) {
            return ((m - 1) % 12) + 1;
          }
          return m;
        };

        const normalizeYear = (year) => {
          const y = Math.round(toNumber(year));
          return y > 0 ? y : new Date().getFullYear();
        };

        function compute_base_loan_amount(home_value, down_payment_value, down_payment_pct) {
          const hv = clampNonNegative(home_value);
          const dpValueInput = toNumber(down_payment_value);
          const dpPctInput = clampNonNegative(down_payment_pct);

          let loan_amount_base;
          let effectiveDpValue;
          let effectiveDpPct;

          // If both down payment fields provided, prefer down_payment_value
          if (dpValueInput > 0) {
            effectiveDpValue = Math.min(dpValueInput, hv); // Don't allow down payment > home value
            loan_amount_base = hv - effectiveDpValue;
            effectiveDpPct = hv > 0 ? effectiveDpValue / hv : 0;
          } else {
            effectiveDpPct = Math.min(dpPctInput, 1.0); // Don't allow down payment % > 100%
            effectiveDpValue = hv * effectiveDpPct;
            loan_amount_base = hv * (1 - effectiveDpPct);
          }

          return {
            loan_amount_base: clampNonNegative(loan_amount_base),
            down_payment_value: effectiveDpValue,
            down_payment_pct: effectiveDpPct,
          };
        }

        function apply_upfront_fee(loan_amount_base, upfront_fee_pct, finance_upfront_fee) {
          const base = clampNonNegative(loan_amount_base);
          const feePct = clampNonNegative(upfront_fee_pct);
          const upfront_fee = base * feePct;
          const financed = Boolean(finance_upfront_fee);
          const principal_0 = financed ? base + upfront_fee : base;
          const cash_at_close_upfront_fee = financed ? 0 : upfront_fee;

          return {
            principal_0,
            upfront_fee,
            cash_at_close_upfront_fee,
          };
        }

        function normalize_property_tax(property_tax_input, home_value) {
          const hv = clampNonNegative(home_value);
          const input = clampNonNegative(property_tax_input);

          if (input <= 20) {
            return {
              property_tax_yearly: hv * (input / 100),
              property_tax_mode: "percent",
            };
          }

          return {
            property_tax_yearly: input,
            property_tax_mode: "absolute",
          };
        }

        function monthly_p_and_i(principal_0, rate_apr, term_years) {
          const principal = clampNonNegative(principal_0);
          const termYears = clampNonNegative(term_years);
          const n = Math.max(Math.round(termYears * MONTHS_IN_YEAR), 0);

          if (n === 0 || principal === 0) {
            return 0;
          }

          const yearlyRate = clampNonNegative(rate_apr);
          const i_m = yearlyRate / MONTHS_IN_YEAR;

          if (i_m > 0) {
            const denominator = 1 - Math.pow(1 + i_m, -n);
            if (denominator === 0) {
              return principal / n;
            }
            return principal * i_m / denominator;
          } else {
            return principal / n;
          }
        }

        function monthly_mi(principal_t, loan_type, home_value, pmi_pct, annual_mi_pct) {
          const principal = clampNonNegative(principal_t);
          const hv = clampNonNegative(home_value);

          switch (loan_type) {
            case "conventional":
              if (hv === 0) return 0;
              const ltv = principal / hv;
              if (ltv <= 0.8) return 0;
              return (clampNonNegative(pmi_pct) / MONTHS_IN_YEAR) * principal;

            case "FHA":
              return (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR) * principal;

            case "VA":
              return 0;

            case "USDA":
              return (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR) * principal;

            default:
              return 0;
          }
        }

        const createStartDate = (start_month, start_year) =>
          new Date(normalizeYear(start_year), normalizeMonth(start_month) - 1, 1);

        const advanceOneMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 1);

        function amortize_monthly(
          principal_0,
          i_m,
          n,
          start_month,
          start_year,
          tax_monthly,
          ins_monthly,
          hoa_monthly,
          home_value,
          loan_type,
          pmi_pct,
          annual_mi_pct,
          p_and_i,
          extra_principal_monthly = 0,
          extra_start_month_index = 0
        ) {
          let principal = clampNonNegative(principal_0);
          let currentDate = createStartDate(start_month, start_year);
          const totalPeriods = Math.max(Math.round(toNumber(n)), 0);
          const extraStartIndex = Math.max(Math.round(toNumber(extra_start_month_index)), 0);

          const totals = {
            interest: 0,
            tax: 0,
            ins: 0,
            hoa: 0,
            mi: 0,
            principal: 0,
            payments: 0,
          };

          const schedule = [];

          for (let t = 0; t < totalPeriods && principal > ZERO_TOLERANCE; t += 1) {
            const interest = principal * clampNonNegative(i_m);
            const principal_sched = Math.max(p_and_i - interest, 0);

            const mi = monthly_mi(principal, loan_type, home_value, pmi_pct, annual_mi_pct);

            const tax = clampNonNegative(tax_monthly);
            const ins = clampNonNegative(ins_monthly);
            const hoa_v = clampNonNegative(hoa_monthly);

            const extra = t >= extraStartIndex ? clampNonNegative(extra_principal_monthly) : 0;

            const principal_reduction = principal_sched + extra;
            const principal_next = Math.max(principal - principal_reduction, 0);

            totals.interest += interest;
            totals.tax += tax;
            totals.ins += ins;
            totals.hoa += hoa_v;
            totals.mi += mi;
            totals.principal += principal_reduction;
            totals.payments += p_and_i + mi + tax + ins + hoa_v + extra;

            schedule.push({
              index: t,
              date: {
                year: currentDate.getFullYear(),
                month: currentDate.getMonth() + 1,
              },
              opening_balance: principal,
              p_and_i,
              interest,
              principal_scheduled: principal_sched,
              extra_principal: extra,
              mi,
              tax,
              ins,
              hoa: hoa_v,
              total_payment: p_and_i + mi + tax + ins + hoa_v + extra,
              closing_balance: principal_next,
            });

            principal = principal_next;
            currentDate = advanceOneMonth(currentDate);

            if (principal <= ZERO_TOLERANCE) {
              principal = 0;
              break;
            }
          }

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : {
                year: normalizeYear(start_year),
                month: normalizeMonth(start_month),
              };

          return { schedule, payoff_date, totals };
        }

        function summarize_outputs(schedule, totals, p_and_i, tax_monthly, ins_monthly, hoa, principal_0, mi0) {
          const total_monthly_0 = p_and_i + tax_monthly + ins_monthly + hoa + mi0;

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : null;

          return {
            total_monthly_0,
            payoff_date,
            total_interest: totals.interest,
            total_tax: totals.tax,
            total_ins: totals.ins,
            total_hoa: totals.hoa,
            total_mi: totals.mi,
            total_of_payments: totals.payments,
            total_principal: totals.principal,
            payments_made: schedule.length,
            schedule,
          };
        }

        function calculate_mortgage(params) {
          const {
            loan_type,
            home_value,
            down_payment_value,
            down_payment_pct,
            rate_apr,
            term_years,
            start_month,
            start_year,
            property_tax_input,
            homeowners_insurance_yearly,
            hoa_monthly,
            upfront_fee_pct,
            annual_mi_pct,
            finance_upfront_fee,
            extra_principal_monthly,
            extra_start_month_index,
            pmi_pct,
          } = params;

          const baseLoan = compute_base_loan_amount(home_value, down_payment_value, down_payment_pct);
          const feeResult = apply_upfront_fee(
            baseLoan.loan_amount_base,
            clampNonNegative(upfront_fee_pct),
            finance_upfront_fee
          );
          const taxInfo = normalize_property_tax(property_tax_input, home_value);

          const tax_monthly = taxInfo.property_tax_yearly / MONTHS_IN_YEAR;
          const ins_monthly = clampNonNegative(homeowners_insurance_yearly) / MONTHS_IN_YEAR;
          const hoa = clampNonNegative(hoa_monthly);
          const n = Math.max(Math.round(clampNonNegative(term_years) * MONTHS_IN_YEAR), 0);
          const i_m = clampNonNegative(rate_apr) / MONTHS_IN_YEAR;
          const p_and_i = monthly_p_and_i(feeResult.principal_0, rate_apr, term_years);

          const loanType = typeof loan_type === "string" ? loan_type : "conventional";
          const pmiPct = clampNonNegative(pmi_pct);
          const annualMiPct = clampNonNegative(annual_mi_pct);

          const amortization = amortize_monthly(
            feeResult.principal_0,
            i_m,
            n,
            start_month,
            start_year,
            tax_monthly,
            ins_monthly,
            hoa,
            home_value,
            loanType,
            pmiPct,
            annualMiPct,
            p_and_i,
            extra_principal_monthly,
            extra_start_month_index
          );

          const monthly_mi_initial = monthly_mi(feeResult.principal_0, loanType, home_value, pmiPct, annualMiPct);

          const totalsSummary = summarize_outputs(
            amortization.schedule,
            amortization.totals,
            p_and_i,
            tax_monthly,
            ins_monthly,
            hoa,
            feeResult.principal_0,
            monthly_mi_initial
          );

          return {
            inputs: {
              loan_type: loanType,
              home_value: clampNonNegative(home_value),
              down_payment_value: baseLoan.down_payment_value,
              down_payment_pct: baseLoan.down_payment_pct,
              rate_apr: clampNonNegative(rate_apr),
              term_years: clampNonNegative(term_years),
              start_month: normalizeMonth(start_month),
              start_year: normalizeYear(start_year),
              property_tax_input: clampNonNegative(property_tax_input),
              homeowners_insurance_yearly: clampNonNegative(homeowners_insurance_yearly),
              hoa_monthly: hoa,
              upfront_fee_pct: clampNonNegative(upfront_fee_pct),
              annual_mi_pct: annualMiPct,
              finance_upfront_fee: Boolean(finance_upfront_fee),
              extra_principal_monthly: clampNonNegative(extra_principal_monthly),
              extra_start_month_index: Math.max(Math.round(toNumber(extra_start_month_index)), 0),
              pmi_pct: pmiPct,
            },
            derived: {
              loan_amount_base: baseLoan.loan_amount_base,
              principal_0: feeResult.principal_0,
              upfront_fee: feeResult.upfront_fee,
              cash_at_close_upfront_fee: feeResult.cash_at_close_upfront_fee,
              property_tax_yearly: taxInfo.property_tax_yearly,
              property_tax_mode: taxInfo.property_tax_mode,
              tax_monthly,
              ins_monthly,
              hoa_monthly: hoa,
              p_and_i,
              monthly_mi_initial,
              total_monthly_0: totalsSummary.total_monthly_0,
            },
            payoff_date: totalsSummary.payoff_date,
            totals: {
              total_interest: totalsSummary.total_interest,
              total_tax: totalsSummary.total_tax,
              total_ins: totalsSummary.total_ins,
              total_hoa: totalsSummary.total_hoa,
              total_mi: totalsSummary.total_mi,
              total_of_payments: totalsSummary.total_of_payments,
              total_principal: totalsSummary.total_principal,
              payments_made: totalsSummary.payments_made,
            },
            schedule: totalsSummary.schedule,
          };
        }

        const mortgageCalculator = Object.freeze({
          compute_base_loan_amount,
          apply_upfront_fee,
          normalize_property_tax,
          monthly_p_and_i,
          monthly_mi,
          amortize_monthly,
          summarize_outputs,
          calculate_mortgage,
        });

        globalThis.mortgageCalculator = mortgageCalculator;

        const $ = (id) => document.getElementById(id);
        const formatCurrency = (value) =>
          clampNonNegative(value).toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
          });

        const formatCompactCurrency = (value) =>
          clampNonNegative(value).toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
            notation: "compact",
          });

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        const baseDefaults = {
          loan_type: "conventional",
          home_value: 450000,
          down_payment_value: 90000,
          rate_apr: 6.75,
          term_years: 30,
          start_month: 2,
          start_year: new Date().getFullYear(),
          property_tax_input: 1.05,
          homeowners_insurance_yearly: 1500,
          hoa_monthly: 0,
          upfront_fee_pct: 0,
          annual_mi_pct: 0,
          finance_upfront_fee: false,
          extra_principal_monthly: 0,
          extra_start_month_index: 0,
          pmi_pct: 0.5,
        };

        const programDefaults = {
          conventional: { pmi_pct: 0.5, upfront_fee_pct: 0, annual_mi_pct: 0, finance_upfront_fee: false },
          FHA: { pmi_pct: 0, upfront_fee_pct: 1.75, annual_mi_pct: 0.85, finance_upfront_fee: true },
          VA: { pmi_pct: 0, upfront_fee_pct: 2.3, annual_mi_pct: 0, finance_upfront_fee: true },
          USDA: { pmi_pct: 0, upfront_fee_pct: 1.0, annual_mi_pct: 0.35, finance_upfront_fee: true },
        };

        const inputs = {
          loan_type: $("loan_type"),
          home_value: $("home_value"),
          down_payment_value: $("down_payment_value"),
          rate_apr: $("rate_apr"),
          term_years: $("term_years"),
          start_month: $("start_month"),
          start_year: $("start_year"),
          property_tax_input: $("property_tax_input"),
          homeowners_insurance_yearly: $("homeowners_insurance_yearly"),
          hoa_monthly: $("hoa_monthly"),
          pmi_pct: $("pmi_pct"),
          upfront_fee_pct: $("upfront_fee_pct"),
          annual_mi_pct: $("annual_mi_pct"),
          finance_upfront_fee: $("finance_upfront_fee"),
          extra_principal_monthly: $("extra_principal_monthly"),
          extra_start_month_index: $("extra_start_month_index"),
        };

        const miVisibilityPrograms = new Set(["FHA", "USDA"]);
        const miOnlyElements = Array.from(document.querySelectorAll("[data-mi-only]"));

        const updateMiVisibility = () => {
          const program = inputs.loan_type.value;
          const show = miVisibilityPrograms.has(program);
          miOnlyElements.forEach((el) => {
            el.classList.toggle("is-hidden", !show);
          });
        };

        const percentInputIds = ["rate_apr", "pmi_pct", "upfront_fee_pct", "annual_mi_pct"];
        const percentInputSet = new Set(percentInputIds);

        const formatPercentValue = (value) => {
          const num = toNumber(value);
          if (!Number.isFinite(num)) return "";
          return num.toFixed(2);
        };

        const normalizePercentInput = (el) => {
          if (!el) return;
          const formatted = formatPercentValue(el.value);
          if (formatted !== "") {
            el.value = formatted;
          }
        };

        const normalizePercentInputs = () => {
          percentInputIds.forEach((id) => normalizePercentInput(inputs[id]));
        };

        const outputs = {
          total_monthly_0: $("total_monthly_0"),
          p_and_i: $("p_and_i"),
          total_interest: $("total_interest"),
          payoff_date: $("payoff_date"),
          interest_hint: $("interest_hint"),
          term_hint: $("term_hint"),
          totalsBreakdown: $("totalsBreakdown"),
          schedulePreview: $("schedulePreview"),
          scheduleNote: $("scheduleNote"),
        };
        const monthlyPaymentCard = $("monthlyPaymentCard");
        const carousel = {
          track: $("resultTrack"),
          prev: $("cardPrev"),
          next: $("cardNext"),
          slides: Array.from(document.querySelectorAll(".carousel-slide")),
          index: 0,
        };

        const setDefaults = (preset = baseDefaults) => {
          Object.entries(preset).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          normalizePercentInputs();
          updateMiVisibility();
        };

        const mergeProgramDefaults = () => {
          const program = inputs.loan_type.value;
          const defaults = programDefaults[program];
          if (!defaults) return;
          Object.entries(defaults).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              // Always update program-specific fields (pmi_pct, upfront_fee_pct, annual_mi_pct)
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          normalizePercentInputs();
        };

        const readParams = () => ({
          loan_type: inputs.loan_type.value,
          home_value: toNumber(inputs.home_value.value),
          down_payment_value: toNumber(inputs.down_payment_value.value),
          down_payment_pct: 0,
          rate_apr: toNumber(inputs.rate_apr.value) / 100,
          term_years: toNumber(inputs.term_years.value),
          start_month: toNumber(inputs.start_month.value),
          start_year: toNumber(inputs.start_year.value),
          property_tax_input: toNumber(inputs.property_tax_input.value),
          homeowners_insurance_yearly: toNumber(inputs.homeowners_insurance_yearly.value),
          hoa_monthly: toNumber(inputs.hoa_monthly.value),
          upfront_fee_pct: toNumber(inputs.upfront_fee_pct.value) / 100,
          annual_mi_pct: toNumber(inputs.annual_mi_pct.value) / 100,
          finance_upfront_fee: Boolean(inputs.finance_upfront_fee.checked),
          extra_principal_monthly: toNumber(inputs.extra_principal_monthly.value),
          extra_start_month_index: toNumber(inputs.extra_start_month_index.value),
          pmi_pct: toNumber(inputs.pmi_pct.value) / 100,
        });

        const divideSafe = (numerator, denominator) =>
          denominator === 0 ? 0 : numerator / denominator;

        const renderSummary = (calc) => {
          const { inputs: normalized, derived, totals, payoff_date } = calc;
          const monthsElapsed = totals.payments_made || 0;
          const yearsElapsed = divideSafe(monthsElapsed, 12);
          const payoffLabel = payoff_date
            ? `${monthNames[normalizeMonth(payoff_date.month) - 1]} ${payoff_date.year}`
            : "—";

          const monthlyPaymentEl = outputs.total_monthly_0;
          monthlyPaymentEl.textContent = formatCurrency(derived.total_monthly_0);
          if (monthlyPaymentCard) {
            monthlyPaymentCard.classList.remove("glow-animate");
            void monthlyPaymentCard.offsetWidth;
            monthlyPaymentCard.classList.add("glow-animate");
          }
          outputs.p_and_i.textContent = formatCurrency(derived.p_and_i);
          outputs.total_interest.textContent = formatCurrency(totals.total_interest);
          outputs.payoff_date.textContent = payoffLabel;

          const totalExtraPrincipal = calc.schedule.reduce((sum, row) => sum + row.extra_principal, 0);

          outputs.interest_hint.textContent = `Totals include ${formatCurrency(
            totals.total_principal - totalExtraPrincipal
          )} scheduled principal and ${formatCurrency(totalExtraPrincipal)} extra payments.`;

          outputs.term_hint.textContent = `Original term ${normalized.term_years} yrs — paid off in ${yearsElapsed.toFixed(
            1
          )} yrs (${monthsElapsed} months).`;

          outputs.totalsBreakdown.innerHTML = `
            <div>Tax & insurance: <strong>${formatCurrency(totals.total_tax + totals.total_ins)}</strong></div>
            <div>Mortgage insurance: <strong>${formatCurrency(totals.total_mi)}</strong></div>
            <div>HOA dues: <strong>${formatCurrency(totals.total_hoa)}</strong></div>
            <div>Total paid: <strong>${formatCurrency(totals.total_of_payments)}</strong></div>
          `;

          const previewRows = calc.schedule.slice(0, 12);
          if (previewRows.length) {
            const rows = previewRows
              .map((row) => {
                const monthLabel = `${monthNames[row.date.month - 1].slice(0, 3)} ${row.date.year}`;
                return `
                  <tr>
                    <td class="label">${row.index + 1}</td>
                    <td>${monthLabel}</td>
                    <td>${formatCurrency(row.total_payment)}</td>
                    <td>${formatCurrency(row.principal_scheduled + row.extra_principal)}</td>
                    <td>${formatCurrency(row.interest)}</td>
                    <td>${formatCurrency(row.closing_balance)}</td>
                  </tr>`;
              })
              .join("");

            outputs.schedulePreview.innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th class="label">Month</th>
                    <th>Payment</th>
                    <th>Principal</th>
                    <th>Interest</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            `;
            outputs.scheduleNote.textContent = `Showing first ${previewRows.length} of ${calc.schedule.length} months.`;
          } else {
            outputs.schedulePreview.innerHTML = "";
            outputs.scheduleNote.textContent = "Enter loan details to view amortization.";
          }
        };

        const calculateAndRender = () => {
          const params = readParams();
          const calc = mortgageCalculator.calculate_mortgage(params);
          renderSummary(calc);
        };

        const updateCarousel = () => {
          if (!carousel.track) return;
          const clamped = Math.max(0, Math.min(carousel.index, carousel.slides.length - 1));
          carousel.index = clamped;
          const offsetPercent = -(clamped * 100);
          carousel.track.style.transform = `translateX(${offsetPercent}%)`;
          if (carousel.prev) carousel.prev.disabled = clamped === 0;
          if (carousel.next) carousel.next.disabled = clamped === carousel.slides.length - 1;
        };

        if (carousel.prev) {
          carousel.prev.addEventListener("click", () => {
            carousel.index -= 1;
            updateCarousel();
          });
        }

        if (carousel.next) {
          carousel.next.addEventListener("click", () => {
            carousel.index += 1;
            updateCarousel();
          });
        }

        const resetButton = $("resetBtn");
        if (resetButton) {
          resetButton.addEventListener("click", () => {
            setDefaults(baseDefaults);
            mergeProgramDefaults();
            calculateAndRender();
          });
        }

        const recalcButton = $("calculateBtn");
        if (recalcButton) {
          recalcButton.addEventListener("click", calculateAndRender);
        }

        inputs.loan_type.addEventListener("change", () => {
          mergeProgramDefaults();
          calculateAndRender();
        });

        updateMiVisibility();
        updateCarousel();

        Object.values(inputs).forEach((el) => {
          const handler = () => {
            if (percentInputSet.has(el.id)) {
              normalizePercentInput(el);
            }
            calculateAndRender();
          };
          el.addEventListener("change", handler);
          if (el.tagName === "INPUT" && el.type === "number") {
            el.addEventListener("keyup", (evt) => {
              if (evt.key === "Enter") handler();
            });
          }
        });

        setDefaults(baseDefaults);
        mergeProgramDefaults();
        calculateAndRender();
      })();
    </script>
  </body>
</html>
